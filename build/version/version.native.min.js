var __extends=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r},__define=this.__define||function(e,t,r,n){Object.defineProperty(e,t,{configurable:!0,enumerable:!0,get:r,set:n})},egret;!function(e){var t;!function(t){var r=function(t){function r(e){t.call(this),this._versionInfo={},this._versionPath="",this._localFileArr=[],this._stage=e}__extends(r,t);var n=r;return p=n.prototype,p.fetchVersion=function(){var t=this;if(t._versionPath="all.manifest",t._versionInfo=t.getLocalData(t._versionPath),null==t._versionInfo)return void e.callLater(function(){t.dispatchEvent(new e.IOErrorEvent(e.IOErrorEvent.IO_ERROR))},t);var r=0,n=function(n){if(n)for(var i=0;i<n.length;i++)n[i]&&""!=n[i]&&t._localFileArr.push("resource/"+n[i]);r++,2==r&&("native"==egret_native.nativeType?t.loadAllChange():t.dispatchEvent(new e.Event(e.Event.COMPLETE)))};t.getList(n,"assets","resource"),t.getList(n,"update","resource")},p.getList=function(t,r,n){void 0===n&&(n="");var i=e.PromiseObject.create();i.onSuccessFunc=function(e){t(e)},i.onErrorFunc=function(){console.error("list files error")},"assets"==r?egret_native.Game.listResource(n,i):egret_native.Game.listUpdate(n,i)},p.getChangeList=function(){var e=[],t=this._localFileArr;for(var r in this._versionInfo)t.indexOf(this.getVirtualUrl(r))<0&&e.push({url:this.getVirtualUrl(r),size:this._versionInfo[r].s});return e},p.getVirtualUrl=function(e){return this._versionInfo&&this._versionInfo[e]?"resource/"+this._versionInfo[e].v.substring(0,2)+"/"+this._versionInfo[e].v+"_"+this._versionInfo[e].s:e},p.loadAllChange=function(){function t(){s.length>0?l.load(s[0].url,s[0].size):v>3?(l.removeEventListener(e.IOErrorEvent.IO_ERROR,i,o),l.removeEventListener(e.Event.COMPLETE,r,o),l.removeEventListener(e.ProgressEvent.PROGRESS,n,o),o._iLoadingView.loadError(),e.IOErrorEvent.dispatchIOErrorEvent(o)):a.length>0?(s=a,a=[],v++,r()):(l.removeEventListener(e.IOErrorEvent.IO_ERROR,i,o),l.removeEventListener(e.Event.COMPLETE,r,o),l.removeEventListener(e.ProgressEvent.PROGRESS,n,o),o._stage.removeChild(o._iLoadingView),o.dispatchEvent(new e.Event(e.Event.COMPLETE)))}function r(){c+=parseInt(s[0].size),s.shift(),t()}function n(e){o._iLoadingView.setProgress(c+e.bytesLoaded,u)}function i(){a.push(s[0]),s.shift(),r()}var o=this;null==o._iLoadingView&&(o._iLoadingView=new e.DefaultLoadingView),o._stage.addChild(o._iLoadingView);var s=this.getChangeList(),a=[],v=0,o=this,l=new e.NativeResourceLoader;l.addEventListener(e.IOErrorEvent.IO_ERROR,i,o),l.addEventListener(e.Event.COMPLETE,r,o),l.addEventListener(e.ProgressEvent.PROGRESS,n,o);var c=0,u=0;for(var E in s)u+=s[E].size;t()},p.getLocalData=function(e){if(egret_native.readUpdateFileSync&&egret_native.readResourceFileSync){var t=egret_native.readUpdateFileSync(e);return null!=t?JSON.parse(t):(t=egret_native.readResourceFileSync(e),null!=t?JSON.parse(t):null)}return this.getLocalDataByOld(e)},p.getLocalDataByOld=function(e){var t=null;if(egret_native.isRecordExists(e)){var r=egret_native.loadRecord(e);t=JSON.parse(r)}else if(egret_native.isFileExists(e)){var r=egret_native.readFileSync(e);t=JSON.parse(r)}return t},r}(e.EventDispatcher);t.NativeVersionController=r,e.registerClass(r,"egret.native.NativeVersionController",["egret.VersionController","egret.IVersionController","egret.IEventDispatcher"]),e.Capabilities.runtimeType==e.RuntimeType.NATIVE&&(e.VersionController=r)}(t=e["native"]||(e["native"]={}))}(egret||(egret={}));