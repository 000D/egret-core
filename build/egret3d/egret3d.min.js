var egret3d;(function(t){var e=function(){function t(){}t.LITTLE_ENDIAN="littleEndian";t.BIG_ENDIAN="bigEndian";return t}();t.Endian=e;var i=function(){function t(t){this.BUFFER_EXT_SIZE=0;this.EOF_byte=-1;this.EOF_code_point=-1;this._setArrayBuffer(t||new ArrayBuffer(this.BUFFER_EXT_SIZE));this.endian=e.BIG_ENDIAN}t.prototype._setArrayBuffer=function(t){this.write_position=t.byteLength;this.data=new DataView(t);this._position=0};t.prototype.setArrayBuffer=function(t){};Object.defineProperty(t.prototype,"buffer",{get:function(){return this.data.buffer},set:function(t){this.data=new DataView(t)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"dataView",{get:function(){return this.data},set:function(t){this.data=t;this.write_position=t.byteLength},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t;this.write_position=t>this.write_position?t:this.write_position},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"length",{get:function(){return this.write_position},set:function(t){this.write_position=t;var e=new Uint8Array(new ArrayBuffer(t));var i=this.data.buffer.byteLength;if(i>t){this._position=t}var r=Math.min(i,t);e.set(new Uint8Array(this.data.buffer,0,r));this.buffer=e.buffer},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:true,configurable:true});t.prototype.clear=function(){this._setArrayBuffer(new ArrayBuffer(this.BUFFER_EXT_SIZE))};t.prototype.readBoolean=function(){if(!this.validate(t.SIZE_OF_BOOLEAN))return null;return this.data.getUint8(this.position++)!=0};t.prototype.readByte=function(){if(!this.validate(t.SIZE_OF_INT8))return null;return this.data.getInt8(this.position++)};t.prototype.readBytes=function(e,i,r){if(i===void 0){i=0}if(r===void 0){r=0}if(r==0){r=this.bytesAvailable}else if(!this.validate(r)){return null}if(e){e.validateBuffer(i+r)}else{e=new t(new ArrayBuffer(i+r))}var a=new Uint8Array(e.buffer);var n=new Uint8Array(this.data.buffer,this.position,r);a.set(n,e.position);this.position+=r};t.prototype.readDouble=function(){if(!this.validate(t.SIZE_OF_FLOAT64))return null;var i=this.data.getFloat64(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_FLOAT64;return i};t.prototype.uncompress=function(t){if(t===void 0){t="7z"}var e=new nid.LZMA;var i=e.decode(new Uint8Array(this.data.buffer)).buffer;this.buffer=i};t.prototype.compress=function(t){if(t===void 0){t="7z"}var e=new nid.LZMA;var i=nid.LZMAHelper.encode(this.data.buffer);this.buffer=i};t.prototype.readFloat=function(){if(!this.validate(t.SIZE_OF_FLOAT32))return null;var i=this.data.getFloat32(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_FLOAT32;return i};t.prototype.readInt=function(){if(!this.validate(t.SIZE_OF_INT32))return null;var i=this.data.getInt32(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_INT32;return i};t.prototype.readShort=function(){if(!this.validate(t.SIZE_OF_INT16))return null;var i=this.data.getInt16(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_INT16;return i};t.prototype.readUnsignedByte=function(){if(!this.validate(t.SIZE_OF_UINT8))return null;return this.data.getUint8(this.position++)};t.prototype.readUnsignedInt=function(){if(!this.validate(t.SIZE_OF_UINT32))return null;var i=this.data.getUint32(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT32;return i};t.prototype.readUnsignedShort=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT16;return i};t.prototype.readUTF=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT16;if(i>0){return this.readUTFBytes(i)}else{return""}};t.prototype.readUTFBytes=function(t){if(!this.validate(t))return null;var e=new Uint8Array(this.buffer,this.bufferOffset+this.position,t);this.position+=t;return this.decodeUTF8(e)};t.prototype.writeBoolean=function(e){this.validateBuffer(t.SIZE_OF_BOOLEAN);this.data.setUint8(this.position++,e?1:0)};t.prototype.writeByte=function(e){this.validateBuffer(t.SIZE_OF_INT8);this.data.setInt8(this.position++,e)};t.prototype.writeUnsignedByte=function(e){this.validateBuffer(t.SIZE_OF_UINT8);this.data.setUint8(this.position++,e)};t.prototype.writeBytes=function(t,e,i){if(e===void 0){e=0}if(i===void 0){i=0}var r;if(e<0){return}if(i<0){return}else if(i==0){r=t.length-e}else{r=Math.min(t.length-e,i)}if(r>0){this.validateBuffer(r);var a=new Uint8Array(this.buffer);var n=new Uint8Array(t.buffer,e,r);a.set(n,this.position);this.position+=r}};t.prototype.writeDouble=function(i){this.validateBuffer(t.SIZE_OF_FLOAT64);this.data.setFloat64(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_FLOAT64};t.prototype.writeFloat=function(i){this.validateBuffer(t.SIZE_OF_FLOAT32);this.data.setFloat32(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_FLOAT32};t.prototype.writeInt=function(i){this.validateBuffer(t.SIZE_OF_INT32);this.data.setInt32(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_INT32};t.prototype.writeShort=function(i){this.validateBuffer(t.SIZE_OF_INT16);this.data.setInt16(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_INT16};t.prototype.writeUnsignedInt=function(i){this.validateBuffer(t.SIZE_OF_UINT32);this.data.setUint32(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT32};t.prototype.writeUnsignedShort=function(i){this.validateBuffer(t.SIZE_OF_UINT16);this.data.setUint16(this.position,i,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT16};t.prototype.writeUTF=function(i){var r=this.encodeUTF8(i);var a=r.length;this.validateBuffer(t.SIZE_OF_UINT16+a);this.data.setUint16(this.position,a,this.endian==e.LITTLE_ENDIAN);this.position+=t.SIZE_OF_UINT16;this._writeUint8Array(r,false)};t.prototype.writeUTFBytes=function(t){this._writeUint8Array(this.encodeUTF8(t))};t.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable};t.prototype._writeUint8Array=function(t,e){if(e===void 0){e=true}if(e){this.validateBuffer(this.position+t.length)}var i=new Uint8Array(this.buffer);i.set(t,this.position);this.position+=t.length};t.prototype.validate=function(t){if(this.data.byteLength>0&&this._position+t<=this.data.byteLength){return true}else{}};t.prototype.validateBuffer=function(t,e){if(e===void 0){e=false}this.write_position=t>this.write_position?t:this.write_position;t+=this._position;if(this.data.byteLength<t||e){var i=new Uint8Array(new ArrayBuffer(t+this.BUFFER_EXT_SIZE));var r=Math.min(this.data.buffer.byteLength,t+this.BUFFER_EXT_SIZE);var a=new Uint8Array(this.data.buffer,0,r);i.set(a);this.buffer=i.buffer}};t.prototype.encodeUTF8=function(t){var e=0;var i=this.stringToCodePoints(t);var r=[];while(i.length>e){var a=i[e++];if(this.inRange(a,55296,57343)){this.encoderError(a)}else if(this.inRange(a,0,127)){r.push(a)}else{var n,o;if(this.inRange(a,128,2047)){n=1;o=192}else if(this.inRange(a,2048,65535)){n=2;o=224}else if(this.inRange(a,65536,1114111)){n=3;o=240}r.push(this.div(a,Math.pow(64,n))+o);while(n>0){var s=this.div(a,Math.pow(64,n-1));r.push(128+s%64);n-=1}}}return new Uint8Array(r)};t.prototype.decodeUTF8=function(t){var e=false;var i=0;var r="";var a;var n=0;var o=0;var s=0;var h=0;while(t.length>i){var u=t[i++];if(u==this.EOF_byte){if(o!=0){a=this.decoderError(e)}else{a=this.EOF_code_point}}else{if(o==0){if(this.inRange(u,0,127)){a=u}else{if(this.inRange(u,194,223)){o=1;h=128;n=u-192}else if(this.inRange(u,224,239)){o=2;h=2048;n=u-224}else if(this.inRange(u,240,244)){o=3;h=65536;n=u-240}else{this.decoderError(e)}n=n*Math.pow(64,o);a=null}}else if(!this.inRange(u,128,191)){n=0;o=0;s=0;h=0;i--;a=this.decoderError(e,u)}else{s+=1;n=n+(u-128)*Math.pow(64,o-s);if(s!==o){a=null}else{var l=n;var c=h;n=0;o=0;s=0;h=0;if(this.inRange(l,c,1114111)&&!this.inRange(l,55296,57343)){a=l}else{a=this.decoderError(e,u)}}}}if(a!==null&&a!==this.EOF_code_point){if(a<=65535){if(a>0)r+=String.fromCharCode(a)}else{a-=65536;r+=String.fromCharCode(55296+(a>>10&1023));r+=String.fromCharCode(56320+(a&1023))}}}return r};t.prototype.encoderError=function(t){};t.prototype.decoderError=function(t,e){if(t){}return e||65533};t.prototype.inRange=function(t,e,i){return e<=t&&t<=i};t.prototype.div=function(t,e){return Math.floor(t/e)};t.prototype.stringToCodePoints=function(t){var e=[];var i=0,r=t.length;while(i<t.length){var a=t.charCodeAt(i);if(!this.inRange(a,55296,57343)){e.push(a)}else if(this.inRange(a,56320,57343)){e.push(65533)}else{if(i==r-1){e.push(65533)}else{var n=t.charCodeAt(i+1);if(this.inRange(n,56320,57343)){var o=a&1023;var s=n&1023;i+=1;e.push(65536+(o<<10)+s)}else{e.push(65533)}}}i+=1}return e};t.SIZE_OF_BOOLEAN=1;t.SIZE_OF_INT8=1;t.SIZE_OF_INT16=2;t.SIZE_OF_INT32=4;t.SIZE_OF_UINT8=1;t.SIZE_OF_UINT16=2;t.SIZE_OF_UINT32=4;t.SIZE_OF_FLOAT32=4;t.SIZE_OF_FLOAT64=8;return t}();t.ByteArray=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this._dirty=true;this._makeResult=0;this._values=[];this._values=[];this._values.length=t.MAX_COUNT}t.prototype.setBoolean=function(e,i){if(e>=t.MAX_COUNT)throw Error("BooleanArray MAX_COUNT："+t.MAX_COUNT);if(this._values[e]!=i){this._values[e]=i;this._dirty=true}};t.prototype.getBoolean=function(e){if(e>=t.MAX_COUNT)return false;return this._values[e]};Object.defineProperty(t.prototype,"dirty",{get:function(){return this._dirty},enumerable:true,configurable:true});t.prototype.forceDirty=function(){this._dirty=true};Object.defineProperty(t.prototype,"makeResult",{get:function(){if(this._dirty){this.make()}return this._makeResult},enumerable:true,configurable:true});t.prototype.make=function(){this._makeResult=0;for(var e=0,i=t.MAX_COUNT;e<i;e++){if(this._values[e]){this._makeResult+=1<<e}}this._dirty=false;return this._makeResult};t.prototype.clear=function(){this._dirty=true;this._makeResult=0;this._values.length=0};t.FLAG_0=0;t.FLAG_1=1;t.FLAG_2=2;t.FLAG_3=3;t.FLAG_4=4;t.FLAG_5=5;t.FLAG_6=6;t.FLAG_7=7;t.FLAG_8=8;t.FLAG_9=9;t.FLAG_10=10;t.MAX_COUNT=24;return t}();t.BooleanArray=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.isDebug=false;this._console=document.createElement("console");document.body.appendChild(this._console);this._console.style.color="red";this._console.style.zIndex="1000";this._console.style.position="absolute";this._console.style.top="10px";this._console.style.left="10px"}t.prototype.trace=function(){var t=[];for(var e=0;e<arguments.length;e++){t[e-0]=arguments[e]}if(this.isDebug){this.reset();var i=t.length;for(var r=0;r<i;r++){this._console.innerHTML+=t[r]+"</br>"}}};t.prototype.reset=function(){this._console.innerHTML=""};Object.defineProperty(t,"instance",{get:function(){if(this._instance==null){this._instance=new t}return this._instance},enumerable:true,configurable:true});t._instance=null;return t}();t.Debug=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parseContent=function(t){var e=new Array;var i="";var r=";";var a=-1;for(var n=0;n<t.length;++n){if(t.charAt(n)=="{"){a=i.indexOf("=");if(a<0){r="}"}}if(i==""){if(t.charAt(n)==" "||t.charAt(n)=="    "||t.charAt(n)=="\t"){continue}}i+=t.charAt(n);if(r!="\n"){if(i.indexOf("#extension")>=0){r="\n"}else if(i.indexOf("#define")>=0){r="\n"}}if(r==t.charAt(n)){if(r=="}"){var o=0;var s=0;for(var h=0;h<i.length;++h){if(i.charAt(h)=="{"){o++}else if(i.charAt(h)=="}"){s++}}if(o!=s){continue}if(i.indexOf("struct")>=0){r=";";continue}}if(i.length>0){e.push(i)}i="";r=";"}}return e};e.parseLines=function(t){var e=new Array;var i="";var r=false;for(var a=0;a<t.length;++a){if(r){if(t.charAt(a)==";"){r=false;if(i.length>0){e.push(i);i=""}break}i+=t.charAt(a);continue}if(t.charAt(a)!=" "&&t.charAt(a)!="\t"&&t.charAt(a)!=","&&t.charAt(a)!="\r"&&t.charAt(a)!="\n"&&t.charAt(a)!=":"){if(t.charAt(a)==";"){if(i.length>0){e.push(i);i=""}break}else if(t.charAt(a)=="="){if(i.length>0){e.push(i);i=""}e.push("=");r=true;continue}i+=t.charAt(a);if(a==t.length-1&&t!=""){e.push(i);i=""}}else{if(i!=""){e.push(i);i=""}}}return e};e.hasString=function(t,e){for(var i=0;i<t.length;++i){if(t[i]==e){return i}}return-1};e.getVarName=function(t){var e=this.hasString(t,"=");if(e>=0){e-=1;if(e>=0&&e<t.length){return t[e]}}else{e=t.length-1;if(e>=0&&e<t.length){return t[e]}}return""};e.getVarValue=function(t){var e=this.hasString(t,"=");if(e>=0){e+=1;if(e>=0&&e<t.length){return t[e]}}return""};e.getVarType=function(t){var e=this.hasString(t,"=");if(e>=0){e-=2;if(e>=0&&e<t.length){return t[e]}}else{e=t.length-2;if(e>=0&&e<t.length){return t[e]}}return""};e.getVarKey=function(t){var e=this.hasString(t,"=");if(e>=0){e-=3;if(e>=0&&e<t.length){return t[e]}}else{e=t.length-3;if(e>=0&&e<t.length){return t[e]}else{return t[0]}}return""};e.processShaderFile=function(t){var e=["\n","\r"];e=[];var i=t;var r=i;while(true){var a=i.indexOf("//");if(a<0){break}var n=i.indexOf("\r\n",a);if(n==-1){n=i.indexOf("\n",a)}var o=i.slice(a,n);i=i.replace(o,"");if(i==r){break}r=i}for(var s=0;s<e.length;++s){while(true){r=i.replace(e[s],"");if(i==r){break}i=r}}return i};e.colorRgb=function(t){var e=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;var i=t.toLowerCase();if(i&&e.test(i)){if(i.length===4){var r="#";for(var a=1;a<4;a+=1){r+=i.slice(a,a+1).concat(i.slice(a,a+1))}i=r}var n=[];for(var a=1;a<7;a+=2){n.push(parseInt("0x"+i.slice(a,a+2)))}return"RGB("+n.join(",")+")"}else{return i}};e.getLineType=function(t){var e=t.indexOf("{");if(e>0){var i=t.substr(0,e);if(i.indexOf("struct")>=0){var r=i.lastIndexOf(" ");r++;var a=i.substr(r,i.length-r);return"struct "+a}if(i.indexOf("=")<0){var n=t.indexOf("(");var r=t.lastIndexOf(" ",n);r++;var o=t.substr(r,n-r);return"function "+o}}return"unknown"};e.processStruct=function(t,i,r){var a=i.lastIndexOf("}");a++;var n=i.lastIndexOf(";");var o=i.substr(a,n-a);var s=e.parseLines(o);for(var h=0;h<s.length;++h){var u=e.getTemper(t+" "+s[h]+";");if(u)r.addVar(u)}};e.getAttribute=function(i){var r=i;var a;var n;var o;var s=e.parseLines(r);a=e.getVarName(s);n=e.getVarType(s);o=new t.GLSL.Attribute(a,n);o.value=e.getVarValue(s);return o};e.getTemper=function(i){var r=i;var a;var n;var o;var s=e.parseLines(r);a=e.getVarName(s);n=e.getVarType(s);o=new t.GLSL.TmpVar(a,n);o.value=e.getVarValue(s);return o};e.getVarying=function(i){var r=i;var a;var n;var o;var s=e.parseLines(r);a=e.getVarName(s);n=e.getVarType(s);o=new t.GLSL.Varying(a,n);return o};e.getUniform=function(i){var r=i;var a;var n;var o;var s=e.parseLines(r);a=e.getVarName(s);n=e.getVarType(s);o=new t.GLSL.Uniform(a,n);return o};e.getConst=function(i){var r=i;var a;var n;var o;var s;var h=e.parseLines(r);a=e.getVarName(h);n=e.getVarType(h);o=e.getVarValue(h);s=new t.GLSL.ConstVar(a,n,o);return s};e.getExtension=function(i){var r=i.indexOf("#");var a=i.indexOf(" ");var n=i.substr(r,a);var o=i.indexOf(":");var s=i.substr(a,o-a);s=e.replaceCharacter(s,[" "],"");o+=1;var h=i.substr(o,i.length-o);h=e.replaceCharacter(h,[" ",":","\n","\r"],"");var u=new t.GLSL.Extension(s);u.value=h;return u};e.getDefine=function(i){var r=i;var a="";var n="";var o;var s=e.parseLines(r);a=s[1];if(s.length>=3){n=s[2]}o=new t.GLSL.DefineVar(a,n);return o};e.getSampler2D=function(i){var r=i;var a;var n;var o;var s=e.parseLines(r);a=e.getVarName(s);o=new t.GLSL.Sampler2D(a);return o};e.getSampler3D=function(i){var r=i;var a;var n;var o;var s=e.parseLines(r);a=e.getVarName(s);o=new t.GLSL.Sampler3D(a);return o};e.filterCharacter=function(t){var i=t;var r=i;for(var a=0;a<e._filterChar.length;++a){while(true){r=i.replace(e._filterChar[a],"");if(i==r){break}i=r}}return r};e.replaceCharacter=function(t,e,i){var r=t;var a=false;while(!a){a=true;for(var n=0;n<e.length;++n){if(r.indexOf(e[n])>=0){a=false;break}}for(var n=0;n<e.length;++n){r=r.replace(e[n],i)}}return r};e.getURLName=function(t){var e=t.split(".");e=e[0].split("/");return e[e.length-1]};e.getFileFormat=function(t){var e=t.lastIndexOf(".");e++;var i=t.lastIndexOf("/");var r=t.substr(e,t.length-e);r=r.toLowerCase();return r};e.getPath=function(t){var e=t.lastIndexOf("/");e++;return t.substr(0,e)};e.ab2str=function(t,e){if(e===void 0){e=65535}var i="";var r=t.position;var a=e;while(t.position<t.length){a=e;if(t.length-t.position<a){a=t.length-t.position}i+=t.readUTFBytes(a)}t.position=r;return i};e.str2ab=function(e){var i=new t.ByteArray;i.writeUTFBytes(e);return i};e._filterChar=[" ","  ",";","\n","\r","\t","\n","\r","\t"];return e}();t.StringUtil=e})(egret3d||(egret3d={}));var nid;(function(t){var e=function(){function t(){}t.allocateUint8=function(e){t.u8=new Uint8Array(e)};t.allocateUint16=function(e){t.u16=new Uint16Array(e)};t.allocateUint32=function(e){t.u32=new Uint32Array(e)};t.reset=function(){t.u8Index=0;t.u16Index=0;t.u32Index=0};t.getUint8=function(){if(!t.u8){t.allocateUint8(10)}return t.u8Index++};t.getUint16=function(){if(!t.u16){t.allocateUint16(24)}return t.u16Index++};t.getUint32=function(){if(!t.u32){t.allocateUint32(10)}return t.u32Index++};t.u8Index=0;t.u16Index=0;t.u32Index=0;return t}();t.MEMORY=e})(nid||(nid={}));var nid;(function(t){var e=function(){function e(){this.posSlotDecoder=t.BitTreeDecoder.constructArray(6,t.LZMA.kNumLenToPosStates);this.alignDecoder=new t.BitTreeDecoder(t.LZMA.kNumAlignBits);this.posDecoders=new Uint16Array(1+t.LZMA.kNumFullDistances-t.LZMA.kEndPosModelIndex);this.isMatch=new Uint16Array(t.LZMA.kNumStates<<t.LZMA.kNumPosBitsMax);this.isRep=new Uint16Array(t.LZMA.kNumStates);this.isRepG0=new Uint16Array(t.LZMA.kNumStates);this.isRepG1=new Uint16Array(t.LZMA.kNumStates);this.isRepG2=new Uint16Array(t.LZMA.kNumStates);this.isRep0Long=new Uint16Array(t.LZMA.kNumStates<<t.LZMA.kNumPosBitsMax);this.lenDecoder=new t.LenDecoder;this.repLenDecoder=new t.LenDecoder;this.rangeDec=new t.RangeDecoder;this.outWindow=new t.OutWindow}e.prototype.init=function(){t.MEMORY.reset();this.loc1=t.MEMORY.getUint32()|0;this.loc2=t.MEMORY.getUint32()|0;this.matchBitI=t.MEMORY.getUint16()|0;this.matchByteI=t.MEMORY.getUint16()|0;this.bitI=t.MEMORY.getUint16()|0;this.symbolI=t.MEMORY.getUint16()|0;this.prevByteI=t.MEMORY.getUint16()|0;this.litStateI=t.MEMORY.getUint16()|0;this.initLiterals();this.initDist();t.LZMA.INIT_PROBS(this.isMatch);t.LZMA.INIT_PROBS(this.isRep);t.LZMA.INIT_PROBS(this.isRepG0);t.LZMA.INIT_PROBS(this.isRepG1);t.LZMA.INIT_PROBS(this.isRepG2);t.LZMA.INIT_PROBS(this.isRep0Long);this.lenDecoder.init();this.repLenDecoder.init()};e.prototype.create=function(){this.outWindow.create(this.dictSize);this.createLiterals()};e.prototype.createLiterals=function(){this.litProbs=new Uint16Array(768<<this.lc+this.lp)};e.prototype.initLiterals=function(){var e=768<<this.lc+this.lp;for(var i=0;i<e;i++){this.litProbs[i]=t.LZMA.PROB_INIT_VAL}};e.prototype.decodeLiteral=function(e,i){t.MEMORY.u16[this.prevByteI]=0;if(!this.outWindow.isEmpty())t.MEMORY.u16[this.prevByteI]=this.outWindow.getByte(1);t.MEMORY.u16[this.symbolI]=1;t.MEMORY.u16[this.litStateI]=((this.outWindow.totalPos&(1<<this.lp)-1)<<this.lc)+(t.MEMORY.u16[this.prevByteI]>>>8-this.lc);var r=768*t.MEMORY.u16[this.litStateI]|0;if(e>=7){t.MEMORY.u16[this.matchByteI]=this.outWindow.getByte(i+1);do{t.MEMORY.u16[this.matchBitI]=t.MEMORY.u16[this.matchByteI]>>>7&1;t.MEMORY.u16[this.matchByteI]<<=1;t.MEMORY.u16[this.bitI]=this.rangeDec.decodeBit(this.litProbs,r+(1+t.MEMORY.u16[this.matchBitI]<<8)+t.MEMORY.u16[this.symbolI]);t.MEMORY.u16[this.symbolI]=t.MEMORY.u16[this.symbolI]<<1|t.MEMORY.u16[this.bitI];if(t.MEMORY.u16[this.matchBitI]!=t.MEMORY.u16[this.bitI])break}while(t.MEMORY.u16[this.symbolI]<256)}while(t.MEMORY.u16[this.symbolI]<256){t.MEMORY.u16[this.symbolI]=t.MEMORY.u16[this.symbolI]<<1|this.rangeDec.decodeBit(this.litProbs,r+t.MEMORY.u16[this.symbolI])}this.outWindow.putByte(t.MEMORY.u16[this.symbolI]-256)};e.prototype.decodeDistance=function(e){var i=e;if(i>t.LZMA.kNumLenToPosStates-1)i=t.LZMA.kNumLenToPosStates-1;var r=this.posSlotDecoder[i].decode(this.rangeDec);if(r<4)return r;var a=(r>>>1)-1;t.MEMORY.u32[this.loc1]=(2|r&1)<<a;if(r<t.LZMA.kEndPosModelIndex){t.MEMORY.u32[this.loc1]+=t.LZMA.BitTreeReverseDecode(this.posDecoders,a,this.rangeDec,t.MEMORY.u32[this.loc1]-r)}else{t.MEMORY.u32[this.loc1]+=this.rangeDec.decodeDirectBits(a-t.LZMA.kNumAlignBits)<<t.LZMA.kNumAlignBits;t.MEMORY.u32[this.loc1]+=this.alignDecoder.reverseDecode(this.rangeDec)}return t.MEMORY.u32[this.loc1]};e.prototype.initDist=function(){for(var e=0;e<t.LZMA.kNumLenToPosStates;e++){this.posSlotDecoder[e].init()}this.alignDecoder.init();t.LZMA.INIT_PROBS(this.posDecoders)};e.prototype.decodeProperties=function(e){var i=new Uint8Array(4);i[0]=e[0];if(i[0]>=9*5*5){throw"Incorrect LZMA properties"}i[1]=i[0]%9;i[0]/=9;i[2]=i[0]/5;i[3]=i[0]%5;this.lc=i[1];this.pb=i[2];this.lp=i[3];this.dictSizeInProperties=0;for(var r=0;r<4;r++){this.dictSizeInProperties|=e[r+1]<<8*r}this.dictSize=this.dictSizeInProperties;if(this.dictSize<t.LZMA.LZMA_DIC_MIN){this.dictSize=t.LZMA.LZMA_DIC_MIN}};e.prototype.updateState_Literal=function(t){if(t<4)return 0;else if(t<10)return t-3;else return t-6};e.prototype.updateState_ShortRep=function(t){return t<7?9:11};e.prototype.updateState_Rep=function(t){return t<7?8:11};e.prototype.updateState_Match=function(t){return t<7?7:10};e.prototype.decode=function(e,i){this.init();this.rangeDec.init();if(e){this.outWindow.outStream=new Uint8Array(new ArrayBuffer(i))}var r=0,a=0,n=0,o=0;var s=0;for(;;){if(e&&i==0&&!this.markerIsMandatory){if(this.rangeDec.isFinishedOK()){return t.LZMA.LZMA_RES_FINISHED_WITHOUT_MARKER}}var h=this.outWindow.totalPos&(1<<this.pb)-1;if(this.rangeDec.decodeBit(this.isMatch,(s<<t.LZMA.kNumPosBitsMax)+h)==0){if(e&&i==0){return t.LZMA.LZMA_RES_ERROR}this.decodeLiteral(s,r);s=this.updateState_Literal(s);i--;continue}var u;if(this.rangeDec.decodeBit(this.isRep,s)!=0){if(e&&i==0){return t.LZMA.LZMA_RES_ERROR}if(this.outWindow.isEmpty()){return t.LZMA.LZMA_RES_ERROR}if(this.rangeDec.decodeBit(this.isRepG0,s)==0){if(this.rangeDec.decodeBit(this.isRep0Long,(s<<t.LZMA.kNumPosBitsMax)+h)==0){s=this.updateState_ShortRep(s);this.outWindow.putByte(this.outWindow.getByte(r+1));i--;continue}}else{var l;if(this.rangeDec.decodeBit(this.isRepG1,s)==0){l=a}else{if(this.rangeDec.decodeBit(this.isRepG2,s)==0){l=n}else{l=o;o=n}n=a}a=r;r=l}u=this.repLenDecoder.decode(this.rangeDec,h);s=this.updateState_Rep(s)}else{o=n;n=a;a=r;u=this.lenDecoder.decode(this.rangeDec,h);s=this.updateState_Match(s);r=this.decodeDistance(u);if(r==4294967295){return this.rangeDec.isFinishedOK()?t.LZMA.LZMA_RES_FINISHED_WITH_MARKER:t.LZMA.LZMA_RES_ERROR}if(e&&i==0){return t.LZMA.LZMA_RES_ERROR}if(r>=this.dictSize||!this.outWindow.checkDistance(r)){return t.LZMA.LZMA_RES_ERROR}}u+=t.LZMA.kMatchMinLen;var c=false;if(e&&i<u){u=i;c=true}this.outWindow.copyMatch(r+1,u);i-=u;if(c){return t.LZMA.LZMA_RES_ERROR}}};return e}();t.LzmaDecoder=e})(nid||(nid={}));var nid;(function(t){"use strict";var e=function(){function e(){this.decoder=new t.LzmaDecoder}e.INIT_PROBS=function(t){for(var e=0;e<t.length;e++){t[e]=this.PROB_INIT_VAL}};e.BitTreeReverseDecode=function(t,e,i,r){if(r===void 0){r=0}var a=1;var n=0;for(var o=0;o<e;o++){var s=i.decodeBit(t,r+a);a<<=1;a+=s;n|=s<<o}return n};e.prototype.decode=function(t){this.data=t;var i=new Uint8Array(13);var r;for(r=0;r<13;r++){i[r]=t[r]}this.decoder.decodeProperties(i);var a=0;var n=false;for(r=0;r<8;r++){var o=i[5+r];if(o!=255){n=true}a|=o<<8*r}this.decoder.markerIsMandatory=!n;if(n){console.log("Uncompressed Size : "+a+" bytes")}else{console.log("End marker is expected")}this.decoder.rangeDec.inStream=t;this.decoder.create();var s=this.decoder.decode(n,a);if(s==e.LZMA_RES_ERROR){throw"LZMA decoding error"}else if(s==e.LZMA_RES_FINISHED_WITHOUT_MARKER){}else if(s==e.LZMA_RES_FINISHED_WITH_MARKER){if(n){if(this.decoder.outWindow.out_pos!=a){throw"Finished with end marker before than specified size"}}}else{throw"Internal Error"}if(this.decoder.rangeDec.corrupted){console.log("Warning: LZMA stream is corrupted")}return this.decoder.outWindow.outStream};e.LZMA_DIC_MIN=1<<12;e.LZMA_RES_ERROR=0;e.LZMA_RES_FINISHED_WITH_MARKER=1;e.LZMA_RES_FINISHED_WITHOUT_MARKER=2;e.kNumBitModelTotalBits=11;e.kNumMoveBits=5;e.PROB_INIT_VAL=(1<<e.kNumBitModelTotalBits)/2;e.kNumPosBitsMax=4;e.kNumStates=12;e.kNumLenToPosStates=4;e.kNumAlignBits=4;e.kStartPosModelIndex=4;e.kEndPosModelIndex=14;e.kNumFullDistances=1<<(e.kEndPosModelIndex>>>1);e.kMatchMinLen=2;return e}();t.LZMA=e})(nid||(nid={}));var nid;(function(t){var e=function(){function t(){this.out_pos=0}t.prototype.create=function(t){this.buf=new Uint8Array(t);this.pos=0;this.size=t;this.isFull=false;this.totalPos=0};t.prototype.putByte=function(t){this.totalPos++;this.buf[this.pos++]=t;if(this.pos==this.size){this.pos=0;this.isFull=true}this.outStream[this.out_pos++]=t};t.prototype.getByte=function(t){return this.buf[t<=this.pos?this.pos-t:this.size-t+this.pos]};t.prototype.copyMatch=function(t,e){for(;e>0;e--){this.putByte(this.getByte(t))}};t.prototype.checkDistance=function(t){return t<=this.pos||this.isFull};t.prototype.isEmpty=function(){return this.pos==0&&!this.isFull};return t}();t.OutWindow=e})(nid||(nid={}));var nid;(function(t){var e=function(){function t(){this.rangeI=0;this.codeI=1;this.loc1=2;this.loc2=3;this.in_pos=13}t.prototype.isFinishedOK=function(){return this.U32[this.codeI]==0};t.prototype.init=function(){this.U32=new Uint32Array(4);this.U16=new Uint16Array(4);this.corrupted=false;if(this.inStream[this.in_pos++]!=0){this.corrupted=true}this.U32[this.rangeI]=4294967295;this.U32[this.codeI]=0;for(var t=0;t<4;t++){this.U32[this.codeI]=this.U32[this.codeI]<<8|this.inStream[this.in_pos++]}if(this.U32[this.codeI]==this.U32[this.rangeI]){this.corrupted=true}};t.prototype.normalize=function(){if(this.U32[this.rangeI]<t.kTopValue){this.U32[this.rangeI]<<=8;this.U32[this.codeI]=this.U32[this.codeI]<<8|this.inStream[this.in_pos++]}};t.prototype.decodeDirectBits=function(t){this.U32[this.loc1]=0;do{this.U32[this.rangeI]>>>=1;this.U32[this.codeI]-=this.U32[this.rangeI];this.U32[this.loc2]=0-(this.U32[this.codeI]>>>31);this.U32[this.codeI]+=this.U32[this.rangeI]&this.U32[this.loc2];if(this.U32[this.codeI]==this.U32[this.rangeI]){this.corrupted=true}this.normalize();this.U32[this.loc1]<<=1;this.U32[this.loc1]+=this.U32[this.loc2]+1}while(--t);return this.U32[this.loc1]};t.prototype.decodeBit=function(t,e){this.U16[0]=t[e];this.U32[2]=(this.U32[0]>>>11)*this.U16[0];if(this.U32[1]<this.U32[2]){this.U16[0]+=(1<<11)-this.U16[0]>>>5;this.U32[0]=this.U32[2];this.U16[1]=0}else{this.U16[0]-=this.U16[0]>>>5;this.U32[1]-=this.U32[2];this.U32[0]-=this.U32[2];this.U16[1]=1}t[e]=this.U16[0];if(this.U32[0]<16777216){this.U32[0]<<=8;this.U32[1]=this.U32[1]<<8|this.inStream[this.in_pos++]}return this.U16[1]};t.kTopValue=1<<24;return t}();t.RangeDecoder=e})(nid||(nid={}));var nid;(function(t){var e=function(){function e(t){this.numBits=t;this.probs=new Uint16Array(1<<this.numBits)}e.prototype.init=function(){t.LZMA.INIT_PROBS(this.probs)};e.prototype.decode=function(t){var e=1;for(var i=0;i<this.numBits;i++)e=(e<<1)+t.decodeBit(this.probs,e);return e-(1<<this.numBits)};e.prototype.reverseDecode=function(e){return t.LZMA.BitTreeReverseDecode(this.probs,this.numBits,e)};e.constructArray=function(t,i){var r=[];for(var a=0;a<i;a++){r[a]=new e(t)}return r};return e}();t.BitTreeDecoder=e})(nid||(nid={}));var nid;(function(t){var e=function(){function e(){this.lowCoder=t.BitTreeDecoder.constructArray(3,1<<t.LZMA.kNumPosBitsMax);this.midCoder=t.BitTreeDecoder.constructArray(3,1<<t.LZMA.kNumPosBitsMax);this.highCoder=new t.BitTreeDecoder(8)}e.prototype.init=function(){this.choice=[t.LZMA.PROB_INIT_VAL,t.LZMA.PROB_INIT_VAL];this.highCoder.init();for(var e=0;e<1<<t.LZMA.kNumPosBitsMax;e++){this.lowCoder[e].init();this.midCoder[e].init()}};e.prototype.decode=function(t,e){if(t.decodeBit(this.choice,0)==0){return this.lowCoder[e].decode(t)}if(t.decodeBit(this.choice,1)==0){return 8+this.midCoder[e].decode(t)}return 16+this.highCoder.decode(t)};return e}();t.LenDecoder=e})(nid||(nid={}));var nid;(function(t){"use strict";var e=function(){function e(){this.command=null;var e=this;this.decoder=new t.LZMA;addEventListener("message",function(t){if(e.command==null){e.command=t.data}else if(e.command["job"]==1){e.command=null}else if(e.command["job"]==2){e.decode(t.data)}},false)}e.prototype.decode=function(t){this.time=Date.now();var e=this.decoder.decode(new Uint8Array(t));this.command["time"]=Date.now()-this.time;postMessage(this.command);postMessage(e.buffer,[e.buffer])};e.ENCODE=1;e.DECODE=2;return e}();t.LZMAWorker=e})(nid||(nid={}));new nid.LZMAWorker;var nid;(function(t){var e=function(){function e(){}e.init=function(){var t=0};e.encode=function(t){return null};e.decode=function(t){return e.decoder.decode(new Uint8Array(t)).buffer};e.encodeAsync=function(t,e){};e.decodeAsync=function(t,i){if(e.callback==null){e.callback=i}else{console.log("Warning! Another LZMA decoding is running...")}};e.decoder=new t.LZMA;e.ENCODE=1;e.DECODE=2;return e}();t.LZMAHelper=e})(nid||(nid={}));nid.LZMAHelper.init();var egret3d;(function(t){var e=function(){function e(){}e.outError=function(t){console.log("Error:"+t)};e.outWarn=function(t){console.log("Warning:"+t)};e.outDebug=function(e){if(t.Egret3DEngine.instance.debug){console.log("Debug:"+e)}};return e}();t.Egret3DLog=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.averageFPS=60;this.averageDelay=16;this.delayNumber=0;this.countFrame=30}t.prototype.update=function(t,e){this.delayNumber+=e-1;if(this.countFrame--==0){this.countFrame=30;this.averageDelay=Math.floor(this.delayNumber/this.countFrame);this.averageFPS=Math.floor(1e3/this.averageDelay);this.averageFPS=Math.min(this.averageFPS,60);this.delayNumber=0}return" "+this.averageFPS.toString()+" fps/"+this.averageDelay.toString()+" delay"};t.fps=16.6666;return t}();var i=function(){function i(){}i.initState=function(){if(t.Egret3DEngine.instance.debug&&!i._canvas){i._canvas=document.createElement("canvas");document.body.appendChild(i._canvas);i._canvas.width=i._width;i._canvas.height=i._height;i._canvas.style.backgroundColor="rgba(158,158,158,0.3)"}};i.showTime=function(t,e){if(!i.use)i.initState();i._fps=i.fpsInfo.update(t,e)};i.showDataInfo=function(){var t=[];for(var e=0;e<arguments.length;e++){t[e-0]=arguments[e]}if(!i.use)i.initState();var r;for(r in t){if(t[r]){this.array.push(t[r].toString())}}};i.countStart=function(){if(t.Egret3DEngine.instance.debug)this.help=(new Date).getTime()};i.countEnd=function(t){i.showDataInfo(t+":"+((new Date).getTime()-i.help)+" ms")};i.show=function(){if(!i._canvas)return;var t=20;var e=i._canvas.getContext("2d");e.fillStyle="lightblue";e.font="20px Corbel";e.clearRect(0,0,i._width,i._height);e.fillText(" Egret3D Graphics ",10,t);t+=20;e.fillText(i._fps,10,t);t+=20;for(var r=0;r<this.array.length;r++){e.fillText(this.array[r].toString(),10,t);t+=20}this.array.length=0};i.use=false;i._width=260;i._height=600;i.fpsInfo=new e;i.help=0;i._fps="";i.array=[];return i}();t.Egret3DState=i})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["diffuse"]=0]="diffuse";t[t["normal"]=1]="normal";t[t["specular"]=2]="specular";t[t["color"]=3]="color";t[t["shadow"]=4]="shadow"})(t.TextureMethodType||(t.TextureMethodType={}));var e=t.TextureMethodType;(function(t){t[t["utils_vertex"]=0]="utils_vertex";t[t["base_vertex"]=1]="base_vertex";t[t["start_vertex"]=2]="start_vertex";t[t["local_vertex"]=3]="local_vertex";t[t["global_vertex"]=4]="global_vertex";t[t["end_vertex"]=5]="end_vertex";
t[t["utils_fragment"]=6]="utils_fragment";t[t["base_fragment"]=7]="base_fragment";t[t["start_fragment"]=8]="start_fragment";t[t["materialsource_fragment"]=9]="materialsource_fragment";t[t["diffuse_fragment"]=10]="diffuse_fragment";t[t["normal_fragment"]=11]="normal_fragment";t[t["matCap_fragment"]=12]="matCap_fragment";t[t["specular_fragment"]=13]="specular_fragment";t[t["shadow_fragment"]=14]="shadow_fragment";t[t["lighting_fragment"]=15]="lighting_fragment";t[t["multi_end_fragment"]=16]="multi_end_fragment";t[t["end_fragment"]=17]="end_fragment"})(t.ShaderPhaseType||(t.ShaderPhaseType={}));var i=t.ShaderPhaseType})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["uniform1f"]=0]="uniform1f";t[t["uniform1fv"]=1]="uniform1fv";t[t["uniform1i"]=2]="uniform1i";t[t["uniform1iv"]=3]="uniform1iv";t[t["uniform2f"]=4]="uniform2f";t[t["uniform2fv"]=5]="uniform2fv";t[t["uniform2i"]=6]="uniform2i";t[t["uniform2iv"]=7]="uniform2iv";t[t["uniform3f"]=8]="uniform3f";t[t["uniform3fv"]=9]="uniform3fv";t[t["uniform3i"]=10]="uniform3i";t[t["uniform3iv"]=11]="uniform3iv";t[t["uniform4f"]=12]="uniform4f";t[t["uniform4fv"]=13]="uniform4fv";t[t["uniform4i"]=14]="uniform4i";t[t["uniform4iv"]=15]="uniform4iv";t[t["uniformMatrix2fv"]=16]="uniformMatrix2fv";t[t["uniformMatrix3fv"]=17]="uniformMatrix3fv";t[t["uniformMatrix4fv"]=18]="uniformMatrix4fv"})(t.UniformType||(t.UniformType={}));var e=t.UniformType;(function(t){t[t["PixelArray"]=0]="PixelArray";t[t["CompressData"]=1]="CompressData";t[t["ImageData"]=2]="ImageData"})(t.InternalFormat||(t.InternalFormat={}));var i=t.InternalFormat;(function(t){t[t["shadowFrameBufrfer"]=0]="shadowFrameBufrfer";t[t["defaultFrameBuffer"]=1]="defaultFrameBuffer";t[t["positionFrameBuffer"]=2]="positionFrameBuffer";t[t["normalFrameBuffer"]=3]="normalFrameBuffer";t[t["specularFrameBuffer"]=4]="specularFrameBuffer";t[t["leftEyeFrameBuffer"]=5]="leftEyeFrameBuffer";t[t["rightEyeFrameBuffer"]=6]="rightEyeFrameBuffer";t[t["nextFrameBuffer"]=7]="nextFrameBuffer"})(t.FrameBufferType||(t.FrameBufferType={}));var r=t.FrameBufferType;(function(t){t[t["FLOAT_RGB"]=0]="FLOAT_RGB";t[t["FLOAT_RGBA"]=1]="FLOAT_RGBA";t[t["UNSIGNED_BYTE_RGB"]=2]="UNSIGNED_BYTE_RGB";t[t["UNSIGNED_BYTE_RGBA"]=3]="UNSIGNED_BYTE_RGBA"})(t.FrameBufferFormat||(t.FrameBufferFormat={}));var a=t.FrameBufferFormat;(function(t){t[t["ALPHA"]=0]="ALPHA";t[t["LAYER"]=1]="LAYER";t[t["NORMAL"]=2]="NORMAL";t[t["MULTIPLY"]=3]="MULTIPLY";t[t["ADD"]=4]="ADD";t[t["SUB"]=5]="SUB";t[t["DIV"]=6]="DIV";t[t["SCREEN"]=7]="SCREEN";t[t["SOFT_ADD"]=8]="SOFT_ADD"})(t.BlendMode||(t.BlendMode={}));var n=t.BlendMode;var o=function(){function t(){}return t}();t.ContextSamplerType=o;var s=function(){function t(){}return t}();t.DrawMode=s;var h=function(){function t(){}t.Direct3D_Opengl_Auto="Direct3D_Opengl_Auto";t.Direct3D_9_0="Direct3D_9_0";t.Direct3D_10_0="Direct3D_10_0";t.Direct3D_11_0="Direct3D_11_0";t.OpenGLES_2_0="OpenGLES_2_0";t.OpenGLES_3_0="OpenGLES_3_0";t.OpenGL="OpenGL";t.ColorFormat_DXT1_RGB=0;t.ColorFormat_DXT1_RGBA=0;t.ColorFormat_DXT3_RGBA=0;t.ColorFormat_DXT5_RGBA=0;return t}();t.ContextConfig=h})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e){if(t===void 0){t=0}if(e===void 0){e=0}this.x=t;this.y=e}Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:true,configurable:true});t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)};t.prototype.incrementBy=function(t){this.x+=t.x;this.y+=t.y};t.prototype.setTo=function(t,e){if(t===void 0){t=0}if(e===void 0){e=0}this.x+=t;this.y+=e};t.prototype.clone=function(){return new t(this.x,this.y)};t.prototype.copyFrom=function(t){this.x=t.x;this.y=t.y};t.prototype.equals=function(t){return this.x==t.x&&this.y==t.y};t.prototype.normalize=function(t){if(t===void 0){t=1}var e=this.length;if(e!=0){var i=t/e;this.x*=i;this.y*=i;return}throw"Cannot divide by zero length."};t.prototype.offset=function(t,e){this.x+=t;this.y+=e};t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)};t.prototype.toString=function(){return"[Point] (x="+this.x+", y="+this.y+")"};t.distance=function(t,e){var i=e.x-t.x;var r=e.y-t.y;return Math.sqrt(i*i+r*r)};return t}();t.Point=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.pointInsideTriangle=function(t,i,r,a){e.pp.setTo(t.x,t.z);e.p1.setTo(i.x,i.z);e.p2.setTo(r.x,r.z);e.p3.setTo(a.x,a.z);return e.pointInsideTriangle2d()};e.pointInsideTriangle2d=function(){if(e.product2d(e.p1,e.p2,e.p3)>=0){return e.product2d(e.p1,e.p2,e.pp)>=0&&e.product2d(e.p2,e.p3,e.pp)>=0&&e.product2d(e.p3,e.p1,e.pp)>=0}else{return e.product2d(e.p1,e.p2,e.pp)<=0&&e.product2d(e.p2,e.p3,e.pp)<=0&&e.product2d(e.p3,e.p1,e.pp)<=0}};e.product2d=function(t,e,i){var r=(t.x-i.x)*(e.y-i.y)-(t.y-i.y)*(e.x-i.x);if(r>-1e-5&&r<1e-5)r=0;return r};e.p1=new t.Point;e.p2=new t.Point;e.p3=new t.Point;e.pp=new t.Point;return e}();t.PointUtils=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e,i,r){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=0}this.x=0;this.y=0;this.z=0;this.w=0;this.x=t;this.y=e;this.z=i;this.w=r}Object.defineProperty(e.prototype,"a",{get:function(){return this.w},set:function(t){this.w=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"r",{get:function(){return this.x},set:function(t){this.x=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"g",{get:function(){return this.y},set:function(t){this.y=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"b",{get:function(){return this.z},set:function(t){this.z=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"length",{get:function(){return Math.sqrt(this.lengthSquared)},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"lengthSquared",{get:function(){return this.x*this.x+this.y*this.y+this.z*this.z},enumerable:true,configurable:true});e.prototype.add=function(t,i){if(i===void 0){i=null}if(!i){i=new e}var r=this.x;var a=this.y;var n=this.z;var o=this.w;var s=t.x;var h=t.y;var u=t.z;var l=t.w;i.setTo(r+s,a+h,n+u,o+l);return i};e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)};e.prototype.copyFrom=function(t){var e=this;e.x=t.x;e.y=t.y;e.z=t.z;e.w=t.w};e.prototype.crossProduct=function(t,i){if(i===void 0){i=null}i=i||new e;i.x=this.y*t.z-this.z*t.y;i.y=this.z*t.x-this.x*t.z;i.z=this.x*t.y-this.y*t.x;i.w=1;return i};e.prototype.decrementBy=function(t){this.x-=t.x;this.y-=t.y;this.z-=t.z};e.distance=function(t,e){var i=t.x-e.x;var r=t.y-e.y;var a=t.z-e.z;return Math.sqrt(i*i+r*r+a*a)};e.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z};e.prototype.equals=function(t,e){if(e===void 0){e=false}return this.x==t.x&&this.y==t.y&&this.z==t.z&&(!e||this.w==t.w)};e.prototype.incrementBy=function(t){this.x+=t.x;this.y+=t.y;this.z+=t.z};e.prototype.fromArray=function(t){this.x=t[0];this.y=t[1];this.z=t[2]};e.prototype.divide=function(t){if(t instanceof e)return new e(this.x/t.x,this.y/t.y,this.z/t.z);else{this.x=this.x/t;this.y=this.y/t;this.z=this.z/t}return this};e.prototype.negate=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z};e.prototype.normalize=function(t){if(t===void 0){t=1}if(this.length!=0){var e=t/this.length;this.x*=e;this.y*=e;this.z*=e;return}};e.prototype.scaleBy=function(t){this.x*=t;this.y*=t;this.z*=t};e.prototype.setTo=function(t,e,i,r){if(r===void 0){r=1}this.x=t;this.y=e;this.z=i;this.w=r};e.prototype.subtract=function(t,i){if(i===void 0){i=null}if(!i){i=new e}i.setTo(this.x-t.x,this.y-t.y,this.z-t.z);return i};e.prototype.multiply=function(t,i){if(i===void 0){i=null}if(!i){i=new e}var r=this.x;var a=this.y;var n=this.z;var o=t.x;var s=t.y;var h=t.z;i.setTo(r*o,a*s,n*h);return i};e.prototype.divided=function(t,i){if(i===void 0){i=null}if(!i){i=new e}var r=this.x;var a=this.y;var n=this.z;var o=t.x;var s=t.y;var h=t.z;i.setTo(r/o,a/s,n/h);return i};e.prototype.lerp=function(t,e,i){var r=t.x,a=t.y,n=t.z,o=t.w;var s=e.x,h=e.y,u=e.z,l=e.w;this.x=(s-r)*i+r;this.y=(h-a)*i+a;this.z=(u-n)*i+n;this.w=(l-o)*i+o};e.prototype.Dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z};e.prototype.OrthoNormalVectorFast=function(t,i){if(!i){i=new e}var r;var a;if(Math.abs(t.z)>.70710678){r=t.y*t.y+t.z*t.z;a=1/Math.sqrt(r);i.x=0;i.y=-t.z*a;i.z=t.y*a}else{r=t.x*t.x+t.y*t.y;a=1/Math.sqrt(r);i.x=-t.y*a;i.y=t.x*a;i.z=0}return i};e.prototype.slerp=function(i,r,a){var n=Math.sqrt(this.Dot(i,i));var o=Math.sqrt(this.Dot(r,r));if(n<1e-5||o<1e-5){return this.lerp(i,r,a)}var s=n+a*(o-n);var h=this.Dot(i,r)/(n*o);if(h>1-1e-5){return this.lerp(i,r,a)}else if(h<-1+1e-5){e.HELP_0.copyFrom(i);var u=e.HELP_0.divide(n);this.OrthoNormalVectorFast(u,e.HELP_1);var l=e.HELP_1;t.Quaternion.HELP_0.fromAxisAngle(e.HELP_1,3.1415926*a*t.MathUtil.RADIANS_TO_DEGREES);var c=t.Quaternion.HELP_0.toMatrix3D(t.Matrix4_4.helpMatrix);c.transformVector(u,this);this.scaleBy(s);return}else{i.dotProduct;this.Cross(i,r,e.HELP_0);var l=e.HELP_0;e.HELP_1.copyFrom(i);var u=e.HELP_1.divide(n);l.normalize();var f=Math.acos(h)*a;t.Quaternion.HELP_0.fromAxisAngle(l,f*t.MathUtil.RADIANS_TO_DEGREES);var c=t.Quaternion.HELP_0.toMatrix3D(t.Matrix4_4.helpMatrix);c.transformVector(u,this);this.scaleBy(s);return}};e.prototype.Cross=function(t,i,r){if(r===void 0){r=null}if(!r){r=new e}r.x=t.y*i.z-t.z*i.y;r.y=t.z*i.x-t.x*i.z;r.z=t.x*i.y-t.y*i.x;return r};e.prototype.toString=function(){return"<"+this.x+", "+this.y+", "+this.z+">"};e.prototype.parsing=function(t){var e=t.split(" ");if(e.length<3)return;this.x=parseFloat(e[0]);this.y=parseFloat(e[1]);this.z=parseFloat(e[2])};e.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y||this.z!=t.z||this.w!=t.w)};e.X_AXIS=new e(1,0,0);e.Y_AXIS=new e(0,1,0);e.Z_AXIS=new e(0,0,1);e.HELP_0=new e;e.HELP_1=new e;e.HELP_2=new e;e.HELP_3=new e;return e}();t.Vector3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e,i,r){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=0}this.x=0;this.y=0;this.width=0;this.height=0;this.x=t;this.y=e;this.width=i;this.height=r}t.prototype.copyFrom=function(t){this.x=t.x;this.y=t.y;this.width=t.width;this.height=t.height};t.prototype.copyTo=function(t){t.copyFrom(this)};t.prototype.inner=function(t,e){if(t<this.x||t>this.x+this.width||e<this.y||e>this.y+this.height){return false}return true};t.pointInRect=function(t,e,i,r,a,n){if(t<i||t>a||e<r||e>n){return false}return true};t.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y||this.width!=t.width||this.height!=t.height)};t.prototype.equalArea=function(t,e,i,r){return!(this.x!=t||this.y!=e||this.width!=i||this.height!=r)};t.prototype.equalInnerArea=function(t,e){var i=this.x;var r=this.y;var a=this.x+this.width;var n=this.y+this.height;var o=t.x;var s=t.y;var h=t.x+t.width;var u=t.y+t.height;if(Math.max(i,o)<=Math.min(a,h)&&Math.max(r,s)<=Math.min(n,u)){return true}return false};t.prototype.innerArea=function(e,i){i=i||new t;var r=this.x;var a=this.y;var n=this.x+this.width;var o=this.y+this.height;var s=e.x;var h=e.y;var u=e.x+e.width;var l=e.y+e.height;var c=Math.max(a,h);var f=Math.min(o,l);var d=Math.max(r,s);var p=Math.min(u,n);if(c>=0&&f>=0&&f-c>=0&&p-d>0){i.x=d;i.y=c;i.width=p-d;i.height=f-c}else{i.x=0;i.y=0;i.width=0;i.height=0}return i};t.prototype.setTo=function(t,e,i,r){this.x=t;this.y=e;this.width=i;this.height=r};return t}();t.Rectangle=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e,i,r){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=1}this.x=0;this.y=0;this.z=0;this.w=1;this.x=t;this.y=e;this.z=i;this.w=r}e.prototype.setTo=function(t,e,i,r){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=1}this.x=t;this.y=e;this.z=i;this.w=r};Object.defineProperty(e.prototype,"magnitude",{get:function(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:true,configurable:true});e.prototype.fromArray=function(t){this.x=-t[0];this.y=-t[1];this.z=t[2];this.w=t[3]};e.prototype.multiply=function(t,e){var i=t.w,r=t.x,a=t.y,n=t.z;var o=e.w,s=e.x,h=e.y,u=e.z;this.w=i*o-r*s-a*h-n*u;this.x=i*s+r*o+a*u-n*h;this.y=i*h-r*u+a*o+n*s;this.z=i*u+r*h-a*s+n*o};e.prototype.multiplyVector=function(t,i){if(i===void 0){i=null}if(i===null){i=new e}var r=t.x;var a=t.y;var n=t.z;i.w=-this.x*r-this.y*a-this.z*n;i.x=this.w*r+this.y*n-this.z*a;i.y=this.w*a-this.x*n+this.z*r;i.z=this.w*n+this.x*a-this.y*r;return i};e.prototype.fromAxisAngle=function(t,e){e*=Math.PI/180;var i=e*.5;var r=Math.sin(i);this.w=Math.cos(i);this.x=t.x*r;this.y=t.y*r;this.z=t.z*r;this.normalize()};e.prototype.toAxisAngle=function(t){var e=this.x*this.x+this.y*this.y+this.z*this.z;var i=0;if(e>0){i=2*Math.acos(this.w);e=1/Math.sqrt(e);t.x=this.x*e;t.y=this.y*e;t.z=this.z*e}else{i=0;t.x=1;t.y=0;t.z=0}i/=Math.PI/180;return i};e.prototype.slerp=function(t,e,i){var r=t.w,a=t.x,n=t.y,o=t.z;var s=e.w,h=e.x,u=e.y,l=e.z;var c=r*s+a*h+n*u+o*l;if(c<0){c=-c;s=-s;h=-h;u=-u;l=-l}if(c<.95){var f=Math.acos(c);var d=1/Math.sin(f);var p=Math.sin(f*(1-i))*d;var _=Math.sin(f*i)*d;this.w=r*p+s*_;this.x=a*p+h*_;this.y=n*p+u*_;this.z=o*p+l*_}else{this.w=r+i*(s-r);this.x=a+i*(h-a);this.y=n+i*(u-n);this.z=o+i*(l-o);var m=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=m;this.x*=m;this.y*=m;this.z*=m}};e.prototype.lerp=function(t,e,i){var r=t.w,a=t.x,n=t.y,o=t.z;var s=e.w,h=e.x,u=e.y,l=e.z;var c;if(r*s+a*h+n*u+o*l<0){s=-s;h=-h;u=-u;l=-l}this.w=r+i*(s-r);this.x=a+i*(h-a);this.y=n+i*(u-n);this.z=o+i*(l-o);c=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=c;this.x*=c;this.y*=c;this.z*=c};e.prototype.fromEulerAngles=function(e,i,r){e*=t.MathUtil.DEGREES_TO_RADIANS;i*=t.MathUtil.DEGREES_TO_RADIANS;r*=t.MathUtil.DEGREES_TO_RADIANS;var a=e*.5,n=i*.5,o=r*.5;var s=Math.cos(a),h=Math.sin(a);var u=Math.cos(n),l=Math.sin(n);var c=Math.cos(o),f=Math.sin(o);this.w=s*u*c+h*l*f;this.x=h*u*c-s*l*f;this.y=s*l*c+h*u*f;this.z=s*u*f-h*l*c;return this};e.prototype.toEulerAngles=function(e){if(e===void 0){e=null}if(e===null){e=new t.Vector3D}e.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y));var i=2*(this.w*this.y-this.z*this.x);i=t.MathUtil.clampf(i,-1,1);e.y=Math.asin(i);e.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z));e.x/=t.MathUtil.DEGREES_TO_RADIANS;e.y/=t.MathUtil.DEGREES_TO_RADIANS;e.z/=t.MathUtil.DEGREES_TO_RADIANS;return e};e.prototype.normalize=function(t){if(t===void 0){t=1}var e=t/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=e;this.y*=e;this.z*=e;this.w*=e};e.prototype.toString=function(){return"{x:"+this.x+" y:"+this.y+" z:"+this.z+" w:"+this.w+"}"};e.prototype.toMatrix3D=function(e){if(e===void 0){e=null}var i=this.x;var r=this.y;var a=this.z;var n=this.w;var o=t.MathUtil.RAW_DATA_CONTAINER;var s=2*i*r,h=2*i*a,u=2*i*n;var l=2*r*a,c=2*r*n,f=2*a*n;var d=i*i,p=r*r,_=a*a,m=n*n;o[0]=d-p-_+m;o[4]=s-f;o[8]=h+c;o[12]=0;o[1]=s+f;o[5]=-d+p-_+m;o[9]=l-u;o[13]=0;o[2]=h-c;o[6]=l+u;o[10]=-d-p+_+m;o[14]=0;o[3]=0;o[7]=0;o[11]=0;o[15]=1;if(!e)return new t.Matrix4_4(new Float32Array(o));e.copyRawDataFrom(o);return e};e.prototype.fromMatrix=function(e){var i=e.decompose(t.Orientation3D.QUATERNION)[1];this.x=i.x;this.y=i.y;this.z=i.z;this.w=i.w};e.prototype.inverse=function(t){if(t===void 0){t=null}if(!t){t=new e}var i=this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z;if(i>0){var r=1/i;t.w=this.w*r;t.x=-this.x*r;t.y=-this.y*r;t.z=-this.z*r}return t};e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)};e.prototype.transformVector=function(e,i){if(i===void 0){i=null}var r,a,n,o;var s=e.x,h=e.y,u=e.z;if(i===null){i=new t.Vector3D}o=-this.x*s-this.y*h-this.z*u;r=this.w*s+this.y*u-this.z*h;a=this.w*h-this.x*u+this.z*s;n=this.w*u+this.x*h-this.y*s;i.x=-o*this.x+r*this.w-a*this.z+n*this.y;i.y=-o*this.y+r*this.z+a*this.w-n*this.x;i.z=-o*this.z-r*this.y+a*this.x+n*this.w;return i};e.prototype.fromToRotation=function(e,i){var r=new t.Matrix4_4;t.Matrix4_4.fromToRotation(e,i,r);this.fromMatrix(r)};e.fromToRotation=function(t,i,r){if(r===void 0){r=null}if(!r){r=new e}r.fromToRotation(t,i);return r};e.prototype.copyFrom=function(t){var e=this;e.x=t.x;e.y=t.y;e.z=t.z;e.w=t.w};e.HELP_0=new e;e.HELP_1=new e;e.HELP_2=new e;return e}();t.Quaternion=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.AXIS_ANGLE="axisAngle";t.EULER_ANGLES="eulerAngles";t.QUATERNION="quaternion";return t}();t.Orientation3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e,i,r){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=0}this.a=t;this.b=e;this.c=i;this.d=r}e.prototype.setTo=function(t,e,i,r){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=0}this.a=t;this.b=e;this.c=i;this.d=r};e.prototype.fromPoints=function(t,e,i){var r=e.x-t.x;var a=e.y-t.y;var n=e.z-t.z;var o=i.x-t.x;var s=i.y-t.y;var h=i.z-t.z;this.a=a*h-n*s;this.b=n*o-r*h;this.c=r*s-a*o;this.d=-(this.a*t.x+this.b*t.y+this.c*t.z)};e.prototype.fromNormalAndPoint=function(t,e){this.a=t.x;this.b=t.y;this.c=t.z;this.d=-(this.a*e.x+this.b*e.y+this.c*e.z)};e.prototype.normalize=function(){var t=Math.sqrt(this.a*this.a+this.b*this.b+this.c*this.c);if(t>0){var e=1/t;this.a*=e;this.b*=e;this.c*=e;this.d*=e}return t};e.prototype.distance=function(t){return this.a*t.x+this.b*t.y+this.c*t.z+this.d};e.prototype.classifyPoint=function(e,i){if(i===void 0){i=.01}var r=this.distance(e);if(r<-i){return t.PlaneClassification.BACK}else if(r>i){return t.PlaneClassification.FRONT}return t.PlaneClassification.INTERSECT};e.prototype.toString=function(){return"Plane3D [a:"+this.a+", b:"+this.b+", c:"+this.c+", d:"+this.d+"]"};e.ALIGN_ANY=0;e.ALIGN_XY_AXIS=1;e.ALIGN_YZ_AXIS=2;e.ALIGN_XZ_AXIS=3;return e}();t.Plane3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){if(t===void 0){t=null}this.length=16;this.rowLength=4;if(t){this.rawData=t}else this.rawData=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}e.prototype.lookAt=function(e,i,r){if(r===void 0){r=t.Vector3D.Y_AXIS}var a=this.rawData;i.subtract(e,t.Vector3D.HELP_0);var n=t.Vector3D.HELP_0;n.normalize();var o=r.crossProduct(n,t.Vector3D.HELP_1);if(o.length<.05){o.x=r.y;o.y=r.x;if(Math.abs(o.x-o.y)<.05){o.x=-r.z;o.y=r.x;o.z=0}else{o.z=0}}o.normalize();var s=n.crossProduct(o,t.Vector3D.HELP_2);a[0]=o.x;a[1]=s.x;a[2]=n.x;a[3]=0;a[4]=o.y;a[5]=s.y;a[6]=n.y;a[7]=0;a[8]=o.z;a[9]=s.z;a[10]=n.z;a[11]=0;a[12]=-o.dotProduct(e);a[13]=-s.dotProduct(e);a[14]=-n.dotProduct(e);a[15]=1};e.prototype.multiply=function(t){var i=this.rawData,r=t.rawData,a=e.helpMatrix;a[0]=i[0]*r[0]+i[1]*r[4]+i[2]*r[8]+i[3]*r[12];a[1]=i[0]*r[1]+i[1]*r[5]+i[2]*r[9]+i[3]*r[13];a[2]=i[0]*r[2]+i[1]*r[6]+i[2]*r[10]+i[3]*r[14];a[3]=i[0]*r[3]+i[1]*r[7]+i[2]*r[11]+i[3]*r[15];a[4]=i[4]*r[0]+i[5]*r[4]+i[6]*r[8]+i[7]*r[12];a[5]=i[4]*r[1]+i[5]*r[5]+i[6]*r[9]+i[7]*r[13];a[6]=i[4]*r[2]+i[5]*r[6]+i[6]*r[10]+i[7]*r[14];a[7]=i[4]*r[3]+i[5]*r[7]+i[6]*r[11]+i[7]*r[15];a[8]=i[8]*r[0]+i[9]*r[4]+i[10]*r[8]+i[11]*r[12];a[9]=i[8]*r[1]+i[9]*r[5]+i[10]*r[9]+i[11]*r[13];a[10]=i[8]*r[2]+i[9]*r[6]+i[10]*r[10]+i[11]*r[14];a[11]=i[8]*r[3]+i[9]*r[7]+i[10]*r[11]+i[11]*r[15];a[12]=i[12]*r[0]+i[13]*r[4]+i[14]*r[8]+i[15]*r[12];a[13]=i[12]*r[1]+i[13]*r[5]+i[14]*r[9]+i[15]*r[13];a[14]=i[12]*r[2]+i[13]*r[6]+i[14]*r[10]+i[15]*r[14];a[15]=i[12]*r[3]+i[13]*r[7]+i[14]*r[11]+i[15]*r[15];i[0]=a[0];i[1]=a[1];i[2]=a[2];i[3]=a[3];i[4]=a[4];i[5]=a[5];i[6]=a[6];i[7]=a[7];i[8]=a[8];i[9]=a[9];i[10]=a[10];i[11]=a[11];i[12]=a[12];i[13]=a[13];i[14]=a[14];i[15]=a[15]};e.prototype.perspectiveB=function(t,e,i,r){var a=Math.tan(t*Math.PI/360)*i;var n=a*e;return this.frustum(-n,n,-a,a,i,r)};e.prototype.frustum=function(t,e,i,r,a,n){var o=this.rawData;o[0]=2*a/(e-t);o[1]=0;o[2]=(e+t)/(e-t);o[3]=0;o[4]=0;o[5]=2*a/(r-i);o[6]=(r+i)/(r-i);o[7]=0;o[8]=0;o[9]=0;o[10]=-(n+a)/(n-a);o[11]=-2*n*a/(n-a);o[12]=0;o[13]=0;o[14]=-1;o[15]=0;return this};e.prototype.perspective=function(t,e,i,r){var a=this.rawData;var n=t*(Math.PI/180);var o=Math.tan((Math.PI-n)/2);var s=o/e;a[0]=s;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=o;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=r/(r-i);a[11]=1;a[12]=0;a[13]=0;a[14]=-i*r/(r-i);a[15]=0};e.prototype.ortho=function(t,e,i,r){var a=this.rawData;a[0]=2/t;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=2/e;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1/(r-i);a[11]=0;a[12]=0;a[13]=0;a[14]=i/(i-r);a[15]=1};e.prototype.orthoOffCenter=function(t,e,i,r,a,n){var o=this.rawData;o[0]=2/(e-t);o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=2/(r-i);o[6]=0;o[7]=0;o[8]=0;o[9]=0;o[10]=1/(n-a);o[11]=0;o[12]=(t+e)/(t-e);o[13]=(r+i)/(i-r);o[14]=a/(a-n);o[15]=1};e.prototype.fromToRotation=function(e,i){var r=this.rawData;var a=1e-6;var n=t.Vector3D.HELP_0;i.crossProduct(e,n);var o=i.dotProduct(e);if(o>1-a){this.identity()}else if(3<-1+a){var s=t.Vector3D.HELP_1;var h=t.Vector3D.HELP_2;var u=0;var l=void 0,c=void 0,f=void 0,d=void 0,p=void 0,_=void 0;var m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,b=void 0;var D=void 0,T=void 0,P=void 0,A=void 0,w=void 0,S=void 0;h.x=0;h.y=e.z;h.z=-e.y;if(h.dotProduct(h)<a){h.x=-e.z;h.y=0;h.z=e.x}u=1/Math.sqrt(h.dotProduct(h));h[0]*=u;h[1]*=u;h[2]*=u;h.crossProduct(e,s);l=-e.x*e.x;c=-e.y*e.y;f=-e.z*e.z;d=-e.x*e.y;p=-e.x*e.z;_=-e.y*e.z;m=s.x*s.x;v=s.y*s.y;g=s.z*s.z;y=s.x*s.y;x=s.x*s.z;b=s.y*s.z;D=-h.x*h.x;T=-h.y*h.y;P=-h.z*h.z;A=-h.x*h.y;w=-h.x*h.z;S=-h.y*h.z;r[0]=l+m+D;r[1]=d+y+A;r[2]=p+x+w;r[4]=r[1];r[5]=c+v+T;r[6]=_+b+S;r[8]=r[2];r[9]=r[6];r[10]=f+g+P;r[3]=0;r[7]=0;r[11]=0;r[15]=1}else{var C=void 0,E=void 0,L=void 0,M=void 0,F=void 0;var R=(1-o)/n.dotProduct(n);C=R*n.x;E=R*n.z;L=C*n.y;M=C*n.z;F=E*n.y;r[0]=o+C*n.x;r[1]=L-n.z;r[2]=M+n.y;r[4]=L+n.z;r[5]=o+R*n.y*n.y;r[6]=F-n.x;r[8]=M-n.y;r[9]=F+n.x;r[10]=o+E*n.z;r[3]=0;r[7]=0;r[11]=0;r[15]=1}};e.fromToRotation=function(t,i,r){if(r===void 0){r=null}if(!r){r=new e}r.fromToRotation(t,i);return r};e.prototype.append=function(t){var e=this.rawData;var i=e[0],r=e[4],a=e[8],n=e[12],o=e[1],s=e[5],h=e[9],u=e[13],l=e[2],c=e[6],f=e[10],d=e[14],p=e[3],_=e[7],m=e[11],v=e[15];e[0]=i*t.rawData[0]+o*t.rawData[4]+l*t.rawData[8]+p*t.rawData[12];e[1]=i*t.rawData[1]+o*t.rawData[5]+l*t.rawData[9]+p*t.rawData[13];e[2]=i*t.rawData[2]+o*t.rawData[6]+l*t.rawData[10]+p*t.rawData[14];e[3]=i*t.rawData[3]+o*t.rawData[7]+l*t.rawData[11]+p*t.rawData[15];e[4]=r*t.rawData[0]+s*t.rawData[4]+c*t.rawData[8]+_*t.rawData[12];e[5]=r*t.rawData[1]+s*t.rawData[5]+c*t.rawData[9]+_*t.rawData[13];e[6]=r*t.rawData[2]+s*t.rawData[6]+c*t.rawData[10]+_*t.rawData[14];e[7]=r*t.rawData[3]+s*t.rawData[7]+c*t.rawData[11]+_*t.rawData[15];e[8]=a*t.rawData[0]+h*t.rawData[4]+f*t.rawData[8]+m*t.rawData[12];e[9]=a*t.rawData[1]+h*t.rawData[5]+f*t.rawData[9]+m*t.rawData[13];e[10]=a*t.rawData[2]+h*t.rawData[6]+f*t.rawData[10]+m*t.rawData[14];e[11]=a*t.rawData[3]+h*t.rawData[7]+f*t.rawData[11]+m*t.rawData[15];e[12]=n*t.rawData[0]+u*t.rawData[4]+d*t.rawData[8]+v*t.rawData[12];e[13]=n*t.rawData[1]+u*t.rawData[5]+d*t.rawData[9]+v*t.rawData[13];e[14]=n*t.rawData[2]+u*t.rawData[6]+d*t.rawData[10]+v*t.rawData[14];e[15]=n*t.rawData[3]+u*t.rawData[7]+d*t.rawData[11]+v*t.rawData[15]};e.prototype.add=function(t){var e=this.rawData;var i=e[0],r=e[4],a=e[8],n=e[12],o=e[1],s=e[5],h=e[9],u=e[13],l=e[2],c=e[6],f=e[10],d=e[14],p=e[3],_=e[7],m=e[11],v=e[15],g=t.rawData[0],y=t.rawData[4],x=t.rawData[8],b=t.rawData[12],D=t.rawData[1],T=t.rawData[5],P=t.rawData[9],A=t.rawData[13],w=t.rawData[2],S=t.rawData[6],C=t.rawData[10],E=t.rawData[14],L=t.rawData[3],M=t.rawData[7],F=t.rawData[11],R=t.rawData[15];e[0]=i+g;e[1]=o+D;e[2]=l+w;e[3]=p+L;e[4]=r+y;e[5]=s+T;e[6]=c+S;e[7]=_+M;e[8]=a+x;e[9]=h+P;e[10]=f+C;e[11]=m+F;e[12]=n+b;e[13]=u+A;e[14]=d+E;e[15]=v+R;return this};e.prototype.sub=function(t){var e=this.rawData;var i=e[0],r=e[4],a=e[8],n=e[12],o=e[1],s=e[5],h=e[9],u=e[13],l=e[2],c=e[6],f=e[10],d=e[14],p=e[3],_=e[7],m=e[11],v=e[15],g=t.rawData[0],y=t.rawData[4],x=t.rawData[8],b=t.rawData[12],D=t.rawData[1],T=t.rawData[5],P=t.rawData[9],A=t.rawData[13],w=t.rawData[2],S=t.rawData[6],C=t.rawData[10],E=t.rawData[14],L=t.rawData[3],M=t.rawData[7],F=t.rawData[11],R=t.rawData[15];e[0]=i-g;e[1]=o-D;e[2]=l-w;e[3]=p-L;e[4]=r-y;e[5]=s-T;e[6]=c-S;e[7]=_-M;e[8]=a-x;e[9]=h-P;e[10]=f-C;e[11]=m-F;e[12]=n-b;e[13]=u-A;e[14]=d-E;e[15]=v-R;return this};e.prototype.mult=function(t){var e=this.rawData;e[0]*=t;e[1]*=t;e[2]*=t;e[3]*=t;e[4]*=t;e[5]*=t;e[6]*=t;e[7]*=t;e[8]*=t;e[9]*=t;e[10]*=t;e[11]*=t;e[12]*=t;e[13]*=t;e[14]*=t;e[15]*=t;return this};e.prototype.rotation=function(i,r,a){t.MathUtil.CALCULATION_QUATERNION.fromEulerAngles(i,r,a);this.makeTransform(e.position_000,e.scale_111,t.MathUtil.CALCULATION_QUATERNION)};e.prototype.appendRotation=function(t,i){var r=e.getAxisRotation(i.x,i.y,i.z,t);this.append(r)};e.prototype.createByRotation=function(e,i){var r=t.MathUtil.CALCULATION_MATRIX;var a,n;var o=e*t.MathUtil.DEGREES_TO_RADIANS;a=Math.sin(o);n=Math.cos(o);if(i.x==1){r.rawData[0]=1;r.rawData[1]=0;r.rawData[2]=0;r.rawData[3]=0;r.rawData[4]=0;r.rawData[5]=n;r.rawData[6]=a;r.rawData[7]=0;r.rawData[8]=0;r.rawData[9]=-a;r.rawData[10]=n;r.rawData[11]=0;r.rawData[12]=0;r.rawData[13]=0;r.rawData[14]=0;r.rawData[15]=1}if(i.y==1){r.rawData[0]=n;r.rawData[1]=0;r.rawData[2]=-a;r.rawData[3]=0;r.rawData[4]=0;r.rawData[5]=1;r.rawData[6]=0;r.rawData[7]=0;r.rawData[8]=a;r.rawData[9]=0;r.rawData[10]=n;r.rawData[11]=0;r.rawData[12]=0;r.rawData[13]=0;r.rawData[14]=0;r.rawData[15]=1}if(i.z==1){r.rawData[0]=n;r.rawData[1]=a;r.rawData[2]=0;r.rawData[3]=0;r.rawData[4]=-a;r.rawData[5]=n;r.rawData[6]=0;r.rawData[7]=0;r.rawData[8]=0;r.rawData[9]=0;r.rawData[10]=1;r.rawData[11]=0;r.rawData[12]=0;r.rawData[13]=0;r.rawData[14]=0;r.rawData[15]=1}this.append(r)};e.prototype.appendScale=function(t,i,r){e.helpMatrix.createByScale(t,i,r);this.append(e.helpMatrix)};e.prototype.createByScale=function(t,e,i){var r=this.rawData;r[0]=t;r[1]=0;r[2]=0;r[3]=0;r[4]=0;r[5]=e;r[6]=0;r[7]=0;r[8]=0;r[9]=0;r[10]=i;r[11]=0;r[12]=0;r[13]=0;r[14]=0;r[15]=1};e.prototype.appendTranslation=function(t,e,i){var r=this.rawData;r[12]+=t;r[13]+=e;r[14]+=i};e.prototype.clone=function(){var t=new e;t.copyFrom(this);return t};e.prototype.copyRowFrom=function(t,e){var i=this.rawData;switch(t){case 0:i[0]=e.x;i[1]=e.y;i[2]=e.z;i[3]=e.w;break;case 1:i[4]=e.x;i[5]=e.y;i[6]=e.z;i[7]=e.w;break;case 2:i[8]=e.x;i[9]=e.y;i[10]=e.z;i[11]=e.w;break;case 3:i[12]=e.x;i[13]=e.y;i[14]=e.z;i[15]=e.w;break;default:}};e.prototype.copyRowTo=function(t,e){var i=this.rawData;switch(t){case 0:e.x=i[0];e.y=i[1];e.z=i[2];e.w=i[3];break;case 1:e.x=i[4];e.y=i[5];e.z=i[6];e.w=i[7];break;case 2:e.x=i[8];e.y=i[9];e.z=i[10];e.w=i[11];break;case 3:e.x=i[12];e.y=i[13];e.z=i[14];e.w=i[15];break;default:}};e.prototype.copyFrom=function(t){var e=this.rawData;e[0]=t.rawData[0];e[1]=t.rawData[1];e[2]=t.rawData[2];e[3]=t.rawData[3];e[4]=t.rawData[4];e[5]=t.rawData[5];e[6]=t.rawData[6];e[7]=t.rawData[7];e[8]=t.rawData[8];e[9]=t.rawData[9];e[10]=t.rawData[10];e[11]=t.rawData[11];e[12]=t.rawData[12];e[13]=t.rawData[13];e[14]=t.rawData[14];e[15]=t.rawData[15];return this};e.prototype.copyRawDataFrom=function(t,e,i){if(e===void 0){e=0}if(i===void 0){i=false}var r=this.rawData;r[0]=t[0+e];r[1]=t[1+e];r[2]=t[2+e];r[3]=t[3+e];r[4]=t[4+e];r[5]=t[5+e];r[6]=t[6+e];r[7]=t[7+e];r[8]=t[8+e];r[9]=t[9+e];r[10]=t[10+e];r[11]=t[11+e];r[12]=t[12+e];r[13]=t[13+e];r[14]=t[14+e];r[15]=t[15+e]};e.prototype.copyRawDataTo=function(t,e,i){if(e===void 0){e=0}if(i===void 0){i=false}var r=this.rawData;t[0+e]=r[0];t[1+e]=r[1];t[2+e]=r[2];t[3+e]=r[3];t[4+e]=r[4];t[5+e]=r[5];t[6+e]=r[6];t[7+e]=r[7];t[8+e]=r[8];t[9+e]=r[9];t[10+e]=r[10];t[11+e]=r[11];t[12+e]=r[12];t[13+e]=r[13];t[14+e]=r[14];t[15+e]=r[15]};e.prototype.copyColFrom=function(t,e){var i=this.rawData;switch(t){case 0:i[0]=e.x;i[4]=e.y;i[8]=e.z;i[12]=e.w;break;case 1:i[1]=e.x;i[5]=e.y;i[9]=e.z;i[13]=e.w;break;case 2:i[2]=e.x;i[6]=e.y;i[10]=e.z;i[14]=e.w;break;case 3:i[3]=e.x;i[7]=e.y;i[11]=e.z;i[15]=e.w;break;default:new Error("no more raw!")}};e.prototype.copyColTo=function(t,e){var i=this.rawData;switch(t){case 0:e.x=i[0];e.y=i[4];e.z=i[8];e.w=i[12];break;case 1:e.x=i[1];e.y=i[5];e.z=i[9];e.w=i[13];break;case 2:e.x=i[2];e.y=i[6];e.z=i[10];e.w=i[14];break;case 3:e.x=i[3];e.y=i[7];e.z=i[11];e.w=i[15];break;default:new Error("no more raw!")}};e.prototype.copyToMatrix3D=function(t){t.rawData=this.rawData.slice(0)};e.prototype.decompose=function(i,r){if(i===void 0){i="eulerAngles"}if(r===void 0){r=null}var a=t.MathUtil.CALCULATION_QUATERNION;var n=r?r:e.prs;this.copyRawDataTo(e.helpMatrix.rawData);var o=e.helpMatrix.rawData;var s=n[0];s.x=o[12];s.y=o[13];s.z=o[14];o[12]=0;o[13]=0;o[14]=0;var h=n[2];h.x=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]);h.y=Math.sqrt(o[4]*o[4]+o[5]*o[5]+o[6]*o[6]);h.z=Math.sqrt(o[8]*o[8]+o[9]*o[9]+o[10]*o[10]);if(o[0]*(o[5]*o[10]-o[6]*o[9])-o[1]*(o[4]*o[10]-o[6]*o[8])+o[2]*(o[4]*o[9]-o[5]*o[8])<0)h.z=-h.z;o[0]/=h.x;o[1]/=h.x;o[2]/=h.x;o[4]/=h.y;o[5]/=h.y;o[6]/=h.y;o[8]/=h.z;o[9]/=h.z;o[10]/=h.z;var u=n[1];switch(i){case t.Orientation3D.AXIS_ANGLE:u.w=Math.acos((o[0]+o[5]+o[10]-1)/2);var l=Math.sqrt((o[6]-o[9])*(o[6]-o[9])+(o[8]-o[2])*(o[8]-o[2])+(o[1]-o[4])*(o[1]-o[4]));u.x=(o[6]-o[9])/l;u.y=(o[8]-o[2])/l;u.z=(o[1]-o[4])/l;break;case t.Orientation3D.QUATERNION:var c=o[0]+o[5]+o[10];if(c>0){u.w=Math.sqrt(1+c)/2;u.x=(o[6]-o[9])/(4*u.w);u.y=(o[8]-o[2])/(4*u.w);u.z=(o[1]-o[4])/(4*u.w)}else if(o[0]>o[5]&&o[0]>o[10]){u.x=Math.sqrt(1+o[0]-o[5]-o[10])/2;u.w=(o[6]-o[9])/(4*u.x);u.y=(o[1]+o[4])/(4*u.x);u.z=(o[8]+o[2])/(4*u.x)}else if(o[5]>o[10]){u.y=Math.sqrt(1+o[5]-o[0]-o[10])/2;u.x=(o[1]+o[4])/(4*u.y);u.w=(o[8]-o[2])/(4*u.y);u.z=(o[6]+o[9])/(4*u.y)}else{u.z=Math.sqrt(1+o[10]-o[0]-o[5])/2;u.x=(o[8]+o[2])/(4*u.z);u.y=(o[6]+o[9])/(4*u.z);u.w=(o[1]-o[4])/(4*u.z)}break;case t.Orientation3D.EULER_ANGLES:var c=o[0]+o[5]+o[10];if(c>0){a.w=Math.sqrt(1+c)/2;a.x=(o[6]-o[9])/(4*a.w);a.y=(o[8]-o[2])/(4*a.w);a.z=(o[1]-o[4])/(4*a.w)}else if(o[0]>o[5]&&o[0]>o[10]){a.x=Math.sqrt(1+o[0]-o[5]-o[10])/2;a.w=(o[6]-o[9])/(4*a.x);a.y=(o[1]+o[4])/(4*a.x);a.z=(o[8]+o[2])/(4*a.x)}else if(o[5]>o[10]){u.y=Math.sqrt(1+o[5]-o[0]-o[10])/2;a.x=(o[1]+o[4])/(4*a.y);a.w=(o[8]-o[2])/(4*a.y);a.z=(o[6]+o[9])/(4*a.y)}else{a.z=Math.sqrt(1+o[10]-o[0]-o[5])/2;a.x=(o[8]+o[2])/(4*a.z);a.y=(o[6]+o[9])/(4*a.z);a.w=(o[1]-o[4])/(4*a.z)}a.toEulerAngles(u);break}n[0]=s;n[1]=u;n[2]=h;return n};e.prototype.deltaTransformVector=function(e,i){if(i===void 0){i=null}if(!i){i=new t.Vector3D}var r=this.rawData;var a=e.x;var n=e.y;var o=e.z;i.x=a*r[0]+n*r[4]+o*r[8];i.y=a*r[1]+n*r[5]+o*r[9];i.z=a*r[2]+n*r[6]+o*r[10];i.w=a*r[3]+n*r[7]+o*r[11];return i};e.prototype.identity=function(){var t=this.rawData;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[0]=1;t[5]=1;t[10]=1;t[15]=1};e.prototype.fill=function(t){var e=this.rawData;e[1]=t;e[2]=t;e[3]=t;e[4]=t;e[6]=t;e[7]=t;e[8]=t;e[9]=t;e[11]=t;e[12]=t;e[13]=t;e[14]=t;e[0]=t;e[5]=t;e[10]=t;e[15]=t};e.prototype.invers33=function(){var t=this.rawData;var e=t[5]*t[10]-t[9]*t[6];var i=t[8]*t[6]-t[4]*t[10];var r=t[4]*t[9]-t[8]*t[5];var a=t[9]*t[2]-t[1]*t[10];var n=t[0]*t[10]-t[8]*t[2];var o=t[8]*t[1]-t[0]*t[9];var s=t[1]*t[6]-t[5]*t[2];var h=t[4]*t[2]-t[0]*t[6];var u=t[0]*t[5]-t[4]*t[1];var l=t[0]*e+t[4]*a+t[8]*s;if(Math.abs(l)>1e-11){var c=1/l;t[0]=c*e;t[4]=c*i;t[8]=c*r;t[1]=c*a;t[5]=c*n;t[9]=c*o;t[2]=c*s;t[6]=c*h;t[10]=c*u}};e.transpose=function(t,i){i=i||new e;var r=t.rawData,a=i.rawData;a[0]=r[0];a[1]=r[4];a[2]=r[8];a[3]=r[12];a[4]=r[1];a[5]=r[5];a[6]=r[9];a[7]=r[13];a[8]=r[2];a[9]=r[6];a[10]=r[10];a[11]=r[14];a[12]=r[3];a[13]=r[7];a[14]=r[11];a[15]=r[15];return i};e.inverse=function(t,i){i=i||new e;var r=t.rawData,a=i.rawData;a[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10];a[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10];
a[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6];a[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6];a[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10];a[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10];a[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6];a[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6];a[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9];a[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9];a[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5];a[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5];a[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9];a[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9];a[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5];a[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];var n=r[0]*a[0]+r[1]*a[4]+r[2]*a[8]+r[3]*a[12];for(var o=0;o<16;o++)a[o]/=n;return i};e.prototype.invert=function(){var t=this.determinant;var e=Math.abs(t)>1e-11;var i=this.rawData;if(e){t=1/t;var r=i[0];var a=i[4];var n=i[8];var o=i[12];var s=i[1];var h=i[5];var u=i[9];var l=i[13];var c=i[2];var f=i[6];var d=i[10];var p=i[14];var _=i[3];var m=i[7];var v=i[11];var g=i[15];i[0]=t*(h*(d*g-p*v)-u*(f*g-p*m)+l*(f*v-d*m));i[1]=-t*(s*(d*g-p*v)-u*(c*g-p*_)+l*(c*v-d*_));i[2]=t*(s*(f*g-p*m)-h*(c*g-p*_)+l*(c*m-f*_));i[3]=-t*(s*(f*v-d*m)-h*(c*v-d*_)+u*(c*m-f*_));i[4]=-t*(a*(d*g-p*v)-n*(f*g-p*m)+o*(f*v-d*m));i[5]=t*(r*(d*g-p*v)-n*(c*g-p*_)+o*(c*v-d*_));i[6]=-t*(r*(f*g-p*m)-a*(c*g-p*_)+o*(c*m-f*_));i[7]=t*(r*(f*v-d*m)-a*(c*v-d*_)+n*(c*m-f*_));i[8]=t*(a*(u*g-l*v)-n*(h*g-l*m)+o*(h*v-u*m));i[9]=-t*(r*(u*g-l*v)-n*(s*g-l*_)+o*(s*v-u*_));i[10]=t*(r*(h*g-l*m)-a*(s*g-l*_)+o*(s*m-h*_));i[11]=-t*(r*(h*v-u*m)-a*(s*v-u*_)+n*(s*m-h*_));i[12]=-t*(a*(u*p-l*d)-n*(h*p-l*f)+o*(h*d-u*f));i[13]=t*(r*(u*p-l*d)-n*(s*p-l*c)+o*(s*d-u*c));i[14]=-t*(r*(h*p-l*f)-a*(s*p-l*c)+o*(s*f-h*c));i[15]=t*(r*(h*d-u*f)-a*(s*d-u*c)+n*(s*f-h*c))}return e};e.prototype.makeTransform=function(e,i,r){this.createByScale(i.x,i.y,i.z);r.toMatrix3D(t.MathUtil.CALCULATION_MATRIX);this.append(t.MathUtil.CALCULATION_MATRIX);this.rawData[12]=e.x;this.rawData[13]=e.y;this.rawData[14]=e.z;this.rawData[15]=1};e.prototype.recompose=function(e){t.MathUtil.CALCULATION_QUATERNION.fromEulerAngles(e[1].x,e[1].y,e[1].z);this.makeTransform(e[0],e[2],t.MathUtil.CALCULATION_QUATERNION);return true};e.prototype.transformVector=function(e,i){if(i===void 0){i=null}var r=this.rawData;if(!i){i=new t.Vector3D}var a=e.x;var n=e.y;var o=e.z;i.x=a*r[0]+n*r[4]+o*r[8]+r[12];i.y=a*r[1]+n*r[5]+o*r[9]+r[13];i.z=a*r[2]+n*r[6]+o*r[10]+r[14];i.w=a*r[3]+n*r[7]+o*r[11]+r[15];return i};e.prototype.transformVector4=function(e,i){if(i===void 0){i=null}var r=this.rawData;if(!i){i=new t.Vector3D}var a=e.x;var n=e.y;var o=e.z;var s=e.w;i.x=a*r[0]+n*r[4]+o*r[8]+s*r[12];i.y=a*r[1]+n*r[5]+o*r[9]+s*r[13];i.z=a*r[2]+n*r[6]+o*r[10]+s*r[14];i.w=a*r[3]+n*r[7]+o*r[11]+s*r[15];return i};e.prototype.mat3TransformVector=function(e,i){if(i===void 0){i=null}var r=this.rawData;if(!i){i=new t.Vector3D}var a=e.x;var n=e.y;var o=e.z;i.x=a*r[0]+n*r[4]+o*r[8];i.y=a*r[1]+n*r[5]+o*r[9];i.z=a*r[2]+n*r[6]+o*r[10];return i};e.prototype.transformPlane=function(i){var r=new e;r.copyFrom(this);r.invert();r.transpose();var a=new t.Vector3D(i.a,i.b,i.c,i.d);a.copyFrom(r.transformVector(a));var n=new t.Plane3D;n.a=a.x;n.b=a.y;n.c=a.z;n.d=a.w/Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);return n};e.prototype.transpose=function(){var t=this.rawData;for(var i=0;i<e.helpMatrix.rawData.length;i++){e.helpMatrix.rawData[i]=t[i]}t[1]=e.helpMatrix.rawData[4];t[2]=e.helpMatrix.rawData[8];t[3]=e.helpMatrix.rawData[12];t[4]=e.helpMatrix.rawData[1];t[6]=e.helpMatrix.rawData[9];t[7]=e.helpMatrix.rawData[13];t[8]=e.helpMatrix.rawData[2];t[9]=e.helpMatrix.rawData[6];t[11]=e.helpMatrix.rawData[14];t[12]=e.helpMatrix.rawData[3];t[13]=e.helpMatrix.rawData[7];t[14]=e.helpMatrix.rawData[11]};e.getAxisRotation=function(t,i,r,a){var n=new e;var o=a*(Math.PI/180);var s=Math.cos(o);var h=Math.sin(o);var u=1-s;var l,c;n.rawData[0]=s+t*t*u;n.rawData[5]=s+i*i*u;n.rawData[10]=s+r*r*u;l=t*i*u;c=r*h;n.rawData[1]=l+c;n.rawData[4]=l-c;l=t*r*u;c=i*h;n.rawData[8]=l+c;n.rawData[2]=l-c;l=i*r*u;c=t*h;n.rawData[9]=l-c;n.rawData[6]=l+c;return n};Object.defineProperty(e.prototype,"determinant",{get:function(){var t=this.rawData;return(t[0]*t[5]-t[4]*t[1])*(t[10]*t[15]-t[14]*t[11])-(t[0]*t[9]-t[8]*t[1])*(t[6]*t[15]-t[14]*t[7])+(t[0]*t[13]-t[12]*t[1])*(t[6]*t[11]-t[10]*t[7])+(t[4]*t[9]-t[8]*t[5])*(t[2]*t[15]-t[14]*t[3])-(t[4]*t[13]-t[12]*t[5])*(t[2]*t[11]-t[10]*t[3])+(t[8]*t[13]-t[12]*t[9])*(t[2]*t[7]-t[6]*t[3])},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"position",{get:function(){var e=this.rawData;return new t.Vector3D(e[12],e[13],e[14])},set:function(t){var e=this.rawData;e[12]=t.x;e[13]=t.y;e[14]=t.z},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"scale",{get:function(){var e=this.rawData;return new t.Vector3D(e[0],e[5],e[10])},enumerable:true,configurable:true});e.prototype.toString=function(){var t=this.rawData;return"matrix3d("+Math.round(t[0]*1e3)/1e3+","+Math.round(t[1]*1e3)/1e3+","+Math.round(t[2]*1e3)/1e3+","+Math.round(t[3]*1e3)/1e3+","+Math.round(t[4]*1e3)/1e3+","+Math.round(t[5]*1e3)/1e3+","+Math.round(t[6]*1e3)/1e3+","+Math.round(t[7]*1e3)/1e3+","+Math.round(t[8]*1e3)/1e3+","+Math.round(t[9]*1e3)/1e3+","+Math.round(t[10]*1e3)/1e3+","+Math.round(t[11]*1e3)/1e3+","+Math.round(t[12]*1e3)/1e3+","+Math.round(t[13]*1e3)/1e3+","+Math.round(t[14]*1e3)/1e3+","+Math.round(t[15]*1e3)/1e3+")"};e.prototype.lerp=function(t,e,i){this.copyFrom(e).sub(t).mult(i).add(t)};e.helpMatrix=new e;e.helpMatrix2=new e;e.position_000=new t.Vector3D;e.scale_111=new t.Vector3D(1,1,1);e.prs=[new t.Vector3D,new t.Vector3D,new t.Vector3D];return e}();t.Matrix4_4=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.BACK=0;t.FRONT=1;t.IN=0;t.OUT=1;t.INTERSECT=2;return t}();t.PlaneClassification=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.FloatEqual=function(t,e){return Math.abs(t-e)<1e-8};e.quaternion2matrix=function(i,r){if(r===void 0){r=null}var a=i.x;var n=i.y;var o=i.z;var s=i.w;var h=a*a;var u=a*n;var l=a*o;var c=a*s;var f=n*n;var d=n*o;var p=n*s;var _=o*o;var m=o*s;var v=e.RAW_DATA_CONTAINER;v[0]=1-2*(f+_);v[1]=2*(u+m);v[2]=2*(l-p);v[4]=2*(u-m);v[5]=1-2*(h+_);v[6]=2*(d+c);v[8]=2*(l+p);v[9]=2*(d-c);v[10]=1-2*(h+f);v[3]=v[7]=v[11]=v[12]=v[13]=v[14]=0;v[15]=1;if(r){r.copyRawDataFrom(v);return r}else return new t.Matrix4_4(new Float32Array(v))};e.getForward=function(e,i){if(i===void 0){i=null}if(i===null){i=new t.Vector3D(0,0,0)}e.copyRowTo(2,i);i.normalize();return i};e.getUp=function(e,i){if(i===void 0){i=null}if(i===null){i=new t.Vector3D(0,0,0)}e.copyRowTo(1,i);i.normalize();return i};e.getRight=function(e,i){if(i===void 0){i=null}if(i===null){i=new t.Vector3D(0,0,0)}e.copyRowTo(0,i);i.normalize();return i};e.compare=function(t,i){var r=e.RAW_DATA_CONTAINER;var a=i.rawData;t.copyRawDataTo(r);for(var n=0;n<16;++n){if(r[n]!=a[n])return false}return true};e.reflection=function(i,r){if(r===void 0){r=null}if(r===null)r=new t.Matrix4_4;var a=i.a,n=i.b,o=i.c,s=i.d;var h=e.RAW_DATA_CONTAINER;var u=-2*a*n;var l=-2*a*o;var c=-2*n*o;h[0]=1-2*a*a;h[4]=u;h[8]=l;h[12]=-2*a*s;h[1]=u;h[5]=1-2*n*n;h[9]=c;h[13]=-2*n*s;h[2]=l;h[6]=c;h[10]=1-2*o*o;h[14]=-2*o*s;h[3]=0;h[7]=0;h[11]=0;h[15]=1;r.copyRawDataFrom(h);return r};e.getTranslation=function(e,i){if(i===void 0){i=null}if(!i)i=new t.Vector3D;e.copyRowTo(3,i);return i};e.clampf=function(t,e,i){if(e>i){var r=e;e=i;i=r}return t<e?e:t<i?t:i};e.ScreenToPosition=function(t,e,i){return(t+e*.5)/i*2-1};e.PositionToScreen=function(t,e,i){return(t+1)*.5*i-e*.5};e.mix=function(t,e,i){return t*(1-i)+e*i};e.calcDegree=function(i,r){i.transformVector(t.Vector3D.Y_AXIS,this._tempVector);this._tempVector.x=0;this._tempVector.normalize();var a=t.Vector3D.Y_AXIS.dotProduct(this._tempVector);var n=Math.acos(a)*e.RADIANS_TO_DEGREES;if(this._tempVector.z<0){n=180-n}i.transformVector(t.Vector3D.Z_AXIS,this._tempVector);this._tempVector.y=0;this._tempVector.normalize();var o=t.Vector3D.Z_AXIS.dotProduct(this._tempVector);var s=Math.acos(o)*e.RADIANS_TO_DEGREES;if(this._tempVector.x<0){s=360-s}i.transformVector(t.Vector3D.X_AXIS,this._tempVector);this._tempVector.z=0;this._tempVector.normalize();var h=t.Vector3D.X_AXIS.dotProduct(this._tempVector);var u=Math.acos(h)*e.RADIANS_TO_DEGREES;if(this._tempVector.y<0){u=360-u}n=this.clampAngle(n);s=this.clampAngle(s);u=this.clampAngle(u);r.setTo(n,s,u)};e.clampAngle=function(t){while(t<-180){t+=360}while(t>180){t-=360}return t};e.RADIANS_TO_DEGREES=180/Math.PI;e.DEGREES_TO_RADIANS=Math.PI/180;e.MAX_VALUE=2147483647;e.MIN_VALUE=-2147483647;e.RAW_DATA_CONTAINER=new Float32Array(16);e.CALCULATION_MATRIX=new t.Matrix4_4;e.CALCULATION_QUATERNION=new t.Quaternion;e.CALCULATION_VECTOR3D=new t.Vector3D;e.CALCULATION_VECTOR3D_0=new t.Vector3D;e.CALCULATION_VECTOR3D_1=new t.Vector3D;e.CALCULATION_VECTOR3D_2=new t.Vector3D;e._tempVector=new t.Vector3D;return e}();t.MathUtil=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){if(e===void 0){e=new t.Vector3D}if(i===void 0){i=new t.Vector3D}this.origin=new t.Vector3D;this.dir=new t.Vector3D;this.invViewMat=new t.Matrix4_4;this.origin.copyFrom(e);this.dir.copyFrom(i)}e.prototype.IntersectTriangle=function(t,i,r,a){if(a===void 0){a=null}var n=i.subtract(t,e.v0);var o=r.subtract(t,e.v1);var s=this.dir.crossProduct(o,e.v2);var h=n.dotProduct(s);var u;if(h>0){u=this.origin.subtract(t,e.v3)}else{u=t.subtract(this.origin,e.v3);h=-h}if(h<1e-4){return false}var l=u.dotProduct(s);if(a!=null){a[1]=l}if(l<0||l>h){return false}var c=u.crossProduct(n,e.v4);var f=this.dir.dotProduct(c);if(a!=null){a[2]=f}if(f<0||l+f>h){return false}var d=o.dotProduct(c);var p=1/h;d*=p;l*=p;f*=p;if(a!=null){a[0]=d;a[1]=l;a[2]=f}if(d<0){return false}return true};e.prototype.IntersectSphere=function(i,r,a,n){if(a===void 0){a=null}if(n===void 0){n=null}a=a||[];e.transformCenter.copyFrom(i);e.v0.copyFrom(t.Vector3D.X_AXIS);e.v0.scaleBy(r);e.v0.add(e.transformCenter,e.v0);n.mat3TransformVector(e.v0,e.v0);e.v0.subtract(e.transformCenter,e.v0);r=e.v0.length;if(n){n.transformVector(i,e.transformCenter)}var o=0;var s=0;var h=e.transformCenter.subtract(this.origin,t.MathUtil.CALCULATION_VECTOR3D_0);var u=this.dir.dotProduct(h);if(u<0)return null;var l=h.dotProduct(h);var c=l-u*u;var f=r*r;if(c>f)return null;var d=f-c;if(d<0){o=s=u}else{d=Math.sqrt(d);o=u-d;s=u+d;if(o<0){o=s}}a.push(o);a.push(s);return a};e.prototype.IntersectBound=function(e,i){if(i===void 0){i=null}i=i||new t.PickResult;if(this.IntersectMesh(e.vexData,e.indexData,e.vexLength,e.indexData.length/3,0,e.transform,i)){return i}return null};e.prototype.IntersectMeshEx=function(t,e,i){return this.IntersectMesh(t.geometry.vertexArray,t.geometry.indexArray,t.geometry.vertexAttLength,t.geometry.faceCount,e,t.modelMatrix,i)};e.prototype.IntersectMesh=function(i,r,a,n,o,s,h){var u=e.modletriangle;var l=e.uvarray;var c=e.triangle;var f=c[0];var d=c[1];var p=c[2];var _=e.pos;var m=e.uv;var v=e.ret;var g=-1;var y=t.MathUtil.MAX_VALUE;var x=0;var b=0;for(var D=0;D<n;++D){for(var T=0;T<3;++T){var P=r[3*D+T];_.setTo(i[a*P+0],i[a*P+1],i[a*P+2]);_.copyFrom(s.transformVector(_));c[T].x=_.x;c[T].y=_.y;c[T].z=_.z}if(this.IntersectTriangle(f,d,p,v)){if(v[0]<y){g=D;y=v[0];x=v[1];b=v[2]}}}if(g<n&&g>=0){for(var D=0;D<3;++D){var P=r[3*g+D];_.setTo(i[a*P+0],i[a*P+1],i[a*P+2]);u[D].copyFrom(_);if(o>0){m.x=i[a*P+0+o];m.y=i[a*P+1+o];l[D].x=m.x;l[D].y=m.y}_.copyFrom(s.transformVector(_));c[D].x=_.x;c[D].y=_.y;c[D].z=_.z}h.faceIndex=g;h.v0=r[3*g+0];h.v1=r[3*g+1];h.v2=r[3*g+2];var A=d.subtract(f,e.v0);A.scaleBy(x);var w=p.subtract(f,e.v1);w.scaleBy(b);h.globalPosition.copyFrom(f.add(A.add(w,e.v2),e.v3));A=u[1].subtract(u[0],A);A.scaleBy(x);w=u[2].subtract(u[0],w);w.scaleBy(b);h.localPosition.copyFrom(u[0].add(A.add(w,e.v2),e.v3));if(o>0){A=l[1].subtract(l[0],A);A.scaleBy(x);w=l[2].subtract(l[0],w);w.scaleBy(b);h.uv.copyFrom(l[0].add(A.add(w,e.v2),e.v3))}return true}return false};e.prototype.CalculateAndTransformRay=function(t,i,r,a,n,o){this.reset();this.dir.x=(2*n/t-1)/a.rawData[0];this.dir.y=(-2*o/i+1)/a.rawData[5];this.dir.z=1;this.invViewMat.copyFrom(r);this.origin.copyFrom(this.invViewMat.transformVector(this.origin,e.v0));this.dir.copyFrom(this.invViewMat.deltaTransformVector(this.dir,e.v0));this.dir.normalize()};e.prototype.reset=function(){this.origin.setTo(0,0,0);this.dir.setTo(0,0,0)};e.v0=new t.Vector3D;e.v1=new t.Vector3D;e.v2=new t.Vector3D;e.v3=new t.Vector3D;e.v4=new t.Vector3D;e.transformCenter=new t.Vector3D;e.modletriangle=[new t.Vector3D,new t.Vector3D,new t.Vector3D];e.uvarray=[new t.Vector3D,new t.Vector3D,new t.Vector3D];e.triangle=[new t.Vector3D,new t.Vector3D,new t.Vector3D];e.ret=[0,0,0];e.pos=new t.Vector3D;e.uv=new t.Point;return e}();t.Ray=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e,i,r){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=255}this.a=255;this.r=255;this.g=255;this.b=255;this.a=r;this.r=t;this.g=e;this.b=i}e.white=function(){return new e(255,255,255,255)};e.black=function(){return new e(0,0,0,255)};e.red=function(){return new e(255,0,0,255)};e.green=function(){return new e(0,255,0,255)};e.blue=function(){return new e(0,0,255,255)};e.getColor=function(e,i,r){if(i===void 0){i=t.ContextConfig.ColorFormat_RGBA8888}if(r===void 0){r=null}if(!r){r=new t.Vector3D}r.setTo((e>>16&255)/255,(e>>8&255)/255,(e&255)/255,(e>>24&255)/255);return r};e.RGBAToColor=function(t,e,i,r){return r<<24|t<<16|e<<8|i};e.prototype.getColor=function(e){if(e===void 0){e=t.ContextConfig.ColorFormat_RGBA8888}if(e==t.ContextConfig.ColorFormat_RGB565)return 0;if(e==t.ContextConfig.ColorFormat_RGBA5551)return 0;if(e==t.ContextConfig.ColorFormat_RGBA4444)return 0;return this.r<<24|this.g<<16|this.b<<8|this.a};e.prototype.lerp=function(t,e,i){this.a=i*(e.a-t.a)+t.a;this.r=i*(e.r-t.r)+t.r;this.g=i*(e.g-t.g)+t.g;this.b=i*(e.b-t.b)+t.b;this.a=Math.floor(this.a);this.r=Math.floor(this.r);this.g=Math.floor(this.g);this.b=Math.floor(this.b)};e.prototype.copyFrom=function(t){this.a=t.a;this.r=t.r;this.g=t.g;this.b=t.b};e.prototype.setTo=function(t,e,i,r){if(t===void 0){t=255}if(e===void 0){e=255}if(i===void 0){i=255}if(r===void 0){r=255}this.a=t;this.r=e;this.g=i;this.b=r};e.createColor=function(t){var i=new e;i.setColorARGB(t);return i};e.prototype.setColorARGB=function(t){this.a=t/16777216;this.a>>=0;this.r=t&16711680;this.r>>=16;this.g=t&65280;this.g>>=8;this.b=t&255};e.prototype.setColorRGB=function(t){this.r=t&16711680;this.r>>=16;this.g=t&65280;this.g>>=8;this.b=t&255};e.prototype.randomColor=function(t,e,i){if(i===void 0){i=false}if(i){var r=Math.random();this.a=t.a+(e.a-t.a)*r;this.r=t.r+(e.r-t.r)*r;this.g=t.g+(e.g-t.g)*r;this.b=t.b+(e.b-t.b)*r}else{this.a=t.a+(e.a-t.a)*Math.random();this.r=t.r+(e.r-t.r)*Math.random();this.g=t.g+(e.g-t.g)*Math.random();this.b=t.b+(e.b-t.b)*Math.random()}this.a=Math.floor(this.a);this.r=Math.floor(this.r);this.g=Math.floor(this.g);this.b=Math.floor(this.b)};e.prototype.scaleBy=function(t){this.a*=t;this.r*=t;this.g*=t;this.b*=t};return e}();t.Color=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.colors=[];this.times=[]}e.prototype.lerpColor=function(e,i){if(i===void 0){i=null}if(e<0){e=0}else if(e>1){e=1}if(i==null)i=new t.Color;var r;var a;for(var n=0,o=this.times.length-1;n<o;n++){if(e>=this.times[n]&&e<this.times[n+1]){e=(e-this.times[n])/(this.times[n+1]-this.times[n]);i.lerp(this.colors[n],this.colors[n+1],e);break}}return i};return e}();t.ColorGradients=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){this.vexLength=3;this._bound=new t.Wireframe;this.matrix=new t.Matrix4_4;this.temp=new t.Vector3D;this.owner=e;this._bound.material.diffuseColor=16777215;this._bound.name="Bound";this._bound.geometry.vertexCount=8;this._bound.geometry.indexCount=24;this._bound.geometry.setVertexIndices(0,[0,1,1,2,2,3,0,3,4,5,5,6,6,7,4,7,0,4,1,5,3,7,2,6])}Object.defineProperty(e.prototype,"visible",{get:function(){return this._bound.parent?true:false},set:function(t){if(t){if(!this._bound.parent){this.owner.addChild(this._bound)}else{if(this._bound.parent!=this.owner){this._bound.parent.removeChild(this._bound);this.owner.addChild(this._bound)}}}else{if(this._bound.parent){this._bound.parent.removeChild(this._bound)}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"transform",{get:function(){if(!this.owner){return this.matrix}return this.owner.modelMatrix},enumerable:true,configurable:true});e.prototype.pointIntersect=function(t){return false};e.prototype.intersect=function(t,e){if(e===void 0){e=null}return true};e.prototype.clone=function(){var t=new e(this.owner);t.copyVertex(this);return t};e.prototype.calculateTransform=function(){for(var t=0;t<this.vexData.length;t+=3){this.temp.setTo(this.vexData[t],this.vexData[t+1],this.vexData[t+2]);this.transform.transformVector(this.temp,this.temp);this.vexData[t+0]=this.temp.x;this.vexData[t+1]=this.temp.y;this.vexData[t+2]=this.temp.z}};e.prototype.copyVertex=function(t){for(var e=0;e<t.vexData.length;++e){this.vexData[e]=t.vexData[e]}for(var e=0;e<t.indexData.length;++e){this.indexData[e]=t.indexData[e]}this.vexLength=t.vexLength};e.prototype.createChild=function(){this.childBound=new e(this.owner)};e.prototype.inBound=function(t){return true};e.prototype.updateAABB=function(){};e.prototype.dispose=function(){if(this._bound){this._bound.dispose()}if(this.childBound){this.childBound.dispose()}};return e}();t.Bound=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t){if(t===void 0){t=false}this.data=[];this.list=new Array;if(t){this.list=new Array}}t.prototype.isHas=function(t){if(this.data[t])return true;return false};t.prototype.getValue=function(t){return this.data[t]};t.prototype.getList=function(){return this.list};t.prototype.add=function(t,e){this.data[t]=e;if(this.list){this.list.push(e)}};t.prototype.remove=function(t){if(this.list){var e=this.list.indexOf(this.data[t]);if(e!=-1){this.list.splice(e)}}delete this.data[t]};t.prototype.dispose=function(){delete this.data;delete this.list};return t}();t.HashMap=e})(egret3d||(egret3d={}));var __extends=this&&this.__extends||function(t,e){for(var i in e)if(e.hasOwnProperty(i))t[i]=e[i];function r(){this.constructor=t}t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)};var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a){if(i===void 0){i=null}if(r===void 0){r=null}if(a===void 0){a=null}e.call(this,i);this.min=new t.Vector3D;this.max=new t.Vector3D;this.width=0;this.heigth=0;this.depth=0;this.volume=0;this.center=new t.Vector3D;this.radius=0;if(!r){r=new t.Vector3D}if(!a){a=new t.Vector3D}this.min.copyFrom(r);this.max.copyFrom(a);this.calculateBox()}i.prototype.copyFrom=function(t){this.min.copyFrom(t.min);this.max.copyFrom(t.max);this.calculateBox()};i.prototype.fillBox=function(t,e){this.min.copyFrom(t);this.max.copyFrom(e);this.calculateBox()};i.prototype.pointIntersect=function(t){if(t.x<=this.max.x&&t.x>=this.min.x&&t.y<=this.max.y&&t.y>=this.min.y&&t.z<=this.max.z&&t.z>=this.min.z){return true}return false};i.prototype.intersectAABBs=function(t,e){if(e===void 0){e=null}if(this.min.x>t.max.x){return false}if(this.max.x<t.min.x){return false}if(this.min.y>t.max.y){return false}if(this.max.y<t.min.y){return false}if(this.min.z>t.max.z){return false}if(this.max.z<t.min.z){return false}if(e!=null){e.min.x=Math.max(this.min.x,t.min.x);e.max.x=Math.min(this.max.x,t.max.x);e.min.y=Math.max(this.min.y,t.min.y);e.max.y=Math.min(this.max.y,t.max.y);e.min.z=Math.max(this.min.z,t.min.z);e.max.z=Math.min(this.max.z,t.max.z);e.calculateBox()}return true};i.prototype.intersect=function(t,e){if(e===void 0){e=null}if(!this._box0){this._box0=this.clone()}else{this._box0.copyVertex(this);this._box0.owner=this.owner}this._box0.calculateTransform();this._box0.updateAABB();if(!this._box1){this._box1=t.clone()}else{this._box1.copyVertex(this);this._box1.owner=t.owner}this._box1.calculateTransform();this._box1.updateAABB();return this._box0.intersectAABBs(this._box1,e)};i.prototype.toString=function(){return"BoundBox [min:("+this.min.x+", "+this.min.y+", "+this.min.z+") max:("+this.max.x+", "+this.max.y+", "+this.max.z+")]"};i.prototype.calculateBox=function(){var e=this.max.subtract(this.min,t.MathUtil.CALCULATION_VECTOR3D_0);this.vexData=this.vexData||new Float32Array(24);this.indexData=this.indexData||new Uint16Array(36);this.vexData[0]=this.min.x;this.vexData[1]=this.min.y;this.vexData[2]=this.min.z;this.vexData[3]=this.min.x;this.vexData[4]=this.min.y;this.vexData[5]=this.min.z+e.z;this.vexData[6]=this.min.x+e.x;this.vexData[7]=this.min.y;this.vexData[8]=this.min.z+e.z;this.vexData[9]=this.min.x+e.x;this.vexData[10]=this.min.y;this.vexData[11]=this.min.z;this.vexData[12]=this.max.x-e.x;this.vexData[13]=this.max.y;this.vexData[14]=this.max.z-e.z;this.vexData[15]=this.max.x-e.x;this.vexData[16]=this.max.y;this.vexData[17]=this.max.z;this.vexData[18]=this.max.x;this.vexData[19]=this.max.y;this.vexData[20]=this.max.z;this.vexData[21]=this.max.x;this.vexData[22]=this.max.y;this.vexData[23]=this.max.z-e.z;this.indexData[0]=0;this.indexData[1]=4;this.indexData[2]=7;this.indexData[3]=0;this.indexData[4]=7;this.indexData[5]=3;this.indexData[6]=2;this.indexData[7]=6;this.indexData[8]=5;this.indexData[9]=2;this.indexData[10]=5;this.indexData[11]=1;this.indexData[12]=4;this.indexData[13]=5;this.indexData[14]=6;this.indexData[15]=4;this.indexData[16]=6;this.indexData[17]=7;this.indexData[18]=0;this.indexData[19]=3;this.indexData[20]=2;this.indexData[21]=0;this.indexData[22]=2;this.indexData[23]=1;this.indexData[24]=0;this.indexData[25]=1;this.indexData[26]=5;this.indexData[27]=0;this.indexData[28]=5;this.indexData[29]=4;this.indexData[30]=3;this.indexData[31]=7;this.indexData[32]=6;this.indexData[33]=3;this.indexData[34]=6;this.indexData[35]=2;this.width=this.max.x-this.min.x;this.heigth=this.max.y-this.min.y;this.depth=this.max.z-this.min.z;this.volume=this.width*this.heigth*this.depth;var i=this.max.subtract(this.min,t.MathUtil.CALCULATION_VECTOR3D_1);i.scaleBy(.5);this.radius=i.length;this.center.copyFrom(this.min);var r=this.center.add(i,t.MathUtil.CALCULATION_VECTOR3D_2);this.center.copyFrom(r);for(var a=0;a<8;++a){this._bound.geometry.setVerticesForIndex(a,t.VertexFormat.VF_POSITION,[this.vexData[a*3+0],this.vexData[a*3+1],this.vexData[a*3+2]],1)}};i.prototype.inBound=function(e){this.transform.transformVector(this.center,t.MathUtil.CALCULATION_VECTOR3D);return e.inSphere(t.MathUtil.CALCULATION_VECTOR3D,this.radius)};i.prototype.updateAABB=function(){this.min.copyFrom(new t.Vector3D(t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE));this.max.copyFrom(new t.Vector3D(-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE));for(var e=0;e<this.vexData.length;e+=this.vexLength){if(this.max.x<this.vexData[e]){this.max.x=this.vexData[e]}if(this.max.y<this.vexData[e+1]){this.max.y=this.vexData[e+1]}if(this.max.z<this.vexData[e+2]){this.max.z=this.vexData[e+2]}if(this.min.x>this.vexData[e]){this.min.x=this.vexData[e]}if(this.min.y>this.vexData[e+1]){this.min.y=this.vexData[e+1]}if(this.min.z>this.vexData[e+2]){this.min.z=this.vexData[e+2]}}};i.prototype.createChild=function(){this.childBound=new i(this.owner);var e=new t.Vector3D;var r=new t.Vector3D;e.x=this.center.x+this.width/4;e.y=this.center.y+this.heigth/4;e.z=this.center.z+this.depth/4;r.x=this.center.x-this.width/4;r.y=this.center.y-this.heigth/4;r.z=this.center.z-this.depth/4;this.childBound.fillBox(r,e)};i.prototype.clone=function(){var t=new i(this.owner,this.min,this.max);return t};return i}(t.Bound);t.BoundBox=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.prototype.calcLineX=function(e,i){var r;var a;for(var n=0,o=e.length-1;n<o;n++){r=e[n];a=e[n+1];if(r.x<=i&&a.x>=i){break}}return t.MathUtil.mix(r.y,a.y,(i-r.x)/(i-a.x))};e.prototype.calcBezierY=function(t,e,i){var r;var a;var n;var o;for(var s=0;s<3;s++){if(i>=t[s].x&&i<=t[s+1].x){r=t[s];a=e[s];n=t[s+1];o=e[s+1];break}}if(!r){r=t[t.length-1]}if(!a){a=e[e.length-1]}n=n||r;o=o||a;i=(i-r.x)/(n.x-r.x);return this.cubic_bezier(r.y,a.y,o.y,n.y,i)};e.prototype.calcBezierX=function(t,e,i){var r;var a;var n;var o;for(var s=0;s<3;s++){if(i>=t[s].x&&i<=t[s+1].x){r=t[s];a=e[s];n=t[s+1];o=e[s+1];break}}i=(i-r.x)/(n.x-r.x);return this.cubic_bezier(r.x,a.x,o.x,n.x,i)};e.prototype.cubic_bezier=function(e,i,r,a,n){e=t.MathUtil.mix(e,i,n);i=t.MathUtil.mix(i,r,n);r=t.MathUtil.mix(r,a,n);e=t.MathUtil.mix(e,i,n);i=t.MathUtil.mix(i,r,n);e=t.MathUtil.mix(e,i,n);return e};return e}();t.BezierCurve=e;var i=function(){function i(){this.posPoints=[];this.ctrlPoints=[];this.lineMode=false;this.linePoints=[]}i.prototype.calc=function(t){var e;if(!this.lineMode){e=i.calc.calcBezierY(this.posPoints,this.ctrlPoints,t)}else{e=i.calc.calcLineX(this.linePoints,t)}return e};i.prototype.trySampler=function(){var t;if(this.lineMode){for(var e=0,i=this.linePoints.length;e<i;e++){if(this.linePoints[e].y!=0){t=true;break}}}else{for(var e=0,i=this.posPoints.length;e<i;e++){if(this.posPoints[e].y!=0||this.ctrlPoints[e].y!=0){t=true;break}}}if(t){return this.sampler()}return null};i.prototype.sampler=function(){if(this.lineMode){return this.samplerLine()}return this.samplerBezier()};i.prototype.samplerLine=function(){var t=8;var e=new Float32Array(1+(t*2+1)*2);e[e.length-1]=this.linePoints.length;for(var i=0,r=this.linePoints.length;i<r;i++){e[i*2]=this.linePoints[i].x;e[i*2+1]=this.linePoints[i].y}return e};i.prototype.samplerBezier=function(){var t=8;var e=new Float32Array(1+(t*2+1)*2);var r;var a=0;var n,o,s;var h=0;e[h]=a;h++;e[h]=this.posPoints[0].y;h++;for(n=0,s=i.SegCount;n<s;n++){r=this.posPoints[n*2+1].x-this.posPoints[n*2].x;r/=t;for(o=0;o<t;o++){a+=r;if(a>1){a=1}e[h]=a;h++;e[h]=this.calc(a);h++}}e[h]=t*2+1;h++;return e};i.prototype.validate=function(){var e=0,r=0;if(!this.lineMode){if(this.posPoints==null){this.posPoints=[]}if(this.ctrlPoints==null){this.ctrlPoints=[]}for(e=this.posPoints.length/2,r=i.SegCount;e<r;e++){this.posPoints.push(new t.Point(0,0));this.posPoints.push(new t.Point(1,0))}for(e=this.ctrlPoints.length/2,r=i.SegCount;e<r;e++){this.ctrlPoints.push(new t.Point(0,0));this.ctrlPoints.push(new t.Point(1,0))}this.ctrlPoints.length=i.SegCount*2;this.posPoints.length=i.SegCount*2}else{if(this.linePoints==null){this.linePoints=[]}for(e=this.linePoints.length,r=17;e<r;e++){this.linePoints.push(new t.Point(1,0))}}};i.SegCount=2;i.calc=new e;return i}();t.BezierData=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.m44=new t.Matrix4_4;this.alpha=1}e.prototype.scale=function(t,e,i,r){if(t===void 0){t=1}if(e===void 0){e=1}if(i===void 0){i=1}if(r===void 0){r=1}this.m44.appendScale(t,e,i);this.alpha*=r};e.prototype.offset=function(t,e,i,r){if(t===void 0){t=0}if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=0}this.m44.appendTranslation(t,e,i);this.alpha+=r};e.prototype.gray=function(){var t=new Float32Array(16);t[0]=.2126;t[1]=.7152;t[2]=.0722;t[3]=1;t[4]=.2126;t[5]=.7152;t[6]=.0722;t[7]=1;t[8]=.2126;t[9]=.7152;t[10]=.0722;t[11]=1;t[12]=0;t[13]=0;t[14]=0;t[15]=1;this.m44.copyRawDataFrom(t)};e.prototype.reset=function(){this.m44.identity();this.alpha=1};e.prototype.multiply=function(t){this.m44.multiply(t.m44);this.alpha*=t.alpha};e.prototype.copyFrom=function(t){this.m44.copyFrom(t.m44);this.alpha=t.alpha};e.prototype.copyTo=function(t){t.copyFrom(this)};e.prototype.setColorRGB=function(t){var e=t&16711680;e>>=16;var i=t&65280;i>>=8;var r=t&255;e/=255;i/=255;r/=255;this.m44.identity();this.scale(e,i,r,1)};return e}();t.ColorTransform=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.localPosition=new t.Vector3D;this.globalPosition=new t.Vector3D;this.uv=new t.Vector3D}return e}();t.PickResult=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e){if(t===void 0){t=null}if(e===void 0){e=null}this.time=0;this.delay=0;this._stopImmediatePropagation=false;this.eventType=t;this.data=e}t.prototype.stopImmediatePropagation=function(){this._stopImmediatePropagation=true};t.prototype.reset=function(){this._stopImmediatePropagation=false};Object.defineProperty(t.prototype,"isStopImmediatePropagation",{get:function(){return this._stopImmediatePropagation},enumerable:true,configurable:true});t.ENTER_FRAME="enter_frame";t.RESIZE="resize";t.CHANGE="change";return t}();t.Event3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.apply(this,arguments)}e.CYCLE="cycle";e.COMPLETE="complete";return e}(t.Event3D);t.AnimationEvent3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["Mouse_Left"]=0]="Mouse_Left";t[t["Mouse_Mid"]=1]="Mouse_Mid";t[t["Mouse_Right"]=2]="Mouse_Right"})(t.MouseCode||(t.MouseCode={}));var e=t.MouseCode;var i=function(t){__extends(e,t);function e(){t.apply(this,arguments);this.mouseCode=0}e.MOUSE_CLICK="onMouseClick";e.MOUSE_DOWN="onMouseDown";e.MOUSE_UP="onMouseUp";e.MOUSE_MOVE="onMouseMove";e.MOUSE_OVER="onMouseOver";e.MOUSE_OUT="onMouseOut";e.MOUSE_WHEEL="onMouseWheel";return e}(t.Event3D);t.MouseEvent3D=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.apply(this,arguments)}e.TOUCH_MOVE="onTouchMove";e.TOUCH_START="onTouchStart";e.TOUCH_END="onTouchEnd";return e}(t.Event3D);t.TouchEvent3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.apply(this,arguments)}e.PICK_CLICK="onPickClick";e.PICK_DOWN="onPickDown";e.PICK_UP="onPickUp";e.PICK_MOVE="onPickMove";e.PICK_WHEEL="onPickWheel";return e}(t.Event3D);t.PickEvent3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["Key_BackSpace"]=8]="Key_BackSpace";t[t["Key_Tab"]=9]="Key_Tab";t[t["Key_Clear"]=12]="Key_Clear";t[t["Key_Enter"]=13]="Key_Enter";t[t["Key_Shift_L"]=16]="Key_Shift_L";t[t["Key_Control_L"]=17]="Key_Control_L";t[t["Key_Alt_L"]=18]="Key_Alt_L";t[t["Key_Pause"]=19]="Key_Pause";t[t["Key_CapsLock"]=20]="Key_CapsLock";t[t["Key_Escape"]=21]="Key_Escape";t[t["Key_Space"]=32]="Key_Space";t[t["Key_Prior"]=33]="Key_Prior";t[t["Key_Next"]=34]="Key_Next";t[t["Key_End"]=35]="Key_End";t[t["Key_Home"]=36]="Key_Home";t[t["Key_Left"]=37]="Key_Left";t[t["Key_Up"]=38]="Key_Up";t[t["Key_Right"]=39]="Key_Right";t[t["Key_Down"]=40]="Key_Down";t[t["Key_Select"]=41]="Key_Select";t[t["Key_Print"]=42]="Key_Print";t[t["Key_Execute"]=43]="Key_Execute";t[t["Key_Insert"]=45]="Key_Insert";t[t["Key_Delete"]=46]="Key_Delete";t[t["Key_Help"]=47]="Key_Help";t[t["Key_0"]=48]="Key_0";t[t["Key_1"]=49]="Key_1";t[t["Key_2"]=50]="Key_2";t[t["Key_3"]=51]="Key_3";t[t["Key_4"]=52]="Key_4";t[t["Key_5"]=53]="Key_5";t[t["Key_6"]=54]="Key_6";t[t["Key_7"]=55]="Key_7";t[t["Key_8"]=56]="Key_8";t[t["Key_9"]=57]="Key_9";t[t["Key_A"]=65]="Key_A";t[t["Key_B"]=66]="Key_B";t[t["Key_C"]=67]="Key_C";t[t["Key_D"]=68]="Key_D";t[t["Key_E"]=69]="Key_E";t[t["Key_F"]=70]="Key_F";t[t["Key_G"]=71]="Key_G";t[t["Key_H"]=72]="Key_H";t[t["Key_I"]=73]="Key_I";t[t["Key_J"]=74]="Key_J";t[t["Key_K"]=75]="Key_K";
t[t["Key_L"]=76]="Key_L";t[t["Key_M"]=77]="Key_M";t[t["Key_N"]=78]="Key_N";t[t["Key_O"]=79]="Key_O";t[t["Key_P"]=80]="Key_P";t[t["Key_Q"]=81]="Key_Q";t[t["Key_R"]=82]="Key_R";t[t["Key_S"]=83]="Key_S";t[t["Key_T"]=84]="Key_T";t[t["Key_U"]=85]="Key_U";t[t["Key_V"]=86]="Key_V";t[t["Key_W"]=87]="Key_W";t[t["Key_X"]=88]="Key_X";t[t["Key_Y"]=89]="Key_Y";t[t["Key_Z"]=90]="Key_Z";t[t["Key_KP_0"]=96]="Key_KP_0";t[t["Key_KP_1"]=97]="Key_KP_1";t[t["Key_KP_2"]=98]="Key_KP_2";t[t["Key_KP_3"]=99]="Key_KP_3";t[t["Key_KP_4"]=100]="Key_KP_4";t[t["Key_KP_5"]=101]="Key_KP_5";t[t["Key_KP_6"]=102]="Key_KP_6";t[t["Key_KP_7"]=103]="Key_KP_7";t[t["Key_KP_8"]=104]="Key_KP_8";t[t["Key_KP_9"]=105]="Key_KP_9";t[t["Key_Multiply"]=106]="Key_Multiply";t[t["Key_Add"]=107]="Key_Add";t[t["Key_Separator"]=108]="Key_Separator";t[t["Key_Subtract"]=109]="Key_Subtract";t[t["Key_Decimal"]=110]="Key_Decimal";t[t["Key_Divide"]=111]="Key_Divide";t[t["Key_F1"]=112]="Key_F1";t[t["Key_F2"]=113]="Key_F2";t[t["Key_F3"]=114]="Key_F3";t[t["Key_F4"]=115]="Key_F4";t[t["Key_F5"]=116]="Key_F5";t[t["Key_F6"]=117]="Key_F6";t[t["Key_F7"]=118]="Key_F7";t[t["Key_F8"]=119]="Key_F8";t[t["Key_F9"]=120]="Key_F9";t[t["Key_F10"]=121]="Key_F10";t[t["Key_F11"]=122]="Key_F11";t[t["Key_F12"]=123]="Key_F12";t[t["Key_F13"]=124]="Key_F13";t[t["Key_F14"]=125]="Key_F14";t[t["Key_F15"]=126]="Key_F15";t[t["Key_F16"]=127]="Key_F16";t[t["Key_F17"]=128]="Key_F17";t[t["Key_F18"]=129]="Key_F18";t[t["Key_F19"]=130]="Key_F19";t[t["Key_F20"]=131]="Key_F20";t[t["Key_F21"]=132]="Key_F21";t[t["Key_F22"]=133]="Key_F22";t[t["Key_F23"]=134]="Key_F23";t[t["Key_F24"]=135]="Key_F24";t[t["Key_Num_Lock"]=136]="Key_Num_Lock";t[t["Key_Scroll_Lock"]=137]="Key_Scroll_Lock"})(t.KeyCode||(t.KeyCode={}));var e=t.KeyCode;var i=function(t){__extends(e,t);function e(){t.apply(this,arguments);this.keyCode=0}e.KEY_DOWN="onKeyDown";e.KEY_UP="onKeyUp";return e}(t.Event3D);t.KeyEvent3D=i})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["Portrait_Primary"]=0]="Portrait_Primary";t[t["Portrait_Secondary"]=180]="Portrait_Secondary";t[t["Landscape_Primary"]=-90]="Landscape_Primary";t[t["Landscape_Secondary"]=90]="Landscape_Secondary"})(t.Orientation||(t.Orientation={}));var e=t.Orientation;var i=function(t){__extends(e,t);function e(){t.apply(this,arguments)}Object.defineProperty(e.prototype,"orientation",{get:function(){var t=window.orientation;return t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"acceleration",{get:function(){return this._acceleration},set:function(t){this._acceleration=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"accelerationIncludingGravity",{get:function(){return this._accelerationIncludingGravity},set:function(t){this._accelerationIncludingGravity=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"rotationRate",{get:function(){return this._rotationRate},set:function(t){this._rotationRate=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"absolute",{get:function(){return this._absolute},set:function(t){this._absolute=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"beta",{get:function(){return this._beta},set:function(t){this._beta=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"gamma",{get:function(){return this._gamma},set:function(t){this._gamma=t},enumerable:true,configurable:true});e.ORIENTATION_CHANGE="onOrientationChange";e.DEVICE_MOTION="onDeviceMotion";e.DEVICE_ORIENTATION="onDeviceOrientation";return e}(t.Event3D);t.OrientationEvent3D=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.apply(this,arguments)}e.LOADER_COMPLETE="onLoadComplete";e.COMPLETE="onLoadComplete";e.LOADER_ONCE_COMPLETE="onLoadOnceComplete";e.ONCE_COMPLETE="onLoadOnceComplete";e.LOADER_PROGRESS="onLoadProgress";e.PROGRESS="onLoadProgress";e.LOADER_ERROR="onLoadError";e.ERROR="onLoadError";return e}(t.Event3D);t.LoaderEvent3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.apply(this,arguments)}e.PARSER_COMPLETE="onParserComplete";return e}(t.Event3D);t.ParserEvent3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e,i,r,a){if(t===void 0){t=null}if(e===void 0){e=null}if(i===void 0){i=null}if(r===void 0){r=null}if(a===void 0){a=0}this.type=t;this.thisObject=e;this.handler=i;this.param=r;this.priority=a}t.prototype.equalCurrentListener=function(t,e,i,r){if(this.type==t&&this.thisObject==i&&this.handler==e&&this.param==r){return true}return false};t.event_id_count=0;return t}();t.EventListener=e;var i=function(){function t(){this.listeners={}}t.prototype.dispatchEvent=function(t){var e=this.listeners[t.eventType];if(e!=null){e=e.slice();for(var i=0;i<e.length;i++){if(t.isStopImmediatePropagation){break}var r=e[i];try{t.param=r.param;t.target=this;t.currentTarget=r;r.handler.call(r.thisObject,t)}catch(t){if(window.console){console.error(t.stack)}}}}};t.prototype.dispose=function(){for(var t in this.listeners){var e=this.listeners[t];while(e.length>0){var i=e[0];i.handler=null;i.thisObject=null;e.splice(0,1)}}};t.prototype.addEventListener=function(t,i,r,a,n){if(a===void 0){a=null}if(n===void 0){n=0}if(this.listeners[t]==null){this.listeners[t]=[]}var o=new e(t,r,i,a,n);o.id=++e.event_id_count;this.listeners[t].push(o);this.listeners[t].sort(function(t,e){return e.priority-t.priority});return o.id};t.prototype.removeEventListener=function(t,e,i){if(this.hasEventListener(t,e,i)){for(var r=0;r<this.listeners[t].length;r++){var a=this.listeners[t][r];if(a.equalCurrentListener(t,e,i,a.param)){a.handler=null;a.thisObject=null;this.listeners[t].splice(r,1);return}}}};t.prototype.removeEventListenerAt=function(t){for(var e in this.listeners){for(var i=0;i<this.listeners[e].length;i++){var r=this.listeners[e][i];if(r.id==t){r.handler=null;r.thisObject=null;this.listeners[e].splice(i,1);return}}}};t.prototype.clearEventListener=function(){this.listeners={}};t.prototype.containEventListener=function(t){if(this.listeners[t]==null)return false;return this.listeners[t].length>0};t.prototype.hasEventListener=function(t,e,i){if(e===void 0){e=null}if(i===void 0){i=null}if(this.listeners[t]==null)return false;if(i&&e){for(var r=0;r<this.listeners[t].length;r++){var a=this.listeners[t][r];if(a.equalCurrentListener(t,e,i,a.param)){return true}}}return false};return t}();t.EventDispatcher=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){this._retRenderList=new Array;this._ray=new t.Ray;this._canvas=e;this._pickEvent3d=new t.PickEvent3D;t.Input.addEventListener(t.MouseEvent3D.MOUSE_CLICK,this.onMouseClick,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.onMouseDown,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,this.onMouseWheel,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.onTouchDown,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.onTouchUp,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.onTouchMove,this)}Object.defineProperty(e.prototype,"_view3ds",{get:function(){return this._canvas.view3Ds},enumerable:true,configurable:true});e.prototype.onClear=function(){this._canvas=null};e.prototype.onClearListeners=function(){};e.prototype.sendEvent=function(e,i,r){var a=this._canvas;if(!a){return}for(var n=0;n<this._view3ds.length;n++){var o=this._view3ds[n];var s=o.entityCollect.specialCastItem[t.SpecialCast.Pick];if(!o.entityCollect||!s){continue}var h=null;var u=null;this._retRenderList.length=0;var l=this._retRenderList;for(var c=0;c<s.length;++c){h=s[c];if(!h.containEventListener(e.eventType)&&!h.containEventListener(i)){continue}if(!u){u=t.Picker.createRayToView(o,this._ray)}if(t.Picker.doPickerObject(this._ray,h)){l.push(h)}}var f=l.length;if(f<=0){continue}var d=null;var p=t.MathUtil.MAX_VALUE;var _=0;for(var c=0;c<f;c++){h=l[c];_=t.Vector3D.distance(h.globalPosition,o.camera3D.globalPosition);if(_<p){p=_;d=h}}if(d){d.dispatchEvent(e);d.dispatchEvent(r.call(this,i,e,d))}}};e.prototype.initPickEvent3D=function(t,e,i){this._pickEvent3d.eventType=t;this._pickEvent3d.data=e;this._pickEvent3d.pickResult=i.pickResult;return this._pickEvent3d};e.prototype.clearEvent=function(){this._pickEvent3d.target=null;this._pickEvent3d.data=null;this._pickEvent3d.pickResult=null;this._pickEvent3d.targetEvent=null};e.prototype.onTouchMove=function(e){this._pickEvent3d.targetEvent=e;this.sendEvent(e,t.PickEvent3D.PICK_MOVE,this.initPickEvent3D);this.clearEvent()};e.prototype.onTouchUp=function(e){this._pickEvent3d.targetEvent=e;this.sendEvent(e,t.PickEvent3D.PICK_UP,this.initPickEvent3D);this.clearEvent()};e.prototype.onTouchDown=function(e){this._pickEvent3d.targetEvent=e;this.sendEvent(e,t.PickEvent3D.PICK_DOWN,this.initPickEvent3D);this.clearEvent()};e.prototype.onMouseClick=function(e){this._pickEvent3d.targetEvent=e;this.sendEvent(e,t.PickEvent3D.PICK_CLICK,this.initPickEvent3D);this.clearEvent()};e.prototype.onMouseDown=function(e){this._pickEvent3d.targetEvent=e;this.sendEvent(e,t.PickEvent3D.PICK_DOWN,this.initPickEvent3D);this.clearEvent()};e.prototype.onMouseUp=function(e){this._pickEvent3d.targetEvent=e;this.sendEvent(e,t.PickEvent3D.PICK_UP,this.initPickEvent3D);this.clearEvent()};e.prototype.onMouseMove=function(e){this._pickEvent3d.targetEvent=e;this.sendEvent(e,t.PickEvent3D.PICK_MOVE,this.initPickEvent3D);this.clearEvent()};e.prototype.onMouseWheel=function(e){this._pickEvent3d.targetEvent=e;this.sendEvent(e,t.PickEvent3D.PICK_WHEEL,this.initPickEvent3D);this.clearEvent()};return e}();t.EventManager=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){this.index=0;this.shadersName=new Array;this.endShadername="";this.stateChange=false;this.maxBone=0;this.shaderType=-1;this.shaderType=t}e.prototype.addUseShaderName=function(t){this.shadersName.push(t)};e.prototype.addEndShaderName=function(t){this.endShadername=t};e.prototype.getShader=function(e){if(this.endShadername!=""){var i=this.shadersName.indexOf(this.endShadername);if(i==-1){this.shadersName.push(this.endShadername)}}return t.ShaderUtil.instance.fillShaderContent(this,this.shadersName,e)};return e}();t.ShaderBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){this.varName="";this.name="";this.key="";this.valueType="";this.value="";this.activeTextureIndex=-1;this.index=-1;this.level="";this.size=0;this.dataType=0;this.normalized=false;this.stride=0;this.offset=0;this.offsetIndex=0;this.offsetBytes=0}t.prototype.var=function(t){return this.level+" "+this.valueType+" "+name+"."+t};t.prototype.use=function(t){if(t===void 0){t=""}if(t!="")return this.name+"."+t;return this.name};t.prototype.clone=function(){var e=new t;e.name=this.name;e.valueType=this.valueType;e.level=this.level;e.varName=this.varName;e.value=this.value;e.key=this.key;return e};t.prototype.computeVarName=function(){var t=this.name.indexOf("[");if(t>=0){this.varName=this.name.substr(0,t)}else{this.varName=this.name}};return t}();t.VarRegister=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="attribute";this.valueType=i}return e}(t.VarRegister);t.Attribute=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.int="int";t.float="float";t.vec2="vec2";t.vec3="vec3";t.vec4="vec4";t.mat2="mat2";t.mat3="mat3";t.mat4="mat4";return t}();t.AttributeType=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i,r){t.call(this);this.name=e;this.computeVarName();this.key="const";this.valueType=i;this.value=r}return e}(t.VarRegister);t.ConstVar=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);this.name=e;this.computeVarName();this.key="sampler2D"}return e}(t.VarRegister);t.Sampler2D=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);this.name=e;this.computeVarName();this.key="samplerCube"}return e}(t.VarRegister);t.Sampler3D=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="";this.valueType=i}return e}(t.VarRegister);t.TmpVar=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="uniform";this.valueType=i}return e}(t.VarRegister);t.Uniform=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.bool="bool";t.int="int";t.float="float";t.vec2="vec2";t.vec3="vec3";t.vec4="vec4";t.bvec2="bvec2";t.bvec3="bvec3";t.bvec4="bvec4";t.ivec2="ivec2";t.ivec3="ivec3";t.ivec4="ivec4";t.mat2="mat2";t.mat3="mat3";t.mat4="mat4";t.sampler2D="sampler2D";t.sampleCube="sampleCube";return t}();t.UniformType=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.attribute_position="attribute_position";t.attribute_normal="attribute_normal";t.attribute_tangent="attribute_tangent";t.attribute_vertexColor="attribute_vertexColor";t.attribute_uv0="attribute_uv0";t.attribute_uv1="attribute_uv1";t.varying_pos="varying_pos";t.varying_normal="varying_normal";t.varying_tangent="varying_tangent";t.varying_color="varying_color";t.varying_uv0="varying_uv0";t.varying_uv1="varying_uv1";t.varying_globalPos="varying_globalPos";t.varying_lightDir="varying_lightDir";t.varying_eye="varying_eye";t.uniform_floatv_0="uniform_floatv_0";t.uniform_floatv_1="uniform_floatv_1";t.uniform_floatv_2="uniform_floatv_2";t.uniform_iv_0="uniform_iv_0";t.uniform_iv_1="uniform_iv_1";t.uniform_iv_2="uniform_iv_2";t.uniform_bv_0="uniform_bv_0";t.uniform_bv_1="uniform_bv_1";t.uniform_bv_2="uniform_bv_2";t.uniform_vec2fv_0="uniform_vec2fv_0";t.uniform_vec2fv_1="uniform_vec2fv_1";t.uniform_vec2fv_2="uniform_vec2fv_2";t.uniform_vec3fv_0="uniform_vec3fv_0";t.uniform_vec3fv_1="uniform_vec3fv_1";t.uniform_vec3fv_2="uniform_vec3fv_2";t.uniform_vec4fv_0="uniform_vec4fv_0";t.uniform_vec4fv_1="uniform_vec4fv_1";t.uniform_vec4fv_2="uniform_vec4fv_2";t.uniform_vec2iv_0="uniform_vec2iv_0";t.uniform_vec2iv_1="uniform_vec2iv_1";t.uniform_vec2iv_2="uniform_vec2iv_2";t.uniform_vec3iv_0="uniform_vec3iv_0";t.uniform_vec3iv_1="uniform_vec3iv_1";t.uniform_vec3iv_2="uniform_vec3iv_2";t.uniform_vec4iv_0="uniform_vec4iv_0";t.uniform_vec4iv_1="uniform_vec4iv_1";t.uniform_vec4iv_2="uniform_vec4iv_2";t.uniform_vec2bv_0="uniform_vec2bv_0";t.uniform_vec2bv_1="uniform_vec2bv_1";t.uniform_vec2bv_2="uniform_vec2bv_2";t.uniform_vec3bv_0="uniform_vec3bv_0";t.uniform_vec3bv_1="uniform_vec3bv_1";t.uniform_vec3bv_2="uniform_vec3bv_2";t.uniform_vec4bv_0="uniform_vec4bv_0";t.uniform_vec4bv_1="uniform_vec4bv_1";t.uniform_vec4bv_2="uniform_vec4bv_2";t.uniform_modelMatrix="uniform_modelMatrix";t.uniform_projectionMatrix="uniform_projectionMatrix";t.uniform_normalMatrix="uniform_normalMatrix";t.uniform_eye="uniform_eye";t.uniform_lightDir="uniform_lightDir";t.texture2D_0="texture2D_0";t.texture2D_1="texture2D_1";t.texture2D_2="texture2D_2";t.texture2D_3="texture2D_3";t.texture2D_4="texture2D_4";return t}();t.VarConstName=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="varying";this.valueType=i}return e}(t.VarRegister);t.Varying=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e){t.call(this);this.name=e;this.computeVarName();this.key="#extension"}return e}(t.VarRegister);t.Extension=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this);this.name=e;this.computeVarName();this.key="#define";this.value=i}return e}(t.VarRegister);t.DefineVar=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.bool="bool";t.int="int";t.float="float";t.vec2="vec2";t.vec3="vec3";t.vec4="vec4";t.bvec2="bvec2";t.bvec3="bvec3";t.bvec4="bvec4";t.ivec2="ivec2";t.ivec3="ivec3";t.ivec4="ivec4";t.mat2="mat2";t.mat3="mat3";t.mat4="mat4";t.sampler2D="sampler2D";t.sampleCube="sampleCube";return t}();t.VaryingType=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.lib={alphaMask_fs:"uniform sampler2D maskTexture ; \n"+"void main(void){ \n"+"float maskAlpha = texture2D( maskTexture , uv_0 ).x; \n"+"if(maskAlpha * diffuseColor.w < 0.001){ \n"+"discard; \n"+"} \n"+"materialSource.alpha *= maskAlpha; \n"+"} \n",AmbientOcclusion:"varying vec2 varying_uv0; \n"+"uniform sampler2D positionPass; \n"+"uniform sampler2D normalPass; \n"+"void main(){ \n"+"gl_FragColor = texture2D(positionPass,varying_uv0) + texture2D(normalPass,varying_uv0) ; \n"+"} \n",AOMap_fs:"uniform sampler2D aoTexture ; \n"+"uniform float aoPower ; \n"+"void main(void){ \n"+"float ao = texture2D( aoTexture , varying_uv1 ).x ; \n"+"diffuseColor.xyz *= (ao * aoPower) ; \n"+"} \n",baseShadowPass_fs:"varying vec2 varying_uv0; \n"+"varying vec4 varying_color; \n"+"vec4 outColor ; \n"+"vec2 uv_0; \n"+"void main() { \n"+"uv_0 = varying_uv0; \n"+"} \n",baseShadowPass_vs:"attribute vec3 attribute_position; \n"+"attribute vec2 attribute_uv0; \n"+"attribute vec4 attribute_color; \n"+"uniform mat4 uniform_ProjectionMatrix ; \n"+"varying vec2 varying_uv0; \n"+"varying vec4 varying_color; \n"+"vec3 e_position = vec3(0.0, 0.0, 0.0); \n"+"vec4 outPosition ; \n"+"void main(void){ \n"+"e_position = attribute_position; \n"+"varying_color = attribute_color; \n"+"varying_uv0 = attribute_uv0; \n"+"} \n",base_fs:"#extension GL_OES_standard_derivatives : enable \n"+"varying vec3 varying_eyeNormal  ; \n"+"varying vec2 varying_uv0; \n"+"varying vec4 varying_color; \n"+"uniform mat4 uniform_ViewMatrix ; \n"+"vec4 outColor ; \n"+"vec4 diffuseColor ; \n"+"vec4 specularColor ; \n"+"vec4 ambientColor; \n"+"vec4 light ; \n"+"vec3 normal; \n"+"vec2 uv_0; \n"+"vec3 flatNormals(vec3 pos) { \n"+"vec3 fdx = dFdx(pos); \n"+"vec3 fdy = dFdy(pos); \n"+"return normalize(cross(fdx, fdy)); \n"+"} \n"+"void main() { \n"+"diffuseColor  = vec4(1.0,1.0,1.0,1.0); \n"+"specularColor = vec4(0.0,0.0,0.0,0.0); \n"+"ambientColor  = vec4(0.0,0.0,0.0,0.0); \n"+"light         = vec4(1.0,1.0,1.0,1.0); \n"+"normal = normalize(varying_eyeNormal) ; \n"+"uv_0 = varying_uv0; \n"+"} \n",base_vs:"attribute vec3 attribute_position; \n"+"attribute vec3 attribute_normal; \n"+"attribute vec4 attribute_color; \n"+"attribute vec2 attribute_uv0; \n"+"vec3 e_position = vec3(0.0, 0.0, 0.0); \n"+"vec3 e_normal = vec3(0.0, 0.0, 0.0); \n"+"uniform mat4 uniform_ModelMatrix ; \n"+"uniform mat4 uniform_ViewMatrix ; \n"+"uniform mat4 uniform_ProjectionMatrix ; \n"+"varying vec3 varying_eyeNormal  ; \n"+"varying vec2 varying_uv0; \n"+"varying vec4 varying_color; \n"+"vec4 outPosition ; \n"+"mat4 rotVertexMatrix; \n"+"mat4 transpose(mat4 inMatrix) { \n"+"vec4 i0 = inMatrix[0]; \n"+"vec4 i1 = inMatrix[1]; \n"+"vec4 i2 = inMatrix[2]; \n"+"vec4 i3 = inMatrix[3]; \n"+"mat4 outMatrix = mat4( \n"+"vec4(i0.x, i1.x, i2.x, i3.x), \n"+"vec4(i0.y, i1.y, i2.y, i3.y), \n"+"vec4(i0.z, i1.z, i2.z, i3.z), \n"+"vec4(i0.w, i1.w, i2.w, i3.w) \n"+"); \n"+"return outMatrix; \n"+"} \n"+"mat4 inverse(mat4 m) { \n"+"float \n"+"a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3], \n"+"a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3], \n"+"a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3], \n"+"a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3], \n"+"b00 = a00 * a11 - a01 * a10, \n"+"b01 = a00 * a12 - a02 * a10, \n"+"b02 = a00 * a13 - a03 * a10, \n"+"b03 = a01 * a12 - a02 * a11, \n"+"b04 = a01 * a13 - a03 * a11, \n"+"b05 = a02 * a13 - a03 * a12, \n"+"b06 = a20 * a31 - a21 * a30, \n"+"b07 = a20 * a32 - a22 * a30, \n"+"b08 = a20 * a33 - a23 * a30, \n"+"b09 = a21 * a32 - a22 * a31, \n"+"b10 = a21 * a33 - a23 * a31, \n"+"b11 = a22 * a33 - a23 * a32, \n"+"det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06; \n"+"return mat4( \n"+"a11 * b11 - a12 * b10 + a13 * b09, \n"+"a02 * b10 - a01 * b11 - a03 * b09, \n"+"a31 * b05 - a32 * b04 + a33 * b03, \n"+"a22 * b04 - a21 * b05 - a23 * b03, \n"+"a12 * b08 - a10 * b11 - a13 * b07, \n"+"a00 * b11 - a02 * b08 + a03 * b07, \n"+"a32 * b02 - a30 * b05 - a33 * b01, \n"+"a20 * b05 - a22 * b02 + a23 * b01, \n"+"a10 * b10 - a11 * b08 + a13 * b06, \n"+"a01 * b08 - a00 * b10 - a03 * b06, \n"+"a30 * b04 - a31 * b02 + a33 * b00, \n"+"a21 * b02 - a20 * b04 - a23 * b00, \n"+"a11 * b07 - a10 * b09 - a12 * b06, \n"+"a00 * b09 - a01 * b07 + a02 * b06, \n"+"a31 * b01 - a30 * b03 - a32 * b00, \n"+"a20 * b03 - a21 * b01 + a22 * b00) / det; \n"+"} \n"+"void main(void){ \n"+"e_position = attribute_position; \n"+"e_normal = attribute_normal; \n"+"varying_color = attribute_color; \n"+"varying_uv0 = attribute_uv0; \n"+"} \n",bezier:"vec2 quadratic_bezier(vec2 A, vec2 B, vec2 C, float t) \n"+"{ \n"+"vec2 D = mix(A, B, t); \n"+"vec2 E = mix(B, C, t); \n"+"return mix(D, E, t); \n"+"} \n"+"vec2 cubic_bezier(vec2 A, vec2 B, vec2 C, vec2 D, float t) \n"+"{ \n"+"vec2 E = mix(A, B, t); \n"+"vec2 F = mix(B, C, t); \n"+"vec2 G = mix(C, D, t); \n"+"return quadratic_bezier(E, F, G, t); \n"+"} \n",bloom_fs:"varying vec2 varying_uv0; \n"+"uniform sampler2D diffuseTexture; \n"+"uniform float bloom_amount = 0.15; \n"+"void main(void) { \n"+"vec2 uv = vec2( varying_uv0.x , 1.0-varying_uv0.y ); \n"+"vec4 color = texture2D(diffuseTexture, uv); \n"+"vec4 sum = vec4(0), add = vec4(0), val = texture2D(diffuseTexture, uv); \n"+"for( int i = -4 ; i < 4; i++) { \n"+"for ( int j = -4; j < 4; j++) { \n"+"add += texture2D(diffuseTexture, uv + vec2(j, i)*0.002) * bloom_amount; \n"+"} \n"+"} \n"+"if (val.r < 0.2) { sum = add*add*0.012 + val; } else \n"+"if (val.r < 0.5) { sum = add*add*0.009 + val; } else { \n"+"sum = add*add*0.0075 + val; \n"+"} \n"+"gl_FragColor = vec4(sum.rgb, 1.0); \n"+"} \n",colorCorrectionRamp_fs:"precision highp float; \n"+"varying vec2 varying_uv0; \n"+"uniform float saturation; \n"+"uniform sampler2D diffuseTexture; \n"+"uniform sampler2D lutTexture; \n"+"float Luminance( vec3 c ){ \n"+"return dot( c , vec3(0.22,0.707,0.071) ); \n"+"} \n"+"void main() \n"+"{ \n"+"vec2 uv = varying_uv0 ; \n"+"vec4 color = texture2D(diffuseTexture, uv); \n"+"float red = texture2D(lutTexture, color.rr).r ; \n"+"float green = texture2D(lutTexture,color.gg ).g ; \n"+"float blue = texture2D(lutTexture, color.bb ).b ; \n"+"color = vec4(red,green,blue, color.a); \n"+"gl_FragColor = color ; \n"+"} \n",colorCorrection_fs:"varying vec2 varying_uv0; \n"+"uniform sampler2D diffuseTexture; \n"+"uniform sampler2D lutTexture; \n"+"uniform float saturation ; \n"+"float Luminance( vec3 c ){ \n"+"return dot( c , vec3(0.22,0.707,0.071) ); \n"+"} \n"+"void main() \n"+"{ \n"+"vec2 uv = varying_uv0 ; \n"+"vec4 color = texture2D(diffuseTexture, uv); \n"+"vec3 red = texture2D(lutTexture, vec2(color.r, 0.5/4.0)).rgb * vec3(1.0,0.0,0.0); \n"+"vec3 green = texture2D(lutTexture, vec2(color.g, 1.5/4.0)).rgb * vec3(0.0,1.0,0.0); \n"+"vec3 blue = texture2D(lutTexture, vec2(color.b, 2.5/4.0)).rgb * vec3(0.0,0.0,1.0); \n"+"color = vec4(red+green+blue, color.a); \n"+"float lum = Luminance(color.rgb); \n"+"gl_FragColor = color ; \n"+"} \n",colorGradients_fs:"varying vec4 varying_mvPose; \n"+"uniform float uniform_colorGradientsSource[6] ; \n"+"void main(void){ \n"+"float posStartY = uniform_colorGradientsSource[0]; \n"+"float posEndY = uniform_colorGradientsSource[1]; \n"+"vec4 color = vec4(uniform_colorGradientsSource[2], uniform_colorGradientsSource[3], uniform_colorGradientsSource[4], uniform_colorGradientsSource[5]); \n"+"color.w *= clamp((varying_mvPose.y - posStartY) / (posEndY - posStartY), 0.0, 1.0); \n"+"color.xyz *= color.w; \n"+"outColor.xyz = outColor.xyz * (1.0 - color.w) + color.xyz * color.w; \n"+"} \n"+"  \n",colorPassEnd_fs:"void main() { \n"+"gl_FragColor = vec4(diffuseColor.xyz,1.0); \n"+"} \n",colorTransform_fs:"uniform float uniform_colorTransformAlpha ; \n"+"uniform mat4 uniform_colorTransformM44 ; \n"+"void main(){ \n"+"diffuseColor.xyz = (uniform_colorTransformM44 * vec4(diffuseColor.xyz, 1.0)).xyz; \n"+"diffuseColor.w *= diffuseColor.w * uniform_colorTransformAlpha; \n"+"} \n",color_fragment:"vec4 diffuseColor ; \n"+"void main() { \n"+"if( diffuseColor.w == 0.0 ){ \n"+"discard; \n"+"} \n"+"diffuseColor = vec4(1.0, 1.0, 1.0, 1.0); \n"+"if( diffuseColor.w < materialSource.cutAlpha ){ \n"+"discard; \n"+"}else \n"+"diffuseColor.xyz *= diffuseColor.w ; \n"+"} \n",combin_fs:"uniform sampler2D colorTexture; \n"+"void main(void){ \n"+"} \n",cube_fragment:"uniform samplerCube diffuseTexture3D ; \n"+"varying vec3 varying_pos; \n"+"vec4 diffuseColor ; \n"+"void main() { \n"+"if( diffuseColor.w == 0.0 ){ \n"+"discard; \n"+"} \n"+"vec3 uvw = normalize(varying_pos.xyz); \n"+"diffuseColor = vec4(textureCube(diffuseTexture3D, uvw.xyz)); \n"+"if( diffuseColor.w < materialSource.cutAlpha ){ \n"+"discard; \n"+"}else \n"+"diffuseColor.xyz *= diffuseColor.w ; \n"+"} \n",cube_vertex:"varying vec3 varying_pos; \n"+"void main(void){ \n"+"varying_pos =  e_position; \n"+"}  \n",detail_Bending_vs:"uniform float uniformTime[4] ; \n"+"void main(void){ \n"+"e_position = attribute_position; \n"+"varying_uv0 = attribute_uv0; \n"+"varying_color = attribute_color; \n"+"vec4 curve = SmoothTriangleWave(vec4(sin(uniformTime[0]*0.001),1.0,1.0,1.0)); \n"+"e_position.xyz += curve.x * vec3(1.0,0.5,0.0) * ( attribute_color.xyz) ; \n"+"} \n",diffuse_fragment:"uniform sampler2D diffuseTexture; \n"+"vec4 diffuseColor ; \n"+"void main() { \n"+"diffuseColor = texture2D(diffuseTexture , uv_0 ); \n"+"if( diffuseColor.w < materialSource.cutAlpha ){ \n"+"discard; \n"+"} \n"+"} \n",diffuse_vertex:"attribute vec3 attribute_normal; \n"+"attribute vec4 attribute_color; \n"+"varying vec4 varying_mvPose; \n"+"void main(void){ \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n"+"varying_mvPose = mvMatrix * vec4( e_position , 1.0 )  ; \n"+"mat4 normalMatrix = inverse(mvMatrix) ; \n"+"normalMatrix = transpose(normalMatrix); \n"+"varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n"+"outPosition = varying_mvPose ; \n"+"varying_color = attribute_color; \n"+"} \n",directLight_fragment:"const int max_directLight = 0 ; \n"+"uniform float uniform_directLightSource[9*max_directLight] ; \n"+"varying vec4 varying_mvPose; \n"+"uniform mat4 uniform_ViewMatrix; \n"+"mat4 normalMatrix ; \n"+"struct DirectLight{ \n"+"vec3 direction; \n"+"vec3 diffuse; \n"+"vec3 ambient; \n"+"}; \n"+"mat4 transpose(mat4 inMatrix) { \n"+"vec4 i0 = inMatrix[0]; \n"+"vec4 i1 = inMatrix[1]; \n"+"vec4 i2 = inMatrix[2]; \n"+"vec4 i3 = inMatrix[3]; \n"+"mat4 outMatrix = mat4( \n"+"vec4(i0.x, i1.x, i2.x, i3.x), \n"+"vec4(i0.y, i1.y, i2.y, i3.y), \n"+"vec4(i0.z, i1.z, i2.z, i3.z), \n"+"vec4(i0.w, i1.w, i2.w, i3.w) \n"+"); \n"+"return outMatrix; \n"+"} \n"+"mat4 inverse(mat4 m) { \n"+"float \n"+"a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3], \n"+"a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3], \n"+"a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3], \n"+"a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3], \n"+"b00 = a00 * a11 - a01 * a10, \n"+"b01 = a00 * a12 - a02 * a10, \n"+"b02 = a00 * a13 - a03 * a10, \n"+"b03 = a01 * a12 - a02 * a11, \n"+"b04 = a01 * a13 - a03 * a11, \n"+"b05 = a02 * a13 - a03 * a12, \n"+"b06 = a20 * a31 - a21 * a30, \n"+"b07 = a20 * a32 - a22 * a30, \n"+"b08 = a20 * a33 - a23 * a30, \n"+"b09 = a21 * a32 - a22 * a31, \n"+"b10 = a21 * a33 - a23 * a31, \n"+"b11 = a22 * a33 - a23 * a32, \n"+"det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06; \n"+"return mat4( \n"+"a11 * b11 - a12 * b10 + a13 * b09, \n"+"a02 * b10 - a01 * b11 - a03 * b09, \n"+"a31 * b05 - a32 * b04 + a33 * b03, \n"+"a22 * b04 - a21 * b05 - a23 * b03, \n"+"a12 * b08 - a10 * b11 - a13 * b07, \n"+"a00 * b11 - a02 * b08 + a03 * b07, \n"+"a32 * b02 - a30 * b05 - a33 * b01, \n"+"a20 * b05 - a22 * b02 + a23 * b01, \n"+"a10 * b10 - a11 * b08 + a13 * b06, \n"+"a01 * b08 - a00 * b10 - a03 * b06, \n"+"a30 * b04 - a31 * b02 + a33 * b00, \n"+"a21 * b02 - a20 * b04 - a23 * b00, \n"+"a11 * b07 - a10 * b09 - a12 * b06, \n"+"a00 * b09 - a01 * b07 + a02 * b06, \n"+"a31 * b01 - a30 * b03 - a32 * b00, \n"+"a20 * b03 - a21 * b01 + a22 * b00) / det; \n"+"} \n"+"void calculateDirectLight( MaterialSource materialSource ){ \n"+"float lambertTerm , specular ; \n"+"vec3 dir ,viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n"+"for(int i = 0 ; i < max_directLight ; i++){ \n"+"DirectLight directLight ; \n"+"directLight.direction = (normalMatrix * vec4(uniform_directLightSource[i*9],uniform_directLightSource[i*9+1],uniform_directLightSource[i*9+2],1.0)).xyz; \n"+"directLight.diffuse = vec3(uniform_directLightSource[i*9+3],uniform_directLightSource[i*9+4],uniform_directLightSource[i*9+5]); \n"+"directLight.ambient = vec3(uniform_directLightSource[i*9+6],uniform_directLightSource[i*9+7],uniform_directLightSource[i*9+8]); \n"+"dir = normalize(directLight.direction) ; \n"+"LightingBlinnPhong(dir,directLight.diffuse,directLight.ambient,normal,viewDir,0.5); \n"+"} \n"+"} \n"+"void main() { \n"+"normalMatrix = inverse(uniform_ViewMatrix); \n"+"normalMatrix = transpose(normalMatrix); \n"+"calculateDirectLight( materialSource ); \n"+"} \n",endShadowPass_fs:"void main() { \n"+"if(varying_color.w<=0.0){ \n"+"discard; \n"+"} \n"+"outColor.x =  outColor.y = outColor.z = varying_ViewPose.z/varying_ViewPose.w  ; \n"+"outColor.w = 1.0 ; \n"+"gl_FragColor = outColor ; \n"+"} \n",endShadowPass_vs:"void main() { \n"+"outPosition = uniform_ProjectionMatrix * outPosition ; \n"+"gl_Position = outPosition ; \n"+"} \n"+"                       \n",end_fs:"varying vec4 varying_mvPose; \n"+"vec4 diffuseColor ; \n"+"vec4 specularColor ; \n"+"vec4 ambientColor; \n"+"vec4 light ; \n"+"vec3 Fresnel_Schlick(float cosT, vec3 F0) \n"+"{ \n"+"return F0 + (1.0-F0) * pow( 1.0 - cosT, 5.0); \n"+"} \n"+"void main() { \n"+"if(materialSource.refraction<2.41){ \n"+"float vl = dot(normal,-normalize(varying_mvPose.xyz)); \n"+"vec3 f = Fresnel_Schlick(vl,vec3(1.2)) * materialSource.refractionintensity ; \n"+"light.xyz += max(f,vec3(0.0)) ; \n"+"} \n"+"outColor.xyz = (light.xyz+materialSource.ambient) * (diffuseColor.xyz * materialSource.diffuse * varying_color.xyz) + specularColor.xyz ; \n"+"outColor.w = materialSource.alpha * diffuseColor.w * varying_color.w; \n"+"outColor.xyz *= outColor.w; \n"+"outColor.xyz = pow(outColor.xyz,vec3(materialSource.gamma)); \n"+"} \n",end_vs:"vec4 endPosition ; \n"+"uniform float uniform_materialSource[20]; \n"+"void main() { \n"+"gl_PointSize = uniform_materialSource[17]; \n"+"outPosition = uniform_ProjectionMatrix * outPosition ; \n"+"} \n"+"                       \n",environmentDiffuse_vertex:"void main(){ \n"+"} \n",environmentMapping_fragment:"uniform samplerCube environmentMapTex ; \n"+"uniform float reflectValue; \n"+"varying vec3 varying_ViewDir ; \n"+"void main(){ \n"+"vec3 N = normalize(normal); \n"+"vec3 V = normalize(varying_mvPose.xyz/varying_mvPose.w); \n"+"float dotNV = clamp(dot(N,V), 0.0, 1.0); \n"+"float FV = pow((1.0 - dotNV), 2.0); \n"+"mat4 invViewMatrix = inverse(uniform_ViewMatrix); \n"+"vec3 ecReflected = reflect(normalize(varying_ViewDir.xyz), normalize(mat3(invViewMatrix)*normal)); \n"+"vec4 reflectiveColor = textureCube(environmentMapTex,-normalize(ecReflected.xyz)); \n"+"diffuseColor.xyz = mix( diffuseColor.xyz,reflectiveColor.xyz, reflectValue + FV ); \n"+"} \n"+"          \n",
expFog_fs:"struct Fog{ \n"+"vec3 fogColor  ; \n"+"float globalDensity ; \n"+"vec3 distance ; \n"+"}; \n"+"varying vec4 varying_pos; \n"+"uniform float uniform_globalFog[7]; \n"+"void main(void){ \n"+"Fog fog; \n"+"fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n"+"fog.globalDensity = uniform_globalFog[3]; \n"+"fog.distance = vec2(uniform_globalFog[4], uniform_globalFog[5]); \n"+"float d = distance(uniform_eyepos,varying_pos.xyz); \n"+"float distFog = max( 0.0 , d - fog.distance.x )* fog.distance.y; \n"+"float fogFactor = (1.0-exp( -distFog * 0.000001 * fog.globalDensity )) ; \n"+"diffuseColor.xyz = mix( diffuseColor.xyz  , fog.fogColor , min(fogFactor,1.0) ); \n"+"} \n"+"  \n",expHeightFog_fs:"struct Fog{ \n"+"vec3 fogColor  ; \n"+"float globalDensity ; \n"+"float fogStartDistance ; \n"+"float fogHeightStart ; \n"+"float fogAlpha ; \n"+"}; \n"+"varying vec4 varying_pos; \n"+"uniform float uniform_globalFog[7]; \n"+"vec3 applyFog( float yDistance, vec3  vpos , Fog fog ) \n"+"{ \n"+"float d = distance(uniform_eyepos,varying_pos.xyz); \n"+"float distFog = max( 0.0 , d - fog.fogStartDistance ) ; \n"+"float yFog = max(0.0, (vpos.y - fog.fogHeightStart - yDistance) )  ; \n"+"float fogAmount =  1.0-(exp(-distFog * fog.globalDensity )) + (exp(-yFog * fog.globalDensity )); \n"+"return mix( diffuseColor.xyz,fog.fogColor, clamp(fogAmount,0.0,fog.fogAlpha) ); \n"+"} \n"+"void main(void){ \n"+"Fog fog; \n"+"fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n"+"fog.globalDensity = uniform_globalFog[3]; \n"+"fog.fogStartDistance = uniform_globalFog[4] ; \n"+"fog.fogHeightStart = uniform_globalFog[5] ; \n"+"fog.fogAlpha = uniform_globalFog[6] ; \n"+"fog.fogColor *= diffuseColor.w; \n"+"float yd = uniform_eyepos.y - varying_pos.y ; \n"+"diffuseColor.xyz = applyFog( yd , varying_pos.xyz , fog ); \n"+"} \n"+"  \n",FakePBR_fs:"#extension GL_OES_standard_derivatives:enable \n"+"#define max_directLight 1 \n"+"struct DirectLight{ \n"+"vec3 direction; \n"+"vec3 diffuse; \n"+"vec3 ambient; \n"+"}; \n"+"uniform float uniform_directLightSource[9*max_directLight] ; \n"+"varying vec4 varying_mvPose; \n"+"varying vec3 varying_eyeNormal; \n"+"varying vec2 varying_uv0; \n"+"uniform sampler2D albedoTex; \n"+"uniform sampler2D normalTex; \n"+"uniform sampler2D glossTex; \n"+"uniform sampler2D specularTex; \n"+"uniform sampler2D opacityTex; \n"+"uniform samplerCube reflectionMap; \n"+"uniform mat4 uniform_ViewMatrix; \n"+"mat3 TBN; \n"+"mat4 normalMatrix ; \n"+"vec3 normalDirection; \n"+"vec3 light; \n"+"vec3 normalTexColor ; \n"+"vec4 opacityTexColor ; \n"+"vec4 glossTexColor ; \n"+"vec4 specularTexColor ; \n"+"vec4 albedoTexColor ; \n"+"vec2 uv_0; \n"+"mat4 transpose(mat4 inMatrix) { \n"+"vec4 i0 = inMatrix[0]; \n"+"vec4 i1 = inMatrix[1]; \n"+"vec4 i2 = inMatrix[2]; \n"+"vec4 i3 = inMatrix[3]; \n"+"mat4 outMatrix = mat4( \n"+"vec4(i0.x, i1.x, i2.x, i3.x), \n"+"vec4(i0.y, i1.y, i2.y, i3.y), \n"+"vec4(i0.z, i1.z, i2.z, i3.z), \n"+"vec4(i0.w, i1.w, i2.w, i3.w) \n"+"); \n"+"return outMatrix; \n"+"} \n"+"mat4 inverse(mat4 m) { \n"+"float \n"+"a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3], \n"+"a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3], \n"+"a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3], \n"+"a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3], \n"+"b00 = a00 * a11 - a01 * a10, \n"+"b01 = a00 * a12 - a02 * a10, \n"+"b02 = a00 * a13 - a03 * a10, \n"+"b03 = a01 * a12 - a02 * a11, \n"+"b04 = a01 * a13 - a03 * a11, \n"+"b05 = a02 * a13 - a03 * a12, \n"+"b06 = a20 * a31 - a21 * a30, \n"+"b07 = a20 * a32 - a22 * a30, \n"+"b08 = a20 * a33 - a23 * a30, \n"+"b09 = a21 * a32 - a22 * a31, \n"+"b10 = a21 * a33 - a23 * a31, \n"+"b11 = a22 * a33 - a23 * a32, \n"+"det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06; \n"+"return mat4( \n"+"a11 * b11 - a12 * b10 + a13 * b09, \n"+"a02 * b10 - a01 * b11 - a03 * b09, \n"+"a31 * b05 - a32 * b04 + a33 * b03, \n"+"a22 * b04 - a21 * b05 - a23 * b03, \n"+"a12 * b08 - a10 * b11 - a13 * b07, \n"+"a00 * b11 - a02 * b08 + a03 * b07, \n"+"a32 * b02 - a30 * b05 - a33 * b01, \n"+"a20 * b05 - a22 * b02 + a23 * b01, \n"+"a10 * b10 - a11 * b08 + a13 * b06, \n"+"a01 * b08 - a00 * b10 - a03 * b06, \n"+"a30 * b04 - a31 * b02 + a33 * b00, \n"+"a21 * b02 - a20 * b04 - a23 * b00, \n"+"a11 * b07 - a10 * b09 - a12 * b06, \n"+"a00 * b09 - a01 * b07 + a02 * b06, \n"+"a31 * b01 - a30 * b03 - a32 * b00, \n"+"a20 * b03 - a21 * b01 + a22 * b00) / det; \n"+"} \n"+"vec3 unpackNormal(vec4 packednormal) \n"+"{ \n"+"return packednormal.xyz * 2.0 - 1.0; \n"+"} \n"+"mat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) { \n"+"vec3 dp1 = dFdx(p); \n"+"vec3 dp2 = dFdy(p); \n"+"vec2 duv1 = dFdx(uv); \n"+"vec2 duv2 = dFdy(uv); \n"+"vec3 dp2perp = cross(dp2, N); \n"+"vec3 dp1perp = cross(N, dp1); \n"+"vec3 T = dp2perp * duv1.x + dp1perp * duv2.x; \n"+"vec3 B = dp2perp * duv1.y + dp1perp * duv2.y; \n"+"float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B))); \n"+"return mat3(T * invmax, B * invmax, N); \n"+"} \n"+"vec3 fakePBRLight( vec3 lightDir , vec3 viewDir , vec3 lightColor , vec3 ambient ){ \n"+"vec3 lightDirection = mat3(uniform_ViewMatrix) * normalize(lightDir); \n"+"vec3 halfDirection = normalize( lightDirection + viewDir) ; \n"+"float attenuation = 1.0 ; \n"+"vec3 attenColor = attenuation * lightColor; \n"+"float Pi = 3.141592654; \n"+"float InvPi = 0.31830988618; \n"+"float gloss = glossTexColor.r; \n"+"float specPow = exp2( gloss * 10.0 + 1.0 ); \n"+"float NdotL = max(0.0, dot( normalDirection, lightDirection )); \n"+"float specularMonochrome = max( max(specularTexColor.r, specularTexColor.g), specularTexColor.b); \n"+"float normTerm = (specPow + 8.0 ) / (8.0 * Pi); \n"+"vec3 directSpecular =  (floor(attenuation) * lightColor ) * pow(max(0.0,dot(halfDirection,normalDirection)),normTerm) * specularTexColor.xyz * normTerm ; \n"+"vec3 specular = directSpecular; \n"+"NdotL = max(0.0,dot( normalDirection , normalize(lightDirection) )); \n"+"vec3 directDiffuse = max( 0.0, NdotL) * attenColor; \n"+"vec3 indirectDiffuse = vec3(0.0,0.0,0.0); \n"+"indirectDiffuse +=  ambient ; \n"+"vec3 diffuseColor = albedoTexColor.rgb; \n"+"diffuseColor *= 1.0-specularMonochrome; \n"+"vec3 diffuse = (directDiffuse + indirectDiffuse) * diffuseColor; \n"+"vec3 finalColor = diffuse + specular ; \n"+"return finalColor ; \n"+"} \n"+"void calculateDirectLight(  ){ \n"+"float lambertTerm , specular ; \n"+"vec3 dir ,viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n"+"for(int i = 0 ; i < max_directLight ; i++){ \n"+"DirectLight directLight ; \n"+"directLight.direction = vec3(uniform_directLightSource[i*9],uniform_directLightSource[i*9+1],uniform_directLightSource[i*9+2]); \n"+"directLight.diffuse = vec3(uniform_directLightSource[i*9+3],uniform_directLightSource[i*9+4],uniform_directLightSource[i*9+5]); \n"+"directLight.ambient = vec3(uniform_directLightSource[i*9+6],uniform_directLightSource[i*9+7],uniform_directLightSource[i*9+8]); \n"+"dir = normalize(directLight.direction) ; \n"+"light.xyz += fakePBRLight( dir , viewDir , directLight.diffuse , directLight.ambient); \n"+"} \n"+"} \n"+"void main(void){ \n"+"TBN = cotangentFrame(normalize(varying_eyeNormal), normalize(-varying_mvPose.xyz) , uv_0); \n"+"albedoTexColor = texture2D(albedoTex, varying_uv0 ); \n"+"normalTexColor = unpackNormal(texture2D(normalTex, uv_0 )) ; \n"+"opacityTexColor = texture2D(opacityTex, uv_0 ) ; \n"+"glossTexColor = texture2D(glossTex, uv_0 ); \n"+"specularTexColor = texture2D(specularTex, uv_0 ); \n"+"normalDirection = TBN * normalTexColor.xyz ; \n"+"if( (step(materialSource.cutAlpha,opacityTexColor.g) - 0.5) < 0.0 ){ \n"+"discard; \n"+"} \n"+"calculateDirectLight(); \n"+"vec4 finalRGBA = vec4(light,1.0) ; \n"+"gl_FragColor = finalRGBA; \n"+"} \n",FakePBR_vs:"attribute vec3 attribute_position; \n"+"attribute vec3 attribute_normal; \n"+"attribute vec2 attribute_uv0; \n"+"uniform mat4 uniform_ModelMatrix ; \n"+"uniform mat4 uniform_ViewMatrix ; \n"+"uniform mat4 uniform_ProjectionMatrix ; \n"+"varying vec4 varying_mvPose; \n"+"varying vec3 varying_eyeNormal; \n"+"varying vec2 varying_uv0; \n"+"vec4 outPosition; \n"+"mat4 transpose(mat4 inMatrix) { \n"+"vec4 i0 = inMatrix[0]; \n"+"vec4 i1 = inMatrix[1]; \n"+"vec4 i2 = inMatrix[2]; \n"+"vec4 i3 = inMatrix[3]; \n"+"mat4 outMatrix = mat4( \n"+"vec4(i0.x, i1.x, i2.x, i3.x), \n"+"vec4(i0.y, i1.y, i2.y, i3.y), \n"+"vec4(i0.z, i1.z, i2.z, i3.z), \n"+"vec4(i0.w, i1.w, i2.w, i3.w) \n"+"); \n"+"return outMatrix; \n"+"} \n"+"mat4 inverse(mat4 m) { \n"+"float \n"+"a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3], \n"+"a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3], \n"+"a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3], \n"+"a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3], \n"+"b00 = a00 * a11 - a01 * a10, \n"+"b01 = a00 * a12 - a02 * a10, \n"+"b02 = a00 * a13 - a03 * a10, \n"+"b03 = a01 * a12 - a02 * a11, \n"+"b04 = a01 * a13 - a03 * a11, \n"+"b05 = a02 * a13 - a03 * a12, \n"+"b06 = a20 * a31 - a21 * a30, \n"+"b07 = a20 * a32 - a22 * a30, \n"+"b08 = a20 * a33 - a23 * a30, \n"+"b09 = a21 * a32 - a22 * a31, \n"+"b10 = a21 * a33 - a23 * a31, \n"+"b11 = a22 * a33 - a23 * a32, \n"+"det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06; \n"+"return mat4( \n"+"a11 * b11 - a12 * b10 + a13 * b09, \n"+"a02 * b10 - a01 * b11 - a03 * b09, \n"+"a31 * b05 - a32 * b04 + a33 * b03, \n"+"a22 * b04 - a21 * b05 - a23 * b03, \n"+"a12 * b08 - a10 * b11 - a13 * b07, \n"+"a00 * b11 - a02 * b08 + a03 * b07, \n"+"a32 * b02 - a30 * b05 - a33 * b01, \n"+"a20 * b05 - a22 * b02 + a23 * b01, \n"+"a10 * b10 - a11 * b08 + a13 * b06, \n"+"a01 * b08 - a00 * b10 - a03 * b06, \n"+"a30 * b04 - a31 * b02 + a33 * b00, \n"+"a21 * b02 - a20 * b04 - a23 * b00, \n"+"a11 * b07 - a10 * b09 - a12 * b06, \n"+"a00 * b09 - a01 * b07 + a02 * b06, \n"+"a31 * b01 - a30 * b03 - a32 * b00, \n"+"a20 * b03 - a21 * b01 + a22 * b00) / det; \n"+"} \n"+"void main(void){ \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n"+"varying_mvPose = mvMatrix * vec4( attribute_position , 1.0 )  ; \n"+"mat4 normalMatrix = inverse(mvMatrix) ; \n"+"normalMatrix = transpose(normalMatrix); \n"+"varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n"+"varying_uv0 = attribute_uv0 ; \n"+"outPosition = uniform_ProjectionMatrix * varying_mvPose ; \n"+"gl_Position = outPosition; \n"+"} \n",flatNormal_fs:"#extension GL_OES_standard_derivatives : enable \n"+"vec3 flatNormal(vec3 pos){ \n"+"vec3 fdx = dFdx(pos); \n"+"vec3 fdy = dFdy(pos); \n"+"return normalize(cross(fdx, fdy)); \n"+"} \n",gamma_fs:"const float gamma = 2.2; \n"+"float toLinear_float_v1(float v) { \n"+"return pow(v, gamma); \n"+"} \n"+"vec2 toLinear_vec2_v1(vec2 v) { \n"+"return pow(v, vec2(gamma)); \n"+"} \n"+"vec3 toLinear_vec3_v1(vec3 v) { \n"+"return pow(v, vec3(gamma)); \n"+"} \n"+"vec4 toLinear_vec4_v1(vec4 v) { \n"+"return vec4(toLinear_vec3_v1(v.rgb), v.a); \n"+"} \n"+"float toGamma_float_v2(float v) { \n"+"return pow(v, 1.0 / gamma); \n"+"} \n"+"vec2 toGamma_vec2_v2(vec2 v) { \n"+"return pow(v, vec2(1.0 / gamma)); \n"+"} \n"+"vec3 toGamma_vec3_v2(vec3 v) { \n"+"return pow(v, vec3(1.0 / gamma)); \n"+"} \n"+"vec4 toGamma_vec4_v2(vec4 v) { \n"+"return vec4(toGamma_vec3_v2(v.rgb), v.a); \n"+"} \n"+"vec4 textureLinear(sampler2D uTex, vec2 uv) { \n"+"return toLinear_vec4_v1(texture2D(uTex, uv)); \n"+"} \n",gaussian_H_fs:"varying vec2 varying_uv0; \n"+"uniform sampler2D diffuseTexture; \n"+"vec4 blur9_1_0(sampler2D image, vec2 uv, float radius , float resolution, vec2 dir) { \n"+"vec4 color = vec4(0.0); \n"+"vec2 tc = uv; \n"+"float blur = radius/resolution ; \n"+"float hstep = dir.x; \n"+"float vstep = dir.y; \n"+"color += texture2D(image, vec2(tc.x - 4.0*blur*hstep, tc.y - 4.0*blur*vstep)) * 0.0162162162; \n"+"color += texture2D(image, vec2(tc.x - 3.0*blur*hstep, tc.y - 3.0*blur*vstep)) * 0.0540540541; \n"+"color += texture2D(image, vec2(tc.x - 2.0*blur*hstep, tc.y - 2.0*blur*vstep)) * 0.1216216216; \n"+"color += texture2D(image, vec2(tc.x - 1.0*blur*hstep, tc.y - 1.0*blur*vstep)) * 0.1945945946; \n"+"color += texture2D(image, vec2(tc.x, tc.y)) * 0.2270270270; \n"+"color += texture2D(image, vec2(tc.x + 1.0*blur*hstep, tc.y + 1.0*blur*vstep)) * 0.1945945946; \n"+"color += texture2D(image, vec2(tc.x + 2.0*blur*hstep, tc.y + 2.0*blur*vstep)) * 0.1216216216; \n"+"color += texture2D(image, vec2(tc.x + 3.0*blur*hstep, tc.y + 3.0*blur*vstep)) * 0.0540540541; \n"+"color += texture2D(image, vec2(tc.x + 4.0*blur*hstep, tc.y + 4.0*blur*vstep)) * 0.0162162162; \n"+"return color; \n"+"} \n"+"void main(void) { \n"+"vec4 color = vec4(0.0,0.0,0.0,0.0); \n"+"color =blur9_1_0(diffuseTexture,varying_uv0,3.0,2048.0,vec2(0.0,1.0)); \n"+"gl_FragColor  = color; \n"+"} \n",gaussian_V_fs:"varying vec2 varying_uv0; \n"+"uniform sampler2D diffuseTexture; \n"+"uniform sampler2D colorTexture; \n"+"vec4 blur9_1_0(sampler2D image, vec2 uv, float radius , float resolution, vec2 dir) { \n"+"vec4 color = vec4(0.0); \n"+"vec2 tc = uv; \n"+"float blur = radius/resolution ; \n"+"float hstep = dir.x; \n"+"float vstep = dir.y; \n"+"color += texture2D(image, vec2(tc.x - 4.0*blur*hstep, tc.y - 4.0*blur*vstep)) * 0.0162162162; \n"+"color += texture2D(image, vec2(tc.x - 3.0*blur*hstep, tc.y - 3.0*blur*vstep)) * 0.0540540541; \n"+"color += texture2D(image, vec2(tc.x - 2.0*blur*hstep, tc.y - 2.0*blur*vstep)) * 0.1216216216; \n"+"color += texture2D(image, vec2(tc.x - 1.0*blur*hstep, tc.y - 1.0*blur*vstep)) * 0.1945945946; \n"+"color += texture2D(image, vec2(tc.x, tc.y)) * 0.2270270270; \n"+"color += texture2D(image, vec2(tc.x + 1.0*blur*hstep, tc.y + 1.0*blur*vstep)) * 0.1945945946; \n"+"color += texture2D(image, vec2(tc.x + 2.0*blur*hstep, tc.y + 2.0*blur*vstep)) * 0.1216216216; \n"+"color += texture2D(image, vec2(tc.x + 3.0*blur*hstep, tc.y + 3.0*blur*vstep)) * 0.0540540541; \n"+"color += texture2D(image, vec2(tc.x + 4.0*blur*hstep, tc.y + 4.0*blur*vstep)) * 0.0162162162; \n"+"return color; \n"+"} \n"+"void main(void) { \n"+"vec4 color = vec4(0.0,0.0,0.0,0.0); \n"+"vec2 uv = vec2(varying_uv0.x,1.0-varying_uv0.y); \n"+"color = blur9_1_0(diffuseTexture,varying_uv0,3.0,2048.0,vec2(1.0,0.0)); \n"+"color += texture2D(colorTexture,uv); \n"+"gl_FragColor  = color; \n"+"} \n",grass_fs:"uniform float uniform_lightMap_data[5]; \n"+"uniform sampler2D diffuseTexture; \n"+"uniform sampler2D lightMapTexture; \n"+"varying vec4 varying_scenePose; \n"+"vec4 diffuseColor; \n"+"void main() { \n"+"vec2 lightUV; \n"+"diffuseColor = texture2D(diffuseTexture, varying_uv0); \n"+"if( diffuseColor.w < materialSource.cutAlpha ){ \n"+"discard; \n"+"} \n"+"if(uniform_lightMap_data[0] > 0.5){ \n"+"lightUV.x = (varying_scenePose.x + uniform_lightMap_data[1]) / uniform_lightMap_data[3]; \n"+"lightUV.y = (varying_scenePose.z + uniform_lightMap_data[2]) / uniform_lightMap_data[4]; \n"+"diffuseColor *= texture2D(lightMapTexture, lightUV); \n"+"} \n"+"outColor = diffuseColor; \n"+"} \n",grass_vs:"attribute vec3 attribute_grassOffset; \n"+"attribute float attribute_grassAngleY; \n"+"uniform float uniform_grass_data[9]; \n"+"uniform float uniform_squeeze_data[6]; \n"+"uniform float uniform_lightMap_data[5]; \n"+"uniform mat4 uniform_cameraMatrix; \n"+"uniform mat4 uniform_billboardMatrix; \n"+"varying vec4 varying_mvPose; \n"+"varying vec4 varying_scenePose; \n"+"const float TrueOrFalse = 0.5; \n"+"const float PI_2 = 6.283; \n"+"struct SqueezeData{ \n"+"float enable; \n"+"vec3 position; \n"+"float strength; \n"+"float radius; \n"+"}; \n"+"SqueezeData squeezeData; \n"+"mat4 buildRotMat4(vec3 rot) \n"+"{ \n"+"float s; \n"+"float c; \n"+"s = sin(rot.x); \n"+"c = cos(rot.x); \n"+"mat4 ret = mat4( \n"+"vec4(1.0, 0.0, 0.0, 0.0), \n"+"vec4(0.0, c, s, 0.0), \n"+"vec4(0.0, -s, c, 0.0), \n"+"vec4(0.0, 0.0, 0.0, 1.0) \n"+"); \n"+"s = sin(rot.y); \n"+"c = cos(rot.y); \n"+"ret = mat4( \n"+"vec4(c, 0.0, -s, 0.0), \n"+"vec4(0.0, 1.0, 0.0, 0.0), \n"+"vec4(s, 0.0, c, 0.0), \n"+"vec4(0.0, 0.0, 0.0, 1.0) \n"+") * ret; \n"+"s = sin(rot.z); \n"+"c = cos(rot.z); \n"+"ret = mat4( \n"+"vec4(c, s, 0.0, 0.0), \n"+"vec4(-s, c, 0.0, 0.0), \n"+"vec4(0.0, 0.0, 1.0, 0.0), \n"+"vec4(0.0, 0.0, 0.0, 1.0) \n"+") * ret; \n"+"return ret; \n"+"} \n"+"vec4 buildQuat(vec3 axis, float angle){ \n"+"axis = normalize(axis); \n"+"vec4 ret; \n"+"float halfAngle = angle * 0.5; \n"+"float sin_a = sin(angle); \n"+"ret.w = cos(halfAngle); \n"+"ret.x = axis.x * sin_a; \n"+"ret.y = axis.y * sin_a; \n"+"ret.z = axis.z * sin_a; \n"+"ret = normalize(ret); \n"+"return ret; \n"+"} \n"+"mat4 buildMat4Quat(vec4 quat) \n"+"{ \n"+"float xx = quat.x * quat.x; \n"+"float xy = quat.x * quat.y; \n"+"float xz = quat.x * quat.z; \n"+"float xw = quat.x * quat.w; \n"+"float yy = quat.y * quat.y; \n"+"float yz = quat.y * quat.z; \n"+"float yw = quat.y * quat.w; \n"+"float zz = quat.z * quat.z; \n"+"float zw = quat.z * quat.w; \n"+"return mat4( \n"+"1.0 - 2.0 * (yy + zz),\t\t2.0 * (xy + zw),\t\t2.0 * (xz - yw),\t\t0, \n"+"2.0 * (xy - zw),\t\t\t\t1.0 - 2.0 * (xx + zz),\t2.0 * (yz + xw),\t\t0, \n"+"2.0 * (xz + yw),\t\t\t\t2.0 * (yz - xw),\t\t1.0 - 2.0 * (xx + yy),\t0, \n"+"0.0,\t\t\t\t\t\t\t0.0,\t\t\t\t\t0.0,\t\t\t\t\t1 \n"+"); \n"+"} \n"+"void main(void){ \n"+"if(uniform_grass_data[8] > TrueOrFalse){ \n"+"rotVertexMatrix = uniform_billboardMatrix; \n"+"}else{ \n"+"rotVertexMatrix = buildRotMat4(vec3(0.0, attribute_grassAngleY, 0.0)); \n"+"} \n"+"e_position.xyz = (rotVertexMatrix * vec4(e_position, 1.0)).xyz; \n"+"e_normal.xyz = (rotVertexMatrix * vec4(e_normal, 1.0)).xyz; \n"+"if(e_position.y > 0.0){ \n"+"float windDirectionX\t\t\t= uniform_grass_data[0]; \n"+"float windDirectionZ\t\t\t= uniform_grass_data[1]; \n"+"float windSpaceX\t\t\t\t= uniform_grass_data[2]; \n"+"float windSpaceZ\t\t\t\t= uniform_grass_data[3]; \n"+"float windStrength\t\t\t\t= uniform_grass_data[4]; \n"+"float windSpeed\t\t\t\t\t= uniform_grass_data[5]; \n"+"float shakeScale\t\t\t\t= uniform_grass_data[6]; \n"+"float grassTime\t\t\t\t\t= uniform_grass_data[7]; \n"+"squeezeData.enable\t\t\t= uniform_squeeze_data[0]; \n"+"squeezeData.position.x\t\t= uniform_squeeze_data[1]; \n"+"squeezeData.position.y\t\t= uniform_squeeze_data[2]; \n"+"squeezeData.position.z\t\t= uniform_squeeze_data[3]; \n"+"squeezeData.radius\t\t\t= uniform_squeeze_data[4]; \n"+"squeezeData.strength\t\t= uniform_squeeze_data[5]; \n"+"windSpaceX = PI_2 * (attribute_grassOffset.x + abs(windDirectionX) * windSpeed * grassTime) / windSpaceX; \n"+"windSpaceZ = PI_2 * (attribute_grassOffset.z + abs(windDirectionZ) * windSpeed * grassTime) / windSpaceZ; \n"+"float angle = sin(windSpaceX + windSpaceZ) * shakeScale + windStrength; \n"+"angle = clamp(angle, -1.57, 1.57); \n"+"vec3 windDir = vec3(windSpaceX, 0.0, windSpaceZ); \n"+"vec3 windDirY = vec3(0.0, 1.0, 0.0); \n"+"windDir = normalize(windDir); \n"+"vec3 axis = cross(windDirY,windDir); \n"+"vec4 quat = buildQuat(axis, angle); \n"+"mat4 matrix = buildMat4Quat(quat); \n"+"vec2 orgXZ = vec2(e_position.x, e_position.z); \n"+"e_position.x = e_position.z = 0.0; \n"+"e_position = (matrix * vec4(e_position, 1.0)).xyz; \n"+"e_position.xz += orgXZ; \n"+"if(squeezeData.enable > TrueOrFalse){ \n"+"vec3 distanceVec3 = squeezeData.position - attribute_grassOffset; \n"+"vec2 distance2D = vec2(distanceVec3.x, distanceVec3.z); \n"+"float distanceFloat = sqrt(dot(distance2D, distance2D)); \n"+"if(distanceFloat < squeezeData.radius){ \n"+"float ratio = distanceFloat / squeezeData.radius; \n"+"ratio = 1.0 - ratio; \n"+"distanceVec3 = normalize(distanceVec3); \n"+"distanceVec3 *= squeezeData.strength * ratio * abs(e_position.y - squeezeData.position.y); \n"+"e_position -= distanceVec3; \n"+"} \n"+"} \n"+"} \n"+"e_position += attribute_grassOffset; \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n"+"varying_mvPose = outPosition = mvMatrix * vec4( e_position , 1.0 ); \n"+"varying_scenePose = vec4( e_position, 1.0 ); \n"+"mat4 normalMatrix = inverse(mvMatrix) ; \n"+"normalMatrix = transpose(normalMatrix); \n"+"varying_eyeNormal = mat3(normalMatrix) * - e_normal; \n"+"varying_color = attribute_color; \n"+"} \n",gui_fs:"varying vec4 varying_uv; \n"+"varying vec4 varying_color; \n"+"varying vec4 varying_pos; \n"+"varying vec4 varying_mask; \n"+"vec4 diffuseColor; \n"+"uniform sampler2D uiTexture_0; \n"+"uniform sampler2D uiTexture_1; \n"+"uniform sampler2D uiTexture_2; \n"+"uniform sampler2D uiTexture_3; \n"+"uniform sampler2D uiTexture_4; \n"+"uniform sampler2D uiTexture_5; \n"+"uniform sampler2D uiTexture_6; \n"+"const int FLAG_VALLID_QUAD = 0; \n"+"const int FLAG_IS_VISIBLE = 1; \n"+"const int FLAG_HAS_MASK = 2; \n"+"const int FLAG_HAS_TEXTURE = 3; \n"+"const int FLAG_IS_TEXTFIELD = 4; \n"+"bool booleanArray[5]; \n"+"void decodeBooleanArray(float data){ \n"+"float headData; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[0] = (headData - data) > 0.2; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[1] = (headData - data) > 0.2; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[2] = (headData - data) > 0.2; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[3] = (headData - data) > 0.2; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[4] = (headData - data) > 0.2; \n"+"} \n"+"void main(void){ \n"+"decodeBooleanArray(varying_pos.w); \n"+"if(booleanArray[FLAG_VALLID_QUAD] == false || booleanArray[FLAG_IS_VISIBLE] == false || booleanArray[FLAG_HAS_TEXTURE] == false){ \n"+"discard; \n"+"} \n"+"if(booleanArray[FLAG_HAS_MASK]){ \n"+"vec4 mask = varying_mask; \n"+"if( (2.0*mask.x-1.0) > varying_pos.x){ \n"+"discard; \n"+"} \n"+"if( (-2.0*mask.y+1.0) < varying_pos.y){ \n"+"discard; \n"+"} \n"+"if( (2.0*mask.z-1.0) < varying_pos.x){ \n"+"discard; \n"+"} \n"+"if( (-2.0*mask.w+1.0) > varying_pos.y){ \n"+"discard; \n"+"} \n"+"} \n"+"vec2 uv = varying_uv.xy ; \n"+"int index = int(floor(varying_pos.z)); \n"+"if(booleanArray[FLAG_HAS_TEXTURE] == false){ \n"+"diffuseColor = vec4(1.0, 1.0, 1.0, 1.0); \n"+"} \n"+"else{ \n"+"if(index==0){ \n"+"diffuseColor = texture2D(uiTexture_0, uv ); \n"+"} \n"+"else if(index==1){ \n"+"diffuseColor = texture2D(uiTexture_1, uv ); \n"+"} \n"+"else if(index==2){ \n"+"diffuseColor = texture2D(uiTexture_2, uv ); \n"+"} \n"+"else if(index==3){ \n"+"diffuseColor = texture2D(uiTexture_3, uv ); \n"+"} \n"+"else if(index==4){ \n"+"diffuseColor = texture2D(uiTexture_4, uv ); \n"+"} \n"+"else if(index==5){ \n"+"diffuseColor = texture2D(uiTexture_5, uv ); \n"+"} \n"+"else if(index==6){ \n"+"diffuseColor = texture2D(uiTexture_6, uv ); \n"+"} \n"+"if(booleanArray[FLAG_IS_TEXTFIELD]){ \n"+"int clrChannel = int(uv.x); \n"+"uv.x -= float(clrChannel); \n"+"float fontAlpha = 1.0; \n"+"if(clrChannel == 0){ \n"+"fontAlpha = diffuseColor.x; \n"+"}else if(clrChannel == 1){ \n"+"fontAlpha = diffuseColor.y; \n"+"} else if(clrChannel == 2){ \n"+"fontAlpha = diffuseColor.z; \n"+"}else if(clrChannel == 3){ \n"+"fontAlpha = diffuseColor.w; \n"+"} \n"+"if(fontAlpha > 0.9){ \n"+"fontAlpha = 1.0; \n"+"} \n"+"diffuseColor = vec4(1.0, 1.0, 1.0, fontAlpha); \n"+"} \n"+"} \n"+"if(diffuseColor.w < 0.01 || varying_color.w < 0.01){ \n"+"discard; \n"+"} \n"+"diffuseColor.xyz *= varying_color.xyz; \n"+"diffuseColor.w *= varying_color.w; \n"+"diffuseColor.xyz *= diffuseColor.w; \n"+"diffuseColor = clamp(diffuseColor, 0.0, 1.0); \n"+"gl_FragColor = diffuseColor; \n"+"} \n",gui_vs:"attribute vec4 attribute_position; \n"+"attribute vec4 attribute_shapePosition; \n"+"attribute vec4 attribute_uvRec; \n"+"attribute vec4 attribute_rotate; \n"+"attribute vec4 attribute_maskRectangle; \n"+"attribute vec4 attribute_quad_color; \n"+"varying vec4 varying_uv; \n"+"varying vec4 varying_color; \n"+"varying vec4 varying_pos; \n"+"varying vec4 varying_mask; \n"+"varying float varying_boolList; \n"+"vec4 outPosition; \n"+"uniform mat4 uniform_ModelMatrix; \n"+"uniform mat4 uniform_ViewMatrix; \n"+"uniform mat4 uniform_ProjectionMatrix; \n"+"uniform mat4 uniform_orthProjectMatrix; \n"+"uniform float uniform_materialSource[20]; \n"+"mat4 buildMat4Quat(vec4 quat){ \n"+"float xx = quat.x * quat.x; \n"+"float xy = quat.x * quat.y; \n"+"float xz = quat.x * quat.z; \n"+"float xw = quat.x * quat.w; \n"+"float yy = quat.y * quat.y; \n"+"float yz = quat.y * quat.z; \n"+"float yw = quat.y * quat.w; \n"+"float zz = quat.z * quat.z; \n"+"float zw = quat.z * quat.w; \n"+"return mat4( \n"+"1.0 - 2.0 * (yy + zz),\t\t2.0 * (xy + zw),\t\t2.0 * (xz - yw),\t\t0, \n"+"2.0 * (xy - zw),\t\t\t\t1.0 - 2.0 * (xx + zz),\t2.0 * (yz + xw),\t\t0, \n"+"2.0 * (xz + yw),\t\t\t\t2.0 * (yz - xw),\t\t1.0 - 2.0 * (xx + yy),\t0, \n"+"0.0,\t\t\t\t\t\t\t0.0,\t\t\t\t\t0.0,\t\t\t\t\t1 \n"+"); \n"+"} \n"+"const int FLAG_VALLID_QUAD = 0; \n"+"const int FLAG_IS_VISIBLE = 1; \n"+"const int FLAG_HAS_MASK = 2; \n"+"const int FLAG_HAS_TEXTURE = 3; \n"+"const int FLAG_IS_TEXTFIELD = 4; \n"+"bool booleanArray[5]; \n"+"void decodeBooleanArray(float data){ \n"+"float headData; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[0] = (headData - data) > 0.2; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[1] = (headData - data) > 0.2; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[2] = (headData - data) > 0.2; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[3] = (headData - data) > 0.2; \n"+"data *= 0.5; \n"+"headData = data; \n"+"data = floor(data); \n"+"booleanArray[4] = (headData - data) > 0.2; \n"+"} \n"+"void main(void){ \n"+"gl_PointSize = uniform_materialSource[18]; \n"+"varying_pos.zw = attribute_shapePosition.zw; \n"+"decodeBooleanArray(attribute_shapePosition.w); \n"+"if(booleanArray[FLAG_VALLID_QUAD] == false || booleanArray[FLAG_IS_VISIBLE] == false || booleanArray[FLAG_HAS_TEXTURE] == false){ \n"+"outPosition = vec4(0.0,0.0,0.0,1.0); \n"+"gl_Position = outPosition; \n"+"return; \n"+"} \n"+"float devicePixelRatio = 1.0; \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n"+"mat4 po = buildMat4Quat(attribute_rotate.xyzw); \n"+"mat4 oth = uniform_orthProjectMatrix; \n"+"float px = oth[0].x ; \n"+"float py = oth[1].y ; \n"+"oth[0].x = oth[0].x / devicePixelRatio ; \n"+"oth[1].y = oth[1].y / devicePixelRatio ; \n"+"vec3 pos = mat3(po) * (attribute_position.xyz * vec3(attribute_uvRec.zw,1.0) ) + vec3(attribute_shapePosition.xy,1.0) ; \n"+"vec3 sceneWH = vec3( 1.0/ oth[0].x, -1.0/oth[1].y , 0.0 )  ; \n"+"outPosition = mvMatrix * vec4( pos - sceneWH , 1.0 ) ; \n"+"varying_color = attribute_quad_color ; \n"+"outPosition = oth * outPosition ; \n"+"varying_pos.xy = outPosition.xy; \n"+"vec4 maskk = attribute_maskRectangle; \n"+"sceneWH = vec3(2.0/px*devicePixelRatio,2.0/py*devicePixelRatio,1.0) ; \n"+"varying_mask = vec4(maskk.xy/sceneWH.xy,(maskk.x+maskk.z)/sceneWH.x, (maskk.y+maskk.w)/(sceneWH.y)) ; \n"+"varying_uv = attribute_uvRec; \n"+"gl_Position = outPosition; \n"+"} \n",hud_cull_fs:"varying vec2 varying_uv0; \n"+"uniform sampler2D diffuseTexture; \n"+"uniform vec2 uv_scale; \n"+"void main(void) { \n"+"vec2 uv_0 = varying_uv0; \n"+"uv_0 *= uv_scale; \n"+"vec4 color = texture2D(diffuseTexture, varying_uv0); \n"+"float mask = 1.0; \n"+"float f = uv_scale.y - varying_uv0.y; \n"+"if (varying_uv0.y < uv_scale.y){ \n"+"if(f < 0.03 && f > 0.0){ \n"+"mask =1.0 - (f / 0.03 * 0.9 + 0.1); \n"+"} \n"+"else{ \n"+"mask = 0.1; \n"+"} \n"+"} \n"+"color.xyz *= mask; \n"+"gl_FragColor  = color; \n"+"} \n",hud_H_fs:"varying vec2 varying_uv0; \n"+"uniform sampler2D diffuseTexture; \n"+"void main(void) { \n"+"vec2 uv = vec2(varying_uv0.x ,1.0-varying_uv0.y); \n"+"vec4 color = texture2D(diffuseTexture, uv); \n"+"gl_FragColor  = color; \n"+"} \n",hud_vs:"attribute vec3 attribute_position; \n"+"attribute vec2 attribute_uv0; \n"+"varying  vec2 varying_uv0; \n"+"uniform  mat4 uniform_ViewProjectionMatrix; \n"+"void main(void) { \n"+"vec4 pos = vec4(attribute_position, 1.0); \n"+"gl_Position = uniform_ViewProjectionMatrix * pos; \n"+"varying_uv0 = attribute_uv0; \n"+"} \n",hud_V_fs:"varying vec2 varying_uv0; \n"+"uniform sampler2D diffuseTexture; \n"+"void main(void) { \n"+"vec4 color = texture2D(diffuseTexture, varying_uv0); \n"+"gl_FragColor  = color; \n"+"} \n",lightingBase_fs:"void LightingBlinnPhong(vec3 lightDir, vec3 lightColor , vec3 lightAmbient , vec3 normal , vec3 viewDir, float atten){ \n"+"vec3 H = normalize(lightDir + normalize(viewDir)); \n"+"float NdotL = max(dot(normal, lightDir),0.0); \n"+"float NdotH = max(dot(normal,H),0.0); \n"+"vec3 diffuse = lightColor.xyz * NdotL ; \n"+"float specPower = pow (NdotH, materialSource.shininess ) * materialSource.specularScale ; \n"+"vec3 specular = lightColor.xyz * specPower * materialSource.specular ; \n"+"specularColor.xyz += specular; \n"+"light.xyz += (diffuse+lightAmbient) * (atten * 2.0 ); \n"+"light.w = materialSource.alpha + (specPower * atten); \n"+"} \n"+"void main(void) { \n"+"light.xyzw = vec4(0.0,0.0,0.0,1.0) ; \n"+"} \n",lightMapSpecularPower_fs:"uniform sampler2D lightTexture ; \n"+"varying vec2 varying_uv1 ; \n"+"vec4 decode_hdr( vec4 data ){ \n"+"data.w = data.w * 255.0 - 128.0 ; \n"+"data.w = pow( 2.0 ,data.w); \n"+"data.xyz *= data.w ; \n"+"return data ; \n"+"} \n"+"void main(void){ \n"+"vec4 lightmap = texture2D( lightTexture , varying_uv1 ); \n"+"lightmap.xyz = decode_hdr(lightmap).xyz ; \n"+"diffuseColor.xyz *= lightmap.xyz ; \n"+"specularColor.xyz *= lightmap.xyz ; \n"+"} \n"+"  \n",lightMap_fs:"uniform sampler2D lightTexture ; \n"+"varying vec2 varying_uv1 ; \n"+"vec4 decode_hdr( vec4 data ){ \n"+"data.w = data.w * 255.0 - 128.0 ; \n"+"data.w = pow( 2.0 ,data.w); \n"+"data.xyz *= data.w ; \n"+"return data ; \n"+"} \n"+"void main(void){ \n"+"vec4 lightmap = texture2D( lightTexture , varying_uv1 ); \n"+"lightmap.xyz = decode_hdr(lightmap).xyz  ; \n"+"diffuseColor.xyz *= lightmap.xyz ; \n"+"} \n",lineFog:"struct Fog{ \n"+"vec3 fogColor  ; \n"+"float globalDensity ; \n"+"float fogStartDistance ; \n"+"float fogFarDistance ; \n"+"float fogAlpha ; \n"+"}; \n"+"uniform float uniform_globalFog[7]; \n"+"varying vec4 varying_mvPose; \n"+"void main(void){ \n"+"Fog fog; \n"+"fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n"+"fog.globalDensity = uniform_globalFog[3]; \n"+"fog.fogStartDistance = uniform_globalFog[4] ; \n"+"fog.fogFarDistance = uniform_globalFog[5] ; \n"+"fog.fogAlpha = uniform_globalFog[6] ; \n"+"fog.fogColor *= outColor.w; \n"+"float d = varying_mvPose.z ; \n"+"float distFog = max( 0.0 , d -  fog.fogStartDistance ) ; \n"+"outColor.xyz = mix( outColor.xyz,fog.fogColor, clamp(distFog/fog.fogFarDistance,0.0,1.0) * fog.fogAlpha ) ; \n"+"} \n",matCapPass_vs:"varying vec2 capCoord ; \n"+"void main(void){ \n"+"capCoord.x = dot(normalMatrix[0].xyz,normal); \n"+"capCoord.y = dot(normalMatrix[1].xyz,normal); \n"+"capCoord = capCoord * 0.5 + 0.5; \n"+"ambientColor.xyz +=  + capCoord.xyz * 2.0 - 1.0 ; \n"+"} \n",matCap_TextureAdd_fs:"uniform sampler2D matcapTexture; \n"+"void main() { \n"+"vec4 capCoord ; \n"+"capCoord.x = -normal.x; \n"+"capCoord.y = normal.y; \n"+"capCoord.xy = capCoord.xy * 0.5 + 0.5; \n"+"capCoord = texture2D(matcapTexture , capCoord.xy ) * 2.0 - 1.0 ; \n"+"ambientColor.xyz += capCoord.xyz ; \n"+"} \n",matCap_TextureMult_fs:"uniform sampler2D matcapTexture; \n"+"void main() { \n"+"vec4 capCoord ; \n"+"capCoord.x = -normal.x; \n"+"capCoord.y = normal.y; \n"+"capCoord.xy = capCoord.xy * 0.5 + 0.5; \n"+"capCoord = texture2D(matcapTexture , capCoord.xy ) ; \n"+"diffuseColor.xyz *= capCoord.xyz * 2.0 ; \n"+"} \n",materialSource_fs:"struct MaterialSource{ \n"+"vec3 diffuse; \n"+"vec3 ambient; \n"+"vec3 specular; \n"+"float alpha; \n"+"float cutAlpha; \n"+"float shininess; \n"+"float normalDir; \n"+"vec4 uvRectangle; \n"+"float gamma; \n"+"float specularScale; \n"+"float refraction; \n"+"float refractionintensity; \n"+"}; \n"+"uniform float uniform_materialSource[20] ; \n"+"MaterialSource materialSource ; \n"+"vec2 uv_0 ; \n"+"void main(){ \n"+"materialSource.diffuse.x = uniform_materialSource[0]; \n"+"materialSource.diffuse.y = uniform_materialSource[1]; \n"+"materialSource.diffuse.z = uniform_materialSource[2]; \n"+"materialSource.ambient.x = uniform_materialSource[3]; \n"+"materialSource.ambient.y = uniform_materialSource[4]; \n"+"materialSource.ambient.z = uniform_materialSource[5]; \n"+"materialSource.specular.x = uniform_materialSource[6]; \n"+"materialSource.specular.y = uniform_materialSource[7]; \n"+"materialSource.specular.z = uniform_materialSource[8]; \n"+"materialSource.alpha = uniform_materialSource[9]; \n"+"materialSource.cutAlpha = uniform_materialSource[10]; \n"+"materialSource.shininess = uniform_materialSource[11]; \n"+"materialSource.specularScale = uniform_materialSource[12]; \n"+"materialSource.normalDir = 1.0 ; \n"+"materialSource.uvRectangle.x = uniform_materialSource[13]; \n"+"materialSource.uvRectangle.y = uniform_materialSource[14]; \n"+"materialSource.uvRectangle.z = uniform_materialSource[15]; \n"+"materialSource.uvRectangle.w = uniform_materialSource[16]; \n"+"materialSource.gamma = uniform_materialSource[17]; \n"+"materialSource.refraction = uniform_materialSource[18]; \n"+"materialSource.refractionintensity = uniform_materialSource[19]; \n"+"uv_0 = varying_uv0.xy * materialSource.uvRectangle.zw + materialSource.uvRectangle.xy ; \n"+"} \n",
MultiUVSprite_fs:"uniform vec4 multiUV ; \n"+"uniform sampler2D diffuseTexture; \n"+"vec4 diffuseColor ; \n"+"void main() { \n"+"vec2 scale = vec2(1.0/multiUV.xy) ; \n"+"float a = mod(multiUV.w , multiUV.x) ; \n"+"float b = (multiUV.w / multiUV.x) - fract(multiUV.w / multiUV.x) ; \n"+"vec2 rec = scale * vec2(a,b) + uv_0 * scale; \n"+"diffuseColor = texture2D(diffuseTexture , rec ); \n"+"if( diffuseColor.w < materialSource.cutAlpha ){ \n"+"discard; \n"+"} \n"+"} \n",mulUvRoll_fs:"uniform float mulUvRoll[4] ; \n"+"uniform sampler2D diffuseTexture; \n"+"uniform sampler2D diffuseTexture1; \n"+"vec4 diffuseColor ; \n"+"vec2 uv_1; \n"+"void main() { \n"+"uv_1 = varying_uv0; \n"+"uv_0.xy += vec2(mulUvRoll[0],mulUvRoll[1]); \n"+"uv_1.xy += vec2(mulUvRoll[2],mulUvRoll[3]); \n"+"diffuseColor = texture2D(diffuseTexture , uv_0 ) * texture2D(diffuseTexture1 , uv_1 ); \n"+"diffuseColor.xyz = clamp(diffuseColor.xyz / diffuseColor.w,0.0,1.0); \n"+"} \n",normalMap_fragment:"uniform sampler2D normalTexture; \n"+"varying vec2 varying_uv0        ; \n"+"varying vec4 varying_mvPose        ; \n"+"mat3 TBN ; \n"+"mat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) { \n"+"vec3 dp1 = dFdx(p); \n"+"vec3 dp2 = dFdy(p); \n"+"vec2 duv1 = dFdx(uv); \n"+"vec2 duv2 = dFdy(uv); \n"+"vec3 dp2perp = cross(dp2, N); \n"+"vec3 dp1perp = cross(N, dp1); \n"+"vec3 T = dp2perp * duv1.x + dp1perp * duv2.x; \n"+"vec3 B = dp2perp * duv1.y + dp1perp * duv2.y; \n"+"float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B))); \n"+"return mat3(T * invmax, B * invmax, N); \n"+"} \n"+"vec3 tbn(vec3 map, vec3 N, vec3 V, vec2 texcoord) { \n"+"mat3 TBN = cotangentFrame(N, -V, texcoord); \n"+"return normalize(TBN * map); \n"+"} \n"+"void main(){ \n"+"vec3 normalTex = texture2D(normalTexture,uv_0).xyz *2.0 - 1.0; \n"+"normalTex.y *= materialSource.normalDir; \n"+"normal.xyz = tbn( normalTex.xyz , normal.xyz , varying_mvPose.xyz , uv_0 ) ; \n"+"} \n",normalPassEnd_fs:"void main() { \n"+"outColor = vec4(normal,1.0); \n"+"} \n",outLine_fs:"uniform float uniform_ouline[5] ; \n"+"void main(){ \n"+"diffuseColor = vec4(uniform_ouline[1], \n"+"uniform_ouline[2], \n"+"uniform_ouline[3], \n"+"uniform_ouline[4]) ; \n"+"outColor = diffuseColor; \n"+"} \n",outLine_vs:"attribute vec3 attribute_normal; \n"+"attribute vec4 attribute_color; \n"+"varying vec4 varying_mvPose; \n"+"uniform float uniform_ouline[5] ; \n"+"void main(void){ \n"+"outPosition.xy -= normalize(varying_eyeNormal.xyz).xy * uniform_ouline[0]; \n"+"} \n",out_fs:"void main(){ \n"+"gl_FragColor = outColor; \n"+"} \n",out_vs:"void main(){ \n"+"gl_Position = outPosition ; \n"+"} \n",particle_bezier:"float calcBezierArea(float bzData[35], float tCurrent, float tTotal){ \n"+"float res = 0.0; \n"+"float v0; \n"+"float v1; \n"+"float t0; \n"+"float t1; \n"+"float deltaTime = 0.0; \n"+"float a_deltaTime; \n"+"for(int i = 0; i < 16; i ++) \n"+"{ \n"+"t0 = bzData[i * 2 + 0] * tTotal; \n"+"v0 = bzData[i * 2 + 1]; \n"+"t1 = bzData[i * 2 + 2] * tTotal; \n"+"v1 = bzData[i * 2 + 3]; \n"+"deltaTime = t1 - t0; \n"+"a_deltaTime = 0.5 * (v1 - v0); \n"+"if(tCurrent >= t1) \n"+"{ \n"+"res += deltaTime * (v0 + a_deltaTime); \n"+"}else \n"+"{ \n"+"deltaTime = tCurrent - t0; \n"+"res += deltaTime * (v0 + a_deltaTime); \n"+"break; \n"+"} \n"+"} \n"+"return res; \n"+"} \n"+"float calcBezierSize(float bzData[35], float tCurrent, float tTotal){ \n"+"float res = 0.0; \n"+"float y0; \n"+"float y1; \n"+"float t0; \n"+"float t1; \n"+"float deltaTime = 0.0; \n"+"float v; \n"+"for(int i = 0; i < 16; i ++) \n"+"{ \n"+"t0 = bzData[i * 2 + 0] * tTotal; \n"+"y0 = bzData[i * 2 + 1]; \n"+"t1 = bzData[i * 2 + 2] * tTotal; \n"+"y1 = bzData[i * 2 + 3]; \n"+"deltaTime = t1 - t0; \n"+"if(tCurrent <= t1) \n"+"{ \n"+"v = (y1 - y0) / deltaTime; \n"+"deltaTime = tCurrent - t0; \n"+"res = y0 + v * deltaTime; \n"+"break; \n"+"} \n"+"} \n"+"return res; \n"+"} \n",particle_color_fs:"uniform float uniform_colorTransform[40]; \n"+"vec3 unpack_color(float rgb_data) \n"+"{ \n"+"vec3 res; \n"+"res.z = fract( rgb_data ); \n"+"rgb_data -= res.z; \n"+"rgb_data = rgb_data/256.0; \n"+"res.y = fract( rgb_data ); \n"+"rgb_data -= res.y; \n"+"res.x = rgb_data/256.0; \n"+"return res; \n"+"} \n"+"void main() { \n"+"float startColor ; \n"+"float startSegment ; \n"+"float nextColor ; \n"+"float nextSegment ; \n"+"float startAlpha; \n"+"float nextAlpha; \n"+"float progress = varying_particleData.x/varying_particleData.y; \n"+"const int maxColorCount = 20; \n"+"for( int i = 1 ; i < maxColorCount ; i++ ){ \n"+"if( progress >= fract(uniform_colorTransform[i+maxColorCount-1]) ){ \n"+"startColor = uniform_colorTransform[i-1] ; \n"+"startSegment = fract(uniform_colorTransform[i+maxColorCount-1]) ; \n"+"nextColor = uniform_colorTransform[i]; \n"+"nextSegment = fract(uniform_colorTransform[i+maxColorCount]) ; \n"+"startAlpha = uniform_colorTransform[i+maxColorCount-1] - startSegment; \n"+"nextAlpha = uniform_colorTransform[i+maxColorCount] - nextSegment; \n"+"}else{ \n"+"break; \n"+"} \n"+"} \n"+"float len = nextSegment - startSegment ; \n"+"float ws = ( progress - startSegment ) / len ; \n"+"globalColor = mix(vec4(unpack_color(startColor).xyz,startAlpha / 256.0),vec4(unpack_color(nextColor).xyz, nextAlpha / 256.0),ws) ; \n"+"globalColor.w = clamp(globalColor.w,0.0,1.0); \n"+"} \n"+"//##FilterEnd## \n",particle_color_vs:"void getNodeData(){ \n"+"} \n"+"//##FilterEnd## \n",particle_diffuse_fragment:"uniform sampler2D diffuseTexture; \n"+"vec4 diffuseColor ; \n"+"vec4 globalColor = vec4(1.0, 1.0, 1.0, 1.0); \n"+"void calcUVCoord(){ \n"+"} \n"+"void main() { \n"+"if( diffuseColor.w == 0.0 ){ \n"+"discard; \n"+"} \n"+"calcUVCoord(); \n"+"diffuseColor = texture2D(diffuseTexture , uv_0 ); \n"+"if( diffuseColor.w < materialSource.cutAlpha ){ \n"+"discard; \n"+"} \n"+"} \n",particle_end_fs:"varying vec4 varying_particleData; \n"+"void main() { \n"+"materialSource.diffuse *= globalColor.xyz; \n"+"outColor.xyz = (light.xyz+materialSource.ambient) * (diffuseColor.xyz * materialSource.diffuse * varying_color.xyz) + specularColor.xyz ; \n"+"outColor.w = materialSource.alpha * diffuseColor.w * varying_color.w; \n"+"outColor.w *= globalColor.w; \n"+"if(varying_particleData.w > 0.5){ \n"+"outColor.xyz *= outColor.w; \n"+"} \n"+"outColor = clamp(outColor, 0.0, 1.0); \n"+"} \n",particle_end_vs:"varying vec4 varying_pos; \n"+"mat4 buildModelMatrix(vec4 quat, vec3 scale, vec3 position) \n"+"{ \n"+"mat4 ret = mat4( \n"+"vec4(scale.x, 0.0, 0.0, 0.0), \n"+"vec4(0.0, scale.y, 0.0, 0.0), \n"+"vec4(0.0, 0.0, scale.z, 0.0), \n"+"vec4(0.0, 0.0, 0.0, 1.0) \n"+"); \n"+"ret = buildMat4Quat(quat) * ret; \n"+"ret[3][0] = position.x; \n"+"ret[3][1] = position.y; \n"+"ret[3][2] = position.z; \n"+"return ret; \n"+"} \n"+"vec3 calcParticleMove(vec3 distanceXYZ){ \n"+"if(velocityLimitVec2.y > TrueOrFalse){ \n"+"vec3 temp = distanceXYZ * distanceXYZ; \n"+"float distanceCurrent = sqrt(temp.x + temp.y + temp.z); \n"+"float distanceLimit = velocityLimitVec2.x; \n"+"if(distanceLimit < Tiny){ \n"+"return vec3(0.0); \n"+"} \n"+"if(distanceCurrent > distanceLimit){ \n"+"float nowFrame = currentTime / 0.017; \n"+"float dampen = 1.0 - particleStateData.velocityLimitDampen; \n"+"float startDistance = (distanceCurrent - distanceLimit) / nowFrame; \n"+"float distanceResult = 0.0; \n"+"float tempDistance = startDistance; \n"+"for(int i = 1; i < 600; i++){ \n"+"distanceResult += tempDistance; \n"+"tempDistance *= dampen; \n"+"if(float(i) > nowFrame) \n"+"break; \n"+"} \n"+"distanceXYZ *= (distanceResult + distanceLimit) / distanceCurrent; \n"+"} \n"+"} \n"+"return distanceXYZ; \n"+"} \n"+"bool updateStretchedBillBoard(vec3 moveVector){ \n"+"return true; \n"+"} \n"+"void main(void) { \n"+"vec3 position_emitter = attribute_offsetPosition; \n"+"vec3 velocityLocalVec3 = velocityBaseVec3 * currentTime; \n"+"vec3 velocityWorldVec3 = vec3(0.0,0.0,0.0); \n"+"vec3 velocityMultiVec3 = vec3(0.0,0.0,0.0); \n"+"if(particleStateData.velocityOverWorldSpace < TrueOrFalse){ \n"+"velocityLocalVec3 += velocityOverVec3; \n"+"}else{ \n"+"velocityWorldVec3 += velocityOverVec3; \n"+"} \n"+"if(particleStateData.velocityForceWorldSpace < TrueOrFalse){ \n"+"velocityLocalVec3 += velocityForceVec3; \n"+"}else{ \n"+"velocityWorldVec3 += velocityForceVec3; \n"+"} \n"+"position_emitter *= vec3(particleStateData.scaleX, particleStateData.scaleY, particleStateData.scaleZ); \n"+"if(particleStateData.worldSpace > TrueOrFalse){ \n"+"}else{ \n"+"followTargetPosition.x = particleStateData.positionX; \n"+"followTargetPosition.y = particleStateData.positionY; \n"+"followTargetPosition.z = particleStateData.positionZ; \n"+"followTargetRotation.x = particleStateData.rotationX; \n"+"followTargetRotation.y = particleStateData.rotationY; \n"+"followTargetRotation.z = particleStateData.rotationZ; \n"+"followTargetRotation.w = particleStateData.rotationW; \n"+"} \n"+"mat4 followRotQuat = buildMat4Quat(followTargetRotation); \n"+"velocityLocalVec3 = (followRotQuat * vec4(velocityLocalVec3, 1.0)).xyz; \n"+"if(particleStateData.renderMode == Mesh){ \n"+"rotVertexMatrix = followRotQuat * rotVertexMatrix; \n"+"} \n"+"localPosition.xyz *= scaleSize; \n"+"localPosition = rotVertexMatrix * localPosition; \n"+"trackPosition(); \n"+"mat4 modelMatrix = buildModelMatrix(followTargetRotation, followTargetScale, followTargetPosition); \n"+"position_emitter = (modelMatrix * vec4(position_emitter, 1.0)).xyz; \n"+"velocityMultiVec3 = velocityLocalVec3 + velocityWorldVec3; \n"+"velocityMultiVec3 = calcParticleMove(velocityMultiVec3); \n"+"velocityMultiVec3.y -= 4.9 * currentTime * currentTime * particleStateData.gravity; \n"+"position_emitter += velocityMultiVec3; \n"+"if(particleStateData.renderMode == StretchedBillboard){ \n"+"discard_particle = discard_particle || updateStretchedBillBoard(velocityMultiVec3) == false; \n"+"outPosition = localPosition; \n"+"rotVertexMatrix = rotVertexMatrix * uniform_billboardMatrix; \n"+"}else{ \n"+"outPosition = uniform_billboardMatrix * localPosition; \n"+"} \n"+"if(discard_particle){ \n"+"outPosition = vec4(0.0,0.0,0.0,0.0); \n"+"}else{ \n"+"outPosition.xyz += position_emitter.xyz; \n"+"outPosition = uniform_ViewMatrix * outPosition; \n"+"e_normal.xyz = (rotVertexMatrix * vec4(e_normal, 1.0)).xyz; \n"+"e_normal = normalize(e_normal); \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * modelMatrix); \n"+"varying_mvPose = outPosition; \n"+"mat4 normalMatrix = inverse(mvMatrix) ; \n"+"normalMatrix = transpose(normalMatrix); \n"+"varying_eyeNormal = mat3(normalMatrix) * - e_normal; \n"+"} \n"+"varying_pos = outPosition = uniform_ProjectionMatrix * outPosition; \n"+"} \n"+"//##FilterEnd## \n",particle_follow_vs:"attribute vec3 attribute_followPosition ; \n"+"attribute vec4 attribute_followRotation ; \n"+"attribute vec3 attribute_followScale; \n"+"void getNodeData(){ \n"+"followTargetPosition = attribute_followPosition; \n"+"followTargetRotation = attribute_followRotation; \n"+"} \n"+"//##FilterEnd## \n",particle_rotationConst:"attribute float attribute_rotationZ ; \n"+"void getUnitRotate(){ \n"+"rotResultVec3.z = currentTime * attribute_rotationZ; \n"+"} \n",particle_rotationOneBezier:"uniform float uniform_rotationBezier[35]; \n"+"void getUnitRotate(){ \n"+"float rot = calcBezierArea(uniform_rotationBezier, currentTime, curParticle.life); \n"+"rotResultVec3.z = rot; \n"+"} \n",particle_rotationTwoBezier:"attribute float attribute_rotationRandomSeed; \n"+"uniform float uniform_rotationBezier[35]; \n"+"uniform float uniform_rotationBezier2[35]; \n"+"void getUnitRotate(){ \n"+"vec2 rotationTwoBezier = vec2(0.0); \n"+"rotationTwoBezier.x = calcBezierArea(uniform_rotationBezier, currentTime, curParticle.life); \n"+"rotationTwoBezier.y = calcBezierArea(uniform_rotationBezier2, currentTime, curParticle.life); \n"+"float rot = mix(rotationTwoBezier.x, rotationTwoBezier.y, attribute_rotationRandomSeed); \n"+"rotResultVec3.z = rot; \n"+"} \n",particle_rotationXYZConst:"attribute vec3 attribute_rotSpeedXYZ ; \n"+"attribute vec3 attribute_rotBirthXYZ ; \n"+"void getUnitRotate(){ \n"+"rotResultVec3 = (attribute_rotBirthXYZ + particleStateData.time * attribute_rotSpeedXYZ); \n"+"rotResultVec3 = mod(rotResultVec3, 360.0); \n"+"} \n",particle_scaleSizeBezier1:"uniform float uniform_scaleSizeBezier1[35]; \n"+"void main() { \n"+"scaleSize *= calcBezierSize(uniform_scaleSizeBezier1, currentTime, curParticle.life); \n"+"} \n",particle_scaleSizeBezier2:"attribute float attribute_bezierRandomSeed; \n"+"uniform float uniform_scaleSizeBezier1[35]; \n"+"uniform float uniform_scaleSizeBezier2[35]; \n"+"void main() { \n"+"vec2 scaleVec2 = vec2(0.0); \n"+"scaleVec2.x = calcBezierArea(uniform_scaleSizeBezier1, currentTime, curParticle.life); \n"+"scaleVec2.y = calcBezierArea(uniform_scaleSizeBezier2, currentTime, curParticle.life); \n"+"scaleSize * = mix(scaleVec2.x, scaleVec2.y, attribute_bezierRandomSeed); \n"+"} \n",particle_scaleSizeConst:"attribute float attribute_scaleSizeConst; \n"+"void main() { \n"+"scaleSize *= attribute_scaleSizeConst; \n"+"} \n"+"//##FilterEnd## \n",particle_stretched_mode:"bool updateStretchedBillBoard(vec3 moveVector){ \n"+"if(currentTime < 0.016){ \n"+"return false; \n"+"} \n"+"float speed = dot(moveVector, moveVector); \n"+"speed = sqrt(speed) / currentTime; \n"+"speed /= 100.0; \n"+"if(speed < Tiny){ \n"+"return false; \n"+"} \n"+"localPosition.y = localPosition.y * particleStateData.lengthScale + speed * particleStateData.speedScale * localPosition.y / scaleSize; \n"+"vec3 dir1 = vec3(0.0, 1.0, 0.0); \n"+"vec3 dir2 = normalize(moveVector); \n"+"vec3 axis = normalize(cross(dir1, dir2)); \n"+"float angle = acos(dot(dir1, dir2)); \n"+"vec4 quat = vec4(0.0, 0.0, 0.0, 1.0); \n"+"float halfAngle = angle * 0.5; \n"+"float sin_a = sin(halfAngle); \n"+"quat.w = cos(halfAngle); \n"+"quat.x = axis.x * sin_a; \n"+"quat.y = axis.y * sin_a; \n"+"quat.z = axis.z * sin_a; \n"+"quat = normalize(quat); \n"+"localPosition = uniform_billboardMatrix * localPosition; \n"+"rotVertexMatrix = buildMat4Quat(quat); \n"+"localPosition = rotVertexMatrix * localPosition; \n"+"return true; \n"+"} \n",particle_textureSheetConst:"varying vec3 varying_textureSheetData; \n"+"uniform float uniform_textureSheet[5]; \n"+"vec2 getSheetOffset(float frame, float tileX, float tileY) \n"+"{ \n"+"frame = floor(frame); \n"+"vec2 ret = vec2(0.0); \n"+"ret.x = (1.0 / tileX) * mod(frame, tileX); \n"+"ret.y = frame / tileX; \n"+"ret.y = floor(ret.y); \n"+"ret.y = (1.0 / tileY) * ret.y; \n"+"return ret; \n"+"} \n"+"void calcUVCoord() { \n"+"vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]); \n"+"uv_0.xy *= rectUV; \n"+"float frame = varying_textureSheetData.x + varying_textureSheetData.y; \n"+"frame = clamp(frame, uniform_textureSheet[3], uniform_textureSheet[4]); \n"+"uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]); \n"+"} \n",particle_textureSheetOneBezier:"varying vec3 varying_textureSheetData; \n"+"uniform float uniform_textureSheet[5]; \n"+"uniform float uniform_frameBezier[35]; \n"+"vec2 getSheetOffset(float frame, float tileX, float tileY) \n"+"{ \n"+"frame = floor(frame); \n"+"vec2 ret = vec2(0.0); \n"+"ret.x = (1.0 / tileX) * mod(frame, tileX); \n"+"ret.y = frame / tileX; \n"+"ret.y = floor(ret.y); \n"+"ret.y = (1.0 / tileY) * ret.y; \n"+"return ret; \n"+"} \n"+"void calcUVCoord() { \n"+"vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]); \n"+"uv_0.xy *= rectUV; \n"+"float frame = varying_textureSheetData.x + varying_textureSheetData.y; \n"+"float currentTime = varying_particleData.x * uniform_textureSheet[2]; \n"+"currentTime = mod(currentTime, varying_particleData.y); \n"+"float bezierFrame = calcBezierSize(uniform_frameBezier, currentTime, varying_particleData.y); \n"+"bezierFrame = clamp(bezierFrame, uniform_textureSheet[3], uniform_textureSheet[4]); \n"+"frame += bezierFrame; \n"+"uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]); \n"+"} \n",particle_textureSheetTwoBezier:"varying vec3 varying_textureSheetData; \n"+"uniform float uniform_textureSheet[5]; \n"+"uniform float uniform_frameBezier1[35]; \n"+"uniform float uniform_frameBezier2[35]; \n"+"vec2 getSheetOffset(float frame, float tileX, float tileY) \n"+"{ \n"+"frame = floor(frame); \n"+"vec2 ret = vec2(0.0); \n"+"ret.x = (1.0 / tileX) * mod(frame, tileX); \n"+"ret.y = frame / tileX; \n"+"ret.y = floor(ret.y); \n"+"ret.y = (1.0 / tileY) * ret.y; \n"+"return ret; \n"+"} \n"+"void calcUVCoord() { \n"+"vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]); \n"+"uv_0.xy *= rectUV; \n"+"float frame = varying_textureSheetData.x + varying_textureSheetData.y; \n"+"float currentTime = varying_particleData.x * uniform_textureSheet[2]; \n"+"currentTime = mod(currentTime, varying_particleData.y); \n"+"float b1 = calcBezierSize(uniform_frameBezier1, currentTime2, varying_particleData.y); \n"+"float b2 = calcBezierSize(uniform_frameBezier2, currentTime2, varying_particleData.y); \n"+"float bezierFrame = mix(b1, b2, varying_particleData.z); \n"+"bezierFrame = clamp(bezierFrame, uniform_textureSheet[3], uniform_textureSheet[4]); \n"+"frame += bezierFrame; \n"+"uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]); \n"+"} \n",particle_textureSheet_vs:"attribute vec3 attribute_textureSheetData; \n"+"varying vec3 varying_textureSheetData; \n"+"void getNodeData(){ \n"+"varying_textureSheetData = attribute_textureSheetData; \n"+"} \n",particle_trackPosition:"attribute vec3 attribute_trackPosition; \n"+"void calcCubicPos(float time, float totalTime, vec3 fromPos, vec3 endPos){ \n"+"vec3 distanceVec3 = endPos - fromPos; \n"+"float distanceFloat = dot(distanceVec3, distanceVec3); \n"+"distanceFloat = sqrt(distanceFloat); \n"+"float t = time / totalTime; \n"+"t = easeInOut(t); \n"+"vec3 centerPos = distanceVec3 * 0.5 + fromPos; \n"+"vec3 zeroPos = vec3(0.0, distanceFloat * 0.05, 0.0); \n"+"zeroPos = mix(centerPos, zeroPos, 0.6); \n"+"vec3 bezier1 = mix(fromPos, zeroPos, t); \n"+"vec3 bezier2 = mix(zeroPos, endPos, t); \n"+"vec3 bezier3 = mix(bezier1, bezier2, t); \n"+"cubicPos = bezier3 - fromPos; \n"+"t = clamp(time / totalTime, 0.0, 1.0); \n"+"if(t > 0.8){ \n"+"t = (1.0 - t) * 5.0; \n"+"}else if(t > 0.2){ \n"+"t = 1.0; \n"+"}else{ \n"+"t *= 5.0; \n"+"} \n"+"t = 0.5 * (1.0 - cos(t * PI)); \n"+"vec4 nrmVec4 = rotVertexMatrix * vec4(attribute_normal, 1.0); \n"+"vec3 nrmPos = normalize(nrmVec4.xyz); \n"+"nrmPos = nrmPos * t * distanceFloat * 0.04; \n"+"t = clamp(time / totalTime, 0.0, 1.0); \n"+"float heightOffset = 0.0; \n"+"heightOffset = sin(t * 3.0 * PI) * distanceFloat * 0.2 * sqrt(t * (1.0 - t)); \n"+"cubicPos += nrmPos; \n"+"cubicPos.y += heightOffset; \n"+"} \n"+"void trackPosition(){ \n"+"calcCubicPos(currentTime - 0.017, curParticle.life, attribute_offsetPosition, attribute_trackPosition); \n"+"vec3 lastOffset = cubicPos; \n"+"calcCubicPos(currentTime, curParticle.life, attribute_offsetPosition, attribute_trackPosition); \n"+"vec3 curOffset = cubicPos; \n"+"vec3 trackVec3 = curOffset - lastOffset; \n"+"trackVec3 = normalize(trackVec3); \n"+"float ratio = dot(localPosition.xyz, trackVec3); \n"+"float t = clamp(currentTime / curParticle.life, 0.0, 1.0); \n"+"t = 0.5 * (1.0 - cos(t * PI * 2.0)); \n"+"t = sqrt(t); \n"+"float speed = sqrt(dot(curOffset - lastOffset, curOffset - lastOffset)); \n"+"trackVec3 *= speed * 2.0 * t; \n"+"localPosition.xyz += ratio * trackVec3; \n"+"localPosition.xyz += curOffset; \n"+"} \n",particle_uv_roll_fs:"uniform float uniform_particleUVRoll[2]; \n"+"void calcUVCoord() { \n"+"uv_0.xy += vec2(varying_particleData.x * uniform_particleUVRoll[0], varying_particleData.x * uniform_particleUVRoll[1]); \n"+"} \n",particle_velocity:"attribute vec3 attribute_velocity; \n"+"void getNodeData(){ \n"+"velocityBaseVec3 = attribute_velocity; \n"+"} \n",particle_velocityForceConst:"attribute vec3 attribute_velocityForceConst ; \n"+"void getNodeData(){ \n"+"velocityForceVec3 = 0.5 * attribute_velocityForceConst * currentTime * currentTime; \n"+"} \n",particle_velocityForceOneBezier:"vec3 velocityForceOneBezier = vec3(0.0); \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"} \n"+"void main() { \n"+"velocityForceVec3.xyz = velocityForceOneBezier.xyz; \n"+"calcVelocityForceBezier(currentTime, curParticle.life); \n"+"} \n",particle_velocityForceOneBezierX:"uniform float uniform_velocityForceX[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceOneBezier.x = calcBezierArea(uniform_velocityForceX, curTime, totalTime); \n"+"} \n",particle_velocityForceOneBezierY:"uniform float uniform_velocityForceY[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceOneBezier.y = calcBezierArea(uniform_velocityForceY, curTime, totalTime); \n"+"} \n",particle_velocityForceOneBezierZ:"uniform float uniform_velocityForceZ[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceOneBezier.z = calcBezierArea(uniform_velocityForceZ, curTime, totalTime); \n"+"} \n",particle_velocityForceTwoBezier:"attribute float attribute_velocityForceRandomSeed; \n"+"vec3 velocityForceTwoBezier1 = vec3(0.0); \n"+"vec3 velocityForceTwoBezier2 = vec3(0.0); \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"} \n"+"void main() { \n"+"calcVelocityForceBezier(currentTime, curParticle.life); \n"+"velocityForceVec3.x = mix(velocityForceTwoBezier1.x, velocityForceTwoBezier2.x, attribute_velocityForceRandomSeed); \n"+"velocityForceVec3.y = mix(velocityForceTwoBezier1.y, velocityForceTwoBezier2.y, attribute_velocityForceRandomSeed); \n"+"velocityForceVec3.z = mix(velocityForceTwoBezier1.z, velocityForceTwoBezier2.z, attribute_velocityForceRandomSeed); \n"+"} \n",particle_velocityForceTwoBezierX1:"uniform float uniform_velocityForceX1[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceTwoBezier1.x = calcBezierArea(uniform_velocityForceX1, curTime, totalTime); \n"+"} \n",particle_velocityForceTwoBezierX2:"uniform float uniform_velocityForceX2[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceTwoBezier2.x = calcBezierArea(uniform_velocityForceX2, curTime, totalTime); \n"+"} \n",particle_velocityForceTwoBezierY1:"uniform float uniform_velocityForceY1[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceTwoBezier1.y = calcBezierArea(uniform_velocityForceY1, curTime, totalTime); \n"+"} \n",particle_velocityForceTwoBezierY2:"uniform float uniform_velocityForceY2[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceTwoBezier2.y = calcBezierArea(uniform_velocityForceY2, curTime, totalTime); \n"+"} \n",particle_velocityForceTwoBezierZ1:"uniform float uniform_velocityForceZ1[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceTwoBezier1.z = calcBezierArea(uniform_velocityForceZ1, curTime, totalTime); \n"+"} \n",particle_velocityForceTwoBezierZ2:"uniform float uniform_velocityForceZ2[35]; \n"+"void calcVelocityForceBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityForceTwoBezier2.z = calcBezierArea(uniform_velocityForceZ2, curTime, totalTime); \n"+"} \n",particle_velocityLimitConst:"attribute float attribute_velocityLimit; \n"+"void getNodeData(){ \n"+"velocityLimitVec2.x = attribute_velocityLimit * currentTime; \n"+"if(velocityLimitVec2.x < 0.0){ \n"+"velocityLimitVec2.x = 0.0; \n"+"} \n"+"velocityLimitVec2.y = 1.0; \n"+"} \n",particle_velocityLimitOneBezier:"uniform float uniform_velocityLimit[35]; \n"+"void main() { \n"+"velocityLimitVec2.x = calcBezierArea(uniform_velocityLimit, currentTime, curParticle.life); \n"+"velocityLimitVec2.y = 1.0; \n"+"} \n",particle_velocityLimitTwoBezier:"uniform float uniform_velocityLimit[35]; \n"+"uniform float uniform_velocityLimit2[35]; \n"+"attribute float attribute_velocityLimitRandomSeed; \n"+"void main() { \n"+"float velocity2Limit1 = calcBezierArea(uniform_velocityLimit, currentTime, curParticle.life); \n"+"float velocity2Limit2 = calcBezierArea(uniform_velocityLimit2, currentTime, curParticle.life); \n"+"velocityLimitVec2.x = mix(velocity2Limit1, velocity2Limit1, attribute_velocityLimitRandomSeed); \n"+"if(velocityLimitVec2.x < 0.0){ \n"+"velocityLimitVec2.x = 0.0; \n"+"} \n"+"velocityLimitVec2.y = 1.0; \n"+"} \n",particle_velocityOverConst:"attribute vec3 attribute_velocityOverConst; \n"+"void getNodeData(){ \n"+"velocityOverVec3 = attribute_velocityOverConst * currentTime; \n"+"} \n",particle_velocityOverOneBezier:"vec3 velocityTwoBezier = vec3(0.0); \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"} \n"+"void main() { \n"+"calcVelocityOverBezier(currentTime, curParticle.life); \n"+"velocityOverVec3.xyz = velocityTwoBezier.xyz; \n"+"} \n",particle_velocityOverOneBezierX:"uniform float uniform_velocityOverX[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityTwoBezier.x = calcBezierArea(uniform_velocityOverX, curTime, totalTime); \n"+"} \n",particle_velocityOverOneBezierY:"uniform float uniform_velocityOverY[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityTwoBezier.y = calcBezierArea(uniform_velocityOverY, curTime, totalTime); \n"+"} \n",particle_velocityOverOneBezierZ:"uniform float uniform_velocityOverZ[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityTwoBezier.z = calcBezierArea(uniform_velocityOverZ, curTime, totalTime); \n"+"} \n",particle_velocityOverTwoBezier:"attribute float attribute_velocityOverRandomSeed; \n"+"vec3 velocityOverTwoBezier1 = vec3(0.0); \n"+"vec3 velocityOverTwoBezier2 = vec3(0.0); \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"} \n"+"void main() { \n"+"calcVelocityOverBezier(currentTime, curParticle.life); \n"+"velocityOverVec3.x = mix(velocityOverTwoBezier1.x, velocityOverTwoBezier2.x, attribute_velocityOverRandomSeed); \n"+"velocityOverVec3.y = mix(velocityOverTwoBezier1.y, velocityOverTwoBezier2.y, attribute_velocityOverRandomSeed); \n"+"velocityOverVec3.z = mix(velocityOverTwoBezier1.z, velocityOverTwoBezier2.z, attribute_velocityOverRandomSeed); \n"+"} \n",particle_velocityOverTwoBezierX1:"uniform float uniform_velocityOverX1[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityOverTwoBezier1.x = calcBezierArea(uniform_velocityOverX1, curTime, totalTime); \n"+"} \n",particle_velocityOverTwoBezierX2:"uniform float uniform_velocityOverX2[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityOverTwoBezier2.x = calcBezierArea(uniform_velocityOverX2, curTime, totalTime); \n"+"} \n",particle_velocityOverTwoBezierY1:"uniform float uniform_velocityOverY1[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityOverTwoBezier1.y = calcBezierArea(uniform_velocityOverY1, curTime, totalTime); \n"+"} \n",particle_velocityOverTwoBezierY2:"uniform float uniform_velocityOverY2[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityOverTwoBezier2.y = calcBezierArea(uniform_velocityOverY2, curTime, totalTime); \n"+"} \n",particle_velocityOverTwoBezierZ1:"uniform float uniform_velocityOverZ1[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityOverTwoBezier1.z = calcBezierArea(uniform_velocityOverZ1, curTime, totalTime); \n"+"} \n",particle_velocityOverTwoBezierZ2:"uniform float uniform_velocityOverZ2[35]; \n"+"void calcVelocityOverBezier(float curTime, float totalTime) \n"+"{ \n"+"velocityOverTwoBezier2.z = calcBezierArea(uniform_velocityOverZ2, curTime, totalTime); \n"+"} \n",particle_vs:"float currentTime = 0.0; \n"+"float totalTime = 0.0; \n"+"bool discard_particle = true; \n"+"const float PI = 3.1415926; \n"+"const float TrueOrFalse = 0.5; \n"+"const float Tiny = 0.0001; \n"+"varying vec4 varying_particleData; \n"+"varying vec4 varying_mvPose; \n"+"attribute vec3 attribute_time; \n"+"attribute vec4 attribute_color; \n"+"attribute vec3 attribute_offsetPosition; \n"+"attribute float attribute_rotationBirth; \n"+"uniform mat4 uniform_cameraMatrix; \n"+"uniform mat4 uniform_billboardMatrix; \n"+"uniform mat4 uniform_ViewMatrix; \n"+"uniform float uniform_particleState[27]; \n"+"vec3 cubicPos = vec3(1.0,1.0,1.0); \n"+"vec3 rotResultVec3 = vec3(0.0); \n"+"vec4 localPosition = vec4(0.0,0.0,0.0,1.0); \n"+"vec3 velocityBaseVec3 = vec3(0.0,0.0,0.0); \n"+"vec3 velocityOverVec3 = vec3(0.0,0.0,0.0); \n"+"vec3 velocityForceVec3 = vec3(0.0,0.0,0.0); \n"+"vec2 velocityBezierWeightVec2 = vec2(1.0, 1.0); \n"+"vec2 velocityLimitVec2 = vec2(0.0,0.0); \n"+"vec3 followTargetPosition = vec3(0.0,0.0,0.0); \n"+"vec3 followTargetScale = vec3(1.0,1.0,1.0); \n"+"vec4 followTargetRotation = vec4(0.0,0.0,0.0,0.0); \n"+"float scaleSize = 1.0; \n"+"const float Billboard\t\t\t\t= 0.0; \n"+"const float StretchedBillboard\t\t= 1.0; \n"+"const float HorizontalBillboard\t\t= 2.0; \n"+"const float VerticalBillboard\t\t= 3.0; \n"+"const float Mesh\t\t\t\t\t= 4.0; \n"+"struct ParticleData{ \n"+"float bornTime; \n"+"float life; \n"+"float index; \n"+"}; \n"+"ParticleData curParticle; \n"+"struct ParticleStateData{ \n"+"float time; \n"+"float loop; \n"+"float worldSpace; \n"+"float scaleX; \n"+"float scaleY; \n"+"float scaleZ; \n"+"float rotationX; \n"+"float rotationY; \n"+"float rotationZ; \n"+"float rotationW; \n"+"float positionX; \n"+"float positionY; \n"+"float positionZ; \n"+"float loopTime; \n"+"float delay; \n"+"float duration; \n"+"float gravity; \n"+"float velocityOverWorldSpace; \n"+"float velocityForceWorldSpace; \n"+"float velocityLimitDampen; \n"+"float cameraScale; \n"+"float speedScale; \n"+"float lengthScale; \n"+"float renderMode; \n"+"float stayAtEnd; \n"+"float blendMode; \n"+"float shapeType; \n"+"}; \n"+"ParticleStateData particleStateData; \n"+"mat4 buildRotMat4(vec3 rot) \n"+"{ \n"+"float s; \n"+"float c; \n"+"s = sin(rot.x); \n"+"c = cos(rot.x); \n"+"mat4 ret = mat4( \n"+"vec4(1.0, 0.0, 0.0, 0.0), \n"+"vec4(0.0, c, s, 0.0), \n"+"vec4(0.0, -s, c, 0.0), \n"+"vec4(0.0, 0.0, 0.0, 1.0) \n"+"); \n"+"s = sin(rot.y); \n"+"c = cos(rot.y); \n"+"ret = mat4( \n"+"vec4(c, 0.0, -s, 0.0), \n"+"vec4(0.0, 1.0, 0.0, 0.0), \n"+"vec4(s, 0.0, c, 0.0), \n"+"vec4(0.0, 0.0, 0.0, 1.0) \n"+") * ret; \n"+"s = sin(rot.z); \n"+"c = cos(rot.z); \n"+"ret = mat4( \n"+"vec4(c, s, 0.0, 0.0), \n"+"vec4(-s, c, 0.0, 0.0), \n"+"vec4(0.0, 0.0, 1.0, 0.0), \n"+"vec4(0.0, 0.0, 0.0, 1.0) \n"+") * ret; \n"+"return ret; \n"+"} \n"+"mat4 buildMat4Quat(vec4 quat) \n"+"{ \n"+"float xx = quat.x * quat.x; \n"+"float xy = quat.x * quat.y; \n"+"float xz = quat.x * quat.z; \n"+"float xw = quat.x * quat.w; \n"+"float yy = quat.y * quat.y; \n"+"float yz = quat.y * quat.z; \n"+"float yw = quat.y * quat.w; \n"+"float zz = quat.z * quat.z; \n"+"float zw = quat.z * quat.w; \n"+"return mat4( \n"+"1.0 - 2.0 * (yy + zz),\t\t2.0 * (xy + zw),\t\t2.0 * (xz - yw),\t\t0, \n"+"2.0 * (xy - zw),\t\t\t\t1.0 - 2.0 * (xx + zz),\t2.0 * (yz + xw),\t\t0, \n"+"2.0 * (xz + yw),\t\t\t\t2.0 * (yz - xw),\t\t1.0 - 2.0 * (xx + yy),\t0, \n"+"0.0,\t\t\t\t\t\t\t0.0,\t\t\t\t\t0.0,\t\t\t\t\t1 \n"+"); \n"+"} \n"+"float easeInOut(float t) \n"+"{ \n"+"t = clamp(t, 0.0, 1.0); \n"+"float p0; \n"+"float p1; \n"+"float p2; \n"+"if(t <= 0.5){ \n"+"p0 = 0.0; \n"+"p1 = 0.0; \n"+"p2 = 0.5; \n"+"}else{ \n"+"p0 = 0.5; \n"+"p1 = 1.0; \n"+"p2 = 1.0; \n"+"t -= 0.5; \n"+"} \n"+"t *= 2.0; \n"+"p0 = mix(p0, p1, t); \n"+"p1 = mix(p1, p2, t); \n"+"p0 = mix(p0, p1, t); \n"+"return p0; \n"+"} \n"+"void calcParticleTime() \n"+"{ \n"+"discard_particle = true; \n"+"curParticle.bornTime = attribute_time.x; \n"+"curParticle.life = attribute_time.y; \n"+"curParticle.index = attribute_time.z; \n"+"float time = particleStateData.time - particleStateData.delay; \n"+"currentTime = time - curParticle.bornTime; \n"+"if(currentTime <= 0.0){ \n"+"return; \n"+"} \n"+"if(particleStateData.stayAtEnd > TrueOrFalse){ \n"+"if(currentTime >= curParticle.life){ \n"+"currentTime = curParticle.life * 0.99999; \n"+"} \n"+"} \n"+"if(particleStateData.loop < TrueOrFalse){ \n"+"if(curParticle.bornTime >= particleStateData.duration){ \n"+"return; \n"+"} \n"+"if(currentTime >= curParticle.life){ \n"+"return; \n"+"} \n"+"} \n"+"currentTime = mod(currentTime, particleStateData.loopTime); \n"+"if(currentTime > curParticle.life || currentTime <= 0.0){ \n"+"return; \n"+"} \n"+"discard_particle = false; \n"+"} \n"+"void calcCubicPos(float time, float totalTime, vec3 fromPos, vec3 endPos) \n"+"{ \n"+"} \n"+"void trackPosition() \n"+"{ \n"+"} \n"+"void getUnitRotate(){ \n"+"} \n"+"void getNodeData(){ \n"+"} \n"+"void rotateParticleUnit() \n"+"{ \n"+"rotResultVec3.z += attribute_rotationBirth; \n"+"rotResultVec3 *= PI / 180.0; \n"+"if(particleStateData.renderMode == Mesh){ \n"+"if(particleStateData.shapeType > 0.5){ \n"+"rotResultVec3 = vec3(0.0, rotResultVec3.z, 0.0); \n"+"rotVertexMatrix = buildRotMat4(rotResultVec3); \n"+"}else{ \n"+"rotResultVec3 = vec3(0.0, 0.0, rotResultVec3.z); \n"+"rotVertexMatrix = buildRotMat4(rotResultVec3); \n"+"} \n"+"}else if(particleStateData.renderMode == HorizontalBillboard){ \n"+"rotVertexMatrix = buildRotMat4(vec3(0.5 * PI, 0.0, 0.0)); \n"+"rotResultVec3 = vec3(0.0, rotResultVec3.z, 0.0); \n"+"rotVertexMatrix = buildRotMat4(rotResultVec3) * rotVertexMatrix; \n"+"}else if(particleStateData.renderMode == StretchedBillboard){ \n"+"rotResultVec3 = vec3(0.0, 0.0, -0.5 * PI); \n"+"rotVertexMatrix = buildRotMat4(rotResultVec3); \n"+"}else{ \n"+"rotVertexMatrix = buildRotMat4(rotResultVec3); \n"+"} \n"+"} \n"+"void main(void) \n"+"{ \n"+"localPosition = vec4(e_position, 1.0); \n"+"particleStateData.time\t\t\t\t\t\t\t= uniform_particleState[0]; \n"+"particleStateData.loop\t\t\t\t\t\t\t= uniform_particleState[1]; \n"+"particleStateData.worldSpace\t\t\t\t\t= uniform_particleState[2]; \n"+"particleStateData.scaleX\t\t\t\t\t\t= uniform_particleState[3]; \n"+"particleStateData.scaleY\t\t\t\t\t\t= uniform_particleState[4]; \n"+"particleStateData.scaleZ\t\t\t\t\t\t= uniform_particleState[5]; \n"+"particleStateData.rotationX\t\t\t\t\t\t= uniform_particleState[6]; \n"+"particleStateData.rotationY\t\t\t\t\t\t= uniform_particleState[7]; \n"+"particleStateData.rotationZ\t\t\t\t\t\t= uniform_particleState[8]; \n"+"particleStateData.rotationW\t\t\t\t\t\t= uniform_particleState[9]; \n"+"particleStateData.positionX\t\t\t\t\t\t= uniform_particleState[10]; \n"+"particleStateData.positionY\t\t\t\t\t\t= uniform_particleState[11]; \n"+"particleStateData.positionZ\t\t\t\t\t\t= uniform_particleState[12]; \n"+"particleStateData.loopTime\t\t\t\t\t\t= uniform_particleState[13]; \n"+"particleStateData.delay\t\t\t\t\t\t\t= uniform_particleState[14]; \n"+"particleStateData.duration\t\t\t\t\t\t= uniform_particleState[15]; \n"+"particleStateData.gravity\t\t\t\t\t\t= uniform_particleState[16]; \n"+"particleStateData.velocityOverWorldSpace\t\t= uniform_particleState[17]; \n"+"particleStateData.velocityForceWorldSpace\t\t= uniform_particleState[18]; \n"+"particleStateData.velocityLimitDampen\t\t\t= uniform_particleState[19]; \n"+"particleStateData.cameraScale\t\t\t\t\t= uniform_particleState[20]; \n"+"particleStateData.speedScale\t\t\t\t\t= uniform_particleState[21]; \n"+"particleStateData.lengthScale\t\t\t\t\t= uniform_particleState[22]; \n"+"particleStateData.renderMode\t\t\t\t\t= uniform_particleState[23]; \n"+"particleStateData.stayAtEnd\t\t\t\t\t\t= uniform_particleState[24]; \n"+"particleStateData.blendMode\t\t\t\t\t\t= uniform_particleState[25]; \n"+"particleStateData.shapeType\t\t\t\t\t\t= uniform_particleState[26]; \n"+"calcParticleTime(); \n"+"varying_particleData.x = currentTime; \n"+"varying_particleData.y = curParticle.life; \n"+"varying_particleData.z = curParticle.index; \n"+"varying_particleData.w = particleStateData.blendMode; \n"+"if(discard_particle){ \n"+"varying_particleData.x = currentTime = 0.0; \n"+"gl_Position = varying_pos = vec4(0.0, 0.0, 0.0, 1.0); \n"+"return; \n"+"} \n"+"getNodeData(); \n"+"getUnitRotate(); \n"+"rotateParticleUnit(); \n"+"} \n",
pointLight_fragment:"const int max_pointLight = 0 ; \n"+"uniform float uniform_pointLightSource[12*max_pointLight] ; \n"+"varying vec4 varying_mvPose; \n"+"struct PointLight{ \n"+"vec3 position ; \n"+"vec3 diffuse ; \n"+"vec3 ambient ; \n"+"float intensity; \n"+"float radius; \n"+"float cutoff; \n"+"}; \n"+"void calculatePointLight(MaterialSource materialSource){ \n"+"vec3 N = normal; \n"+"vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n"+"for(int i = 0 ; i < max_pointLight ; i++){ \n"+"PointLight pointLight; \n"+"pointLight.position = vec3(uniform_pointLightSource[i*12],uniform_pointLightSource[i*12+1],uniform_pointLightSource[i*12+2]); \n"+"pointLight.diffuse = vec3(uniform_pointLightSource[i*12+3],uniform_pointLightSource[i*12+4],uniform_pointLightSource[i*12+5]); \n"+"pointLight.ambient = vec3(uniform_pointLightSource[i*12+6],uniform_pointLightSource[i*12+7],uniform_pointLightSource[i*12+8]); \n"+"pointLight.intensity = uniform_pointLightSource[i*12+9]; \n"+"pointLight.radius = uniform_pointLightSource[i*12+10]; \n"+"pointLight.cutoff = uniform_pointLightSource[i*12+11]; \n"+"vec3 lightCentre = (mat4(uniform_ViewMatrix) * vec4(pointLight.position.xyz,1.0) ).xyz ; \n"+"float r = pointLight.radius * 0.5 ; \n"+"vec3 ldir = varying_mvPose.xyz - lightCentre ; \n"+"float distance = length(ldir); \n"+"float d = max(distance - r, 0.0); \n"+"vec3 L = ldir / distance; \n"+"float denom = d/r + 1.0; \n"+"float attenuation = 1.0 / (denom*denom); \n"+"float cutoff = pointLight.cutoff ; \n"+"attenuation = (attenuation - cutoff) / (1.0 - cutoff); \n"+"attenuation = max(attenuation*pointLight.intensity, 0.0); \n"+"LightingBlinnPhong(normalize(ldir),pointLight.diffuse,pointLight.ambient,N,(viewDir),attenuation); \n"+"}; \n"+"} \n"+"void main() { \n"+"calculatePointLight(materialSource); \n"+"} \n",positionEndPass_fs:"varying vec4 varying_position ; \n"+"void main(){ \n"+"outColor = vec4(varying_position.xyz,1.0); \n"+"} \n",positionEndPass_vs:"varying vec4 varying_position ; \n"+"void main(){ \n"+"outPosition = uniform_ProjectionMatrix * outPosition ; \n"+"varying_position = outPosition.xyzw; \n"+"} \n",rimlight_fs:"uniform float uniform_rimData[6] ; \n"+"void main(){ \n"+"float rim = 1.0 - clamp(dot (vec3(0.0,0.0,1.0), normal ) ,0.0,1.0); \n"+"vec3 emission = vec3(uniform_rimData[0],uniform_rimData[1],uniform_rimData[2]) * pow(rim, uniform_rimData[4]); \n"+"outColor.xyz += emission * uniform_rimData[3] * uniform_rimData[5] ; \n"+"} \n",secondaryUV_vs:"attribute vec2 attribute_uv1; \n"+"varying vec2 varying_uv1 ; \n"+"void main(void){ \n"+"varying_uv1 = attribute_uv1 ; \n"+"} \n",shadowMapping_fs:"uniform sampler2D shadowMapTexture; \n"+"uniform vec4 uniform_ShadowColor; \n"+"varying vec4 varying_ShadowCoord; \n"+"float unpackDepth(vec4 rgbaDepth){ \n"+"vec4 bitShift = vec4( 1.0 , 1.0/256.0 , 1.0/(256.0*256.0) , 1.0/(256.0*256.0*256.0) ); \n"+"float depth = dot(rgbaDepth,bitShift); \n"+"return depth ; \n"+"} \n"+"void main() { \n"+"vec3 shadowColor = vec3(1.0,1.0,1.0); \n"+"float offset = uniform_ShadowColor.w; \n"+"vec2 sample = varying_ShadowCoord.xy / varying_ShadowCoord.w * 0.5 + 0.5; \n"+"if (sample.x >=0.0 && sample.x <= 1.0 && sample.y >=0.0 && sample.y <= 1.0) { \n"+"vec4 sampleDepth = texture2D(shadowMapTexture, sample).xyzw; \n"+"float depth = varying_ShadowCoord.z; \n"+"if (sampleDepth.z != 0.0) { \n"+"if( sampleDepth.z < depth - offset) { \n"+"shadowColor = uniform_ShadowColor.xyz; \n"+"} \n"+"} \n"+"} \n"+"diffuseColor.xyz = diffuseColor.xyz * shadowColor; \n"+"} \n",shadowMapping_vs:"uniform mat4 uniform_ShadowMatrix; \n"+"uniform mat4 uniform_ModelMatrix; \n"+"varying vec4 varying_ShadowCoord; \n"+"void main() { \n"+"varying_ShadowCoord = uniform_ShadowMatrix * uniform_ModelMatrix * vec4(e_position, 1.0); \n"+"} \n",shadowPass_fs:"uniform sampler2D diffuseTexture; \n"+"vec4 diffuseColor ; \n"+"varying vec2 varying_uv0; \n"+"varying vec4 varying_color; \n"+"varying vec4 varying_pos; \n"+"float unpackDepth(vec4 rgbaDepth){ \n"+"vec4 bitShift = vec4( 1.0 , 1.0/256.0 , 1.0/(256.0*256.0) , 1.0/(256.0*256.0*256.0) ); \n"+"float depth = dot(rgbaDepth,bitShift); \n"+"return depth ; \n"+"} \n"+"void main() { \n"+"diffuseColor = varying_color ; \n"+"if( diffuseColor.w == 0.0 ){ \n"+"discard; \n"+"} \n"+"diffuseColor = texture2D(diffuseTexture , varying_uv0 ); \n"+"if( diffuseColor.w <= 0.3 ){ \n"+"discard; \n"+"} \n"+"gl_FragColor = vec4(varying_pos.zzz, 1.0); \n"+"} \n",shadowPass_skeleton_vs:"attribute vec3 attribute_position; \n"+"attribute vec3 attribute_normal; \n"+"attribute vec4 attribute_color; \n"+"attribute vec2 attribute_uv0; \n"+"attribute vec4 attribute_boneIndex; \n"+"attribute vec4 attribute_boneWeight; \n"+"uniform mat4 uniform_ModelMatrix ; \n"+"uniform mat4 uniform_ViewMatrix ; \n"+"uniform mat4 uniform_ProjectionMatrix ; \n"+"vec3 e_position = vec3(0.0, 0.0, 0.0); \n"+"vec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0); \n"+"vec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0); \n"+"vec4 outPosition = vec4(0.0, 0.0, 0.0, 0.0); \n"+"const int bonesNumber = 0; \n"+"uniform vec4 uniform_PoseMatrix[bonesNumber]; \n"+"varying vec2 varying_uv0; \n"+"varying vec4 varying_color; \n"+"varying vec4 varying_pos; \n"+"mat4 buildMat4(int index){ \n"+"vec4 quat = uniform_PoseMatrix[index * 2 + 0]; \n"+"vec4 translation = uniform_PoseMatrix[index * 2 + 1]; \n"+"float xy2 = 2.0 * quat.x * quat.y; \n"+"float xz2 = 2.0 * quat.x * quat.z; \n"+"float xw2 = 2.0 * quat.x * quat.w; \n"+"float yz2 = 2.0 * quat.y * quat.z; \n"+"float yw2 = 2.0 * quat.y * quat.w; \n"+"float zw2 = 2.0 * quat.z * quat.w; \n"+"float xx = quat.x * quat.x; \n"+"float yy = quat.y * quat.y; \n"+"float zz = quat.z * quat.z; \n"+"float ww = quat.w * quat.w; \n"+"mat4 matrix = mat4( \n"+"xx - yy - zz + ww, xy2 + zw2, xz2 - yw2, 0, \n"+"xy2 - zw2, -xx + yy - zz + ww, yz2 + xw2, 0, \n"+"xz2 + yw2, yz2 - xw2, -xx - yy + zz + ww, 0, \n"+"translation.x, translation.y, translation.z, 1 \n"+"); \n"+"return matrix; \n"+"} \n"+"void main(void){ \n"+"e_boneIndex = attribute_boneIndex; \n"+"e_boneWeight = attribute_boneWeight; \n"+"vec4 temp_position = vec4(attribute_position, 1.0) ; \n"+"mat4 m0 = buildMat4(int(e_boneIndex.x)); \n"+"mat4 m1 = buildMat4(int(e_boneIndex.y)); \n"+"mat4 m2 = buildMat4(int(e_boneIndex.z)); \n"+"mat4 m3 = buildMat4(int(e_boneIndex.w)); \n"+"outPosition = m0 * temp_position * e_boneWeight.x; \n"+"outPosition += m1 * temp_position * e_boneWeight.y; \n"+"outPosition += m2 * temp_position * e_boneWeight.z; \n"+"outPosition += m3 * temp_position * e_boneWeight.w; \n"+"e_position = outPosition.xyz; \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n"+"varying_color = attribute_color; \n"+"varying_uv0 = attribute_uv0 ; \n"+"varying_pos = uniform_ProjectionMatrix * uniform_ViewMatrix * uniform_ModelMatrix * vec4(e_position, 1.0); \n"+"gl_Position = varying_pos; \n"+"} \n",shadowPass_vs:"attribute vec3 attribute_position; \n"+"attribute vec4 attribute_color; \n"+"attribute vec2 attribute_uv0; \n"+"uniform mat4 uniform_ModelMatrix ; \n"+"uniform mat4 uniform_ViewMatrix ; \n"+"uniform mat4 uniform_ProjectionMatrix ; \n"+"varying vec2 varying_uv0; \n"+"varying vec4 varying_color; \n"+"varying vec4 varying_pos; \n"+"void main(void){ \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n"+"varying_color = attribute_color; \n"+"varying_uv0 = attribute_uv0 ; \n"+"varying_pos = uniform_ProjectionMatrix * uniform_ViewMatrix * uniform_ModelMatrix * vec4(attribute_position, 1.0); \n"+"gl_Position = varying_pos; \n"+"} \n",skeletonShadowPass_vs:"attribute vec4 attribute_boneIndex; \n"+"attribute vec4 attribute_boneWeight; \n"+"attribute vec4 attribute_color; \n"+"vec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0); \n"+"vec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0); \n"+"const int bonesNumber = 0; \n"+"uniform vec4 uniform_PoseMatrix[bonesNumber]; \n"+"mat4 buildMat4(int index){ \n"+"vec4 quat = uniform_PoseMatrix[index * 2 + 0]; \n"+"vec4 translation = uniform_PoseMatrix[index * 2 + 1]; \n"+"float xx = quat.x * quat.x; \n"+"float xy = quat.x * quat.y; \n"+"float xz = quat.x * quat.z; \n"+"float xw = quat.x * quat.w; \n"+"float yy = quat.y * quat.y; \n"+"float yz = quat.y * quat.z; \n"+"float yw = quat.y * quat.w; \n"+"float zz = quat.z * quat.z; \n"+"float zw = quat.z * quat.w; \n"+"return mat4( \n"+"1.0 - 2.0 * (yy + zz),\t\t2.0 * (xy + zw),\t\t2.0 * (xz - yw),\t\t0, \n"+"2.0 * (xy - zw),\t\t\t\t1.0 - 2.0 * (xx + zz),\t2.0 * (yz + xw),\t\t0, \n"+"2.0 * (xz + yw),\t\t\t\t2.0 * (yz - xw),\t\t1.0 - 2.0 * (xx + yy),\t0, \n"+"translation.x,\t\t\t\ttranslation.y,\t\t\ttranslation.z,\t\t\t1 \n"+"); \n"+"} \n"+"void main(void){ \n"+"varying_color = attribute_color; \n"+"e_boneIndex = attribute_boneIndex; \n"+"e_boneWeight = attribute_boneWeight; \n"+"vec4 temp_position = vec4(attribute_position, 1.0) ; \n"+"mat4 m0 = buildMat4(int(e_boneIndex.x)); \n"+"mat4 m1 = buildMat4(int(e_boneIndex.y)); \n"+"mat4 m2 = buildMat4(int(e_boneIndex.z)); \n"+"mat4 m3 = buildMat4(int(e_boneIndex.w)); \n"+"outPosition = m0 * temp_position * e_boneWeight.x; \n"+"outPosition += m1 * temp_position * e_boneWeight.y; \n"+"outPosition += m2 * temp_position * e_boneWeight.z; \n"+"outPosition += m3 * temp_position * e_boneWeight.w; \n"+"e_position = outPosition.xyz; \n"+"outPosition = uniform_ModelMatrix * uniform_ViewMatrix *  outPosition; \n"+"} \n",skeleton_vs:"attribute vec4 attribute_boneIndex; \n"+"attribute vec4 attribute_boneWeight; \n"+"attribute vec3 attribute_normal; \n"+"attribute vec4 attribute_color; \n"+"vec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0); \n"+"vec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0); \n"+"const int bonesNumber = 0; \n"+"uniform vec4 uniform_PoseMatrix[bonesNumber]; \n"+"varying vec4 varying_mvPose  ; \n"+"mat4 buildMat4(int index){ \n"+"vec4 quat = uniform_PoseMatrix[index * 2 + 0]; \n"+"vec4 translation = uniform_PoseMatrix[index * 2 + 1]; \n"+"float xy2 = 2.0 * quat.x * quat.y; \n"+"float xz2 = 2.0 * quat.x * quat.z; \n"+"float xw2 = 2.0 * quat.x * quat.w; \n"+"float yz2 = 2.0 * quat.y * quat.z; \n"+"float yw2 = 2.0 * quat.y * quat.w; \n"+"float zw2 = 2.0 * quat.z * quat.w; \n"+"float xx = quat.x * quat.x; \n"+"float yy = quat.y * quat.y; \n"+"float zz = quat.z * quat.z; \n"+"float ww = quat.w * quat.w; \n"+"mat4 matrix = mat4( \n"+"xx - yy - zz + ww, xy2 + zw2, xz2 - yw2, 0, \n"+"xy2 - zw2, -xx + yy - zz + ww, yz2 + xw2, 0, \n"+"xz2 + yw2, yz2 - xw2, -xx - yy + zz + ww, 0, \n"+"translation.x, translation.y, translation.z, 1 \n"+"); \n"+"return matrix; \n"+"} \n"+"void main(void){ \n"+"e_boneIndex = attribute_boneIndex; \n"+"e_boneWeight = attribute_boneWeight; \n"+"vec4 temp_position = vec4(attribute_position, 1.0) ; \n"+"vec4 temp_normal = vec4(attribute_normal, 0.0) ; \n"+"mat4 m0 = buildMat4(int(e_boneIndex.x)); \n"+"mat4 m1 = buildMat4(int(e_boneIndex.y)); \n"+"mat4 m2 = buildMat4(int(e_boneIndex.z)); \n"+"mat4 m3 = buildMat4(int(e_boneIndex.w)); \n"+"outPosition = m0 * temp_position * e_boneWeight.x; \n"+"outPosition += m1 * temp_position * e_boneWeight.y; \n"+"outPosition += m2 * temp_position * e_boneWeight.z; \n"+"outPosition += m3 * temp_position * e_boneWeight.w; \n"+"e_position = outPosition.xyz; \n"+"vec4 temp_n ; \n"+"temp_n  = m0 * temp_normal * e_boneWeight.x; \n"+"temp_n += m1 * temp_normal * e_boneWeight.y; \n"+"temp_n += m2 * temp_normal * e_boneWeight.z; \n"+"temp_n += m3 * temp_normal * e_boneWeight.w; \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n"+"varying_mvPose = mvMatrix * vec4( e_position , 1.0 ) ; \n"+"mat4 normalMatrix = inverse(mvMatrix) ; \n"+"normalMatrix = transpose(normalMatrix); \n"+"varying_eyeNormal = mat3(normalMatrix) * -temp_n.xyz ; \n"+"outPosition.xyzw = varying_mvPose.xyzw ; \n"+"varying_color = attribute_color; \n"+"} \n",specularMap_fragment:"uniform sampler2D specularTexture; \n"+"void main(void){ \n"+"specularColor.xyz *= texture2D( specularTexture , uv_0 ).xyz ; \n"+"} \n",SSAO:"#define DL 2.399963229728653 \n"+"#define EULER 2.718281828459045 \n"+"varying vec2 varying_uv0; \n"+"float aoClamp =  0.5 ; \n"+"float lumInfluence =  0.5 ; \n"+"const vec2 size =  vec2(512.0,512.0); \n"+"const int samples =  64; \n"+"const float radius =  2.0; \n"+"const bool useNoise =  false; \n"+"const float noiseAmount =  0.00000003; \n"+"const float diffArea =  0.4; \n"+"const float gDisplace =  0.4; \n"+"uniform sampler2D positionPass; \n"+"uniform sampler2D normalPass; \n"+"uniform sampler2D colorPass; \n"+"vec2 rand( vec2 coord ) { \n"+"vec2 noise; \n"+"if ( useNoise ) { \n"+"float nx = dot ( coord, vec2( 12.9898, 78.233 ) ); \n"+"float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 ); \n"+"noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 ); \n"+"} else { \n"+"float ff = fract( 1.0 - coord.s * ( size.x / 2.0 ) ); \n"+"float gg = fract( coord.t * ( size.y / 2.0 ) ); \n"+"noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg; \n"+"} \n"+"return ( noise * 2.0  - 1.0 ) * noiseAmount; \n"+"} \n"+"float readDepth(vec2 coord){ \n"+"float cameraNear = 1.0 ; \n"+"float cameraFar = 10000.0; \n"+"float cameraFarPlusNear = cameraFar + cameraNear; \n"+"float cameraFarMinusNear = cameraFar - cameraNear; \n"+"float cameraCoef = 2.0 * cameraNear; \n"+"return texture2D(positionPass,coord).z / (cameraFar-cameraNear); \n"+"} \n"+"float compareDepths( const in float depth1, const in float depth2, inout int far ) { \n"+"float garea = 2.0; \n"+"float diff = ( depth1 - depth2 ) * 100.0; \n"+"if ( diff < gDisplace ) { \n"+"garea = diffArea; \n"+"} else { \n"+"far = 1; \n"+"} \n"+"float dd = diff - gDisplace; \n"+"float gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) ); \n"+"return gauss; \n"+"} \n"+"float calcAO( float depth, float dw, float dh ) { \n"+"float dd = radius - depth * radius; \n"+"vec2 vv = vec2( dw, dh ); \n"+"vec2 vUv = varying_uv0 ; \n"+"vec2 coord1 = vUv + dd * vv; \n"+"vec2 coord2 = vUv - dd * vv; \n"+"float temp1 = 0.0; \n"+"float temp2 = 0.0; \n"+"int far = 0; \n"+"temp1 = compareDepths( depth, readDepth( coord1 ), far ); \n"+"if ( far > 0 ) { \n"+"temp2 = compareDepths( readDepth( coord2 ), depth, far ); \n"+"temp1 += ( 1.0 - temp1 ) * temp2; \n"+"} \n"+"return temp1; \n"+"} \n"+"void main(){ \n"+"vec2 noise = rand( varying_uv0 ); \n"+"float depth = readDepth( varying_uv0 ); \n"+"float tt = clamp( depth, aoClamp, 1.0 ); \n"+"float w = ( 1.0 / size.x )  / tt + ( noise.x * ( 1.0 - noise.x ) ); \n"+"float h = ( 1.0 / size.y ) / tt + ( noise.y * ( 1.0 - noise.y ) ); \n"+"float ao = 0.0; \n"+"float dz = 1.0 / float( samples ); \n"+"float z = 1.0 - dz / 2.0; \n"+"float l = 0.0; \n"+"for ( int i = 0; i <= samples; i ++ ) { \n"+"float r = sqrt( 1.0 - z ); \n"+"float pw = cos( l ) * r; \n"+"float ph = sin( l ) * r; \n"+"ao += calcAO( depth, pw * w, ph * h ); \n"+"z = z - dz; \n"+"l = l + DL; \n"+"} \n"+"ao /= float( samples ); \n"+"ao = 1.0 - ao; \n"+"vec3 color = texture2D(colorPass,varying_uv0).xyz ; \n"+"vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 ); \n"+"float lum = dot( color.rgb, lumcoeff ); \n"+"vec3 luminance = vec3( lum ); \n"+"vec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) ); \n"+"gl_FragColor = vec4( final, 1.0 ); \n"+"} \n",tangent_vs:"attribute vec3 attribute_tangent; \n"+"void main(void){ \n"+"}  \n",terrainRGBA_fragment:"uniform sampler2D blendMaskTexture ; \n"+"uniform sampler2D splat_0Tex ; \n"+"uniform sampler2D splat_1Tex ; \n"+"uniform sampler2D splat_2Tex ; \n"+"uniform sampler2D splat_3Tex ; \n"+"uniform float uvs[8]; \n"+"void main() { \n"+"materialSource.refraction = 3.0 ; \n"+"vec4 splat_control = texture2D ( blendMaskTexture , varying_uv0 ); \n"+"vec4 cc = vec4(0.0,0.0,0.0,1.0); \n"+"vec2 uv = varying_uv0 ; \n"+"cc.xyz = splat_control.x * texture2D (splat_0Tex, uv * vec2(uvs[0],uvs[1])).xyz ; \n"+"cc.xyz += splat_control.y * texture2D (splat_1Tex, uv * vec2(uvs[2],uvs[3]) ).xyz; \n"+"cc.xyz += splat_control.z * vec4(texture2D (splat_2Tex, uv* vec2(uvs[4],uvs[5]))).xyz; \n"+"cc.xyz += (1.0-splat_control.w) * vec4(texture2D (splat_3Tex, uv* vec2(uvs[6],uvs[7]))).xyz; \n"+"diffuseColor.xyz = cc.xyz ; \n"+"} \n",uvRoll_fs:"uniform float uvRoll[2] ; \n"+"uniform sampler2D diffuseTexture; \n"+"vec4 diffuseColor ; \n"+"void main() { \n"+"uv_0.xy += vec2(uvRoll[0],uvRoll[1]); \n"+"diffuseColor = texture2D(diffuseTexture , uv_0 ); \n"+"} \n",uvSpriteSheet_fs:"uniform float uvSpriteSheet[4] ; \n"+"uniform sampler2D diffuseTexture; \n"+"vec4 diffuseColor ; \n"+"void main() { \n"+"uv_0.xy *= vec2(uvSpriteSheet[2],uvSpriteSheet[3]); \n"+"uv_0.xy += vec2(uvSpriteSheet[0],uvSpriteSheet[1]); \n"+"diffuseColor = texture2D(diffuseTexture , uv_0 ); \n"+"} \n",uvStreamerRoll_fs:"uniform float uvRoll[3] ; \n"+"uniform sampler2D diffuseTexture; \n"+"uniform sampler2D streamerTexture; \n"+"vec4 diffuseColor ; \n"+"void main() { \n"+"diffuseColor = texture2D(diffuseTexture , varying_uv0 ); \n"+"vec2 rollUV = varying_uv0 + vec2(uvRoll[0],uvRoll[1]) + vec2(normal.xz) * 0.5 ; \n"+"diffuseColor.xyz += texture2D(streamerTexture , rollUV ).xyz * uvRoll[2] ; \n"+"} \n",varyingViewDir_vs:"varying vec3 varying_ViewDir; \n"+"uniform vec3 uniform_eyepos; \n"+"void main(void){ \n"+"varying_ViewDir = (uniform_eyepos.xyz - e_position) ; \n"+"} \n",vertexPos_vs:"uniform mat4 uniform_ModelMatrix; \n"+"uniform mat4 uniform_ViewMatrix; \n"+"varying vec4 varying_mvPose; \n"+"void main() { \n"+"varying_mvPose = uniform_ViewMatrix * uniform_ModelMatrix * vec4(e_position, 1.0) ; \n"+"} \n"+"                       \n",waterBump_fs:"uniform vec2 waterNormalData[4]; \n"+"uniform vec4 horizonColor; \n"+"uniform float time ; \n"+"uniform sampler2D bumpTexture; \n"+"uniform sampler2D colorControlTexture; \n"+"varying vec2 varying_uv0        ; \n"+"varying vec2 varying_uv0        ; \n"+"vec4 UnpackNormal( vec4 nT ){ \n"+"vec4 t ; \n"+"t.xyzw = nT.xyzw * 2.0 - 1.0 ; \n"+"return t ; \n"+"} \n"+"mat3 TBN ; \n"+"mat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) { \n"+"vec3 dp1 = dFdx(p); \n"+"vec3 dp2 = dFdy(p); \n"+"vec2 duv1 = dFdx(uv); \n"+"vec2 duv2 = dFdy(uv); \n"+"vec3 dp2perp = cross(dp2, N); \n"+"vec3 dp1perp = cross(N, dp1); \n"+"vec3 T = dp2perp * duv1.x + dp1perp * duv2.x; \n"+"vec3 B = dp2perp * duv1.y + dp1perp * duv2.y; \n"+"float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B))); \n"+"return mat3(T * invmax, B * invmax, N); \n"+"} \n"+"void main(void){ \n"+"float tempTime = mod(time,10000000.0); \n"+"vec2 uvA = uv_0 * waterNormalData[3].x + waterNormalData[0] * tempTime ; \n"+"vec2 uvB = uv_0 * waterNormalData[3].y + waterNormalData[1] * tempTime  ; \n"+"TBN = cotangentFrame(normal,varying_mvPose.xyz, varying_uv0) ; \n"+"vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w) ; \n"+"vec3 bump1 = UnpackNormal(texture2D( bumpTexture, uvA )).rgb; \n"+"vec3 bump2 = UnpackNormal(texture2D( bumpTexture, uvB )).rgb; \n"+"vec3 bump = (bump1 + bump2) * 0.5; \n"+"normal = TBN * bump ; \n"+"float fresnel = dot( viewDir, bump ); \n"+"vec4 water = texture2D( colorControlTexture, vec2(fresnel,fresnel) ); \n"+"vec4 col; \n"+"diffuseColor.rgb = mix( water.rgb, horizonColor.rgb, water.a ); \n"+"diffuseColor.a = horizonColor.a; \n"+"} \n",waterDiffuse_fs:"uniform sampler2D diffuseTexture; \n"+"vec4 diffuseColor ; \n"+"void main() { \n"+"diffuseColor.xyz *= diffuseColor.w ; \n"+"} \n",waterNormal_fs:"uniform vec2 waterNormalData[4]; \n"+"uniform float time ; \n"+"uniform sampler2D normalTextureA; \n"+"uniform sampler2D normalTextureB; \n"+"varying vec4 varying_mvPose; \n"+"varying vec2 varying_uv0; \n"+"mat3 TBN ; \n"+"mat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) { \n"+"vec3 dp1 = dFdx(p); \n"+"vec3 dp2 = dFdy(p); \n"+"vec2 duv1 = dFdx(uv); \n"+"vec2 duv2 = dFdy(uv); \n"+"vec3 dp2perp = cross(dp2, N); \n"+"vec3 dp1perp = cross(N, dp1); \n"+"vec3 T = dp2perp * duv1.x + dp1perp * duv2.x; \n"+"vec3 B = dp2perp * duv1.y + dp1perp * duv2.y; \n"+"float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B))); \n"+"return mat3(T * invmax, B * invmax, N); \n"+"} \n"+"vec3 tbn(vec3 map, vec3 N, vec3 V, vec2 texcoord) { \n"+"mat3 TBN = cotangentFrame(N, -V, texcoord); \n"+"return normalize(TBN * map); \n"+"} \n"+"void main(void){ \n"+"TBN = cotangentFrame(normal,varying_mvPose.xyz, varying_uv0) ; \n"+"float tempTime = mod(time,100000.0); \n"+"vec2 uvA = uv_0 * waterNormalData[3].x + waterNormalData[0] * tempTime ; \n"+"vec2 uvB = uv_0 * waterNormalData[3].y + waterNormalData[1] * tempTime  ; \n"+"vec3 bump1 = texture2D( normalTextureA, uvA ).rgb * 2.0-1.0 ; \n"+"bump1.y *= -1.0; \n"+"bump1.xyz = TBN * bump1 ; \n"+"normal.xyz = bump1.xyz ; \n"+"vec3 bump2 = texture2D( normalTextureB, uvB ).rgb * 2.0-1.0 ; \n"+"bump2.y *= -1.0; \n"+"bump2.xyz = TBN * bump2 ; \n"+"normal.xyz = (normal.xyz + bump2.xyz)*0.5 ; \n"+"}  \n",wave_fs:"uniform sampler2D diffuseTexture; \n"+"uniform vec3 uniform_eyepos; \n"+"uniform vec4 waveFSData[2]; \n"+"varying vec4 varying_mvPose; \n"+"vec4 diffuseColor ; \n"+"void main(void){ \n"+"vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n"+"diffuseColor.xyz = vec3(1.0,1.0,1.0) ; \n"+"vec3 shallowWaterColor = waveFSData[0].xyz * waveFSData[0].w ; \n"+"vec3 deepWaterColor = waveFSData[1].xyz * waveFSData[1].w; \n"+"float facing = clamp(dot( -normalize(viewDir),normal),0.0,1.0); \n"+"vec3 waterColor = mix(shallowWaterColor,deepWaterColor,facing); \n"+"diffuseColor.xyz *= waterColor ; \n"+"}  \n",wave_vs:"#define VERTEX_TEXTURES \n"+"attribute vec3 attribute_normal; \n"+"attribute vec4 attribute_color; \n"+"uniform mat4 uniform_ModelMatrix; \n"+"uniform mat4 uniform_ViewMatrix; \n"+"varying vec4 varying_mvPose; \n"+"uniform vec3 waveVSData[4]; \n"+"uniform float time ; \n"+"struct wave{ \n"+"vec3 wave_xyz_intensity_0 ; \n"+"vec3 wave_xyz_intensity_1 ; \n"+"vec3 wave_xyz_speed_0 ; \n"+"vec3 wave_xyz_speed_1 ; \n"+"}; \n"+"const float pi = 3.14 ; \n"+"vec3 calcWave2( float t , vec3 x, float amplitude, float waveLength ,float angularVelocity ,  vec3 waveDir ){ \n"+"angularVelocity = angularVelocity * 0.1; \n"+"vec3 waveVector = waveDir ; \n"+"float waveNumber = pi / waveLength; \n"+"waveVector *= waveNumber ; \n"+"vec3 temp ; \n"+"float kDotX0SubWt = dot(waveVector , x ) - angularVelocity * t  * 0.001; \n"+"float A = amplitude * sin(kDotX0SubWt) ; \n"+"temp.xz = waveDir.xz * A ; \n"+"temp.y += amplitude * cos(kDotX0SubWt); \n"+"temp = x - temp ; \n"+"return temp ; \n"+"} \n"+"void main(void){ \n"+"wave wa ; \n"+"wa.wave_xyz_intensity_0 = vec3(waveVSData[0]) ; \n"+"wa.wave_xyz_intensity_1 = vec3(waveVSData[1]) ; \n"+"wa.wave_xyz_speed_0 = vec3(waveVSData[2]) ; \n"+"wa.wave_xyz_speed_1 = vec3(waveVSData[3]) ; \n"+"float tempTime = mod( time , 1000000.0 ); \n"+"vec3 newPose1 = calcWave2(tempTime,e_position,40.0, 20.0, 10.0,vec3(1.0,0.0,1.0)); \n"+"newPose1 += calcWave2(tempTime,e_position,20.0, 10.0, 10.0,vec3(1.0,0.0,-0.5)); \n"+"newPose1 += calcWave2(tempTime,e_position,1.0, 1.0, 10.0,vec3(1.0,0.0,-1.5)); \n"+"e_position = newPose1 ; \n"+"mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n"+"varying_mvPose = mvMatrix * vec4( e_position , 1.0 )  ; \n"+"mat4 normalMatrix = inverse(mvMatrix) ; \n"+"normalMatrix = transpose(normalMatrix); \n"+"varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n"+"outPosition = varying_mvPose ; \n"+"varying_color = attribute_color; \n"+"}  \n"};return t}();t.ShaderLib=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.register=function(t){this.context=t};e.getGPUShader=function(e,i,r){var a=this.vsShaderHashMap.getValue(i);if(!a){a=this.fsShaderHashMap.getValue(i)}if(!a){if(e==t.Shader.vertex){a=this.context.creatVertexShader(r);a.id=i;this.vsShaderHashMap.add(i,a)}else if(e==t.Shader.fragment){a=this.context.creatFragmentShader(r);a.id=i;this.fsShaderHashMap.add(i,a)}}return a};e.getProgram=function(t,e){var i=this.vsShaderHashMap.getValue(t);var r=this.fsShaderHashMap.getValue(e);var a=i.id+"_"+r.id;var n;if(this.programlib.isHas(a)){n=this.programlib.getValue(a)}else{n=this.registerProgram(i,r);this.programlib.add(a,n)}return this.programlib.getValue(a)};e.unRegisterShader=function(t){};e.registerProgram=function(t,e){var i=this.context.creatProgram(t,e);return i};e.unRegisterProgram=function(t,e){};e.programlib=new t.HashMap;e.vsShaderHashMap=new t.HashMap;e.fsShaderHashMap=new t.HashMap;return e}();t.ShaderPool=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){this.name="";this.source="";this.funcNames=new Array;this.funcDict={};this.structDict={};this.structNames=new Array;this.attributeList=new Array;this.varyingList=new Array;this.uniformList=new Array;this.constList=new Array;this.tempList=new Array;this.sampler2DList=new Array;this.sampler3DList=new Array;this.extensionList=new Array;this.defineList=new Array}t.prototype.addVar=function(t){if(t.key=="attribute"){this.attributeList.push(t)}else if(t.key=="varying"){this.varyingList.push(t)}else if(t.key=="uniform"){this.uniformList.push(t)}else if(t.key=="const"){this.constList.push(t)}else if(t.key=="sampler2D"){this.sampler2DList.push(t)}else if(t.key=="samplerCube"){this.sampler3DList.push(t)}else if(t.key=="#extension"){this.extensionList.push(t)}else if(t.key=="#define"){this.defineList.push(t)}else{this.tempList.push(t)}};t.prototype.addFunc=function(t,e){if(!this.funcDict[t]){this.funcDict[t]=e;this.funcNames.push(t)}else{var i=this.mergeMainFunc(this.funcDict[t],e);this.funcDict[t]=i}if(this.funcDict["main"]){var r=this.funcNames.indexOf("main");this.funcNames.splice(r,1);this.funcNames.push("main")}};t.prototype.addStruct=function(t,e){if(!this.structDict[t]){this.structDict[t]=e;this.structNames.push(t)}else{console.log("<"+t+">"+"struct重复")}};t.prototype.addContent=function(t){for(var e=0;e<t.structNames.length;++e){this.addStruct(t.structNames[e],t.structDict[t.structNames[e]])}for(var e=0;e<t.funcNames.length;++e){this.addFunc(t.funcNames[e],t.funcDict[t.funcNames[e]])}for(var e=0;e<t.attributeList.length;++e){var i=true;for(var r=0;r<this.attributeList.length;++r){if(t.attributeList[e].name==this.attributeList[r].name){if(t.attributeList[e].valueType!=this.attributeList[r].valueType||t.attributeList[e].key!=this.attributeList[r].key){}i=false;break}}if(i){this.attributeList.push(t.attributeList[e].clone())}}for(var e=0;e<t.varyingList.length;++e){var i=true;for(var r=0;r<this.varyingList.length;++r){if(t.varyingList[e].name==this.varyingList[r].name){if(t.varyingList[e].valueType!=this.varyingList[r].valueType||t.varyingList[e].key!=this.varyingList[r].key){}i=false;break}}if(i){this.varyingList.push(t.varyingList[e].clone())}}for(var e=0;e<t.uniformList.length;++e){var i=true;for(var r=0;r<this.uniformList.length;++r){if(t.uniformList[e].name==this.uniformList[r].name){if(t.uniformList[e].valueType!=this.uniformList[r].valueType||t.uniformList[e].key!=this.uniformList[r].key){}i=false;break}}if(i){this.uniformList.push(t.uniformList[e].clone())}}for(var e=0;e<t.constList.length;++e){var i=true;for(var r=0;r<this.constList.length;++r){if(t.constList[e].name==this.constList[r].name){if(t.constList[e].valueType!=this.constList[r].valueType||t.constList[e].key!=this.constList[r].key){}i=false;break}}if(i){this.constList.push(t.constList[e].clone())}}for(var e=0;e<t.tempList.length;++e){var i=true;for(var r=0;r<this.tempList.length;++r){if(t.tempList[e].name==this.tempList[r].name){if(t.tempList[e].valueType!=this.tempList[r].valueType||t.tempList[e].key!=this.tempList[r].key){}i=false;break}}if(i){this.tempList.push(t.tempList[e].clone())}}for(var e=0;e<t.sampler2DList.length;++e){var i=true;for(var r=0;r<this.sampler2DList.length;++r){if(t.sampler2DList[e].name==this.sampler2DList[r].name){if(t.sampler2DList[e].valueType!=this.sampler2DList[r].valueType||t.sampler2DList[e].key!=this.sampler2DList[r].key){}i=false;break}}if(i){this.sampler2DList.push(t.sampler2DList[e].clone())}}for(var e=0;e<t.sampler3DList.length;++e){var i=true;for(var r=0;r<this.sampler3DList.length;++r){if(t.sampler3DList[e].name==this.sampler3DList[r].name){if(t.sampler2DList[e].valueType!=this.sampler3DList[r].valueType||t.sampler3DList[e].key!=this.sampler3DList[r].key){}i=false;break}}if(i){this.sampler3DList.push(t.sampler3DList[e].clone())}}for(var e=0;e<t.extensionList.length;++e){var i=true;for(var r=0;r<this.extensionList.length;++r){if(t.extensionList[e].name==this.extensionList[r].name){i=false;break}}if(i){this.extensionList.push(t.extensionList[e].clone())}}for(var e=0;e<t.defineList.length;++e){var i=true;for(var r=0;r<this.defineList.length;++r){if(t.defineList[e].name==this.defineList[r].name){i=false;break}}if(i){this.defineList.push(t.defineList[e].clone())}}};t.prototype.mergeMainFunc=function(t,e){var i=t;var r="";var a=e.indexOf("{");var n=e.lastIndexOf("}");a++;r=e.slice(a,n);a=i.lastIndexOf("}");var o=i.substr(0,a);var s=i.substr(a,i.length-a);i=o;i+=r;var h="";var u="";var l=i;i+=u;i+=s;return i};t.prototype.clone=function(){var e=new t;e.name=this.name;e.source=this.source;for(var i=0;i<this.funcNames.length;++i){e.funcNames.push(this.funcNames[i])}for(var r in this.funcDict){e.funcDict[r]=this.funcDict[r]}for(var i=0;i<this.structNames.length;++i){e.structNames.push(this.structNames[i])}for(var r in this.structDict){e.structDict[r]=this.structDict[r]}for(var i=0;i<this.attributeList.length;++i){e.attributeList.push(this.attributeList[i].clone())}for(var i=0;i<this.varyingList.length;++i){e.varyingList.push(this.varyingList[i].clone())}for(var i=0;i<this.uniformList.length;++i){e.uniformList.push(this.uniformList[i].clone())}for(var i=0;i<this.constList.length;++i){e.constList.push(this.constList[i].clone())}for(var i=0;i<this.tempList.length;++i){e.tempList.push(this.tempList[i].clone())}for(var i=0;i<this.sampler2DList.length;++i){e.sampler2DList.push(this.sampler2DList[i].clone())}for(var i=0;i<this.sampler3DList.length;++i){e.sampler3DList.push(this.sampler3DList[i].clone())}for(var i=0;i<this.attributeList.length;++i){e.attributeList.push(this.attributeList[i].clone())}for(var i=0;i<this.extensionList.length;++i){e.extensionList.push(this.extensionList[i].clone())}for(var i=0;i<this.defineList.length;++i){e.defineList.push(this.defineList[i].clone())}return e};return t}();t.ShaderContent=e})(e=t.GLSL||(t.GLSL={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._shaderContentDict=[];this.vs_begin="##define vs begin##";this.vs_end="##define vs end##";this.fs_begin="##define fs begin##";this.fs_end="##define fs end##"}Object.defineProperty(e,"instance",{get:function(){if(!this._instance){this._instance=new e}return this._instance},enumerable:true,configurable:true});e.prototype.load=function(){var e=[];var i=[];for(var r in t.ShaderLib.lib){var a=t.ShaderLib.lib[r].indexOf(this.vs_begin);var n=t.ShaderLib.lib[r].indexOf(this.vs_end);var o=false;if(a!=-1){o=true;a+=this.vs_begin.length;e.push(r);i[r+"vs"]=t.ShaderLib.lib[r].substr(a,n-a)}a=t.ShaderLib.lib[r].indexOf(this.fs_begin);n=t.ShaderLib.lib[r].indexOf(this.fs_end);if(a!=-1){a+=this.fs_begin.length;if(o){e.push(r)}i[r+"fs"]=t.ShaderLib.lib[r].substr(a,n-a)}}for(var r in e){delete t.ShaderLib.lib[e[r]]}for(var r in i){t.ShaderLib.lib[r]=i[r]}for(var r in t.ShaderLib.lib){var s=this.readShader(t.ShaderLib.lib[r]);this._shaderContentDict[r]=s;s.name=r}};e.prototype.readShader=function(e){var i=new t.GLSL.ShaderContent;var r=t.StringUtil.processShaderFile(e);var a=t.StringUtil.parseContent(r);var n=a.concat();while(n.length>0){var o=n[0];n.shift();var s=t.StringUtil.getLineType(o);var h=-1;h=s.indexOf("struct");if(h!=-1){var u=s.split(" ");var l=o;i.addStruct(u[1],l);t.StringUtil.processStruct(u[1],l,i);continue}h=s.indexOf("function");if(h!=-1){var u=s.split(" ");var c=o;i.addFunc(u[1],c);continue}h=s.indexOf("unknown");if(h!=-1){var u=t.StringUtil.parseLines(o);var f=t.StringUtil.getVarKey(u);var d=t.StringUtil.getVarType(u);if(d=="sampler2D"){var p=t.StringUtil.getSampler2D(o);if(p)i.addVar(p)}else if(d=="samplerCube"){
var _=t.StringUtil.getSampler3D(o);if(_)i.addVar(_)}else{if(f=="attribute"){var m=t.StringUtil.getAttribute(o);if(m)i.addVar(m)}else if(f=="varying"){var v=t.StringUtil.getVarying(o);if(v)i.addVar(v)}else if(f=="uniform"){var g=t.StringUtil.getUniform(o);if(g)i.addVar(g)}else if(f=="const"){var y=t.StringUtil.getConst(o);if(y)i.addVar(y)}else if(f=="#extension"){var x=t.StringUtil.getExtension(o);if(x)i.addVar(x)}else if(f=="#define"){var b=t.StringUtil.getDefine(o);if(b)i.addVar(b)}else{i.addVar(t.StringUtil.getTemper(o))}}continue}}return i};e.prototype.fillShaderContent=function(i,r,a){var n;var o=0;var s="";for(o=0;o<r.length;++o){if(s!=""){s+="/"}s+=r[o]}s+="/d"+a.maxDirectLight;s+="/s"+a.maxSpotLight;s+="/p"+a.maxPointLight;s+="/b"+a.maxBone;if(!this._shaderContentDict[s]){n=new t.GLSL.ShaderContent;n.name=s;for(o=0;o<r.length;++o){var h=this._shaderContentDict[r[o]];n.addContent(h)}}else{n=this._shaderContentDict[s].clone()}for(o=0;o<n.attributeList.length;o++){s=n.attributeList[o].varName;a[s]=n.attributeList[o]}for(o=0;o<n.varyingList.length;o++){s=n.varyingList[o].varName;if(!a[s]){a[s]=n.varyingList[o]}}for(o=0;o<n.tempList.length;o++){s=n.tempList[o].varName;a[s]=n.tempList[o]}for(o=0;o<n.uniformList.length;o++){s=n.uniformList[o].varName;a[s]=n.uniformList[o]}var u;for(o=0;o<n.constList.length;o++){s=n.constList[o].varName;u=n.constList[o];a[s]=u;switch(s){case"max_directLight":u.value=a.maxDirectLight;break;case"max_spotLight":u.value=a.maxSpotLight;break;case"max_pointLight":u.value=a.maxPointLight;break;case"bonesNumber":i.maxBone=a.maxBone;u.value=a.maxBone;break}}for(o=0;o<n.sampler2DList.length;o++){var l=n.sampler2DList[o];l.index=o;a.sampler2DList.push(l);l.activeTextureIndex=e.getTexture2DIndex(o)}for(o=0;o<n.sampler3DList.length;o++){var c=n.sampler3DList[o];c.activeTextureIndex=e.getTexture2DIndex(n.sampler2DList.length+o);c.index=n.sampler2DList.length+o;a.sampler3DList.push(c)}this.synthesisShader(n,i);return t.ShaderPool.getGPUShader(i.shaderType,n.name,n.source)};e.prototype.synthesisShader=function(t,i){var r;var a="";for(r=0;r<t.extensionList.length;r++){a+=e.connectExtension(t.extensionList[r])}a+="precision highp float;            \t\n";for(r=0;r<t.defineList.length;r++){a+=e.connectDefine(t.defineList[r])}for(r=0;r<t.attributeList.length;r++){a+=e.connectAtt(t.attributeList[r])}for(r=0;r<t.structNames.length;r++){a+=e.connectStruct(t.structDict[t.structNames[r]])}for(r=0;r<t.varyingList.length;r++){a+=e.connectVarying(t.varyingList[r])}for(r=0;r<t.tempList.length;r++){a+=e.connectTemp(t.tempList[r])}for(r=0;r<t.constList.length;r++){a+=e.connectConst(t.constList[r])}for(r=0;r<t.uniformList.length;r++){a+=e.connectUniform(t.uniformList[r])}for(r=0;r<t.sampler2DList.length;r++){var n=t.sampler2DList[r];a+=e.connectSampler(n)}for(r=0;r<t.sampler3DList.length;r++){var o=t.sampler3DList[r];a+=e.connectSampler3D(o)}for(r=0;r<t.funcNames.length;r++){a+=t.funcDict[t.funcNames[r]]}t.source=a};e.connectAtt=function(t){return"attribute "+t.valueType+" "+t.name+"; \r\n"};e.connectTemp=function(t){if(t.value!=""){return t.valueType+" "+t.name+" = "+t.value+"; \r\n"}return t.valueType+" "+t.name+"; \r\n"};e.connectStruct=function(t){return t+" \r\n"};e.connectConst=function(t){return"const "+t.valueType+" "+t.name+" = "+t.value+"; \r\n"};e.connectVarying=function(t){return"varying "+t.valueType+" "+t.name+"; \r\n"};e.connectUniform=function(t){return"uniform "+t.valueType+" "+t.name+"; \r\n"};e.connectSampler=function(t){return"uniform sampler2D "+t.name+"; \r\n"};e.connectSampler3D=function(t){return"uniform samplerCube "+t.name+"; \r\n"};e.connectExtension=function(t){return"#extension "+t.name+":"+t.value+"\r\n"};e.connectDefine=function(t){return t.key+" "+t.name+" "+t.value+"\r\n"};e.getTexture2DIndex=function(e){switch(e){case 0:return t.ContextSamplerType.TEXTURE_0;case 1:return t.ContextSamplerType.TEXTURE_1;case 2:return t.ContextSamplerType.TEXTURE_2;case 3:return t.ContextSamplerType.TEXTURE_3;case 4:return t.ContextSamplerType.TEXTURE_4;case 5:return t.ContextSamplerType.TEXTURE_5;case 6:return t.ContextSamplerType.TEXTURE_6;case 7:return t.ContextSamplerType.TEXTURE_7;case 8:return t.ContextSamplerType.TEXTURE_8}throw new Error("texture not big then 8")};e._shaderLibs={};e._methodLibs={};return e}();t.ShaderUtil=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e){this.location=t;this.data=e}return t}();t.KDData=e;var i=function(){function t(){}t.prototype.buildTree=function(t){var e=t.map(function(t){var e=[t.location[0],t.location[1]];e["datum"]=t;return e});this.root=this.treeify(e,0)};t.prototype.treeify=function(t,e){try{var i=t[0].length}catch(t){return null}var a=e%i;t.sort(function(t,e){return t[a]-e[a]});var n=Math.floor(t.length/2);var o=t[n],s=t.slice(0,n),h=t.slice(n+1);return new r(o,a,[this.treeify(s,e+1),this.treeify(h,e+1)],o["datum"])};return t}();t.KDTree=i;var r=function(){function t(t,e,i,r){this.location=t;this.axis=e;this.subnodes=i;this.datum=r}t.prototype.find=function(e,i){i=i||1;var r=new a(i);n(this);return r.values;function n(i){if(i===null)return;var a=t.distance(i.location,e);r.add(i,a);if(e[i.axis]<i.location[i.axis]){n(i.subnodes[0]);var o=i.subnodes[1]}else{n(i.subnodes[1]);var o=i.subnodes[0]}var s=Math.abs(i.location[i.axis]-e[i.axis]);if(!r.isFull()||s<r.maxPriority()){n(o)}}};t.distance=function(t,e){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))};return t}();t.KDNode=r;var a=function(){function t(t){this.capacity=t;this.elements=[]}t.prototype.isFull=function(){return this.elements.length===this.capacity};t.prototype.isEmpty=function(){return this.elements.length===0};t.prototype.maxPriority=function(){return this.elements[this.elements.length-1].priority};Object.defineProperty(t.prototype,"values",{get:function(){return this.elements.map(function(t){return t.value})},enumerable:true,configurable:true});t.prototype.add=function(t,e){var i=this.elements,r={value:t,priority:e};if(this.isEmpty()){i.push(r)}else{for(var a=0;a<i.length;a++){if(e<i[a].priority){i.splice(a,0,r);break}else if(a==i.length-1&&!this.isFull()){i.push(r)}}}this.elements=i.slice(0,this.capacity)};return t}()})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.vertex_ShaderName={};this.fragment_ShaderName={};this.attributes=new Array}t.prototype.build=function(t,e){};t.prototype.onAnimTimeChange=function(){};t.prototype.importShader=function(t,e,i){var r=t?this.vertex_ShaderName:this.fragment_ShaderName;var a=r[e]=r[e]||[];if(a.indexOf(i)==-1){a.push(i)}};t.prototype.afterBuild=function(){};t.prototype.initNode=function(t,e){};t.prototype.update=function(t,e,i){};t.prototype.activeState=function(t,e,i,r,a,n,o){};t.prototype.upload=function(){};t.prototype.dispose=function(){};return t}();t.AnimationNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}return t}();t.AnimationCurve=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._timeEvent=new t.Event3D;this._times=new Array;this._processTimes=new Array;this._timer=0;this._start=false}i.prototype.start=function(){this._timer=0;this._start=true;this._processTimes.length=0;for(var t=0;t<this._times.length;++t){this._processTimes[t]=this._times[t]}};i.prototype.addTimerAxis=function(t){this._times.push(t)};i.prototype.clearTimerAxis=function(){this._times.length=0;this._processTimes.length=0};i.prototype.reset=function(){this._processTimes.length=0;this._timer=0;this._start=false;for(var t=0;t<this._times.length;++t){this._processTimes[t]=this._times[t]}};i.prototype.update=function(t,e){if(!this._start){return}this._timer+=t;console.log(this._timer+"update");for(var r=0;r<this._processTimes.length;++r){if(this._timer>=this._processTimes[r]){this._timeEvent.eventType=i.TIME_EVENT;this._timeEvent.data=this._processTimes[r];this.dispatchEvent(this._timeEvent);this._processTimes.splice(r,1);break}}};i.TIME_EVENT="TimeEvent";return i}(t.EventDispatcher);t.TimerAxis=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["Line"]=0]="Line";t[t["BesselCurve"]=1]="BesselCurve"})(t.CurveType||(t.CurveType={}));var e=t.CurveType;var i=function(){function t(){this.type=e.Line;this.frame=0;this.value=0}return t}();t.AnimCurve=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.frameRate=16;this.speed=1;this.isLoop=true;this.name="";this._propertyArray=[];this._play=false;this._totalTime=0;this._changeFrameTime=0;this._oldFrameIndex=0;this.totalTime=0}t.prototype.IsExist=function(t){for(var e=0;e<this._propertyArray.length;e++){if(this._propertyArray[e].property==t){return true}}return false};t.prototype.addAnimCurve=function(t,e){if(this.IsExist(t)){return false}if(null==e||e.length<=0){return false}var r=new i;r.keyFrames=e;r.property=t;r.target=this._target;r.isLoop=true;r.timePosition=0;r.totalFrame=e[e.length-1].frame;r.totalTime=r.totalFrame*this.frameRate;this.totalTime=Math.max(this.totalTime,r.totalTime);this._propertyArray.push(r);this.updateBindData(r)};t.prototype.removeAnimCurve=function(t){var e=null;for(var i=0;i<this._propertyArray.length;i++){if(this._propertyArray[i].property==t){e=this._propertyArray[i];this._propertyArray.splice(i,1);return e.keyFrames}}};t.prototype.setPropertyLoop=function(t,e){var i=null;for(var r=0;r<this._propertyArray.length;r++){if(this._propertyArray[r].property==t){i=this._propertyArray[r];i.isLoop=e;break}}};t.prototype.bindObject3D=function(t){this._target=t;for(var e=0;e<this._propertyArray.length;e++){this.updateBindData(this._propertyArray[e])}};t.prototype.updateBindData=function(t){if(!this._target){return}t.target=this._target;var e=t.property.split(".");for(var i=0;i<e.length-1;i++){t.target=t.target[e[i]]}t.name=e[e.length-1]};t.prototype.play=function(t,e){if(this._play&&e){return}for(var i=0;i<this._propertyArray.length;i++){this._propertyArray[i].play(t,e)}this._play=true};t.prototype.stop=function(){this._play=false};t.prototype.update=function(t){if(!this._play||!this._target){return}for(var e=0;e<this._propertyArray.length;e++){this._propertyArray[e].update(0,t)}};t.prototype.clone=function(){var e=new t;e._propertyArray=this._propertyArray;e._totalTime=this._totalTime;e.isLoop=this.isLoop;e.speed=this.speed;e.name=this.name;return e};return t}();t.PropertyAnim=e;var i=function(){function t(){this.totalFrame=0;this.totalTime=0;this.frameRate=16;this.time=0;this.offset=0;this._time=0;this._frame=0;this._weight=0;this._frameTime=0;this._speed=1;this._change=false}t.prototype.play=function(t,e){this._change=e;this._speed=t;if(e){this._time=0}};t.prototype.update=function(t,e){var i=this;if(this._change){this._change=false;this.offset=i._time}i._time=i._time-this.offset;i.time=i._time%i.totalTime;i._frameTime=i.time/this.frameRate;i._frame=Math.floor(i._frameTime);i._weight=i._frameTime-i._frame;if(i.keyFrames[i._frame])i.target[i.name]=i.keyFrames[i._frame].value;i._time+=e*this._speed};return t}()})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=null}e.call(this);this._animTime=0;this.speed=1;this.loopTime=0;this.currentAnimName="";this._proAnimDict={};this._event3D=new t.AnimationEvent3D;this._target=i}Object.defineProperty(i.prototype,"target",{get:function(){return this._target},set:function(t){this._target=t;if(t){for(var e in this._proAnimDict){this._proAnimDict[e].bindObject3D(this._target)}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"animTime",{get:function(){return this._animTime},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"propertyAnimController",{get:function(){return this},enumerable:true,configurable:true});i.prototype.isPlay=function(){return true};i.prototype.play=function(t,e,i,r){if(t===void 0){t=""}if(e===void 0){e=1}if(i===void 0){i=true}if(r===void 0){r=true}this.current=this._proAnimDict[t];if(!this.current){for(var a in this._proAnimDict){this.current=this._proAnimDict[a];break}}this.speed=e;if(this.current){this.current.speed=this.speed;if(this.target){this.current.bindObject3D(this.target)}this.currentAnimName=this.current.name;this.current.play(e,i)}};i.prototype.stop=function(){if(this.current){this.current.stop()}this.current=null};i.prototype.update=function(t,e,i){if(this.current){this.current.update(e)}};i.prototype.activeState=function(t,e,i,r,a,n,o){};i.prototype.clone=function(){var t=new i;for(var e in this._proAnimDict){t.addPropertyAnim(this._proAnimDict[e].clone())}return t};Object.defineProperty(i.prototype,"animStateNames",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"animStates",{get:function(){return null},enumerable:true,configurable:true});i.prototype.addAnimState=function(t){};i.prototype.removeAnimState=function(t){};i.prototype.addPropertyAnim=function(t){this._proAnimDict[t.name]=t;t.proAnimController=this;if(this.target){t.bindObject3D(this.target)}this.loopTime=Math.max(this.loopTime,t.totalTime);if(t.isLoop==false){this.isLoop=t.isLoop}};i.prototype.removePropertyAnim=function(t){delete this._proAnimDict[t.name]};i.prototype.doEvent=function(t,e){this._event3D.eventType=t;this._event3D.target=e;this.dispatchEvent(this._event3D)};return i}(t.EventDispatcher);t.PropertyAnimController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.parent=null;this.index=0;this.parentIndex=-1;this.scale=new t.Vector3D(1,1,1);this.orientation=new t.Quaternion;this.translation=new t.Vector3D;this.localMatrix;this.worldMatrix;this.worldMatrixValid=false}e.prototype.buildLocalMatrix=function(e,i,r){this.scale.copyFrom(e);this.translation.copyFrom(r);if(i instanceof t.Vector3D){this.orientation.fromEulerAngles(i.x,i.y,i.z)}else{this.orientation.copyFrom(i)}this.worldMatrixValid=false};e.prototype.buildInverseMatrix=function(e,i,r){if(!this.inverseMatrix){this.inverseMatrix=new t.Matrix4_4}if(i instanceof t.Vector3D){this.inverseMatrix.recompose([r,i,e])}else{this.inverseMatrix.makeTransform(r,e,i)}};e.prototype.copyTo=function(e,i){if(i===void 0){i=t.BindAnimType.all}switch(i){case t.BindAnimType.all:e.localMatrix=this.worldMatrix;break}};return e}();t.Joint=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.joints=[]}Object.defineProperty(t.prototype,"jointNum",{get:function(){return this.joints.length},enumerable:true,configurable:true});t.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++){if(this.joints[e].name==t)return this.joints[e]}return null};t.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++){if(this.joints[e].name==t)return e}return-1};return t}();t.Skeleton=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.joints=[]}e.prototype.calculateJointWorldMatrix=function(){var t=this.joints;var e=t.length;var i=0;for(i;i<e;++i){this.calculateAbsoluteMatrix(t[i],t)}};e.prototype.calculateAbsoluteMatrix=function(e,i){if(e.parentIndex>=0){this.calculateAbsoluteMatrix(i[e.parentIndex],i)}if(!e.worldMatrixValid){if(!e.worldMatrix)e.worldMatrix=new t.Matrix4_4;e.localMatrix=e.localMatrix||new t.Matrix4_4;e.localMatrix.makeTransform(e.translation,e.scale,e.orientation);e.worldMatrix.copyFrom(e.localMatrix);if(e.parentIndex>=0){e.worldMatrix.append(i[e.parentIndex].worldMatrix)}e.worldMatrixValid=true}};e.prototype.updateGPUData=function(e,i,r){var a=e.joints;var n=a.length;var o=this.joints;var s=o.length;var h=this.boneNameArray;for(var u=0;u<n;++u){for(var l=0;l<s;++l){if(a[u].name!=h[l])continue;t.Matrix4_4.helpMatrix.copyFrom(a[u].inverseMatrix);t.Matrix4_4.helpMatrix.append(o[l].worldMatrix);var c=t.Matrix4_4.helpMatrix.decompose(t.Orientation3D.QUATERNION);i[u*8+0]=c[1].x;i[u*8+1]=c[1].y;i[u*8+2]=c[1].z;i[u*8+3]=c[1].w;i[u*8+4]=c[0].x-r.x;i[u*8+5]=c[0].y-r.y;i[u*8+6]=c[0].z-r.z;i[u*8+7]=1;break}}return i};e.prototype.findJoint=function(t){var e=this.findJointIndex(t);if(e>=0){return this.joints[e]}return null};e.prototype.findJointIndex=function(t){if(""==t)return-1;for(var e=0;e<this.boneNameArray.length;e++){if(this.boneNameArray[e]==t)return e}return-1};e.prototype.resetWorldMatrix=function(){var t=this.joints;var e=t.length;for(var i=0;i<e;i++){t[i].worldMatrixValid=false}};e.prototype.getLerpSkeletonPose=function(t,e,i,r,a){var n;var o;n=r.poseArray[t];o=r.poseArray[e];a.mixAnim(n,o,i,a)};e.prototype.mixAnim=function(t,e,i,r){var a;var n;var o=r.joints;for(var s=0;s<t.joints.length;s++){a=t.joints[s];n=e.joints[s];o[s].translation.lerp(a.translation,n.translation,i);o[s].orientation.lerp(a.orientation,n.orientation,i);o[s].worldMatrixValid=false}r.calculateJointWorldMatrix()};e.prototype.copySkeletonPose=function(t,e){var i=e.joints;var r=t.joints;var a=r.length;for(var n=0;n<a;n++){i[n].translation=r[n].translation;i[n].orientation=r[n].orientation;i[n].scale=r[n].scale;i[n].worldMatrixValid=false}e.calculateJointWorldMatrix()};e.prototype.initSkeletonPose=function(e,i){i.joints=i.joints||[];i.jointsDictionary=i.jointsDictionary||{};i.boneNameArray=e.boneNameArray;for(var r=0;r<e.joints.length;r++){var a=new t.Joint;i.joints.push(a);i.jointsDictionary[e.boneNameArray[r]]=a;a.parentIndex=e.joints[r].parentIndex;a.index=e.joints[r].index;a.worldMatrix=a.worldMatrix||new t.Matrix4_4}};e._temp_jointMatrix=new t.Matrix4_4;e._temp_matrixDecomposeA=[new t.Vector3D,new t.Vector3D,new t.Vector3D];return e}();t.SkeletonPose=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.poseArray=[];this.boneNameArray=[];this.animationName="";this.isLoop=false;this.sampling=0;this.boneCount=0;this.frameDataOffset=0;this.totalFrame=0;this.totalTime=0;this.frameRate=33;this.loopPose=false;this.cycleOffset=0;this.sourceData=null;this._skeletonPose=null;this._temp_scale=new t.Vector3D;this._temp_translation=new t.Vector3D;this._temp_orientation=new t.Quaternion;this._cacheAnimationClip=null}Object.defineProperty(e.prototype,"currentSkeletonPose",{get:function(){return this._skeletonPose},enumerable:true,configurable:true});e.prototype.findJointIndex=function(t){if(!this._skeletonPose){if(this.poseArray.length<=0){return-1}return this.poseArray[0].findJointIndex(t)}return this._skeletonPose.findJointIndex(t)};e.prototype.addSkeletonPose=function(t){this.poseArray.push(t)};e.prototype.buildInitialSkeleton=function(e,i,r){if(this._skeletonPose){return}this._skeletonPose=new t.SkeletonPose;this._skeletonPose.boneNameArray=e;for(var a=0;a<this.boneCount;a++){var n=new t.Joint;n.index=a;n.parentIndex=t.EAMVersion.findNameIndex(e,i[a]);this._skeletonPose.joints.push(n)}};e.prototype.getSkeletonPose=function(t){if(this.poseArray.length>0&&this.poseArray.length>t){return this.poseArray[t]}return null};e.prototype.readSkeletonPose=function(t,e){this.sourceData.position=this.frameDataOffset+(40*this.boneCount+4)*t;e.frameTime=this.sourceData.readInt()/60/80*1e3;for(var i=0;i<this.boneCount;i++){this._temp_orientation.x=this.sourceData.readFloat();this._temp_orientation.y=this.sourceData.readFloat();this._temp_orientation.z=this.sourceData.readFloat();this._temp_orientation.w=this.sourceData.readFloat();this._temp_scale.x=this.sourceData.readFloat();this._temp_scale.y=this.sourceData.readFloat();this._temp_scale.z=this.sourceData.readFloat();this._temp_translation.x=this.sourceData.readFloat();this._temp_translation.y=this.sourceData.readFloat();this._temp_translation.z=this.sourceData.readFloat();e.joints[i].worldMatrixValid=false;e.joints[i].buildLocalMatrix(this._temp_scale,this._temp_orientation,this._temp_translation)}e.calculateJointWorldMatrix();return e};Object.defineProperty(e.prototype,"jointNum",{get:function(){if(this.poseArray.length>0){return this.poseArray[0].joints.length}return this.boneCount},enumerable:true,configurable:true});return e}();t.SkeletonAnimationClip=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){this.time=0;this.offset=0;this.speed=1;this.loop=true;this._frameTime=0;this._frame=0;this._time=0;this._nextframe=0;this._lastframe=0;this._weight=0;this._reStart=false;this._end=false;this.cycleTime=0;this.clip=t;this.loop=this.clip.isLoop;this.totalFrame=t.totalFrame;this.totalTime=t.totalTime}e.prototype.reset=function(t){this._reStart=true;this._time=0;this._lastframe=0;this._end=false};e.prototype.reStart=function(){this._reStart=true};e.prototype.update=function(e,i){if(this._reStart){this._reStart=false;this.offset=this._time}this.time=this._time-this.offset;this.time=this.time%this.totalTime;this._frameTime=this.time/this.clip.frameRate;this._frame=Math.floor(this._frameTime);this._weight=this._frameTime-this._frame;this._nextframe=this._frame+1;if(this._nextframe>=this.totalFrame){this._nextframe=0}if(!this._end){var r=this.speed<0?0:this.totalFrame-1;if(this._frame==r&&this._frame!=this._lastframe){if(this.loop){this.animation.dispatchCycle()}else{this._frame=this._nextframe=this.speed<0?0:this.totalFrame-1;this._end=true;this.animation.dispatchComplete()}}}else{this._frame=this._nextframe=this.speed<0?0:this.totalFrame-1}this._lastframe=this._frame;if(t.Egret3DPolicy.useAnimPoseInterpolation){i.getLerpSkeletonPose(this._frame,this._nextframe,this._weight,this.clip,i)}else{i.copySkeletonPose(this.clip.getSkeletonPose(this._frame),i)}this._time+=e*this.speed;if(this._time<0){this._time=this._time%this.totalTime;this._time=this.totalTime+this._time}};return e}();t.AnimClipState=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.nextName="";this.crossA="";this.crossB="";this.blend_startFrame=0;this.blend_endFrame=0;this.crossB_startFrame=0;this.blendTime=0;this.blendStartTime=0;this.totalTime=0}return t}();t.CrossFadeNode=e;var i=function(){function t(){this._frameTime=0;this._frame=0;this._nextFrame=0;this._weight=0;this._offset=0;this._time=0;this._crossFades={}}t.prototype.addCrossFadeNode=function(t){this._crossFades[t.crossA+t.crossB]=t};t.prototype.getNextAnim=function(){var t=this._crossFades["base"];if(t){return"base"}else if(this._currentCrossFadeNode.nextName!=""){return this._currentCrossFadeNode.nextName}else if(this._currentCrossFadeNode.nextName==""){if(this._currentCrossFadeNode.crossB_state.clip.isLoop){return this._currentCrossFadeNode.crossB}}return""};t.prototype.checkCrossFade=function(t,e,i){this._currentCrossFadeNode=this._crossFades[t+e];if(this._currentCrossFadeNode){var r=i[this._currentCrossFadeNode.crossA];var a=i[this._currentCrossFadeNode.crossB];a.reStart();this._currentCrossFadeNode.crossA_state=r;this._currentCrossFadeNode.crossB_state=a;this._currentCrossFadeNode.blendTime=(this._currentCrossFadeNode.blend_endFrame-this._currentCrossFadeNode.blend_startFrame)*33;this._currentCrossFadeNode.blendStartTime=this._currentCrossFadeNode.blend_startFrame*33;this._currentCrossFadeNode.totalTime=Math.max(r.totalFrame,this._currentCrossFadeNode.crossB_startFrame+a.totalFrame)*r.clip.frameRate}return this._currentCrossFadeNode};t.prototype.update=function(t){};return t}();t.CrossFade=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._canTransitionToSelf=false;this._atomic=true;this._time=0;this._weight=0;this.gpuSkeletonPose=null;this.currentAnimName="";this.nextAnimName="";this._reset=false;this._offset=0;this._defaultFade=new t.CrossFadeNode;this._animState={}}e.prototype.addCrossFadeNode=function(e){if(e)this._crossFade=this._crossFade||new t.CrossFade;this._crossFade.addCrossFadeNode(e)};e.prototype.addAnimClip=function(e){if(e.animationName){var i=new t.AnimClipState(e);i.animation=this.animation;this._animState[e.animationName]=i;this._currentState=i}};Object.defineProperty(e.prototype,"animClip",{get:function(){return this._animState},enumerable:true,configurable:true});e.prototype.getCurrentState=function(){return this._currentState};e.prototype.play=function(e,i,r){if(r===void 0){r=false}if(this.currentAnimName==e&&!r)return;var a=this._currentCrossFadeNode;var n;var o;var s=this._defaultFade;this._currentCrossFadeNode=null;if(this._crossFade)this._currentCrossFadeNode=this._crossFade.checkCrossFade(this.currentAnimName,e,this._animState);if(!this._currentCrossFadeNode&&!r){n=this._animState[this.currentAnimName];o=this._animState[e];if(n&&o){this._currentCrossFadeNode=s;s.crossA=this.currentAnimName;s.crossB=e;s.crossA_state=n;s.crossB_state=o;var h=300;s.blend_startFrame=Math.floor((n.totalTime-h)/n.clip.frameRate);s.blend_endFrame=n.totalFrame;s.crossB_startFrame=s.blend_startFrame;s.blendTime=h;s.blendStartTime=s.blend_startFrame*n.clip.frameRate;s.totalTime=s.blendStartTime+o.totalTime}}this.currentAnimName=e;if(this._animState[e]){this._currentState=this._animState[e];this._currentState.speed=i}else{return}this._reset=true;if(!this.gpuSkeletonPose){this.gpuSkeletonPose=new t.SkeletonPose;this.gpuSkeletonPose.initSkeletonPose(this._animState[e].clip.getSkeletonPose(0),this.gpuSkeletonPose)}if(t.Egret3DPolicy.useAnimMixInterpolation&&!this._lerpAPose){this._lerpAPose=new t.SkeletonPose;this.gpuSkeletonPose.initSkeletonPose(this._animState[e].clip.getSkeletonPose(0),this._lerpAPose)}if(t.Egret3DPolicy.useAnimMixInterpolation&&!this._lerpBPose){this._lerpBPose=new t.SkeletonPose;this.gpuSkeletonPose.initSkeletonPose(this._animState[e].clip.getSkeletonPose(0),this._lerpBPose)}};e.prototype.update=function(e,i){if(this._reset){this._reset=false;this._offset=e;this._currentState.reset(e)}if(t.Egret3DPolicy.useAnimMixInterpolation&&this._currentCrossFadeNode){this.mixUpdate(e,i)}else{if(this._currentState){this._currentState.update(i,this.gpuSkeletonPose)}}if(this.bindList){for(var r in this.bindList){var a=this.gpuSkeletonPose.jointsDictionary[r];a.copyTo(this.bindList[r].node,this.bindList[r].type)}}};e.prototype.mixUpdate=function(t,e){var i=this._lerpAPose;var r=this._lerpBPose;var a=this.gpuSkeletonPose;var n=this._currentCrossFadeNode;var o=this._currentCrossFadeNode.crossA_state;var s=this._currentCrossFadeNode.crossB_state;var h=false;var u=false;var l=false;this._time=t-this._offset+n.blendStartTime;if(this._time<=n.totalTime){if(this._time<n.blendStartTime+n.blendTime){h=true}if(this._time>=n.crossB_startFrame*33&&this._time<=n.crossB_startFrame*33+s.totalTime){u=true}if(this._time<=n.blendStartTime+n.blendTime){l=true}if(l){this._weight=(this._time-n.blendStartTime)/n.blendTime;if(this._weight>1){this._weight=1}o.update(e,i);s.update(e,r);a.mixAnim(i,r,this._weight,a)}else{if(h&&!u){o.update(e,a)}else if(u&&!h){s.update(e,a)}}}else{if(this._crossFade)this.play(this._crossFade.getNextAnim(),1);else this._currentCrossFadeNode=null}};e.prototype.clone=function(){var t=new e;var i;for(var r in this._animState){t.addAnimClip(this._animState[r].clip)}t._crossFade=this._crossFade;return t};return e}();t.SkeletonAnimationState=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["translate"]=0]="translate";t[t["rotation"]=1]="rotation";t[t["scale"]=2]="scale";t[t["translate_rotation"]=3]="translate_rotation";t[t["translate_scale"]=4]="translate_scale";t[t["all"]=5]="all"})(t.BindAnimType||(t.BindAnimType={}));var e=t.BindAnimType;var i=function(i){__extends(r,i);function r(e){if(e===void 0){e=null}i.call(this);this.loopTime=0;this.animTime=0;this.speed=1;this.event3D=new t.AnimationEvent3D;this.isLoop=true;this._loopTime=1;this._isPlay=false;this._time=0;this._cacheTime=0;this._cycleEvent=new t.Event3D(t.AnimationEvent3D.CYCLE);this._completeEvent=new t.Event3D(t.AnimationEvent3D.COMPLETE);this._isPlay=false;this._skeletonAnimationState=e||new t.SkeletonAnimationState;e.animation=this;this._movePosition=new t.Vector3D}Object.defineProperty(r.prototype,"skeletonAnimationController",{get:function(){return this},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"state",{get:function(){return this._skeletonAnimationState},enumerable:true,configurable:true});r.prototype.bindToJointPose=function(t,i,r){if(r===void 0){r=e.all}this._skeletonAnimationState.bindList=this._skeletonAnimationState.bindList||{};this._skeletonAnimationState.bindList[t]={node:i,type:r}};r.prototype.play=function(t,e,i,r){if(e===void 0){e=1}if(i===void 0){i=false}if(r===void 0){r=true}this._skeletonAnimationState.play(t,e,i);this._isPlay=true;return true};r.prototype.pause=function(){this._isPlay=false};r.prototype.stop=function(){this._isPlay=false};r.prototype.update=function(t,e,i){if(!this._isPlay)return;if(this._cacheTime!=t){this._cacheTime=t;this.time+=e;this._skeletonAnimationState.update(this.time,e)}};Object.defineProperty(r.prototype,"time",{get:function(){return this._time},set:function(t){this._time=t},enumerable:true,configurable:true});r.prototype.activeState=function(t,e,i,r,a,n,o){var s=this._skeletonAnimationState;if(s&&s.gpuSkeletonPose){s.gpuSkeletonPose.updateGPUData(r.geometry.skeleton,r.geometry.skeletonGPUData,this._movePosition)}if(i.uniform_time){a.uniform1f(i.uniform_time.uniformIndex,t)}if(i.uniform_PoseMatrix)a.uniform4fv(i.uniform_PoseMatrix.uniformIndex,r.geometry.skeletonGPUData)};Object.defineProperty(r.prototype,"jointNum",{get:function(){return 48},enumerable:true,configurable:true});r.prototype.isPlay=function(){return this._isPlay};r.prototype.clone=function(){var t=new r(this._skeletonAnimationState.clone());for(var e in t.state.animClip){t.state.animClip[e].animation=t}return t};r.prototype.addSkeletonAnimationClip=function(t){this.state.addAnimClip(t)};r.prototype.addAnimState=function(t){};r.prototype.removeAnimState=function(t){};r.prototype.addAnim=function(t){};r.prototype.dispatchCycle=function(){this.dispatchEvent(this._cycleEvent)};r.prototype.dispatchComplete=function(){this.dispatchEvent(this._completeEvent)};r.fps=1e3/60;return r}(t.EventDispatcher);t.SkeletonAnimation=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){this.volume=1;this.loop=false;this.pitch=1;i=i||{};if(i.volume)this.volume=i.volume;if(i.loop)this.loop=i.loop;if(i.pitch)this.pitch=i.pitch;this.sound=e;this.paused=false;if(t.AudioManager.instance.hasAudioContext()){this.context=t.AudioManager.instance.context;this.startTime=0;this.startOffset=0;this.source=null;this.gain=this.context.createGain()}else if(t.AudioManager.instance.hasAudio()){if(this.sound.audio){this.source=this.sound.audio.cloneNode(false);this.source.pause()}}}e.prototype.play=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source){throw new Error("Call stop() before calling play()")}this.createSource();if(!this.source){return}this.startTime=this.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration)}else if(t.AudioManager.instance.hasAudio){this.paused=false;this.source.play()}this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch)};e.prototype.pause=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source){this.startOffset+=this.context.currentTime-this.startTime;this.source.stop(0);this.source=null}}else if(t.AudioManager.instance.hasAudio()){if(this.source){this.source.pause()}}this.paused=true};e.prototype.unpause=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source||!this.paused){throw new Error("Call pause() before unpausing.")}this.createSource();if(!this.source){return}this.startTime=this.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch)}else if(t.AudioManager.instance.hasAudio()){this.source.play()}this.paused=false};e.prototype.stop=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source){this.source.stop(0);this.startOffset=0;this.source=null}}else if(t.AudioManager.instance.hasAudio()){if(this.source){this.source.pause();this.source.currentTime=0}}};e.prototype.setLoop=function(t){if(this.source){this.source.loop=t}};e.prototype.setVolume=function(e){
if(this.gain){this.gain.gain.value=e*t.AudioManager.instance.volume}else if(this.source){this.source.volume=e*t.AudioManager.instance.volume}};e.prototype.setPitch=function(e){if(t.AudioManager.instance.hasAudioContext()){if(this.source){this.source.playbackRate.value=e}}else if(t.AudioManager.instance.hasAudio()){if(this.source){this.source.playbackRate=e}}};e.prototype.isPlaying=function(){if(t.AudioManager.instance.hasAudioContext()){return!this.paused}else if(t.AudioManager.instance.hasAudio()){return!this.source.paused}};e.prototype.getDuration=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source){return this.source.buffer.duration}}else if(t.AudioManager.instance.hasAudio()){if(this.source){var e=this.source.duration;if(e===e){return e}}}return 0};e.prototype.createSource=function(){var t=this;if(this.sound.buffer){this.source=this.context.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.gain);this.gain.connect(this.context.destination);if(this.loop){this.source.onended=function(){return t.play()}}}};return e}();t.Channel=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r){e.call(this,i,r);this._position=new t.Vector3D;this._velocity=new t.Vector3D;if(t.AudioManager.instance.hasAudioContext())this._panner=this.context.createPanner();this._maxDistance=1e4;this._minDistance=1;this._rollOffFactor=1;this._listener=new t.Vector3D}Object.defineProperty(i.prototype,"listener",{get:function(){return this._listener},set:function(e){this._listener.copyFrom(e);if(t.AudioManager.instance.hasAudio()){if(this.source){var i=this.fallOff(this._listener,this.position,this.minDistance,this.maxDistance,this.rollOffFactor);this.source.volume=this.volume*i}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"position",{get:function(){return this._position},set:function(e){this._position.copyFrom(e);if(t.AudioManager.instance.hasAudioContext()){this._panner.setPosition(e.x,e.y,e.z)}if(t.AudioManager.instance.hasAudio()){if(this.source){var i=this.fallOff(this._listener,this.position,this.minDistance,this.maxDistance,this.rollOffFactor);this.source.volume=this.volume*i}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copyFrom(e);if(t.AudioManager.instance.hasAudioContext())this._panner.setVelocity(e.x,e.y,e.z)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e;if(t.AudioManager.instance.hasAudioContext())this._panner.maxDistance=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._minDistance},set:function(e){this._minDistance=e;if(t.AudioManager.instance.hasAudioContext())this._panner.refDistance=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t;if(this._panner)this._panner.rolloffFactor=t},enumerable:true,configurable:true});i.prototype.createSource=function(){if(this.sound.buffer){this.source=this.context.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this._panner);this._panner.connect(this.gain);this.gain.connect(this.context.destination)}};i.prototype.fallOff=function(e,i,r,a,n){var o=t.Vector3D.distance(e,i);if(o<r){return 1}else if(o>a){return 0}else{return 1-o/(a-r)}};return i}(t.Channel);t.Channel3d=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(r,a,n){var o=this;if(a===void 0){a=null}if(n===void 0){n=null}e.call(this);this.audio=null;this._event=new t.Event3D;this._success=a;this._error=n;this.isLoaded=false;if(t.AudioManager.instance.hasAudioContext()){if(!t.AudioManager.instance.isSupported(r,this.audio)){console.warn("Audio format not supported");this._event.eventType=i.SOUND_ERROR;this._event.target=this;this.dispatchEvent(this._event);n(this)}else{if(t.AudioManager.instance.context){this.loadAudioFile(r)}}}else if(t.AudioManager.instance.hasAudio()){try{this.audio=new Audio}catch(t){console.warn("No support for Audio element");this._event.eventType=i.SOUND_ERROR;this._event.target=this;this.dispatchEvent(this._event);if(n)n(this);return}if(!t.AudioManager.instance.isSupported(r,this.audio)){console.warn("Audio format not supported");this._event.eventType=i.SOUND_ERROR;this._event.target=this;this.dispatchEvent(this._event);if(n)n(this)}else{this.audio.src=r;this.audio.addEventListener("canplaythrough",function(t){return o.oncanplaythrough(t)});this.audio.addEventListener("ended",function(t){return o.onended(t)});this.audio.load()}}}Object.defineProperty(i.prototype,"buffer",{get:function(){return this._buffer},enumerable:true,configurable:true});i.prototype.loadAudioFile=function(t){var e=this;if(this.xhr==null)this.xhr=new XMLHttpRequest;this.xhr.open("GET",t,true);this.xhr.responseType="arraybuffer";this.xhr.onload=function(t){return e.audioLoadend(t)};this.xhr.send()};i.prototype.audioLoadend=function(e){var i=this;t.AudioManager.instance.context.decodeAudioData(this.xhr.response,function(t){return i.decodeSuccessCallback(t)})};i.prototype.decodeSuccessCallback=function(t){this._buffer=t;this._event.eventType=i.SOUND_SUCCESS;this._event.target=this;this._event.data=t;this.dispatchEvent(this._event);if(this._success){this._success(this)}};i.prototype.onended=function(t){};i.prototype.oncanplaythrough=function(t){if(!this.isLoaded){this.isLoaded=true;this._event.eventType=i.SOUND_SUCCESS;this._event.target=this;this._event.data=t;this.dispatchEvent(this._event);if(this._success){this._success(this)}}};i.SOUND_SUCCESS="SoundSuccess";i.SOUND_ERROR="SoundError";return i}(t.EventDispatcher);t.Sound=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.volume=1;this.codecs=null;if(this.hasAudioContext()){if(typeof AudioContext!=="undefined"){this.context=new AudioContext}}}e.prototype.hasAudio=function(){return typeof Audio!=="undefined"};e.prototype.hasAudioContext=function(){return!!(typeof AudioContext!=="undefined")};e.prototype.isSupported=function(t,e){if(this.codecs==null){if(e==null)e=new Audio;this.codecs={mp3:!!e.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!e.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")}}var i=t.match(/^data:audio\/([^;,]+);/i);if(!i){i=t.split("?",1)[0].match(/\.([^.]+)$/)}if(i){i=i[1].toLowerCase()}return this.codecs[i]};e.prototype.createSound=function(e,i,r){if(i===void 0){i=null}if(r===void 0){r=null}return new t.Sound(e,i,r)};e.prototype.playSound=function(e,i){i=i||{};var r=new t.Channel(e,i);r.play();return r};e.prototype.playSound3d=function(e,i,r){r=r||{};var a=new t.Channel3d(e,r);a.position=i;if(r.volume){a.volume=r.volume}if(r.loop){a.loop=r.loop}if(r.maxDistance){a.maxDistance=r.maxDistance}if(r.minDistance){a.minDistance=r.minDistance}if(r.rollOffFactor){a.rollOffFactor=r.rollOffFactor}a.play();return a};Object.defineProperty(e,"instance",{get:function(){if(this._instance==null){this._instance=new e}return this._instance},enumerable:true,configurable:true});return e}();t.AudioManager=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){if(e===void 0){e=null}if(i===void 0){i=null}this._autoUpdate=true;this._origin=new t.Vector3D(0,0,0);this._speed=300;this._target=e;this._lookAtObject=i}Object.defineProperty(e.prototype,"target",{get:function(){return this._target},set:function(t){if(this._target==t)return;this._target=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"lookAtObject",{get:function(){return this._lookAtObject},set:function(t){if(this._lookAtObject==t)return;this._lookAtObject=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"speed",{get:function(){return this._speed},set:function(t){this._speed=t},enumerable:true,configurable:true});e.prototype.update=function(){};return e}();t.ControllerBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n){if(i===void 0){i=null}if(r===void 0){r=null}if(a===void 0){a=false}if(n===void 0){n=false}e.call(this,i);this._origin=new t.Vector3D(0,0,0);this._lookAtPosition=new t.Vector3D;this._eyesPos=new t.Vector3D;this._up=t.Vector3D.Y_AXIS;this._eyesLength=100;this._rotaEyesLine=new t.Vector3D(0,0,1);this._rotaAngle=new t.Vector3D;this._matRot=new t.Matrix4_4;this._quaRot=new t.Quaternion;this._tempVec=new t.Vector3D;this._matTemp=new t.Matrix4_4;this._mouseDown=false;this._mouseRightDown=false;this._screenMoveStartDetail=new t.Point;this._screenMoveDelay=new t.Point;this._isUpdate=false;this._elapsed=0;this._xAngle=0;this._ctl=false;this._alt=false;this._shift=false;this._needctl=false;this._needalt=false;this._needshift=false;this._keyArray=new Array;this.lookAtOffset=new t.Vector3D(0,0,0);this.firstCamera=false;this._needctl=a;this._needalt=n;if(r)this.lookAtObject=r;else this.lookAtPosition=new t.Vector3D;this._eyesPos.copyFrom(i.position);this._lookAtPosition.copyFrom(r.position.add(this.lookAtOffset,t.MathUtil.CALCULATION_VECTOR3D));this._target.lookAt(this._eyesPos,this._lookAtPosition);t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.mouseMove,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,this.mouseWheel,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseUp,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.mouseDown,this);t.Input.addEventListener(t.KeyEvent3D.KEY_UP,this.keyUp,this);t.Input.addEventListener(t.KeyEvent3D.KEY_DOWN,this.keyDown,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.touchUp,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.touchDown,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.touchMove,this)}i.prototype.mouseMove=function(e){if(this._mouseDown&&(this._needctl?this._ctl:true)){this._rotaAngle.y+=t.Input.mouseOffsetX;this._rotaAngle.x+=t.Input.mouseOffsetY;this._rotaAngle.y%=360;this._rotaAngle.x%=360}};i.prototype.mouseWheel=function(e){if(!this._target){return}var i=this._target;if(!i){return}var r=t.Input.wheelDelta*.1;var a=i.viewPort;switch(i.cameraType){case t.CameraType.orthogonal:var n=a.width-r;var o=a.height-r;i.updateViewport(0,0,n,o);break;case t.CameraType.orthogonalToCenter:var s=a.x-r;var h=a.y-r;var n=a.width-r;var o=a.height-r;i.updateViewport(s,h,n,o);break;case t.CameraType.perspective:this.distance=this._eyesLength-r;break}};i.prototype.mouseUp=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=false;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=false;break}};i.prototype.mouseDown=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=true;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=true;break}};i.prototype.touchMove=function(t){if(t.targetTouches.length==1){this.mouseMove(null)}else{this.mouseWheel(null)}};i.prototype.touchUp=function(t){this._mouseDown=false};i.prototype.touchDown=function(t){this._mouseDown=true};i.prototype.keyDown=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=true;break;case t.KeyCode.Key_A:this._keyArray[1]=true;break;case t.KeyCode.Key_S:this._keyArray[2]=true;break;case t.KeyCode.Key_D:this._keyArray[3]=true;break;case t.KeyCode.Key_Q:this._keyArray[4]=true;break;case t.KeyCode.Key_E:this._keyArray[5]=true;break;case t.KeyCode.Key_Control_L:this._ctl=true;break;case t.KeyCode.Key_Alt_L:this._alt=true;break}};i.prototype.keyUp=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=false;break;case t.KeyCode.Key_A:this._keyArray[1]=false;break;case t.KeyCode.Key_S:this._keyArray[2]=false;break;case t.KeyCode.Key_D:this._keyArray[3]=false;break;case t.KeyCode.Key_Q:this._keyArray[4]=false;break;case t.KeyCode.Key_E:this._keyArray[5]=false;break;case t.KeyCode.Key_Control_L:this._ctl=false;break;case t.KeyCode.Key_Alt_L:this._alt=false;break}};Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(e){if(this._lookAtObject)this._lookAtObject=null;this._lookAtPosition.copyFrom(e.add(this.lookAtOffset,t.MathUtil.CALCULATION_VECTOR3D))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"distance",{get:function(){return this._eyesLength},set:function(t){this._eyesLength=t;if(this._eyesLength<1){this._eyesLength=1}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationX",{get:function(){return this._rotaAngle.x},set:function(t){this._rotaAngle.x=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationY",{get:function(){return this._rotaAngle.y},set:function(t){this._rotaAngle.y=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationZ",{get:function(){return this._rotaAngle.z},set:function(t){this._rotaAngle.z=t},enumerable:true,configurable:true});i.prototype.update=function(e,i){if(e===void 0){e=16.6}if(i===void 0){i=0}if(this._target){if(this._target.isController==false){return}var r=this._speed*(e/1e3);this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0);this._rotaEyesLine.copyFrom(this._quaRot.transformVector(t.Vector3D.Z_AXIS,t.MathUtil.CALCULATION_VECTOR3D));this._rotaEyesLine.normalize();if(this._keyArray[0]){this._tempVec.copyFrom(this._rotaEyesLine);this._tempVec.y=0;this._tempVec.normalize();this._tempVec.scaleBy(r);this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._lookAtObject.position=this._tempVec}if(this._keyArray[1]){this._tempVec.copyFrom(this._rotaEyesLine);this._matTemp.identity();this._matTemp.createByRotation(90,t.Vector3D.Y_AXIS);this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._tempVec.y=0;this._tempVec.normalize();this._tempVec.scaleBy(r);this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._lookAtObject.position=this._tempVec}if(this._keyArray[2]){this._tempVec.copyFrom(this._rotaEyesLine);this._tempVec.y=0;this._tempVec.normalize();this._tempVec.scaleBy(r);this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._lookAtObject.position=this._tempVec}if(this._keyArray[3]){this._tempVec.copyFrom(this._rotaEyesLine);this._matTemp.identity();this._matTemp.createByRotation(90,t.Vector3D.Y_AXIS);this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._tempVec.y=0;this._tempVec.normalize();this._tempVec.scaleBy(r);this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._lookAtObject.position=this._tempVec}if(this._keyArray[4]){this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0);this._tempVec.copyFrom(this._quaRot.transformVector(t.Vector3D.Y_AXIS,t.MathUtil.CALCULATION_VECTOR3D));this._tempVec.normalize();this._tempVec.scaleBy(r);this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._lookAtObject.position=this._tempVec}if(this._keyArray[5]){this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0);this._tempVec.copyFrom(this._quaRot.transformVector(t.Vector3D.Y_AXIS,t.MathUtil.CALCULATION_VECTOR3D));this._tempVec.normalize();this._tempVec.scaleBy(r);this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._lookAtObject.position=this._tempVec}this._lookAtPosition.copyFrom(this._lookAtObject.position);this._tempVec.copyFrom(this._rotaEyesLine);this._tempVec.scaleBy(this._eyesLength);this._eyesPos.copyFrom(this._lookAtPosition.subtract(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));if(this._lookAtObject){this._lookAtPosition.copyFrom(this._lookAtObject.position.add(this.lookAtOffset,t.MathUtil.CALCULATION_VECTOR3D))}this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,this._rotaAngle.z);this._tempVec.copyFrom(this._up);this._tempVec.copyFrom(this._quaRot.transformVector(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D));this._tempVec.normalize();if(this.firstCamera){this._lookAtObject.rotationY=this._rotaAngle.y;this._lookAtObject.rotationX=this._rotaAngle.x}this._target.lookAt(this._eyesPos,this._lookAtPosition,this._tempVec)}};return i}(t.ControllerBase);t.LookAtController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n,o,s,h,u,l,c,f,d){if(i===void 0){i=null}if(r===void 0){r=null}if(a===void 0){a=0}if(n===void 0){n=90}if(o===void 0){o=100}if(s===void 0){s=-90}if(h===void 0){h=90}if(u===void 0){u=NaN}if(l===void 0){l=NaN}if(c===void 0){c=8}if(f===void 0){f=2}if(d===void 0){d=false}e.call(this,i,r);this._currentPanAngle=0;this._currentTiltAngle=90;this._panAngle=0;this._tiltAngle=90;this._distance=1e3;this._minPanAngle=-Infinity;this._maxPanAngle=Infinity;this._minTiltAngle=-90;this._maxTiltAngle=90;this._maxDistance=5e3;this._minDistance=-5e3;this._steps=8;this._yFactor=2;this._wrapPanAngle=false;this._lookAtPosition=new t.Vector3D(0,0,0);this._mouseDown=false;this._mouseRightDown=false;this._keyArray=new Array;this.distance=o;this.panAngle=a;this.tiltAngle=n;this.minPanAngle=u||-Infinity;this.maxPanAngle=l||Infinity;this.minTiltAngle=s;this.maxTiltAngle=h;this.steps=c;this.yFactor=f;this.wrapPanAngle=d;this._currentPanAngle=this._panAngle;this._currentTiltAngle=this._tiltAngle;t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.mouseMove,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,this.mouseWheel,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseUp,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.mouseDown,this);t.Input.addEventListener(t.KeyEvent3D.KEY_UP,this.keyUp,this);t.Input.addEventListener(t.KeyEvent3D.KEY_DOWN,this.keyDown,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.touchUp,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.touchDown,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.touchMove,this)}i.prototype.mouseMove=function(e){if(this._mouseDown){this._tiltAngle+=t.Input.mouseOffsetY*.1;this._tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle));this._panAngle+=t.Input.mouseOffsetX*.1;this._panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle))}};i.prototype.mouseWheel=function(e){var i=this._target;if(!i){return}var r=t.Input.wheelDelta*.1;var a=i.viewPort;switch(i.cameraType){case t.CameraType.orthogonal:var n=a.width-r;var o=a.height-r;i.updateViewport(0,0,n,o);break;case t.CameraType.orthogonalToCenter:var s=a.x-r;var h=a.y-r;var n=a.width-r;var o=a.height-r;i.updateViewport(s,h,n,o);break;case t.CameraType.perspective:this._distance-=r;this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance));break}};i.prototype.mouseUp=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=false;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=false;break}};i.prototype.mouseDown=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=true;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=true;break}};i.prototype.touchMove=function(t){if(t.targetTouches.length==1){this.mouseMove(null)}else{this.mouseWheel(null)}};i.prototype.touchUp=function(t){this._mouseDown=false};i.prototype.touchDown=function(t){this._mouseDown=true};i.prototype.keyDown=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=true;break;case t.KeyCode.Key_A:this._keyArray[1]=true;break;case t.KeyCode.Key_S:this._keyArray[2]=true;break;case t.KeyCode.Key_D:this._keyArray[3]=true;break}};i.prototype.keyUp=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=false;break;case t.KeyCode.Key_A:this._keyArray[1]=false;break;case t.KeyCode.Key_S:this._keyArray[2]=false;break;case t.KeyCode.Key_D:this._keyArray[3]=false;break}};Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtPosition=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"steps",{get:function(){return this._steps},set:function(t){t=t<1?1:t;if(this._steps==t)return;this._steps=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"panAngle",{get:function(){return this._panAngle},set:function(t){t=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,t));if(this._panAngle==t)return;this._panAngle=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(t){t=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,t));if(this._tiltAngle==t)return;this._tiltAngle=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"distance",{get:function(){return this._distance},set:function(t){if(this._distance==t)return;this._distance=this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,t))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"minPanAngle",{get:function(){return this._minPanAngle},set:function(t){if(this._minPanAngle==t)return;this._minPanAngle=t;this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maxPanAngle",{get:function(){return this._maxPanAngle},set:function(t){if(this._maxPanAngle==t)return;this._maxPanAngle=t;this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(t){if(this._minTiltAngle==t)return;this._minTiltAngle=t;this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(t){if(this._maxTiltAngle==t)return;this._maxTiltAngle=t;this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){if(this._maxDistance==t)return;this._maxDistance=t;this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._maxDistance},set:function(t){if(this._minDistance==t)return;this._minDistance=t;this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"yFactor",{get:function(){return this._yFactor},set:function(t){if(this._yFactor==t)return;this._yFactor=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(t){if(this._wrapPanAngle==t)return;this._wrapPanAngle=t},enumerable:true,configurable:true});i.prototype.update=function(e){if(e===void 0){e=true}if(this._tiltAngle!=this._currentTiltAngle||this._panAngle!=this._currentPanAngle){if(this._wrapPanAngle){if(this._panAngle<0)this._panAngle=this._panAngle%360+360;else this._panAngle=this._panAngle%360;if(this._panAngle-this._currentPanAngle<-180)this._currentPanAngle-=360;else if(this._panAngle-this._currentPanAngle>180)this._currentPanAngle+=360}if(e){this._currentTiltAngle+=(this._tiltAngle-this._currentTiltAngle)/(this.steps+1);this._currentPanAngle+=(this._panAngle-this._currentPanAngle)/(this.steps+1)}else{this._currentPanAngle=this._panAngle;this._currentTiltAngle=this._tiltAngle}if(Math.abs(this._tiltAngle-this._currentTiltAngle)<.01&&Math.abs(this._panAngle-this._currentPanAngle)<.01){this._currentTiltAngle=this._tiltAngle;this._currentPanAngle=this._panAngle}}var i=this._lookAtObject?this._lookAtObject.position:this._lookAtPosition?this._lookAtPosition:this._origin;var r=new t.Vector3D;r.x=i.x+this.distance*Math.sin(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS);r.z=i.z+this.distance*Math.cos(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS);r.y=i.y+this.distance*Math.sin(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS)*this.yFactor;if(this._target){if(this._lookAtPosition)this._target.lookAt(r,this._lookAtPosition)}};return i}(t.ControllerBase);t.HoverController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=null}e.call(this,i,null);this.dir=new t.Vector3D;t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.mouseMove,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,this.mouseWheel,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.touchMove,this)}i.prototype.touchMove=function(t){if(t.targetTouches.length==1){this.mouseMove(null)}else{this.mouseWheel(null)}};i.prototype.mouseWheel=function(e){if(!this._target){return}var r=this._target;if(!r){return}var a=t.Input.wheelDelta*.1;var n=r.viewPort;switch(r.cameraType){case t.CameraType.orthogonal:var o=n.width-a;var s=n.height-a;r.updateViewport(0,0,o,s);break;case t.CameraType.orthogonalToCenter:var h=n.x-a;var u=n.y-a;var o=n.width-a;var s=n.height-a;r.updateViewport(h,u,o,s);break;case t.CameraType.perspective:this.target.globalOrientation.transformVector(t.Vector3D.Z_AXIS,this.dir);this.dir.normalize();i.v0.copyFrom(this.dir);i.v0.scaleBy(a);this.target.globalPosition.add(i.v0,i.v0);this.target.globalPosition=i.v0;break}};i.prototype.mouseMove=function(e){if(t.Input.getMousePress(t.MouseCode.Mouse_Left)){this.target.rotationY+=t.Input.mouseOffsetX;this.target.rotationX+=t.Input.mouseOffsetY}};i.prototype.update=function(e,r){if(e===void 0){e=16.6}if(r===void 0){r=0}if(!this.target){return}var a=this.speed*e/1e3;if(t.Input.getKeyPress(t.KeyCode.Key_W)){this.target.globalOrientation.transformVector(t.Vector3D.Z_AXIS,this.dir);this.dir.normalize();i.v0.copyFrom(this.dir);i.v0.scaleBy(a);this.target.globalPosition.add(i.v0,i.v0);this.target.globalPosition=i.v0}if(t.Input.getKeyPress(t.KeyCode.Key_S)){this.target.globalOrientation.transformVector(t.Vector3D.Z_AXIS,this.dir);this.dir.normalize();i.v0.copyFrom(this.dir);i.v0.scaleBy(a);this.target.globalPosition.subtract(i.v0,i.v0);this.target.globalPosition=i.v0}if(t.Input.getKeyPress(t.KeyCode.Key_A)){this.target.globalOrientation.transformVector(t.Vector3D.X_AXIS,this.dir);this.dir.normalize();i.v0.copyFrom(this.dir);i.v0.scaleBy(a);this.target.globalPosition.subtract(i.v0,i.v0);this.target.globalPosition=i.v0}if(t.Input.getKeyPress(t.KeyCode.Key_D)){this.target.globalOrientation.transformVector(t.Vector3D.X_AXIS,this.dir);this.dir.normalize();i.v0.copyFrom(this.dir);i.v0.scaleBy(a);this.target.globalPosition.add(i.v0,i.v0);this.target.globalPosition=i.v0}};i.v0=new t.Vector3D;return i}(t.ControllerBase);t.FreeController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r){e.call(this,null,null);this._step=5;this._panAngle=0;this._down=false;this._startVec3D=new t.Vector3D;this._endVec3D=new t.Vector3D;this._currentVec3D=new t.Vector3D;this._fixinterpolate=new t.Vector3D;this._fix=new t.Vector3D;this._final=new t.Vector3D;this._rotaAngle=new t.Vector3D;this._looat=new t.Vector3D;this._dir=new t.Vector3D;this._up=new t.Vector3D;this._pos=new t.Vector3D;this._maxFov=90;this._minFov=30;this._calQua=new t.Quaternion;this._useCompass=false;this._gyroCtrlloer=new t.OrientationController;this._gyroCtrlloer.start();this._target=r;this._view=i;this._currentVec3D.z=this._final.z=i.camera3D.fieldOfView;t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.mouseMove,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,this.mouseWheel,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseUp,this);t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.mouseDown,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.touchUp,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.touchDown,this);t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.touchMove,this);this.useCompass(true)}i.prototype.mouseDown=function(t){this._down=true};i.prototype.mouseUp=function(t){this._down=false};i.prototype.mouseMove=function(e){if(this._down){this._final.x-=t.Input.mouseOffsetX/(this._step*this._step);this._final.y-=t.Input.mouseOffsetY/(this._step*this._step)}this.useCompass(false)};i.prototype.touchDown=function(t){this._down=true};i.prototype.touchUp=function(t){this._down=false};i.prototype.touchMove=function(e){if(e.targetTouches.length==1){if(this._down){this._final.x-=t.Input.mouseOffsetX/(this._step*this._step);this._final.y-=t.Input.mouseOffsetY/(this._step*this._step)}}else{this.mouseWheel(null)}this.useCompass(false)};i.prototype.mouseWheel=function(e){this._final.z-=t.Input.wheelDelta/(this._step*this._step)};i.prototype.useCompass=function(t){if(t&&t!=this._useCompass){this._useCompass=true;this._target.rotationX=270}else if(!t&&t!=this._useCompass){this._useCompass=false;this._target.rotationX=0}};i.prototype.update=function(e){if(e===void 0){e=true}if(this._useCompass){this._gyroCtrlloer.update(this._view)}else{this._fix.x=this._final.x-this._currentVec3D.y;this._fix.y=this._final.y-this._currentVec3D.x;this._fix.z=this._final.z-this._currentVec3D.z;this._currentVec3D.y+=this._fix.x/this._step;this._currentVec3D.x+=this._fix.y/this._step;this._rotaAngle.x=this._currentVec3D.x;this._rotaAngle.y=this._currentVec3D.y;this._calQua.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0);this._calQua.transformVector(t.Vector3D.Z_AXIS,this._dir);this._calQua.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,this._rotaAngle.z);this._calQua.transformVector(t.Vector3D.Y_AXIS,this._up);this._view.camera3D.lookAt(this._pos,this._dir,this._up);var i=this._currentVec3D.z+this._fix.z/this._step;if(this._maxFov>i&&i>this._minFov)this._currentVec3D.z=i;else this._final.z=this._currentVec3D.z;this._view.camera3D.fieldOfView=this._currentVec3D.z}};return i}(t.ControllerBase);t.PanController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){if(e===void 0){e=null}this.cameraAnimationFrames=[];this._playing=false;this._playTime=0;this._currentFrameIndex=0;this._loop=true;this._smooth=true;this._cameraAnimationFrame=new i;this._event=new t.Event3D;this._quatCurrentFrame=new t.Quaternion;this._quatnNextFrame=new t.Quaternion;this._quatn=new t.Quaternion;this._camera=e;this._cameraAnimationFrame.fov=45;this._cameraAnimationFrame.rotation=new t.Vector3D;this._cameraAnimationFrame.translation=new t.Vector3D}e.prototype.bindCamera=function(t){this._camera=t};e.prototype.play=function(t){if(this.cameraAnimationFrames.length<=0)return;this._loop=t;this._playTime=0;this._camera.isController=false;this._playing=true};e.prototype.stop=function(){this._camera.isController=true;this._playing=false};e.prototype.update=function(t,i){if(!this._playing)return;this._playTime+=i*5;var r=this._playTime%(this.cameraAnimationFrames[this.cameraAnimationFrames.length-1].time-this.cameraAnimationFrames[0].time+160);
var a=Math.floor(r/160)%this.cameraAnimationFrames.length;if(this._currentFrameIndex>a){if(!this._loop){this._playing=false;this._camera.isController=true}if(this._camera){this._event.eventType=e.EVENT_CAMERA_COMPLETE;this._camera.dispatchEvent(this._event)}}this._currentFrameIndex=a;var n=this.cameraAnimationFrames[a];if(this._smooth){var o=(a+1)%this.cameraAnimationFrames.length;var s=this.cameraAnimationFrames[o];var h=(r-n.time)/Math.abs(s.time-n.time);this._cameraAnimationFrame.fov=(s.fov-n.fov)*h+n.fov;this._quatCurrentFrame.fromEulerAngles(n.rotation.x,n.rotation.y,n.rotation.z);this._quatnNextFrame.fromEulerAngles(s.rotation.x,s.rotation.y,s.rotation.z);this._quatn.lerp(this._quatCurrentFrame,this._quatnNextFrame,h);this._quatn.toEulerAngles(this._cameraAnimationFrame.rotation);this._cameraAnimationFrame.translation.lerp(n.translation,s.translation,h)}else{this._cameraAnimationFrame.fov=n.fov;this._cameraAnimationFrame.rotation.copyFrom(n.rotation);this._cameraAnimationFrame.translation.copyFrom(n.translation)}this._camera.rotation=this._cameraAnimationFrame.rotation;this._camera.position=this._cameraAnimationFrame.translation};e.EVENT_CAMERA_COMPLETE="event_camera_complete";return e}();t.CameraAnimationController=e;var i=function(){function t(){}return t}();t.CameraAnimationFrame=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.count=0}t.prototype.incRef=function(){this.count++};t.prototype.decRef=function(){if(this.count-1>=0){this.count--}};Object.defineProperty(t.prototype,"isDispose",{get:function(){return this.count<=0},enumerable:true,configurable:true});return t}();t.Reference=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.version="3.2.2";this.isLost=false;this.DEPTH_TEST=false;this.CULL_FACE=false;this.BLEND=false;this.blend_Factors_src=-1;this.blend_Factors_dst=-1;this.cullingMode=-1;this.depthCompareMode=-1;this.cacheVertexPoint=[];this.cacheVertexFormat=0}e.prototype.register=function(){var i;e.gl.getExtension("WEBGL_depth_texture")||e.gl.getExtension("MOZ_WEBGL_depth_texture")||e.gl.getExtension("WEBKIT_WEBGL_depth_texture");e.gl.getExtension("EXT_texture_filter_anisotropic")||e.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");e.gl.getExtension("WEBGL_compressed_texture_pvrtc")||e.gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");e.gl.getExtension("WEBGL_compressed_texture_etc1");e.gl.getExtension("OES_element_index_uint");e.gl.getExtension("OES_texture_float_linear");i=e.gl.getExtension("OES_texture_float");i=e.gl.getExtension("OES_texture_half_float");e.gl.getExtension("OES_texture_half_float_linear");e.gl.getExtension("OES_standard_derivatives");e.gl.getExtension("GL_OES_standard_derivatives");e.gl.getExtension("WEBGL_draw_buffers");e.gl.getExtension("WEBGL_depth_texture");e.gl.getExtension("WEBGL_lose_context");i=e.gl.getExtension("WEBGL_compressed_texture_s3tc")||e.gl.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");if(i){t.ContextConfig.ColorFormat_DXT1_RGB=i.COMPRESSED_RGB_S3TC_DXT1_EXT;t.ContextConfig.ColorFormat_DXT1_RGBA=i.COMPRESSED_RGBA_S3TC_DXT1_EXT;t.ContextConfig.ColorFormat_DXT3_RGBA=i.COMPRESSED_RGBA_S3TC_DXT3_EXT;t.ContextConfig.ColorFormat_DXT5_RGBA=i.COMPRESSED_RGBA_S3TC_DXT5_EXT}t.ContextConfig.BLEND=e.gl.BLEND;t.DrawMode.TRIANGLES=e.gl.TRIANGLES;t.DrawMode.POINTS=e.gl.POINTS;t.DrawMode.LINES=e.gl.LINES;t.DrawMode.LINE_STRIP=e.gl.LINE_STRIP;t.ContextConfig.FLOAT=e.gl.FLOAT;t.ContextConfig.UNSIGNED_BYTE=e.gl.UNSIGNED_BYTE;t.ContextConfig.VERTEX_SHADER=e.gl.VERTEX_SHADER;t.ContextConfig.FRAGMENT_SHADER=e.gl.FRAGMENT_SHADER;t.ContextConfig.FRONT=e.gl.FRONT;t.ContextConfig.BACK=e.gl.BACK;t.ContextConfig.FRONT_AND_BACK=e.gl.FRONT_AND_BACK;t.ContextConfig.DEPTH_BUFFER_BIT=e.gl.DEPTH_BUFFER_BIT;t.ContextConfig.ELEMENT_ARRAY_BUFFER=e.gl.ELEMENT_ARRAY_BUFFER;t.ContextConfig.UNSIGNED_SHORT=e.gl.UNSIGNED_SHORT;t.ContextConfig.NEAREST=e.gl.NEAREST;t.ContextConfig.REPEAT=e.gl.REPEAT;t.ContextConfig.ONE=e.gl.ONE;t.ContextConfig.ZERO=e.gl.ZERO;t.ContextConfig.SRC_ALPHA=e.gl.SRC_ALPHA;t.ContextConfig.ONE_MINUS_SRC_ALPHA=e.gl.ONE_MINUS_SRC_ALPHA;t.ContextConfig.SRC_COLOR=e.gl.SRC_COLOR;t.ContextConfig.ONE_MINUS_SRC_COLOR=e.gl.ONE_MINUS_SRC_COLOR;t.ContextConfig.ColorFormat_RGB565=e.gl.RGB565;t.ContextConfig.ColorFormat_RGBA5551=e.gl.RGB5_A1;t.ContextConfig.ColorFormat_RGBA4444=e.gl.RGBA4;t.ContextConfig.ColorFormat_RGBA8888=e.gl.RGBA;t.ContextConfig.ColorFormat_RGB888=e.gl.RGB;t.ContextConfig.DEPTH_TEST=e.gl.DEPTH_TEST;t.ContextConfig.CULL_FACE=e.gl.CULL_FACE;t.ContextConfig.BLEND=e.gl.BLEND;t.ContextConfig.LEQUAL=e.gl.LEQUAL;t.ContextSamplerType.TEXTURE_0=e.gl.TEXTURE0;t.ContextSamplerType.TEXTURE_1=e.gl.TEXTURE1;t.ContextSamplerType.TEXTURE_2=e.gl.TEXTURE2;t.ContextSamplerType.TEXTURE_3=e.gl.TEXTURE3;t.ContextSamplerType.TEXTURE_4=e.gl.TEXTURE4;t.ContextSamplerType.TEXTURE_5=e.gl.TEXTURE5;t.ContextSamplerType.TEXTURE_6=e.gl.TEXTURE6;t.ContextSamplerType.TEXTURE_7=e.gl.TEXTURE7;t.ContextSamplerType.TEXTURE_8=e.gl.TEXTURE8;console.log("requst GPU Config",e.gl);t.ShaderPool.register(this)};e.prototype.viewPort=function(i,r,a,n){e.gl.viewport(i,t.ContextConfig.canvasRectangle.height-n-r,a,n)};e.prototype.creatProgram=function(i,r){var a=e.gl.createProgram();e.gl.attachShader(a,i.shader);e.gl.attachShader(a,r.shader);e.gl.linkProgram(a);var n=e.gl.getProgramParameter(a,e.gl.LINK_STATUS);if(!n){alert("vsShader error"+e.gl.getShaderInfoLog(i.shader));alert("fsShader error"+e.gl.getShaderInfoLog(r.shader))}var o=new t.Program3D(a);return o};e.prototype.creatIndexBuffer=function(i){var r=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,r);e.gl.bufferData(e.gl.ELEMENT_ARRAY_BUFFER,i,e.gl.STATIC_DRAW);var a=new t.IndexBuffer3D(r);a.arrayBuffer=i;return a};e.prototype.uploadIndexBuffer=function(t){e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,t.buffer);e.gl.bufferData(e.gl.ELEMENT_ARRAY_BUFFER,t.arrayBuffer,e.gl.DYNAMIC_DRAW)};e.prototype.creatVertexBuffer=function(i,r){if(r===void 0){r=e.gl.STATIC_DRAW}var a=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ARRAY_BUFFER,a);e.gl.bufferData(e.gl.ARRAY_BUFFER,i,r);var n=new t.VertexBuffer3D(a);n.arrayBuffer=i;return n};e.prototype.uploadVertexBuffer=function(t){e.gl.bindBuffer(e.gl.ARRAY_BUFFER,t.buffer);e.gl.bufferData(e.gl.ARRAY_BUFFER,t.arrayBuffer,e.gl.DYNAMIC_DRAW)};e.prototype.texParameteri=function(t,i,r){e.gl.texParameteri(t,i,r)};e.prototype.upLoadTextureData=function(i,r){e.gl.bindTexture(e.gl.TEXTURE_2D,r.texture2D.textureBuffer);if(r.texture2D.internalFormat==t.InternalFormat.ImageData){e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,e.gl.RGBA,r.texture2D.dataFormat,r.texture2D.imageData)}else if(r.texture2D.internalFormat==t.InternalFormat.CompressData){this.upLoadCompressedTexture2D(i,r.texture2D)}else if(r.texture2D.internalFormat==t.InternalFormat.PixelArray){e.gl.texImage2D(e.gl.TEXTURE_2D,i,r.texture2D.colorFormat,r.texture2D.mimapData[i].width,r.texture2D.mimapData[i].height,r.texture2D.border,r.texture2D.colorFormat,r.texture2D.dataFormat,r.texture2D.mimapData[i].data)}if(r.useMipmap)e.gl.generateMipmap(e.gl.TEXTURE_2D)};e.prototype.upLoadCompressedTexture2D=function(t,i){e.gl.compressedTexImage2D(e.gl.TEXTURE_2D,t,i.colorFormat,i.mimapData[t].width,i.mimapData[t].height,i.border,i.mimapData[t].data)};e.prototype.creatTexture=function(){return e.gl.createTexture()};e.prototype.uploadCubetexture=function(t){e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,t.texture);if(t.image_right.mimapData&&t.image_right.mimapData.length>0)e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,e.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data);else e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.imageData);if(t.image_left.mimapData&&t.image_left.mimapData.length>0)e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data);else e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_left.imageData);if(t.image_left.mimapData&&t.image_left.mimapData.length>0)e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e.gl.RGB,t.image_up.mimapData[0].width,t.image_up.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_up.mimapData[0].data);else e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_up.imageData);if(t.image_left.mimapData&&t.image_left.mimapData.length>0)e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e.gl.RGB,t.image_down.mimapData[0].width,t.image_down.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_down.mimapData[0].data);else e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_down.imageData);if(t.image_left.mimapData&&t.image_left.mimapData.length>0)e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e.gl.RGB,t.image_back.mimapData[0].width,t.image_back.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_back.mimapData[0].data);else e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_back.imageData);if(t.image_left.mimapData&&t.image_left.mimapData.length>0)e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e.gl.RGB,t.image_front.mimapData[0].width,t.image_front.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_front.mimapData[0].data);else e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_front.imageData);e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_MAG_FILTER,e.gl.LINEAR);e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_MIN_FILTER,e.gl.LINEAR);e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_WRAP_S,e.gl.CLAMP_TO_EDGE);e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_WRAP_T,e.gl.CLAMP_TO_EDGE)};e.prototype.createFramebuffer=function(i,r,a,n){var o=e.gl;var s=o.createRenderbuffer();var h=o.createTexture();o.bindTexture(o.TEXTURE_2D,h);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);o.texImage2D(o.TEXTURE_2D,0,o.RGBA,i,r,0,o.RGBA,o.UNSIGNED_BYTE,null);var u=o.createFramebuffer();o.bindFramebuffer(o.FRAMEBUFFER,u);o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,h,0);o.bindRenderbuffer(o.RENDERBUFFER,s);o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,i,r);o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,s);var l=new t.ContextTexture2D;l.width=i;l.height=r;l.textureBuffer=h;l.frameBuffer=u;l.renderbuffer=s;o.bindFramebuffer(o.FRAMEBUFFER,null);o.bindTexture(o.TEXTURE_2D,null);o.bindRenderbuffer(o.RENDERBUFFER,null);return l};e.prototype.setRenderToTexture=function(t,i,r,a){if(i===void 0){i=false}if(r===void 0){r=false}if(a===void 0){a=0}var n=e.gl;e.gl.viewport(0,0,t.width,t.height);e.gl.scissor(0,0,t.width,t.height);n.bindFramebuffer(e.gl.FRAMEBUFFER,t.frameBuffer);n.framebufferTexture2D(e.gl.FRAMEBUFFER,e.gl.COLOR_ATTACHMENT0,e.gl.TEXTURE_2D,t.textureBuffer,0);if(i){n.clearColor(0,0,0,0);n.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT)}};e.prototype.setRenderToBackBuffer=function(){e.gl.bindTexture(e.gl.TEXTURE_2D,null);e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null)};e.prototype.creatVertexShader=function(i){var r=e.gl.createShader(e.gl.VERTEX_SHADER);e.gl.shaderSource(r,i);e.gl.compileShader(r);var a=new t.Shader(r);a.id=(t.Shader.ID_COUNT++).toString();return a};e.prototype.creatFragmentShader=function(i){var r=e.gl.createShader(e.gl.FRAGMENT_SHADER);e.gl.shaderSource(r,i);e.gl.compileShader(r);var a=new t.Shader(r);a.id=(t.Shader.ID_COUNT++).toString();return a};e.prototype.clear=function(t){e.gl.clear(t)};e.prototype.clearColor=function(t,i,r,a){e.gl.clearColor(t,i,r,a)};e.prototype.clearStencil=function(t){e.gl.clearStencil(t)};e.prototype.setProgram=function(t){this.programChange=false;if(this.program==t)return;this.programChange=true;this.program=t;e.gl.useProgram(t.program)};e.prototype.getUniformLocation=function(t,i){return e.gl.getUniformLocation(t.program,i)};e.prototype.uniform1f=function(t,i){e.gl.uniform1f(t,i)};e.prototype.uniform1fv=function(t,i){e.gl.uniform1fv(t,i)};e.prototype.uniform1i=function(t,i){e.gl.uniform1i(t,i)};e.prototype.uniform1iv=function(t,i){e.gl.uniform1iv(t,i)};e.prototype.uniform2f=function(t,i,r){e.gl.uniform2f(t,i,r)};e.prototype.uniform2fv=function(t,i){e.gl.uniform2fv(t,i)};e.prototype.uniform2i=function(t,i,r){e.gl.uniform2i(t,i,r)};e.prototype.uniform2iv=function(t,i){e.gl.uniform2iv(t,i)};e.prototype.uniform3f=function(t,i,r,a){e.gl.uniform3f(t,i,r,a)};e.prototype.uniform3fv=function(t,i){e.gl.uniform3fv(t,i)};e.prototype.uniform3i=function(t,i,r,a){e.gl.uniform3i(t,i,r,a)};e.prototype.uniform3iv=function(t,i){e.gl.uniform3iv(t,i)};e.prototype.uniform4f=function(t,i,r,a,n){e.gl.uniform4f(t,i,r,a,n)};e.prototype.uniform4fv=function(t,i){e.gl.uniform4fv(t,i)};e.prototype.uniform4i=function(t,i,r,a,n){e.gl.uniform4i(t,i,r,a,n)};e.prototype.uniform4iv=function(t,i){e.gl.uniform4iv(t,i)};e.prototype.uniformMatrix2fv=function(t,i,r){e.gl.uniformMatrix2fv(t,i,r)};e.prototype.uniformMatrix3fv=function(t,i,r){e.gl.uniformMatrix3fv(t,i,r)};e.prototype.uniformMatrix4fv=function(t,i,r){e.gl.uniformMatrix4fv(t,i,r)};e.prototype.setBlendFactors=function(t,i){if(this.blend_Factors_src==t&&this.blend_Factors_dst==i)return;this.blend_Factors_src=t;this.blend_Factors_dst=i;e.gl.blendFunc(t,i)};e.prototype.setCulling=function(t){if(this.cullingMode==t)return;this.cullingMode=t;e.gl.cullFace(t)};e.prototype.enableDepth=function(){if(this.DEPTH_TEST)return;this.DEPTH_TEST=true;e.gl.enable(t.ContextConfig.DEPTH_TEST)};e.prototype.disableDepth=function(){if(!this.DEPTH_TEST)return;this.DEPTH_TEST=false;e.gl.disable(t.ContextConfig.DEPTH_TEST)};e.prototype.enableCullFace=function(){if(this.CULL_FACE)return;this.CULL_FACE=true;e.gl.enable(t.ContextConfig.CULL_FACE)};e.prototype.disableCullFace=function(){if(!this.CULL_FACE)return;this.CULL_FACE=false;e.gl.disable(t.ContextConfig.CULL_FACE)};e.prototype.enableBlend=function(){if(this.BLEND)return;this.BLEND=true;e.gl.enable(t.ContextConfig.BLEND)};e.prototype.disableBlend=function(){if(!this.BLEND)return;this.BLEND=false;e.gl.disable(t.ContextConfig.BLEND)};e.prototype.depthFunc=function(t){if(t===void 0){t=0}if(this.depthCompareMode==t)return;this.depthCompareMode=t;e.gl.depthFunc(t)};e.prototype.enableDepthTest=function(t,i){if(i===void 0){i=0}if(t)e.gl.enable(e.gl.DEPTH_TEST)};e.prototype.getShaderAttribLocation=function(t,i){return e.gl.getAttribLocation(t.program,i)};e.prototype.vertexAttribPointer=function(t,i,r,a,n,o){e.gl.vertexAttribPointer(t,i,r,a,n,o);e.gl.enableVertexAttribArray(t)};e.prototype.activeAttribPointer=function(t,e){for(var i=0;i<8;i++){}this.cacheVertexFormat=t;return this.cacheVertexFormat==t};e.prototype.disAttribPointer=function(){for(var t=0;t<8;t++){e.gl.disableVertexAttribArray(t)}};e.prototype.setVertexShaderConstData=function(t,i,r){e.gl.vertexAttrib4fv(i,t.subarray(i,r))};e.prototype.setFragmentShaderConstData=function(t,e,i){};e.prototype.setTexture2DAt=function(t,i,r,a){e.gl.activeTexture(t);e.gl.bindTexture(e.gl.TEXTURE_2D,a.textureBuffer);e.gl.uniform1i(i,r)};e.prototype.disableTexture2DAt=function(t,e,i){};e.prototype.setCubeTextureAt=function(t,i,r,a){if(!a){return}e.gl.activeTexture(t);e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,a.texture);e.gl.uniform1i(i,r)};e.prototype.setScissorRectangle=function(i,r,a,n){e.gl.scissor(i,t.ContextConfig.canvasRectangle.height-n-r,a,n)};e.prototype.setStencilReferenceValue=function(){};e.prototype.setStencilActions=function(t,e,i,r,a){};e.prototype.bindVertexBuffer=function(t){e.gl.bindBuffer(e.gl.ARRAY_BUFFER,t.buffer)};e.prototype.bindIndexBuffer=function(t){e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,t.buffer)};e.prototype.drawArrays=function(t,i,r){e.gl.drawArrays(t,i,r)};e.prototype.drawElement=function(t,i,r){e.gl.drawElements(t,r,e.gl.UNSIGNED_SHORT,i)};e.prototype.flush=function(){e.gl.flush()};return e}();t.Context3DProxy=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}return t}();t.FrameBuffer=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){this.buffer=t}e.prototype.dispose=function(){if(this.buffer){t.Context3DProxy.gl.deleteBuffer(this.buffer);this.buffer=null}if(this.arrayBuffer){delete this.arrayBuffer;this.arrayBuffer=null}};return e}();t.IndexBuffer3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){this.buffer=t}e.prototype.dispose=function(){if(this.buffer){t.Context3DProxy.gl.deleteBuffer(this.buffer);this.buffer=null}if(this.arrayBuffer){delete this.arrayBuffer;this.arrayBuffer=null}};return e}();t.VertexBuffer3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e,i){this.data=t;this.width=e;this.height=i}return t}();t.MipmapData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){this.program=t}e.prototype.dispose=function(){if(this.program){t.Context3DProxy.gl.deleteProgram(this.program);this.program=null}};return e}();t.Program3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){this._shader=t}Object.defineProperty(e.prototype,"shader",{get:function(){return this._shader},enumerable:true,configurable:true});e.prototype.dispose=function(){if(this._shader){t.Context3DProxy.gl.deleteShader(this._shader);this._shader=null}};e.vertex=0;e.fragment=1;e.ID_COUNT=0;return e}();t.Shader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.border=0;this.imageData=null}e.prototype.dispose=function(){if(this.textureBuffer){t.Context3DProxy.gl.deleteTexture(this.textureBuffer);this.textureBuffer=null}if(this.frameBuffer){t.Context3DProxy.gl.deleteFramebuffer(this.frameBuffer);this.frameBuffer=null}if(this.renderbuffer){t.Context3DProxy.gl.deleteRenderbuffer(this.renderbuffer);this.renderbuffer=null}};return e}();t.ContextTexture2D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.border=0;this.useMipmap=true;this.colorformat=t.ContextConfig.ColorFormat_RGBA8888;this.internalformat=t.InternalFormat.PixelArray;this.mimapData=new Array}e.prototype.dispose=function(){if(this.texture){t.Context3DProxy.gl.deleteTexture(this.texture);this.texture=null}if(this.image_front){this.image_front.dispose();this.image_front=null}if(this.image_back){this.image_back.dispose();this.image_back=null}if(this.image_left){this.image_left.dispose();this.image_left=null}if(this.image_right){this.image_right.dispose();this.image_right=null}if(this.image_up){this.image_up.dispose();this.image_up=null}if(this.image_down){this.image_down.dispose();this.image_down=null}};return e}();t.ContextTexture3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["BoundPick"]=0]="BoundPick";t[t["PositionPick"]=1]="PositionPick";t[t["UVPick"]=2]="UVPick"})(t.PickType||(t.PickType={}));var e=t.PickType;(function(t){t[t["DISABLE"]=0]="DISABLE";t[t["X_AXIS"]=1]="X_AXIS";t[t["Y_AXIS"]=2]="Y_AXIS";t[t["Z_AXIS"]=3]="Z_AXIS";t[t["STANDARD"]=4]="STANDARD"})(t.BillboardType||(t.BillboardType={}));var i=t.BillboardType;var r=function(r){__extends(a,r);function a(){r.call(this);this._modelMatrix3D=new t.Matrix4_4;this._localMatrix3D=new t.Matrix4_4;this._transformChange=true;this._pos=new t.Vector3D;this._rot=new t.Vector3D;this._sca=new t.Vector3D(1,1,1);this._orientation=new t.Quaternion;this._axis=new t.Vector3D;this._angle=0;this._globalPos=new t.Vector3D;this._globalRot=new t.Vector3D;this._globalSca=new t.Vector3D(1,1,1);this._globalOrientation=new t.Quaternion;this._qut=new t.Quaternion;this._vec=new t.Vector3D;this._active=false;this._isRoot=true;this.inFrustum=false;this.billboard=i.DISABLE;this.canPick=false;this.renderLayer=0;this.name="";this.id=0;this.layer=0;this.tag=new t.Tag;this.parent=null;this.childs=new Array;this.isController=true;this.visible=true;this.pickType=e.BoundPick;this.pickResult=new t.PickResult;this.enablePick=false;this.mouseChildren=false;this.enableCulling=true;this.id=++a.s_id;this._modelMatrix3D.identity()}Object.defineProperty(a.prototype,"proAnimation",{get:function(){return this._proAnimation},set:function(t){this.setProAnimation(t)},enumerable:true,configurable:true});a.prototype.setProAnimation=function(t){this._proAnimation=t;if(this._proAnimation){this._proAnimation.propertyAnimController.target=this}};Object.defineProperty(a.prototype,"bound",{get:function(){return this._bound},set:function(t){if(this._bound==t){return}if(this._bound){this._bound.dispose()}this._bound=t},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"currentBound",{get:function(){if(this.mouseChildren){return this.bound.childBound}return this.bound},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"position",{get:function(){return this._pos},set:function(t){if(this._pos.x==t.x&&this._pos.y==t.y&&this._pos.z==t.z){return}this.updateTransformChange(true);this._pos.copyFrom(t)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rot},set:function(t){if(this._rot.x==t.x&&this._rot.y==t.y&&this._rot.z==t.z){return}this._rot.x=t.x;this._rot.y=t.y;this._rot.z=t.z;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"orientation",{get:function(){return this._orientation},set:function(t){if(this._orientation.x==t.x&&this._orientation.y==t.y&&this._orientation.z==t.z&&this._orientation.w==t.w){return}this._orientation.copyFrom(t);this._orientation.toEulerAngles(this._rot);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"orientationX",{set:function(t){if(this._orientation.x==t){return}this._orientation.x=t;this._orientation.toEulerAngles(this._rot);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"orientationY",{set:function(t){if(this._orientation.y==t){return}this._orientation.y=t;this._orientation.toEulerAngles(this._rot);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"orientationZ",{set:function(t){if(this._orientation.z==t){return}this._orientation.z=t;this._orientation.toEulerAngles(this._rot);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"orientationW",{set:function(t){if(this._orientation.w==t){return}this._orientation.w=t;this._orientation.toEulerAngles(this._rot);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"scale",{get:function(){return this._sca},set:function(t){if(this._sca.x==t.x&&this._sca.y==t.y&&this._sca.z==t.z){return}this.updateTransformChange(true);this._sca=t},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"x",{get:function(){return this._pos.x},set:function(t){if(this._pos.x==t)return;this._pos.x=t;this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"y",{get:function(){return this._pos.y},set:function(t){if(this._pos.y==t)return;this._pos.y=t;this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"z",{get:function(){return this._pos.z},set:function(t){if(this._pos.z==t)return;this._pos.z=t;this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"rotationX",{get:function(){return this._rot.x},set:function(t){if(this._rot.x==t)return;this._rot.x=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"rotationY",{get:function(){return this._rot.y},set:function(t){if(this._rot.y==t)return;this._rot.y=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"rotationZ",{get:function(){return this._rot.z},set:function(t){if(this._rot.z==t)return;this._rot.z=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this._angle=this._orientation.toAxisAngle(this._axis);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"scaleX",{get:function(){return this._sca.x},set:function(t){if(this._sca.x==t)return;this._sca.x=t;this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"scaleY",{get:function(){return this._sca.y},set:function(t){if(this._sca.y==t)return;this._sca.y=t;this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"scaleZ",{get:function(){return this._sca.z},set:function(t){if(this._sca.z==t)return;this._sca.z=t;this.updateTransformChange(true)},enumerable:true,configurable:true});a.prototype.setRotationFromAxisAngle=function(t,e){t.normalize();this.updateTransformChange(true);this._orientation.fromAxisAngle(t,e);this._orientation.toEulerAngles(this._rot);this._axis.copyFrom(t);this._angle=e};Object.defineProperty(a.prototype,"modelMatrix",{get:function(){if(this._transformChange){this.updateModelMatrix()}return this._modelMatrix3D},set:function(e){var i=e.decompose(t.Orientation3D.QUATERNION);this.globalPosition=i[0];t.MathUtil.CALCULATION_QUATERNION.x=i[1].x;t.MathUtil.CALCULATION_QUATERNION.y=i[1].y;t.MathUtil.CALCULATION_QUATERNION.z=i[1].z;t.MathUtil.CALCULATION_QUATERNION.w=i[1].w;this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION;this.globalScale=i[2]},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"localMatrix",{get:function(){this.modelMatrix;return this._localMatrix3D},set:function(e){var i=e.decompose(t.Orientation3D.QUATERNION);this.position=i[0];a.qua0.setTo(i[1].x,i[1].y,i[1].z,i[1].w);this.orientation=a.qua0;this.scale=i[2]},enumerable:true,configurable:true});a.prototype.updateModelMatrix=function(){if(this.parent!=null){var t=this.parent.globalOrientation;this._globalOrientation.multiply(t,this._orientation);this._globalOrientation.toEulerAngles(this._globalRot);var e=this.parent.globalScale;this._globalSca.copyFrom(e.multiply(this._sca,a.v0));t.transformVector(e.multiply(this._pos,a.v0),this._globalPos);this._globalPos.copyFrom(this._globalPos.add(this.parent.globalPosition,a.v0))}else{this._globalOrientation.copyFrom(this._orientation);this._globalPos.copyFrom(this._pos);this._globalSca.copyFrom(this._sca);this._globalRot.copyFrom(this._rot)}this.onMakeTransform();this._transformChange=false;this.onUpdateTransform()};a.prototype.onUpdateTransform=function(){};a.prototype.onMakeTransform=function(){this._localMatrix3D.makeTransform(this._pos,this._sca,this._orientation);this._modelMatrix3D.makeTransform(this._globalPos,this._globalSca,this._globalOrientation)};Object.defineProperty(a.prototype,"globalX",{get:function(){return this.globalPosition.x},set:function(t){this._vec.copyFrom(this.globalPosition);this._vec.x=t;this.globalPosition=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalY",{get:function(){return this.globalPosition.y},set:function(t){this._vec.copyFrom(this.globalPosition);this._vec.y=t;this.globalPosition=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalZ",{get:function(){return this.globalPosition.z},set:function(t){this._vec.copyFrom(this.globalPosition);this._vec.z=t;this.globalPosition=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalPosition",{get:function(){if(this._transformChange){this.modelMatrix}return this._globalPos},set:function(t){if(this.parent){this.parent.globalOrientation.inverse(this._qut);t.subtract(this.parent.globalPosition,this._vec);this._qut.transformVector(this._vec,this._vec);this._vec.divided(this.parent.globalScale,this._vec);this.position=this._vec}else{this.position=t}},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalRotationX",{get:function(){return this.globalRotation.x},set:function(t){this._vec.copyFrom(this.globalRotation);this._vec.x=t;this.globalRotation=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalRotationY",{get:function(){return this.globalRotation.y},set:function(t){this._vec.copyFrom(this.globalRotation);this._vec.y=t;this.globalRotation=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalRotationZ",{get:function(){return this.globalRotation.z},set:function(t){this._vec.copyFrom(this.globalRotation);this._vec.z=t;this.globalRotation=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalRotation",{get:function(){if(this._transformChange){this.modelMatrix}return this._globalRot},set:function(e){t.MathUtil.CALCULATION_QUATERNION.fromEulerAngles(e.x,e.y,e.z);this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalScale",{get:function(){if(this._transformChange){this.modelMatrix}return this._globalSca},set:function(t){if(this.parent){t.divided(this.parent.globalScale,this._vec);this.scale=this._vec}else{this.scale=t}},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalScaleX",{get:function(){return this.globalScale.x},set:function(t){this._vec.copyFrom(this.globalScale);this._vec.x=t;this.globalScale=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalScaleY",{get:function(){return this.globalScale.y},set:function(t){this._vec.copyFrom(this.globalScale);this._vec.y=t;this.globalScale=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalScaleZ",{get:function(){return this.globalScale.z},set:function(t){this._vec.copyFrom(this.globalScale);this._vec.z=t;this.globalScale=this._vec},enumerable:true,configurable:true});Object.defineProperty(a.prototype,"globalOrientation",{get:function(){if(this._transformChange){this.modelMatrix}return this._globalOrientation},set:function(t){if(this.parent){this.parent.globalOrientation.inverse(this._qut);this._qut.multiply(this._qut,t);this.orientation=this._qut}else{this.orientation=t}},enumerable:true,configurable:true});a.prototype.addChild=function(t){if(t.parent){t.parent.removeChild(t)}if(this.childs.indexOf(t)>=0){this.removeChild(t)}this.childs.push(t);t.parent=this;t._isRoot=false;t.updateTransformChange(true);return t};a.prototype.addChildAt=function(t,e){if(e<0){this.childs.splice(0,0,t)}else if(e>=this.childs.length){this.childs.push(t)}else{this.childs.splice(e,0,t)}t.parent=this;t.updateTransformChange(true);return t};a.prototype.getChildAt=function(t){if(t<0||t>=this.childs.length)return null;return this.childs[t]};a.prototype.addFollowUI=function(t){this._displayList=this._displayList||[];var e=this._displayList.indexOf(t);if(e==-1)this._displayList.push(t)};a.prototype.removeFollowUI=function(t){
if(!this._displayList){return}var e=this._displayList.indexOf(t);if(e>=0)this._displayList.splice(e,1)};a.prototype.getChildIndex=function(t){for(var e=0;e<this.childs.length;++e){if(this.childs[e]!=t){continue}return e}return-1};a.prototype.getChild=function(t){if(t>=0&&t<this.childs.length){return this.childs[t]}return null};a.prototype.removeChild=function(t){var e=this.childs.indexOf(t);if(e<0){return null}t.parent=null;this.childs.splice(e,1);t.updateTransformChange(true);return t};a.prototype.removeChildAt=function(t){if(t<0||t>=this.childs.length)return null;var e=this.childs[t];e.parent=null;this.childs.splice(t,1);e.updateTransformChange(true);return e};a.prototype.removeAllChild=function(){while(this.childs.length>0){this.removeChild(this.childs[0])}};a.prototype.setChildIndex=function(t,e){for(var i=0;i<this.childs.length;++i){if(this.childs[i]!=t){continue}if(i==e){return}else if(e>i){for(var r=i;r>e;--r){this.childs[r]=this.childs[r-1]}}else if(e<i){for(var r=i;r<e;++r){this.childs[r]=this.childs[r+1]}}this.childs[e]=t;return}};a.prototype.swapObject=function(t){var e=t.parent;if(this.parent){var i=this.parent.getChildIndex(this);var r=this.parent;r.removeChildAt(i);r.addChildAt(t,i)}var a=[];while(this.childs.length>0){a.push(this.childs[0]);this.removeChild(this.childs[0])}for(var n=0;n<a.length;++n){t.addChild(a[n])}this.updateTransformChange(true);t.updateTransformChange(true)};a.prototype.swapObjectAndChilds=function(t){var e=t.parent;var i=new Array;for(var r=0;r<t.childs.length;++r){i[r]=t.childs[r]}if(this.parent){var a=this.parent.getChildIndex(this);this.parent.childs[a]=t}if(t.parent){var a=t.parent.getChildIndex(t);t.parent.childs[a]=this}t.parent=this.parent;this.parent=e;t.childs.length=0;for(var r=0;r<this.childs.length;++r){t.childs[r]=this.childs[r];t.childs[r].parent=t}this.childs.length=0;for(var r=0;r<i.length;++r){this.childs[r]=i[r];this.childs[r].parent=this}this.updateTransformChange(true);t.updateTransformChange(true)};a.prototype.swapChildren=function(t,e){var i=0,r=0;for(;i<this.childs.length;++i){if(this.childs[i]!=t){continue}for(;r<this.childs.length;++r){if(this.childs[r]!=e){continue}var a=this.childs[i];this.childs[i]=this.childs[r];this.childs[r]=a;break}return}};a.prototype.swapChildrenAt=function(t,e){if(t<0||t>=this.childs.length)return;if(e<0||e>=this.childs.length)return;var i=this.childs[t];this.childs[t]=this.childs[e];this.childs[e]=i};a.prototype.lookAt=function(e,i,r){if(r===void 0){r=t.Vector3D.Y_AXIS}this.globalPosition=e;t.MathUtil.CALCULATION_MATRIX.lookAt(e,i,r);t.MathUtil.CALCULATION_MATRIX.invert();var a=t.MathUtil.CALCULATION_MATRIX.decompose(t.Orientation3D.QUATERNION);t.MathUtil.CALCULATION_QUATERNION.x=a[1].x;t.MathUtil.CALCULATION_QUATERNION.y=a[1].y;t.MathUtil.CALCULATION_QUATERNION.z=a[1].z;t.MathUtil.CALCULATION_QUATERNION.w=a[1].w;this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION};a.prototype.lookAtLocal=function(e,i,r){if(r===void 0){r=t.Vector3D.Y_AXIS}this.position=e;t.MathUtil.CALCULATION_MATRIX.lookAt(e,i,r);t.MathUtil.CALCULATION_MATRIX.invert();var a=t.MathUtil.CALCULATION_MATRIX.decompose(t.Orientation3D.QUATERNION);t.MathUtil.CALCULATION_QUATERNION.x=a[1].x;t.MathUtil.CALCULATION_QUATERNION.y=a[1].y;t.MathUtil.CALCULATION_QUATERNION.z=a[1].z;t.MathUtil.CALCULATION_QUATERNION.w=a[1].w;this.orientation=t.MathUtil.CALCULATION_QUATERNION};a.prototype.lookAtTarget=function(e){t.MathUtil.CALCULATION_MATRIX.lookAt(this.globalPosition,e.globalPosition,t.Vector3D.Y_AXIS);t.MathUtil.CALCULATION_MATRIX.invert();var i=t.MathUtil.CALCULATION_MATRIX.decompose(t.Orientation3D.QUATERNION);t.MathUtil.CALCULATION_QUATERNION.x=i[1].x;t.MathUtil.CALCULATION_QUATERNION.y=i[1].y;t.MathUtil.CALCULATION_QUATERNION.z=i[1].z;t.MathUtil.CALCULATION_QUATERNION.w=i[1].w;this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION};a.prototype.lookAtTargetLocal=function(e){t.MathUtil.CALCULATION_MATRIX.lookAt(this.position,e.position,t.Vector3D.Y_AXIS);t.MathUtil.CALCULATION_MATRIX.invert();var i=t.MathUtil.CALCULATION_MATRIX.decompose(t.Orientation3D.QUATERNION);t.MathUtil.CALCULATION_QUATERNION.x=i[1].x;t.MathUtil.CALCULATION_QUATERNION.y=i[1].y;t.MathUtil.CALCULATION_QUATERNION.z=i[1].z;t.MathUtil.CALCULATION_QUATERNION.w=i[1].w;this.orientation=t.MathUtil.CALCULATION_QUATERNION};a.prototype.findObject3D=function(t){var e=null;for(var i=0;i<this.childs.length;++i){if(this.childs[i].name==t){e=this.childs[i];return e}e=this.childs[i].findObject3D(t);if(e){return e}}return e};a.prototype.findObject3DToID=function(t){var e=null;for(var i=0;i<this.childs.length;++i){if(this.childs[i].id==t){e=this.childs[i];return e}e=this.childs[i].findObject3DToID(t);if(e){return e}}return e};a.prototype.updateTransformChange=function(t){this._transformChange=t;for(var e=0;e<this.childs.length;++e){this.childs[e].updateTransformChange(t)}};a.prototype.update=function(e,i,r){if(this.inFrustum){if(this.proAnimation){this.proAnimation.update(e,i,null)}}if(this._displayList){for(var a=0;a<this._displayList.length;a++){r.object3DToScreenRay(this.globalPosition,t.Vector3D.HELP_0);this._displayList[a].x=t.Vector3D.HELP_0.x;this._displayList[a].y=t.Vector3D.HELP_0.y}}};a.prototype.dispose=function(){r.prototype.dispose.call(this);for(var t=0;t<this.childs.length;t++){this.childs[t].dispose()}this.removeAllChild()};Object.defineProperty(a.prototype,"root",{get:function(){if(!this.parent){return this}return this.parent.root},enumerable:true,configurable:true});a.prototype.copy=function(t){this.position=t.position;this.rotation=t.rotation;this.scale=t.scale;this.visible=t.visible;this.name=t.name};a.prototype.clone=function(){var t=new a;t.copy(this);return t};a.prototype.deepClone=function(){var t=this.clone();for(var e=0;e<this.childs.length;++e){t.addChild(this.childs[e].deepClone())}return t};a.s_id=0;a.qua0=new t.Quaternion;a.mat0=new t.Matrix4_4;a.v0=new t.Vector3D;a.v1=new t.Vector3D;a.v2=new t.Vector3D;return a}(t.EventDispatcher);t.Object3D=r})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this);this.zIndex=-1;this.type="";this._multiMaterial={};this._materialCount=0;this.animation=null}Object.defineProperty(e.prototype,"geometry",{get:function(){return this._geometry},set:function(t){if(this._geometry==t){return}if(t){t.incRef()}if(this._geometry){this._geometry.dispose()}this._geometry=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"drawOrder",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(t){this._lightGroup=t;for(var e in this.multiMaterial){this.multiMaterial[e].lightGroup=this._lightGroup}},enumerable:true,configurable:true});e.prototype.addSubMaterial=function(t,e){if(!this._multiMaterial[t]){this._materialCount++}this.setSubMaterial(t,e)};e.prototype.setSubMaterial=function(t,e){this._multiMaterial[t]=e;if(!e){this.removeSubMaterial(t)}if(t==0){this._material=e}if(e){e.lightGroup=this._lightGroup}};e.prototype.removeSubMaterial=function(t){if(this._multiMaterial[t]){delete this._multiMaterial[t];this._materialCount--}};e.prototype.getMaterial=function(t){return this._multiMaterial[t]};Object.defineProperty(e.prototype,"materialCount",{get:function(){return this._materialCount},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t;if(this._multiMaterial[0]){this.setSubMaterial(0,t)}else{this.addSubMaterial(0,t)}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"multiMaterial",{get:function(){return this._multiMaterial},set:function(t){this._multiMaterial=t;this._materialCount=0;for(var e in t){this._materialCount++}},enumerable:true,configurable:true});e.prototype.update=function(e,i,r){t.prototype.update.call(this,e,i,r);if(this.inFrustum){if(this.animation){this.animation.update(e,i,this.geometry)}}if(this.geometry.subGeometrys.length<=0){this.geometry.buildDefaultSubGeometry()}};e.prototype.dispose=function(){t.prototype.dispose.call(this);if(this._bound){this._bound.dispose();this._bound=null}this.geometry=null;this.multiMaterial={}};e.TYPE_MESH="mesh";e.TYPE_PARTICLE_EMIT="particleEmit";e.TYPE_WIREFRAME="wireframe";return e}(t.Object3D);t.IRender=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(){t.call(this)}return e}(t.Object3D);t.Entity=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a){if(r===void 0){r=null}if(a===void 0){a=null}e.call(this);this.type=t.IRender.TYPE_MESH;this.geometry=i;if(a){this.animation=a}else{if(i){if(this.geometry.vertexFormat&t.VertexFormat.VF_SKIN){this.animation=new t.SkeletonAnimation(new t.SkeletonAnimationState)}}}this.material=r?r:new t.TextureMaterial;this.addSubMaterial(0,this.material);this.bound=this.buildBoundBox()}Object.defineProperty(i.prototype,"aabb",{get:function(){return this._aabbBox},enumerable:true,configurable:true});i.prototype.initAABB=function(){this._aabbBox=new t.QuadAABB;this.calcGlobalQuadAABB()};i.prototype.calcGlobalQuadAABB=function(){var t=this.bound;var e=this.modelMatrix;i.AABB_BL_2.setTo(t.min.x,t.min.y,t.min.z);i.AABB_BR_2.setTo(t.max.x,t.min.y,t.min.z);i.AABB_TL_2.setTo(t.min.x,t.max.y,t.min.z);i.AABB_TR_2.setTo(t.max.x,t.max.y,t.min.z);i.AABB_BL_1.setTo(t.min.x,t.min.y,t.max.z);i.AABB_BR_1.setTo(t.max.x,t.min.y,t.max.z);i.AABB_TL_1.setTo(t.min.x,t.max.y,t.max.z);i.AABB_TR_1.setTo(t.max.x,t.max.y,t.max.z);e.transformVector(i.AABB_BL_2,i.AABB_BL_2);e.transformVector(i.AABB_BR_2,i.AABB_BR_2);e.transformVector(i.AABB_TL_2,i.AABB_TL_2);e.transformVector(i.AABB_TR_2,i.AABB_TR_2);e.transformVector(i.AABB_BL_1,i.AABB_BL_1);e.transformVector(i.AABB_BR_1,i.AABB_BR_1);e.transformVector(i.AABB_TL_1,i.AABB_TL_1);e.transformVector(i.AABB_TR_1,i.AABB_TR_1);this._aabbBox.maxPosX=Math.max(i.AABB_TL_2.x,i.AABB_TR_2.x,i.AABB_BL_2.x,i.AABB_BR_2.x,i.AABB_TL_1.x,i.AABB_TR_1.x,i.AABB_BL_1.x,i.AABB_BR_1.x);this._aabbBox.maxPosY=Math.max(i.AABB_TL_2.y,i.AABB_TR_2.y,i.AABB_BL_2.y,i.AABB_BR_2.y,i.AABB_TL_1.y,i.AABB_TR_1.y,i.AABB_BL_1.y,i.AABB_BR_1.y);this._aabbBox.minPosX=Math.min(i.AABB_TL_2.x,i.AABB_TR_2.x,i.AABB_BL_2.x,i.AABB_BR_2.x,i.AABB_TL_1.x,i.AABB_TR_1.x,i.AABB_BL_1.x,i.AABB_BR_1.x);this._aabbBox.minPosY=Math.min(i.AABB_TL_2.y,i.AABB_TR_2.y,i.AABB_BL_2.y,i.AABB_BR_2.y,i.AABB_TL_1.y,i.AABB_TR_1.y,i.AABB_BL_1.y,i.AABB_BR_1.y)};Object.defineProperty(i.prototype,"isTriangle",{get:function(){return false},enumerable:true,configurable:true});i.prototype.onUpdateTransform=function(){this._aabbBox.setOffset(this._pos)};i.prototype.copy=function(t){e.prototype.copy.call(this,t);this.multiMaterial=t.multiMaterial};i.prototype.clone=function(){var t=null;if(this.animation){t=this.animation.clone()}var e=new i(this.geometry,this.material,t);e.copy(this);return e};i.prototype.buildBoundBox=function(){var e=new t.BoundBox(this);if(this.geometry&&this.geometry.vertexArray){e.min.copyFrom(new t.Vector3D(t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE));e.max.copyFrom(new t.Vector3D(-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE));for(var i=0;i<this.geometry.vertexArray.length;i+=this.geometry.vertexAttLength){if(e.max.x<this.geometry.vertexArray[i]){e.max.x=this.geometry.vertexArray[i]}if(e.max.y<this.geometry.vertexArray[i+1]){e.max.y=this.geometry.vertexArray[i+1]}if(e.max.z<this.geometry.vertexArray[i+2]){e.max.z=this.geometry.vertexArray[i+2]}if(e.min.x>this.geometry.vertexArray[i]){e.min.x=this.geometry.vertexArray[i]}if(e.min.y>this.geometry.vertexArray[i+1]){e.min.y=this.geometry.vertexArray[i+1]}if(e.min.z>this.geometry.vertexArray[i+2]){e.min.z=this.geometry.vertexArray[i+2]}}}e.fillBox(e.min,e.max);e.createChild();this.bound=e;this.initAABB();return e};i.AABB_TL_1=new t.Vector3D;i.AABB_TR_1=new t.Vector3D;i.AABB_BL_1=new t.Vector3D;i.AABB_BR_1=new t.Vector3D;i.AABB_TL_2=new t.Vector3D;i.AABB_TR_2=new t.Vector3D;i.AABB_BL_2=new t.Vector3D;i.AABB_BR_2=new t.Vector3D;return i}(t.IRender);t.Mesh=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n){if(r===void 0){r=null}if(a===void 0){a=100}if(n===void 0){n=100}if(r==null){r=new t.PlaneGeometry(a,n,1,1,1,1,t.Vector3D.Z_AXIS)}e.call(this,r,i);this.width=a;this.height=n;if(!this.bound){this.bound=this.buildBoundBox()}}i.prototype.update=function(t,i,r){e.prototype.update.call(this,t,i,r);this.globalOrientation=r.globalOrientation};i.prototype.copy=function(t){e.prototype.copy.call(this,t)};i.prototype.clone=function(){var t=new i(this.material,this.geometry,this.width,this.height);t.copy(this);return t};return i}(t.Mesh);t.Billboard=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i,r){if(r===void 0){r=null}t.call(this,e,i);this.camera=r;if(!this.bound){this.bound=this.buildBoundBox()}}e.prototype.update=function(e,i,r){t.prototype.update.call(this,e,i,r);if(this.camera){this.globalPosition=this.camera.globalPosition}};e.prototype.copy=function(e){t.prototype.copy.call(this,e)};e.prototype.clone=function(){var t=new e(this.geometry,this.material,this.camera);t.copy(this);return t};return e}(t.Mesh);t.Sky=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r){if(i===void 0){i=null}if(r===void 0){r=t.VertexFormat.VF_POSITION}e.call(this);this.type=t.IRender.TYPE_WIREFRAME;this.geometry=new t.Geometry;this.material=new t.ColorMaterial(16777215);this.addSubMaterial(0,this.material);this.material.drawMode=t.DrawMode.LINES;this.geometry.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0;this.fromVertexs(i,r)}i.prototype.fromVertexs=function(e,i){if(i===void 0){i=t.VertexFormat.VF_POSITION}if(e){this.geometry.setVerticesForIndex(0,i,e,e.length/t.GeometryUtil.fromVertexFormatToLength(i));this.geometry.indexCount=(this.geometry.vertexCount-1)*2;for(var r=0;r<this.geometry.vertexCount-1;++r){this.geometry.indexArray[r*2+0]=r;this.geometry.indexArray[r*2+1]=r+1}}};i.prototype.fromVertexsEx=function(e,i){if(i===void 0){i=t.VertexFormat.VF_POSITION}if(e){this.geometry.setVerticesForIndex(0,i,e,e.length/t.GeometryUtil.fromVertexFormatToLength(i));this.geometry.indexCount=this.geometry.vertexCount;for(var r=0;r<this.geometry.vertexCount;++r){this.geometry.indexArray[r]=r}}};i.prototype.fromGeometry=function(e){var i=[];e.getVertexForIndex(0,t.VertexFormat.VF_POSITION|t.VertexFormat.VF_COLOR,i,e.vertexCount);this.geometry.setVerticesForIndex(0,t.VertexFormat.VF_POSITION|t.VertexFormat.VF_COLOR,i,e.vertexCount);this.geometry.indexCount=e.faceCount*6;for(var r=0;r<e.faceCount;++r){var a=e.indexArray[r*3+0];var n=e.indexArray[r*3+1];var o=e.indexArray[r*3+2];this.geometry.indexArray[r*6+0]=a;this.geometry.indexArray[r*6+1]=n;this.geometry.indexArray[r*6+2]=n;this.geometry.indexArray[r*6+3]=o;this.geometry.indexArray[r*6+4]=o;this.geometry.indexArray[r*6+5]=a}};i.prototype.copy=function(t){e.prototype.copy.call(this,t);this.geometry=t.geometry;this.material=t.material};i.prototype.clone=function(){var t=new i;t.copy(this);return t};return i}(t.IRender);t.Wireframe=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i,r,a){if(r===void 0){r=4278255360}if(a===void 0){a=4278190335}e.call(this);this._startColor=4278255360;this._endColor=4278190335;this._vb=new Array;this._ib=new Array;this.material.diffuseColor=4294967295;this.setStartAndEndPosition(t,i);this.setStartAndEndColor(r,a)}i.prototype.setStartAndEndPosition=function(t,e){this._start=t;this._end=e;this.updateLine()};i.prototype.setStartAndEndColor=function(t,e){this._startColor=t;this._endColor=e;this.updateLine()};i.prototype.updateLine=function(){this._vb.length=0;this._ib.length=0;var e=t.Color.getColor(this._startColor);var i=t.Color.getColor(this._endColor);this._vb.push(this._start.x,this._start.y,this._start.z,e.x,e.y,e.z,e.w);this._vb.push(this._end.x,this._end.y,this._end.z,i.x,i.y,i.z,i.w);for(var r=0;r<this._vb.length/3;++r){this._ib.push(r)}this.geometry.setVerticesForIndex(0,t.VertexFormat.VF_POSITION|t.VertexFormat.VF_COLOR,this._vb,this._vb.length/7);this.geometry.setVertexIndices(0,this._ib)};return i}(t.Wireframe);t.WireframeLine=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i,r,a){if(e===void 0){e=null}if(i===void 0){i=null}if(r===void 0){r=0}if(a===void 0){a=0}this.lt=0;this.rt=0;this.lb=0;this.rb=0;this.tc=0;this.bc=0;this.lc=0;this.rc=0;this.oc=0;this.center=new t.Vector3D;this.center_0=new t.Vector3D;this.radius=0;this.dh0=0;this.dh1=0;this.dh2=0;this.dh3=0;this.dh4=0;this.dh5=0;this.minDH=0;this.maxDH=0;this.d=0;this.childs=[];this.level=0;this.isRender=false;this.parent=e;this.lodQuadTree=i;if(this.parent){this.level=this.parent.level+1}if(r!=0&&a!=0){this.createNode(0,r,(a+1)*r,(a+1)*(r+1)-1)}if(!this.parent){this.findNeighbour(this,r,a)}}e.prototype.calculateHeightDiff=function(){e.v0.length=0;e.v1.length=0;e.v2.length=0;e.v3.length=0;e.v4.length=0;e.v5.length=0;e.v6.length=0;e.v7.length=0;e.v8.length=0;e.getVertex(this.lt,e.v0,this.lodQuadTree.vertexDatas);e.getVertex(this.rt,e.v1,this.lodQuadTree.vertexDatas);e.getVertex(this.lb,e.v2,this.lodQuadTree.vertexDatas);e.getVertex(this.rb,e.v3,this.lodQuadTree.vertexDatas);var t=(this.lt+this.rt)/2;var i=(this.lb+this.rb)/2;var r=(this.lt+this.lb)/2;var a=(this.rt+this.rb)/2;var n=(this.lt+this.rb)/2;e.getVertex(t,e.v4,this.lodQuadTree.vertexDatas);e.getVertex(i,e.v5,this.lodQuadTree.vertexDatas);e.getVertex(r,e.v6,this.lodQuadTree.vertexDatas);e.getVertex(a,e.v7,this.lodQuadTree.vertexDatas);e.getVertex(n,e.v8,this.lodQuadTree.vertexDatas);this.dh0=(e.v0[2]+e.v1[2])/2-e.v4[2];this.dh1=(e.v2[2]+e.v3[2])/2-e.v5[2];this.dh2=(e.v0[2]+e.v2[2])/2-e.v6[2];this.dh3=(e.v1[2]+e.v3[2])/2-e.v7[2];this.dh4=(e.v0[2]+e.v3[2])/2-e.v8[2];this.dh5=(e.v1[2]+e.v2[2])/2-e.v8[2];this.minDH=Math.max(this.dh0,this.dh1);this.minDH=Math.max(this.minDH,this.dh2);this.minDH=Math.max(this.minDH,this.dh3);this.minDH=Math.max(this.minDH,this.dh4);this.minDH=Math.max(this.minDH,this.dh5);this.maxDH=Math.max(this.dh0,this.dh1);this.maxDH=Math.max(this.maxDH,this.dh2);this.maxDH=Math.max(this.maxDH,this.dh3);this.maxDH=Math.max(this.maxDH,this.dh4);this.maxDH=Math.max(this.maxDH,this.dh5);this.maxDH=Math.max(this.maxDH,1);var o=e.v1[0]-e.v0[0];var s=e.v1[1]-e.v0[1];var h=e.v1[2]-e.v0[2];this.d=Math.sqrt(o*o+s*s+h*h)};e.prototype.createNode=function(t,i,r,a){this.lt=t;this.rt=i;this.lb=r;this.rb=a;if(this.lodQuadTree.vertexDatas){this.createBoundSphere()}if(this.rt-t>1){this.calculateHeightDiff();var n=null;var o=(t+i)/2;var s=(r+a)/2;var h=(t+r)/2;var u=(i+a)/2;var l=(t+a)/2;this.tc=o;this.bc=s;this.lc=h;this.rc=u;this.oc=l;n=new e(this,this.lodQuadTree);this.childs[0]=n;n.createNode(t,o,h,l);n=new e(this,this.lodQuadTree);this.childs[1]=n;n.createNode(o,i,l,u);n=new e(this,this.lodQuadTree);this.childs[2]=n;n.createNode(h,l,r,s);n=new e(this,this.lodQuadTree);this.childs[3]=n;n.createNode(l,u,s,a)}};e.prototype.createBoundSphere=function(){e.v0.length=0;e.v1.length=0;e.v2.length=0;e.v3.length=0;e.getVertex(this.lt,e.v0,this.lodQuadTree.vertexDatas);e.getVertex(this.rt,e.v1,this.lodQuadTree.vertexDatas);e.getVertex(this.lb,e.v2,this.lodQuadTree.vertexDatas);e.getVertex(this.rb,e.v3,this.lodQuadTree.vertexDatas);e.v4[0]=Math.min(e.v0[0],e.v1[0]);e.v4[0]=Math.min(e.v4[0],e.v2[0]);e.v4[0]=Math.min(e.v4[0],e.v3[0]);e.v4[1]=Math.min(e.v0[1],e.v1[1]);e.v4[1]=Math.min(e.v4[1],e.v2[1]);e.v4[1]=Math.min(e.v4[1],e.v3[1]);e.v4[2]=Math.min(e.v0[2],e.v1[2]);e.v4[2]=Math.min(e.v4[2],e.v2[2]);e.v4[2]=Math.min(e.v4[2],e.v3[2]);e.v5[0]=Math.max(e.v0[0],e.v1[0]);e.v5[0]=Math.max(e.v5[0],e.v2[0]);e.v5[0]=Math.max(e.v5[0],e.v3[0]);e.v5[1]=Math.max(e.v0[1],e.v1[1]);e.v5[1]=Math.max(e.v5[1],e.v2[1]);e.v5[1]=Math.max(e.v5[1],e.v3[1]);e.v5[2]=Math.max(e.v0[2],e.v1[2]);e.v5[2]=Math.max(e.v5[2],e.v2[2]);e.v5[2]=Math.max(e.v5[2],e.v3[2]);var t=e.v5[0]-e.v4[0];var i=e.v5[1]-e.v4[1];var r=e.v5[2]-e.v4[2];this.radius=Math.sqrt(t*t+i*i+r*r)/2;this.center.x=e.v4[0]+t/2;this.center.y=e.v4[1]+i/2;this.center.z=e.v4[2]+r/2;this.center_0.copyFrom(this.center)};e.getVertex=function(t,e,i){e[0]=i[t*3+0];e[1]=i[t*3+1];e[2]=i[t*3+2]};e.prototype.isNeighbour=function(i,r,a,n){if(this.lt==i&&this.rt==r&&this.lb==a&&this.rb==n){return this}if(this.childs[0]){var o=(i+r+a+n)/4;e.v0.length=0;e.getVertex(o,e.v0,this.lodQuadTree.vertexDatas);e.v1.length=0;e.v2.length=0;e.getVertex(this.childs[0].lt,e.v1,this.lodQuadTree.vertexDatas);e.getVertex(this.childs[0].rb,e.v2,this.lodQuadTree.vertexDatas);if(t.Rectangle.pointInRect(e.v0[0],e.v0[2],e.v1[0],e.v1[2],e.v2[0],e.v2[2])){return this.childs[0].isNeighbour(i,r,a,n)}e.v1.length=0;e.v2.length=0;e.getVertex(this.childs[1].lt,e.v1,this.lodQuadTree.vertexDatas);e.getVertex(this.childs[1].rb,e.v2,this.lodQuadTree.vertexDatas);if(t.Rectangle.pointInRect(e.v0[0],e.v0[2],e.v1[0],e.v1[2],e.v2[0],e.v2[2])){return this.childs[1].isNeighbour(i,r,a,n)}e.v1.length=0;e.v2.length=0;e.getVertex(this.childs[2].lt,e.v1,this.lodQuadTree.vertexDatas);e.getVertex(this.childs[2].rb,e.v2,this.lodQuadTree.vertexDatas);if(t.Rectangle.pointInRect(e.v0[0],e.v0[2],e.v1[0],e.v1[2],e.v2[0],e.v2[2])){return this.childs[2].isNeighbour(i,r,a,n)}e.v1.length=0;e.v2.length=0;e.getVertex(this.childs[3].lt,e.v1,this.lodQuadTree.vertexDatas);e.getVertex(this.childs[3].rb,e.v2,this.lodQuadTree.vertexDatas);if(t.Rectangle.pointInRect(e.v0[0],e.v0[2],e.v1[0],e.v1[2],e.v2[0],e.v2[2])){return this.childs[3].isNeighbour(i,r,a,n)}}return null};e.prototype.findNeighbour=function(t,e,i){var r=this.rt-this.lt;if(r<=1){return}var a=0;var n=0;var o=0;var s=0;var h=0;if(this.lt==16350&&this.rt==16352&&this.lb==16608&&this.rb==16610){var u=0}for(var l=0;l<4;++l){switch(l){case 0:a=this.lt-r*(e+1);n=this.rt-r*(e+1);o=this.lt;s=this.rt;break;case 1:a=this.lb;n=this.rb;o=this.lb+r*(e+1);s=this.rb+r*(e+1);break;case 2:a=this.lt-r;n=this.lt;o=this.lb-r;s=this.lb;break;case 3:a=this.rt;n=this.rt+r;o=this.rb;s=this.rb+r;break}h=(a+n+o+s)/4;if(h>=0&&h<=(e+1)*(i+1)-1){this.childs[l+4]=t.isNeighbour(a,n,o,s)}}if(this.childs[0]){this.childs[0].findNeighbour(t,e,i);this.childs[1].findNeighbour(t,e,i);this.childs[2].findNeighbour(t,e,i);this.childs[3].findNeighbour(t,e,i)}};e.prototype.isDivide=function(t,i){e.v0.length=0;e.getVertex(this.oc,e.v0,this.lodQuadTree.vertexDatas_0);var r=t.globalX-e.v0[0];var a=t.globalY-e.v0[1];var n=t.globalZ-e.v0[2];var o=Math.sqrt(r*r+a*a+n*n);if(o/(this.d*i*this.maxDH)<1){return true}return false};e.prototype.setIsRender=function(t){this.isRender=t;if(this.childs[0]){this.childs[0].setIsRender(t);this.childs[1].setIsRender(t);this.childs[2].setIsRender(t);this.childs[3].setIsRender(t)}};e.v0=[];e.v1=[];e.v2=[];e.v3=[];e.v4=[];e.v5=[];e.v6=[];e.v7=[];e.v8=[];return e}();t.LODNode=e;var i=function(){function i(r,a){this.lodValue=16;this.offset=200;this.level=7;this.row=128;this.col=128;this.enable=true;this.currentNodes=[];this.nextNodes=[];this.v0=new t.Vector3D;this.v1=new t.Vector3D;this.row=a;this.col=a;this.vertexDatas=r;this.vertexDatas_0=[];for(var n=0;n<r.length;++n){this.vertexDatas_0[0]=r[n]}this.level=i.getOrder(a);this.root=new e(null,this,this.row,this.col)}i.getOrder=function(t){var e=0;t=t-1>>0;do{t>>=1;e++}while(t);return e};i.prototype.build=function(t,e,i){this.currentNodes.length=0;this.nextNodes.length=0;this.currentNodes.push(this.root);var r;this.root.setIsRender(false);for(var a=this.level;a>=0;--a){for(var n=0;n<this.currentNodes.length;++n){r=this.currentNodes[n];if(!i.frustum.inSphere(r.center_0,r.radius+this.offset)){continue}if(r.rt-r.lt<=1){e[t++]=r.lt;e[t++]=r.rb;e[t++]=r.lb;e[t++]=r.lt;e[t++]=r.rt;e[t++]=r.rb;r.isRender=true;continue}if(this.enable){if(r.isDivide(i,this.lodValue)){this.nextNodes.push(r.childs[0]);this.nextNodes.push(r.childs[1]);this.nextNodes.push(r.childs[2]);this.nextNodes.push(r.childs[3])}else{r.setIsRender(true)}}else{this.nextNodes.push(r.childs[0]);this.nextNodes.push(r.childs[1]);this.nextNodes.push(r.childs[2]);this.nextNodes.push(r.childs[3])}}var o=this.currentNodes;this.currentNodes=this.nextNodes;this.nextNodes=o;this.nextNodes.length=0}this.currentNodes.length=0;this.nextNodes.length=0;this.currentNodes.push(this.root);for(var a=this.level;a>=0;--a){for(var n=0;n<this.currentNodes.length;++n){r=this.currentNodes[n];if(r.isRender&&r.rt-r.lt>1){var s=false;var h=false;var u=false;var l=false;if(r.childs[4]){s=r.childs[4].isRender}else{s=true}if(r.childs[5]){h=r.childs[5].isRender}else{h=true}if(r.childs[6]){u=r.childs[6].isRender}else{u=true}if(r.childs[7]){l=r.childs[7].isRender}else{l=true}if(s&&h&&u&&l){e[t++]=r.lt;e[t++]=r.rb;e[t++]=r.lb;e[t++]=r.lt;e[t++]=r.rt;e[t++]=r.rb;continue}if(s||!r.childs[4]){e[t++]=r.oc;e[t++]=r.lt;e[t++]=r.rt}else{t=this.mendCracks(t,e,r,r.childs[4].childs[2],4);t=this.mendCracks(t,e,r,r.childs[4].childs[3],4)}if(h||!r.childs[5]){e[t++]=r.lb;e[t++]=r.oc;e[t++]=r.rb}else{t=this.mendCracks(t,e,r,r.childs[5].childs[0],5);t=this.mendCracks(t,e,r,r.childs[5].childs[1],5)}if(u||!r.childs[6]){e[t++]=r.lt;e[t++]=r.oc;e[t++]=r.lb}else{t=this.mendCracks(t,e,r,r.childs[6].childs[1],6);t=this.mendCracks(t,e,r,r.childs[6].childs[3],6)}if(l||!r.childs[7]){e[t++]=r.oc;e[t++]=r.rt;e[t++]=r.rb}else{t=this.mendCracks(t,e,r,r.childs[7].childs[0],7);t=this.mendCracks(t,e,r,r.childs[7].childs[2],7)}}else{if(r.childs[0]){this.nextNodes.push(r.childs[0]);this.nextNodes.push(r.childs[1]);this.nextNodes.push(r.childs[2]);this.nextNodes.push(r.childs[3])}}}var o=this.currentNodes;this.currentNodes=this.nextNodes;this.nextNodes=o;this.nextNodes.length=0}return t};i.prototype.mendCracks=function(t,e,i,r,a){if(!r){return t}switch(a){case 4:if(r){if(r.isRender){e[t++]=i.oc;e[t++]=r.lb;e[t++]=r.rb}else{t=this.mendCracks(t,e,i,r.childs[2],4);t=this.mendCracks(t,e,i,r.childs[3],4)}}break;case 5:if(r){if(r.isRender){e[t++]=r.lt;e[t++]=i.oc;e[t++]=r.rt}else{t=this.mendCracks(t,e,i,r.childs[0],5);t=this.mendCracks(t,e,i,r.childs[1],5)}}break;case 6:if(r){if(r.isRender){e[t++]=i.oc;e[t++]=r.rb;e[t++]=r.rt}else{t=this.mendCracks(t,e,i,r.childs[1],6);t=this.mendCracks(t,e,i,r.childs[3],6)}}break;case 7:if(r){if(r.isRender){e[t++]=i.oc;e[t++]=r.lt;e[t++]=r.lb}else{t=this.mendCracks(t,e,i,r.childs[0],7);t=this.mendCracks(t,e,i,r.childs[2],7)}}break}return t};i.prototype.onUpdate=function(t){this.currentNodes.length=0;this.nextNodes.length=0;this.currentNodes.push(this.root);var e;for(var i=this.level;i>=0;--i){for(var r=0;r<this.currentNodes.length;++r){e=this.currentNodes[r];t.transformVector(e.center,e.center_0);this.nextNodes.push(e.childs[0]);this.nextNodes.push(e.childs[1]);this.nextNodes.push(e.childs[2]);this.nextNodes.push(e.childs[3])}var a=this.currentNodes;this.currentNodes=this.nextNodes;this.nextNodes=a;this.nextNodes.length=0}for(var i=0;i<this.vertexDatas.length/3;++i){this.v0.setTo(this.vertexDatas[i*3+0],this.vertexDatas[i*3+1],this.vertexDatas[i*3+2]);t.transformVector(this.v0,this.v0);this.vertexDatas_0[i*3+0]=this.v0.x;this.vertexDatas_0[i*3+1]=this.v0.y;this.vertexDatas_0[i*3+2]=this.v0.z}};return i}();t.LODQuadTree=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n,o,s,h,u){if(r===void 0){r=1e3}if(a===void 0){a=100}if(n===void 0){n=1e3}if(o===void 0){o=128}if(s===void 0){s=128}if(h===void 0){h=false}if(u===void 0){u=null}e.call(this,new t.ElevationGeometry(i,r,a,n,o,s),u);this.useLod=h;if(h){if(o==s&&(o&o-1)==0){this.vertex=this.geometry.getVertexForIndex(0,t.VertexFormat.VF_POSITION,null,this.geometry.vertexCount);this.lodQuadTree=new t.LODQuadTree(this.vertex,o);this.lodQuadTree.onUpdate(this.modelMatrix)}else{t.Egret3DLog.outError("地形宽高不相等或者不是2的N次方!")}}}i.prototype.copy=function(t){e.prototype.copy.call(this,t)};i.prototype.clone=function(){var t=new i(this.terrainGeometry.heightmap,this.terrainGeometry.width,this.terrainGeometry.height,this.terrainGeometry.depth,this.terrainGeometry.segmentsW,this.terrainGeometry.segmentsH,this.useLod,this.material);t.copy(this);return t};Object.defineProperty(i.prototype,"terrainGeometry",{get:function(){return this.geometry},enumerable:true,configurable:true});i.prototype.onUpdateTransform=function(){e.prototype.onUpdateTransform.call(this);if(this.lodQuadTree){this.lodQuadTree.onUpdate(this.modelMatrix)}};i.prototype.startLOD=function(e){if(e&&!this.lodQuadTree){var i=this.geometry;if(i.segmentsW==i.segmentsH&&(i.segmentsW&i.segmentsW-1)==0){this.vertex=this.geometry.getVertexForIndex(0,t.VertexFormat.VF_POSITION,null,this.geometry.vertexCount);this.lodQuadTree=new t.LODQuadTree(this.vertex,i.segmentsW);this.lodQuadTree.onUpdate(this.modelMatrix)}else{t.Egret3DLog.outError("地形宽高不相等或者不是2的N次方!")}}else{if(this.lodQuadTree){this.lodQuadTree.enable=false}}};i.prototype.update=function(t,i,r){e.prototype.update.call(this,t,i,r);if(this.lodQuadTree){var a=0;a=this.lodQuadTree.build(a,this.geometry.indexArray,this.cullCamrea?this.cullCamrea:r);this.geometry.indexCount=a;this.geometry.bufferDiry=true;this.geometry.subGeometrys[0].count=this.geometry.indexCount;if(!this.lodQuadTree.enable){this.lodQuadTree=null}}};return i}(t.Mesh);t.Terrain=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(){function t(){}t.load=function(t){this._fontTextures=t};t.getTexture=function(t){var e=this._fontTextures[t];return e};return t}();t.BitmapFont=e})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.aabb=new t.Rectangle;this.mouseEnable=true;this.mouseChildren=true;this._renderText=false;this._childs=[];this._child3Ds=[];this._rgbNumber=16777215;this._alphaNumber=1;this._color=new t.ColorTransform;this._pivot=new t.Vector3D;this._pos=new t.Point;this._rot=new t.Vector3D;this._sca=new t.Vector3D(1,1,100,100);this._globalColor=new t.ColorTransform;this._globalPos=new t.Point;this._globalRot=new t.Vector3D;this._globalSca=new t.Vector3D(1,1,100,100);this._orientation=new t.Quaternion;this._globalOrientation=new t.Quaternion;this._localVisible=true;this._globalVisible=true;this._visibleChange=true;this._colorChange=true;this._transformChange=true;this._maskRectChange=true;this._transformInvalid=true;this._renderTextInvalid=true;this._maskRectInvalid=true;this._colorInvalid=true;this._textureInvalid=true;this._visibleInvalid=true;this.parentIsStage=false}Object.defineProperty(i.prototype,"mouseX",{get:function(){var e=this;var i=t.Input.mouseX;while(e){i-=e.x;if(e.parent&&!e.parentIsStage){e=e.parent}else{e=null}}return i},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"mouseY",{get:function(){var e=this;var i=t.Input.mouseY;while(e){i-=e.y;if(e.parent&&!e.parentIsStage){e=e.parent}else{e=null}}return i},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"stage",{get:function(){return this._stage},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"childs",{get:function(){return this._childs},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"renderText",{set:function(t){if(t!=this._renderText){this._renderTextInvalid=true;this._renderText=t}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"width",{get:function(){return this._sca.z},set:function(t){if(t!=this._sca.z){this._sca.z=t;this.updateTransformChange(true)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"height",{get:function(){return this._sca.w},set:function(t){if(t!=this._sca.w){this._sca.w=t;this.updateTransformChange(true)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"pivotX",{get:function(){return this._pivot.x;
},set:function(t){if(t!=this._pivot.x){this._pivot.x=t;this.updateTransformChange(true)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"pivotY",{get:function(){return this._pivot.y},set:function(t){if(t!=this._pivot.y){this._pivot.y=t;this.updateTransformChange(true)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"pivotZ",{get:function(){return this._pivot.z},set:function(t){if(t!=this._pivot.z){this._pivot.z=t;this.updateTransformChange(true)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"mask",{get:function(){return this._localMaskRect},set:function(e){if(e==null&&this._localMaskRect==null)return;this._localMaskRect=this._localMaskRect||new t.Rectangle;this._localMaskRect.copyFrom(e);this.updateMaskChange(true)},enumerable:true,configurable:true});i.prototype.calculateTransform=function(){if(!this._transformChange)return;if(this._parent!=null){var t=this._parent.globalOrientation;this._globalOrientation.multiply(t,this._orientation);this._globalOrientation.toEulerAngles(this._globalRot);var e=this._parent.globalScale;this._globalSca.copyFrom(e.multiply(this._sca));i.ThisPos.setTo(this._pos.x,this._pos.y,0,1);e.multiply(i.ThisPos);t.transformVector(i.ThisPos,i.TargetPos);this._pos.x=i.ThisPos.x;this._pos.y=i.ThisPos.y;this._globalPos.x=i.TargetPos.x;this._globalPos.y=i.TargetPos.y;this._globalPos.incrementBy(this._parent.globalPosition)}else{this._globalOrientation.copyFrom(this._orientation);this._globalPos.copyFrom(this._pos);this._globalSca.copyFrom(this._sca);this._globalRot.copyFrom(this._rot)}this._transformChange=false;this.calculateMask();this.onUpdateTransform()};i.prototype.calculateMask=function(){this.calculateTransform();if(!this._maskRectChange)return;if(this._parent){if(this._localMaskRect){this._globalMaskRect=this._globalMaskRect||new t.Rectangle;this._globalMaskRect.x=this._localMaskRect.x*this._globalSca.x+this._globalPos.x;this._globalMaskRect.y=this._localMaskRect.y*this._globalSca.y+this._globalPos.y;this._globalMaskRect.width=this._localMaskRect.width*this._globalSca.x;this._globalMaskRect.height=this._localMaskRect.height*this._globalSca.y;if(this._parent.globalMask)this._globalMaskRect.innerArea(this._parent.globalMask,this._globalMaskRect)}else{if(this._parent.globalMask){this._globalMaskRect=this._globalMaskRect||new t.Rectangle;this._globalMaskRect.copyFrom(this._parent.globalMask)}else{this._globalMaskRect=null}}}else{if(this._localMaskRect){this._globalMaskRect=this._globalMaskRect||new t.Rectangle;this._globalMaskRect.x=this._localMaskRect.x*this._globalSca.x+this._globalPos.x;this._globalMaskRect.y=this._localMaskRect.y*this._globalSca.y+this._globalPos.y;this._globalMaskRect.width=this._localMaskRect.width*this._globalSca.x;this._globalMaskRect.height=this._localMaskRect.height*this._globalSca.y}else{this._globalMaskRect=null}}this._maskRectChange=false};i.prototype.onUpdateTransform=function(){};i.prototype.addChild=function(e){if(e instanceof i)return this.doAddChildAt(e,t.MathUtil.MAX_VALUE)};i.prototype.addObject3D=function(t){if(t)this._child3Ds.push(t);return t};i.prototype.addChildAt=function(t,e){return this.doAddChildAt(t,e)};i.prototype.doAddChildAt=function(t,e){if(t==null)return null;if(t.parent){throw Error("This object is already the other child object.")}if(this._childs.indexOf(t)>=0){throw Error("The same child object has been added.")}if(e<0){throw Error("Child index can not be small than 0 !")}if(e>=this._childs.length){this._childs.push(t)}else{this._childs.splice(e,0,t)}t._parent=this;this._stage&&this._stage.setRenderListInvalid();t.activeStage(this._stage);return t};i.prototype.removeChild=function(t){return this.doRemoveChild(t)};i.prototype.removeChildAt=function(t){return this.doRemoveChild(this._childs[t])};i.prototype.doRemoveChild=function(t){if(t==null)return null;var e=this._childs.indexOf(t);if(e==-1)throw Error("The display isn't a child of this container!");this._childs.splice(e,1);t._parent=null;this._stage&&this._stage.setRenderListInvalid();t.activeStage(null);return t};i.prototype.swapChildIndex=function(t,e){};i.prototype.activeStage=function(t){if(this._stage!=t){this._stage=t;this.updateMaskChange(true);this.updateTransformChange(true);this.updateColorChange(true);this.updateVisibleChange(true);for(var e=0,i=this._childs.length;e<i;e++){this._childs[e].activeStage(t)}this.onActiveStage()}};i.prototype.onActiveStage=function(){};i.prototype.hasChild=function(t){return this.childs.indexOf(t)};i.prototype.getChildByIndex=function(t){return this.childs[t]};i.prototype.getChildByName=function(t){if(!t)return null;var e;for(var i=0,r=this._childs;i<r.length;i++){e=r[i];if(e.name==t)return e}return null};i.prototype.update=function(t,e){this.globalPosition;this.globalRotation;this.globalScale;this.globalColor;this.globalVisible;this.globalMask;this.updateMouseAABB()};i.prototype.updateMouseAABB=function(){if(this.mouseEnable){var t=this.globalPosition;var e=this.globalScale;if(this._maskRectInvalid||this._transformInvalid){this.aabb.x=t.x;this.aabb.y=t.y;this.aabb.width=this.width*e.x;this.aabb.height=this.height*e.y;if(this.globalMask){this.aabb.innerArea(this.globalMask,this.aabb)}}else{}}else{this.aabb.setTo(0,0,0,0)}};i.prototype.updateMaskChange=function(t){if(this._maskRectChange==t)return;this._maskRectChange=t;this._maskRectInvalid=t;for(var e=0;e<this._childs.length;++e){this._childs[e].updateMaskChange(t)}};i.prototype.updateTransformChange=function(t){if(this._transformChange==t)return;this._transformChange=t;this._transformInvalid=t;for(var e=0;e<this._childs.length;++e){this._childs[e].updateTransformChange(t)}this.updateMaskChange(t)};i.prototype.updateVisibleChange=function(t){if(this._visibleChange==t)return;this._visibleChange=t;this._visibleInvalid=t;for(var e=0;e<this._childs.length;++e){this._childs[e].updateVisibleChange(t)}};Object.defineProperty(i.prototype,"globalVisible",{get:function(){if(this._visibleChange){if(this._parent){this._globalVisible=this._localVisible&&this._parent.globalVisible}else{this._globalVisible=this._localVisible}this._visibleChange=false}return this._globalVisible},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"visible",{get:function(){return this._localVisible},set:function(t){if(this._localVisible!=t){this._localVisible=t;this.updateVisibleChange(true)}},enumerable:true,configurable:true});i.prototype.updateColorChange=function(t){if(this._colorChange==t)return;this._colorChange=t;this._colorInvalid=t;for(var e=0;e<this._childs.length;++e){this._childs[e].updateColorChange(t)}};Object.defineProperty(i.prototype,"globalX",{get:function(){return this.globalPosition.x},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalY",{get:function(){return this.globalPosition.y},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalPosition",{get:function(){if(this._transformChange){this.calculateTransform()}return this._globalPos},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalRotationX",{get:function(){return this.globalRotation.x},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalRotationY",{get:function(){return this.globalRotation.y},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalRotationZ",{get:function(){return this.globalRotation.z},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalRotation",{get:function(){if(this._transformChange){this.calculateTransform()}return this._globalRot},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalScale",{get:function(){if(this._transformChange){this.calculateTransform()}return this._globalSca},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalScaleX",{get:function(){return this.globalScale.x},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalScaleY",{get:function(){return this.globalScale.y},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalScaleZ",{get:function(){return this.globalScale.z},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalOrientation",{get:function(){if(this._transformChange){this.calculateTransform()}return this._globalOrientation},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalMask",{get:function(){if(this._maskRectChange){this.calculateMask()}return this._globalMaskRect},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"position",{get:function(){return this._pos},set:function(t){this._pos.copyFrom(t);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotation",{get:function(){return this._rot},set:function(t){this._rot.x=t.x;this._rot.y=t.y;this._rot.z=t.z;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"orientation",{get:function(){return this._orientation},set:function(t){this._orientation.copyFrom(t);this._orientation.toEulerAngles(this._rot);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"orientationX",{set:function(t){if(this._orientation.x==t)return;this._orientation.x=t;this._orientation.toEulerAngles(this._rot);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"orientationY",{set:function(t){if(this._orientation.y==t)return;this._orientation.y=t;this._orientation.toEulerAngles(this._rot);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"orientationZ",{set:function(t){if(this._orientation.z==t)return;this._orientation.z=t;this._orientation.toEulerAngles(this._rot);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"orientationW",{set:function(t){if(this._orientation.w==t)return;this._orientation.w=t;this._orientation.toEulerAngles(this._rot);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"scale",{get:function(){return this._sca},set:function(t){this._sca=t;this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"x",{get:function(){return this._pos.x},set:function(t){if(this._pos.x==t)return;this._pos.x=t;this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"y",{get:function(){return this._pos.y},set:function(t){if(this._pos.y==t)return;this.updateTransformChange(true);this._pos.y=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationX",{get:function(){return this._rot.x},set:function(t){if(this._rot.x==t)return;this._rot.x=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationY",{get:function(){return this._rot.y},set:function(t){if(this._rot.y==t)return;this._rot.y=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationZ",{get:function(){return this._rot.z},set:function(t){if(this._rot.z==t)return;this._rot.z=t;this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z);this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"scaleX",{get:function(){return this._sca.x},set:function(t){if(this._sca.x==t)return;this._sca.x=t;this.updateTransformChange(true)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"scaleY",{get:function(){return this._sca.y},set:function(t){if(this._sca.y==t)return;this.updateTransformChange(true);this._sca.y=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalColor",{get:function(){if(this._colorChange){this._color.alpha=this._alphaNumber;this._color.setColorRGB(this._rgbNumber);if(this._parent){this._globalColor.multiply(this._parent.globalColor)}else{this._globalColor.copyFrom(this._color)}this._colorChange=false}return this._color},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"color",{get:function(){return this._rgbNumber},set:function(t){if(this._rgbNumber!=t){this._rgbNumber=t;this.updateColorChange(true)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"alpha",{get:function(){return this._alphaNumber},set:function(t){this._alphaNumber=t;if(this._alphaNumber!=t){this._alphaNumber=t;this.updateColorChange(true)}},enumerable:true,configurable:true});i.ThisVector=new t.Vector3D;i.ThisPos=new t.Vector3D;i.TargetPos=new t.Vector3D;return i}(t.EventDispatcher);t.DisplayObject=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.buildGeometry=function(i,r,a){var i=i;i.vertexFormat=t.VertexFormat.VF_QUAD_POS|t.VertexFormat.VF_QUAD_ORIGN|t.VertexFormat.VF_QUAD_UVREC|t.VertexFormat.VF_QUAD_ROTATION|t.VertexFormat.VF_QUAD_MASK|t.VertexFormat.VF_QUAD_COLOR;var n=new t.SubGeometry;i.vertexCount=a*4;i.indexCount=e.singleQuadIndex.length*a;var o=0;var s=0;for(var h=0;h<a;h++){o=h+r;e.singleQuadData[0*e.vertexLen+2]=o;e.singleQuadData[1*e.vertexLen+2]=o;e.singleQuadData[2*e.vertexLen+2]=o;e.singleQuadData[3*e.vertexLen+2]=o;s=h*4*i.vertexAttLength;for(var u=0;u<e.singleQuadData.length;u++){i.vertexArray[s+u]=e.singleQuadData[u]}for(var l=0;l<e.singleQuadIndex.length;l++){i.indexArray[h*e.singleQuadIndex.length+l]=e.singleQuadIndex[l]+4*h}}n.geometry=i;n.start=0;n.count=i.indexCount;i.subGeometrys.push(n);i.vertexAttLength=e.vertexLen};e.singleQuadData=[0,0,1e5,0,0,0,0,0,0,0,1,1,0,0,0,1,-1,0,1,1,0,0,1,1,0,0,1e5,0,0,0,0,0,1,0,1,1,0,0,0,1,-1,0,1,1,0,0,1,1,0,0,1e5,0,0,0,0,0,1,1,1,1,0,0,0,1,-1,0,1,1,0,0,1,1,0,0,1e5,0,0,0,0,0,0,1,1,1,0,0,0,1,-1,0,1,1,0,0,1,1];e.vertexLen=24;e.posOffest=0;e.posSize=4;e.originalOffset=4;e.originalSize=4;e.uvRectangleOffest=8;e.uvRectangleSize=4;e.rotationOffest=12;e.rotationSize=4;e.maskOffset=16;e.maskSize=4;e.colorOffest=20;e.colorSize=4;e.singleQuadIndex=[0,2,1,0,3,2];e.vertexBytes=e.vertexLen*4;e.quadVertexLen=e.vertexLen*4;return e}();t.QuadData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._globalIndex=-1;this._boolArray=new t.BooleanArray}Object.defineProperty(i.prototype,"texture",{get:function(){return this._texture},set:function(e){if(!e){this.setTexture(e);return}if(e instanceof t.Texture){this.setTexture(e)}},enumerable:true,configurable:true});i.prototype.setTexture=function(t){if(t!==this._texture){this._texture=t;this._textureInvalid=true}};i.prototype.updateVertices=function(e,r,a){if(!r.sharedVertexBuffer||!r.sharedVertexBuffer.arrayBuffer)return;var n=this.globalPosition;var o=this.globalRotation;var s=this.globalScale;if(this._globalIndex!=a){this._globalIndex=a;this._colorInvalid=this._transformInvalid=this._renderTextInvalid=this._textureInvalid=this._visibleInvalid=this._maskRectInvalid=true;this._boolArray.clear()}if(this._visibleInvalid){this._visibleInvalid=false;this._boolArray.setBoolean(i.FLAG_IS_VISIBLE,this.globalVisible)}this._boolArray.setBoolean(i.FLAG_VALLID_QUAD,true);var h=0;var u;var l=r.vertexAttLength;var c=r.sharedVertexBuffer.arrayBuffer;if(this._transformInvalid){this._transformInvalid=false;u=e*t.QuadData.quadVertexLen+t.QuadData.originalOffset;for(var f=0;f<4;f++){h=u+f*l;if(this._renderText){c[h]=n.x>>0;c[h+1]=-n.y>>0}else{c[h]=n.x;c[h+1]=-n.y}}u=e*t.QuadData.quadVertexLen+t.QuadData.posOffest;h=u+0*l;c[h]=0;c[h+1]=0;h=u+1*l;c[h]=this.width;c[h+1]=0;h=u+2*l;c[h]=this.width;c[h+1]=-this.height;h=u+3*l;c[h]=0;c[h+1]=-this.height;u=e*t.QuadData.quadVertexLen+t.QuadData.uvRectangleOffest;for(var f=0;f<4;f++){h=u+f*l;c[h+2]=s.x;c[h+3]=s.y}var d=t.Quaternion.HELP_0;d.fromEulerAngles(this._globalRot.x,this._globalRot.y,this._globalRot.z);u=e*t.QuadData.quadVertexLen+t.QuadData.rotationOffest;for(var f=0;f<4;f++){h=u+f*l;c[h]=d.x;c[h+1]=d.y;c[h+2]=d.z;c[h+3]=d.w}}if(this._renderTextInvalid){this._renderTextInvalid=false;this._boolArray.setBoolean(i.FLAG_IS_TEXTFIELD,this._renderText)}if(this._textureInvalid){this._textureInvalid=false;this._boolArray.setBoolean(i.FLAG_HAS_TEXTURE,this._texture!=null);var p=0;var _;if(this._texture){_=this._texture.uvRectangle;p=this._texture.guiIndex;u=e*t.QuadData.quadVertexLen+t.QuadData.uvRectangleOffest;h=u+0*l;c[h]=_.x;c[h+1]=_.y;h=u+1*l;c[h]=_.x+_.width;c[h+1]=_.y;h=u+2*l;c[h]=_.x+_.width;c[h+1]=_.y+_.height;h=u+3*l;c[h]=_.x;c[h+1]=_.y+_.height;u=e*t.QuadData.quadVertexLen+t.QuadData.originalOffset;for(var f=0;f<4;f++){h=u+f*l;c[h+2]=p}}}if(this._maskRectInvalid){this._maskRectInvalid=false;var m=this.globalMask;this._boolArray.setBoolean(i.FLAG_HAS_MASK,m!=null);var v,g,y,x;if(m){v=m.x;g=m.y;y=m.width;x=m.height;u=e*t.QuadData.quadVertexLen+t.QuadData.maskOffset;for(var f=0;f<4;f++){h=u+f*l;c[h+0]=v;c[h+1]=g;c[h+2]=y;c[h+3]=x}}}if(this._colorInvalid){var b=this.globalColor.alpha;var D=i.TempVector;this.globalColor.m44.transformVector(i.IdentityVector,D);u=e*t.QuadData.quadVertexLen+t.QuadData.colorOffest;for(var f=0;f<4;f++){h=u+f*l;c[h]=D.x;c[h+1]=D.y;c[h+2]=D.z;c[h+3]=b}this._colorInvalid=false}if(this._boolArray.dirty){var T=this._boolArray.makeResult;u=e*t.QuadData.quadVertexLen+t.QuadData.originalOffset;for(var f=0;f<4;f++){h=u+f*l;c[h+3]=T}}};i.prototype.onActiveStage=function(){e.prototype.onActiveStage.call(this);this._globalIndex=-1};i.clear=function(e,i){if(i.sharedVertexBuffer&&i.sharedVertexBuffer.arrayBuffer){var r=i.sharedVertexBuffer.arrayBuffer;var a;var n=e*t.QuadData.quadVertexLen+t.QuadData.originalOffset;for(var o=0;o<4;o++){a=n+o*i.vertexAttLength;r[a+3]=0}}};i.FLAG_VALLID_QUAD=0;i.FLAG_IS_VISIBLE=1;i.FLAG_HAS_MASK=2;i.FLAG_HAS_TEXTURE=3;i.FLAG_IS_TEXTFIELD=4;i.IdentityVector=new t.Vector3D(1,1,1,1);i.TempVector=new t.Vector3D;i.DefaultUVRect=new t.Rectangle(0,0,1,1);return i}(t.DisplayObject);t.Quad=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){this._mouseList=[];this._lastMouseList=[];this._quadStage=e;t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.mouseDown,this,null,Number.MAX_VALUE);t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseUp,this,null,Number.MAX_VALUE);t.Input.addEventListener(t.MouseEvent3D.MOUSE_OVER,this.mouseOver,this,null,Number.MAX_VALUE);t.Input.addEventListener(t.MouseEvent3D.MOUSE_CLICK,this.mouseClick,this,null,Number.MAX_VALUE);t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.mouseMove,this,null,Number.MAX_VALUE);t.Input.addEventListener(t.MouseEvent3D.MOUSE_OUT,this.mouseOut,this,null,Number.MAX_VALUE);t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.mouseDown,this,null,Number.MAX_VALUE);t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.mouseUp,this,null,Number.MAX_VALUE);t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.mouseMove,this,null,Number.MAX_VALUE)}e.prototype.dispatchMouseEvent=function(e){var i=e.eventType;if(i===t.TouchEvent3D.TOUCH_START){i=t.MouseEvent3D.MOUSE_DOWN}else if(i===t.TouchEvent3D.TOUCH_END){i=t.MouseEvent3D.MOUSE_UP}else if(i===t.TouchEvent3D.TOUCH_MOVE){i=t.MouseEvent3D.MOUSE_MOVE}if(i===t.MouseEvent3D.MOUSE_MOVE){this._lastMouseList=this._mouseList}var r=this.getMousePickList();var a;var n;if(r.length===0){var o=new t.MouseEvent3D(i);this._quadStage.dispatchEvent(o);return}e.stopImmediatePropagation();a=r[0];n=a;while(n){var s=new t.MouseEvent3D(i);n.dispatchEvent(s);if(!n.parentIsStage){n=n.parent}else{n=null}}var h=new t.MouseEvent3D(i);this._quadStage.dispatchEvent(h)};e.prototype.onTouchStart=function(t){};e.prototype.onTouchEnd=function(t){};e.prototype.onTouchMove=function(t){};e.prototype.mouseOut=function(t){this.dispatchMouseEvent(t)};e.prototype.mouseDown=function(t){this.dispatchMouseEvent(t)};e.prototype.mouseUp=function(t){this.dispatchMouseEvent(t)};e.prototype.mouseOver=function(t){this.dispatchMouseEvent(t)};e.prototype.mouseMove=function(t){this.dispatchMouseEvent(t)};e.prototype.mouseClick=function(t){this.dispatchMouseEvent(t)};e.prototype.fire=function(){this._finalist=this._quadStage.quadList};e.prototype.getGlobalRect=function(e){var i=new t.Rectangle;i.copyFrom(e.aabb);e=e.parent;while(e){i.x+=e.x;i.y+=e.y;e=e.parent}return i};e.prototype.getMousePickList=function(){var e;this._mouseList.length=0;var i;if(this._finalist){for(e=0;e<this._finalist.length;e++){i=this._finalist[e];if(i.globalVisible&&i.mouseEnable&&i.aabb.inner(t.Input.mouseX,t.Input.mouseY)){this._mouseList.push(i)}}}this._mouseList.reverse();return this._mouseList};return e}();t.GUIEventFire=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,new t.Geometry,new t.TextureMaterial);this.startQuad=0;this.numberQuad=0;this.quadList=[];this.startQuad=i;this.numberQuad=t.QuadStage.moreQuad;this.geometry.drawType=t.Context3DProxy.gl.DYNAMIC_DRAW;t.QuadData.buildGeometry(this.geometry,i,t.QuadStage.moreQuad);this.guiMethod=new t.GUIMethod;this.enableCulling=false;this.uiMaterial=this.material;this.uiMaterial.blendMode=t.BlendMode.ALPHA;this.uiMaterial.repeat=true;this.uiMaterial.diffusePass.addMethod(this.guiMethod);this.canPick=false;this.tag.name="gui"}i.prototype.setTexture=function(t,e){this.guiMethod.setTextures(t,e)};return i}(t.Mesh);t.QuadMesh=e;var i=function(t){__extends(e,t);function e(){t.call(this)}e.prototype.dispose=function(){};return e}(t.Object3D);t.GUIRootContainer=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._nextIndex=0;this._textures=[];for(var i=0;i<e.MAX_COUNT;i++){this._textures[i]=t.CheckerboardTexture.texture}}e.prototype.register=function(t){if(this._nextIndex>=e.MAX_COUNT)return false;if(this._textures.indexOf(t)>=0)return false;this._textures[this._nextIndex]=t;t.guiIndex=this._nextIndex;this._nextIndex++;return true};e.prototype.replace=function(t,i){if(i<0||i>=e.MAX_COUNT)throw new Error("index error");var r=this._textures[i];this._textures[i]=t;return r};e.prototype.activeTexture=function(t){for(var i=0;i<e.MAX_COUNT;i++){t.setTexture(i,this._textures[i])}};e.MAX_COUNT=7;return e}();t.GUITextureGroup=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this);this._childList=[];this._quadMeshs=[];this._quadCurHistory=[];this._quadLastHistory=[];this._renderListInvalid=false;this.x=0;this.y=0;this.width=0;this.height=0;this.quadList=[];this._view3D=i;this._guiEventFire=new t.GUIEventFire(this);this._textureGroup=new t.GUITextureGroup;this._guiContainer=new t.GUIRootContainer;this.changeCamera()}i.prototype.registerTexture=function(t){return this._textureGroup.register(t)};i.prototype.changeCamera=function(){if(this._guiContainer.parent)this._guiContainer.parent.removeChild(this._guiContainer);this._view3D.camera3D.addChild(this._guiContainer)};i.prototype.creatQuadMesh=function(){var e=new t.QuadMesh(this._quadMeshs.length*i.moreQuad);this._quadMeshs.push(e);this._guiContainer.addChild(e)};i.prototype.getChildQuads=function(e,i){var r=0;var a;var n;if(e instanceof t.Quad){n=e;i.push(n)}while(r<e.childs.length){a=e.childs[r++];this.getChildQuads(a,i)}};i.prototype.addChild=function(t){if(!t){throw Error("This object is null")}if(t.parent){throw Error("parent isn't null")}this._childList.push(t);t.activeStage(this);t.parentIsStage=true;this.setRenderListInvalid()};i.prototype.setRenderListInvalid=function(){this._renderListInvalid=true};i.prototype.updateRenderList=function(){this.quadList.length=0;for(var t=0;t<this._childList.length;t++){this.getChildQuads(this._childList[t],this.quadList)}if(this.quadList.length>this._quadMeshs.length*i.moreQuad){var e=Math.ceil(this.quadList.length/i.moreQuad)-this._quadMeshs.length;for(var t=0;t<e;t++){this.creatQuadMesh()}}};i.prototype.removeChild=function(t){var e=this._childList.indexOf(t);if(e!=-1){this._childList.splice(e,1)}t.activeStage(null);t.parentIsStage=false;this.setRenderListInvalid()};i.prototype.update=function(e,r,a,n){var o=this;o.x=n.x;o.y=n.y;o.width=n.width;o.height=n.height;if(this._renderListInvalid){this._renderListInvalid=false;this.updateRenderList()}t.Context3DProxy.gl.disable(t.Context3DProxy.gl.DEPTH_TEST);t.Egret3DCanvas.context3DProxy.disAttribPointer();var s;var h=o.quadList.length;for(s=0;s<h;s++){this.quadList[s].update(e,r)}this._guiEventFire.fire();var u;for(s=0;s<h;s++){u=Math.floor(s/i.moreQuad);this.quadList[s].updateVertices(s%i.moreQuad,o._quadMeshs[u].geometry,s)}this.clearInvalidVertices(h);var l;for(s=0;s<o._quadMeshs.length;s++){l=o._quadMeshs[s];l.geometry.upload(a,t.Context3DProxy.gl.DYNAMIC_DRAW);o._textureGroup.activeTexture(l)}t.Context3DProxy.gl.enable(t.Context3DProxy.gl.DEPTH_TEST)};i.prototype.clearInvalidVertices=function(e){var r=this;this._quadCurHistory.length=0;var a=0;while(e>=i.moreQuad){this._quadCurHistory[a]=i.moreQuad;e-=i.moreQuad;a++}if(e>0){r._quadCurHistory[a]=e}e=r._quadMeshs.length;var n=0;var o=0;for(a=0;a<e;a++){n=r._quadLastHistory[a]||0;o=r._quadCurHistory[a]||0;if(o<n){for(var s=o;s<n;s++){t.Quad.clear(s,r._quadMeshs[a].geometry)}}}var h=r._quadCurHistory;r._quadCurHistory=r._quadLastHistory;r._quadLastHistory=h};i.moreQuad=400;return i}(t.EventDispatcher);t.QuadStage=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(){function i(){this._defaultSkinTexture={}}i.prototype.getDefaultSkin=function(t){return this._defaultSkinTexture[t]};i.prototype.initDefaultSkin=function(){var r=t.textureResMgr.getTexture("normal.png");var a=t.textureResMgr.getTexture("pressed.png");var n=t.textureResMgr.getTexture("hover.png");var o=t.textureResMgr.getTexture("default.png");var s=t.textureResMgr.getTexture("checked.png");var h=t.textureResMgr.getTexture("whitebackground.png");var u=t.textureResMgr.getTexture("backgroundpic.png");var l=t.textureResMgr.getTexture("blue.png");var c=t.textureResMgr.getTexture("unselected.png");var f=t.textureResMgr.getTexture("selected.png");var d=t.textureResMgr.getTexture("hover1.png");var p=t.textureResMgr.getTexture("bluebackground.png");var _=t.textureResMgr.getTexture("whitebackground.png");i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_BUTTON_UP,r);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_BUTTON_DOWN,a);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_BUTTON_OVER,n);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_LABEL_BUTTON_UP,r);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_LABE_BUTTON_DOWN,a);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_CHECK_BOX_UP,o);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_CHECK_BOX_DOWN,o);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_CHECK_BOX_SELECTED_UP,s);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_CHECK_BOX_SELECTED_DOWN,s);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_RADIO_BUTTON_UP,c);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_RADIO_BUTTON_DOWN,d);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_RADIO_BUTTON_SELECTED_DOWN,d);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_RADIO_BUTTON_SELECTED_UP,f);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_SLIDER_BAR,p);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_SLIDER_BACKGROUND,_);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_PROGRESS_BAR,l);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_PROGRESS_BAR_BACKGROUND,u);i.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_PANEL_BACKGROUND,h)};i.prototype.setDefaultSkin=function(e,i){if(typeof i==="string"){i=t.textureResMgr.getTexture(i)}this._defaultSkinTexture[e]=i};Object.defineProperty(i,"instance",{get:function(){if(!i._instance){i._instance=new i}return i._instance},enumerable:true,configurable:true});return i}();e.GUISkinManager=i;var r=function(){function t(){}t.DEFAULT_BUTTON_UP="defaultButtonUp";t.DEFAULT_BUTTON_DOWN="defaultButtonDown";t.DEFAULT_BUTTON_OVER="defaultButtonOver";t.DEFAULT_BUTTON_DISABLE="defaultButtonDisable";t.DEFAULT_LABEL_BUTTON_UP="defaultLabelButtonUp";t.DEFAULT_LABE_BUTTON_DOWN="defaultLabelButtonDown";t.DEFAULT_LABE_BUTTON_DISABLE="defaultLabelButtonDisable";t.DEFAULT_CHECK_BOX_UP="defaultCheckBoxUp";t.DEFAULT_CHECK_BOX_DOWN="defaultCheckBoxDown";t.DEFAULT_CHECK_BOX_SELECTED_UP="defaultCheckBoxSelectedUp";t.DEFAULT_CHECK_BOX_SELECTED_DOWN="defaultCheckBoxSelectedDown";t.DEFAULT_CHECK_BOX_DISABLE="defaultCheckBoxDisable";t.DEFAULT_PROGRESS_BAR="defaultProgressBar";t.DEFAULT_PROGRESS_BAR_BACKGROUND="defaultProgressBarBackground";t.DEFAULT_RADIO_BUTTON_UP="defaultRadioButtonUp";t.DEFAULT_RADIO_BUTTON_DOWN="defaultRadioButtonDown";t.DEFAULT_RADIO_BUTTON_SELECTED_UP="defaultRadioButtonSelectedUp";t.DEFAULT_RADIO_BUTTON_SELECTED_DOWN="defaultRadioButtonSelectedDown";t.DEFAULT_RADIO_BUTTON_DISABLE="defaultRadioButtonDisable";t.DEFAULT_SLIDER_BAR="defaultSliderBar";t.DEFAULT_SLIDER_BACKGROUND="defaultSliderBarBACKGROUND";t.DEFAULT_PANEL_BACKGROUND="defaultPanelBackground";return t}();e.DefaultSkinName=r})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(t){__extends(e,t);function e(){t.apply(this,arguments)}e.prototype.onRender=function(){};e.prototype.onUpdate=function(){};e.prototype.onEvent=function(){};return e}(t.DisplayObject);e.UILayout=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(i){__extends(r,i);function r(){i.call(this)}r.prototype.onRender=function(){};r.prototype.onUpdate=function(){};r.prototype.onEvent=function(){};r.prototype.setStyle=function(e,i){if(!this.instanceStyles){this.instanceStyles={}}if(typeof i==="string"){var r=t.textureResMgr.getTexture(i);if(!r){console.log("未找到名为: "+i+" 的资源贴图");return}else{i=r}}if(this.instanceStyles[e]===i){return}this.instanceStyles[e]=i};r.prototype.getStyle=function(t){return this.instanceStyles?this.instanceStyles[t]:this.getDefaultStyle(t)};r.prototype.getDefaultStyle=function(t){return e.GUISkinManager.instance.getDefaultSkin(this.getDefaultStyleNameByStyleName(t))};r.prototype.getDefaultStyleNameByStyleName=function(t){return""};r.mergeStyles=function(){var t=[];for(var e=0;e<arguments.length;e++){t[e-0]=arguments[e]}var i={};var r=t.length;for(var a=0;a<r;a++){var n=t[a];for(var o in n){if(i[o]!=null){continue}i[o]=t[a][o]}}return i};r.defaultStyles={};return r}(t.DisplayObject);e.UIElement=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(i){__extends(r,i);function r(){i.call(this);this._skin=new t.Quad;this.addChild(this._skin);this._state=r.STATE_UP;this._enable=true;this._isDowning=false;this.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.mouseEventHandler,this);this.addEventListener(t.MouseEvent3D.MOUSE_OUT,this.mouseEventHandler,this);this.addEventListener(t.MouseEvent3D.MOUSE_OVER,this.mouseEventHandler,this);this.drawBackground()}r.prototype.getDefaultStyleNameByStyleName=function(t){var i={down:e.DefaultSkinName.DEFAULT_BUTTON_DOWN,up:e.DefaultSkinName.DEFAULT_BUTTON_UP,over:e.DefaultSkinName.DEFAULT_BUTTON_OVER,disable:e.DefaultSkinName.DEFAULT_BUTTON_DISABLE};var r=i[t];if(!r){console.log(" ERROR!!! UIButton can't find default style : ",t)}return r};Object.defineProperty(r.prototype,"width",{get:function(){return this._skin.width},set:function(t){this._skin.width=t;this.onRender()},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"height",{get:function(){return this._skin.height},set:function(t){this._skin.height=t;this.onRender()},enumerable:true,configurable:true});r.prototype.setStyle=function(t,e){i.prototype.setStyle.call(this,t,e);this.onRender()};r.prototype.mouseEventHandler=function(e){if(!this._enable)return;if(e.eventType===t.MouseEvent3D.MOUSE_DOWN){this.startPress();
}else if(e.eventType===t.MouseEvent3D.MOUSE_UP){this.endPress()}else if(e.eventType===t.MouseEvent3D.MOUSE_OUT){this.mouseOut()}else if(e.eventType===t.MouseEvent3D.MOUSE_OVER){}};r.prototype.mouseOut=function(){this.setMouseState(r.STATE_UP)};r.prototype.mouseOver=function(){if(this._isDowning){this.setMouseState(r.STATE_DOWN)}else{this.setMouseState(r.STATE_OVER)}};r.prototype.startPress=function(){this.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseEventHandler,this);if(this.stage){this.stage.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onStageEnd,this)}this._isDowning=true;this.setMouseState(r.STATE_DOWN)};r.prototype.onStageEnd=function(e){if(this.stage){this.stage.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onStageEnd,this)}this.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseEventHandler,this);this.setMouseState(r.STATE_UP);this._isDowning=false};r.prototype.endPress=function(){this.setMouseState(r.STATE_UP);this._isDowning=false;if(this.stage){this.stage.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onStageEnd,this)}this.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseEventHandler,this)};Object.defineProperty(r.prototype,"enable",{get:function(){return this._enable},set:function(t){this._enable=t;this.mouseEnable=t},enumerable:true,configurable:true});r.prototype.setMouseState=function(t){if(this._state===t){return}this._state=t;this.onRender()};r.prototype.onRender=function(){this.drawBackground()};r.prototype.drawBackground=function(){var t=this.enable?this.getStyle(this._state):this.getStyle(r.STATE_DISABLE);this._skin.texture=t};r.STATE_DOWN="down";r.STATE_UP="up";r.STATE_OVER="over";r.STATE_DISABLE="disable";return r}(e.UIElement);e.UIButton=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){(function(t){t[t["NONE"]=0]="NONE";t[t["LEFT"]=1]="LEFT";t[t["RIGHT"]=2]="RIGHT";t[t["CENTER"]=3]="CENTER"})(e.UITextFieldAutoSize||(e.UITextFieldAutoSize={}));var i=e.UITextFieldAutoSize;(function(t){t[t["DYNAMIC"]=0]="DYNAMIC";t[t["INPUT"]=1]="INPUT"})(e.UITextFieldType||(e.UITextFieldType={}));var r=e.UITextFieldType;var a=function(){function t(){}return t}();(function(t){t[t["CENTER"]=0]="CENTER";t[t["JUSTIFY"]=1]="JUSTIFY";t[t["LEFT"]=2]="LEFT";t[t["RIGHT"]=3]="RIGHT"})(e.UITextFormatAlign||(e.UITextFormatAlign={}));var n=e.UITextFormatAlign;var o=function(){function t(){}return t}();e.UITextFormat=o;var s=function(n){__extends(o,n);function o(e){if(e===void 0){e=r.DYNAMIC}n.call(this);this._textLineInfo=[];this._text="";this._maxChars=0;this._restrict="";this._textWidth=0;this._textLine=[];this._quadPool=[];this._textHeight=0;this._fontQuadLine=[];this._multiline=false;this._selectable=false;this._type=e;this._textColor=52224;this._selectionEndIndex=-1;this._selectionBeginIndex=-1;this._displayAsPassword=false;this._autoSize=i.LEFT;this._fontQuadPanel=new t.DisplayObject;this._blankQuad=this.createFontQuad("b".charCodeAt(0),false);if(!o.sharedHTMLInputElement){o.sharedHTMLInputElement=document.createElement("input");o.sharedHTMLInputElement.style.width=this.width+"px";o.sharedHTMLInputElement.style.height=this.height+"px";o.sharedHTMLInputElement.hidden=true;o.sharedHTMLInputElement.style.color="#00ff00";o.sharedHTMLInputElement.style.border="0px";o.sharedHTMLInputElement.style.backgroundColor="transparent";document.getElementById("egret3D").parentElement.appendChild(o.sharedHTMLInputElement)}if(!o.sharedHTMLTextAreaElement){o.sharedHTMLTextAreaElement=document.createElement("textarea");o.sharedHTMLTextAreaElement.style.width=this.width+"px";o.sharedHTMLTextAreaElement.style.height=this.height+"px";o.sharedHTMLTextAreaElement.hidden=true;o.sharedHTMLTextAreaElement.style.color="#00ff00";o.sharedHTMLTextAreaElement.style.paddingLeft="0px";o.sharedHTMLTextAreaElement.style.paddingTop="0px";o.sharedHTMLTextAreaElement.style.margin="0px";o.sharedHTMLTextAreaElement.style.backgroundColor="transparent";document.getElementById("egret3D").parentElement.appendChild(o.sharedHTMLTextAreaElement)}this._bgQuad=new t.Quad;if(r.INPUT==this._type){this._bgQuad.mouseEnable=true;this._bgQuad.width=this.width;this._bgQuad.height=this.height;this.addChild(this._bgQuad);this._bgQuad.addEventListener(t.TouchEvent3D.TOUCH_START,this.onShowInputAgent,this);this._bgQuad.addEventListener(t.MouseEvent3D.MOUSE_CLICK,this.onShowInputAgent,this)}this.width=100;this.height=20;this.addChild(this._fontQuadPanel)}o.prototype.onShowInputAgent=function(t){var e=this;if(this._multiline){o.sharedHTMLTextAreaElement.hidden=false;o.sharedHTMLTextAreaElement.style.position="absolute";o.sharedHTMLTextAreaElement.style.left=this.x+"px";o.sharedHTMLTextAreaElement.style.top=this.y+"px";o.sharedHTMLTextAreaElement.style.width=this.width+"px";o.sharedHTMLTextAreaElement.style.height=this.height+"px";o.sharedHTMLTextAreaElement.value=this._text;o.sharedHTMLTextAreaElement.focus();o.sharedHTMLTextAreaElement.onblur=function(t){return e.onSharedHTMLTextLoseFocus(t)}}else{o.sharedHTMLInputElement.hidden=false;o.sharedHTMLInputElement.style.position="absolute";o.sharedHTMLInputElement.style.left=this.x+"px";o.sharedHTMLInputElement.style.top=this.y+"px";o.sharedHTMLInputElement.style.width=this.width+"px";o.sharedHTMLInputElement.style.height=this.height+"px";o.sharedHTMLInputElement.value=this._text;o.sharedHTMLInputElement.focus();o.sharedHTMLInputElement.onblur=function(t){return e.onSharedHTMLTextLoseFocus(t)}}this._fontQuadPanel.visible=false};o.prototype.onSharedHTMLTextLoseFocus=function(t){this.text=this._multiline?o.sharedHTMLTextAreaElement.value:o.sharedHTMLInputElement.value;o.sharedHTMLInputElement.onblur=o.sharedHTMLTextAreaElement.onblur=null;o.sharedHTMLInputElement.hidden=o.sharedHTMLTextAreaElement.hidden=true;this._fontQuadPanel.visible=true};Object.defineProperty(o.prototype,"width",{get:function(){return this._sca.z},set:function(t){if(t!=this._sca.z){this._fontQuadPanel.width=t;this._sca.z=t;this._transformChange=true;this._bgQuad.width=t;this.refreshAlign()}},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"height",{get:function(){return this._sca.w},set:function(t){if(t!=this._sca.w){this._fontQuadPanel.height=t;this._sca.w=t;this._transformChange=true;this._bgQuad.height=t;this.refreshAlign()}},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"displayAsPassword",{get:function(){return this._displayAsPassword},set:function(t){this._displayAsPassword=t},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"length",{get:function(){return this._text.length},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"maxChars",{get:function(){return this._maxChars},set:function(t){this._maxChars=t},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"multiline",{get:function(){return this._multiline},set:function(t){this._multiline=t},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"restrict",{get:function(){return this._restrict},set:function(t){this._restrict=t},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"selectable",{get:function(){return this._selectable},set:function(t){this._selectable=t},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"selectionBeginIndex",{get:function(){return this._selectionBeginIndex},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"selectionEndIndex",{get:function(){return this._selectionEndIndex},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"textColor",{get:function(){return this._textColor},set:function(t){this._textColor=t},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"textWidth",{get:function(){return this._textWidth},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"textHeight",{get:function(){return this._textHeight},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"text",{get:function(){return this._text},set:function(t){this.clearText();this._text=t;this._textLine=t.split("\n");if(!this._multiline){this._textLine[0]=this._textLine.join("");this._textLine.length=1}var e=null;for(var i=0;i<this._textLine.length;++i){var r=this._textLine[i];e=this.buildTextLineInfo(r);this._textLineInfo.push(e)}this.refreshAlign()},enumerable:true,configurable:true});o.prototype.clearText=function(){var t=null;for(var e=0;e<this._textLineInfo.length;++e){t=this._textLineInfo[e];for(var i=0;i<t.lineQuads.length;++i){this.deleteFontQuad(t.lineQuads[i])}t.lineQuads=null}this._textLineInfo=[]};Object.defineProperty(o.prototype,"autoSize",{get:function(){return this._autoSize},set:function(t){this._autoSize=t},enumerable:true,configurable:true});o.prototype.refreshAlign=function(){var t=null;var e=null;var r,a;if(this._autoSize==i.LEFT){a=0;if(!this.multiline&&this._textLineInfo.length>=1){a=this.height/2-this._textLineInfo[0].lineHeight/2}for(var n=0;n<this._textLineInfo.length;++n){e=this._textLineInfo[n];r=0;for(var o=0;o<e.lineQuads.length;++o){t=e.lineQuads[o];t.x=r;t.y=a;r+=t.width;t.visible=t.x+t.width<=this.width}a+=e.lineHeight}}else if(this._autoSize==i.RIGHT){a=0;if(!this.multiline&&this._textLineInfo.length>=1){a=this.height/2-this._textLineInfo[0].lineHeight/2}for(var n=0;n<this._textLineInfo.length;++n){e=this._textLineInfo[n];r=this.width;for(var o=e.lineQuads.length-1;o>=0;--o){t=e.lineQuads[o];t.x=r-=t.width;t.y=a;t.visible=t.x+t.width>0}a+=e.lineHeight}}else if(this._autoSize==i.CENTER){a=0;if(!this.multiline&&this._textLineInfo.length>=1){a=this.height/2-this._textLineInfo[0].lineHeight/2}for(var n=0;n<this._textLineInfo.length;++n){e=this._textLineInfo[n];r=this.width*.5-e.lineWidth*.5;for(var o=0;o<e.lineQuads.length;++o){t=e.lineQuads[o];t.x=r;t.y=a;r+=t.width;t.visible=t.x+t.width<=this.width&&t.x+t.width>0}a+=e.lineHeight}}};o.prototype.buildTextLineInfo=function(t){var e=new a;e.lineText=t;e.lineWidth=0;e.lineHeight=0;e.lineQuads=[];for(var i=0;i<t.length;++i){var r=null;var n=t.charCodeAt(i);r=n!=32?this.createFontQuad(n):this._blankQuad;e.lineQuads.push(r);e.lineWidth+=r.width;if(e.lineHeight<r.height){e.lineHeight=r.height}}return e};o.prototype.appendText=function(t){};o.prototype.getCharBoundaries=function(t){return null};o.prototype.getCharIndexAtPoint=function(t,e){return 0};o.prototype.replaceSelectedText=function(t){};o.prototype.replaceText=function(t,e,i){};o.prototype.setSelection=function(t,e){};o.prototype.createFontQuad=function(i,r){if(r===void 0){r=true}var a;if(this._quadPool.length>0){a=this._quadPool[this._quadPool.length-1];this._quadPool.splice(this._quadPool.length-1,1)}else{a=new t.Quad;a.renderText=true}var n=e.BitmapFont.getTexture(i);if(!n){n=e.BitmapFont.getTexture("?".charCodeAt(0))}a.width=n.width;a.height=n.height;a.texture=n;a.color=this._textColor;if(r){this._fontQuadPanel.addChild(a)}return a};o.prototype.deleteFontQuad=function(t){if(this._blankQuad==t)return;this._fontQuadPanel.removeChild(t);this._quadPool.push(t)};return o}(t.DisplayObject);e.UITextField=s})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._label="";this._textField=new t.UITextField;this._textField.autoSize=t.UITextFieldAutoSize.CENTER;this._textField.textColor=4278190080;this.addChild(this._textField);this.onRender();this._textHeight=-1;this._textWidth=-1}i.prototype.getDefaultStyleNameByStyleName=function(e){var i={down:t.DefaultSkinName.DEFAULT_LABE_BUTTON_DOWN,up:t.DefaultSkinName.DEFAULT_LABEL_BUTTON_UP,disable:t.DefaultSkinName.DEFAULT_LABE_BUTTON_DISABLE};var r=i[e];if(!r){console.log(" ERROR!!! UILabelButton can't find default style : ",e)}return r};Object.defineProperty(i.prototype,"textHeight",{get:function(){return this._textHeight},set:function(t){this._textHeight=t;this.onRender()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"textWidth",{get:function(){return this._textWidth},set:function(t){this._textWidth=t;this.onRender()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"textField",{get:function(){return this._textField},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"label",{get:function(){return this._label},set:function(t){this._label=t;this._textField.text=this._label},enumerable:true,configurable:true});i.prototype.onRender=function(){e.prototype.onRender.call(this);if(this._textHeight>0){this.textField.textHeight=this._textHeight}else{this._textField.height=this._skin.height}if(this._textWidth>0){this.textField.textWidth=this._textWidth}else{this._textField.width=this._skin.width}};return i}(t.UIButton);t.UILabelButton=e})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(i){__extends(r,i);function r(){i.call(this);this._selected=false;this._textPadding=5;this.textField.autoSize=e.UITextFieldAutoSize.LEFT;this.textWidth=45;this.onRender()}Object.defineProperty(r.prototype,"buttonAndLabelWidth",{get:function(){return this._skin.width+this.textPadding+this.textWidth},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"textPadding",{get:function(){return this._textPadding},set:function(t){this._textPadding=t;this.onRender()},enumerable:true,configurable:true});r.prototype.onRender=function(){i.prototype.onRender.call(this);this.textField.x=this._skin.width+this._textPadding};Object.defineProperty(r.prototype,"selected",{get:function(){return this._selected},set:function(i){if(this._selected===i)return;this._selected=i;this._selected?this.setMouseState(r.STATE_UP_AND_SELECTED):this.setMouseState(e.UIButton.STATE_UP);var a=new t.Event3D(t.Event3D.CHANGE);a.target=this;this.dispatchEvent(a)},enumerable:true,configurable:true});r.prototype.setMouseState=function(t){if(t===e.UIButton.STATE_DOWN){this._selected?i.prototype.setMouseState.call(this,r.STATE_DOWN_AND_SELECTED):i.prototype.setMouseState.call(this,e.UIButton.STATE_DOWN)}else if(t===e.UIButton.STATE_UP){this._selected?i.prototype.setMouseState.call(this,r.STATE_UP_AND_SELECTED):i.prototype.setMouseState.call(this,e.UIButton.STATE_UP)}else{i.prototype.setMouseState.call(this,t)}};r.prototype.startPress=function(){i.prototype.startPress.call(this);this._selected?this.setMouseState(r.STATE_DOWN_AND_SELECTED):this.setMouseState(e.UIButton.STATE_DOWN)};r.prototype.endPress=function(){i.prototype.endPress.call(this);this.selected=!this.selected;this._selected?this.setMouseState(r.STATE_UP_AND_SELECTED):this.setMouseState(e.UIButton.STATE_UP)};r.STATE_DOWN_AND_SELECTED="downAndSelected";r.STATE_UP_AND_SELECTED="upAndSelected";return r}(e.UILabelButton);e.UIToggleButtonBase=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(i){__extends(r,i);function r(){i.call(this);this._background=new t.Quad;this._container=new e.UIElement;i.prototype.addChild.call(this,this._background);i.prototype.addChild.call(this,this._container);this._w=100;this._h=100;this.drawBackground();this.updateMask()}r.prototype.updateMask=function(){this.mask=new t.Rectangle(0,0,this._w,this._h)};Object.defineProperty(r.prototype,"background",{get:function(){return this._background},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"width",{get:function(){return this._w},set:function(t){this._w=t;this._background.width=t;this.updateMask()},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"height",{get:function(){return this._h},set:function(t){this._h=t;this._background.height=t;this.updateMask()},enumerable:true,configurable:true});r.prototype.onRender=function(){i.prototype.onRender.call(this);this.drawBackground();this.updateMask()};r.prototype.getDefaultStyleNameByStyleName=function(t){var i={background:e.DefaultSkinName.DEFAULT_PANEL_BACKGROUND};var r=i[t];if(!r){console.log(" ERROR!!! UIPanel can't find default style : ",t)}return r};r.prototype.drawBackground=function(){var t=this.getStyle("background");this._background.texture=t};r.prototype.setStyle=function(t,e){i.prototype.setStyle.call(this,t,e);this.onRender()};r.prototype.addChild=function(t){return this._container.addChild(t)};r.prototype.addChildAt=function(t,e){return this._container.addChildAt(t,e)};r.prototype.removeChild=function(t){return this._container.removeChild(t)};r.prototype.removeChildAt=function(t){return this._container.removeChildAt(t)};r.prototype.swapChildIndex=function(t,e){this._container.swapChildIndex(t,e)};r.prototype.hasChild=function(t){return this._container.hasChild(t)};r.prototype.getChildByIndex=function(t){return this._container.getChildByIndex(t)};r.prototype.getChildByName=function(t){return this._container.getChildByName(t)};return r}(e.UIElement);e.UIPanel=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(e){__extends(i,e);function i(){e.call(this);this._items=[];this._gap=5;this._selectedIndex=-1;this._selectedItem=null;this.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.onMouseDown,this);this._startDrag=false;this._container.height=0}i.prototype.onMouseDown=function(e){this._startDrag=true;this.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this);this.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this);if(this.stage){this.stage.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this)}};i.prototype.onMouseUp=function(e){this._startDrag=false;this.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this);this.removeEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this);if(this.stage){this.stage.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this)}};i.prototype.onMouseMove=function(e){if(this._startDrag){this._container.y+=t.Input.mouseOffsetY;if(this._container.y>0){this._container.y=0}else if(this._containerHeight<this.height){this._container.y=0}else if(this._container.y<this.height-this._containerHeight){this._container.y=this.height-this._containerHeight}}};i.prototype.updateView=function(){var t=0;for(var e=0;e<this._items.length;e++){var i=this._items[e];i.y=t;t=i.y+i.height+this._gap}this._containerHeight=t};Object.defineProperty(i.prototype,"gap",{get:function(){return this._gap},set:function(t){this._gap=t;this.updateView()},enumerable:true,configurable:true});i.prototype.addItem=function(t){this._items.push(t);this.addChildAt(t,this._container.childs.length);this.updateView()};i.prototype.removeItem=function(t){this.removeChild(t);this._items.splice(this._items.indexOf(t),1);this.updateView()};return i}(t.gui.UIPanel);e.UIList=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this)}i.prototype.getDefaultStyleNameByStyleName=function(e){var i={down:t.DefaultSkinName.DEFAULT_CHECK_BOX_DOWN,up:t.DefaultSkinName.DEFAULT_CHECK_BOX_UP,downAndSelected:t.DefaultSkinName.DEFAULT_CHECK_BOX_SELECTED_DOWN,upAndSelected:t.DefaultSkinName.DEFAULT_CHECK_BOX_SELECTED_UP,disable:t.DefaultSkinName.DEFAULT_CHECK_BOX_DISABLE};var r=i[e];if(!r){console.log(" ERROR!!! UICheckBox can't find default style : ",e)}return r};return i}(t.UIToggleButtonBase);t.UICheckBox=e})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this)}Object.defineProperty(i.prototype,"group",{set:function(t){this._group=t},enumerable:true,configurable:true});i.prototype.getDefaultStyleNameByStyleName=function(e){var i={down:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_DOWN,up:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_UP,downAndSelected:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_SELECTED_DOWN,upAndSelected:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_SELECTED_UP,disable:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_DISABLE};var r=i[e];if(!r){console.log(" ERROR!!! UIRadioButton can't find default style : ",e)}return r};return i}(t.UIToggleButtonBase);t.UIRadioButton=e})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(e){__extends(i,e);function i(){e.call(this);this._items=[];this._enable=true}Object.defineProperty(i.prototype,"enable",{get:function(){return this._enable},set:function(t){if(this._enable===t)return;this._enable=t;for(var e=0;e<this._items.length;e++){var i=this._items[e];i.enable=t}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"selection",{get:function(){return this._selection},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"selectedIndex",{get:function(){return this._items.indexOf(this._selection)},set:function(t){var e=this._items[t];if(e){e.selected=true}},enumerable:true,configurable:true});i.prototype.addItem=function(e){this._items.push(e);e.enable=this._enable;e.addEventListener(t.Event3D.CHANGE,this.onItemChange,this)};i.prototype.removeItem=function(e){var i=this._items.indexOf(e);if(i!==-1){e.removeEventListener(t.Event3D.CHANGE,this.onItemChange,this);this._items.splice(i,1)}};i.prototype.getRadioButtonAt=function(t){return this._items[t]};i.prototype.onItemChange=function(t){var e=t.target;this.changeSelectedItem(e)};i.prototype.changeSelectedItem=function(e){if(e.selected===false)return;if(this._selection===e){return}if(this._selection)this._selection.selected=false;this._selection=e;var i=new t.Event3D(t.Event3D.CHANGE);i.target=this;this.dispatchEvent(i)};return i}(t.EventDispatcher);e.UIRadioButtonGroup=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(i){__extends(r,i);function r(){i.call(this);this._mask=new t.Rectangle;this._background=new t.Quad;this.addChild(this._background);this._bar=new t.Quad;this.addChild(this._bar);this._ratio=.5;this.updateStyle()}Object.defineProperty(r.prototype,"ratio",{get:function(){return this._ratio},set:function(t){if(t>1){t=1}else if(t<0){t=0}this._ratio=t;this.updateBar()},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"width",{get:function(){return this._background.width},set:function(t){this._background.width=this._bar.width=t},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"height",{get:function(){return this._background.height},set:function(t){this._background.height=this._bar.height=t},enumerable:true,configurable:true});r.prototype.setBarRect=function(t,e,i,r){this._bar.x=t;this._bar.y=e;this._bar.width=i;this._bar.height=r};Object.defineProperty(r.prototype,"bar",{get:function(){return this._bar},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"background",{get:function(){return this._background},enumerable:true,configurable:true});r.prototype.updateBar=function(){this._mask.width=this._ratio*this._bar.width;this._mask.height=this._bar.height;this._bar.mask=this._mask};r.prototype.setStyle=function(t,e){i.prototype.setStyle.call(this,t,e);this.updateStyle();this.updateBar()};r.prototype.getDefaultStyleNameByStyleName=function(t){var i={bar:e.DefaultSkinName.DEFAULT_PROGRESS_BAR,background:e.DefaultSkinName.DEFAULT_PROGRESS_BAR_BACKGROUND};var r=i[t];if(!r){console.log(" ERROR!!! UISlider can't find default style : ",t)}return r};r.prototype.updateStyle=function(){this._background.texture=this.getStyle("background");this._bar.texture=this.getStyle("bar")};return r}(e.UIElement);e.UIProgressBar=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){var e;(function(e){var i=function(i){__extends(r,i);function r(){i.call(this);this._background=new t.Quad;this._bar=new t.Quad;this._text=new e.UITextField(e.UITextFieldType.DYNAMIC);this._text.autoSize=e.UITextFieldAutoSize.CENTER;this._text.textColor=4278190080;this.addChild(this._background);this.addChild(this._bar);this.addChild(this._text);this._minimum=0;this._maximum=100;this._snapInterval=10;this.value=50;this.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.onMouseDown,this);this.drawTexture()}r.prototype.setStyle=function(t,e){i.prototype.setStyle.call(this,t,e);this.drawTexture();this.onRender()};r.prototype.drawTexture=function(){this._bar.texture=this.getStyle("bar");this._background.texture=this.getStyle("background")};r.prototype.getDefaultStyleNameByStyleName=function(t){var i={bar:e.DefaultSkinName.DEFAULT_SLIDER_BAR,background:e.DefaultSkinName.DEFAULT_SLIDER_BACKGROUND};var r=i[t];if(!r){console.log(" ERROR!!! UISlider can't find default style : ",t)}return r};r.prototype.onMouseUp=function(e){this.removeEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this);this.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this)};r.prototype.onMouseDown=function(e){this.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this);if(this.stage){this.stage.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this)}var i=this.mouseX;this.value=i/this._background.width*(this._maximum-this._minimum)+this._minimum};r.prototype.updateBar=function(){var t=Math.abs((this._value-this._minimum)/(this._maximum-this._minimum));this._bar.width=this._background.width*t;this._text.text=this.value.toString()};Object.defineProperty(r.prototype,"snapInterval",{get:function(){return this._snapInterval},set:function(t){this._snapInterval=t},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"value",{get:function(){return this._value},set:function(e){if(e%this._snapInterval!==0){e=Math.round(e/this._snapInterval)*this._snapInterval}if(this._value===e)return;this._value=e;var i=new t.Event3D(t.Event3D.CHANGE);this.dispatchEvent(i);this.updateBar()},enumerable:true,configurable:true});r.prototype.onMouseMove=function(t){var e=this.mouseX;this.value=e/this._background.width*(this._maximum-this._minimum)+this._minimum};Object.defineProperty(r.prototype,"maximum",{get:function(){return this._maximum},set:function(t){this._maximum=t},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"minimum",{get:function(){return this._minimum},set:function(t){this._minimum=t},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"width",{get:function(){return this._background.width},set:function(t){this._background.width=this._text.width=t},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"height",{get:function(){return this._background.height},set:function(t){this._background.height=this._text.height=this._bar.height=t},enumerable:true,configurable:true});return r}(e.UIElement);e.UISlider=i})(e=t.gui||(t.gui={}))})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["pointlight"]=0]="pointlight";t[t["directlight"]=1]="directlight";t[t["spotLightlight"]=2]="spotLightlight"})(t.LightType||(t.LightType={}));var e=t.LightType;var i=function(e){__extends(i,e);function i(){e.call(this);this.lightId=-1;this.lightType=-1;this._ambient=new t.Vector3D(0,0,0);this._diffuse=new t.Vector3D(1,1,1);this._specular=new t.Vector3D(1,1,1);this._halfVector=new t.Vector3D(1,1,1);this._intensity=1;this._radius=100;this._cutoff=.01;this._halfIntensity=0;this._spotExponent=1.1;this._spotCutoff=.7;this._spotCosCutoff=.1;this._constantAttenuation=.1;this._linearAttenuation=.1;this._quadraticAttenuation=.1;this._lightIndex=-1;this.len=25;this._change=true;this.lightViewPos=new t.Vector3D}Object.defineProperty(i.prototype,"intensity",{get:function(){return this._intensity},set:function(t){if(this._intensity!=t){this._intensity=t;this._change=false}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"halfIntensity",{get:function(){return this._halfIntensity},set:function(t){if(this._halfIntensity!=t){this._halfIntensity=t;this._change=false}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"ambient",{get:function(){return 0},set:function(t){this._ambient.w=(t>>24&255)/255;this._ambient.x=(t>>16&255)/255;this._ambient.y=(t>>8&255)/255;this._ambient.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"diffuse",{get:function(){return 0},set:function(t){this._diffuse.w=(t>>24&255)/255;this._diffuse.x=(t>>16&255)/255;this._diffuse.y=(t>>8&255)/255;this._diffuse.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"specular",{get:function(){return 0},set:function(t){this._specular.w=(t>>24&255)/255;this._specular.x=(t>>16&255)/255;this._specular.y=(t>>8&255)/255;this._specular.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});i.prototype.init=function(){};i.prototype.updateLightData=function(t,e,i){};return i}(t.Object3D);t.LightBase=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=16777215}e.call(this);this.scenePosMat=new t.Matrix4_4;this.lightType=t.LightType.pointlight;this.diffuse=i}Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cutoff",{get:function(){return this._cutoff},set:function(t){this._cutoff=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"ambient",{set:function(t){this._ambient.w=(t>>24&255)/255;this._ambient.x=(t>>16&255)/255;this._ambient.y=(t>>8&255)/255;this._ambient.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});i.prototype.updateLightData=function(t,e,r){r[e*i.stride]=this.globalPosition.x;r[e*i.stride+1]=this.globalPosition.y;r[e*i.stride+2]=this.globalPosition.z;r[e*i.stride+3]=this._diffuse.x*this._intensity;r[e*i.stride+4]=this._diffuse.y*this._intensity;r[e*i.stride+5]=this._diffuse.z*this._intensity;r[e*i.stride+6]=this._ambient.x;r[e*i.stride+7]=this._ambient.y;r[e*i.stride+8]=this._ambient.z;r[e*i.stride+9]=this._intensity;r[e*i.stride+10]=this._radius;r[e*i.stride+11]=this._cutoff};i.scenePos=new t.Vector3D;i.stride=12;return i}(t.LightBase);t.PointLight=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this);this.diffuse=i;this.lightType=t.LightType.spotLightlight}Object.defineProperty(i.prototype,"spotCosCutoff",{get:function(){return this._spotCosCutoff},set:function(t){this._spotCosCutoff=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"spotExponent",{get:function(){return this._spotExponent},set:function(t){this._spotExponent=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"constantAttenuation",{get:function(){return this._constantAttenuation},set:function(t){this._constantAttenuation=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"linearAttenuation",{get:function(){return this._linearAttenuation},set:function(t){this._linearAttenuation=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"quadraticAttenuation",{get:function(){return this._quadraticAttenuation},set:function(t){this._quadraticAttenuation=t},enumerable:true,configurable:true});i.prototype.updateLightData=function(e,r,a){a[r*i.stride]=this.globalPosition.x;a[r*i.stride+1]=this.globalPosition.y;a[r*i.stride+2]=this.globalPosition.z;a[r*i.stride+3]=this.globalRotation.x*t.MathUtil.DEGREES_TO_RADIANS;a[r*i.stride+4]=this.globalRotation.y*t.MathUtil.DEGREES_TO_RADIANS;a[r*i.stride+5]=this.globalRotation.z*t.MathUtil.DEGREES_TO_RADIANS;a[r*i.stride+6]=this._diffuse.x;a[r*i.stride+7]=this._diffuse.y;a[r*i.stride+8]=this._diffuse.z;a[r*i.stride+9]=this._spotExponent;a[r*i.stride+10]=this._spotCosCutoff;a[r*i.stride+11]=this._constantAttenuation;a[r*i.stride+12]=this._linearAttenuation;a[r*i.stride+13]=this._quadraticAttenuation};i.stride=14;return i}(t.LightBase);t.SpotLight=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(r){if(r===void 0){r=new t.Vector3D(0,0,1)}e.call(this);
this._dir=new t.Vector3D(0,0,1);this._dir.copyFrom(r);this._dir.normalize();t.Quaternion.fromToRotation(t.Vector3D.Z_AXIS,this._dir,i.q0);this.globalOrientation=i.q0;this.lightType=t.LightType.directlight}Object.defineProperty(i.prototype,"ambient",{set:function(t){this._ambient.w=(t>>24&255)/255;this._ambient.x=(t>>16&255)/255;this._ambient.y=(t>>8&255)/255;this._ambient.z=(t&255)/255;this._change=false},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"dir",{get:function(){if(this._transformChange){this.modelMatrix}return this._dir},set:function(e){this._dir.copyFrom(e);this._dir.normalize();t.Quaternion.fromToRotation(t.Vector3D.Z_AXIS,this._dir,i.q0);this.globalOrientation=i.q0},enumerable:true,configurable:true});i.prototype.onUpdateTransform=function(){e.prototype.onUpdateTransform.call(this);this.globalOrientation.transformVector(t.Vector3D.Z_AXIS,this._dir);this._dir.normalize()};i.prototype.updateLightData=function(t,e,r){var a=this.dir;r[e*i.stride+0]=a.x;r[e*i.stride+1]=a.y;r[e*i.stride+2]=a.z;r[e*i.stride+3]=this._diffuse.x*this._intensity;r[e*i.stride+4]=this._diffuse.y*this._intensity;r[e*i.stride+5]=this._diffuse.z*this._intensity;r[e*i.stride+6]=this._ambient.x;r[e*i.stride+7]=this._ambient.y;r[e*i.stride+8]=this._ambient.z};i.q0=new t.Quaternion;i.stride=9;return i}(t.LightBase);t.DirectLight=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.lightNum=0;this.event=new t.Event3D;this.directLightList=new Array;this.spotLightList=new Array;this.pointLightList=new Array}i.prototype.addLight=function(e){switch(e.lightType){case t.LightType.directlight:this.directLightList.push(e);this.lightNum++;this.event.eventType=i.EVENT_LIGHT_RESET;this.dispatchEvent(this.event);break;case t.LightType.pointlight:this.pointLightList.push(e);this.lightNum++;this.event.eventType=i.EVENT_LIGHT_RESET;this.dispatchEvent(this.event);break;case t.LightType.spotLightlight:this.spotLightList.push(e);this.lightNum++;this.event.eventType=i.EVENT_LIGHT_RESET;this.dispatchEvent(this.event);break}};i.prototype.removeLight=function(e){switch(e.lightType){case t.LightType.directlight:var r=this.directLightList.indexOf(e);if(r>=0&&r<this.directLightList.length){this.directLightList.splice(r,1);this.lightNum--;this.event.eventType=i.EVENT_LIGHT_RESET;this.dispatchEvent(this.event)}break;case t.LightType.pointlight:var r=this.pointLightList.indexOf(e);if(r>=0&&r<this.pointLightList.length){this.pointLightList.splice(r,1);this.lightNum--;this.event.eventType=i.EVENT_LIGHT_RESET;this.dispatchEvent(this.event)}break;case t.LightType.spotLightlight:var r=this.spotLightList.indexOf(e);if(r>=0&&r<this.spotLightList.length){this.spotLightList.splice(r,1);this.lightNum--;this.event.eventType=i.EVENT_LIGHT_RESET;this.dispatchEvent(this.event)}break}};i.EVENT_LIGHT_RESET="Event_Light_Reset";return i}(t.EventDispatcher);t.LightGroup=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this._num=0;this._objDict={};this.renderList=new Array}Object.defineProperty(t.prototype,"root",{get:function(){return this.rootScene},set:function(t){this.rootScene=t},enumerable:true,configurable:true});t.prototype.update=function(t){t.modelMatrix;this.renderList.length=0};t.prototype.findRenderObject=function(t){for(var e=0;e<this.renderList.length;++e){if(this.renderList[e]===t){return e}}return-1};return t}();t.CollectBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["Shadow"]=0]="Shadow";t[t["Pick"]=1]="Pick"})(t.SpecialCast||(t.SpecialCast={}));var e=t.SpecialCast;var i=function(i){__extends(r,i);function r(){i.call(this);this.numberVertex=0;this.numberFace=0;this.numberDraw=0;this.numberSkin=0;this.numberAnimation=0;this.numberParticle=0;this.numberCastShadow=0;this.numberAcceptShadow=0;this.numberPick=0;this.softLayerRenderItems={};this.specialCastItem={};this.specialCastItem[e.Shadow]=[];this.specialCastItem[e.Pick]=[]}r.prototype.applyRender=function(t,i){if(t.canPick){this.specialCastItem[e.Pick].push(t);this.numberPick++}if(!t.visible){return}this.addRenderList(t,i);for(var r=0;r<t.childs.length;r++){this.applyRender(t.childs[r],i)}};r.prototype.addRenderList=function(i,r,a){if(a===void 0){a=true}if(a){if(!r.isVisibleToCamera(i)){return}}if(!i.material)return;if(i.enablePick){this.specialCastItem[e.Pick].push(i);this.numberPick++}if(i.material.castShadow){this.specialCastItem[e.Shadow].push(i);this.numberCastShadow++}if(i.material.acceptShadow){this.numberAcceptShadow++}for(var n=0;n<t.Layer.layerType.length;n++){if(i.material.materialData.alphaBlending&&i.tag.name=="normalObject"){var o=r.object3DToScreenRay(i.position,t.Vector3D.HELP_0);i.zIndex=t.Vector3D.HELP_0.z;this.softLayerRenderItems["alphaObject"].push(i)}else if(i.tag.name==t.Layer.layerType[n]){this.softLayerRenderItems[t.Layer.layerType[n]].push(i)}}if(t.Egret3DEngine.instance.debug){this.numberFace+=i.geometry.faceCount;this.numberVertex+=i.geometry.vertexCount;this.numberDraw+=1;if(i.animation)this.numberSkin+=1;if(i.proAnimation)this.numberAnimation+=1;if(i.type==t.IRender.TYPE_PARTICLE_EMIT)this.numberParticle+=1}};r.prototype.update=function(e){i.prototype.update.call(this,e);this.numberFace=0;this.numberVertex=0;this.numberDraw=0;this.numberSkin=0;this.numberAnimation=0;this.numberParticle=0;this.numberCastShadow=0;this.numberPick=0;this.numberAcceptShadow=0;this.clearList();if(this.rootScene.quad){var r=e.frustum.box;var a=this.rootScene.quad.getNodesByAABB(r.min.x,r.min.y,r.max.x,r.max.y);this.appendQuadList(a,e)}else{t.Egret3DState.countStart();this.applyRender(this.rootScene,e);t.Egret3DState.countEnd("entityCollect applyRender")}var n;var o;var s;o=t.Layer.layerType[2];n=this.softLayerRenderItems[o];if(n&&n.length){s=n.length;n.sort(this.alphaZSort)}for(var h=0;h<t.Layer.layerType.length;h++){o=t.Layer.layerType[h];n=this.softLayerRenderItems[o];if(n){s=n.length;n.sort(this.sortByOrder);for(var u=0;u<s;u++){this.renderList.push(n[u])}}}};r.prototype.appendQuadList=function(e,i){var r;var a;for(var n=0,o=e;n<o.length;n++){a=o[n];if(!(a instanceof t.Mesh))continue;r=a;if(r&&r.visible&&r["material"])this.addRenderList(r,i,false)}};r.prototype.clearList=function(){for(var e=0;e<t.Layer.layerType.length;e++){if(!this.softLayerRenderItems[t.Layer.layerType[e]]){this.softLayerRenderItems[t.Layer.layerType[e]]=[]}else this.softLayerRenderItems[t.Layer.layerType[e]].length=0}for(var i in this.specialCastItem){this.specialCastItem[i].length=0}};r.prototype.sort=function(e,i,r){var a=t.Vector3D.distance(e.globalPosition,r.position);var n=t.Vector3D.distance(i.globalPosition,r.position);if(a>n){return-1}else if(a<n){return 1}return 0};r.prototype.sortByOrder=function(t,e){return e.drawOrder-t.drawOrder};r.prototype.alphaZSort=function(t,e){return e.zIndex-t.zIndex};return r}(t.CollectBase);t.EntityCollect=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){if(e===void 0){e=null}this._vtxNum=8;this._planeNum=6;this._frustum=new t.Wireframe;this.nearCenter=new t.Vector3D;this.farCenter=new t.Vector3D;this._tempVector=new t.Vector3D;this.camera=e;this._vertex=new Array;for(var i=0;i<this._vtxNum;++i){this._vertex.push(new t.Vector3D)}this._tempVertices=new Array;for(var i=0;i<this._vtxNum;++i){this._tempVertices.push(new t.Vector3D)}this._pos=new t.Vector3D;this._plane=new Array;for(var i=0;i<6;++i){this._plane.push(new t.Plane3D)}this.box=new t.BoundBox(null,new t.Vector3D,new t.Vector3D);this.center=new t.Vector3D;this._frustum.material.diffuseColor=16777215;this._frustum.name="CameraFrustum";this._frustum.geometry.vertexCount=8;this._frustum.geometry.indexCount=24;this._frustum.geometry.setVertexIndices(0,[0,1,1,2,2,3,0,3,4,5,5,6,6,7,4,7,0,4,1,5,3,7,2,6])}Object.defineProperty(e.prototype,"vertices",{get:function(){return this._vertex},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"wireframe",{get:function(){return this._frustum},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"visible",{get:function(){return this._frustum.parent?true:false},set:function(t){if(t){if(!this._frustum.parent){this.camera.addChild(this._frustum)}else{if(this._frustum.parent!=this.camera){this._frustum.parent.removeChild(this._frustum);this.camera.addChild(this._frustum)}}}else{if(this._frustum.parent){this._frustum.parent.removeChild(this._frustum)}}},enumerable:true,configurable:true});e.prototype.makeFrustum=function(t,e,i,r){var a=Math.tan(t/2*(Math.PI/180));var n=i*a;var o=n*e;var s=r*a;var h=s*e;this._vertex[0].x=o;this._vertex[0].y=n;this._vertex[0].z=i;this._vertex[1].x=-o;this._vertex[1].y=n;this._vertex[1].z=i;this._vertex[2].x=-o;this._vertex[2].y=-n;this._vertex[2].z=i;this._vertex[3].x=o;this._vertex[3].y=-n;this._vertex[3].z=i;this._vertex[4].x=h;this._vertex[4].y=s;this._vertex[4].z=r;this._vertex[5].x=-h;this._vertex[5].y=s;this._vertex[5].z=r;this._vertex[6].x=-h;this._vertex[6].y=-s;this._vertex[6].z=r;this._vertex[7].x=h;this._vertex[7].y=-s;this._vertex[7].z=r};e.prototype.makeOrthoFrustum=function(t,e,i,r){this._vertex[0].x=t/2;this._vertex[0].y=e/2;this._vertex[0].z=i;this._vertex[1].x=-t/2;this._vertex[1].y=e/2;this._vertex[1].z=i;this._vertex[2].x=-t/2;this._vertex[2].y=-e/2;this._vertex[2].z=i;this._vertex[3].x=t/2;this._vertex[3].y=-e/2;this._vertex[3].z=i;this._vertex[4].x=t/2;this._vertex[4].y=e/2;this._vertex[4].z=r;this._vertex[5].x=-t/2;this._vertex[5].y=e/2;this._vertex[5].z=r;this._vertex[6].x=-t/2;this._vertex[6].y=-e/2;this._vertex[6].z=r;this._vertex[7].x=t/2;this._vertex[7].y=-e/2;this._vertex[7].z=r};e.prototype.makeOrthoToCenterFrustum=function(t,e,i,r,a,n){this._vertex[0].x=e;this._vertex[0].y=r;this._vertex[0].z=a;this._vertex[1].x=t;this._vertex[1].y=r;this._vertex[1].z=a;this._vertex[2].x=t;this._vertex[2].y=i;this._vertex[2].z=a;this._vertex[3].x=e;this._vertex[3].y=i;this._vertex[3].z=a;this._vertex[4].x=e;this._vertex[4].y=r;this._vertex[4].z=n;this._vertex[5].x=t;this._vertex[5].y=r;this._vertex[5].z=n;this._vertex[6].x=t;this._vertex[6].y=i;this._vertex[6].z=n;this._vertex[7].x=e;this._vertex[7].y=i;this._vertex[7].z=n};e.prototype.updateFrustum=function(){switch(this.camera.cameraType){case t.CameraType.perspective:this.makeFrustum(this.camera.fieldOfView,this.camera.aspectRatio,this.camera.near,this.camera.far);break;case t.CameraType.orthogonal:this.makeOrthoFrustum(this.camera.viewPort.width,this.camera.viewPort.height,this.camera.near,this.camera.far);break;case t.CameraType.orthogonalToCenter:this.makeOrthoToCenterFrustum(this.camera.viewPort.x,this.camera.viewPort.y,this.camera.viewPort.width,this.camera.viewPort.height,this.camera.near,this.camera.far);break}for(var e=0;e<this.vertices.length;++e){this._frustum.geometry.setVerticesForIndex(e,t.VertexFormat.VF_POSITION,[this.vertices[e].x,this.vertices[e].y,this.vertices[e].z],1)}};e.prototype.update=function(){var e=t.Matrix4_4.helpMatrix;e.copyFrom(this.camera.modelMatrix);for(var i=0;i<this._vtxNum;++i){e.transformVector(this._vertex[i],this._tempVertices[i])}this.box.max.x=this.box.max.y=this.box.max.z=-t.MathUtil.MAX_VALUE;this.box.min.x=this.box.min.y=this.box.min.z=t.MathUtil.MAX_VALUE;for(var i=0;i<this._tempVertices.length;++i){if(this.box.max.x<this._tempVertices[i].x){this.box.max.x=this._tempVertices[i].x}if(this.box.max.y<this._tempVertices[i].y){this.box.max.y=this._tempVertices[i].y}if(this.box.max.z<this._tempVertices[i].z){this.box.max.z=this._tempVertices[i].z}if(this.box.min.x>this._tempVertices[i].x){this.box.min.x=this._tempVertices[i].x}if(this.box.min.y>this._tempVertices[i].y){this.box.min.y=this._tempVertices[i].y}if(this.box.min.z>this._tempVertices[i].z){this.box.min.z=this._tempVertices[i].z}}this.box.calculateBox();this._plane[0].fromPoints(this._tempVertices[4],this._tempVertices[5],this._tempVertices[6]);this._plane[1].fromPoints(this._tempVertices[1],this._tempVertices[6],this._tempVertices[5]);this._plane[2].fromPoints(this._tempVertices[0],this._tempVertices[4],this._tempVertices[7]);this._plane[3].fromPoints(this._tempVertices[1],this._tempVertices[0],this._tempVertices[3]);this._plane[4].fromPoints(this._tempVertices[1],this._tempVertices[5],this._tempVertices[4]);this._plane[5].fromPoints(this._tempVertices[3],this._tempVertices[7],this._tempVertices[6]);for(var i=0;i<this._planeNum;i++){this._plane[i].normalize()}this.nearCenter.copyFrom(this._tempVertices[0].subtract(this._tempVertices[2],t.MathUtil.CALCULATION_VECTOR3D_0));this.nearCenter.scaleBy(.5);this.nearCenter.copyFrom(this._tempVertices[2].add(this.nearCenter,t.MathUtil.CALCULATION_VECTOR3D_1));this.farCenter.copyFrom(this._tempVertices[4].subtract(this._tempVertices[6],t.MathUtil.CALCULATION_VECTOR3D_2));this.farCenter.scaleBy(.5);this.farCenter.copyFrom(this._tempVertices[6].add(this.farCenter,t.MathUtil.CALCULATION_VECTOR3D_0));this.center.copyFrom(this.farCenter.subtract(this.nearCenter,t.MathUtil.CALCULATION_VECTOR3D_1));this.center.scaleBy(.5);this.center.copyFrom(this.nearCenter.add(this.center,t.MathUtil.CALCULATION_VECTOR3D_2))};e.prototype.inPoint=function(t){var e=0;for(var i=0;i<this._plane.length;++i){e=this._plane[i].distance(t);if(e>0){return false}}return true};e.prototype.inSphere=function(t,e){var i=0;for(var r=0;r<this._plane.length;++r){i=this._plane[r].distance(t);if(i>e){return false}}return true};e.prototype.inBox=function(t){var e=0;var i=this._plane.length;for(var r=0;r<i;++r){var a=t.vexData.length/3;var n=t.vexData.length;for(var o=0;o<n;o+=3){this._tempVector.setTo(t.vexData[o],t.vexData[o+1],t.vexData[o+2]);t.transform.transformVector(this._tempVector,this._tempVector);e=this._plane[r].distance(this._tempVector);if(e>0){a--}}if(a<=0){return false}}return true};e.prototype.dispose=function(){if(this._frustum){this._frustum.dispose()}this._frustum=null};return e}();t.Frustum=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.TAG_NAME_NORMAL_OBJECT="normalObject";t.TAG_NAME_NORMAL_ALPHA_OBJECT="normalAlphaObject";t.TAG_NAME_ALPHA_OBJECT="alphaObject";t.TAG_NAME_DECAL="decal";t.TAG_NAME_EFFECT="effect";t.TAG_NAME_GUI="gui";t.layerType=["normalObject","normalAlphaObject","alphaObject","decal","effect","gui"];t.layerTypeThan=[3,2,1,0];t.layerNumber=5;return t}();t.Layer=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.name="normalObject";this.clearDepth=false}return t}();t.Tag=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.createRayToView=function(i,r){if(r===void 0){r=null}if(!r){r=e.ray}if(t.Input.mouseX<i.x||t.Input.mouseX>a+i.width||t.Input.mouseY<i.y||t.Input.mouseY>n+i.height){return null}var a=t.Input.mouseX-i.x;var n=t.Input.mouseY-i.y;r.CalculateAndTransformRay(i.width,i.height,i.camera3D.modelMatrix,i.camera3D.projectMatrix,a,n);return r};e.pickObject3D=function(t,i,r){if(r===void 0){r=null}r=r||[];r.length=0;var a=e.createRayToView(t);e.pickObject(a,i,r);return r};e.pickObject=function(t,i,r){if(r===void 0){r=null}if(e.doPickerObject(t,i)){r.push(i)}for(var a=0;a<i.childs.length;++a){e.pickObject(t,i.childs[a],r)}return r};e.doPickerObject=function(e,i){var r;switch(i.pickType){case t.PickType.BoundPick:if(i.bound!=null){var a=i.currentBound;if(a){if(e.IntersectBound(a,i.pickResult)){return true}}}return false;case t.PickType.PositionPick:if(i instanceof t.IRender){r=i;var n=0;if(r.geometry.vertexFormat&t.VertexFormat.VF_POSITION){n+=t.Geometry.positionSize}if(r.geometry.vertexFormat&t.VertexFormat.VF_NORMAL){n+=t.Geometry.normalSize}if(r.geometry.vertexFormat&t.VertexFormat.VF_TANGENT){n+=t.Geometry.tangentSize}if(r.geometry.vertexFormat&t.VertexFormat.VF_COLOR){n+=t.Geometry.colorSize}var o=r.bound;var s=[];if(e.IntersectSphere(o.center,o.radius,s,r.modelMatrix)){if(e.IntersectMeshEx(r,n,r.pickResult)){return true}}}return false;case t.PickType.UVPick:if(i instanceof t.IRender){r=i;var n=0;if(r.geometry.vertexFormat&t.VertexFormat.VF_POSITION){n+=t.Geometry.positionSize}if(r.geometry.vertexFormat&t.VertexFormat.VF_NORMAL){n+=t.Geometry.normalSize}if(r.geometry.vertexFormat&t.VertexFormat.VF_TANGENT){n+=t.Geometry.tangentSize}if(r.geometry.vertexFormat&t.VertexFormat.VF_COLOR){n+=t.Geometry.colorSize}var o=r.bound;if(e.IntersectSphere(o.center,o.radius,s,o.transform)){if(e.IntersectMeshEx(r,n,r.pickResult)){return true}}}return false}return false};e.pickObject3DList=function(t,i,r){if(r===void 0){r=null}if(!r){r=new Array}r.length=0;var a=e.createRayToView(t);for(var n=0;n<i.length;++n){if(e.doPickerObject(a,i[n])){r.push(i[n])}}return r};e.ray=new t.Ray;return e}();t.Picker=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["VF_POSITION"]=1]="VF_POSITION";t[t["VF_NORMAL"]=2]="VF_NORMAL";t[t["VF_TANGENT"]=4]="VF_TANGENT";t[t["VF_COLOR"]=8]="VF_COLOR";t[t["VF_UV0"]=16]="VF_UV0";t[t["VF_UV1"]=32]="VF_UV1";t[t["VF_SKIN"]=64]="VF_SKIN";t[t["VF_QUAD_UVREC"]=128]="VF_QUAD_UVREC";t[t["VF_QUAD_ROTATION"]=256]="VF_QUAD_ROTATION";t[t["VF_QUAD_MASK"]=1024]="VF_QUAD_MASK";t[t["VF_QUAD_POS"]=2048]="VF_QUAD_POS";t[t["VF_QUAD_ORIGN"]=4096]="VF_QUAD_ORIGN";t[t["VF_QUAD_COLOR"]=8192]="VF_QUAD_COLOR"})(t.VertexFormat||(t.VertexFormat={}));var e=t.VertexFormat;var i=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.drawType=t.Context3DProxy.gl.STATIC_DRAW;this._vertexFormat=0;this.vertexAttLength=0;this.faceOrBack=false;this.subGeometrys=[];this._bufferDiry=true;this._vertexCount=0;this._indexCount=0;this._totalIndexCount=0;this._faceCount=0}Object.defineProperty(r.prototype,"bufferDiry",{get:function(){return this._bufferDiry},set:function(t){this._bufferDiry=t},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"skeleton",{get:function(){return this._skeleton},set:function(t){if(!t){return}this._skeleton=t;this.skeletonGPUData=new Float32Array(t.jointNum*8);for(var e=0;e<t.jointNum;++e){this.skeletonGPUData[e*8+3]=1;this.skeletonGPUData[e*8+7]=1}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"vertexCount",{get:function(){return this._vertexCount},set:function(t){if(this._vertexCount==t){return}var e=t*this.vertexAttLength;var i=null;if(this.vertexArray){if(this.vertexCount<t){i=new Float32Array(e);i.set(this.vertexArray);delete this.vertexArray}else{i=this.vertexArray}}else{i=new Float32Array(e)}this.vertexArray=i;this._vertexCount=t},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"indexCount",{get:function(){return this._indexCount},set:function(t){this._indexCount=t;this._faceCount=t/3;if(this._totalIndexCount>=t){return}var e=new Uint16Array(t);if(this.indexArray){e.set(this.indexArray);delete this.indexArray}this.indexArray=e;this._totalIndexCount=t},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"faceCount",{get:function(){return this._faceCount},set:function(t){if(this._faceCount==t){return}this.indexCount=t*3;this._faceCount=t},enumerable:true,configurable:true});r.prototype.buildDefaultSubGeometry=function(){var e=new t.SubGeometry;e.matID=0;e.geometry=this;e.start=0;e.count=this.indexCount;this.subGeometrys.push(e)};Object.defineProperty(r.prototype,"vertexFormat",{get:function(){return this._vertexFormat},set:function(i){this._vertexFormat=i;if(this.vertexFormat&e.VF_POSITION){this.vertexAttLength+=r.positionSize}if(this.vertexFormat&e.VF_NORMAL){this.vertexAttLength+=r.normalSize}if(this.vertexFormat&e.VF_TANGENT){this.vertexAttLength+=r.tangentSize}if(this.vertexFormat&e.VF_COLOR){this.vertexAttLength+=r.colorSize}if(this.vertexFormat&e.VF_UV0){this.vertexAttLength+=r.uvSize}if(this.vertexFormat&e.VF_UV1){this.vertexAttLength+=r.uv2Size}if(this.vertexFormat&e.VF_SKIN){this.vertexAttLength+=r.skinSize}if(this.vertexFormat&e.VF_QUAD_UVREC){this.vertexAttLength+=t.QuadData.uvRectangleSize}if(this.vertexFormat&e.VF_QUAD_ROTATION){this.vertexAttLength+=t.QuadData.rotationSize}if(this.vertexFormat&e.VF_QUAD_MASK){this.vertexAttLength+=t.QuadData.maskSize}if(this.vertexFormat&e.VF_QUAD_POS){this.vertexAttLength+=t.QuadData.posSize}if(this.vertexFormat&e.VF_QUAD_ORIGN){this.vertexAttLength+=t.QuadData.originalSize}if(this.vertexFormat&e.VF_QUAD_COLOR){this.vertexAttLength+=t.QuadData.colorSize}this.vertexSizeInBytes=this.vertexAttLength*4},enumerable:true,configurable:true});r.prototype.activeState=function(t,e,i,r){if(this._bufferDiry){this._bufferDiry=false;this.upload(i,this.drawType)}i.bindVertexBuffer(this.sharedVertexBuffer);i.bindIndexBuffer(this.sharedIndexBuffer)};r.prototype.upload=function(e,i){if(i===void 0){i=t.Context3DProxy.gl.STATIC_DRAW}if(!this.sharedIndexBuffer&&!this.sharedVertexBuffer){this.sharedIndexBuffer=e.creatIndexBuffer(this.indexArray);this.sharedVertexBuffer=e.creatVertexBuffer(this.vertexArray,i)}else{e.uploadVertexBuffer(this.sharedVertexBuffer);e.uploadIndexBuffer(this.sharedIndexBuffer)}};r.prototype.getVertexForIndex=function(t,i,a,n){if(a===void 0){a=null}if(n===void 0){n=1}if(!a){a=new Array}if(t<0||t>=this.vertexCount){return a}for(var o=0;o<n;++o){var s=0;if(i&e.VF_POSITION){if(this.vertexFormat&e.VF_POSITION){a.push(this.vertexArray[t*this.vertexAttLength+s+0]);a.push(this.vertexArray[t*this.vertexAttLength+s+1]);a.push(this.vertexArray[t*this.vertexAttLength+s+2])}else{a.push(0,0,0)}}if(this.vertexFormat&e.VF_POSITION){s+=r.positionSize}if(i&e.VF_NORMAL){if(this.vertexFormat&e.VF_NORMAL){a.push(this.vertexArray[t*this.vertexAttLength+s+0]);a.push(this.vertexArray[t*this.vertexAttLength+s+1]);a.push(this.vertexArray[t*this.vertexAttLength+s+2])}else{a.push(0,0,0)}}if(this.vertexFormat&e.VF_NORMAL){s+=r.normalSize}if(i&e.VF_TANGENT){if(this.vertexFormat&e.VF_TANGENT){a.push(this.vertexArray[t*this.vertexAttLength+s+0]);a.push(this.vertexArray[t*this.vertexAttLength+s+1]);a.push(this.vertexArray[t*this.vertexAttLength+s+2])}else{a.push(0,0,0)}}if(this.vertexFormat&e.VF_TANGENT){s+=r.tangentSize}if(i&e.VF_COLOR){if(this.vertexFormat&e.VF_COLOR){a.push(this.vertexArray[t*this.vertexAttLength+s+0]);a.push(this.vertexArray[t*this.vertexAttLength+s+1]);a.push(this.vertexArray[t*this.vertexAttLength+s+2]);a.push(this.vertexArray[t*this.vertexAttLength+s+3])}else{a.push(0,0,0,0)}}if(this.vertexFormat&e.VF_COLOR){s+=r.colorSize}if(i&e.VF_UV0){if(this.vertexFormat&e.VF_UV0){a.push(this.vertexArray[t*this.vertexAttLength+s+0]);a.push(this.vertexArray[t*this.vertexAttLength+s+1])}else{a.push(0,0)}}if(this.vertexFormat&e.VF_UV0){s+=r.uvSize}if(i&e.VF_UV1){if(this.vertexFormat&e.VF_UV1){a.push(this.vertexArray[t*this.vertexAttLength+s+0]);a.push(this.vertexArray[t*this.vertexAttLength+s+1])}else{a.push(0,0)}}if(this.vertexFormat&e.VF_UV1){s+=r.uv2Size}if(i&e.VF_SKIN){if(this.vertexFormat&e.VF_SKIN){for(var h=0;h<r.skinSize;++h){a.push(this.vertexArray[t*this.vertexAttLength+s+h])}}else{a.push(0,0,0,0,0,0,0,0)}}if(this.vertexFormat&e.VF_SKIN){s+=r.skinSize}t++}return a};r.prototype.setVerticesForIndex=function(t,i,a,n){if(n===void 0){n=1}if(t+n>this.vertexCount){this.vertexCount=t+n}this._bufferDiry=true;var o=0;var s=0;for(var h=0;h<n;++h){o=0;if(this.vertexFormat&e.VF_POSITION){if(i&e.VF_POSITION){this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0];this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1];this.vertexArray[t*this.vertexAttLength+o+2]=a[s+2]}o+=r.positionSize}if(i&e.VF_POSITION){s+=r.positionSize}if(this.vertexFormat&e.VF_NORMAL){if(i&e.VF_NORMAL){this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0];this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1];this.vertexArray[t*this.vertexAttLength+o+2]=a[s+2]}o+=r.normalSize}if(i&e.VF_NORMAL){s+=r.normalSize}if(this.vertexFormat&e.VF_TANGENT){if(i&e.VF_TANGENT){this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0];this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1];this.vertexArray[t*this.vertexAttLength+o+2]=a[s+2]}o+=r.tangentSize}if(i&e.VF_TANGENT){s+=r.tangentSize}if(this.vertexFormat&e.VF_COLOR){if(i&e.VF_COLOR){this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0];this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1];this.vertexArray[t*this.vertexAttLength+o+2]=a[s+2];this.vertexArray[t*this.vertexAttLength+o+3]=a[s+3]}else{if(this.vertexArray[t*this.vertexAttLength+o+0]==0&&this.vertexArray[t*this.vertexAttLength+o+1]==0&&this.vertexArray[t*this.vertexAttLength+o+2]==0&&this.vertexArray[t*this.vertexAttLength+o+3]==0){this.vertexArray[t*this.vertexAttLength+o+0]=1;this.vertexArray[t*this.vertexAttLength+o+1]=1;this.vertexArray[t*this.vertexAttLength+o+2]=1;this.vertexArray[t*this.vertexAttLength+o+3]=1}}o+=r.colorSize}if(i&e.VF_COLOR){s+=r.colorSize}if(this.vertexFormat&e.VF_UV0){if(i&e.VF_UV0){this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0];this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1]}o+=r.uvSize}if(i&e.VF_UV0){s+=r.uvSize}if(this.vertexFormat&e.VF_UV1){if(i&e.VF_UV1){this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0];this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1]}o+=r.uv2Size}if(i&e.VF_UV1){s+=r.uv2Size}if(this.vertexFormat&e.VF_SKIN){if(i&e.VF_SKIN){for(var u=0;u<r.skinSize;++u){this.vertexArray[t*this.vertexAttLength+o+u]=a[s+u]}}o+=r.skinSize}if(i&e.VF_SKIN){s+=r.skinSize}t++}};r.prototype.getVertexIndices=function(t,e,i){if(e===void 0){e=-1}if(i===void 0){i=null}if(!i){i=new Array}if(t>=this.indexCount){return i}e==-1?e=this.indexCount:e;if(t+e>this.indexCount){e=this.indexCount-t}for(var r=0;r<e;++r){i[r]=this.indexArray[r+t]}return i};r.prototype.setVertexIndices=function(t,e){if(t+e.length>this.indexCount){this.indexCount=t+e.length}for(var i=0;i<e.length;++i){this.indexArray[t+i]=e[i]}};r.prototype.cloneMirror=function(e,i,a){var n=new r;n.vertexFormat=this.vertexFormat;n.vertexCount=this.vertexCount;n.indexCount=this.indexCount;var o=0;var s=new t.Vector3D;var h=new t.Vector3D;var u=new t.Vector3D(e?-1:1,i?-1:1,a?-1:1);var l=new t.Quaternion;n.vertexArray=new Float32Array(this.vertexArray.length);n.indexArray=new Float32Array(this.indexArray.length);for(o=0;o<n.vertexArray.length;o++){n.vertexArray[o]=this.vertexArray[o]}for(o=0;o<n.indexArray.length;o++){n.indexArray[o]=this.indexArray[o]}t.Matrix4_4.helpMatrix.makeTransform(h,u,l);for(o=0;o<this.vertexCount;o++){s.x=n.vertexArray[o*this.vertexAttLength];s.y=n.vertexArray[o*this.vertexAttLength+1];s.z=n.vertexArray[o*this.vertexAttLength+2];t.Matrix4_4.helpMatrix.transformVector(s,t.Vector3D.HELP_0);n.vertexArray[o*this.vertexAttLength]=t.Vector3D.HELP_0.x;n.vertexArray[o*this.vertexAttLength+1]=t.Vector3D.HELP_0.y;n.vertexArray[o*this.vertexAttLength+2]=t.Vector3D.HELP_0.z}for(o=0;o<this.indexCount/3;o++){s.x=n.indexArray[o*3+0];s.y=n.indexArray[o*3+1];s.z=n.indexArray[o*3+2];n.indexArray[o*3+0]=s.x;n.indexArray[o*3+1]=s.z;n.indexArray[o*3+2]=s.y}for(o=0;o<this.subGeometrys.length;++o){var c=new t.SubGeometry;c.matID=o;c.geometry=n;c.start=this.subGeometrys[o].start*3;c.count=this.subGeometrys[o].count*3;c.textureDiffuse=this.subGeometrys[o].textureDiffuse;c.textureNormal=this.subGeometrys[o].textureNormal;c.textureSpecular=this.subGeometrys[o].textureSpecular;n.subGeometrys.push(c)}return n};r.prototype.copy=function(e){this.vertexFormat=e.vertexFormat;this.vertexCount=e.vertexCount;this.indexCount=e.indexCount;for(var i=0;i<e.vertexArray.length;++i){this.vertexArray[i]=e.vertexArray[i]}for(var i=0;i<e.indexArray.length;++i){this.indexArray[i]=e.indexArray[i]}this.subGeometrys.length=0;for(var i=0;i<e.subGeometrys.length;++i){var r=new t.SubGeometry;this.subGeometrys.push(r);var a=e.subGeometrys[i];r.geometry=this;r.start=a.start;r.count=a.count;r.matID=a.matID;r.textureDiffuse=a.textureDiffuse;r.textureNormal=a.textureNormal;r.textureSpecular=a.textureSpecular}};r.prototype.dispose=function(){this.decRef();if(this.isDispose){if(this.sharedIndexBuffer){this.sharedIndexBuffer.dispose();this.sharedIndexBuffer=null}if(this.sharedVertexBuffer){this.sharedVertexBuffer.dispose();this.sharedVertexBuffer=null}this.vertexArray=null;this.indexArray=null;this.skeletonGPUData=null;this.skeleton=null;this.subGeometrys=[]}};r.positionSize=3;r.normalSize=3;r.tangentSize=3;r.colorSize=4;r.uvSize=2;r.uv2Size=2;r.skinSize=8;return r}(t.Reference);t.Geometry=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.vertexAttLength=17;this.vertLen=0;this.faces=0;this.source_indexData=new Array;this.source_vertexData=new Array;this.source_vertexColorData=new Array;this.source_normalData=new Array;this.source_tangtData=new Array;this.source_uvData=new Array;this.source_uv2Data=new Array;this.source_skinData=new Array;this.vertexIndex=0;this.indices=new Array;this.vertices=new Array;this.normals=new Array;this.tangts=new Array;this.verticesColor=new Array;this.uvs=new Array;this.uv2s=new Array;this.skinMesh=new Array;this.faceNormals=new Array;this.faceWeights=new Array;this.vertexIndices=new Array;this.uvIndices=new Array;this.uv2Indices=new Array;this.normalIndices=new Array;this.colorIndices=new Array;this.indexIds=new Array;this.matCount=0;this.material={}}e.buildGeomtry=function(e,i){var r=new t.Geometry;r.vertexFormat=i;r.vertexCount=e.faces*3;r.indexCount=e.faces*3;r.faceCount=e.faces;r.skeleton=e.skeleton;var a=new t.Vector3D;var n=new t.Vector3D(1,1,1);var o=new t.Vector3D(1,1,1,1);var s={u:1,v:0};var h={u:1,v:0};var u=0;var l=0;var c=0;for(var f=0;f<e.faces;f++){r.indexArray[f*3+0]=f*3+0;r.indexArray[f*3+1]=f*3+2;r.indexArray[f*3+2]=f*3+1;for(var d=0;d<3;d++){l=f*3+d;l*=r.vertexAttLength;c=0;u=e.vertexIndices[f*3+d]*t.Geometry.positionSize;if(i&t.VertexFormat.VF_POSITION){a.x=e.source_vertexData[u+0];a.y=e.source_vertexData[u+1];a.z=e.source_vertexData[u+2];r.vertexArray[l+c+0]=a.x;r.vertexArray[l+c+1]=a.y;r.vertexArray[l+c+2]=a.z;c+=t.Geometry.positionSize}if(i&t.VertexFormat.VF_NORMAL){if(e.normalIndices&&e.source_normalData&&e.source_normalData.length>0){u=e.normalIndices[f*3+d]*t.Geometry.normalSize;n.x=e.source_normalData[u+0];n.y=e.source_normalData[u+1];n.z=e.source_normalData[u+2]}r.vertexArray[l+c+0]=n.x;r.vertexArray[l+c+1]=n.y;r.vertexArray[l+c+2]=n.z;c+=t.Geometry.normalSize}if(i&t.VertexFormat.VF_TANGENT){r.vertexArray[l+c+0]=0;r.vertexArray[l+c+1]=0;r.vertexArray[l+c+2]=0;c+=t.Geometry.tangentSize}if(i&t.VertexFormat.VF_COLOR){if(e.colorIndices&&e.source_vertexColorData&&e.source_vertexColorData.length>0){u=e.colorIndices[f*3+d]*t.Geometry.colorSize;o.x=e.source_vertexColorData[u+0];o.y=e.source_vertexColorData[u+1];o.z=e.source_vertexColorData[u+2];o.w=e.source_vertexColorData[u+3]}r.vertexArray[l+c+0]=o.x;r.vertexArray[l+c+1]=o.y;r.vertexArray[l+c+2]=o.z;r.vertexArray[l+c+3]=o.w;c+=t.Geometry.colorSize}if(i&t.VertexFormat.VF_UV0){if(e.uvIndices&&e.source_uvData&&e.source_uvData.length>0){u=e.uvIndices[f*3+d]*t.Geometry.uvSize;s.u=e.source_uvData[u+0];s.v=e.source_uvData[u+1]}r.vertexArray[l+c+0]=s.u;r.vertexArray[l+c+1]=s.v;c+=t.Geometry.uvSize}if(i&t.VertexFormat.VF_UV1){if(e.uv2Indices&&e.source_uv2Data&&e.source_uv2Data.length>0){u=e.uv2Indices[f*3+d]*t.Geometry.uv2Size;h.u=e.source_uv2Data[u+0];h.v=e.source_uv2Data[u+1]}r.vertexArray[l+c+0]=h.u;r.vertexArray[l+c+1]=h.v;c+=t.Geometry.uv2Size}if(i&t.VertexFormat.VF_SKIN){if(e.source_skinData!=null&&e.source_skinData.length>0){u=e.vertexIndices[f*3+d]*t.Geometry.skinSize;r.vertexArray[l+c+0]=e.source_skinData[u+0];r.vertexArray[l+c+1]=e.source_skinData[u+2];r.vertexArray[l+c+2]=e.source_skinData[u+4];r.vertexArray[l+c+3]=e.source_skinData[u+6];r.vertexArray[l+c+4]=e.source_skinData[u+1];r.vertexArray[l+c+5]=e.source_skinData[u+3];r.vertexArray[l+c+6]=e.source_skinData[u+5];r.vertexArray[l+c+7]=e.source_skinData[u+7]}else{r.vertexArray[l+c+0]=0;r.vertexArray[l+c+1]=0;r.vertexArray[l+c+2]=0;r.vertexArray[l+c+3]=0;r.vertexArray[l+c+4]=0;r.vertexArray[l+c+5]=0;r.vertexArray[l+c+6]=0;r.vertexArray[l+c+7]=0}}}}for(var d=0;d<e.matCount;++d){var p=new t.SubGeometry;p.matID=d;p.geometry=r;p.start=e.material[d].start*3;p.count=e.material[d].count*3;p.textureDiffuse=e.material[d].textureDiffuse;p.textureNormal=e.material[d].textureNormal;p.textureSpecular=e.material[d].textureSpecular;
r.subGeometrys.push(p)}return r};e.combinGeomtryData=function(t,e){if(e===void 0){e=true}var i=0;var r=0;var a=0;var n=0;var o=0;var s=0;var h=0;var u=0;var l=t.vertexDatas;while(i<t.vertLen){l[i++]=t.vertices[r++];l[i++]=t.vertices[r++];l[i++]=t.vertices[r++];if(t.normals&&t.normals.length){l[i++]=t.normals[a++];l[i++]=t.normals[a++];l[i++]=t.normals[a++]}else{l[i++]=0;l[i++]=0;l[i++]=0}if(t.tangts){i++;i++;i++}else{l[i++]=0;l[i++]=0;l[i++]=0}if(t.source_vertexColorData&&t.source_vertexColorData.length){l[i++]=t.verticesColor[h++];l[i++]=t.verticesColor[h++];l[i++]=t.verticesColor[h++];l[i++]=t.verticesColor[h++]}else{l[i++]=1;l[i++]=1;l[i++]=1;l[i++]=1}if(t.uvs&&t.uvs.length){l[i++]=t.uvs[o++];l[i++]=t.uvs[o++];if(t.uv2s&&t.uv2s.length){l[i++]=t.uv2s[s++];l[i++]=t.uv2s[s++]}else{l[i++]=t.uvs[s++];l[i++]=t.uvs[s++]}}else{l[i++]=0;l[i++]=0;l[i++]=0;l[i++]=0}if(t.skinMesh&&t.skinMesh.length){l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++];l[i++]=t.skinMesh[u++]}}};e.updateFaceNormals=function(t){var e=0,i=0,r=0;var a;var n=t.indices.length;var o,s,h;var u,l,c;var f,d,p;var _,m,v;var g,y,x;var b,D,T;var P;var A=t.vertexDatas;var w=17;var S=3;while(e<n){a=S+t.indices[e++]*w;o=A[a];u=A[a+1];f=A[a+2];a=S+t.indices[e++]*w;s=A[a];l=A[a+1];d=A[a+2];a=S+t.indices[e++]*w;h=A[a];c=A[a+1];p=A[a+2];_=h-o;m=c-u;v=p-f;g=s-o;y=l-u;x=d-f;b=v*y-m*x;D=_*x-v*g;T=m*g-_*y;P=Math.sqrt(b*b+D*D+T*T);if(true){var C=P*1e4;if(C<1)C=1;t.faceWeights[r++]=C}P=1/P;t.faceNormals[i++]=b*P;t.faceNormals[i++]=D*P;t.faceNormals[i++]=T*P}};e.updateVertexNormals=function(t){this.updateFaceNormals(t);var e;var i=0,r=1,a=2;var n=t.vertexDatas.length;var o=17;var s=3;var h=0,u=0;var l=t.indices.length;var c;var f;while(h<l){f=t.faceWeights[u++];c=s+t.indices[h++]*o;t.vertexDatas[c]+=t.faceNormals[i]*f;t.vertexDatas[c++]+=t.faceNormals[r]*f;t.vertexDatas[c++]+=t.faceNormals[a]*f;c=s+t.indices[h++]*o;t.vertexDatas[c]+=t.faceNormals[i]*f;t.vertexDatas[c++]+=t.faceNormals[r]*f;t.vertexDatas[c++]+=t.faceNormals[a]*f;c=s+t.indices[h++]*o;t.vertexDatas[c]+=t.faceNormals[i]*f;t.vertexDatas[c++]+=t.faceNormals[r]*f;t.vertexDatas[c++]+=t.faceNormals[a]*f;i+=3;r+=3;a+=3}};return e}();t.GeometryData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.useVertexAttributeList=[];this._start=0;this.count=0;this.matID=0;this.preAttList=new Array;this.localActive=false}Object.defineProperty(e.prototype,"start",{get:function(){return this._start},set:function(t){this._start=t},enumerable:true,configurable:true});e.prototype.upload=function(e,i){e.attributeDiry=false;var r=0;e["attributeList"]=[];if(this.geometry.vertexFormat&t.VertexFormat.VF_POSITION){if(e.attribute_position){if(!e.attribute_position.uniformIndex){e.attribute_position.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_position.varName)}e.attribute_position.size=t.Geometry.positionSize;e.attribute_position.dataType=t.ContextConfig.FLOAT;e.attribute_position.normalized=false;e.attribute_position.stride=this.geometry.vertexSizeInBytes;e.attribute_position.offsetBytes=r;e["attributeList"].push(e.attribute_position);this.useVertexAttributeList[e.attribute_position.uniformIndex]=e.attribute_position.uniformIndex}r+=t.Geometry.positionSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_NORMAL){if(e.attribute_normal){if(!e.attribute_normal.uniformIndex){e.attribute_normal.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_normal.varName)}e.attribute_normal.size=t.Geometry.normalSize;e.attribute_normal.dataType=t.ContextConfig.FLOAT;e.attribute_normal.normalized=false;e.attribute_normal.stride=this.geometry.vertexSizeInBytes;e.attribute_normal.offsetBytes=r;e["attributeList"].push(e.attribute_normal);this.useVertexAttributeList[e.attribute_normal.uniformIndex]=e.attribute_normal.uniformIndex}r+=t.Geometry.normalSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_TANGENT){if(e.attribute_tangent){if(!e.attribute_tangent.uniformIndex){e.attribute_tangent.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_tangent.varName)}e.attribute_tangent.size=t.Geometry.tangentSize;e.attribute_tangent.dataType=t.ContextConfig.FLOAT;e.attribute_tangent.normalized=false;e.attribute_tangent.stride=this.geometry.vertexSizeInBytes;e.attribute_tangent.offsetBytes=r;e["attributeList"].push(e.attribute_tangent);this.useVertexAttributeList[e.attribute_tangent.uniformIndex]=e.attribute_tangent.uniformIndex}r+=t.Geometry.tangentSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_COLOR){if(e.attribute_color){if(!e.attribute_color.uniformIndex){e.attribute_color.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_color.varName)}e.attribute_color.size=t.Geometry.colorSize;e.attribute_color.dataType=t.ContextConfig.FLOAT;e.attribute_color.normalized=false;e.attribute_color.stride=this.geometry.vertexSizeInBytes;e.attribute_color.offsetBytes=r;e["attributeList"].push(e.attribute_color);this.useVertexAttributeList[e.attribute_color.uniformIndex]=e.attribute_color.uniformIndex}r+=t.Geometry.colorSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_UV0){if(e.attribute_uv0){if(!e.attribute_uv0.uniformIndex){e.attribute_uv0.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_uv0.varName)}e.attribute_uv0.size=t.Geometry.uvSize;e.attribute_uv0.dataType=t.ContextConfig.FLOAT;e.attribute_uv0.normalized=false;e.attribute_uv0.stride=this.geometry.vertexSizeInBytes;e.attribute_uv0.offsetBytes=r;e["attributeList"].push(e.attribute_uv0);this.useVertexAttributeList[e.attribute_uv0.uniformIndex]=e.attribute_uv0.uniformIndex}r+=t.Geometry.uvSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_UV1){if(e.attribute_uv1){if(!e.attribute_uv1.uniformIndex){e.attribute_uv1.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_uv1.varName)}e.attribute_uv1.size=t.Geometry.uv2Size;e.attribute_uv1.dataType=t.ContextConfig.FLOAT;e.attribute_uv1.normalized=false;e.attribute_uv1.stride=this.geometry.vertexSizeInBytes;e.attribute_uv1.offsetBytes=r;e["attributeList"].push(e.attribute_uv1);this.useVertexAttributeList[e.attribute_uv1.uniformIndex]=e.attribute_uv1.uniformIndex}r+=t.Geometry.uv2Size*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_SKIN){if(e.attribute_boneIndex){if(!e.attribute_boneIndex.uniformIndex){e.attribute_boneIndex.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_boneIndex.varName)}e.attribute_boneIndex.size=t.Geometry.skinSize/2;e.attribute_boneIndex.dataType=t.ContextConfig.FLOAT;e.attribute_boneIndex.normalized=false;e.attribute_boneIndex.stride=this.geometry.vertexSizeInBytes;e.attribute_boneIndex.offsetBytes=r;e["attributeList"].push(e.attribute_boneIndex);this.useVertexAttributeList[e.attribute_boneIndex.uniformIndex]=e.attribute_boneIndex.uniformIndex}r+=t.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT;if(e.attribute_boneWeight){if(!e.attribute_boneWeight.uniformIndex){e.attribute_boneWeight.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_boneWeight.varName)}e.attribute_boneWeight.size=t.Geometry.skinSize/2;e.attribute_boneWeight.dataType=t.ContextConfig.FLOAT;e.attribute_boneWeight.normalized=false;e.attribute_boneWeight.stride=this.geometry.vertexSizeInBytes;e.attribute_boneWeight.offsetBytes=r;e["attributeList"].push(e.attribute_boneWeight);this.useVertexAttributeList[e.attribute_boneWeight.uniformIndex]=e.attribute_boneWeight.uniformIndex}r+=t.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_POS){if(e.attribute_position){if(!e.attribute_position.uniformIndex){e.attribute_position.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_position.varName)}e.attribute_position.size=t.QuadData.posSize;e.attribute_position.dataType=t.ContextConfig.FLOAT;e.attribute_position.normalized=false;e.attribute_position.stride=t.QuadData.vertexBytes;e.attribute_position.offsetBytes=r;e["attributeList"].push(e.attribute_position);this.useVertexAttributeList[e.attribute_position.uniformIndex]=e.attribute_position.uniformIndex}r+=t.QuadData.posSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_ORIGN){if(e.attribute_shapePosition){if(!e.attribute_shapePosition.uniformIndex){e.attribute_shapePosition.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_shapePosition.varName)}e.attribute_shapePosition.size=t.QuadData.originalSize;e.attribute_shapePosition.dataType=t.ContextConfig.FLOAT;e.attribute_shapePosition.normalized=false;e.attribute_shapePosition.stride=t.QuadData.vertexBytes;e.attribute_shapePosition.offsetBytes=r;e["attributeList"].push(e.attribute_shapePosition);this.useVertexAttributeList[e.attribute_shapePosition.uniformIndex]=e.attribute_shapePosition.uniformIndex}r+=t.QuadData.originalSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_UVREC){if(e.attribute_uvRec){if(!e.attribute_uvRec.uniformIndex){e.attribute_uvRec.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_uvRec.varName)}e.attribute_uvRec.size=t.QuadData.uvRectangleSize;e.attribute_uvRec.dataType=t.ContextConfig.FLOAT;e.attribute_uvRec.normalized=false;e.attribute_uvRec.stride=t.QuadData.vertexBytes;e.attribute_uvRec.offsetBytes=r;e["attributeList"].push(e.attribute_uvRec);this.useVertexAttributeList[e.attribute_uvRec.uniformIndex]=e.attribute_uvRec.uniformIndex}r+=t.QuadData.uvRectangleSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_ROTATION){if(e.attribute_rotate){if(!e.attribute_rotate.uniformIndex){e.attribute_rotate.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_rotate.varName)}e.attribute_rotate.size=t.QuadData.rotationSize;e.attribute_rotate.dataType=t.ContextConfig.FLOAT;e.attribute_rotate.normalized=false;e.attribute_rotate.stride=t.QuadData.vertexBytes;e.attribute_rotate.offsetBytes=r;e["attributeList"].push(e.attribute_rotate);this.useVertexAttributeList[e.attribute_rotate.uniformIndex]=e.attribute_rotate.uniformIndex}r+=t.QuadData.rotationSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_MASK){if(e.attribute_maskRectangle){if(!e.attribute_maskRectangle.uniformIndex){e.attribute_maskRectangle.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_maskRectangle.varName)}e.attribute_maskRectangle.size=t.QuadData.maskSize;e.attribute_maskRectangle.dataType=t.ContextConfig.FLOAT;e.attribute_maskRectangle.normalized=false;e.attribute_maskRectangle.stride=t.QuadData.vertexBytes;e.attribute_maskRectangle.offsetBytes=r;e["attributeList"].push(e.attribute_maskRectangle);this.useVertexAttributeList[e.attribute_maskRectangle.uniformIndex]=e.attribute_maskRectangle.uniformIndex}r+=t.QuadData.maskSize*Float32Array.BYTES_PER_ELEMENT}if(this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_COLOR){if(e.attribute_quad_color){if(!e.attribute_quad_color.uniformIndex){e.attribute_quad_color.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_quad_color.varName)}e.attribute_quad_color.size=t.QuadData.colorSize;e.attribute_quad_color.dataType=t.ContextConfig.FLOAT;e.attribute_quad_color.normalized=false;e.attribute_quad_color.stride=t.QuadData.vertexBytes;e.attribute_quad_color.offsetBytes=r;e["attributeList"].push(e.attribute_quad_color);this.useVertexAttributeList[e.attribute_quad_color.uniformIndex]=e.attribute_quad_color.uniformIndex}r+=t.QuadData.colorSize*Float32Array.BYTES_PER_ELEMENT}for(var a=0;a<this.preAttList.length;++a){var n=this.preAttList[a];var o=e[n.name];if(o){if(!o.uniformIndex){o.uniformIndex=i.getShaderAttribLocation(e.program3D,o.varName);o.size=n.size;o.dataType=t.ContextConfig.FLOAT;o.normalized=false;o.stride=this.geometry.vertexSizeInBytes;o.offsetBytes=r;e["attributeList"].push(o);this.useVertexAttributeList[o.uniformIndex]=o.uniformIndex}}r+=n.size*Float32Array.BYTES_PER_ELEMENT}};e.prototype.activeState=function(t,e,i,r){if(i.attributeDiry)this.upload(i,r);var a=r.activeAttribPointer(this.geometry.vertexFormat,i["attributeList"].length);for(var n=0;n<i["attributeList"].length;n++){var o=i["attributeList"][n];if(o.uniformIndex>=0)r.vertexAttribPointer(o.uniformIndex,o.size,o.dataType,o.normalized,o.stride,o.offsetBytes)}};e.use=false;return e}();t.SubGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i,r){if(t===void 0){t=80}if(i===void 0){i=80}if(r===void 0){r=80}e.call(this);this._width=80;this._height=80;this._depth=80;this._width=t;this._height=i;this._depth=r;this.buildGeomtry(true)}Object.defineProperty(i.prototype,"width",{get:function(){return this._width},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"depth",{get:function(){return this._depth},enumerable:true,configurable:true});i.prototype.buildGeomtry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;this.vertexCount=36;this.indexCount=36;this.vertexArray.set([-this._width*.5,-this._height*.5,-this._depth*.5,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,-this._width*.5,this._height*.5,-this._depth*.5,0,0,-10,1,0,0,1,1,1,1,1,1,0,0,this._width*.5,this._height*.5,-this._depth*.5,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,this._width*.5,this._height*.5,-this._depth*.5,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,this._width*.5,-this._height*.5,-this._depth*.5,0,0,-10,1,0,0,1,1,1,1,0,0,0,0,-this._width*.5,-this._height*.5,-this._depth*.5,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,-this._width*.5,-this._height*.5,this._depth*.5,0,0,10,1,0,0,1,1,1,1,0,0,0,0,this._width*.5,-this._height*.5,this._depth*.5,0,0,10,1,0,0,1,1,1,1,1,0,0,0,this._width*.5,this._height*.5,this._depth*.5,0,0,10,1,0,0,1,1,1,1,1,1,0,0,this._width*.5,this._height*.5,this._depth*.5,0,0,10,1,0,0,1,1,1,1,1,1,0,0,-this._width*.5,this._height*.5,this._depth*.5,0,0,10,1,0,0,1,1,1,1,0,1,0,0,-this._width*.5,-this._height*.5,this._depth*.5,0,0,10,1,0,0,1,1,1,1,0,0,0,0,-this._width*.5,-this._height*.5,-this._depth*.5,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,this._width*.5,-this._height*.5,-this._depth*.5,0,-10,0,1,0,0,1,1,1,1,1,0,0,0,this._width*.5,-this._height*.5,this._depth*.5,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,this._width*.5,-this._height*.5,this._depth*.5,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,-this._width*.5,-this._height*.5,this._depth*.5,0,-10,0,1,0,0,1,1,1,1,0,1,0,0,-this._width*.5,-this._height*.5,-this._depth*.5,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,this._width*.5,-this._height*.5,-this._depth*.5,10,0,0,1,0,0,1,1,1,1,0,0,0,0,this._width*.5,this._height*.5,-this._depth*.5,10,0,0,1,0,0,1,1,1,1,1,0,0,0,this._width*.5,this._height*.5,this._depth*.5,10,0,0,1,0,0,1,1,1,1,1,1,0,0,this._width*.5,this._height*.5,this._depth*.5,10,0,0,1,0,0,1,1,1,1,1,1,0,0,this._width*.5,-this._height*.5,this._depth*.5,10,0,0,1,0,0,1,1,1,1,0,1,0,0,this._width*.5,-this._height*.5,-this._depth*.5,10,0,0,1,0,0,1,1,1,1,0,0,0,0,this._width*.5,this._height*.5,-this._depth*.5,0,10,0,1,0,0,1,1,1,1,0,0,0,0,-this._width*.5,this._height*.5,-this._depth*.5,0,10,0,1,0,0,1,1,1,1,1,0,0,0,-this._width*.5,this._height*.5,this._depth*.5,0,10,0,1,0,0,1,1,1,1,1,1,0,0,-this._width*.5,this._height*.5,this._depth*.5,0,10,0,1,0,0,1,1,1,1,1,1,0,0,this._width*.5,this._height*.5,this._depth*.5,0,10,0,1,0,0,1,1,1,1,0,1,0,0,this._width*.5,this._height*.5,-this._depth*.5,0,10,0,1,0,0,1,1,1,1,0,0,0,0,-this._width*.5,this._height*.5,-this._depth*.5,-10,0,0,1,0,0,1,1,1,1,0,0,0,0,-this._width*.5,-this._height*.5,-this._depth*.5,-10,0,0,1,0,0,1,1,1,1,1,0,0,0,-this._width*.5,-this._height*.5,this._depth*.5,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,-this._width*.5,-this._height*.5,this._depth*.5,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,-this._width*.5,this._height*.5,this._depth*.5,-10,0,0,1,0,0,1,1,1,1,0,1,0,0,-this._width*.5,this._height*.5,-this._depth*.5,-10,0,0,1,0,0,1,1,1,1,0,0,0,0]);if(e){this.indexArray.set([0,2,1,3,5,4,6,8,7,9,11,10,12,14,13,15,17,16,18,20,19,21,23,22,24,26,25,27,29,28,30,32,31,33,35,34])}else{this.indexArray.set([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35])}this.buildDefaultSubGeometry()};return i}(t.Geometry);t.CubeGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i){if(t===void 0){t=100}if(i===void 0){i=200}e.call(this);this._height=t;this._radius=i;this.buildGeomtry()}Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},enumerable:true,configurable:true});i.prototype.buildGeomtry=function(){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;var e=[];var i=[];var r=20;var a=20;var n=2*Math.PI/r;var o=1/r;for(a=0;a<r;a++){var s=this._radius*Math.sin(a*n);var h=this._radius*Math.cos(a*n);e.push(s,0+this._height/2,h,s,0,h,1,0,0,1,1,1,1,1,0,0,0,s,0-this._height/2,h,s,0,h,1,0,0,1,1,1,1,1,0,0,0)}var u=e.length/this.vertexAttLength;var l=u;e.push(0,0-this._height/2,0,0,-1,0,1,0,0,1,1,1,1,1,0,0,0);var c=u+1;e.push(0,0+this._height/2,0,0,1,0,1,0,0,1,1,1,1,1,0,0,0);for(var f=0;f<u;f++){if((f&1)!=0){i.push(f,f+1>=u?f+1-u:f+1,f+2>=u?f+2-u:f+2,l,f,f+2>=u?f+2-u:f+2)}else{i.push(f+1>=u?f+1-u:f+1,f,f+2>=u?f+2-u:f+2,f,c,f+2>=u?f+2-u:f+2)}}this.setVerticesForIndex(0,this.vertexFormat,e,e.length/this.vertexAttLength);this.setVertexIndices(0,i);var d=new t.SubGeometry;d.geometry=this;d.start=0;d.count=this.indexCount;this.subGeometrys.push(d)};return i}(t.Geometry);t.CylinderGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n,o,s,h,u,l){if(i===void 0){i=500}if(r===void 0){r=500}if(a===void 0){a=1}if(n===void 0){n=1}if(o===void 0){o=1}if(s===void 0){s=1}if(h===void 0){h=t.Vector3D.Y_AXIS}if(u===void 0){u=true}if(l===void 0){l=true}e.call(this);this._segmentsW=1;this._segmentsH=1;this._width=500;this._height=500;this._scaleU=1;this._scaleV=1;this._width=i;this._height=r;this._segmentsW=a;this._segmentsH=n;this._scaleU=o;this._scaleV=s;this._wCenter=u;this._hCenter=l;this.buildGeometry(h)}Object.defineProperty(i.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"width",{get:function(){return this._width},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"scaleU",{get:function(){return this._scaleU},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"scaleV",{get:function(){return this._scaleV},enumerable:true,configurable:true});i.prototype.buildGeometry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0;var i,r;var a;var n;var o=this._segmentsW+1;var s=(this._segmentsH+1)*o;var h=this.vertexAttLength;var u=h-15;a=this._segmentsH*this._segmentsW*6;this.vertexCount=s;this.indexCount=a;a=0;var l=new t.Vector3D;var c=0;for(var f=0;f<=this._segmentsH;++f){for(var d=0;d<=this._segmentsW;++d){i=(d/this._segmentsW-.5)*this._width;r=(f/this._segmentsH-.5)*this._height;if(this._wCenter==false){i+=this._width/2}if(this._hCenter==false){r+=this._height/2}switch(e){case t.Vector3D.Y_AXIS:this.vertexArray[c++]=i;this.vertexArray[c++]=0;this.vertexArray[c++]=r;this.vertexArray[c++]=0;this.vertexArray[c++]=1;this.vertexArray[c++]=0;break;case t.Vector3D.Z_AXIS:this.vertexArray[c++]=i;this.vertexArray[c++]=r;this.vertexArray[c++]=0;this.vertexArray[c++]=0;this.vertexArray[c++]=0;this.vertexArray[c++]=-1;break;case t.Vector3D.X_AXIS:this.vertexArray[c++]=0;this.vertexArray[c++]=i;this.vertexArray[c++]=r;this.vertexArray[c++]=1;this.vertexArray[c++]=0;this.vertexArray[c++]=0;break;default:this.vertexArray[c++]=i;this.vertexArray[c++]=0;this.vertexArray[c++]=r;this.vertexArray[c++]=0;this.vertexArray[c++]=1;this.vertexArray[c++]=0;break}this.vertexArray[c++]=1;this.vertexArray[c++]=0;this.vertexArray[c++]=0;this.vertexArray[c++]=1;this.vertexArray[c++]=1;this.vertexArray[c++]=1;this.vertexArray[c++]=1;this.vertexArray[c++]=d/this._segmentsW*this._scaleU;this.vertexArray[c++]=(1-f/this._segmentsH)*this._scaleV;c+=u;if(d!=this._segmentsW&&f!=this._segmentsH){n=d+f*o;var p=1;this.indexArray[a++]=n*p;this.indexArray[a++]=(n+o+1)*p;this.indexArray[a++]=(n+o)*p;this.indexArray[a++]=n*p;this.indexArray[a++]=(n+1)*p;this.indexArray[a++]=(n+o+1)*p}}}var _=new t.SubGeometry;_.geometry=this;_.start=0;_.count=this.indexCount;this.subGeometrys.push(_)};return i}(t.Geometry);t.PlaneGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i,r){if(t===void 0){t=100}if(i===void 0){i=15}if(r===void 0){r=15}e.call(this);this._segmentsW=50;this._segmentsH=50;this._radius=100;this._radius=t;this._segmentsW=i;this._segmentsH=r;this.buildSphere(true)}Object.defineProperty(i.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},enumerable:true,configurable:true});i.prototype.buildSphere=function(e){if(e===void 0){e=true}this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;var i=0,r=0,a=0;var n=(this._segmentsH+1)*(this._segmentsW+1);var o=this.vertexAttLength;var s=o-9;this.vertexCount=n;this.indexCount=(this._segmentsH-1)*this._segmentsW*6;var h=0;var u=0;var l=0,c=0,f=0,d=0;for(r=0;r<=this._segmentsH;++r){h=u;var p=Math.PI*r/this._segmentsH;var _=-this._radius*Math.cos(p);var m=this._radius*Math.sin(p);for(i=0;i<=this._segmentsW;++i){var v=2*Math.PI*i/this._segmentsW;var g=m*Math.cos(v);var y=m*Math.sin(v);var x=1/Math.sqrt(g*g+y*y+_*_);var b=Math.sqrt(y*y+g*g);f=0;d=b>.007?g/b:0;l=-_;c=y;if(i==this._segmentsW){this.vertexArray[u++]=this.vertexArray[h];this.vertexArray[u++]=this.vertexArray[h+1];this.vertexArray[u++]=this.vertexArray[h+2];this.vertexArray[u++]=g*x;this.vertexArray[u++]=l*x;this.vertexArray[u++]=c*x;this.vertexArray[u++]=b>.007?-y/b:1;this.vertexArray[u++]=f;this.vertexArray[u++]=d;this.vertexArray[u+0]=1;this.vertexArray[u+1]=1;this.vertexArray[u+2]=1;this.vertexArray[u+3]=1}else{this.vertexArray[u++]=g;this.vertexArray[u++]=l;this.vertexArray[u++]=c;this.vertexArray[u++]=g*x;this.vertexArray[u++]=l*x;this.vertexArray[u++]=c*x;this.vertexArray[u++]=b>.007?-y/b:1;this.vertexArray[u++]=f;this.vertexArray[u++]=d;this.vertexArray[u]=1;this.vertexArray[u+1]=1;this.vertexArray[u+2]=1;this.vertexArray[u+3]=1}if(i>0&&r>0){var D=(this._segmentsW+1)*r+i;var T=(this._segmentsW+1)*r+i-1;var P=(this._segmentsW+1)*(r-1)+i-1;var A=(this._segmentsW+1)*(r-1)+i;if(r==this._segmentsH){this.vertexArray[u-9]=this.vertexArray[h];this.vertexArray[u-8]=this.vertexArray[h+1];this.vertexArray[u-7]=this.vertexArray[h+2];if(e){this.indexArray[a++]=D;this.indexArray[a++]=A;this.indexArray[a++]=P}else{this.indexArray[a++]=D;this.indexArray[a++]=P;this.indexArray[a++]=A}}else if(r==1){if(e){this.indexArray[a++]=D;this.indexArray[a++]=P;this.indexArray[a++]=T}else{this.indexArray[a++]=D;this.indexArray[a++]=T;this.indexArray[a++]=P}}else{if(e){this.indexArray[a++]=D;this.indexArray[a++]=A;this.indexArray[a++]=P;this.indexArray[a++]=D;this.indexArray[a++]=P;this.indexArray[a++]=T}else{this.indexArray[a++]=D;this.indexArray[a++]=P;this.indexArray[a++]=A;this.indexArray[a++]=D;this.indexArray[a++]=T;this.indexArray[a++]=P}}}u+=s}}var o=17;var w=(this._segmentsH+1)*(this._segmentsW+1)*o;var S;var s=o-2;var u=13;for(r=0;r<=this._segmentsH;++r){for(i=0;i<=this._segmentsW;++i){this.vertexArray[u++]=i/this._segmentsW;this.vertexArray[u++]=r/this._segmentsH;u+=s}}var C=new t.SubGeometry;C.geometry=this;C.start=0;C.count=this.indexCount;this.subGeometrys.push(C)};return i}(t.Geometry);t.SphereGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a){if(a===void 0){a=false}e.call(this);this.vector3_Down=new t.Vector3D(0,-1,0);this.vector3_Forward=new t.Vector3D(0,0,1);this.vector3_Up=new t.Vector3D(0,1,0);this.directions=[new t.Vector3D(-1,0,0),new t.Vector3D(0,0,-1),new t.Vector3D(1,0,0),new t.Vector3D(0,0,1)];if(i<0){i=0;console.error("Sky Sphere subdivisions increased to minimum, which is 0.")}else if(i>6){i=6;console.error("Sky Sphere subdivisions decreased to maximum, which is 6.")}this._subdivisions=i;this._radius=r;this.buildGeomtry(false,a)}i.prototype.buildGeomtry=function(e,i){var r=[];var a=[];var n=1<<this._subdivisions;var o=[];var s=[];this.CreateOctahedron(o,s,n,i);for(var h=0;h<o.length;h++){console.log(o[h])}var u=[];this.Normalize(o,u,e);var l=[];this.CreateUV(o,l);if(this._radius!=1){for(var h=0;h<o.length;h++){o[h].x*=this._radius;o[h].y*=this._radius;o[h].z*=this._radius;console.log(o[h].x+" "+o[h].y+" "+o[h].z)}}this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0;for(var h=0;h<o.length;h++){var c=o[h];r.push(c.x);r.push(c.y);r.push(c.z);var f=u[h];r.push(f.x);r.push(f.y);r.push(f.z);r.push(1,1,1,1);var d=l[h];r.push(d.u);r.push(1-d.v)}a=s;this.setVerticesForIndex(0,this.vertexFormat,r,r.length/this.vertexAttLength);this.setVertexIndices(0,a);this.buildDefaultSubGeometry()};i.prototype.CreateOctahedron=function(e,i,r,a){var n=0,o=0,s=0;if(a==false){for(var h=0;h<4;h++){e[n++]=this.vector3_Down.clone()}for(var h=1;h<=r;h++){var u=h/r;var l=new t.Vector3D;var c=new t.Vector3D;c.lerp(this.vector3_Down,this.vector3_Forward,u);e[n++]=c;for(var f=0;f<4;f++){l=c.clone();c.lerp(this.vector3_Down,this.directions[f],u);s=this.CreateLowerStrip(h,n,o,s,i);n=this.CreateVertexLine(l,c,h,n,e);o+=h>1?h-1:1}o=n-1-h*4}}for(var h=r-1;h>=1;h--){var u=h/r;var l;var c=new t.Vector3D;c.lerp(this.vector3_Up,this.vector3_Forward,u);e[n++]=c;for(var f=0;f<4;f++){l=c.clone();c.lerp(this.vector3_Up,this.directions[f],u);s=this.CreateUpperStrip(h,n,o,s,i);n=this.CreateVertexLine(l,c,h,n,e);o+=h+1}o=n-1-h*4}for(var h=0;h<4;h++){i[s++]=o;i[s++]=n;i[s++]=++o;e[n++]=this.vector3_Up.clone()}};i.prototype.CreateLowerStrip=function(t,e,i,r,a){for(var n=1;n<t;n++){a[r++]=i;a[r++]=e-1;a[r++]=e;a[r++]=i++;a[r++]=e++;a[r++]=i}a[r++]=i;a[r++]=e-1;a[r++]=e;return r};i.prototype.CreateVertexLine=function(e,i,r,a,n){for(var o=1;o<=r;o++){var s=new t.Vector3D;s.lerp(e,i,o/r);n[a++]=s}return a};i.prototype.CreateUpperStrip=function(t,e,i,r,a){a[r++]=i;a[r++]=e-1;a[r++]=++i;for(var n=1;n<=t;n++){a[r++]=e-1;a[r++]=e;a[r++]=i;a[r++]=i;a[r++]=e++;a[r++]=++i}return r};i.prototype.Normalize=function(t,e,i){for(var r=0;r<t.length;r++){var a=t[r];a.normalize();e[r]=a;t[r]=a}};i.prototype.CreateUV=function(t,e){var i=1;for(var r=0;r<t.length;r++){var a=t[r];if(a.x==i){e[r-1].u=1}i=a.x;var n={u:Math.atan2(a.x,a.z)/(-2*Math.PI),v:Math.asin(a.y)/Math.PI+.5};if(n.u<0){n.u+=1}e[r]=n}e[t.length-4].u=e[0].u=.125;e[t.length-3].u=e[1].u=.375;e[t.length-2].u=e[2].u=.625;e[t.length-1].u=e[3].u=.875};i.prototype.CreateTangents=function(e,i){for(var r=0;r<e.length;r++){var a=e[r];a.y=0;a.normalize();var n=new t.Quaternion;n.x=-a.z;n.y=0;n.z=a.x;n.w=-1;i[r]=n}i[0]=new t.Quaternion(-1,0,-1);i[1]=new t.Quaternion(1,0,-1);i[2]=new t.Quaternion(1,0,1);i[3]=new t.Quaternion(-1,0,1);i[0].normalize();i[1].normalize();i[2].normalize();i[3].normalize();i[e.length-4]=i[0];i[e.length-3]=i[1];i[e.length-2]=i[2];i[e.length-1]=i[3];for(var r=0;r<4;r++){i[e.length-1-r].w=i[r].w=-1}};return i}(t.Geometry);t.OctahedronSphereGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.createGeometry=function(e){if(e===void 0){e=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1}var i=new t.Geometry;i.vertexFormat=e;return i};e.createGemetryForType=function(e,i){switch(e){case"CubeGeometry":return new t.CubeGeometry(i.width,i.height,i.depth);case"CylinderGeometry":return new t.CylinderGeometry(i.height,i.radius);case"ElevationGeometry":return new t.ElevationGeometry(i.heightmap,i.width,i.height,i.depth,i.segmentsW,i.segmentsH);case"PlaneGeometry":return new t.PlaneGeometry(i.width,i.height,i.segmentsW,i.segmentsH,i.uScale,i.vScale);case"SphereGeometry":return new t.SphereGeometry(i.r,i.segmentsW,i.segmentsH)}return null};e.fromVertexFormatToLength=function(e){var i=0;if(e&t.VertexFormat.VF_POSITION){i+=t.Geometry.positionSize}if(e&t.VertexFormat.VF_NORMAL){i+=t.Geometry.normalSize}if(e&t.VertexFormat.VF_TANGENT){i+=t.Geometry.tangentSize}if(e&t.VertexFormat.VF_COLOR){i+=t.Geometry.colorSize}if(e&t.VertexFormat.VF_UV0){i+=t.Geometry.uvSize}if(e&t.VertexFormat.VF_UV1){i+=t.Geometry.uv2Size}if(e&t.VertexFormat.VF_SKIN){i+=t.Geometry.skinSize}if(e&t.VertexFormat.VF_QUAD_ORIGN){i+=t.QuadData.originalSize}if(e&t.VertexFormat.VF_QUAD_POS){i+=t.QuadData.posOffest}if(e&t.VertexFormat.VF_QUAD_UVREC){i+=t.QuadData.uvRectangleSize}if(e&t.VertexFormat.VF_QUAD_ROTATION){i+=t.QuadData.rotationSize}if(e&t.VertexFormat.VF_QUAD_MASK){i+=t.QuadData.maskSize}if(e&t.VertexFormat.VF_QUAD_COLOR){i+=t.QuadData.colorSize}return i};return e}();t.GeometryUtil=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i,r,a,n,o,s,h){if(i===void 0){i=1e3}if(r===void 0){r=100}if(a===void 0){a=1e3}if(n===void 0){n=30}if(o===void 0){o=30}if(s===void 0){s=255}if(h===void 0){h=0}e.call(this);this._width=100;this._height=100;this._segmentsW=100;this._segmentsH=100;this._depth=100;this._minElevation=100;this._maxElevation=100;this._scaleU=1;this._scaleV=1;this._segmentsW=n;this._segmentsH=o;this._width=i;this._height=r;this._depth=a;this._minElevation=h;this._maxElevation=s;this._heightmap=t;this._imageData=t.readPixels(0,0,t.width,t.height);this._positionXYZ=[];this.buildGeomtry(true)}Object.defineProperty(i.prototype,"width",{get:function(){return this._width},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"depth",{get:function(){return this._depth},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"heightmap",{get:function(){return this._heightmap},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:true,configurable:true});i.prototype.buildGeomtry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;var i,r;var a;var n;var o=this._segmentsW+1;var s=(this._segmentsH+1)*o;var h=(this._heightmap.width-1)/this._segmentsW;var u=(this._heightmap.height-1)/this._segmentsH;var l,c;var f;this.vertexCount=s;this.indexCount=this._segmentsH*this._segmentsW*6;s=0;a=0;var d;for(var p=0;p<=this._segmentsH;++p){for(var _=0;_<=this._segmentsW;++_){i=(_/this._segmentsW-.5)*this._width;r=(p/this._segmentsH-.5)*this._depth;l=_*h;c=(this._segmentsH-p)*u;
f=this.getHeightByPixel(l,c);this.vertexArray[s++]=i;this.vertexArray[s++]=f;this.vertexArray[s++]=r;this.vertexArray[s++]=1;this.vertexArray[s++]=1;this.vertexArray[s++]=1;this.vertexArray[s++]=-1;this.vertexArray[s++]=0;this.vertexArray[s++]=0;this.vertexArray[s++]=1;this.vertexArray[s++]=1;this.vertexArray[s++]=1;this.vertexArray[s++]=1;this.vertexArray[s++]=_/this._segmentsW*this._scaleU;this.vertexArray[s++]=1-p/this._segmentsH*this._scaleV;this.vertexArray[s++]=_/this._segmentsW;this.vertexArray[s++]=1-p/this._segmentsH;if(_!=this._segmentsW&&p!=this._segmentsH){n=_+p*o;this.indexArray[a++]=n;this.indexArray[a++]=n+o+1;this.indexArray[a++]=n+o;this.indexArray[a++]=n;this.indexArray[a++]=n+1;this.indexArray[a++]=n+o+1}}}this.updateFaceNormals();this.buildDefaultSubGeometry()};i.prototype.getHeightByPixel=function(t,e){t=Math.floor(t);e=Math.floor(e);if(t<0){t=0}else if(t>=this._imageData.width){t=this._imageData.width-1}if(e<0){e=0}else if(e>this._imageData.height){e=this._imageData.height-1}var i=this.getPixelColor(t,e)&255;return i>this._maxElevation?this._maxElevation/255*this._height:i<this._minElevation?this._minElevation/255*this._height:i/255*this._height};i.prototype.getPixelColor=function(t,e){var i=(e*this._heightmap.imageData.width+t)*4;var r=this._imageData.data[i+3]<<24|this._imageData.data[i+0]<<16|this._imageData.data[i+1]<<8|this._imageData.data[i+2];return r};i.prototype.get3DCoordAtPixel=function(e,i,r,a,n){if(n===void 0){n=null}i=a-i;n=n||new t.Vector3D;e*=this._width/r;e-=this._width*.5;i*=this._depth/a;i-=this._depth*.5;n.setTo(e,0,i);n.y=this.getHeightBySceneCoord(e,i);return n};i.prototype.getHeightBySceneCoord=function(e,i){e+=this._width*.5;i+=this._depth*.5;if(e<0||i<0){return 0}if(e>=this._width||i>=this._depth){return 0}i=this._depth-i;e*=this._imageData.width/this._width;i*=this._imageData.height/this._depth;var r=Math.floor(e);var a=Math.floor(i);var n=this.getHeightByPixel(r,a);var o=this.getHeightByPixel(r+1,a);var s=this.getHeightByPixel(r,a+1);var h=this.getHeightByPixel(r+1,a+1);var u=e-r;var l=i-a;n=t.MathUtil.mix(n,o,u);o=t.MathUtil.mix(s,h,u);n=t.MathUtil.mix(n,o,l);return n};i.prototype.updateFaceNormals=function(){var t=0,e=0,i=0;var r;var a=this.indexCount;var n,o,s;var h,u,l;var c,f,d;var p,_,m;var v,g,y;var x,b,D;var T;var P=17;var A=0;var w=[];while(t<a){r=A+this.indexArray[t+0]*P;n=this.vertexArray[r];h=this.vertexArray[r+1];c=this.vertexArray[r+2];r=A+this.indexArray[t+1]*P;o=this.vertexArray[r];u=this.vertexArray[r+1];f=this.vertexArray[r+2];r=A+this.indexArray[t+2]*P;s=this.vertexArray[r];l=this.vertexArray[r+1];d=this.vertexArray[r+2];p=o-n;_=u-h;m=f-c;v=s-n;g=l-h;y=d-c;x=m*g-_*y;b=p*y-m*v;D=_*v-p*g;T=Math.sqrt(x*x+b*b+D*D);w[e++]=D*T;w[e++]=b*T;w[e++]=x*T;t+=3}t=0;var S=0,C=1,E=2;var L=this.vertexAttLength;var M=3;while(t<a){r=M+this.indexArray[t++]*L;this.vertexArray[r++]=w[S];this.vertexArray[r++]=w[C];this.vertexArray[r++]=w[E];r=M+this.indexArray[t++]*L;this.vertexArray[r++]=w[S];this.vertexArray[r++]=w[C];this.vertexArray[r++]=w[E];r=M+this.indexArray[t++]*L;this.vertexArray[r++]=w[S];this.vertexArray[r++]=w[C];this.vertexArray[r++]=w[E];S+=3;C+=3;E+=3}};return i}(t.Geometry);t.ElevationGeometry=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}return t}();t.Face=e;var i=function(){function i(e){this.height=0;this.selectFaces=[];this.mesh=e;this._offsetPos=new t.Vector3D;this._offsetPos.copyFrom(e.globalPosition);this._geometry=e.geometry;this.buildFace()}i.prototype.buildFace=function(){var i=0;var r=0;var a=0;var n=[];for(var o=0;o<this._geometry.indexCount/3;o++){var s=new e;s.v_0=new t.Vector3D;s.v_1=new t.Vector3D;s.v_2=new t.Vector3D;s.min=new t.Vector3D;s.max=new t.Vector3D;s.centre=new t.Vector3D;i=this._geometry.indexArray[o*3+0];r=this._geometry.indexArray[o*3+1];a=this._geometry.indexArray[o*3+2];s.v_0.x=this._offsetPos.x+this._geometry.vertexArray[i*this._geometry.vertexAttLength+0];s.v_0.y=this._offsetPos.y+this._geometry.vertexArray[i*this._geometry.vertexAttLength+1];s.v_0.z=this._offsetPos.z+this._geometry.vertexArray[i*this._geometry.vertexAttLength+2];s.v_1.x=this._offsetPos.x+this._geometry.vertexArray[r*this._geometry.vertexAttLength+0];s.v_1.y=this._offsetPos.y+this._geometry.vertexArray[r*this._geometry.vertexAttLength+1];s.v_1.z=this._offsetPos.z+this._geometry.vertexArray[r*this._geometry.vertexAttLength+2];s.v_2.x=this._offsetPos.x+this._geometry.vertexArray[a*this._geometry.vertexAttLength+0];s.v_2.y=this._offsetPos.y+this._geometry.vertexArray[a*this._geometry.vertexAttLength+1];s.v_2.z=this._offsetPos.z+this._geometry.vertexArray[a*this._geometry.vertexAttLength+2];s.min.x=Math.min(s.v_0.x,s.v_1.x,s.v_2.x);s.min.y=Math.min(s.v_0.y,s.v_1.y,s.v_2.y);s.min.z=Math.min(s.v_0.z,s.v_1.z,s.v_2.z);s.max.x=Math.max(s.v_0.x,s.v_1.x,s.v_2.x);s.max.y=Math.max(s.v_0.y,s.v_1.y,s.v_2.y);s.max.z=Math.max(s.v_0.z,s.v_1.z,s.v_2.z);s.centre.x=s.min.x+(s.max.x-s.min.x)*.5;s.centre.y=s.min.y+(s.max.y-s.min.y)*.5;s.centre.z=s.min.z+(s.max.z-s.min.z)*.5;n.push(new t.KDData([s.centre.x,s.centre.z,s.centre.y],s))}this._kdTree=new t.KDTree;this._kdTree.buildTree(n)};i.prototype.getTerrainCollisionHeight=function(t,e){var i=this._kdTree.root.find([t,e],3);var r;this.selectFaces.length=0;for(var a=0;a<i.length;a++){r=i[a]["datum"].data;this.selectFaces.push(r);if(this.checkPointInTriangle(t,e,r)){return this.height=this.getHeightInTriangle(t,e,r)}}return this.height};i.prototype.checkPointInTriangle=function(t,e,i){var r=i.v_0;var a=i.v_1;var n=i.v_2;var o=r.z-a.z;var s=a.x-r.x;var h=r.x*a.z-a.x*r.z;var u=a.z-n.z;var l=n.x-a.x;var c=a.x*n.z-n.x*a.z;var f=n.z-r.z;var d=r.x-n.x;var p=n.x*r.z-r.x*n.z;var _=false;var m=o*t+s*e+h;var v=u*t+l*e+c;var g=f*t+d*e+p;var y=.01;if(m>=-y&&v>=-y&&g>=-y||m<=y&&v<=y&&g<=y)_=true;return _};i.prototype.getHeightInTriangle=function(e,i,r){var a=r.v_0;var n=r.v_1;var o=r.v_2;var s=t.Vector3D.HELP_2;if(a.x>=e){if(o.x>=e){s=o;o=n;n=s}else{if(n.x>=e){}else{s=o;o=a;a=s}}}else if(a.x<e){if(o.x<e){s=o;o=n;n=s}else{if(n.x<e){}else{s=o;o=a;a=s}}}else return a.y;var h=t.Vector3D.HELP_0;var u=t.Vector3D.HELP_1;h.x=e;if(a.x-o.x==0){h.y=o.y;h.z=o.z}else{h.y=(a.y-o.y)*(e-o.x)/(a.x-o.x)+o.y;h.z=(a.z-o.z)*(e-o.x)/(a.x-o.x)+o.z}u.x=e;if(n.x-o.x==0){u.y=o.y;u.z=o.z}else{u.y=(n.y-o.y)*(e-o.x)/(n.x-o.x)+o.y;u.z=(n.z-o.z)*(e-o.x)/(n.x-o.x)+o.z}var l;if(h.z==u.z)l=u.y;else l=(h.y-u.y)*(i-u.z)/(h.z-u.z)+u.y;return l};return i}();t.TerrainCollision=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t){this.canvasX=t.clientX-i.canvas.x+i.canvas.offsetX;this.canvasY=t.clientY-i.canvas.y+i.canvas.offsetY;this.identifier=t.identifier;this.clientX=t.clientX;this.clientY=t.clientY;this.pageX=t.pageX;this.pageY=t.pageY;this.screenX=t.screenX;this.screenY=t.screenY}return t}();t.TouchData=e;var i=function(i){__extends(r,i);function r(){var e=this;i.call(this);this._time=0;this._keyStatus={};this._mouseStatus={};this._isTouchStart=false;this._mouseEvent3d=new t.MouseEvent3D;this._keyEvent3d=new t.KeyEvent3D;this._touchEvent3d=new t.TouchEvent3D;this._windowsEvent3d=new t.Event3D;this._orientationEvent3d=new t.OrientationEvent3D;this.onGamepadStick1=null;this.onGamepadStick2=null;this._gp=false;this._oldPosition1=null;this._oldPosition2=null;window.addEventListener("click",function(t){return e.mouseClick(t)},true);window.addEventListener("mousedown",function(t){return e.mouseStart(t)},true);window.addEventListener("mouseup",function(t){return e.mouseEnd(t)},true);window.addEventListener("mousewheel",function(t){return e.mouseWheel(t)},true);window.addEventListener("mousemove",function(t){return e.mouseMove(t)},true);window.addEventListener("mouseover",function(t){return e.mouseOver(t)},true);window.addEventListener("keydown",function(t){return e.keyDown(t)},true);window.addEventListener("keyup",function(t){return e.keyUp(t)},true);if(this.canGame()){window.addEventListener("gamepadconnected",function(t){return e.ongamepadconnected(t)},true);window.addEventListener("gamepaddisconnected",function(t){return e.ongamepaddisconnected(t)},true)}window.addEventListener("touchstart",function(t){return e.touchStart(t)},true);window.addEventListener("touchend",function(t){return e.touchEnd(t)},true);window.addEventListener("touchmove",function(t){return e.touchMove(t)},true);window.addEventListener("touchcancel",function(t){return e.touchEnd(t)},true);window.addEventListener("resize",function(t){return e.onWindowsResize(t)},true)}Object.defineProperty(r,"instance",{get:function(){if(this._instance==null){this._instance=new r}return this._instance},enumerable:true,configurable:true});r.addEventListener=function(t,e,i,a,n){if(a===void 0){a=null}if(n===void 0){n=0}return r.instance.addEventListener(t,e,i,a,n)};r.prototype.addEventListener=function(e,r,a,n,o){var s=this;if(n===void 0){n=null}if(o===void 0){o=0}if(e==t.OrientationEvent3D.ORIENTATION_CHANGE&&!this.containEventListener(t.OrientationEvent3D.ORIENTATION_CHANGE)){window.addEventListener("orientationchange",function(t){return s.onOrientationChange(t)},true)}else if(e==t.OrientationEvent3D.DEVICE_MOTION&&!this.containEventListener(t.OrientationEvent3D.DEVICE_MOTION)){window.addEventListener("devicemotion",function(t){return s.onDeviceMotion(t)},true)}else if(e==t.OrientationEvent3D.DEVICE_ORIENTATION&&!this.containEventListener(t.OrientationEvent3D.DEVICE_ORIENTATION)){window.addEventListener("deviceorientation",function(t){return s.onDeviceOrientation(t)},true)}var h=i.prototype.addEventListener.call(this,e,r,a,n,o);return h};r.removeEventListener=function(t,e,i){r.instance.removeEventListener(t,e,i)};r.removeEventListenerAt=function(t){r.instance.removeEventListenerAt(t)};r.getKeyPress=function(t){return r.instance._keyStatus[t]};r.getMousePress=function(t){return r.instance._mouseStatus[t]};r.prototype.ongamepaddisconnected=function(t){this._gp=false};r.prototype.ongamepadconnected=function(t){this._gp=true};r.prototype.getGamepadButtonState=function(t){return navigator.getGamepads()[0].buttons[t].pressed};r.prototype.getGamepadStick1=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[0],navigator.getGamepads()[0].axes[1],0)};r.prototype.getGamepadStick2=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[2],navigator.getGamepads()[0].axes[3],0)};r.prototype.canGame=function(){return"getGamepads"in navigator};r.reportOnGamepad=function(){if(r.instance.canGame()&&r.instance._gp){if(r.instance.onGamepadStick1!=null){r.instance.onGamepadStick1(r.instance.getGamepadStick1())}if(r.instance.onGamepadStick2!=null){r.instance.onGamepadStick2(r.instance.getGamepadStick2())}}};r.prototype.printout=function(){var t="";t+="id: "+navigator.getGamepads()[0].id+"<br/>";var e=navigator.getGamepads()[0].buttons.length;for(var i=0;i<e;i++){t+="Button "+(i+1)+": ";if(this.getGamepadButtonState(i))t+=" pressed";t+="<br/>"}var r=this.getGamepadStick1();t+="Stick 1"+": "+r.x+","+r.y+"<br/>";r=this.getGamepadStick2();t+="Stick 2"+": "+r.x+","+r.y+"<br/>"};r.prototype.onPinch=function(e,i,r,a){this._oldPosition1=new t.Point(e,i);this._oldPosition2=new t.Point(r,a)};r.prototype.onSwipe=function(t,e){r.mouseX=t;r.mouseY=e;this._oldPosition1=null;this._oldPosition2=null;this._time=(new Date).getTime()};r.prototype.touchStart=function(e){if(!this.deliverMessage()){return}var i=e.targetTouches[0].clientX-r.canvas.x+r.canvas.offsetX;var a=e.targetTouches[0].clientY-r.canvas.y+r.canvas.offsetY;if(e.targetTouches.length==2){var n=e.targetTouches[1].clientX-r.canvas.x+r.canvas.offsetX;var o=e.targetTouches[1].clientY-r.canvas.y+r.canvas.offsetY;this.onPinch(i,a,n,o)}else if(e.targetTouches.length==1){this.onSwipe(i,a);this._mouseStatus[t.MouseCode.Mouse_Left]=true}this._touchEvent3d.reset();this._touchEvent3d.targetTouches=this.GetTargetTouches(e.targetTouches);this._touchEvent3d.target=this;if(!this._isTouchStart){this._isTouchStart=true;this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_START;this.dispatchEvent(this._touchEvent3d)}};r.prototype.touchEnd=function(e){if(e.targetTouches.length>1){var i=e.targetTouches[0].clientX-r.canvas.x+r.canvas.offsetX;var a=e.targetTouches[0].clientY-r.canvas.y+r.canvas.offsetY;var n=e.targetTouches[1].clientX-r.canvas.x+r.canvas.offsetX;var o=e.targetTouches[1].clientY-r.canvas.y+r.canvas.offsetY;this.onPinch(i,a,n,o)}else if(e.targetTouches.length==1){this.onSwipe(e.targetTouches[0].clientX-r.canvas.x+r.canvas.offsetX,e.targetTouches[0].clientY-r.canvas.y+r.canvas.offsetY);this._mouseStatus[t.MouseCode.Mouse_Left]=false}else{this._oldPosition1=null;this._oldPosition2=null;this._time=0}this._touchEvent3d.reset();this._isTouchStart=false;this._touchEvent3d.targetTouches=this.GetTargetTouches(e.targetTouches);this._touchEvent3d.target=this;this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_END;this.dispatchEvent(this._touchEvent3d)};r.prototype.touchMove=function(e){r.mouseLastX=r.mouseX;r.mouseLastY=r.mouseY;r.mouseX=e.targetTouches[0].clientX-r.canvas.x+r.canvas.offsetX;r.mouseY=e.targetTouches[0].clientY-r.canvas.y+r.canvas.offsetY;r.mouseOffsetX=r.mouseX-r.mouseLastX;r.mouseOffsetY=r.mouseY-r.mouseLastY;e.preventDefault();if(e.targetTouches.length>1){var i=new t.Point(r.mouseX,r.mouseY);var a=new t.Point(e.targetTouches[1].clientX-r.canvas.x+r.canvas.offsetX,e.targetTouches[1].clientY-r.canvas.y+r.canvas.offsetY);if(this._oldPosition1==null)this._oldPosition1=i;if(this._oldPosition2==null)this._oldPosition2=a;if(this.isEnlarge(this._oldPosition1,this._oldPosition2,i,a))r.wheelDelta=120;else r.wheelDelta=-120;this._oldPosition1=i;this._oldPosition2=a}else{}this._touchEvent3d.reset();this._touchEvent3d.targetTouches=this.GetTargetTouches(e.targetTouches);this._touchEvent3d.target=this;this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_MOVE;this.dispatchEvent(this._touchEvent3d)};r.prototype.GetTargetTouches=function(t){var i=new Array;for(var r=0;r<t.length;r++){var a=new e(t[r]);i.push(a)}return i};r.prototype.mouseClick=function(e){if(!this.deliverMessage()){return}this._mouseEvent3d.reset();this._mouseEvent3d.mouseCode=e.button;this._mouseEvent3d.target=this;this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_CLICK;this.dispatchEvent(this._mouseEvent3d)};r.prototype.mouseEnd=function(e){this._mouseEvent3d.reset();this._mouseEvent3d.mouseCode=e.button;this._mouseEvent3d.target=this;this._mouseStatus[this._mouseEvent3d.mouseCode]=false;this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_UP;this.dispatchEvent(this._mouseEvent3d)};r.prototype.deliverMessage=function(){var t=r.canvas.view3Ds;for(var e=0;e<t.length;++e){if(t[e].inView3D(r.mouseX,r.mouseY)){return true}}return false};r.prototype.mouseStart=function(e){if(!this.deliverMessage()){return}this._mouseEvent3d.reset();this._mouseEvent3d.mouseCode=e.button;this._mouseEvent3d.target=this;if(!this._mouseStatus[this._mouseEvent3d.mouseCode]){this._mouseStatus[this._mouseEvent3d.mouseCode]=true;this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_DOWN;this.dispatchEvent(this._mouseEvent3d)}};r.prototype.mouseMove=function(e){r.mouseLastX=r.mouseX;r.mouseLastY=r.mouseY;r.mouseX=e.clientX-r.canvas.x+r.canvas.offsetX;r.mouseY=e.clientY-r.canvas.y+r.canvas.offsetY;r.mouseOffsetX=r.mouseX-r.mouseLastX;r.mouseOffsetY=r.mouseY-r.mouseLastY;this._mouseEvent3d.reset();this._mouseEvent3d.target=this;this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_MOVE;this.dispatchEvent(this._mouseEvent3d)};r.prototype.mouseOver=function(e){this._mouseEvent3d.reset();this._mouseEvent3d.target=this;this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_OVER;this.dispatchEvent(this._mouseEvent3d)};r.prototype.mouseWheel=function(e){r.wheelDelta=e.wheelDelta;this._mouseEvent3d.reset();this._mouseEvent3d.target=this;this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_WHEEL;this.dispatchEvent(this._mouseEvent3d)};r.prototype.keyDown=function(e){this._keyEvent3d.reset();this._keyEvent3d.keyCode=e.keyCode;this._keyEvent3d.target=this;if(!this._keyStatus[e.keyCode]){this._keyStatus[e.keyCode]=true;this._keyEvent3d.eventType=t.KeyEvent3D.KEY_DOWN;this.dispatchEvent(this._keyEvent3d)}};r.prototype.keyUp=function(e){this._keyEvent3d.reset();this._keyEvent3d.keyCode=e.keyCode;this._keyEvent3d.target=this;this._keyStatus[e.keyCode]=false;this._keyEvent3d.eventType=t.KeyEvent3D.KEY_UP;this.dispatchEvent(this._keyEvent3d)};r.prototype.onWindowsResize=function(e){this._windowsEvent3d.target=this;this._windowsEvent3d.eventType=t.Event3D.RESIZE;this.dispatchEvent(this._windowsEvent3d)};r.prototype.onOrientationChange=function(e){this._orientationEvent3d.target=this;this._orientationEvent3d.eventType=t.OrientationEvent3D.ORIENTATION_CHANGE;this.dispatchEvent(this._orientationEvent3d)};r.prototype.onDeviceMotion=function(e){this._orientationEvent3d.target=this;this._orientationEvent3d.eventType=t.OrientationEvent3D.DEVICE_MOTION;this._orientationEvent3d.acceleration=e.acceleration;this._orientationEvent3d.accelerationIncludingGravity=e.accelerationIncludingGravity;this._orientationEvent3d.rotationRate=e.rotationRate;this.dispatchEvent(this._orientationEvent3d)};r.prototype.onDeviceOrientation=function(e){this._orientationEvent3d.target=this;this._orientationEvent3d.eventType=t.OrientationEvent3D.DEVICE_ORIENTATION;this._orientationEvent3d.absolute=e.absolute;this._orientationEvent3d.alpha=e.alpha;this._orientationEvent3d.beta=e.beta;this._orientationEvent3d.gamma=e.gamma;this.dispatchEvent(this._orientationEvent3d)};r.prototype.GetSlideAngle=function(t,e){return Math.atan2(e,t)*180/Math.PI};r.prototype.GetSlideDirection=function(t,e,i,r){var a=e-r;var n=i-t;var o=0;if(Math.abs(n)<2&&Math.abs(a)<2){return o}var s=this.GetSlideAngle(n,a);if(s>=-45&&s<45){o=4}else if(s>=45&&s<135){o=1}else if(s>=-135&&s<-45){o=2}else if(s>=135&&s<=180||s>=-180&&s<-135){o=3}return o};r.prototype.isEnlarge=function(t,e,i,r){var a=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y));var n=Math.sqrt((i.x-r.x)*(i.x-r.x)+(i.y-r.y)*(i.y-r.y));if(a<n){return true}else{return false}};r.mouseX=0;r.mouseY=0;r.wheelDelta=0;r.mouseOffsetX=0;r.mouseOffsetY=0;r.mouseLastX=0;r.mouseLastY=0;r._instance=null;return r}(t.EventDispatcher);t.Input=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.orientation=new t.Vector3D;this.screenOrientation=0;this.openDebug=false;this.offsetRotation=new t.Vector3D;this.fixOritation=new t.Vector3D;this.state=-1;this.degtorad=Math.PI/180;this.q=new t.Quaternion;this.q1=new t.Quaternion;this.outQ=new t.Quaternion;this.fix=new t.Vector3D;this.fixinterpolate=new t.Vector3D;this.fixAxis=new t.Vector3D;this.caheFixAxis=new t.Vector3D;this.steps=3.001;this.interpolate=true;if(this.openDebug){this.accDiv=document.createElement("div");this.accGravityDiv=document.createElement("div");this.rotationRateDiv=document.createElement("div");this.orientationRateDiv=document.createElement("div");this.stateDiv=document.createElement("div");this.accDiv.style.color="red";this.accGravityDiv.style.color="red";this.rotationRateDiv.style.color="red";this.orientationRateDiv.style.color="red";this.stateDiv.style.color="red";this.stateDiv.style.fontSize="52";document.body.appendChild(this.accDiv);document.body.appendChild(this.accGravityDiv);document.body.appendChild(this.rotationRateDiv);document.body.appendChild(this.orientationRateDiv);document.body.appendChild(this.stateDiv)}}e.prototype.start=function(){var t=this;this.orientationchangeHandler();window.addEventListener("orientationchange",function(){return t.orientationchangeHandler()});window.addEventListener("devicemotion",function(e){return t.motionHandler(e)});window.addEventListener("deviceorientation",function(e){return t.orientationHandler(e)})};e.prototype.stop=function(){var t=this;window.removeEventListener("orientationchange",function(){return t.orientationchangeHandler()});window.removeEventListener("devicemotion",function(e){return t.motionHandler(e)});window.removeEventListener("deviceorientation",function(e){return t.orientationHandler(e)})};e.prototype.orientationchangeHandler=function(){if(window.orientation!=undefined)this.screenOrientation=window.orientation};e.prototype.motionHandler=function(t){this.acc=t.acceleration;this.accGravity=t.accelerationIncludingGravity;this.rotationRate=t.rotationRate};e.prototype.orientationHandler=function(t){this.orientation.x=t.alpha;this.orientation.y=t.beta;this.orientation.z=t.gamma;if(this.openDebug)this.debug()};e.prototype.debug=function(){this.accGravityDiv.innerHTML="<br><br> Gravity-x:"+this.orientation.x*t.MathUtil.RADIANS_TO_DEGREES+"<br>Gravity-y:"+this.orientation.y+"<br>Gravity-z:"+this.orientation.z;this.orientationRateDiv.innerHTML="<br> orientation-x:"+this.fixOritation.x+"<br>orientation-y:"+this.fixOritation.y+"<br>orientation-z:"+this.fixOritation.z;this.stateDiv.innerHTML="<br> state: "+this.state};e.prototype.getOrientation=function(){switch(window.screen.msOrientation){case"landscape-primary":return-90;case"landscape-secondary":return 90;case"portrait-secondary":return 180;case"portrait-primary":return 0}return 270};e.prototype.getQuaternion=function(e,i,r){var a=i?i*this.degtorad:0;var n=r?r*this.degtorad:0;var o=e?e*this.degtorad:0;a=Math.floor(a*100)/100;n=Math.floor(n*100)/100;var s=-this.getOrientation()*this.degtorad;this.state=this.getOrientation();var h=Math.cos(a/2);var u=Math.cos(n/2);var l=Math.cos(o/2);var c=Math.sin(a/2);var f=Math.sin(n/2);var d=Math.sin(o/2);this.q.w=h*u*l-c*f*d;this.q.x=c*u*l-h*f*d;this.q.y=h*f*l+c*u*d;this.q.z=h*u*d+c*f*l;var p=new t.Vector3D(0,0,1);var _=new t.Quaternion;_.fromAxisAngle(p,s);this.q.multiply(this.q,_);p.setTo(-1,0,0);_.fromAxisAngle(p,90*this.degtorad);this.q.multiply(this.q,_);return this.q};e.prototype.update=function(t){this.getBaseQuaternion(this.orientation.x,this.orientation.y,this.orientation.z);this.q.toEulerAngles(this.fixOritation);if(this.interpolate){this.fixinterpolate.x=this.fixOritation.x-this.fix.x;this.fixinterpolate.y=this.fixOritation.y-this.fix.y;this.fixinterpolate.z=this.fixOritation.z-this.fix.z;this.caheFixAxis.x=this.fixOritation.x/Math.abs(this.fixOritation.x);this.caheFixAxis.y=this.fixOritation.y/Math.abs(this.fixOritation.y);this.caheFixAxis.z=this.fixOritation.z/Math.abs(this.fixOritation.z);if(Math.abs(this.fixinterpolate.x)>150||Math.abs(this.fixinterpolate.y)>150||Math.abs(this.fixinterpolate.z)>150){this.fix.x=this.fixOritation.x;this.fix.y=this.fixOritation.y;this.fix.z=this.fixOritation.z}else{this.fix.x+=this.fixinterpolate.x/this.steps;this.fix.y+=this.fixinterpolate.y/this.steps;this.fix.z+=this.fixinterpolate.z/this.steps}t.camera3D.rotationX=-this.fix.x;t.camera3D.rotationY=-this.fix.y;t.camera3D.rotationZ=this.fix.z}else{t.camera3D.rotationX=-this.fixOritation.x;t.camera3D.rotationY=-this.fixOritation.y;t.camera3D.rotationZ=this.fixOritation.z}};e.prototype.getBaseQuaternion=function(t,e,i){var r=e?e*this.degtorad:0;var a=i?i*this.degtorad:0;var n=t?t*this.degtorad:0;var o=Math.cos(r/2);var s=Math.cos(a/2);var h=Math.cos(n/2);var u=Math.sin(r/2);var l=Math.sin(a/2);var c=Math.sin(n/2);var f=o*s*h-u*l*c;var d=u*s*h-o*l*c;var p=o*l*h+u*s*c;var _=o*s*c+u*l*h;this.q.w=f;this.q.x=d;this.q.y=p;this.q.z=_;return this.q};return e}();t.OrientationController=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.url="";this._dataformat=null;this.data=null;this.taskTotal=0;this.taskCurrent=0;this.currentProgress=0;this.resourceName=""}Object.defineProperty(i.prototype,"dataformat",{get:function(){return this._dataformat},set:function(t){this._dataformat=t},enumerable:true,configurable:true});i.prototype.dispose=function(){e.prototype.dispose.call(this)};i.prototype.processFileFormat=function(){var e=t.StringUtil.getFileFormat(this.url);switch(e){case"rar":this._dataformat=i.DATAFORMAT_BINARY;case"7z":this._dataformat=i.DATAFORMAT_BINARY;case"lzma":this._dataformat=i.DATAFORMAT_BINARY;break;case"dds":this._dataformat=i.DATAFORMAT_DDS;break;case"tga":this._dataformat=i.DATAFORMAT_TGA;break;case"bmp":this._dataformat=i.DATAFORMAT_BITMAP;break;case"png":this._dataformat=i.DATAFORMAT_BITMAP;break;case"jpg":this._dataformat=i.DATAFORMAT_BITMAP;break;case"hdr":this._dataformat=i.DATAFORMAT_HDR;break;case"glsl":this._dataformat=i.DATAFORMAT_TEXT;break;case"pvr":this._dataformat=i.DATAFORMAT_PVR;break;case"esm":this._dataformat=i.DATAFORMAT_ESM;break;case"eam":this._dataformat=i.DATAFORMAT_EAM;break;case"e3dpack":this._dataformat=i.DATAFORMAT_E3DPACK;break;case"eum":this._dataformat=t.URLLoader.DATAFORMAT_EUM;break;case"eca":this._dataformat=i.DATAFORMAT_ECA;break;case"epa":this._dataformat=i.DATAFORMAT_EPA;break;case"json":this._dataformat=i.DATAFORMAT_JSON;break;case"xml":this._dataformat=i.DATAFORMAT_XML;break}};i.DATAFORMAT_BINARY="binary";i.DATAFORMAT_TEXT="text";i.DATAFORMAT_SOUND="sound";i.DATAFORMAT_BITMAP="bitmap";i.DATAFORMAT_DDS="dds";i.DATAFORMAT_TGA="tga";i.DATAFORMAT_ESM="esm";i.DATAFORMAT_EAM="eam";i.DATAFORMAT_E3DPACK="e3dpack";i.DATAFORMAT_EUM="eum";i.DATAFORMAT_ECA="eca";i.DATAFORMAT_EPA="epa";i.DATAFORMAT_PVR="pvr";i.DATAFORMAT_HDR="hdr";i.DATAFORMAT_JSON="json";i.DATAFORMAT_XML="xml";return i}(t.EventDispatcher);t.ILoader=e})(egret3d||(egret3d={}));var egret3d;(function(egret3d){var URLLoader=function(_super){__extends(URLLoader,_super);function URLLoader(t,e){if(t===void 0){t=null}if(e===void 0){e=null}_super.call(this);this._event=new egret3d.LoaderEvent3D;this.parentUrl="";if(t){this.load(t,e)}}URLLoader.prototype.load=function(t,e){var i=this;if(e===void 0){e=null}this.data=null;this.url=t;this.resourceName=egret3d.StringUtil.getURLName(this.url);this.dataformat=e;if(null==this._dataformat){this.processFileFormat()}if(this._xhr==null){this._xhr=this.getXHR()}if(this._xhr==null){alert("Your browser does not support XMLHTTP.");return}if(this._xhr.readyState>0){this._xhr.abort();this.disposeXhrEventListener()}this._xhr.open("GET",this.url,true);this.progress=function(t){return i.onProgress(t)};this.readystatechange=function(t){return i.onReadyStateChange(t)};this.error=function(t){return i.onError(t)};this._xhr.addEventListener("progress",this.progress,false);this._xhr.addEventListener("readystatechange",this.readystatechange,false);this._xhr.addEventListener("error",this.error,false);if(this.dataformat==URLLoader.DATAFORMAT_BITMAP){this._xhr.responseType="blob"}else if(this.dataformat!=URLLoader.DATAFORMAT_TEXT&&this.dataformat!=URLLoader.DATAFORMAT_JSON&&this.dataformat!=URLLoader.DATAFORMAT_XML){this._xhr.responseType="arraybuffer"}this._xhr.send()};Object.defineProperty(URLLoader.prototype,"bytesLoaded",{get:function(){return this._progressEvent?this._progressEvent.loaded:0},enumerable:true,configurable:true});Object.defineProperty(URLLoader.prototype,"bytesTotal",{get:function(){return this._progressEvent?this._progressEvent.total:0},enumerable:true,configurable:true});URLLoader.prototype.onReadyStateChange=function(t){if(this._xhr.readyState==4){if(this._xhr.status>=400){console.log(this.url,"load fail")}else{this.loadComplete()}}};URLLoader.prototype.loadComplete=function(){var _this=this;switch(this.dataformat){case egret3d.ILoader.DATAFORMAT_BINARY:this.data=new egret3d.ByteArray(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_SOUND:this.data=this._xhr.responseBody;break;case egret3d.ILoader.DATAFORMAT_TEXT:this.data=this._xhr.responseText;break;case egret3d.ILoader.DATAFORMAT_BITMAP:var img=document.createElement("img");if(window["createObjectURL"]!=undefined){img.src=window["createObjectURL"](this._xhr.response)}else if(window["URL"]!=undefined){img.src=window["URL"].createObjectURL(this._xhr.response)}else if(window["webkitURL"]!=undefined){img.src=window["webkitURL"].createObjectURL(this._xhr.response)}img.onload=function(){return _this.onLoad(img)};return;case egret3d.ILoader.DATAFORMAT_DDS:this.data=egret3d.DDSParser.parse(this._xhr.response);this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_TGA:this.data=egret3d.TGAParser.parse(this._xhr.response);this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_HDR:this.data=egret3d.HDRParser.parse(this._xhr.response);this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_ESM:this.data=egret3d.ESMParser.parse(this._xhr.response,this.unitNodeData);break;case egret3d.ILoader.DATAFORMAT_EAM:this.data=egret3d.EAMParser.parse(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_ECA:this.data=egret3d.ECAParser.parse(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_EPA:this.data=egret3d.EPAParser.parse(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_E3DPACK:this.data=egret3d.E3dPackParser.parse(this._xhr.response,this.url);break;case URLLoader.DATAFORMAT_EUM:this.data=egret3d.EUMParser.parse(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_XML:this.data=egret3d.XMLParser.parse(this._xhr.responseText);break;case egret3d.ILoader.DATAFORMAT_JSON:this.data=eval("("+this._xhr.responseText+")");break;default:this.data=this._xhr.response;break}this.doLoadComplete()};URLLoader.prototype.onProgress=function(t){this._event.eventType=egret3d.LoaderEvent3D.LOADER_PROGRESS;this._event.loader=this;this._event.total=t.total;this._event.loaded=t.loaded;this._progressEvent=t;this.currentProgress=t.loaded/t.total;if(this.currentProgress<1){this._event.currentProgress=this.currentProgress;this.dispatchEvent(this._event)}};URLLoader.prototype.onError=function(t){this._event.eventType=egret3d.LoaderEvent3D.LOADER_ERROR;this._event.target=this;this._event.loader=this;this.dispatchEvent(this._event);console.log("load error",t);this.disposeXhrEventListener()};URLLoader.prototype.getXHR=function(){var t=null;if(window["XMLHttpRequest"]){t=new window["XMLHttpRequest"]}else{t=new ActiveXObject("MSXML2.XMLHTTP")}return t};URLLoader.prototype.onLoad=function(t){this.data=new egret3d.ImageTexture(t);this.checkTexture(this.data);this.doLoadComplete();if(window["createObjectURL"]!=undefined){window["revokeObjectURL"](t.src)}else if(window["URL"]!=undefined){window["URL"].revokeObjectURL(t.src)}else if(window["webkitURL"]!=undefined){window["webkitURL"].revokeObjectURL(t.src)}t.onload=null};URLLoader.prototype.checkTexture=function(t){if((t.width&t.width-1)!=0||(t.height&t.height-1)!=0){egret3d.Egret3DLog.outError("<"+this.url+">"+"<贴图宽高不是2的N次方>")}};URLLoader.prototype.doLoadComplete=function(){this.currentProgress=1;this.disposeXhrEventListener();this._event.loader=this;this._event.data=this.data;this._event.total=this._progressEvent.total;this._event.loaded=this._progressEvent.loaded;this._event.currentProgress=this.currentProgress;this._event.eventType=egret3d.LoaderEvent3D.LOADER_ONCE_COMPLETE;this.dispatchEvent(this._event);this._event.eventType=egret3d.LoaderEvent3D.LOADER_PROGRESS;this.dispatchEvent(this._event);this._event.eventType=egret3d.LoaderEvent3D.LOADER_COMPLETE;this.dispatchEvent(this._event)};URLLoader.prototype.disposeXhrEventListener=function(){if(this.progress){this._xhr.removeEventListener("progress",this.progress,false);this.progress=null}if(this.readystatechange){this._xhr.removeEventListener("readystatechange",this.readystatechange,false);this.readystatechange=null}if(this.error){this._xhr.removeEventListener("error",this.error,false);this.error=null}};URLLoader.prototype.dispose=function(){_super.prototype.dispose.call(this);if(this.data&&this.data.dispose){this.data.dispose()}this.data=null;this._event=null;this.disposeXhrEventListener();this._xhr=null};return URLLoader}(egret3d.ILoader);egret3d.URLLoader=URLLoader})(egret3d||(egret3d={}));var egret3d;(function(egret3d){var BinaryLoader=function(_super){__extends(BinaryLoader,_super);function BinaryLoader(t){if(t===void 0){t=null}_super.call(this);this._event=new egret3d.LoaderEvent3D;if(t){this.load(t)}}BinaryLoader.prototype.load=function(t){this.data=null;this.url=t;this.resourceName=egret3d.StringUtil.getURLName(this.url);this.processFileFormat();this.loadComplete()};BinaryLoader.prototype.loadComplete=function(){var _this=this;
var byte=egret3d.assetMgr.getByteArray(this.url);switch(this.dataformat){case egret3d.ILoader.DATAFORMAT_BINARY:this.data=byte;break;case egret3d.ILoader.DATAFORMAT_BITMAP:var blob=new Blob([byte.buffer]);var img=document.createElement("img");if(window["createObjectURL"]!=undefined){img.src=window["createObjectURL"](blob)}else if(window["URL"]!=undefined){img.src=window["URL"].createObjectURL(blob)}else if(window["webkitURL"]!=undefined){img.src=window["webkitURL"].createObjectURL(blob)}img.onload=function(){return _this.onLoad(img)};return;case egret3d.ILoader.DATAFORMAT_DDS:this.data=egret3d.DDSParser.parse(byte.buffer);this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_TGA:this.data=egret3d.TGAParser.parse(byte.buffer);this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_HDR:this.data=egret3d.HDRParser.parse(byte.buffer);this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_ESM:this.data=egret3d.ESMParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_EAM:this.data=egret3d.EAMParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_ECA:this.data=egret3d.ECAParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_EPA:this.data=egret3d.EPAParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_E3DPACK:this.data=egret3d.E3dPackParser.parse(byte.buffer,this.url);break;case egret3d.URLLoader.DATAFORMAT_EUM:this.data=egret3d.EUMParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_XML:this.data=egret3d.XMLParser.parse(egret3d.StringUtil.ab2str(byte));break;case egret3d.ILoader.DATAFORMAT_JSON:this.data=eval("("+egret3d.StringUtil.ab2str(byte)+")");break;default:this.data=byte.buffer;break}setTimeout(function(){_this.doLoadComplete()},0)};BinaryLoader.prototype.onLoad=function(t){this.data=new egret3d.ImageTexture(t);this.checkTexture(this.data);this.doLoadComplete();if(window["createObjectURL"]!=undefined){window["revokeObjectURL"](t.src)}else if(window["URL"]!=undefined){window["URL"].revokeObjectURL(t.src)}else if(window["webkitURL"]!=undefined){window["webkitURL"].revokeObjectURL(t.src)}t.onload=null};BinaryLoader.prototype.checkTexture=function(t){if((t.width&t.width-1)!=0||(t.height&t.height-1)!=0){egret3d.Egret3DLog.outError("<"+this.url+">"+"<贴图宽高不是2的N次方>")}};BinaryLoader.prototype.doLoadComplete=function(){this.currentProgress=1;this._event.loader=this;this._event.data=this.data;this._event.currentProgress=this.currentProgress;this._event.eventType=egret3d.LoaderEvent3D.LOADER_PROGRESS;this.dispatchEvent(this._event);this._event.eventType=egret3d.LoaderEvent3D.LOADER_ONCE_COMPLETE;this.dispatchEvent(this._event);this._event.eventType=egret3d.LoaderEvent3D.LOADER_COMPLETE;this.dispatchEvent(this._event)};return BinaryLoader}(egret3d.ILoader);egret3d.BinaryLoader=BinaryLoader})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._loaderDict={};this._queueLoader=[];this._loaderEvent=new t.LoaderEvent3D;this._binaryDict={};this._binaryUrlDict={}}e.prototype.loadAsset=function(e,i,r,a){if(a===void 0){a=null}return this.addEventListener(e,t.LoaderEvent3D.LOADER_COMPLETE,i,r,a)};e.prototype.addEventListener=function(e,i,r,a,n){var o=this;if(n===void 0){n=null}var s=this._loaderDict[e];if(!s){s={};this._loaderDict[e]=s;if(this.getByteArray(e)){s.loader=new t.BinaryLoader}else{s.loader=new t.URLLoader}s.objects=[];var h=s.loader;h.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onComplete,this);this._queueLoader.push(e);if(!this._currentLoader){this._currentLoader=h;this._currentLoader.load(e)}}var h=s.loader;h.param=n;if(n instanceof t.UnitNodeData){h.unitNodeData=n}if(h.data){setTimeout(function(){o._loaderEvent.eventType=i;o._loaderEvent.target=h;o._loaderEvent.loader=h;o._loaderEvent.data=h.data;o._loaderEvent.param=n;if(r){r.call(a,o._loaderEvent)}o._loaderEvent.target=null;o._loaderEvent.loader=null;o._loaderEvent.data=null;o._loaderEvent.param=null},0)}else{if(r){h.addEventListener(i,r,a,n)}}if(s.objects.indexOf(a)<0){s.objects.push(a)}return h};e.prototype.findAsset=function(t,e){if(e===void 0){e=null}var i=this._loaderDict[t];if(i){if(e){if(i.objects.indexOf(e)<0){i.objects.push(e)}}return i.loader}return null};e.prototype.dispose=function(t){var e=[];for(var i in this._loaderDict){var r=this._loaderDict[i];var a=r.objects.indexOf(t);if(a>=0){r.objects.splice(a,1)}if(r.objects.length<=0){e.push(i)}}for(var n=0;n<e.length;++n){var r=this._loaderDict[e[n]];r.loader.dispose();r.loader=null;r.objects=null;delete this._loaderDict[e[n]]}e=null};e.prototype.onComplete=function(t){this._queueLoader.shift();if(this._queueLoader.length>0){var e=this._loaderDict[this._queueLoader[0]];var i=e.loader;i.load(this._queueLoader[0]);this._currentLoader=i}else{this._currentLoader=null}};e.prototype.addByteArray=function(t,e,i){this._binaryDict[t]=e;var r=this._binaryUrlDict[i];if(!r){r=[];this._binaryUrlDict[i]=r}r.push(t)};e.prototype.removeByteArray=function(t){var e=this._binaryUrlDict[t];if(e){for(var i=0;i<e.length;++i){delete this._binaryDict[e[i]]}delete this._binaryUrlDict[t]}};e.prototype.getByteArray=function(t){return this._binaryDict[t]};return e}();t.AssetManager=e;t.assetMgr=new e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._textureDic={};this._urlTextureDic={};this._bigTextureDic={};this._count=0;this.resetCount()}Object.defineProperty(i.prototype,"guiStage",{get:function(){return this._guiStage},set:function(t){this._guiStage=t},enumerable:true,configurable:true});i.prototype.resetCount=function(){this._totalCount=0;this._loadedCount=0};Object.defineProperty(i.prototype,"totalCount",{get:function(){return this._totalCount},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"loadedCount",{get:function(){return this._loadedCount},enumerable:true,configurable:true});i.prototype.loadTexture=function(e,i){var r=this;var a=function(i,a){var n=a["frames"];for(var o=0;o<n.length;o++){var s=n[o];var h=s["filename"];var u=s["frame"];var l=new t.Texture;l.copyFromTexture(i,u["x"]/i.width,u["y"]/i.height,u["w"]/i.width,u["h"]/i.height);l.width=u["w"];l.height=u["h"];if(r._textureDic[h]){console.log("TextureResourceManager::loadTexture, 贴图缓存池里已经有相同名字的贴图. 请检查, name: "+h+" url:"+e)}r._textureDic[h]=l}};this._count++;this._totalCount++;var n=function(i){var n=new t.URLLoader(e);n.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,function(e){i.useMipmap=false;t.registGUITexture(i);a(i,JSON.parse(n.data));r._count--;r._loadedCount++;r.dispatchEvent(new t.LoaderEvent3D(t.LoaderEvent3D.LOADER_PROGRESS));if(r._count===0){r.resetCount();setTimeout(function(){r.dispatchEvent(new t.LoaderEvent3D(t.LoaderEvent3D.LOADER_COMPLETE))},0)}},r)};var o=new t.URLLoader(i);o.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,function(t){n(o.data)},this)};i.prototype.getTextureDic=function(){return this._textureDic};i.prototype.getTexture=function(t){return this._textureDic[t]};i.prototype.addTexture=function(e,i,r){t.registGUITexture(r);this._bigTextureDic[e]=r;var a=[];this._urlTextureDic[e]=a;var n=i["frames"];var o;for(var s=0;s<n.length;s++){var h=n[s];o=h["filename"];var u=h["frame"];var l=new t.Texture;l.copyFromTexture(r,u["x"]/r.width,u["y"]/r.height,u["w"]/r.width,u["h"]/r.height);l.width=u["w"];l.height=u["h"];if(this._textureDic[o]){console.log("TextureResourceManager::loadTexture, 贴图缓存池里已经有相同名字的贴图. 请检查, url: "+e)}this._textureDic[o]=l;a.push(o)}};i.prototype.removeTexture=function(t){var e=this._urlTextureDic[t];if(e){for(var i=0;i<e.length;i++){delete this._textureDic[e[i]]}}};return i}(t.EventDispatcher);t.TextureResourceManager=e;t.textureResMgr=new e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["RGB_S3TC_DXT1_FORMAT"]=2001]="RGB_S3TC_DXT1_FORMAT";t[t["RGBA_S3TC_DXT1_FORMAT"]=2002]="RGBA_S3TC_DXT1_FORMAT";t[t["RGBA_S3TC_DXT3_FORMAT"]=2003]="RGBA_S3TC_DXT3_FORMAT";t[t["RGBA_S3TC_DXT5_FORMAT"]=2003]="RGBA_S3TC_DXT5_FORMAT"})(t.DDSFormat||(t.DDSFormat={}));var e=t.DDSFormat;var i=function(){function i(){}i.parse=function(r,a){if(a===void 0){a=true}var n=31;var o=0;var s=542327876;var h=1,u=2,l=4,c=8,f=4096,d=131072,p=524288,_=8388608;var m=8,v=4194304,g=4096;var y=512,x=1024,b=2048,D=4096,T=8192,P=16384,A=32768,w=2097152;var S=1,C=2,E=4,L=64,M=512,F=131072;var R=i.fourCCToInt32("DXT1");var O=i.fourCCToInt32("DXT3");var I=i.fourCCToInt32("DXT5");var z=1021;var o=0;var V=1;var B=2;var N=3;var U=4;var k=7;var G=20;var j=21;var X=22;var H=23;var Y=24;var K=25;var Q=26;var q=27;var W=28;var Z=29;var J=30;var $=new Int32Array(r,0,n);if($[o]!==s){console.error("DDSParser.parse: Invalid magic number in DDS header.");return null}if(!($[G]&E)){console.error("DDSParser.parse: Unsupported format, must contain a FourCC code.");return null}var tt;var et=$[j];var it=false;var rt=1;var at;var nt;var ot;var st;switch(et){case R:tt=8;at=e.RGB_S3TC_DXT1_FORMAT;break;case O:tt=16;at=e.RGBA_S3TC_DXT3_FORMAT;break;case I:tt=16;at=e.RGBA_S3TC_DXT5_FORMAT;break;default:if($[X]==32&&$[H]&16711680&&$[Y]&65280&&$[K]&255&&$[Q]&4278190080){it=true;tt=64;at=z}else{console.error("DDSParser.parse: Unsupported FourCC code ",i.int32ToFourCC(et));return null}}if($[B]&d&&a!==false){rt=Math.max(1,$[k])}nt=$[W]&y?true:false;ot=$[U];st=$[N];var ht=$[V]+4;var ut=nt?6:1;var lt=new Array;var ct=false;if(at==e.RGB_S3TC_DXT1_FORMAT&&t.ContextConfig.ColorFormat_DXT1_RGB==0)ct=true;else if(at==e.RGBA_S3TC_DXT3_FORMAT&&t.ContextConfig.ColorFormat_DXT3_RGBA==0)ct=true;else if(at==e.RGBA_S3TC_DXT5_FORMAT&&t.ContextConfig.ColorFormat_DXT5_RGBA==0)ct=true;var ft=new t.Texture;ft.width=ot;ft.height=st;for(var dt=0;dt<ut;dt++){for(var pt=0;pt<rt;pt++){var _t;if(it){_t=i.loadARGBMip(r,ht,ot,st);var mt=_t.length}else{var mt=Math.max(4,ot)/4*Math.max(4,st)/4*tt;_t=new Uint8Array(r,ht,mt);if(ct){_t=i.softSolutionDXT(ot,st,at,_t)}}var vt=new t.MipmapData(_t,ot,st);lt.push(vt);ht+=mt;ot=Math.max(ot*.5,1);st=Math.max(st*.5,1)}ot=ot;st=st}if(ct){ft.internalFormat=t.InternalFormat.PixelArray;ft.colorFormat=t.ContextConfig.ColorFormat_RGBA8888}else{ft.internalFormat=t.InternalFormat.CompressData;if(R==et)ft.colorFormat=t.ContextConfig.ColorFormat_DXT1_RGB;else if(O==et)ft.colorFormat=t.ContextConfig.ColorFormat_DXT3_RGBA;else if(I==et)ft.colorFormat=t.ContextConfig.ColorFormat_DXT5_RGBA}ft.mimapData=lt;return ft};i.loadARGBMip=function(t,e,i,r){var a=i*r*4;var n=new Uint8Array(t,e,a);var o=new Uint8Array(a);var s=0;var h=0;for(var u=0;u<r;u++){for(var l=0;l<i;l++){var c=n[h];h++;var f=n[h];h++;var d=n[h];h++;var p=n[h];h++;o[s]=d;s++;o[s]=f;s++;o[s]=c;s++;o[s]=p;s++}}return o};i.fourCCToInt32=function(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)};i.int32ToFourCC=function(t){return String.fromCharCode(t&255,t>>8&255,t>>16&255,t>>24&65385)};i.softSolutionDXT=function(i,r,a,n){var o;var s=new Uint8Array(i*r*4);var h=[new t.Color,new t.Color,new t.Color,new t.Color];var u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];switch(a){case e.RGB_S3TC_DXT1_FORMAT:case e.RGBA_S3TC_DXT1_FORMAT:{o=n.length/8;for(var l=0;l<o;l++){var c=n[l*8+0]|n[l*8+1]<<8;var f=n[l*8+2]|n[l*8+3]<<8;h[0].r=c>>11&31;h[0].g=c>>5&63;h[0].b=c&31;h[0].a=255;h[1].r=f>>11&31;h[1].g=f>>5&63;h[1].b=f&31;h[1].a=255;if(c>f){h[2].lerp(h[0],h[1],.33);h[3].lerp(h[0],h[1],.66)}else{h[2].lerp(h[0],h[1],.5)}for(var d=0;d<4;d++){u[d*4+0]=n[l*8+4+d]&3;u[d*4+1]=n[l*8+4+d]>>2&3;u[d*4+2]=n[l*8+4+d]>>4&3;u[d*4+3]=n[l*8+4+d]>>6&3}for(var p=0;p<h.length;p++){h[p].r=h[p].r*8;h[p].g=h[p].g*4;h[p].b=h[p].b*8}var _=l%(i/4)*4;var m=Math.floor(l/(i/4))*4;if(m+0<r){if(_+0<i){s[(m+0)*(i*4)+(_+0)*4+0]=h[u[0]].r;s[(m+0)*(i*4)+(_+0)*4+1]=h[u[0]].g;s[(m+0)*(i*4)+(_+0)*4+2]=h[u[0]].b;s[(m+0)*(i*4)+(_+0)*4+3]=h[u[0]].a}if(_+1<i){s[(m+0)*(i*4)+(_+1)*4+0]=h[u[1]].r;s[(m+0)*(i*4)+(_+1)*4+1]=h[u[1]].g;s[(m+0)*(i*4)+(_+1)*4+2]=h[u[1]].b;s[(m+0)*(i*4)+(_+1)*4+3]=h[u[1]].a}if(_+2<i){s[(m+0)*(i*4)+(_+2)*4+0]=h[u[2]].r;s[(m+0)*(i*4)+(_+2)*4+1]=h[u[2]].g;s[(m+0)*(i*4)+(_+2)*4+2]=h[u[2]].b;s[(m+0)*(i*4)+(_+2)*4+3]=h[u[2]].a}if(_+3<i){s[(m+0)*(i*4)+(_+3)*4+0]=h[u[3]].r;s[(m+0)*(i*4)+(_+3)*4+1]=h[u[3]].g;s[(m+0)*(i*4)+(_+3)*4+2]=h[u[3]].b;s[(m+0)*(i*4)+(_+3)*4+3]=h[u[3]].a}}if(m+1<r){if(_+0<i){s[(m+1)*(i*4)+(_+0)*4+0]=h[u[4]].r;s[(m+1)*(i*4)+(_+0)*4+1]=h[u[4]].g;s[(m+1)*(i*4)+(_+0)*4+2]=h[u[4]].b;s[(m+1)*(i*4)+(_+0)*4+3]=h[u[4]].a}if(_+1<i){s[(m+1)*(i*4)+(_+1)*4+0]=h[u[5]].r;s[(m+1)*(i*4)+(_+1)*4+1]=h[u[5]].g;s[(m+1)*(i*4)+(_+1)*4+2]=h[u[5]].b;s[(m+1)*(i*4)+(_+1)*4+3]=h[u[5]].a}if(_+2<i){s[(m+1)*(i*4)+(_+2)*4+0]=h[u[6]].r;s[(m+1)*(i*4)+(_+2)*4+1]=h[u[6]].g;s[(m+1)*(i*4)+(_+2)*4+2]=h[u[6]].b;s[(m+1)*(i*4)+(_+2)*4+3]=h[u[6]].a}if(_+3<i){s[(m+1)*(i*4)+(_+3)*4+0]=h[u[7]].r;s[(m+1)*(i*4)+(_+3)*4+1]=h[u[7]].g;s[(m+1)*(i*4)+(_+3)*4+2]=h[u[7]].b;s[(m+1)*(i*4)+(_+3)*4+3]=h[u[7]].a}}if(m+2<r){if(_+0<i){s[(m+2)*(i*4)+(_+0)*4+0]=h[u[8]].r;s[(m+2)*(i*4)+(_+0)*4+1]=h[u[8]].g;s[(m+2)*(i*4)+(_+0)*4+2]=h[u[8]].b;s[(m+2)*(i*4)+(_+0)*4+3]=h[u[8]].a}if(_+1<i){s[(m+2)*(i*4)+(_+1)*4+0]=h[u[9]].r;s[(m+2)*(i*4)+(_+1)*4+1]=h[u[9]].g;s[(m+2)*(i*4)+(_+1)*4+2]=h[u[9]].b;s[(m+2)*(i*4)+(_+1)*4+3]=h[u[9]].a}if(_+2<i){s[(m+2)*(i*4)+(_+2)*4+0]=h[u[10]].r;s[(m+2)*(i*4)+(_+2)*4+1]=h[u[10]].g;s[(m+2)*(i*4)+(_+2)*4+2]=h[u[10]].b;s[(m+2)*(i*4)+(_+2)*4+3]=h[u[10]].a}if(_+3<i){s[(m+2)*(i*4)+(_+3)*4+0]=h[u[11]].r;s[(m+2)*(i*4)+(_+3)*4+1]=h[u[11]].g;s[(m+2)*(i*4)+(_+3)*4+2]=h[u[11]].b;s[(m+2)*(i*4)+(_+3)*4+3]=h[u[11]].a}}if(m+3<r){if(_+0<i){s[(m+3)*(i*4)+(_+0)*4+0]=h[u[12]].r;s[(m+3)*(i*4)+(_+0)*4+1]=h[u[12]].g;s[(m+3)*(i*4)+(_+0)*4+2]=h[u[12]].b;s[(m+3)*(i*4)+(_+0)*4+3]=h[u[12]].a}if(_+1<i){s[(m+3)*(i*4)+(_+1)*4+0]=h[u[13]].r;s[(m+3)*(i*4)+(_+1)*4+1]=h[u[13]].g;s[(m+3)*(i*4)+(_+1)*4+2]=h[u[13]].b;s[(m+3)*(i*4)+(_+1)*4+3]=h[u[13]].a}if(_+2<i){s[(m+3)*(i*4)+(_+2)*4+0]=h[u[14]].r;s[(m+3)*(i*4)+(_+2)*4+1]=h[u[14]].g;s[(m+3)*(i*4)+(_+2)*4+2]=h[u[14]].b;s[(m+3)*(i*4)+(_+2)*4+3]=h[u[14]].a}if(_+3<i){s[(m+3)*(i*4)+(_+3)*4+0]=h[u[15]].r;s[(m+3)*(i*4)+(_+3)*4+1]=h[u[15]].g;s[(m+3)*(i*4)+(_+3)*4+2]=h[u[15]].b;s[(m+3)*(i*4)+(_+3)*4+3]=h[u[15]].a}}}}break;case e.RGBA_S3TC_DXT3_FORMAT:{o=n.length/16;for(var l=0;l<o;l++){var c=n[l*16+8]|n[l*16+9]<<8;var f=n[l*16+10]|n[l*16+11]<<8;h[0].r=c>>11&31;h[0].g=c>>5&63;h[0].b=c&31;h[0].a=255;h[1].r=f>>11&31;h[1].g=f>>5&63;h[1].b=f&31;h[1].a=255;if(c>f){h[2].lerp(h[0],h[1],.33);h[3].lerp(h[0],h[1],.66)}else{h[2].lerp(h[0],h[1],.5);h[3].a=0}for(var d=0;d<4;d++){u[d*4+0]=n[l*16+12+d]&3;u[d*4+1]=n[l*16+12+d]>>2&3;u[d*4+2]=n[l*16+12+d]>>4&3;u[d*4+3]=n[l*16+12+d]>>6&3}for(var p=0;p<h.length;p++){h[p].r=h[p].r*8;h[p].g=h[p].g*4;h[p].b=h[p].b*8}var _=l%(i/4)*4;var m=Math.floor(l/(i/4))*4;if(m+0<r){if(_+0<i){s[(m+0)*(i*4)+(_+0)*4+0]=h[u[0]].r;s[(m+0)*(i*4)+(_+0)*4+1]=h[u[0]].g;s[(m+0)*(i*4)+(_+0)*4+2]=h[u[0]].b;s[(m+0)*(i*4)+(_+0)*4+3]=(n[l*16+0]&15)*17}if(_+1<i){s[(m+0)*(i*4)+(_+1)*4+0]=h[u[1]].r;s[(m+0)*(i*4)+(_+1)*4+1]=h[u[1]].g;s[(m+0)*(i*4)+(_+1)*4+2]=h[u[1]].b;s[(m+0)*(i*4)+(_+1)*4+3]=(n[l*16+0]>>4&15)*17}if(_+2<i){s[(m+0)*(i*4)+(_+2)*4+0]=h[u[2]].r;s[(m+0)*(i*4)+(_+2)*4+1]=h[u[2]].g;s[(m+0)*(i*4)+(_+2)*4+2]=h[u[2]].b;s[(m+0)*(i*4)+(_+2)*4+3]=(n[l*16+1]&15)*17}if(_+3<i){s[(m+0)*(i*4)+(_+3)*4+0]=h[u[3]].r;s[(m+0)*(i*4)+(_+3)*4+1]=h[u[3]].g;s[(m+0)*(i*4)+(_+3)*4+2]=h[u[3]].b;s[(m+0)*(i*4)+(_+3)*4+3]=(n[l*16+1]>>4&15)*17}}if(m+1<r){if(_+0<i){s[(m+1)*(i*4)+(_+0)*4+0]=h[u[4]].r;s[(m+1)*(i*4)+(_+0)*4+1]=h[u[4]].g;s[(m+1)*(i*4)+(_+0)*4+2]=h[u[4]].b;s[(m+1)*(i*4)+(_+0)*4+3]=(n[l*16+2]&15)*17}if(_+1<i){s[(m+1)*(i*4)+(_+1)*4+0]=h[u[5]].r;s[(m+1)*(i*4)+(_+1)*4+1]=h[u[5]].g;s[(m+1)*(i*4)+(_+1)*4+2]=h[u[5]].b;s[(m+1)*(i*4)+(_+1)*4+3]=(n[l*16+2]>>4&15)*17}if(_+2<i){s[(m+1)*(i*4)+(_+2)*4+0]=h[u[6]].r;s[(m+1)*(i*4)+(_+2)*4+1]=h[u[6]].g;s[(m+1)*(i*4)+(_+2)*4+2]=h[u[6]].b;s[(m+1)*(i*4)+(_+2)*4+3]=(n[l*16+3]&15)*17}if(_+3<i){s[(m+1)*(i*4)+(_+3)*4+0]=h[u[7]].r;s[(m+1)*(i*4)+(_+3)*4+1]=h[u[7]].g;s[(m+1)*(i*4)+(_+3)*4+2]=h[u[7]].b;s[(m+1)*(i*4)+(_+3)*4+3]=(n[l*16+3]>>4&15)*17}}if(m+2<r){if(_+0<i){s[(m+2)*(i*4)+(_+0)*4+0]=h[u[8]].r;s[(m+2)*(i*4)+(_+0)*4+1]=h[u[8]].g;s[(m+2)*(i*4)+(_+0)*4+2]=h[u[8]].b;s[(m+2)*(i*4)+(_+0)*4+3]=(n[l*16+4]&15)*17}if(_+1<i){s[(m+2)*(i*4)+(_+1)*4+0]=h[u[9]].r;s[(m+2)*(i*4)+(_+1)*4+1]=h[u[9]].g;s[(m+2)*(i*4)+(_+1)*4+2]=h[u[9]].b;s[(m+2)*(i*4)+(_+1)*4+3]=(n[l*16+4]>>4&15)*17}if(_+2<i){s[(m+2)*(i*4)+(_+2)*4+0]=h[u[10]].r;s[(m+2)*(i*4)+(_+2)*4+1]=h[u[10]].g;s[(m+2)*(i*4)+(_+2)*4+2]=h[u[10]].b;s[(m+2)*(i*4)+(_+2)*4+3]=(n[l*16+5]&15)*17}if(_+3<i){s[(m+2)*(i*4)+(_+3)*4+0]=h[u[11]].r;s[(m+2)*(i*4)+(_+3)*4+1]=h[u[11]].g;s[(m+2)*(i*4)+(_+3)*4+2]=h[u[11]].b;s[(m+2)*(i*4)+(_+3)*4+3]=(n[l*16+5]>>4&15)*17}}if(m+3<r){if(_+0<i){s[(m+3)*(i*4)+(_+0)*4+0]=h[u[12]].r;s[(m+3)*(i*4)+(_+0)*4+1]=h[u[12]].g;s[(m+3)*(i*4)+(_+0)*4+2]=h[u[12]].b;s[(m+3)*(i*4)+(_+0)*4+3]=(n[l*16+6]&15)*17}if(_+1<i){s[(m+3)*(i*4)+(_+1)*4+0]=h[u[13]].r;s[(m+3)*(i*4)+(_+1)*4+1]=h[u[13]].g;s[(m+3)*(i*4)+(_+1)*4+2]=h[u[13]].b;s[(m+3)*(i*4)+(_+1)*4+3]=(n[l*16+6]>>4&15)*17}if(_+2<i){s[(m+3)*(i*4)+(_+2)*4+0]=h[u[14]].r;s[(m+3)*(i*4)+(_+2)*4+1]=h[u[14]].g;s[(m+3)*(i*4)+(_+2)*4+2]=h[u[14]].b;s[(m+3)*(i*4)+(_+2)*4+3]=(n[l*16+7]&15)*17}if(_+3<i){s[(m+3)*(i*4)+(_+3)*4+0]=h[u[15]].r;s[(m+3)*(i*4)+(_+3)*4+1]=h[u[15]].g;s[(m+3)*(i*4)+(_+3)*4+2]=h[u[15]].b;s[(m+3)*(i*4)+(_+3)*4+3]=(n[l*16+7]>>4&15)*17}}}}break;case e.RGBA_S3TC_DXT5_FORMAT:break}return s};return i}();t.DDSParser=i})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["RGB_PVRTC_4BPPV1_Format"]=2100]="RGB_PVRTC_4BPPV1_Format";t[t["RGB_PVRTC_2BPPV1_Format"]=2101]="RGB_PVRTC_2BPPV1_Format";t[t["RGBA_PVRTC_4BPPV1_Format"]=2102]="RGBA_PVRTC_4BPPV1_Format";t[t["RGBA_PVRTC_2BPPV1_Format"]=2103]="RGBA_PVRTC_2BPPV1_Format"})(t.PVRFormat||(t.PVRFormat={}));var e=t.PVRFormat;var i=function(){function i(){}i.parse=function(e){var r;var a=13;var n=new Uint32Array(e,0,a);var o={buffer:e,header:n};if(n[0]===55727696){r=i._parseV3(o)}else if(n[11]===559044176){r=i._parseV2(o)}else{console.log("PVRParser unknow pvr format. PVRParser::parse");return r}r.internalFormat=t.InternalFormat.PixelArray;r.colorFormat=t.ContextConfig.ColorFormat_RGBA8888;r.useMipmap=false;return r};i._parseV2=function(t){var r=t.header;var a=r[0],n=r[1],o=r[2],s=r[3],h=r[4],u=r[5],l=r[6],c=r[7],f=r[8],d=r[9],p=r[10],_=r[11],m=r[12];var v=255;var g=24,y=25;var x=h&v;var l,b;var D=p>0;if(x===y){b=D?e.RGBA_PVRTC_4BPPV1_Format:e.RGB_PVRTC_4BPPV1_Format;l=4}else if(x===g){b=D?e.RGBA_PVRTC_2BPPV1_Format:e.RGB_PVRTC_2BPPV1_Format;l=2}else throw new Error("pvrtc - unknown format "+x);t.dataPtr=a;t.bpp=l;t.format=b;t.width=o;t.height=n;t.numSurfaces=m;t.numMipmaps=s+1;t.isCubemap=m===6;return i._extract(t)};i._parseV3=function(t){var r=t.header;var a,n;var o=r[12],s=r[2],h=r[6],u=r[7],l=r[9],c=r[10],f=r[11];switch(s){case 0:a=2;n=e.RGB_PVRTC_2BPPV1_Format;break;case 1:a=2;n=e.RGBA_PVRTC_2BPPV1_Format;break;case 2:a=4;n=e.RGB_PVRTC_4BPPV1_Format;break;case 3:a=4;n=e.RGBA_PVRTC_4BPPV1_Format;break;default:throw new Error("pvrtc - unsupported PVR format "+s)}t.dataPtr=52+o;t.bpp=a;t.format=n;t.width=u;t.height=h;t.numSurfaces=c;t.numMipmaps=f;t.isCubemap=c===6;return i._extract(t)};i._extract=function(e){var i=new t.Texture;i.width=e.width;i.height=e.height;var r=e.buffer;var a=e.dataPtr,n=e.bpp,o=e.numSurfaces,s=0,h=0,u=0,l=0,c=0,f=0;if(n===2){u=8;l=4}else{u=4;l=4}h=u*l*n/8;i.mimapData=[];var d=0;while(d<e.numMipmaps){var p=e.width>>d;var _=e.height>>d;c=p/u;f=_/l;if(c<2){c=2}if(f<2){f=2}s=c*f*h;for(var m=0;m<o;m++){var v=new Uint8Array(r,a,s);var g={data:v,width:p,height:_};i.mimapData[m*e.numMipmaps+d]=g;a+=s}d++}return i};return i}();t.PVRParser=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e){var i=0,r=1,a=2,n=3,o=9,s=10,h=11,u=48,l=4,c=0,f=1,d=2,p=3;if(e.byteLength<19){console.error("TGAParser.parse: Not enough data to contain header.")}var _=new Uint8Array(e),m=0,v={id_length:_[m++],colormap_type:_[m++],image_type:_[m++],colormap_index:_[m++]|_[m++]<<8,colormap_length:_[m++]|_[m++]<<8,colormap_size:_[m++],origin:[_[m++]|_[m++]<<8,_[m++]|_[m++]<<8],width:_[m++]|_[m++]<<8,height:_[m++]|_[m++]<<8,pixel_size:_[m++],flags:_[m++]};function g(t){switch(t.image_type){case r:case o:if(t.colormap_length>256||t.colormap_size!==24||t.colormap_type!==1){console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for indexed type")}break;case a:case n:case s:case h:if(t.colormap_type){console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for colormap type")}break;case i:console.error("TGAParser.parse.tgaCheckHeader: No data");break;default:console.error('TGAParser.parse.tgaCheckHeader: Invalid type " '+t.image_type+'"')}if(t.width<=0||t.height<=0){console.error("TGAParser.parse.tgaCheckHeader: Invalid image size")}if(t.pixel_size!==8&&t.pixel_size!==16&&t.pixel_size!==24&&t.pixel_size!==32){console.error('TGAParser.parse.tgaCheckHeader: Invalid pixel size "'+t.pixel_size+'"')}}g(v);if(v.id_length+m>e.byteLength){console.error("TGAParser.parse: No data")}m+=v.id_length;var y=false,x=false,b=false;switch(v.image_type){case o:y=true;x=true;break;case r:x=true;break;case s:y=true;break;case a:break;case h:y=true;b=true;break;case n:b=true;break}function D(t,e,i,r,a){var n,o,s,h;o=i.pixel_size>>3;s=i.width*i.height*o;if(e){h=a.subarray(r,r+=i.colormap_length*(i.colormap_size>>3))}if(t){n=new Uint8Array(s);var u,l,c;var f=0;var d=new Uint8Array(o);while(f<s){u=a[r++];l=(u&127)+1;if(u&128){for(c=0;c<o;++c){d[c]=a[r++]}for(c=0;c<l;++c){n.set(d,f+c*o)}f+=o*l}else{l*=o;for(c=0;c<l;++c){n[f+c]=a[r++]}f+=l}}}else{n=a.subarray(r,r+=e?i.width*i.height:s)}return{pixel_data:n,palettes:h}}function T(t,e,i,r,a,n,o,s,h){var u=h;var l,c=0,f,d;var p=v.width;for(d=e;d!==r;d+=i){for(f=a;f!==o;f+=n,c++){l=s[c];t[(f+p*d)*4+3]=255;t[(f+p*d)*4+2]=u[l*3+0];t[(f+p*d)*4+1]=u[l*3+1];t[(f+p*d)*4+0]=u[l*3+2]}}return t}function P(t,e,i,r,a,n,o,s){var h,u=0,l,c;var f=v.width;for(c=e;c!==r;c+=i){for(l=a;l!==o;l+=n,u+=2){h=s[u+0]+(s[u+1]<<8);t[(l+f*c)*4+0]=(h&31744)>>7;t[(l+f*c)*4+1]=(h&992)>>2;t[(l+f*c)*4+2]=(h&31)>>3;t[(l+f*c)*4+3]=h&32768?0:255}}return t}function A(t,e,i,r,a,n,o,s){var h=0,u,l;var c=v.width;for(l=e;l!==r;l+=i){for(u=a;u!==o;u+=n,h+=3){t[(u+c*l)*4+3]=255;t[(u+c*l)*4+2]=s[h+0];t[(u+c*l)*4+1]=s[h+1];t[(u+c*l)*4+0]=s[h+2]}}return t}function w(t,e,i,r,a,n,o,s){var h=0,u,l;var c=v.width;for(l=e;l!==r;l+=i){for(u=a;u!==o;u+=n,h+=4){t[(u+c*l)*4+2]=s[h+0];t[(u+c*l)*4+1]=s[h+1];t[(u+c*l)*4+0]=s[h+2];t[(u+c*l)*4+3]=s[h+3]}}return t}function S(t,e,i,r,a,n,o,s){var h,u=0,l,c;var f=v.width;for(c=e;c!==r;c+=i){for(l=a;l!==o;l+=n,u++){h=s[u];t[(l+f*c)*4+0]=h;t[(l+f*c)*4+1]=h;t[(l+f*c)*4+2]=h;t[(l+f*c)*4+3]=255}}return t}function C(t,e,i,r,a,n,o,s){var h=0,u,l;var c=v.width;for(l=e;l!==r;l+=i){for(u=a;u!==o;u+=n,h+=2){t[(u+c*l)*4+0]=s[h+0];t[(u+c*l)*4+1]=s[h+0];t[(u+c*l)*4+2]=s[h+0];t[(u+c*l)*4+3]=s[h+1]}}return t}function E(t,e,i,r){var a,n,o,s,h,_,m=new Uint8Array(t*e*4);switch((v.flags&u)>>l){default:case d:a=0;o=1;h=t;n=0;s=1;_=e;break;case c:a=0;o=1;h=t;n=e-1;s=-1;_=-1;break;case p:a=t-1;o=-1;h=-1;n=0;s=1;_=e;break;case f:a=t-1;o=-1;h=-1;n=e-1;s=-1;_=-1;break}if(b){switch(v.pixel_size){case 8:S(m,n,s,_,a,o,h,i);break;case 16:C(m,n,s,_,a,o,h,i);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format");break}}else{switch(v.pixel_size){case 8:T(m,n,s,_,a,o,h,i,r);break;case 16:P(m,n,s,_,a,o,h,i);break;case 24:A(m,n,s,_,a,o,h,i);break;case 32:w(m,n,s,_,a,o,h,i);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format");break}}return m}var L=D(y,x,v,m,_);var M=E(v.width,v.height,L.pixel_data,L.palettes);var F=new t.Texture;F.width=v.width;F.height=v.height;F.internalFormat=t.InternalFormat.PixelArray;F.colorFormat=t.ContextConfig.ColorFormat_RGBA8888;F.mimapData=[new t.MipmapData(M,v.width,v.height)];return F};return e}();t.TGAParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.ldexp=function(t,e){return e>1023?t*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?t*Math.pow(2,-1074)*Math.pow(2,e+1074):t*Math.pow(2,e)};e.readPixelsRawRLE=function(t,e,i,r,a,n){var o=new Array(4);var s=null;var h;var u;var l;var c=new Array(2);var f=t.length;function d(e){var i=0;do{e[i++]=t[r]}while(++r<f&&i<e.length);return i}function p(e,i,a){var n=0;do{e[i+n++]=t[r]}while(++r<f&&n<a);return n}function _(t,e,i,r){var a=4*r;var n=p(e,i,a);if(n<a){throw new Error("Error reading raw pixels: got "+n+" bytes, expected "+a)}}while(n>0){if(d(o)<o.length){throw new Error("Error reading bytes: expected "+o.length)}if(o[0]!=2||o[1]!=2||(o[2]&128)!=0){e[i++]=o[0];e[i++]=o[1];e[i++]=o[2];e[i++]=o[3];_(t,e,i,a*n-1);return}if(((o[2]&255)<<8|o[3]&255)!=a){throw new Error("Wrong scanline width "+((o[2]&255)<<8|o[3]&255)+", expected "+a)}if(s==null){s=new Array(4*a)}h=0;for(var m=0;m<4;m++){u=(m+1)*a;while(h<u){if(d(c)<c.length){throw new Error("Error reading 2-byte buffer")}if((c[0]&255)>128){l=(c[0]&255)-128;if(l==0||l>u-h){throw new Error("Bad scanline data")}while(l-- >0)s[h++]=c[1]}else{l=c[0]&255;if(l==0||l>u-h){throw new Error("Bad scanline data")}s[h++]=c[1];if(--l>0){if(p(s,h,l)<l){throw new Error("Error reading non-run data")}h+=l}}}}for(var m=0;m<a;m++){e[i+0]=s[m];e[i+1]=s[m+a];e[i+2]=s[m+2*a];e[i+3]=s[m+3*a];i+=4}n--}};e.parse=function(i){if(i instanceof ArrayBuffer){i=new Uint8Array(i)}var r=0;var a=i.length;var n=10;function o(){var t="";do{var e=i[r];if(e==n){++r;break}t+=String.fromCharCode(e)}while(++r<a);return t}var s=0;var h=0;var u=1;var l=1;var c=false;for(var f=0;f<20;f++){var d=o();var p;if(p=d.match(e.radiancePattern)){}else if(p=d.match(e.formatPattern)){c=true}else if(p=d.match(e.exposurePattern)){u=Number(p[1])}else if(p=d.match(e.commentPattern)){}else if(p=d.match(e.widthHeightPattern)){h=Number(p[1]);s=Number(p[2]);break}}if(!c){throw new Error("File is not run length encoded!")}var _=new Uint8Array(s*h*4);var m=s;var v=h;this.readPixelsRawRLE(i,_,0,r,m,v);var g=1;var y=new t.MipmapData(_,s,h);var x=new t.Texture;x.internalFormat=t.InternalFormat.PixelArray;x.colorFormat=t.ContextConfig.ColorFormat_RGBA8888;x.mimapData=[y];x.useMipmap=false;x.width=s;x.height=h;return x};e.radiancePattern="#\\?RADIANCE";e.commentPattern="#.*";e.gammaPattern="GAMMA=";e.exposurePattern="EXPOSURE=\\s*([0-9]*[.][0-9]*)";e.formatPattern="FORMAT=32-bit_rle_rgbe";e.widthHeightPattern="-Y ([0-9]+) \\+X ([0-9]+)";return e}();t.HDRParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e){var i=new t.ByteArray(e);var r=new t.ByteArray;i.readBytes(r,0,3);var a=i.readUnsignedInt();if(!t.EAMVersion.versionDictionary[a]){console.log("egret3d engine not found "+a+" version");return null}return t.EAMVersion.versionDictionary[a](i)};return e}();t.EAMParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.findNameIndex=function(t,e){if(""==e){return-1}for(var i=0;i<t.length;++i){if(e==t[i]){return i}}return-1};e.parserVersion_1=function(i){var r=i.readUnsignedByte();var a=i.readUnsignedByte();if(r<=0)return null;var n=new t.SkeletonAnimationClip;var o=n.boneNameArray;var s=new Array;for(var h=0;h<r;h++){o.push(i.readUTF());s.push(i.readUTF())}var u=i.readInt();var l=i.readInt();var c=new t.Quaternion;var f=new t.Vector3D;var d=new t.Vector3D;for(var h=0;h<l;h++){var p=new t.SkeletonPose;p.frame=i.readInt()/60/80*1e3;for(var _=0;_<r;_++){var m=new t.Joint;m.index=_;m.parentIndex=e.findNameIndex(o,s[_]);c.fromEulerAngles(i.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,i.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,i.readFloat()*t.MathUtil.RADIANS_TO_DEGREES);f.x=i.readFloat();f.y=i.readFloat();f.z=i.readFloat();d.x=i.readFloat();d.y=i.readFloat();d.z=i.readFloat();m.buildLocalMatrix(f,c,d);p.joints.push(m)}p.calculateJointWorldMatrix();n.addSkeletonPose(p)}return n};e.parserVersion_2=function(i){var r=i.readUnsignedByte();var a=i.readUnsignedByte();if(r<=0)return null;var n=new t.SkeletonAnimationClip;var o=n.boneNameArray;var s=new Array;for(var h=0;h<r;h++){o.push(i.readUTF());s.push(i.readUTF())}var u=i.readInt();var l=i.readInt();if(r*u>=1e4&&false){n.sampling=a;n.boneCount=r;n.frameDataOffset=i.position;n.sourceData=i;n.buildInitialSkeleton(o,s,l)}else{var c=new t.Quaternion;var f=new t.Vector3D;var d=new t.Vector3D;var p=0;for(var h=0;h<l;h++){var _=new t.SkeletonPose;_.boneNameArray=o;_.frame=i.readInt();p=Math.max(_.frameTime,p);for(var m=0;m<r;m++){var v=new t.Joint;v.index=m;v.parentIndex=e.findNameIndex(o,s[m]);c.x=i.readFloat();c.y=i.readFloat();c.z=i.readFloat();c.w=i.readFloat();f.x=i.readFloat();f.y=i.readFloat();f.z=i.readFloat();d.x=i.readFloat();d.y=i.readFloat();d.z=i.readFloat();v.buildLocalMatrix(f,c,d);_.joints.push(v)}n.addSkeletonPose(_)}n.totalTime=l*n.frameRate;n.totalFrame=l}return n};e.parserVersion_3=function(i){var r=i.readUnsignedByte();var a=i.readUnsignedByte();var n=i.readInt();var o=i.readInt();var s=i.readInt();var h=new t.SkeletonAnimationClip;var u=h.boneNameArray;var l=new Array;for(var c=0;c<r;c++){u.push(i.readUTF());l.push(i.readUTF())}if(r*s>=1e4&&false){h.sampling=a;h.boneCount=r;h.frameDataOffset=i.position;h.sourceData=i;h.buildInitialSkeleton(u,l,s)}else{var f=new t.Quaternion;var d=new t.Vector3D;var p=new t.Vector3D;var _=0;for(var c=0;c<s;c++){var m=new t.SkeletonPose;m.boneNameArray=u;m.frame=i.readInt();_=Math.max(m.frameTime,_);for(var v=0;v<r;v++){var g=new t.Joint;g.index=v;g.parentIndex=e.findNameIndex(u,l[v]);f.x=i.readFloat();f.y=i.readFloat();f.z=i.readFloat();f.w=i.readFloat();d.x=i.readFloat();d.y=i.readFloat();d.z=i.readFloat();p.x=i.readFloat();p.y=i.readFloat();p.z=i.readFloat();g.buildLocalMatrix(d,f,p);m.joints.push(g)}h.addSkeletonPose(m)}h.totalTime=o*h.frameRate;h.totalFrame=o}return h};e.versionDictionary={1:function(t){return e.parserVersion_1(t)},2:function(t){return e.parserVersion_2(t)},3:function(t){return e.parserVersion_3(t)}};return e}();t.EAMVersion=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e){var i=new t.ByteArray(e);var r=new t.ByteArray;i.readBytes(r,0,3);var a=i.readUnsignedInt();if(!t.ECAVersion.versionDictionary[a]){console.log("egret3d engine not found "+a+" version");return null}return t.ECAVersion.versionDictionary[a](i)};return e}();t.ECAParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parserVersion_1=function(e){var i=new t.CameraAnimationController;var r=e.readUnsignedInt();var a=null;var n=new t.Vector3D(1,1,1,1);while(r--){a=new t.CameraAnimationFrame;a.time=e.readInt();a.fov=e.readFloat();a.rotation=new t.Vector3D(e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES+90,e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES);a.translation=new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat());a.matrix=new t.Matrix4_4;a.matrix.recompose([a.translation,a.rotation,n]);i.cameraAnimationFrames.push(a)}return i};e.versionDictionary={1:function(t){return e.parserVersion_1(t)}};return e}();t.ECAVersion=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e,i){if(i===void 0){i=null}var r=new t.ByteArray(e);var a=new t.ByteArray;r.readBytes(a,0,3);var n=r.readUnsignedInt();if(!t.ESMVersion.versionDictionary[n]){console.log("egret3d engine not found "+n+" version");return null}var o=new t.GeometryData;t.ESMVersion.versionDictionary[n](r,o,i);var s;var h=0;if(o.source_skinData.length>0){h=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_SKIN;s=t.GeometryData.buildGeomtry(o,h)}else{h=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;s=t.GeometryData.buildGeomtry(o,h)}o=null;return s};return e}();t.ESMParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parserVersion_1=function(e,i,r){var a=e.readInt();
i.matCount=e.readInt();for(var n=0;n<i.matCount;++n){i.material[n]={};i.material[n].matID=e.readInt();i.material[n].start=e.readInt();i.material[n].count=e.readInt();i.material[n].textureDiffuse=e.readUTF();i.material[n].textureNormal=e.readUTF();i.material[n].textureSpecular=e.readUTF()}if(a&t.VertexFormat.VF_POSITION){var o=e.readInt();for(var n=0;n<o;n++){i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat())}}if(a&t.VertexFormat.VF_NORMAL){var s=e.readInt();for(var n=0;n<s;n++){i.source_normalData.push(e.readFloat());i.source_normalData.push(e.readFloat());i.source_normalData.push(e.readFloat())}}if(a&t.VertexFormat.VF_COLOR){var h=e.readInt();for(var n=0;n<h;n++){i.source_vertexColorData.push(e.readFloat());i.source_vertexColorData.push(e.readFloat());i.source_vertexColorData.push(e.readFloat());i.source_vertexColorData.push(e.readFloat())}}if(a&t.VertexFormat.VF_UV0){var u=e.readInt();for(var n=0;n<u;n++){i.source_uvData.push(e.readFloat());i.source_uvData.push(e.readFloat())}}if(a&t.VertexFormat.VF_UV1){var u=e.readInt();for(var n=0;n<u;n++){i.source_uv2Data.push(e.readFloat());i.source_uv2Data.push(e.readFloat())}}i.faces=e.readInt();for(var n=0;n<i.faces;n++){i.vertexIndices.push(e.readUnsignedInt());i.vertexIndices.push(e.readUnsignedInt());i.vertexIndices.push(e.readUnsignedInt());if(a&t.VertexFormat.VF_NORMAL){i.normalIndices.push(e.readUnsignedInt());i.normalIndices.push(e.readUnsignedInt());i.normalIndices.push(e.readUnsignedInt())}if(a&t.VertexFormat.VF_COLOR){i.colorIndices.push(e.readUnsignedInt());i.colorIndices.push(e.readUnsignedInt());i.colorIndices.push(e.readUnsignedInt())}if(a&t.VertexFormat.VF_UV0){i.uvIndices.push(e.readUnsignedInt());i.uvIndices.push(e.readUnsignedInt());i.uvIndices.push(e.readUnsignedInt())}if(a&t.VertexFormat.VF_UV1){i.uv2Indices.push(e.readUnsignedInt());i.uv2Indices.push(e.readUnsignedInt());i.uv2Indices.push(e.readUnsignedInt())}}var l=e.readUnsignedByte();if(l>0){i.skeleton=new t.Skeleton}var c=new t.Quaternion;var f=new t.Vector3D;var d=new t.Vector3D;var p=new t.Vector3D;for(var n=0;n<l;++n){var _=new t.Joint;e.readInt();_.parentIndex=e.readInt();_.name=e.readUTF();f.x=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES;f.y=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES;f.z=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES;d.x=e.readFloat();d.y=e.readFloat();d.z=e.readFloat();p.x=e.readFloat();p.y=e.readFloat();p.z=e.readFloat();_.buildInverseMatrix(d,f,p);i.skeleton.joints.push(_)}var m=e.readInt();for(var n=0;n<m;n++){var v=e.readUnsignedByte();for(var g=0;g<v;g++){i.source_skinData.push(e.readUnsignedByte());i.source_skinData.push(e.readFloat())}for(var g=v;g<4;g++){i.source_skinData.push(0);i.source_skinData.push(0)}}};e.parserVersion_2=function(e,i,r){var a=e.readInt();i.matCount=e.readInt();for(var n=0;n<i.matCount;++n){i.material[n]={};i.material[n].matID=e.readInt();i.material[n].start=e.readInt();i.material[n].count=e.readInt();i.material[n].textureDiffuse=e.readUTF();i.material[n].textureNormal=e.readUTF();i.material[n].textureSpecular=e.readUTF()}if(a&t.VertexFormat.VF_POSITION){var o=e.readInt();for(var n=0;n<o;n++){i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat())}}if(a&t.VertexFormat.VF_NORMAL){var s=e.readInt();for(var n=0;n<s;n++){i.source_normalData.push(e.readFloat());i.source_normalData.push(e.readFloat());i.source_normalData.push(e.readFloat())}}if(a&t.VertexFormat.VF_COLOR){var h=e.readInt();for(var n=0;n<h;n++){i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255)}}if(a&t.VertexFormat.VF_UV0){var u=e.readInt();for(var n=0;n<u;n++){i.source_uvData.push(e.readFloat());i.source_uvData.push(e.readFloat())}}if(a&t.VertexFormat.VF_UV1){var u=e.readInt();for(var n=0;n<u;n++){i.source_uv2Data.push(e.readFloat());i.source_uv2Data.push(e.readFloat())}}i.faces=e.readInt();for(var n=0;n<i.faces;n++){i.vertexIndices.push(e.readUnsignedShort());i.vertexIndices.push(e.readUnsignedShort());i.vertexIndices.push(e.readUnsignedShort());if(a&t.VertexFormat.VF_NORMAL){i.normalIndices.push(e.readUnsignedShort());i.normalIndices.push(e.readUnsignedShort());i.normalIndices.push(e.readUnsignedShort())}if(a&t.VertexFormat.VF_COLOR){i.colorIndices.push(e.readUnsignedShort());i.colorIndices.push(e.readUnsignedShort());i.colorIndices.push(e.readUnsignedShort())}if(a&t.VertexFormat.VF_UV0){i.uvIndices.push(e.readUnsignedShort());i.uvIndices.push(e.readUnsignedShort());i.uvIndices.push(e.readUnsignedShort())}if(a&t.VertexFormat.VF_UV1){i.uv2Indices.push(e.readUnsignedShort());i.uv2Indices.push(e.readUnsignedShort());i.uv2Indices.push(e.readUnsignedShort())}}var l=e.readUnsignedByte();if(l>0){i.skeleton=new t.Skeleton}var c=new t.Quaternion;var f=new t.Vector3D;var d=new t.Vector3D;var p=new t.Vector3D;for(var n=0;n<l;++n){var _=new t.Joint;e.readInt();_.parentIndex=e.readInt();_.name=e.readUTF();f.x=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES;f.y=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES;f.z=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES;d.x=e.readFloat();d.y=e.readFloat();d.z=e.readFloat();p.x=e.readFloat();p.y=e.readFloat();p.z=e.readFloat();_.buildInverseMatrix(d,f,p);i.skeleton.joints.push(_)}var m=e.readInt();for(var n=0;n<m;n++){var v=e.readUnsignedByte();for(var g=0;g<v;g++){i.source_skinData.push(e.readUnsignedByte());i.source_skinData.push(e.readFloat())}for(var g=v;g<4;g++){i.source_skinData.push(0);i.source_skinData.push(0)}}};e.parserVersion_3=function(e,i,r){var a=e.readInt();i.matCount=e.readInt();var n=0;var o=0;var s=0;var h=0;for(var u=0;u<i.matCount;++u){i.material[u]={};i.material[u].matID=e.readInt();i.material[u].start=e.readInt();i.material[u].count=e.readInt();i.material[u].textureDiffuse=e.readUTF();i.material[u].textureNormal=e.readUTF();i.material[u].textureSpecular=e.readUTF()}if(a&t.VertexFormat.VF_POSITION){var l=e.readInt();for(var u=0;u<l;u++){i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat())}}if(a&t.VertexFormat.VF_NORMAL){n=e.readInt();for(var u=0;u<n;u++){i.source_normalData.push(e.readFloat());i.source_normalData.push(e.readFloat());i.source_normalData.push(e.readFloat())}}if(a&t.VertexFormat.VF_COLOR){o=e.readInt();for(var u=0;u<o;u++){i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255)}}if(a&t.VertexFormat.VF_UV0){s=e.readInt();for(var u=0;u<s;u++){i.source_uvData.push(e.readFloat());i.source_uvData.push(e.readFloat())}}if(a&t.VertexFormat.VF_UV1){h=e.readInt();for(var u=0;u<h;u++){i.source_uv2Data.push(e.readFloat());i.source_uv2Data.push(e.readFloat())}}i.faces=e.readInt();for(var u=0;u<i.faces;u++){i.vertexIndices.push(e.readUnsignedShort());i.vertexIndices.push(e.readUnsignedShort());i.vertexIndices.push(e.readUnsignedShort());if(a&t.VertexFormat.VF_NORMAL){i.normalIndices.push(e.readUnsignedShort());i.normalIndices.push(e.readUnsignedShort());i.normalIndices.push(e.readUnsignedShort())}if(a&t.VertexFormat.VF_COLOR){i.colorIndices.push(e.readUnsignedShort());i.colorIndices.push(e.readUnsignedShort());i.colorIndices.push(e.readUnsignedShort())}if(a&t.VertexFormat.VF_UV0){i.uvIndices.push(e.readUnsignedShort());i.uvIndices.push(e.readUnsignedShort());i.uvIndices.push(e.readUnsignedShort())}if(a&t.VertexFormat.VF_UV1){i.uv2Indices.push(e.readUnsignedShort());i.uv2Indices.push(e.readUnsignedShort());i.uv2Indices.push(e.readUnsignedShort())}}var c=e.readUnsignedByte();if(c>0){i.skeleton=new t.Skeleton}var f=new t.Quaternion;var d=new t.Vector3D;var p=new t.Vector3D;var _=new t.Vector3D;for(var u=0;u<c;++u){var m=new t.Joint;e.readInt();m.parentIndex=e.readInt();m.name=e.readUTF();f.x=e.readFloat();f.y=e.readFloat();f.z=e.readFloat();f.w=e.readFloat();p.x=e.readFloat();p.y=e.readFloat();p.z=e.readFloat();_.x=e.readFloat();_.y=e.readFloat();_.z=e.readFloat();m.buildInverseMatrix(p,f,_);i.skeleton.joints.push(m)}var v=e.readInt();for(var u=0;u<v;u++){var g=e.readUnsignedByte();for(var y=0;y<g;y++){i.source_skinData.push(e.readUnsignedByte());i.source_skinData.push(e.readFloat())}for(var y=g;y<4;y++){i.source_skinData.push(0);i.source_skinData.push(0)}}};e.parserVersion_4=function(e,i,r){var a=e.readInt();i.matCount=e.readInt();var n=0;var o=0;var s=0;var h=0;for(var u=0;u<i.matCount;++u){i.material[u]={};i.material[u].matID=e.readInt();i.material[u].start=e.readInt();i.material[u].count=e.readInt();i.material[u].textureDiffuse=e.readUTF();i.material[u].textureNormal=e.readUTF();i.material[u].textureSpecular=e.readUTF()}if(a&t.VertexFormat.VF_POSITION){var l=e.readInt();for(var u=0;u<l;u++){i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat())}}if(a&t.VertexFormat.VF_NORMAL){n=e.readInt();for(var u=0;u<n;u++){i.source_normalData.push(e.readFloat());i.source_normalData.push(e.readFloat());i.source_normalData.push(e.readFloat())}}if(a&t.VertexFormat.VF_COLOR){o=e.readInt();for(var u=0;u<o;u++){i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255)}}if(a&t.VertexFormat.VF_UV0){s=e.readInt();for(var u=0;u<s;u++){i.source_uvData.push(e.readFloat());i.source_uvData.push(e.readFloat())}}if(a&t.VertexFormat.VF_UV1){h=e.readInt();for(var u=0;u<h;u++){i.source_uv2Data.push(e.readFloat());i.source_uv2Data.push(e.readFloat())}}i.faces=e.readInt();for(var u=0;u<i.faces;u++){i.vertexIndices.push(e.readUnsignedShort());i.vertexIndices.push(e.readUnsignedShort());i.vertexIndices.push(e.readUnsignedShort());if(n>0){if(a&t.VertexFormat.VF_NORMAL){i.normalIndices.push(e.readUnsignedShort());i.normalIndices.push(e.readUnsignedShort());i.normalIndices.push(e.readUnsignedShort())}}if(o>0){if(a&t.VertexFormat.VF_COLOR){i.colorIndices.push(e.readUnsignedShort());i.colorIndices.push(e.readUnsignedShort());i.colorIndices.push(e.readUnsignedShort())}}if(s>0){if(a&t.VertexFormat.VF_UV0){i.uvIndices.push(e.readUnsignedShort());i.uvIndices.push(e.readUnsignedShort());i.uvIndices.push(e.readUnsignedShort())}}if(h>0){if(a&t.VertexFormat.VF_UV1){i.uv2Indices.push(e.readUnsignedShort());i.uv2Indices.push(e.readUnsignedShort());i.uv2Indices.push(e.readUnsignedShort())}}}var c=e.readUnsignedByte();if(c>0){i.skeleton=new t.Skeleton}var f=new t.Quaternion;var d=new t.Vector3D;var p=new t.Vector3D;var _=new t.Vector3D;for(var u=0;u<c;++u){var m=new t.Joint;e.readInt();m.parentIndex=e.readInt();m.name=e.readUTF();f.x=e.readFloat();f.y=e.readFloat();f.z=e.readFloat();f.w=e.readFloat();p.x=e.readFloat();p.y=e.readFloat();p.z=e.readFloat();_.x=e.readFloat();_.y=e.readFloat();_.z=e.readFloat();m.buildInverseMatrix(p,f,_);i.skeleton.joints.push(m)}var v=e.readInt();for(var u=0;u<v;u++){var g=e.readUnsignedByte();for(var y=0;y<g;y++){i.source_skinData.push(e.readUnsignedByte());i.source_skinData.push(e.readFloat())}for(var y=g;y<4;y++){i.source_skinData.push(0);i.source_skinData.push(0)}}};e.parserVersion_5=function(e,i,r){var a=e.readInt();i.matCount=e.readInt();var n=0;var o=0;var s=0;var h=0;for(var u=0;u<i.matCount;++u){i.material[u]={};i.material[u].matID=e.readInt();i.material[u].start=e.readInt();i.material[u].count=e.readInt();i.material[u].textureDiffuse=e.readUTF();i.material[u].textureNormal=e.readUTF();i.material[u].textureSpecular=e.readUTF()}if(a&t.VertexFormat.VF_POSITION){var l=e.readInt();for(var u=0;u<l;u++){i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat());i.source_vertexData.push(e.readFloat())}}if(a&t.VertexFormat.VF_NORMAL){n=e.readInt();for(var u=0;u<n;u++){i.source_normalData.push(e.readByte()/125);i.source_normalData.push(e.readByte()/125);i.source_normalData.push(e.readByte()/125)}}if(a&t.VertexFormat.VF_COLOR){o=e.readInt();for(var u=0;u<o;u++){i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255);i.source_vertexColorData.push(e.readUnsignedByte()/255)}}if(a&t.VertexFormat.VF_UV0){s=e.readInt();for(var u=0;u<s;u++){i.source_uvData.push(e.readFloat());i.source_uvData.push(e.readFloat())}}if(a&t.VertexFormat.VF_UV1){h=e.readInt();for(var u=0;u<h;u++){i.source_uv2Data.push(e.readFloat());i.source_uv2Data.push(e.readFloat())}}i.faces=e.readInt();for(var u=0;u<i.faces;u++){var c=e.readUnsignedShort();var f=e.readUnsignedShort();var d=e.readUnsignedShort();i.vertexIndices.push(c);i.vertexIndices.push(f);i.vertexIndices.push(d);if(n>0){if(a&t.VertexFormat.VF_NORMAL){i.normalIndices.push(c);i.normalIndices.push(f);i.normalIndices.push(d)}}if(o>0){if(a&t.VertexFormat.VF_COLOR){i.colorIndices.push(c);i.colorIndices.push(f);i.colorIndices.push(d)}}if(s>0){if(a&t.VertexFormat.VF_UV0){i.uvIndices.push(c);i.uvIndices.push(f);i.uvIndices.push(d)}}if(h>0){if(a&t.VertexFormat.VF_UV1){i.uv2Indices.push(c);i.uv2Indices.push(f);i.uv2Indices.push(d)}}}var p=e.readUnsignedByte();if(p>0){i.skeleton=new t.Skeleton}var _=new t.Quaternion;var m=new t.Vector3D;var v=new t.Vector3D;var g=new t.Vector3D;for(var u=0;u<p;++u){var y=new t.Joint;e.readInt();y.parentIndex=e.readInt();y.name=e.readUTF();_.x=e.readFloat();_.y=e.readFloat();_.z=e.readFloat();_.w=e.readFloat();v.x=e.readFloat();v.y=e.readFloat();v.z=e.readFloat();g.x=e.readFloat();g.y=e.readFloat();g.z=e.readFloat();y.buildInverseMatrix(v,_,g);i.skeleton.joints.push(y)}var x=e.readInt();for(var u=0;u<x;u++){var b=e.readUnsignedByte();for(var D=0;D<b;D++){i.source_skinData.push(e.readUnsignedByte());i.source_skinData.push(e.readFloat())}for(var D=b;D<4;D++){i.source_skinData.push(0);i.source_skinData.push(0)}}};e.versionDictionary={1:function(t,i,r){return e.parserVersion_1(t,i,r)},2:function(t,i,r){return e.parserVersion_2(t,i,r)},3:function(t,i,r){return e.parserVersion_3(t,i,r)},4:function(t,i,r){return e.parserVersion_4(t,i,r)},5:function(t,i,r){return e.parserVersion_5(t,i,r)}};return e}();t.ESMVersion=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e,i){var r=new t.ByteArray(e);var a=r.readByte();if(a==1){var n=r.readInt();var o=new t.ByteArray;r.readBytes(o,0,n);o.uncompress();r=o}var s=new t.ByteArray;r.readBytes(s,0,7);var h=r.readUnsignedShort();if(!t.E3dPackVersion.versionDictionary[h]){console.log("egret3d engine not found "+h+" version");return null}var u=i.replace(".e3dPack","/");return t.E3dPackVersion.versionDictionary[h](r,u)};return e}();t.E3dPackParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parserVersion_1=function(e,i){var r={};var a=e.readUTF();var n=e.readUnsignedShort();for(var o=0;o<n;o++){var s=e.readUTF();var h=e.readUnsignedInt();var u=new t.ByteArray;e.readBytes(u,0,h);r[s]=u;var l=i+s;t.assetMgr.addByteArray(l,u,i)}return r};e.versionDictionary={1:function(t,i){return e.parserVersion_1(t,i)}};return e}();t.E3dPackVersion=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e){var i=new t.ByteArray(e);if(i.readUnsignedInt()!=1701863680){return null}var r=i.readUnsignedInt();if(!t.EPAVersion.versionDictionary[r]){console.log("egret3d engine not found "+r+" version");return null}return t.EPAVersion.versionDictionary[r](i)};return e}();t.EPAParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parserVersion_1=function(i){var r=new t.PropertyAnim;var a=i.readUnsignedShort();for(var n=0;n<a;n++){var o=i.readUTF();var s=[];var h=i.readUnsignedShort();for(var u=0;u<h;u++){var l=new t.AnimCurve;l.type=i.readUnsignedInt();if(l.type&e.VALUE_TYPE_UINT){l.frame=i.readFloat();l.frame=Math.floor(l.frame/16);l.value=i.readUnsignedInt();i.readFloat();i.readUnsignedInt();i.readFloat();i.readFloat();i.readFloat();i.readFloat()}else{l.frame=i.readFloat();l.frame=Math.floor(l.frame/16);l.value=i.readFloat();i.readFloat();i.readFloat();i.readFloat();i.readFloat();i.readFloat();i.readFloat()}s.push(l)}r.addAnimCurve(o,s)}return r};e.parserVersion_2=function(i){var r=new t.PropertyAnim;var a=i.readFloat();var n=i.readUnsignedByte();var o=i.readUnsignedShort();for(var s=0;s<o;s++){var h=i.readUTF();var u=[];var l=i.readUnsignedShort();for(var c=0;c<l;c++){var f=new t.AnimCurve;f.type=i.readUnsignedInt();if(f.type&e.VALUE_TYPE_UINT){f.frame=i.readFloat();f.frame=Math.floor(f.frame/16);f.value=i.readUnsignedInt();i.readFloat();i.readUnsignedInt();i.readFloat();i.readFloat();i.readFloat();i.readFloat()}else{f.frame=i.readFloat();f.frame=Math.floor(f.frame/16);f.value=i.readFloat();i.readFloat();i.readFloat();i.readFloat();i.readFloat();i.readFloat();i.readFloat()}u.push(f)}r.addAnimCurve(h,u)}return r};e.versionDictionary={1:function(t){return e.parserVersion_1(t)},2:function(t){return e.parserVersion_2(t)}};e.VALUE_TYPE_UINT=1073741824;return e}();t.EPAVersion=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parse=function(e){var i=new t.ByteArray(e);var r=new t.ByteArray;i.readBytes(r,0,3);var a=i.readUnsignedShort();if(!t.EUMVersion.versionDictionary[a]){console.log("egret3d engine not found "+a+" version");return null}t.EUMVersion.versionValue=a;return t.EUMVersion.versionDictionary[a](i)};return e}();t.EUMParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parserVersion_1=function(e){var i={};var r=e.readUnsignedInt();for(var a=0;a<r;a++){var n=e.readUnsignedInt();var o=e.readUnsignedInt();var s=new t.ByteArray;e.readBytes(s,0,o);i[n]=s}return i};e.parserVersion_2=function(e){var i={};var r=e.readUnsignedInt();for(var a=0;a<r;a++){var n=e.readUnsignedInt();var o=e.readUnsignedInt();var s=new t.ByteArray;e.readBytes(s,0,o);i[n]=s}return i};e.fillGeometryUv2=function(t,i,r){switch(e.versionValue){case 1:return e.fillGeometryUv2_1(t,i,r);case 2:return e.fillGeometryUv2_2(t,i,r);default:return null}};e.fillGeometryUv2_1=function(e,i,r){if(!i||!i[e]){return}var a=i[e];a.position=0;var n=[];var o=a.readUnsignedInt();for(var s=0;s<o;s++){n.push(a.readFloat());n.push(a.readFloat())}var h=0;var u=a.readUnsignedInt();for(var s=0;s<u;s++){for(var l=0;l<3;++l){h=s*3+l;var c=a.readUnsignedShort();var f=n[c*t.Geometry.uv2Size+0];var d=n[c*t.Geometry.uv2Size+1];r.setVerticesForIndex(h,t.VertexFormat.VF_UV1,[f,d])}}};e.fillGeometryUv2_2=function(e,i,r){if(!i||!i[e]){return}var a=i[e];a.position=0;var n=a.readFloat();var o=a.readFloat();var s=a.readFloat();var h=a.readFloat();var u=0;var l=r.faceCount;for(var c=0;c<l;c++){for(var f=0;f<3;++f){u=c*3+f;var d=r.getVertexForIndex(u,t.VertexFormat.VF_UV1);var p=d[0]*n+s;var _=1-(d[1]*o+h);r.setVerticesForIndex(u,t.VertexFormat.VF_UV1,[p,_])}}};e.versionDictionary={1:function(t){return e.parserVersion_1(t)},2:function(t){return e.parserVersion_2(t)}};return e}();t.EUMVersion=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.parse=function(t){var e=null;if(!window["DOMParser"]&&window["ActiveXObject"]){var i=["MSXML.2.DOMDocument.6.0","MSXML.2.DOMDocument.3.0","Microsoft.XMLDOM"];for(var r=0;r<i.length;r++){try{e=new ActiveXObject(i[r]);e.async=false;e.loadXML(t);break}catch(t){}}}else if(window["DOMParser"]&&document.implementation&&document.implementation.createDocument){try{var a=new DOMParser;e=a.parseFromString(t,"text/xml")}catch(t){}}else{return null}return e};t.eachXmlAttr=function(t,e){if(t==null||e==null)return;var i;for(var r=0,a=t.attributes.length;r<a;r++){i=t.attributes[r];e(i.name,i.value)}};return t}();t.XMLParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.parserType=function(e,i){switch(i){case"xml":break;case"json":if(e.type){return e.type}if(e.meta){if(e.meta.smartupdate){e.meta.smartupdate.indexOf(t.IConfigParser.TYPE_TEXTUREPACKER);return t.IConfigParser.TYPE_TEXTUREPACKER}}if(e.property&&e.emission&&e.life){return t.IConfigParser.TYPE_PARTICLE}return""}return""};e.parserConfig=function(i,r){var a=e.parserType(i,r);switch(a){case t.IConfigParser.TYPE_SCENE:case t.IConfigParser.TYPE_SKIN_MESH:case t.IConfigParser.TYPE_EFFECT_GROUP:return new t.UnitConfigParser(i,r,a);case t.IConfigParser.TYPE_PARTICLE:return new t.ParticleParser(i,r,a);case t.IConfigParser.TYPE_TEXTUREPACKER:return new t.TexturePackerParser(i,r,a)}return null};e.mapParser=function(e,i,r){var a;switch(e){case"xml":a=new t.UnitXmlParser(i,r);break;case"json":a=new t.UnitJsonParser(i,r);break}if(a){a.parser()}};e.particleParser=function(e,i){return new t.ParticleParser(i,e).data};e.jsonVersion=function(e,i,r){var a;switch(e){case 1:a=new t.UnitJsonParser_1(i,r);break;default:a=new t.UnitJsonParser_1(i,r);break}return a};e.xmlVersion=function(e,i,r){var a;switch(e){case 1:a=new t.UnitXmlParser_1(i,r);break}return a};e.binVersion=function(t,e,i){return null};return e}();t.UnitParserUtils=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.doMethod=function(e,i,r){var a=t.CheckerboardTexture.texture;var n=null;switch(i.type){case t.UnitMatMethodData.methodType.lightmapMethod:var o=new t.LightmapMethod(i.usePower);n=o;e.diffusePass.addMethod(o);o.lightTexture=a;var s=i.texturesData[0];r.addMethodImgTask(s.path,o,s.attributeName);break;case t.UnitMatMethodData.methodType.uvRollMethod:var h=new t.UVRollMethod;n=h;e.diffusePass.addMethod(h);h.speedU=i.uSpeed;h.speedV=i.vSpeed;e.repeat=true;break;case t.UnitMatMethodData.methodType.uvSpriteSheetMethod:var u=new t.UVSpriteSheetMethod(i.frameNum,i.row,i.col,i.totalTime);n=u;e.diffusePass.addMethod(u);u.isLoop=i.loop;u.delayTime=i.delayTime;break;case t.UnitMatMethodData.methodType.mulUvRollMethod:var l=new t.MulUVRollMethod;n=l;e.diffusePass.addMethod(l);l.diffuseTexture1=a;l.setSpeedU(0,i.uSpeed);l.setSpeedV(0,i.vSpeed);var s=i.texturesData[0];l.setSpeedU(1,s.uSpeed);l.setSpeedV(1,s.vSpeed);r.addMethodImgTask(s.path,l,s.attributeName);e.repeat=true;break;case t.UnitMatMethodData.methodType.alphaMaskMethod:var c=new t.AlphaMaskMethod;n=c;e.diffusePass.addMethod(c);c.maskTexture=a;var s=i.texturesData[0];r.addMethodImgTask(s.path,c,s.attributeName);break;case t.UnitMatMethodData.methodType.streamerMethod:var f=new t.StreamerMethod;n=f;e.diffusePass.addMethod(f);f.steamerTexture=a;var s=i.texturesData[0];r.addMethodImgTask(s.path,f,s.attributeName);f.speedU=i.uSpeed;f.speedV=i.vSpeed;break;case t.UnitMatMethodData.methodType.terrainARGBMethod:var d=new t.TerrainARGBMethod(a,a,a,a,a);n=d;e.diffusePass.addMethod(d);var s=null;for(var p=0;p<i.texturesData.length;++p){s=i.texturesData[p];r.addMethodImgTask(s.path,d,s.attributeName);if(p!=0){d.setUVTitling(p-1,Number(s.uvTitlingX),Number(s.uvTitlingY))}}break;case t.UnitMatMethodData.methodType.waterWaveMethod:var _=new t.WaterWaveMethod;n=_;e.diffusePass.addMethod(_);if(i["deepWaterColor"]){_.deepWaterColor=Number(i["deepWaterColor"])}if(i["shallowWaterColor"]){_.shallowWaterColor=Number(i["shallowWaterColor"])}e.repeat=true;break;case t.UnitMatMethodData.methodType.waterNormalMethod:var m=new t.WaterNormalMethod;n=m;e.diffusePass.addMethod(m);m.normalTextureA=a;m.normalTextureB=a;if(i["uScale"]&&i["vScale"]){m.setUvScale(Number(i["uScale"]),Number(i["vScale"]))}var s=null;for(var p=0;p<i.texturesData.length;++p){s=i.texturesData[p];m.setUvSpeed(p,Number(s.uSpeed),Number(s.vSpeed));r.addMethodImgTask(s.path,m,s.attributeName)}break}if(i.play){if(n["start"]){r.addAutoAnimation(n)}}};return e}();t.MethodUtils=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t,e){this._data=t;this._mapConfigParser=e;this._versionParser=null}t.prototype.parser=function(){};t.prototype.parseTexture=function(t){};t.prototype.parseMethod=function(t){return null};t.prototype.parseMat=function(t){return null};t.prototype.parseNode=function(t){return null};t.prototype.parseEnvironment=function(t){};t.prototype.parseHud=function(t){return null};t.prototype.parseLight=function(t){return null};return t}();t.UnitParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i){t.call(this,e,i)}return e}(t.UnitParser);t.UnitBinParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i){e.call(this,t,i);this._mapConfigParser.version=Number(t.version);this._mapConfigParser.engineVersion=String(t.egret3DVersion)}i.prototype.parser=function(){if(this._mapConfigParser.engineVersion==undefined){console.log("the resource engine Version is old , but the current engine Version is "+t.Egret3DPolicy.engineVersion)}if(this._mapConfigParser.engineVersion!=t.Egret3DPolicy.engineVersion){console.log("the resource engine Version is "+this._mapConfigParser.engineVersion+", but the current engine Version is "+t.Egret3DPolicy.engineVersion)}this._versionParser=t.UnitParserUtils.jsonVersion(this._mapConfigParser.version,this._data,this._mapConfigParser);this._versionParser.parseEnvironment(this._data.env);if(this._data.auto){this._mapConfigParser.auto=this._data.auto=="true"?true:false}if(this._data.loop){this._mapConfigParser.loop=this._data.loop=="true"?true:false}if(this._data.uv2){this._mapConfigParser.uv2=this._data.uv2}this._mapConfigParser.calculateTask();if(this._data.propertyAnimations){for(var e=0;e<this._data.propertyAnimations.length;e++){var i=this._data.propertyAnimations[e];var r=Number(i.id);if(i){this._mapConfigParser.proAnimationDict[r]=i;this._mapConfigParser.calculateProAnimationTask(i)}}}if(this._data.skeletonAnimations){for(var e=0;e<this._data.skeletonAnimations.length;e++){var a=this._data.skeletonAnimations[e];var r=Number(a.id);if(a){this._mapConfigParser.skeletonAnimationDict[r]=a;this._mapConfigParser.calculateSkeletonAnimationTask(a)}}}if(this._data.mats){for(var e=0;e<this._data.mats.length;e++){var n=this._versionParser.parseMat(this._data.mats[e]);if(n){this._mapConfigParser.matDict[n.id]=n;this._mapConfigParser.calculateMatTask(n)}}}if(this._data.nodes){for(var e=0;e<this._data.nodes.length;e++){var o=this._versionParser.parseNode(this._data.nodes[e]);if(o){this._mapConfigParser.nodeList.push(o);this._mapConfigParser.calculateNodeTask(o)}}}if(this._data.textures){for(var e=0;e<this._data.textures.length;e++){this._versionParser.parseTexture(this._data.textures[e])}}if(this._data.huds){for(var e=0;e<this._data.huds.length;e++){var s=this._versionParser.parseHud(this._data.huds[e]);if(s){this._mapConfigParser.hudList.push(s);this._mapConfigParser.calculateHudTask(s)}}}};return i}(t.UnitParser);t.UnitJsonParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.apply(this,arguments)}i.prototype.parseMethod=function(e){var i=[];var r;for(var a in e){r=new t.UnitMatMethodData;r.type=a;var n=e[a];for(var o in n){if(o=="textures"){for(var s in n.textures){var h={};for(var u in n.textures[s]){h[u]=n.textures[s][u]}r.texturesData.push(h)}}else{var l=typeof r[o];if(l=="string"){r[o]=n[o]}else if(l=="number"){r[o]=Number(n[o])}else if(l=="boolean"){r[o]=n[o]=="true"?true:false}else{r[o]=n[o]}}}i.push(r)}return i};i.prototype.parseMat=function(e){var i=new t.UnitMatSphereData;for(var r in e){switch(r){case"uvRectangle":i.uvRectangle.x=Number(e.uvRectangle.x);i.uvRectangle.y=Number(e.uvRectangle.y);i.uvRectangle.width=Number(e.uvRectangle.width);i.uvRectangle.height=Number(e.uvRectangle.height);break;case"methods":i.methods=this.parseMethod(e.methods);break;case"blendMode":i[r]=t.BlendMode[e[r]];break;case"lightIds":var a=e[r].split(",");for(var n=0;n<a.length;++n){i.lightIds.push(Number(a[n]))}break;default:var o=typeof i[r];if(o=="number"){i[r]=Number(e[r])}else if(o=="boolean"){i[r]=e[r]=="true"}else if(o=="string"){i[r]=e[r]}break}}return i};i.prototype.parseNode=function(e){var i=new t.UnitNodeData;for(var r in e){if(r=="pos"||r=="rot"||r=="scale"){for(var a in e[r]){i[a]=Number(e[r][a])}}else if(r=="geometry"){for(var n in e[r]){if(n=="type"){i.geometry[n]=e[r][n]}else{i.geometry[n]=Number(e[r][n])}}}else if(r=="skinClips"){for(var o=0;o<e.skinClips.length;++o){i.skinClips.push(e.skinClips[o])}}else if(r=="propertyAnims"){for(var o=0;o<e.propertyAnims.length;++o){i.propertyAnims.push(e.propertyAnims[o])}}else if(r=="grass"){for(var o=0;o<e.grass.length;++o){i.grass.push(e.grass[o])}}else if(r=="mats"){i.materialIDs=(e[r]+"").split(",")}else if(r=="subs"){for(var o=0;o<e.subs.length;++o){i.childs.push(e.subs[o])}}else if(r=="boneBind"){i.boneBind=e.boneBind}else if(r=="lightInfo"){i.lightData=this.parseLight(e.lightInfo)}else if(r=="lightIds"){i.lightIds=(e[r]+"").split(",")}else{var s=typeof i[r];if(s=="number"){i[r]=Number(e[r])}else if(s=="boolean"){i[r]=e[r]=="true"?true:false}else{i[r]=e[r]}}}return i};i.prototype.parseEnvironment=function(t){if(!t){return}if(t){this._mapConfigParser.isFogOpen=Boolean(t.isFogOpen);if(this._mapConfigParser.isFogOpen){this._mapConfigParser.fogColor=Number(t.fogColor);this._mapConfigParser.fogMode=String(t.fogMode);this._mapConfigParser.fogDensity=Number(t.fogDensity);this._mapConfigParser.linearFogStart=Number(t.linearFogStart);this._mapConfigParser.linearFogEnd=Number(t.linearFogEnd)}}if(t.directLight){this._mapConfigParser.directLight=t.directLight=="open"}if(t.pointLight){this._mapConfigParser.pointLight=t.pointLight=="open"}if(!t.lightList){return}for(var e=0;e<t.lightList.length;++e){var i=this.parseLight(t.lightList[e]);this._mapConfigParser.lightDict[i.id]=i}};i.prototype.parseHud=function(e){var i=new t.UnitHUDData;for(var r in e){if(r=="pos"||r=="rot"||r=="size"){for(var a in e[r]){i[a]=Number(e[r][a])}}else if(r=="bothside"){i[r]=e[r]=="true"}else{i[r]=e[r]}}return i};i.prototype.parseTexture=function(t){this._mapConfigParser.textures.push(t);this._mapConfigParser.calculateTextureTask(t)};i.prototype.parseLight=function(e){var i=new t.UnitLightData;for(var r in e){switch(r){case"id":case"diffuseColor":case"ambientColor":case"intensity":case"halfIntensity":case"falloff":case"radius":i[r]=Number(e[r]);break;case"type":i[r]=t.LightType[e.type];break;case"direction":i.direction.x=Number(e[r].x);i.direction.y=Number(e[r].y);i.direction.z=Number(e[r].z);break;case"position":i.position.x=Number(e[r].x);i.position.y=Number(e[r].y);i.position.z=Number(e[r].z);break}}return i};return i}(t.UnitJsonParser);t.UnitJsonParser_1=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t,i){e.call(this,t,i);var r=t.getElementsByTagName("version");this._mapConfigParser.version=Number(r[0].textContent)}i.prototype.parser=function(){this._versionParser=t.UnitParserUtils.xmlVersion(this._mapConfigParser.version,this._data,this._mapConfigParser);var e=this._data.getElementsByTagName("mat");var i=this._data.getElementsByTagName("node");var r=this._data.getElementsByTagName("env");var a=this._data.getElementsByTagName("cameraAnims");var n=this._data.getElementsByTagName("hud");var o=this._data.getElementsByTagName("texture");this.parseEnvironment(r);for(var s=0;s<e.length;s++){var h=this._versionParser.parseMat(e[s]);if(h){this._mapConfigParser.matDict[h.id]=h;this._mapConfigParser.calculateMatTask(h)}}for(var s=0;s<i.length;s++){var u=this._versionParser.parseNode(i[s]);if(u){this._mapConfigParser.nodeList.push(u);this._mapConfigParser.calculateNodeTask(u)}}for(var s=0;s<o.length;s++){this.parseTexture(o[s])}for(var s=0;s<n.length;s++){var l=this._versionParser.parseHud(n[s]);if(l){this._mapConfigParser.hudList.push(l);this._mapConfigParser.calculateHudTask(l)}}};i.prototype.nodeFilter=function(t){return t.nodeName=="#text"||t.nodeName=="#comment"};return i}(t.UnitParser);t.UnitXmlParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){
__extends(i,e);function i(){e.apply(this,arguments)}i.prototype.parseTexture=function(t){if(t.childNodes.length==1)return null;var e=null;var i;var r=0;var a=0;for(r=0,a=t.childNodes.length;r<a;r++){i=t.childNodes[r];if(this.nodeFilter(i))continue;var n={};for(var o=0;o<i.attributes.length;++o){e=i.attributes[o];n[e.name]=e.value}this._mapConfigParser.textures.push(n);this._mapConfigParser.calculateTextureTask(n)}};i.prototype.parseMethod=function(e){if(e.childNodes.length<=1)return null;var i=[];var r;var a;var n=0;var o;var s=null;for(var h=0,n=e.childNodes.length;h<n;h++){r=e.childNodes[h];a=r.nodeName;if(this.nodeFilter(r))continue;o=new t.UnitMatMethodData;o.type=a;for(var u=0;u<r.attributes.length;++u){s=r.attributes[u];var l=typeof o[s.name];if(l=="string"){o[s.name]=s.value}else if(l=="number"){o[s.name]=Number(s.value)}else if(l=="boolean"){o[s.name]=s.value=="true"?true:false}else{o[s.name]=s.value}}for(var u=0;u<r.childNodes.length;++u){var c=r.childNodes[u];if(this.nodeFilter(c)){continue}var f={};for(var d=0;d<c.attributes.length;++d){s=c.attributes[d];f[s.name]=s.value}o.texturesData.push(f)}i.push(o)}return i};i.prototype.parseMat=function(e){if(e.childNodes.length==0)return null;var i=new t.UnitMatSphereData;var r=null;for(var a=0;a<e.attributes.length;++a){r=e.attributes[a];i[r.name]=r.value}var n;var o;var s=0;for(var a=0,s=e.childNodes.length;a<s;a++){n=e.childNodes[a];o=n.nodeName;if(this.nodeFilter(n)){continue}if(o=="methods"){i.methods=this.parseMethod(n)}else if(o=="uvRectangle"){for(var h=0;h<n.attributes.length;++h){i.uvRectangle[n.attributes[h].name]=Number(n.attributes[h].value)}}else if(o=="blendMode"){i[n.nodeName]=t.BlendMode[n.textContent]}else if(o=="lightIds"){if(n.textContent){var u=n.textContent.split(",");for(var h=0;h<u.length;++h){i.lightIds.push(Number(u[h]))}}}else{var l=typeof i[n.nodeName];if(l=="string"){i[n.nodeName]=n.textContent}else if(l=="number"){i[n.nodeName]=Number(n.textContent)}else if(l=="boolean"){i[n.nodeName]=n.textContent=="true"?true:false}}}return i};i.prototype.parseNode=function(e){if(e.childNodes.length==1)return null;var i=null;var r=new t.UnitNodeData;for(var a=0;a<e.attributes.length;++a){i=e.attributes[a];var n=typeof r[i.name];if(n=="number"){r[i.name]=Number(i.value)}else if(n=="boolean"){r[i.name]=i.value=="true"?true:false}else{r[i.name]=i.value}}var o;var s;var a=0;var h=0;for(a=0,h=e.childNodes.length;a<h;a++){o=e.childNodes[a];s=o.nodeName;if(this.nodeFilter(o)){continue}if(s=="pos"){for(var u=0;u<o.attributes.length;++u){i=o.attributes[u];r[i.nodeName]=Number(i.value)}}else if(s=="rot"){for(var u=0;u<o.attributes.length;++u){i=o.attributes[u];r[i.nodeName]=Number(i.value)}}else if(s=="scale"){for(var u=0;u<o.attributes.length;++u){i=o.attributes[u];r[i.nodeName]=Number(i.value)}}else if(s=="mat"){for(var u=0;u<o.attributes.length;++u){i=o.attributes[u];if(i.nodeName=="id"){r.materialIDs=(i.value+"").split(",")}}}else if(s=="skinClip"){var l={};r.skinClips.push(l);for(var u=0;u<o.attributes.length;++u){i=o.attributes[u];l[i.nodeName]=i.value}}else if(s=="propertyAnim"){var c={};r.propertyAnims.push(c);for(var u=0;u<o.attributes.length;++u){i=o.attributes[u];c[i.nodeName]=i.value}}else if(s=="geometry"){var f={};for(var u=0;u<o.attributes.length;++u){i=o.attributes[u];if(i.name=="type"){f[i.name]=i.value}else{f[i.name]=Number(i.value)}}r.geometry=f}else if(s=="sub"){var d={};for(var u=0;u<o.attributes.length;++u){i=o.attributes[u];d[i.name]=i.value}r.childs.push(d)}}return r};i.prototype.parseEnvironment=function(e){if(e.length<=0){return}var i;var r;var a;var n=null;for(var o=0;o<e[0].attributes.length;++o){n=e[0].attributes[o];this._mapConfigParser[n.name]=n.value=="open"}for(var s=0,h=e.length;s<h;s++){i=e[s];for(var u=0;u<i.childNodes.length;++u){r=i.childNodes[u];if(this.nodeFilter(r))continue;if(r.nodeName=="light"){var l=new t.UnitLightData;for(var o=0;o<r.attributes.length;++o){n=r.attributes[o];if(n.name=="id"){l[n.name]=Number(n.value)}else{l[n.name]=n.value}}this._mapConfigParser.lightDict[l.id]=l;for(var o=0;o<r.childNodes.length;++o){a=r.childNodes[o];if(this.nodeFilter(a)){continue}if(a.nodeName=="direction"){for(var c=0;c<a.attributes.length;++c){n=a.attributes[c];l.direction[n.name]=Number(n.value)}}else if(a.nodeName=="position"){for(var c=0;c<a.attributes.length;++c){n=a.attributes[c];l.position[n.name]=Number(n.value)}}else if(a.nodeName=="type"){l.type=t.LightType[a.textContent]}else{l[a.nodeName]=Number(a.textContent)}}}else if(r.nodeName=="fog"){}}}};i.prototype.parseHud=function(e){if(e.childNodes.length==1)return null;var i=null;var r=new t.UnitHUDData;for(var a=0;a<e.attributes.length;++a){i=e.attributes[a];if(i.nodeName=="bothside"){r[i.nodeName]=i.value=="true"}else{r[i.nodeName]=i.value}}var n;var o;var a=0;var s=0;for(a=0,s=e.childNodes.length;a<s;a++){n=e.childNodes[a];o=n.nodeName;if(this.nodeFilter(n)){continue}for(var h=0;h<n.attributes.length;++h){i=n.attributes[h];if(o=="shader"){r[i.nodeName]=i.value}else{r[i.nodeName]=Number(i.value)}}}return r};return i}(t.UnitXmlParser);t.UnitXmlParser_1=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=null}e.call(this);this.container=null;this.loader=null;this.autoPlayAnimation=false;this._pathRoot="";this._configParser=null;this._mapParser=null;this._particleParser=null;this._texturePackerParser=null;this._taskCount=0;this._event=new t.LoaderEvent3D;this._type="";this._taskDict={};this._textures={};this.skinClipDict={};this.proAnimDict={};this.unitLoaderList=[];this._dictUnitLoader={};this._unitQueue=[];this.huds=[];this.lightDict={};this.autoAnimationList=[];this.continueProgressEvent=[];if(i){this.load(i)}}Object.defineProperty(i.prototype,"configParser",{get:function(){return this._configParser},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"pathRoot",{get:function(){return this._pathRoot},set:function(t){this._pathRoot=t},enumerable:true,configurable:true});i.prototype.addAutoAnimation=function(t,e,i,r,a){if(e===void 0){e=1}if(i===void 0){i=false}if(r===void 0){r=false}if(a===void 0){a=""}var n={};n.animation=t;n.speed=e;n.reset=i;n.prewarm=r;n.name=a;this.autoAnimationList.push(n)};i.prototype.getAssetURLLoader=function(e){return t.assetMgr.findAsset(e,this)};i.prototype.createObject=function(){return new t.Object3D};i.prototype.findTexture=function(t){return this._textures[t]};i.prototype.load=function(e){this.reset();this.resourceName=t.StringUtil.getURLName(e);this.url=e;this.pathRoot=t.StringUtil.getPath(e);this._type=t.StringUtil.getFileFormat(e);this.taskTotal++;this._taskDict[this.url]={};this._taskDict[this.url].status=1;this._taskDict[this.url].currentProgress=0;if(this._type==t.ILoader.DATAFORMAT_E3DPACK){this.loader=this.doAssetLoader(this.url,this.onE3dPack);var i=this.pathRoot+"MapConfig.json";this.processUrlContinue(i)}else{this.loader=this.doAssetLoader(this.url,this.onConfigLoad)}this.processUrlContinue(e)};i.prototype.onE3dPack=function(e){var i=e.loader;this._type=t.ILoader.DATAFORMAT_JSON;this.pathRoot+=this.resourceName+"/";var r=this.pathRoot+"MapConfig.json";if(t.assetMgr.getByteArray(r)){this.taskTotal++;this._taskDict[r]={};this._taskDict[r].status=1;this._taskDict[r].currentProgress=0;this.doAssetLoader(r,this.onConfigLoad,this)}this.processTask(i)};i.prototype.processUrlContinue=function(e){var i=t.StringUtil.getFileFormat(e);if(i==t.ILoader.DATAFORMAT_E3DPACK){this.continueProgressEvent.push(e)}if(i==t.ILoader.DATAFORMAT_JSON){this.continueProgressEvent.push(e)}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this.reset();this.container=null};i.prototype.onProgress=function(e){var i=e.target;if(this._taskDict[i.url]){this._taskDict[i.url].currentProgress=i.currentProgress;this.currentProgress=this.calculateProgress();if(this.currentProgress<1){var r=e.loader;this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS;this._event.loader=r;this._event.data=r.data;this._event.currentProgress=this.currentProgress;this.dispatchEvent(this._event)}}};i.prototype.reset=function(){t.assetMgr.dispose(this);if(this.url){t.assetMgr.removeByteArray(this.url);t.textureResMgr.removeTexture(this.url);this.url=null}this.taskTotal=0;this.taskCurrent=0;this._taskCount=0;this._taskDict={};this._textures={};this.skinClipDict={};this.huds=[];this.lightDict={};this._mapParser=null;this._configParser=null;this._event.target=null;this._event.loader=null;this._event.data=null;for(var e=0;e<this.unitLoaderList.length;++e){this.unitLoaderList[e].dispose()}this.unitLoaderList.length=0;this._dictUnitLoader={};this._unitQueue.length=0;this._currentUnitLoader=null;this.continueProgressEvent.length=0};i.prototype.parseParticle=function(){this.data=this._particleParser.data;if(!this._particleParser.data.shape.meshFile&&!this._particleParser.data.property.meshFile){return}if(this._particleParser.data.shape.meshFile){var t=this._pathRoot+this._particleParser.data.shape.meshFile;var e={};e.particle=this._particleParser.data;e.type="shape";this.doAssetLoader(t,this.onParticleEsmLoad1,e)}if(this._particleParser.data.property.meshFile){var t=this._pathRoot+this._particleParser.data.property.meshFile;var e={};e.particle=this._particleParser.data;e.type="property";this.doAssetLoader(t,this.onParticleEsmLoad1,e)}};i.prototype.parseUnit=function(){this.processNode();this.processSkinClip();this.processProAnim();this.createLight();if(this._mapParser.uv2){var t=this.pathRoot+this._mapParser.uv2;this.doAssetLoader(t,this.onCompleteUv2)}else{this.onProcessNodeLoad()}};i.prototype.onCompleteUv2=function(t){var e=t.loader;this.uv2Dict=t.data;this.onProcessNodeLoad();this.processTask(e)};i.prototype.onProcessNodeLoad=function(){for(var e=0;e<this._mapParser.nodeList.length;e++){var i=this._mapParser.nodeList[e];if(!i.object3d.parent){this.container.addChild(i.object3d)}switch(i.type){case"Object3D":case"Camera3D":case"DirectLight":case"PointLight":this.doLoadEpa(i);break;case"CubeSky":case"SphereSky":case"Mesh":if(i.path){var r=this._pathRoot+i.path;this.doAssetLoader(r,this.onEsmLoad,i)}else if(i.geometry){this.processMesh(i,t.GeometryUtil.createGemetryForType(i.geometry.type,i.geometry))}break;case"Terrain":if(i.path){var r=this._pathRoot+i.path;this.doAssetLoader(r,this.onHeightImg,i)}break;case"ParticleEmitter":if(i.path){var r=this._pathRoot+i.path;var a=this.doUnitLoader(r,this.onUnitLoader,i);if(this._configParser.version==1){a.pathRoot=this._pathRoot}}break;case"EffectGroup":if(i.path){var r=this._pathRoot+i.path;this.doUnitLoader(r,this.onUnitLoader,i)}break}}for(var e=0;e<this._mapParser.textures.length;++e){var n=this._mapParser.textures[e];var r=this._pathRoot+n.path;this.doAssetLoader(r,this.onTexture,n.name)}for(var e=0;e<this._mapParser.hudList.length;++e){var o=this._mapParser.hudList[e];var s=new t.HUD;s.name=o.name;s.bothside=o.bothside;s.x=o.x;s.y=o.y;s.rotationX=o.rx;s.rotationY=o.ry;s.rotationZ=o.rz;s.width=o.width;s.height=o.height;if(o.vs){s.vsShader=o.vs}if(o.fs){s.fsShader=o.fs}this.huds.push(s);o.hud=s;if(!o.texture){continue}var r=this._pathRoot+o.texture;this.doAssetLoader(r,this.onHudTexture,o)}};i.prototype.parseTexturePacker=function(){if(this._texturePackerParser.data.meta&&this._texturePackerParser.data.meta.image){var t=this._pathRoot+this._texturePackerParser.data.meta.image;this.doAssetLoader(t,this.onTexturePackerLoad)}};i.prototype.onTexturePackerLoad=function(e){var i=e.loader;this.data=i.data;t.textureResMgr.addTexture(this.url,this._texturePackerParser.data,i.data);this.processTask(i)};i.prototype.parseConfig=function(e,i){this._configParser=t.UnitParserUtils.parserConfig(e,i);if(!this._configParser){return false}var r="";for(var a in this._configParser.taskDict){this.taskTotal++;r=this._pathRoot+a;this._taskDict[r]={};this._taskDict[r].status=1;this._taskDict[r].currentProgress=0}switch(this._configParser.type){case t.IConfigParser.TYPE_SCENE:this._mapParser=this._configParser;this.container=this.container||new t.Scene3D;this.parseUnit();break;case t.IConfigParser.TYPE_SKIN_MESH:this.container=this.container||new t.Role;this._mapParser=this._configParser;this.parseUnit();break;case t.IConfigParser.TYPE_EFFECT_GROUP:this.container=this.container||new t.EffectGroup;this._mapParser=this._configParser;this.parseUnit();break;case t.IConfigParser.TYPE_PARTICLE:this._particleParser=this._configParser;this.parseParticle();break;case t.IConfigParser.TYPE_TEXTUREPACKER:this._texturePackerParser=this._configParser;this.parseTexturePacker();break;default:return false}if(this.container){this.data=this.container}return true};i.prototype.processParticle=function(t,e){if(!t.shape.meshFile&&!t.property.meshFile){this.processParticleGeometry(t,e)}else{if(t.shape.meshFile){var i=this._pathRoot+t.shape.meshFile;var r={};r.particle=t;r.nodeData=e;r.type="shape";this.doAssetLoader(i,this.onParticleEsmLoad,r)}if(t.property.meshFile){var i=this._pathRoot+t.property.meshFile;var r={};r.particle=t;r.nodeData=e;r.type="property";this.doAssetLoader(i,this.onParticleEsmLoad,r)}}return null};i.prototype.processParticleGeometry=function(e,i){e.materialData=this._mapParser.matDict[i.materialIDs[0]];var r=new t.ParticleEmitter(e,new t.TextureMaterial);i.visible=t.Egret3DPolicy.useParticle;this.processObject3d(i,r);if(this.autoPlayAnimation||e.property.playOnAwake){this.addAutoAnimation(r,1,false,e.property.prewarm)}this.processMat(i)};i.prototype.processObject3d=function(t,e){e.name=t.object3d.name;e.visible=t.visible;e.position=t.object3d.position;e.orientation=t.object3d.orientation;e.scale=t.object3d.scale;if(t.tagName!=""){e.tag.name=t.object3d.tag.name}t.object3d.swapObject(e);t.object3d=e};i.prototype.onConfigLoad=function(e){var i=e.loader;switch(this._type){case t.ILoader.DATAFORMAT_XML:case t.ILoader.DATAFORMAT_JSON:if(!this.parseConfig(i.data,this._type)){this.data=i.data}break;default:this.data=i.data;break}this.processTask(i)};i.prototype.onHeightImg=function(e){var i=e.loader;var r=e.param;var a=r.geometry;var n=new t.Terrain(i.data,a.width,a.height,a.depth,a.segmentsW,a.segmentsH,false,new t.TextureMaterial(i.data));this.processHeightMesh(r,n);var o=r.grass;if(o){for(var s=0;s<o.length;++s){var h=o[s];var u=this._pathRoot+h.detailTexture;var l={};l.grassData=h;l.mapNodeData=r;this.doAssetLoader(u,this.onGrassDetailTexture,l)}}this.processTask(i)};i.prototype.doAssetLoader=function(e,i,r){if(r===void 0){r=null}this.addTask();var a=t.assetMgr.loadAsset(e,i,this,r);t.assetMgr.addEventListener(e,t.LoaderEvent3D.LOADER_PROGRESS,this.onProgress,this);return a};i.prototype.doUnitLoader=function(e,r,a){var n=this;if(a===void 0){a=null}this.addTask();var o=this._dictUnitLoader[e];if(!o){o={pathRoot:null,loader:new i};this._dictUnitLoader[e]=o;o.loader.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onUnitComplete,this,a);this.unitLoaderList.push(o.loader);this._unitQueue.push(e);if(!this._currentUnitLoader){this._currentUnitLoader=o.loader;this._currentUnitLoader.load(e)}}if(o.loader.data){setTimeout(function(){if(r){var e=new t.LoaderEvent3D;e.eventType=t.LoaderEvent3D.LOADER_COMPLETE;e.target=o.loader;e.loader=o.loader;e.data=o.loader.data;e.param=a;r.call(n,e)}},0)}else{o.loader.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,r,this,a);o.loader.addEventListener(t.LoaderEvent3D.LOADER_PROGRESS,this.onProgress,this)}return o};i.prototype.onUnitComplete=function(t){this._unitQueue.shift();if(this._unitQueue.length>0){var e=this._unitQueue[0];var i=this._dictUnitLoader[e];this._currentUnitLoader=i.loader;this._currentUnitLoader.load(e);if(i.pathRoot){this._currentUnitLoader.pathRoot=i.pathRoot}}else{this._currentUnitLoader=null}};i.prototype.onTexture=function(t){var e=t.loader;var i=t.param;this._textures[i]=e.data;this.processTask(e)};i.prototype.onHudTexture=function(t){var e=t.loader;var i=t.param;i.hud.diffuseTexture=e.data;this.processTask(e)};i.prototype.onMaterialTexture=function(t){var e=t.loader;var i=t.param;var r=null;var a=null;var n=i.mapNodeData;r=n.object3d;a=r.getMaterial(i.matID);a[i.type]=e.data;this.processTask(e)};i.prototype.onMethodTexture=function(t){var e=t.loader;var i=t.param;i.method[i.textureName]=e.data;this.processTask(e)};i.prototype.onGrassDetailTexture=function(e){var i=e.loader;var r=e.param;var a=r.grassData;var n=r.mapNodeData;var o=n.object3d;var s=this.getGrassPositions(o,i.data);if(s.length>0){var h=new t.TextureMaterial;h.ambientColor=16777215;h.blendMode=t.BlendMode.NORMAL;h.cutAlpha=.4;var u=new t.Rectangle(o.x,o.z,o.x*2,o.z*2);var l=new t.GrassMesh(s,h,a);l.method.setLightMapData(t.CheckerboardTexture.texture,u);o.addChild(l);o.x;o.y;var c=r.grassData;if(c.grassTexture){var f=this._pathRoot+c.grassTexture;this.doAssetLoader(f,this.onGrassDiffuseTexture,l.material)}}this.processTask(i)};i.prototype.getGrassPositions=function(t,e){var i=t.geometry;var r=e.readPixels(0,0,e.width,e.height);var a=r.width;var n=r.height;var o;var s;var h=1/16;var u=[];var l;var c;var f;for(var d=0;d<n;d++){for(var p=0;p<a;p++){s=d*a+p;s*=4;o=r.data[s]*h;o=Math.round(o);if(o>0){for(var _=0;_<o;_++){c=p+Math.random()-.5;f=d+Math.random()-.5;if(c<0){c=0}else if(c>=a){c=a-.01}if(f<0){f=0}else if(f>=n){f-=.01}l=i.get3DCoordAtPixel(c,f,a,n);u.push(l)}}}}return u};i.prototype.onGrassDiffuseTexture=function(t){var e=t.loader;t.param.diffuseTexture=e.data;this.processTask(e)};i.prototype.doLoadEpa=function(e){if(e.propertyAnims){for(var i=0;i<e.propertyAnims.length;++i){if(!e.object3d.proAnimation){e.object3d.proAnimation=new t.PropertyAnimController(e.object3d)}var r=e.propertyAnims[i];var a=this._pathRoot+r["path"];this.doAssetLoader(a,this.onEpaLoad,e)}}var n=this.proAnimDict[e.propertyAnimsId];if(n){e.object3d.proAnimation=n}};i.prototype.processEpa=function(t,e){t.object3d.proAnimation.propertyAnimController.addPropertyAnim(e);if(this.autoPlayAnimation){if(t.object3d.proAnimation){this.addAutoAnimation(t.object3d.proAnimation)}}};i.prototype.processHeightMesh=function(t,e){this.processObject3d(t,e);this.processMat(t);this.doLoadEpa(t)};i.prototype.processMesh=function(e,i){var r=this.skinClipDict[e.skeletonAnimation];var a=null;if(e.type=="Mesh"){a=new t.Mesh(i,new t.TextureMaterial,r)}else if(e.type=="CubeSky"){a=new t.Sky(i,new t.CubeTextureMaterial)}else if(e.type=="SphereSky"){a=new t.Sky(i,new t.TextureMaterial)}t.EUMVersion.fillGeometryUv2(e.uv2Id,this.uv2Dict,a.geometry);this.processObject3d(e,a);this.processMat(e);for(var n=0;n<e.skinClips.length;n++){var o=e.skinClips[n];var s=this._pathRoot+o["path"];var h={};h.eamData=o;h.mapNodeData=e;this.doAssetLoader(s,this.onEamLoad,h)}this.doLoadEpa(e)};i.prototype.onEsmLoad=function(e){var i=e.loader;var r=e.param;if(r){var a=i.data;if(this.uv2Dict&&this.uv2Dict[r.uv2Id]){a=new t.Geometry;a.copy(i.data)}this.processMesh(r,a)}this.processTask(i)};i.prototype.onParticleEsmLoad=function(t){var e=t.loader;var i=t.param;var r=i.particle;var a=i.nodeData;switch(i.type){case"shape":r.shape.geometry=e.data;break;case"property":r.property.geometry=e.data;break}var n=0;var o=0;if(r.shape.meshFile){n++}if(r.property.meshFile){n++}if(r.shape.geometry){o++}if(r.property.geometry){o++}if(o==n){this.processParticleGeometry(r,a)}this.processTask(e)};i.prototype.onParticleEsmLoad1=function(t){var e=t.loader;var i=t.param;var r=i.particle;switch(i.type){case"shape":r.shape.geometry=e.data;break;case"property":r.property.geometry=e.data;break}var a=0;var n=0;if(r.shape.meshFile){a++}if(r.property.meshFile){a++}if(r.shape.geometry){n++}if(r.property.geometry){n++}if(n==a){this.data=r}this.processTask(e)};i.prototype.onEamLoad=function(t){var e=t.loader;var i=t.param;var r=e.data;r.animationName=i.eamData.name;var a=i.mapNodeData.object3d;a.animation.skeletonAnimationController.state.addAnimClip(r);if(this.autoPlayAnimation){this.addAutoAnimation(a.animation,1,false,false,r.animationName)}this.processTask(e)};i.prototype.onSkinClip=function(t){var e=t.loader;var i=t.param;var r=i.skinClip;var a=i.skinData;var n=i.clip;var o=e.data;o.animationName=n.name;if(n.loop){o.isLoop=n.loop=="true"?true:false}r.state.addAnimClip(o);if(this.autoPlayAnimation){this.addAutoAnimation(r,1,false,false,o.animationName)}else{if(a.auto&&a.auto!=""){this.addAutoAnimation(r,1,false,false,o.animationName)}}this.processTask(e)};i.prototype.onProAnim=function(t){var e=t.loader;var i=t.param;var r=i.proAnimation;var a=i.proData;var n=i.clip;var o=e.data;o=o.clone();if(n.loop){o.isLoop=n.loop=="true"?true:false}if(n.name){o.name=n.name}r.addPropertyAnim(o);if(this.autoPlayAnimation){this.addAutoAnimation(r,1,false,false,n.name)}else{if(a.auto&&a.auto!=""){this.addAutoAnimation(r,1,false,false,a.auto)}}this.processTask(e)};i.prototype.onEpaLoad=function(t){var e=t.loader;var i=t.param;var r=e.data;var a=r.clone();this.processEpa(i,a);this.processTask(e)};i.prototype.addTask=function(){this._taskCount++};i.prototype.calculateProgress=function(){var t=0;for(var e in this._taskDict){var i=false;for(var r=0;r<this.continueProgressEvent.length;++r){if(e==this.continueProgressEvent[r]){i=true;break}}if(i){t+=.1/this.continueProgressEvent.length*this._taskDict[e].currentProgress}else{t+=.9/(this.taskTotal-this.continueProgressEvent.length)*this._taskDict[e].currentProgress}}return t};i.prototype.processTaskCurrent=function(e){if(this._taskDict[e.url]){if(this._taskDict[e.url].status==1){this.taskCurrent++;this._taskDict[e.url].status=2;this._taskDict[e.url].currentProgress=1;this._event.loader=e;this._event.data=e.data;var i=true;this.currentProgress=this.calculateProgress();if(this.currentProgress<1){this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS;this._event.currentProgress=this.currentProgress;this.dispatchEvent(this._event)}this._event.currentProgress=this.currentProgress;this._event.eventType=t.LoaderEvent3D.LOADER_ONCE_COMPLETE;this.dispatchEvent(this._event)}}};i.prototype.processTask=function(e){this.processTaskCurrent(e);this._taskCount--;if(this._taskCount<=0){this.currentProgress=1;this.onLoaderComplete();this._event.loader=this;this._event.data=this.data;this._event.currentProgress=this.currentProgress;this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS;this.dispatchEvent(this._event);this._event.eventType=t.LoaderEvent3D.LOADER_COMPLETE;this.dispatchEvent(this._event)}};i.prototype.onLoaderComplete=function(){if(!this._configParser){return}if(this._mapParser){this.data=this.container;var e=[];for(var i=0;i<this._mapParser.nodeList.length;i++){var r=this._mapParser.nodeList[i];if(r.object3d instanceof t.ParticleEmitter){var a=r.object3d;for(var n=0;n<r.childs.length;++n){var o=r.childs[n];var s=this.container.findObject3D(o.name);e.push(s);if(s instanceof t.ParticleEmitter){a.addSubEmitter(Number(t.ParticleDataSubEmitterPhase[o.phase]),s)}}}if(r.boneBind.skeletonAnimation){var h=Number(r.boneBind.skeletonAnimation);var u=this.skinClipDict[h];u.bindToJointPose(r.boneBind.boneName,r.object3d)}}var l;for(var i=0;i<e.length;i++){l=e[i];if(l&&l.parent){l.parent.removeChild(l)}}var c=true;if(c){var f=t.StaticMergeUtil.bacthingMesh(this._mapParser);for(var d in f){this.container.addChild(f[d])}}}if(this.view3d){for(var i=0;i<this.huds.length;++i){this.view3d.addHUD(this.huds[i])}}for(var i=0;i<this.autoAnimationList.length;++i){var p=this.autoAnimationList[i];if(p.animation instanceof t.SkeletonAnimation){p.animation.play(p.name,p.speed,p.reset,p.prewarm)}else if(p.animation instanceof t.PropertyAnimController){p.animation.play(p.name)}else if(p.animation instanceof t.MethodBase){p.animation.start(true)}else if(p.animation instanceof t.ParticleEmitter){p.animation.play(p.speed,p.reset,p.prewarm)}else if(p.animation instanceof t.EffectGroup){p.animation.play()}}if(this._configParser.type==t.IConfigParser.TYPE_EFFECT_GROUP){var _=this.data;if(_){_.init(this._mapParser.loop);if(this._mapParser.auto){_.play()}}}if(this._configParser.type==t.IConfigParser.TYPE_SKIN_MESH){var m=this.data;for(var v in this.skinClipDict){m.skeletonAnimation=this.skinClipDict[v];break}}};i.prototype.addImaTask=function(t,e,i,r,a){var n=null;var o=this._pathRoot+t;var s={};s.type=e;s.matID=i;s.mapNodeData=r;this.doAssetLoader(o,this.onMaterialTexture,s);return n};i.prototype.addMethodImgTask=function(t,e,i){var r=this._pathRoot+t;var a={};a.method=e;a.textureName=i;var n=this.doAssetLoader(r,this.onMethodTexture,a);return n};i.prototype.processMat=function(e){var i=e.object3d;for(var r=0;r<e.materialIDs.length;++r){var a=this._mapParser.matDict[e.materialIDs[r]];if(!a){continue}var n=i.getMaterial(r);if(!n){n=new t.TextureMaterial;i.addSubMaterial(r,n)}var o=null;if(a.diffuseTextureName!=""){o=this.addImaTask(a.diffuseTextureName,"diffuseTexture",r,e,n)}if(a.normalTextureName!=""){o=this.addImaTask(a.normalTextureName,"normalTexture",r,e,n)}if(a.specularTextureName!=""){o=this.addImaTask(a.specularTextureName,"specularTexture",r,e,n)}if(a.matcapTextureName!=""){o=this.addImaTask(a.matcapTextureName,"matcapTexture",r,e,n)}n.diffuseColor=a.diffuseColor;n.ambientColor=a.ambientColor;n.specularColor=a.specularColor;n.tintColor=a.tintColor;n.alpha=a.alpha;n.specularLevel=a.specularLevel;n.gloss=a.gloss;n.gamma=a.gamma;n.refraction=a.refraction;n.refractionintensity=a.refractionintensity;n.castShadow=a.castShadow;n.acceptShadow=a.acceptShadow;n.repeat=a.repeat;n.bothside=a.bothside;n.drawMode=a.drawMode;n.cullMode=a.cullMode;n.blendMode=a.blendMode;n.cutAlpha=a.cutAlpha;n.uvRectangle.copyFrom(a.uvRectangle);var s=new t.LightGroup;for(var h=0;h<a.lightIds.length;++h){var u=this.lightDict[a.lightIds[h]];if(u){s.addLight(u)}}if(s.lightNum>0){n.lightGroup=s}this.processMethod(n,a)}var l=i.lightGroup||new t.LightGroup;for(var r=0;r<e.lightIds.length;++r){var u=this.lightDict[e.lightIds[r]];if(u){l.addLight(u)}}if(l.lightNum>0){i.lightGroup=l}};i.prototype.processMethod=function(e,i){var r=null;var a=null;for(var n=0,o=i.methods;n<o.length;n++){a=o[n];t.MethodUtils.doMethod(e,a,this)}};i.prototype.processNode=function(){for(var e=0;e<this._mapParser.nodeList.length;e++){var i=this._mapParser.nodeList[e];if(i.type=="Camera3D"){var r=new t.Camera3D;r.fieldOfView=i.fov;r.near=i.clipNear;r.far=i.clipFar;i.object3d=r}else if(i.type=="Billboard"){i.object3d=new t.Billboard(new t.TextureMaterial(t.CheckerboardTexture.texture))}else if(i.type=="Terrain"){i.object3d=new t.Object3D}else if(i.type=="DirectLight"){var a=new t.DirectLight;i.object3d=a;a.lightId=i.lightData.id;a.diffuse=i.lightData.diffuseColor;a.ambient=i.lightData.ambientColor;a.halfIntensity=i.lightData.halfIntensity;a.intensity=i.lightData.intensity;this.lightDict[i.lightData.id]=a}else if(i.type=="PointLight"){var n=new t.PointLight;i.object3d=n;n.lightId=i.lightData.id;n.ambient=i.lightData.ambientColor;n.diffuse=i.lightData.diffuseColor;n.radius=i.lightData.radius;n.cutoff=i.lightData.falloff;n.intensity=i.lightData.intensity;this.lightDict[i.lightData.id]=n}else{i.object3d=new t.Object3D}i.object3d.name=i.name;i.object3d.visible=i.visible;i.object3d.position=new t.Vector3D(i.x,i.y,i.z);i.object3d.orientation=new t.Quaternion(i.rx,i.ry,i.rz,i.rw);i.object3d.scale=new t.Vector3D(i.sx,i.sy,i.sz);if(i.tagName!=""){i.object3d.tag.name=i.tagName}}for(var e=0;e<this._mapParser.nodeList.length;e++){var o=this._mapParser.nodeList[e];for(var s=0;s<this._mapParser.nodeList.length;s++){var h=this._mapParser.nodeList[s];if(o.parent==h.insID){h.object3d.addChild(o.object3d);break}}}};i.prototype.processSkinClip=function(){for(var e in this._mapParser.skeletonAnimationDict){var i=this._mapParser.skeletonAnimationDict[e];var r=Number(e);var a=new t.SkeletonAnimation(new t.SkeletonAnimationState);this.skinClipDict[r]=a;for(var n=0;n<i.clips.length;++n){var o=i.clips[n];var s=this._pathRoot+o.path;var h={};h.skinClip=a;h.skinData=i;h.clip=o;this.doAssetLoader(s,this.onSkinClip,h)}}};i.prototype.processProAnim=function(){for(var e in this._mapParser.proAnimationDict){var i=this._mapParser.proAnimationDict[e];var r=Number(e);var a=new t.PropertyAnimController;this.proAnimDict[r]=a;for(var n=0;n<i.clips.length;++n){var o=i.clips[n];var s=this._pathRoot+o.path;var h={};h.proAnimation=a;h.proData=i;h.clip=o;this.doAssetLoader(s,this.onProAnim,h)}}};i.prototype.createLight=function(){var e=null;for(var i in this._mapParser.lightDict){e=this._mapParser.lightDict[i];if(e.type==t.LightType.directlight&&this._mapParser.directLight){var r=new t.DirectLight(e.direction);r.lightId=e.id;r.diffuse=e.diffuseColor;r.ambient=e.ambientColor;r.halfIntensity=e.halfIntensity;r.intensity=e.intensity;this.lightDict[e.id]=r}else if(e.type==t.LightType.pointlight&&this._mapParser.pointLight){var a=new t.PointLight(0);a.lightId=e.id;a.position=e.position;a.ambient=e.ambientColor;a.diffuse=e.diffuseColor;a.radius=e.radius;a.cutoff=e.falloff;a.intensity=e.intensity;this.lightDict[e.id]=a}}};i.prototype.onUnitLoader=function(e){var r=e.param;var a=e.target;a.removeEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onUnitLoader,this);switch(r.type){case i.NODE_TYPE_EffectGroup:this.processObject3d(r,a.container);var n=a.container;if(n){if(r.auto){this.addAutoAnimation(n)}}break;case i.NODE_TYPE_ParticleEmitter:var o=a.data;o.materialData=this._mapParser.matDict[r.materialIDs[0]];var s=new t.ParticleEmitter(o,new t.TextureMaterial);r.visible=t.Egret3DPolicy.useParticle;this.processObject3d(r,s);if(this.autoPlayAnimation||o.property.playOnAwake){this.addAutoAnimation(s,1,false,o.property.prewarm)}this.processMat(r);break}this.doLoadEpa(r);this.processTask(a)};i.NODE_TYPE_Object3D="Object3D";i.NODE_TYPE_Camera3D="Camera3D";i.NODE_TYPE_CubeSky="CubeSky";i.NODE_TYPE_SphereSky="SphereSky";i.NODE_TYPE_MESH="Mesh";i.NODE_TYPE_Terrain="Terrain";i.NODE_TYPE_ParticleEmitter="ParticleEmitter";i.NODE_TYPE_EffectGroup="EffectGroup";return i}(t.ILoader);t.UnitLoader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.type="";this.insID=0;this.parent=0;this.name="";this.staticType="";this.path="";this.fov=0;this.clipNear=0;this.clipFar=0;this.tagName="";this.materialIDs=[];this.skinClips=[];this.propertyAnims=[];this.billboard=false;this.visible=true;this.x=0;this.y=0;this.z=0;this.rx=0;this.ry=0;this.rz=0;this.rw=0;this.sx=1;this.sy=1;this.sz=1;this.skeletonAnimation=-1;this.propertyAnimsId=-1;this.geometry=[];this.grass=[];this.childs=[];this.boneBind={};this.lightIds=[];this.auto=false;this.loop=false;this.uv2Id=-1}return t}();t.UnitNodeData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t){this.taskDict={};this.type=t}t.TYPE_SCENE="scene";t.TYPE_SKIN_MESH="ShinnedMesh";t.TYPE_EFFECT_GROUP="EffectGroup";t.TYPE_PARTICLE="ParticleConfig";t.TYPE_TEXTUREPACKER="TexturePacker";return t}();t.IConfigParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a){e.call(this,a);this.nodeList=new Array;this.hudList=new Array;this.auto=false;this.loop=false;this.matDict={};this.lightDict={};this.skeletonAnimationDict={};this.proAnimationDict={};this.directLight=false;this.pointLight=false;this.textures=[];t.UnitParserUtils.mapParser(r,i,this)}i.prototype.calculateTask=function(){if(this.uv2){this.taskDict[this.uv2]=0}};i.prototype.calculateProAnimationTask=function(t){for(var e=0;e<t.clips;++e){var i=t.clips[e];if(i.path){this.taskDict[t.path]=0}}};i.prototype.calculateSkeletonAnimationTask=function(t){for(var e=0;e<t.clips;++e){var i=t.clips[e];if(i.path){this.taskDict[t.path]=0}}};i.prototype.calculateMatTask=function(t){if(t.diffuseTextureName!=""){this.taskDict[t.diffuseTextureName]=0}if(t.normalTextureName!=""){this.taskDict[t.normalTextureName]=0}if(t.specularTextureName!=""){this.taskDict[t.specularTextureName]=0}for(var e=0;e<t.methods.length;++e){var i=t.methods[e];for(var r=0;r<i.texturesData.length;++r){var a=i.texturesData[r];if(a.path){this.taskDict[a.path]=0}}}};i.prototype.calculateNodeTask=function(t){if(t.path){this.taskDict[t.path]=0}for(var e=0;e<t.skinClips.length;e++){var i=t.skinClips[e];if(i.path){this.taskDict[i.path]=0}}
for(var e=0;e<t.propertyAnims.length;++e){var r=t.propertyAnims[e];if(r.path){this.taskDict[r.path]=0}}for(var e=0;e<t.grass.length;++e){var a=t.grass[e];if(a.detailTexture){this.taskDict[a.detailTexture]=0}if(a.grassTexture){this.taskDict[a.detailTexture]=0}}};i.prototype.calculateHudTask=function(t){if(t.texture){this.taskDict[t.texture]=0}};i.prototype.calculateTextureTask=function(t){if(t.path){this.taskDict[t.path]=0}};return i}(t.IConfigParser);t.UnitConfigParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.type="";this.usePower=false;this.texturesData=[];this.uSpeed=0;this.vSpeed=0;this.play=true;this.loop=true;this.frameNum=0;this.row=0;this.col=0;this.delayTime=0;this.totalTime=0}t.methodType={lightmapMethod:"lightmapMethod",uvRollMethod:"uvRollMethod",uvSpriteSheetMethod:"uvSpriteSheetMethod",mulUvRollMethod:"mulUvRollMethod",alphaMaskMethod:"alphaMaskMethod",streamerMethod:"streamerMethod",terrainARGBMethod:"terrainARGBMethod",waterWaveMethod:"waterWaveMethod",waterNormalMethod:"waterNormalMethod",particleUVRoll:"particleUVRoll"};return t}();t.UnitMatMethodData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.id=0;this.diffuseTextureName="";this.normalTextureName="";this.specularTextureName="";this.matcapTextureName="";this.diffuseColor=0;this.ambientColor=0;this.specularColor=0;this.tintColor=2155905152;this.alpha=0;this.specularLevel=0;this.gloss=0;this.gamma=1;this.refraction=1.9;this.refractionintensity=2;this.ambientPower=0;this.diffusePower=0;this.normalPower=0;this.castShadow=false;this.acceptShadow=false;this.smooth=false;this.repeat=false;this.bothside=false;this.drawMode=0;this.cullMode=0;this.blendMode=0;this.cutAlpha=.7;this.methods=[];this.lightIds=[];this.uvRectangle=new t.Rectangle(0,0,1,1)}return e}();t.UnitMatSphereData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.id=0;this.type=0;this.diffuseColor=16777215;this.ambientColor=16777215;this.intensity=1;this.halfIntensity=0;this.direction=new t.Vector3D(-.5,-.6,.2);this.position=new t.Vector3D;this.falloff=0;this.radius=100}return e}();t.UnitLightData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.bothside=false}return t}();t.UnitHUDData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){if(t===void 0){t=null}e.call(this,t);this.container=this.createObject()}i.prototype.createObject=function(){this.scene=new t.Scene3D;return this.scene};i.prototype.onLoaderComplete=function(){e.prototype.onLoaderComplete.call(this)};return i}(t.UnitLoader);t.MapLoader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.avatar={}}i.prototype.setAvatar=function(t,i){var r=this.avatar[t];if(r){r.parent.removeChild(r)}this.avatar[t]=i;e.prototype.addChild.call(this,i)};i.prototype.delAvatar=function(t){if(this.avatar[t]){delete this.avatar[t]}};i.prototype.play=function(t,e,i){this.skeletonAnimation.play(t,e,i)};i.prototype.addChild=function(i){if(i instanceof t.Mesh){this.setAvatar(i.name,i)}else{e.prototype.addChild.call(this,i)}return i};i.prototype.addChildAt=function(i,r){if(i instanceof t.Mesh){this.setAvatar(i.name,i)}else{e.prototype.addChildAt.call(this,i,r)}return i};i.prototype.removeChild=function(t){this.delAvatar(t.name);return e.prototype.removeChild.call(this,t)};i.prototype.removeChildAt=function(t){var i=this.getChild(t);if(i){this.delAvatar(i.name)}return e.prototype.removeChildAt.call(this,t)};i.prototype.update=function(t,e){};i.prototype.copy=function(t){e.prototype.copy.call(this,t)};i.prototype.clone=function(){var e=new i;var r=this.skeletonAnimation.clone();e.skeletonAnimation=r;for(var a=0;a<this.childs.length;a++){if(this.childs[a]instanceof t.Mesh){var n=this.childs[a].clone();n.animation=r;e.setAvatar(n.name,n)}}return e};return i}(t.Object3D);t.Role=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(t){if(t===void 0){t=null}e.call(this,t);this.container=this.createObject()}i.prototype.createObject=function(){this.role=new t.Role;return this.role};return i}(t.UnitLoader);t.RoleLoader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.prototype.parse=function(t,e){this._particleData=e;this.version=this.getNode(t,"version").textContent;var i=this.getNode(t,"property");this.parseProperty(i);var r=this.getNode(t,"emission");this.parseEmission(r);var a=this.getNode(t,"life");this.parseLife(a);var n=this.getNode(t,"shape");this.parseShape(n);var o=this.getNode(t,"rotationBirth");this.parseRotationBirth(o);var s=this.getNode(t,"scaleBirth");this.parseScaleBirth(s);var h=this.getNode(t,"geometry");this.parseGeometry(h);var u=this.getNode(t,"moveSpeed");this.parseMoveSpeed(u);var l=this.getNode(t,"followTarget");this.parseFollowTarget(l);var c=this.getNode(t,"scaleBezier");this.parseScaleBeizer(c);var f=this.getNode(t,"rotationSpeed");this.parseRotationSpeed(f);var d=this.getNode(t,"colorOffset");this.parseColorOffset(d);var p=this.getNode(t,"mat");var _=this.getNode(t,"textureSheet");this.parseTextureSheet(_)};e.prototype.parseProperty=function(e){var i=this._particleData.property;i.particleCount=Number(this.getNode(e,"particleCount").textContent);i.prewarm=this.getNode(e,"prewarm").textContent=="true";i.playOnAwake=this.getNode(e,"playOnAwake").textContent=="true";var r=this.getNode(e,"bounds");i.bounds=this.parseVector3D(r,i.bounds);i.colorType=t.ParticleBirthColorType[this.getNode(e,"colorType").textContent];var a=this.getNode(e,"colorConst1");var n=this.getNode(e,"colorConst2");var o=this.getNode(e,"colorGradients1");var s=this.getNode(e,"colorGradients2");this.parseColorProperty(i,a,n,o,s);i.gravity=Number(this.getNode(e,"gravity").textContent);var h=this.getNode(e,"transform");var u=this.getNode(h,"rotation");var l=this.getNode(h,"scale");var c=this.getNode(h,"position");i.rotation=this.parseVector3D(u,i.rotation);i.scale=this.parseVector3D(l,i.scale);i.position=this.parseVector3D(c,i.position);var f=this.getNode(e,"render");var d=this.getNode(f,"renderMode");if(d){i.renderMode=t.ParticleRenderModeType[d.textContent]}var p=this.getNode(f,"lengthScale");if(p){i.lengthScale=Number(p.textContent)}var _=this.getNode(f,"cameraScale");if(_){i.cameraScale=Number(_.textContent)}var m=this.getNode(f,"speedScale");if(m){i.speedScale=Number(m.textContent)}var v=this.getNode(f,"meshFile");if(v&&v.textContent!=""){i.meshFile=v.textContent}var g=this.getNode(e,"sortingFudge");if(g){i.sortingFudge=Number(g.textContent)}};e.prototype.parseColorProperty=function(e,i,r,a,n){if(i){e.colorConst1=t.Color.createColor(Number(i.textContent))}if(r){e.colorConst2=t.Color.createColor(Number(r.textContent))}if(a){var o=this.getNodeList(a,"item");e.colorGradients1=this.parseGradientsColor(o,e.colorGradients1)}if(n){var o=this.getNodeList(n,"item");e.colorGradients2=this.parseGradientsColor(o,e.colorGradients2)}};e.prototype.parseEmission=function(e){var i=this._particleData.emission;i.type=t.ParticleValueType[this.getNode(e,"type").textContent];i.rate=Number(this.getNode(e,"rate").textContent);var r=this.getNode(e,"bursts");var a;var n;var o=0;var s=0;var h;if(r){i.bursts=[];var u=this.getNodeList(r,"item");for(o=0,s=u?u.length:0;o<s;o++){a=u[o];h=new t.Point;i.bursts.push(h);this.eachAttr(a,function(t,e){if(t=="time"){h.x=Number(e)}else if(t=="count"){h.y=Number(e)}})}}var l=this.getNode(e,"bezier");if(i.type==t.ParticleValueType.OneBezier){i.bezier=this.parseBezierData(l)}};e.prototype.parseLife=function(e){var i=this._particleData.life;i.type=t.ParticleValueType[this.getNode(e,"type").textContent];i.min=Number(this.getNode(e,"min").textContent);i.max=Number(this.getNode(e,"max").textContent);i.bezier1=this.parseBezierData(this.getNode(e,"bezier1"));i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"));i.duration=Number(this.getNode(e,"duration").textContent);i.delay=Number(this.getNode(e,"delay").textContent);i.loop=this.getNode(e,"loop").textContent=="true"};e.prototype.parseShape=function(e){if(e==null)return;var i=this._particleData.shape;i.type=t.ParticleDataShapeType[this.getNode(e,"type").textContent];i.randomDirection=this.getNode(e,"randomDirection").textContent=="true";var r=this.getNode(e,"emitFromShell");i.emitFromShell=r&&r.textContent=="true";var a=this.getNode(e,"cube");this.eachAttr(a,function(t,e){if(t=="width"){i.cubeW=Number(e)}else if(t=="height"){i.cubeH=Number(e)}else if(t=="depth"){i.cubeD=Number(e)}});var n=this.getNode(e,"sphereRadius");if(n){i.sphereRadius=Number(n.textContent)}var o=this.getNode(e,"hemiSphereRadius");if(o){i.hemiSphereRadius=Number(o.textContent)}var s=this.getNode(e,"cone");this.eachAttr(s,function(e,r){if(e=="type"){i.coneType=t.ParticleConeShapeType[r]}else if(e=="length"){i.coneLength=Number(r)}else if(e=="radius"){i.coneRadius=Number(r)}else if(e=="angle"){i.coneAngle=Number(r)}});var h=this.getNode(e,"meshType");if(h){i.meshType=t.ParticleMeshShapeType[h.textContent]}var u=this.getNode(e,"meshFile");if(u&&u.textContent!=""){i.meshFile=u.textContent}};e.prototype.parseRotationBirth=function(e){var i=this._particleData.rotationBirth;i.type=t.ParticleValueType[this.getNode(e,"type").textContent];i.min=Number(this.getNode(e,"min").textContent);i.max=Number(this.getNode(e,"max").textContent);i.bezier1=this.parseBezierData(this.getNode(e,"bezier1"));i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))};e.prototype.parseScaleBirth=function(e){var i=this._particleData.scaleBirth;i.type=t.ParticleValueType[this.getNode(e,"type").textContent];i.min=Number(this.getNode(e,"min").textContent);i.max=Number(this.getNode(e,"max").textContent);i.bezier1=this.parseBezierData(this.getNode(e,"bezier1"));i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))};e.prototype.parseGeometry=function(t){var e=this._particleData.geometry;var i=this.getNode(t,"plane");this.eachAttr(i,function(t,i){if(t=="width"){e.planeW=Number(i)}else if(t=="height"){e.planeH=Number(i)}})};e.prototype.parseMoveSpeed=function(e){var i=this._particleData.moveSpeed;i.type=t.ParticleValueType[this.getNode(e,"type").textContent];i.min=Number(this.getNode(e,"min").textContent);i.max=Number(this.getNode(e,"max").textContent);i.bezier1=this.parseBezierData(this.getNode(e,"bezier1"));i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"));var r=this.getNode(e,"velocityOver");if(r){var a=new t.VelocityOverLifeTimeData;a.type=t.ParticleValueType[this.getNode(r,"type").textContent];var n=this.getNode(r,"min");var o=this.getNode(r,"max");a.min=this.parseVector3D(n,a.min);a.max=this.parseVector3D(o,a.max);a.worldSpace=this.getNode(r,"worldSpace").textContent=="true";a.xBezier1=this.parseBezierData(this.getNode(r,"xBezier1"));a.yBezier1=this.parseBezierData(this.getNode(r,"yBezier1"));a.zBezier1=this.parseBezierData(this.getNode(r,"zBezier1"));a.xBezier2=this.parseBezierData(this.getNode(r,"xBezier2"));a.yBezier2=this.parseBezierData(this.getNode(r,"yBezier2"));a.zBezier2=this.parseBezierData(this.getNode(r,"zBezier2"));i.velocityOver=a}var s=this.getNode(e,"velocityForce");if(s){var h=new t.VelocityForceLifeTimeData;h.type=t.ParticleValueType[this.getNode(s,"type").textContent];var n=this.getNode(s,"min");var o=this.getNode(s,"max");h.min=this.parseVector3D(n,h.min);h.max=this.parseVector3D(o,h.max);h.worldSpace=this.getNode(s,"worldSpace").textContent=="true";h.xBezier1=this.parseBezierData(this.getNode(s,"xBezier1"));h.yBezier1=this.parseBezierData(this.getNode(s,"yBezier1"));h.zBezier1=this.parseBezierData(this.getNode(s,"zBezier1"));h.xBezier2=this.parseBezierData(this.getNode(s,"xBezier2"));h.yBezier2=this.parseBezierData(this.getNode(s,"yBezier2"));h.zBezier2=this.parseBezierData(this.getNode(s,"zBezier2"));i.velocityForce=h}var u=this.getNode(e,"velocityLimit");if(u){var l=new t.VelocityLimitLifeTimeData;l.type=t.ParticleValueType[this.getNode(u,"type").textContent];var n=this.getNode(u,"min");var o=this.getNode(u,"max");var c=this.getNode(u,"dampen");l.min=Number(n.textContent);l.max=Number(o.textContent);l.dampen=c?Number(c.textContent):0;l.bezier1=this.parseBezierData(this.getNode(u,"bezier1"));l.bezier2=this.parseBezierData(this.getNode(u,"bezier2"));i.velocityLimit=l}};e.prototype.parseFollowTarget=function(e){if(e==null)return;var i=this._particleData.followTarget=new t.ParticleDataFollowTarget;i.followRotation=this.getNode(e,"followRotation").textContent=="true";i.followScale=this.getNode(e,"followScale").textContent=="true"};e.prototype.parseScaleBeizer=function(e){if(e==null)return;var i=this._particleData.scaleSize=new t.ParticleDataScaleSize;i.bezier1=this.parseBezierData(this.getNode(e,"bezier"))};e.prototype.parseRotationSpeed=function(e){if(e==null)return;var i=this._particleData.rotationSpeed=new t.ParticleDataRotationSpeed;i.type=t.ParticleValueType[this.getNode(e,"type").textContent];var r=this.getNode(e,"min");var a=this.getNode(e,"max");i.min=this.parseVector3D(r,i.min);i.max=this.parseVector3D(a,i.max);i.bezier1=this.parseBezierData(this.getNode(e,"bezier1"));i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))};e.prototype.parseColorOffset=function(e){if(e==null)return;var i=this._particleData.colorOffset=new t.ParticleDataColorOffset;var r=this.getNodeList(e,"item");i.data=this.parseGradientsColor(r,i.data)};e.prototype.parseTextureSheet=function(e){if(e==null)return null;var i=this._particleData.textureSheet=new t.ParticleDataTextureSheet;i.frameType=t.ParticleValueType[this.getNode(e,"frameType").textContent];i.tileX=Number(this.getNode(e,"tileX").textContent);i.tileY=Number(this.getNode(e,"tileY").textContent);i.whole=this.getNode(e,"whole").textContent=="true";i.row=Number(this.getNode(e,"row").textContent);i.min=Number(this.getNode(e,"min").textContent);i.max=Number(this.getNode(e,"max").textContent);i.circles=Number(this.getNode(e,"circles").textContent);i.bezier1=this.parseBezierData(this.getNode(e,"bezier1"));i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"));return i};e.prototype.parseGradientsColor=function(e,i){i||(i=new t.ColorGradients);var r;var a=0;var n=0;var o;var s;var h;for(a=0,n=e?e.length:0;a<n;a++){r=e[a];this.eachAttr(r,function(e,r){if(e=="time"){i.times.push(Number(r))}else if(e=="color"){s=t.Color.createColor(Number(r));i.colors.push(s)}})}var u=i.times.slice();var l=i.colors.slice();u.sort(function(t,e){return t-e});for(a=0,n=i?i.times.length:0;a<n;a++){var c=u.indexOf(i.times[a]);i.colors[a]=l[c]}i.times=u;return i};e.prototype.parseBezierData=function(e){var i=new t.BezierData;if(e==null)return i;var r=this.getNodeList(e,"pos");var a=this.getNodeList(e,"ctrl");var n;var o=0;var s=0;var h;for(o=0,s=r?r.length:0;o<s;o++){n=r[o];h=new t.Point;i.posPoints.push(h);this.eachAttr(n,function(t,e){if(t=="x"){h.x=Number(e)}else if(t=="y"){h.y=Number(e)}})}for(o=0,s=a?a.length:0;o<s;o++){n=a[o];h=new t.Point;i.ctrlPoints.push(h);this.eachAttr(n,function(t,e){if(t=="x"){h.x=Number(e)}else if(t=="y"){h.y=Number(e)}})}return i};e.prototype.parseVector3D=function(e,i){if(i==null)i=new t.Vector3D;this.eachAttr(e,function(t,e){if(t=="x"){i.x=Number(e)}else if(t=="y"){i.y=Number(e)}else if(t=="z"){i.z=Number(e)}});return i};e.prototype.getNode=function(t,e){if(t==null)return null;var i=t.getElementsByTagName(e);if(i==null||i.length==0)return null;return i[0]};e.prototype.getNodeList=function(t,e){if(t==null)return null;var i=t.getElementsByTagName(e);if(i==null||i.length==0)return null;return i};e.prototype.eachAttr=function(e,i){t.XMLParser.eachXmlAttr(e,i)};return e}();t.ParticleXmlParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.prototype.parse=function(t,e){this._particleData=e;this.engineVersion=t.engineVersion+"";this.version=t.version+"";var i=t.property;this.parseProperty(i);var r=t.emission;this.parseEmission(r);var a=t.life;this.parseLife(a);var n=t.shape;this.parseShape(n);var o=t.rotationBirth;this.parseRotationBirth(o);var s=t.scaleBirth;this.parseScaleBirth(s);var h=t.geometry;this.parseGeometry(h);var u=t.moveSpeed;this.parseMoveSpeed(u);var l=t.followTarget;this.parseFollowTarget(l);var c=t.scaleSize;var f=t.scaleBezier;if(c){this.parseScaleSize(c)}else{this.parseScaleBeizer(f)}var d=t.rotationSpeed;this.parseRotationSpeed(d);var p=t.colorOffset;this.parseColorOffset(p);var _=t.mat;var m=t.textureSheet;this.parseTextureSheet(m)};e.prototype.parseProperty=function(e){var i=this._particleData.property;i.particleCount=Number(e.particleCount);i.prewarm=e.prewarm;if(e.playOnAwake!=undefined){i.playOnAwake=e.playOnAwake}i.bounds=this.parseVector3D(e.bounds,i.bounds);i.colorType=t.ParticleBirthColorType[e.colorType+""];var r=e.colorConst1;var a=e.colorConst2;var n=e.colorGradients1;var o=e.colorGradients2;this.parseColorProperty(i,r,a,n,o);i.gravity=Number(e.gravity);var s=e.transform;var h=s.rotation;var u=s.scale;var l=s.position;i.rotation=this.parseVector3D(h,i.rotation);i.scale=this.parseVector3D(u,i.scale);i.position=this.parseVector3D(l,i.position);var c=e.render;i.renderMode=t.ParticleRenderModeType[c.renderMode+""];i.lengthScale=Number(c.lengthScale);i.cameraScale=Number(c.cameraScale);i.speedScale=Number(c.speedScale);i.meshFile=c.meshFile;if(i.meshFile==""){i.meshFile=null}i.sortingFudge=Number(e.sortingFudge)};e.prototype.parseColorProperty=function(e,i,r,a,n){if(i){e.colorConst1=t.Color.createColor(Number(i))}if(r){e.colorConst2=t.Color.createColor(Number(r))}if(a){e.colorGradients1=this.parseGradientsColor(a,e.colorGradients1)}if(n){e.colorGradients2=this.parseGradientsColor(n,e.colorGradients2)}};e.prototype.parseEmission=function(e){var i=this._particleData.emission;i.type=t.ParticleValueType[e.type+""];i.rate=Number(e.rate);var r=e.bursts;var a=0;var n=0;var o;var s;if(r){i.bursts=[];for(a=0,n=r?r.length:0;a<n;a++){s=r[a];o=new t.Point;o.x=Number(s[0]);o.y=Number(s[1]);i.bursts.push(o)}}if(i.type==t.ParticleValueType.OneBezier){i.bezier=this.parseFoldLine(e.line)||this.parseBezierData(e.bezier)}};e.prototype.parseLife=function(e){var i=this._particleData.life;i.type=t.ParticleValueType[e.type+""];i.min=Number(e.min);i.max=Number(e.max);i.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1);i.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2);i.duration=Number(e.duration);i.delay=Number(e.delay);i.loop=e.loop};e.prototype.parseShape=function(e){if(e==null)return;var i=this._particleData.shape;i.type=t.ParticleDataShapeType[e.type+""];i.randomDirection=e.randomDirection;i.emitFromShell=e.emitFromShell;var r=e.cube;if(r){i.cubeW=Number(r[0]);i.cubeH=Number(r[1]);i.cubeD=Number(r[2])}i.sphereRadius=Number(e.sphereRadius);i.hemiSphereRadius=Number(e.hemiSphereRadius);if(i.type==t.ParticleDataShapeType.Cone){var a=e.cone;i.coneType=t.ParticleConeShapeType[a.type+""];i.coneLength=Number(a.length);i.coneRadius=Number(a.radius);i.coneAngle=Number(a.angle)}i.meshType=t.ParticleMeshShapeType[e.meshType+""];i.meshFile=e.meshFile;if(i.meshFile==""){i.meshFile=null}};e.prototype.parseRotationBirth=function(e){var i=this._particleData.rotationBirth;i.type=t.ParticleValueType[e.type+""];i.min=Number(e.min);i.max=Number(e.max);i.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1);i.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2)};e.prototype.parseScaleBirth=function(e){var i=this._particleData.scaleBirth;i.type=t.ParticleValueType[e.type+""];i.min=Number(e.min);i.max=Number(e.max);i.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1);i.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2)};e.prototype.parseGeometry=function(t){var e=this._particleData.geometry;var i=t.plane;e.planeW=Number(i[0]);e.planeH=Number(i[1])};e.prototype.parseMoveSpeed=function(e){var i=this._particleData.moveSpeed;i.type=t.ParticleValueType[e.type+""];i.min=Number(e.min);i.max=Number(e.max);i.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1);i.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2);var r=e.velocityOver;if(r){var a=new t.VelocityOverLifeTimeData;a.type=t.ParticleValueType[r.type+""];a.min=this.parseVector3D(r.min,a.min);a.max=this.parseVector3D(r.max,a.max);a.worldSpace=r.worldSpace;a.xBezier1=this.parseFoldLine(e.xLine1)||this.parseBezierData(r.xBezier1);a.yBezier1=this.parseFoldLine(e.yLine1)||this.parseBezierData(r.yBezier1);a.zBezier1=this.parseFoldLine(e.zLine1)||this.parseBezierData(r.zBezier1);a.xBezier2=this.parseFoldLine(e.xLine2)||this.parseBezierData(r.xBezier2);a.yBezier2=this.parseFoldLine(e.yLine2)||this.parseBezierData(r.yBezier2);a.zBezier2=this.parseFoldLine(e.zLine2)||this.parseBezierData(r.zBezier2);i.velocityOver=a}var n=e.velocityForce;if(n){var o=new t.VelocityForceLifeTimeData;o.type=t.ParticleValueType[n.type+""];o.min=this.parseVector3D(n.min,o.min);o.max=this.parseVector3D(n.max,o.max);o.worldSpace=n.worldSpace;o.xBezier1=this.parseFoldLine(e.xLine1)||this.parseBezierData(n.xBezier1);o.yBezier1=this.parseFoldLine(e.yLine1)||this.parseBezierData(n.yBezier1);o.zBezier1=this.parseFoldLine(e.zLine1)||this.parseBezierData(n.zBezier1);o.xBezier2=this.parseFoldLine(e.xLine2)||this.parseBezierData(n.xBezier2);o.yBezier2=this.parseFoldLine(e.yLine2)||this.parseBezierData(n.yBezier2);o.zBezier2=this.parseFoldLine(e.zLine2)||this.parseBezierData(n.zBezier2);i.velocityForce=o}var s=e.velocityLimit;if(s){var h=new t.VelocityLimitLifeTimeData;h.type=t.ParticleValueType[s.type+""];h.min=Number(s.min);h.max=Number(s.max);h.dampen=Number(s.dampen);h.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(s.bezier1);h.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(s.bezier2);i.velocityLimit=h}};e.prototype.parseFollowTarget=function(e){if(e==null)return;var i=this._particleData.followTarget=new t.ParticleDataFollowTarget;i.followRotation=e.followRotation;i.followScale=e.followScale};e.prototype.parseScaleBeizer=function(e){if(e==null)return;var i=this._particleData.scaleSize=new t.ParticleDataScaleSize;i.type=t.ParticleValueType.OneBezier;i.bezier1=this.parseFoldLine(e.line)||this.parseBezierData(e.bezier)};e.prototype.parseScaleSize=function(e){if(e==null)return;var i=this._particleData.scaleSize=new t.ParticleDataScaleSize;i.type=t.ParticleValueType[e.type+""];i.min=Number(e.min);i.max=Number(e.max);i.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1);i.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2)};e.prototype.parseRotationSpeed=function(e){if(e==null)return;var i=this._particleData.rotationSpeed=new t.ParticleDataRotationSpeed;i.type=t.ParticleValueType[e.type+""];i.min=this.parseVector3D(e.min,i.min);i.max=this.parseVector3D(e.max,i.max);i.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1);i.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2)};e.prototype.parseColorOffset=function(e){if(e==null)return;var i=this._particleData.colorOffset=new t.ParticleDataColorOffset;i.data=this.parseGradientsColor(e.item,i.data)};e.prototype.parseTextureSheet=function(e){if(e==null)return null;var i=this._particleData.textureSheet=new t.ParticleDataTextureSheet;i.frameType=t.ParticleValueType[e.frameType+""];i.tileX=Number(e.tileX);i.tileY=Number(e.tileY);i.whole=e.whole;i.row=Number(e.row);i.min=Number(e.min);i.max=Number(e.max);i.circles=Number(e.circles);i.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1);i.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2);return i};e.prototype.parseGradientsColor=function(e,i){i||(i=new t.ColorGradients);var r;var a=0;var n=0;var o;for(a=0,n=e?e.length:0;a<n;a++){r=e[a];i.times.push(Number(r[0]));o=t.Color.createColor(Number(r[1]));i.colors.push(o)}var s=i.times.slice();var h=i.colors.slice();s.sort(function(t,e){return t-e});for(a=0,n=i?i.times.length:0;a<n;a++){var u=s.indexOf(i.times[a]);i.colors[a]=h[u]}i.times=s;return i};e.prototype.parseBezierData=function(e){var i=new t.BezierData;i.lineMode=false;if(e==null)return i;var r;var a=0;var n=0;var o;for(a=0,n=e?e.length:0;a<n;a++){r=e[a];o=new t.Point;o.x=Number(r[1]);o.y=Number(r[2]);if(r[0]=="pos"){i.posPoints.push(o)}else{i.ctrlPoints.push(o)}}return i};e.prototype.parseFoldLine=function(e){if(e==null)return null;var i=new t.BezierData;i.lineMode=true;var r;var a=0;var n=0;var o;for(a=0,n=e?e.length:0;a<n;a++){r=e[a];o=new t.Point;o.x=Number(r[0]);o.y=Number(r[1]);i.linePoints.push(o)}return i};e.prototype.parseVector3D=function(e,i){if(i==null)i=new t.Vector3D;if(e){i.x=Number(e[0]);i.y=Number(e[1]);i.z=Number(e[2])}return i};return e}();t.ParticleJsonParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a){if(a===void 0){a=t.IConfigParser.TYPE_PARTICLE}e.call(this,a);switch(r){case"xml":this.data=this.parseXml(i);break;case"json":this.data=this.parseJson(i);break}if(this.data.shape.meshFile){this.taskDict[this.data.shape.meshFile]=0}if(this.data.property.meshFile){this.taskDict[this.data.property.meshFile]=0}}i.prototype.parseJson=function(e){this.data=new t.ParticleData;var i=new t.ParticleJsonParser;i.parse(e,this.data);this.version=Number(i.version);this.engineVersion=String(i.engineVersion);this.data.validate();return this.data};i.prototype.parseXml=function(e){this.data=new t.ParticleData;var i=new t.ParticleXmlParser;i.parse(e,this.data);this.version=Number(i.version);this.data.validate();return this.data};return i}(t.IConfigParser);t.ParticleParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(t){__extends(e,t);function e(e,i,r){t.call(this,r);this.data=e;switch(i){case"json":if(this.data.meta&&this.data.meta.image){this.taskDict[this.data.meta.image]=0}break}}return e}(t.IConfigParser);t.TexturePackerParser=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.apply(this,arguments);this._event=new t.ParserEvent3D}i.prototype.parser=function(e){var i=this;var r=new t.ByteArray(e);var a=new t.ByteArray;r.readBytes(a,0,3);r.position=0;var n=0;n|=a.readUnsignedByte()<<16;n|=a.readUnsignedByte()<<8;n|=a.readUnsignedByte();switch(n){case 4473939:this.datas=t.DDSParser.parse(e);this.dataFormat=".dds";this.doLoadComplete();break;case 2:case 16:this.datas=t.TGAParser.parse(e);this.dataFormat=".tga";this.doLoadComplete();break;case 16767231:var o=new Blob([e]);this.dataFormat=".jpg";var s=document.createElement("img");if(window["createObjectURL"]!=undefined){s.src=window["createObjectURL"](o)}else if(window["URL"]!=undefined){s.src=window["URL"].createObjectURL(o)}else if(window["webkitURL"]!=undefined){s.src=window["webkitURL"].createObjectURL(o)}s.onload=function(){return i.onLoad(s)};break;case 8998990:var o=new Blob([e]);this.dataFormat=".png";var s=document.createElement("img");if(window["createObjectURL"]!=undefined){s.src=window["createObjectURL"](o)}else if(window["URL"]!=undefined){s.src=window["URL"].createObjectURL(o)}else if(window["webkitURL"]!=undefined){s.src=window["webkitURL"].createObjectURL(o)}s.onload=function(){return i.onLoad(s)};break;case 6648685:this.dataFormat=".esm";this.datas=t.ESMParser.parse(e);this.doLoadComplete();break;case 6644077:this.dataFormat=".eam";this.datas=t.EAMParser.parse(e);this.doLoadComplete();break;case 6644577:this.dataFormat=".eca";this.datas=t.ECAParser.parse(e);this.doLoadComplete();break;default:return false}return true};i.prototype.onLoad=function(e){this.datas=new t.ImageTexture(e);this.doLoadComplete();window.URL.revokeObjectURL(e.src);e.onload=null};i.prototype.doLoadComplete=function(){this._event.eventType=t.ParserEvent3D.PARSER_COMPLETE;this._event.data=this;this._event.parser=this;this.dispatchEvent(this._event)};return i}(t.EventDispatcher);t.ParserUtils=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=null}e.call(this);this.dictLoader={};this.currentLoader=null;this.dictProgress={};this.queueLoader=[];this._event=new t.LoaderEvent3D;this.taskTotal=0;this.taskCurrent=0;this.currentProgress=0;this.lastProgress=0;if(i){this.load(i)}}i.prototype.load=function(e){if(this.dictLoader[e]){t.Egret3DLog.outWarn("已经加载过["+e+"]");return this.dictLoader[e]}this.taskTotal++;var i=new t.UnitLoader;this.dictLoader[e]=i;i.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onComplete,this);i.addEventListener(t.LoaderEvent3D.LOADER_PROGRESS,this.onProgress,this);this.dictProgress[e]=0;this.queueLoader.push(e);if(!this.currentLoader){this.currentLoader=this.dictLoader[e];this.currentLoader.load(e)}return i};i.prototype.addAssetEventListener=function(t,e,i,r,a,n){if(a===void 0){a=null}if(n===void 0){n=0}var o=this.dictLoader[t];if(o){return o.addEventListener(e,i,r,a,n)}return 0};i.prototype.removeAssetEventListener=function(t,e,i,r,a,n){if(a===void 0){a=null}if(n===void 0){n=0}var o=this.dictLoader[t];if(o){o.removeEventListener(e,i,r)}};i.prototype.getAsset=function(e){if(this.dictLoader[e]){return this.dictLoader[e].data}return t.textureResMgr.getTexture(e)};i.prototype.getAnim=function(e){var i=this.getAsset(e);if(i instanceof t.Mesh)return this.getAsset(e);return null};i.prototype.getTexture=function(e){var i=this.getAsset(e);if(i instanceof t.ITexture)return this.getAsset(e);return null};i.prototype.getScene=function(e){var i=this.getAsset(e);if(i instanceof t.Object3D)return this.getAsset(e);return null};i.prototype.getText=function(t){var e=this.getAsset(t);return this.getAsset(t)};i.prototype.getGeometry=function(e){var i=this.getAsset(e);if(i instanceof t.Geometry)return this.getAsset(e);return null};i.prototype.getAnimClip=function(e){var i=this.getAsset(e);if(i instanceof t.SkeletonAnimationClip)return this.getAsset(e);return null};i.prototype.getAssetURLLoader=function(e){return t.assetMgr.findAsset(e,this)};i.prototype.getUnitLoader=function(t){return this.dictLoader[t]};i.prototype.onComplete=function(e){var i=e.loader;i.removeEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onComplete,this);i.removeEventListener(t.LoaderEvent3D.LOADER_PROGRESS,this.onProgress,this);this.taskCurrent++;this.queueLoader.shift();this._event.eventType=t.LoaderEvent3D.LOADER_ONCE_COMPLETE;this._event.loader=i;this._event.data=i.data;this._event.currentProgress=this.currentProgress;this.dispatchEvent(this._event);if(this.queueLoader.length>0){var r=this.queueLoader[0];this.currentLoader=this.dictLoader[r];this.currentLoader.load(r)}else{this.guiComplete();this.currentLoader=null;this.currentProgress=1;this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS;this._event.currentProgress=this.currentProgress;this.dispatchEvent(this._event);var a=this.currentLoader;var n=this.taskTotal;var o=this.taskCurrent;var s=[];for(var h in this.dictProgress){s.push(h)}var u=this.currentProgress;var l=this.lastProgress;this._event.eventType=t.LoaderEvent3D.LOADER_COMPLETE;this._event.currentProgress=this.currentProgress;this.dispatchEvent(this._event);this.taskTotal=this.taskTotal-n;this.taskCurrent=this.taskCurrent-o;for(var c=0;c<s.length;++c){if(this.dictProgress[s[c]]>0){delete this.dictProgress[s[c]]}}this.currentProgress=0;this.lastProgress=0}};i.prototype.onProgress=function(e){var i=e.target;if(this.dictProgress[i.url]!=undefined){this.dictProgress[i.url]=i.currentProgress;this.currentProgress=0;for(var r in this.dictProgress){this.currentProgress+=1/this.taskTotal*this.dictProgress[r]}if(this.lastProgress<this.currentProgress){this.lastProgress=this.currentProgress;this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS;this._event.loader=i;this._event.data=i.data;this._event.currentProgress=this.currentProgress;this.dispatchEvent(this._event)}}};i.prototype.loadDefaultGUISkin=function(){var t=this.load("resource/ui/fonts.json");var e=this.load("resource/ui/GUI.json")};i.prototype.guiComplete=function(){t.gui.BitmapFont.load(t.textureResMgr.getTextureDic());t.gui.GUISkinManager.instance.initDefaultSkin()};i.prototype.dispose=function(){
e.prototype.dispose.call(this);for(var i in this.dictLoader){this.dictLoader[i].dispose()}t.assetMgr.dispose(this);this.dictLoader={}};i.prototype.disposeUnitLoader=function(t){if(this.dictLoader[t]){this.dictLoader[t].dispose();delete this.dictLoader[t]}};return i}(t.EventDispatcher);t.QueueLoader=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.vsShaderList=[];this.fsShaderList=[]}t.prototype.upload=function(t,e,i,r,a,n,o,s){};t.prototype.activeState=function(t,e,i,r,a,n,o,s){};t.prototype.dispose=function(){};return t}();t.MethodBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.vsShaderList[t.ShaderPhaseType.base_vertex]=this.vsShaderList[t.ShaderPhaseType.base_vertex]||[];this.vsShaderList[t.ShaderPhaseType.base_vertex].push("gui_vs");this.fsShaderList[t.ShaderPhaseType.base_fragment]=this.fsShaderList[t.ShaderPhaseType.base_fragment]||[];this.fsShaderList[t.ShaderPhaseType.base_fragment].push("gui_fs")}i.prototype.setTextures=function(t,e){var i="uiTexture_"+t.toString();this.materialData[i]=e;this.materialData[i].useMipmap=false};i.prototype.upload=function(t,e,i,r,a,n,o){};i.prototype.activeState=function(t,e,i,r,a,n,o){};return i}(t.MethodBase);t.GUIMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n,o){if(i===void 0){i=t.CheckerboardTexture.texture}if(r===void 0){r=t.CheckerboardTexture.texture}if(a===void 0){a=t.CheckerboardTexture.texture}if(n===void 0){n=t.CheckerboardTexture.texture}if(o===void 0){o=t.CheckerboardTexture.texture}e.call(this);this.uvs=new Float32Array(8);this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("terrainRGBA_fragment");this.controlTex=i;this.splat_0=r;this.splat_1=a;this.splat_2=n;this.splat_3=o;this.uvs[0]=1;this.uvs[1]=1;this.uvs[2]=1;this.uvs[3]=1;this.uvs[4]=1;this.uvs[5]=1;this.uvs[6]=1;this.uvs[7]=1}i.prototype.setUVTitling=function(t,e,i){this.uvs[t*2]=e;this.uvs[t*2+1]=i};Object.defineProperty(i.prototype,"splat_0_Texture",{set:function(t){this.splat_0=t;this.materialData.splat_0Tex=t;this.materialData.textureChange=true},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"splat_1_Texture",{set:function(t){this.splat_1=t;this.materialData.splat_1Tex=t;this.materialData.textureChange=true},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"splat_2_Texture",{set:function(t){this.splat_2=t;this.materialData.splat_2Tex=t;this.materialData.textureChange=true},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"splat_3_Texture",{set:function(t){this.splat_3=t;this.materialData.splat_3Tex=t;this.materialData.textureChange=true},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"controlTexture",{set:function(t){this.controlTex=t;this.materialData.blendMaskTexture=t;this.materialData.textureChange=true},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["uvs"]=a.getUniformLocation(i.program3D,"uvs")};i.prototype.activeState=function(t,e,i,r,a,n,o){a.uniform1fv(i["uvs"],this.uvs)};i.prototype.dispose=function(){};return i}(t.MethodBase);t.TerrainARGBMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i="expHeightFog_fs"}e.call(this);this.uniform_globalFog=new Float32Array(7);this._fogColor=204;this._globalDensity=1;this._fogStartDistance=1e3;this._fogDistanceScale=.5;this._height=500;this._fogAlpha=1;this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[];this.vsShaderList[t.ShaderPhaseType.local_vertex].push("vertexPos_vs");if(i=="line"){this.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("lineFog")}else if(i=="exp"){this.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("expFog_fs")}else if(i=="expHeightFog_fs"){this.fsShaderList[t.ShaderPhaseType.lighting_fragment]=this.fsShaderList[t.ShaderPhaseType.lighting_fragment]||[];this.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("expHeightFog_fs")}this.uniform_globalFog[0]=.5;this.uniform_globalFog[1]=.6;this.uniform_globalFog[2]=.7;this.uniform_globalFog[3]=this._globalDensity;this.uniform_globalFog[4]=this._fogStartDistance;this.uniform_globalFog[5]=this._height;this.uniform_globalFog[6]=this._fogAlpha}Object.defineProperty(i.prototype,"fogColor",{get:function(){return this.fogColor},set:function(t){this._fogColor=t;this.uniform_globalFog[0]=(this._fogColor>>16&255)/255;this.uniform_globalFog[1]=(this._fogColor>>8&255)/255;this.uniform_globalFog[2]=(this._fogColor&255)/255},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(t){this._globalDensity=t;this.uniform_globalFog[3]=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fogStartDistance",{get:function(){return this._fogStartDistance},set:function(t){this._fogStartDistance=t;this.uniform_globalFog[4]=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fogHeight",{get:function(){return this._height},set:function(t){this._height=t;this.uniform_globalFog[5]=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fogAlpha",{get:function(){return this._height},set:function(t){this._height=t;this.uniform_globalFog[6]=t},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["uniform_globalFog"]=a.getUniformLocation(i.program3D,"uniform_globalFog")};i.prototype.activeState=function(t,e,i,r,a,n,o){a.uniform1fv(i["uniform_globalFog"],this.uniform_globalFog)};i.prototype.dispose=function(){};return i}(t.MethodBase);t.FogMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.uniform_globalFog=new Float32Array(7);this._fogColor=204;this._fogStartDistance=100;this._fogFarDistance=1e3;this._fogAlpha=1;this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[];this.vsShaderList[t.ShaderPhaseType.local_vertex].push("vertexPos_vs");this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[];this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("lineFog");this.uniform_globalFog[0]=.5;this.uniform_globalFog[1]=.6;this.uniform_globalFog[2]=.7;this.uniform_globalFog[3]=1;this.uniform_globalFog[4]=this._fogStartDistance;this.uniform_globalFog[5]=this._fogFarDistance;this.uniform_globalFog[6]=this._fogAlpha}Object.defineProperty(i.prototype,"fogColor",{get:function(){return this.fogColor},set:function(t){this._fogColor=t;this.uniform_globalFog[0]=(this._fogColor>>16&255)/255;this.uniform_globalFog[1]=(this._fogColor>>8&255)/255;this.uniform_globalFog[2]=(this._fogColor&255)/255},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fogStartDistance",{get:function(){return this._fogStartDistance},set:function(t){this._fogStartDistance=t;this.uniform_globalFog[4]=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fogFarDistance",{get:function(){return this._fogFarDistance},set:function(t){this._fogFarDistance=t;this.uniform_globalFog[5]=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fogAlpha",{get:function(){return this._fogAlpha},set:function(t){this._fogAlpha=t;this.uniform_globalFog[6]=t},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["uniform_globalFog"]=a.getUniformLocation(i.program3D,"uniform_globalFog")};i.prototype.activeState=function(t,e,i,r,a,n,o){a.uniform1fv(i["uniform_globalFog"],this.uniform_globalFog)};i.prototype.dispose=function(){};return i}(t.MethodBase);t.LineFogMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._uvRoll=new Float32Array(2);this._speedU=5e-5;this._speedV=0;this._time=0;this._start=false;this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvRoll_fs")}Object.defineProperty(i.prototype,"speedU",{get:function(){return this._speedU},set:function(t){this._speedU=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"speedV",{get:function(){return this._speedV},set:function(t){this._speedV=t},enumerable:true,configurable:true});i.prototype.start=function(t){if(t===void 0){t=false}if(t)this._time=0;this._start=true};i.prototype.stop=function(){this._start=false};i.prototype.upload=function(t,e,i,r,a,n,o){i["uvRoll"]=a.getUniformLocation(i.program3D,"uvRoll")};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._start){this._time+=e}this._uvRoll[0]=this._time*this._speedU;this._uvRoll[1]=this._time*this._speedV;a.uniform1fv(i["uvRoll"],this._uvRoll)};return i}(t.MethodBase);t.UVRollMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._uvRoll=new Float32Array(4);this._uvSpeed=new Float32Array(4);this._time=0;this._start=false;this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("mulUvRoll_fs");this._uvSpeed[0]=5e-5;this._uvSpeed[1]=0;this._uvSpeed[2]=5e-5;this._uvSpeed[3]=0}i.prototype.setSpeedU=function(t,e){this._uvSpeed[t*2+0]=e};i.prototype.getSpeedU=function(t){return this._uvSpeed[t*2+0]};i.prototype.setSpeedV=function(t,e){this._uvSpeed[t*2+1]=e};i.prototype.getSpeedV=function(t){return this._uvSpeed[t*2+1]};i.prototype.start=function(t){if(t===void 0){t=false}if(t)this._time=0;this._start=true};i.prototype.stop=function(){this._start=false};Object.defineProperty(i.prototype,"diffuseTexture1",{get:function(){return this._diffuseTexture1},set:function(t){this._diffuseTexture1=t;this.materialData["diffuseTexture1"]=t;this.materialData.textureChange=true},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["mulUvRoll"]=a.getUniformLocation(i.program3D,"mulUvRoll")};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._start){this._time+=e}for(var s=0;s<4;++s){this._uvRoll[s]=this._time*this._uvSpeed[s]}a.uniform1fv(i["mulUvRoll"],this._uvRoll)};return i}(t.MethodBase);t.MulUVRollMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n){if(n===void 0){n=true}e.call(this);this._isRandom=true;this._multiData=new Float32Array(4);this._multiData[0]=i;this._multiData[1]=r;this._multiData[2]=a;this._isRandom=n;this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("MultiUVSprite_fs")}Object.defineProperty(i.prototype,"row",{get:function(){return this._multiData[0]},set:function(t){this._multiData[0]=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"column",{get:function(){return this._multiData[1]},set:function(t){this._multiData[1]=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"sum",{get:function(){return this._multiData[2]},set:function(t){this._multiData[2]=t},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["multiUV"]=a.getUniformLocation(i.program3D,"multiUV");if(this._isRandom)this._multiData[3]=Math.floor(Math.random()*this.sum)};i.prototype.activeState=function(t,e,i,r,a,n,o){a.uniform4fv(i["multiUV"],this._multiData)};return i}(t.MethodBase);t.MultiUVSpriteMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n){e.call(this);this._uvSpriteSheet=new Float32Array(4);this._uvRectangle=new t.Rectangle;this._speed=0;this._time=0;this._numTime=.4;this._start=false;this._frameNum=12;this._row=4;this._column=4;this._currentFrame=0;this.frameList=[];this._change=true;this._delayTime=0;this._isLoop=true;this._currentDelay=0;this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvSpriteSheet_fs");this.frameNum=i;this.row=r;this.column=a;this.numTime=n}i.prototype.caculate=function(){this._change=false;this._speed=this._numTime*1e3/this._frameNum;this._uvRectangle.x=0;this._uvRectangle.y=0;this._uvRectangle.width=1/this._row;this._uvRectangle.height=1/this._column;this.frameList.length=this._frameNum;var e=0;var i=0;for(var r=0;r<this._frameNum;r++){e=r%this._row;i=Math.floor(r/this._column);var a=new t.Rectangle;a.x=e*this._uvRectangle.width+this._uvRectangle.x;a.y=i*this._uvRectangle.height+this._uvRectangle.y;a.width=this._uvRectangle.width;a.height=this._uvRectangle.height;this.frameList[r]=a}};Object.defineProperty(i.prototype,"numTime",{get:function(){return this._numTime},set:function(t){if(this._numTime!=t){this._change=true;this._numTime=t}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"frameNum",{get:function(){return this._frameNum},set:function(t){if(this._frameNum!=t){this._change=true;this._frameNum=t}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"row",{get:function(){return this._row},set:function(t){if(this._row!=t){this._change=true;this._row=t}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"column",{get:function(){return this._column},set:function(t){if(this._column!=t){this._change=true;this._column=t}},enumerable:true,configurable:true});i.prototype.start=function(t){if(t===void 0){t=false}if(t){this._time=0;this._currentDelay=0;this._currentFrame=0}this._start=true};i.prototype.stop=function(){this._start=false};Object.defineProperty(i.prototype,"delayTime",{get:function(){return this._delayTime/1e3},set:function(t){if(this._delayTime!=t){this._change=true;this._delayTime=t*1e3;this._currentDelay=0}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"isLoop",{get:function(){return this._isLoop},set:function(t){if(this._isLoop!=t){this._change=true;this._isLoop=t}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"currentFrame",{get:function(){return this._currentFrame},set:function(t){this._currentFrame=t},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["uvSpriteSheet"]=a.getUniformLocation(i.program3D,"uvSpriteSheet")};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._change)this.caculate();if(this._start){this._currentDelay+=e;if(this._currentDelay>=this._delayTime){this._time+=e;if(this._time/this._speed>1){if(this._currentFrame+1>=this._frameNum){if(this._isLoop){this._currentFrame=0}else{this._start=false}}else{this._currentFrame++}this._time=0}}}this._currentFrame=this._currentFrame%this._frameNum;this._uvSpriteSheet[0]=this.frameList[this._currentFrame].x;this._uvSpriteSheet[1]=this.frameList[this._currentFrame].y;this._uvSpriteSheet[2]=this.frameList[this._currentFrame].width;this._uvSpriteSheet[3]=this.frameList[this._currentFrame].height;a.uniform1fv(i["uvSpriteSheet"],this._uvSpriteSheet)};return i}(t.MethodBase);t.UVSpriteSheetMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=true}e.call(this);this._globalColorData=new Float32Array(3);this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[];this.vsShaderList[t.ShaderPhaseType.local_vertex].push("secondaryUV_vs");this.fsShaderList[t.ShaderPhaseType.lighting_fragment]=this.fsShaderList[t.ShaderPhaseType.lighting_fragment]||[];this.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("lightingBase_fs");if(i){this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[];this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("lightMapSpecularPower_fs")}else{this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[];this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("lightMap_fs")}}Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t;if(this.materialData.lightTexture!=this.texture){this.materialData.lightTexture=this.texture;this.materialData.lightTexture.useMipmap=false;this.materialData.lightTexture.smooth=true;this.materialData.textureChange=true}},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){};i.prototype.activeState=function(t,e,i,r,a,n,o){};return i}(t.MethodBase);t.LightmapMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._speed=new t.Vector3D;this._time=0;this._windData=new Float32Array(4);this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[];this.vsShaderList[t.ShaderPhaseType.local_vertex].push("detail_Bending_vs")}Object.defineProperty(i.prototype,"windDirAndSpeed",{get:function(){return this._speed},set:function(t){this._speed=t;this._windData[1]=t.x;this._windData[2]=t.y;this._windData[3]=t.z},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["uniformTime"]=a.getUniformLocation(i.program3D,"uniformTime")};i.prototype.activeState=function(t,e,i,r,a,n,o){this._time+=e;this._windData[0]=this._time;a.uniform1fv(i["uniformTime"],this._windData)};return i}(t.MethodBase);t.PlantDistortedMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[];this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("alphaMask_fs")}Object.defineProperty(i.prototype,"maskTexture",{set:function(t){this.texture=t;this.materialData.maskTexture=this.texture;this.materialData.textureChange=true},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){};i.prototype.activeState=function(t,e,i,r,a,n,o){};return i}(t.MethodBase);t.AlphaMaskMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.aoPower=1;this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[];this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("AOMap_fs")}Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t;this.materialData.aoTexture=this.texture;this.materialData.textureChange=true},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["aoPower"]=a.getUniformLocation(i.program3D,"aoPower")};i.prototype.activeState=function(t,e,i,r,a,n,o){a.uniform1f(i["aoPower"],this.aoPower)};i.prototype.dispose=function(){};return i}(t.MethodBase);t.AOMapMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[];this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("colorTransform_fs")}Object.defineProperty(i.prototype,"colorTransform",{get:function(){return this.materialData.colorTransform},set:function(t){this.materialData.colorTransform=t},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["uniform_colorTransformAlpha"]=a.getUniformLocation(i.program3D,"uniform_colorTransformAlpha");i["uniform_colorTransformM44"]=a.getUniformLocation(i.program3D,"uniform_colorTransformM44")};i.prototype.activeState=function(t,e,i,r,a,n,o){a.uniform1f(i["uniform_colorTransformAlpha"],this.colorTransform.alpha);a.uniformMatrix4fv(i["uniform_colorTransformM44"],false,this.colorTransform.m44.rawData)};return i}(t.MethodBase);t.ColorTransformMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._posStart=0;this._posEnd=0;this._color=new t.Color;this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[];this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("colorGradients_fs")}i.prototype.setStartData=function(t,e,i){this._color.copyFrom(i);this._posStart=t;this._posEnd=e};i.prototype.upload=function(t,e,i,r,a,n,o){i["uniform_colorGradientsSource"]=a.getUniformLocation(i.program3D,"uniform_colorGradientsSource")};i.prototype.activeState=function(t,e,i,r,a,n,o){this.materialData.colorGradientsSource[0]=this._posStart;this.materialData.colorGradientsSource[1]=this._posEnd;this.materialData.colorGradientsSource[2]=this._color.r;this.materialData.colorGradientsSource[3]=this._color.g;this.materialData.colorGradientsSource[4]=this._color.b;this.materialData.colorGradientsSource[5]=this._color.a;a.uniform1fv(i["uniform_colorGradientsSource"],this.materialData.colorGradientsSource)};return i}(t.MethodBase);t.ColorGradientsMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._uvRoll=new Float32Array(3);this._speedU=1e-4;this._speedV=1e-4;this._intensity=.9;this._time=0;this._start=false;this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvStreamerRoll_fs");this.start()}Object.defineProperty(i.prototype,"speedU",{get:function(){return this._speedU},set:function(t){this._speedU=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"speedV",{get:function(){return this._speedV},set:function(t){this._speedV=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"steamerTexture",{get:function(){return this._steamerTexture},set:function(t){this._steamerTexture=t;this.materialData["streamerTexture"]=t;this.materialData.textureChange=true},enumerable:true,configurable:true});i.prototype.start=function(t){if(t===void 0){t=false}if(t)this._time=0;this._start=true};i.prototype.stop=function(){this._start=false};i.prototype.upload=function(t,e,i,r,a,n,o){i["uvRoll"]=a.getUniformLocation(i.program3D,"uvRoll")};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._start){this._time+=e}this._uvRoll[0]=this._time*this._speedU;this._uvRoll[1]=this._time*this._speedV;this._uvRoll[2]=this._intensity;a.uniform1fv(i["uvRoll"],this._uvRoll)};return i}(t.MethodBase);t.StreamerMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=null}e.call(this);if(i)this.materialData=i;this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[];this.vsShaderList[t.ShaderPhaseType.local_vertex].push("shadowMapping_vs");this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[];this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("shadowMapping_fs")}Object.defineProperty(i.prototype,"shadowMapTexture",{get:function(){return this.materialData.shadowMapTexture},set:function(t){if(this.materialData.shadowMapTexture!=t){this.materialData.shadowMapTexture=t;this.materialData.textureChange=true}},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o,s){if(i.uniform_ShadowMatrix){i.uniform_ShadowMatrix.uniformIndex=a.getUniformLocation(i.program3D,"uniform_ShadowMatrix")}};i.prototype.activeState=function(e,i,r,a,n,o,s,h){var u=h.renderDictionary[t.PassType.shadowPass].camera;if(u){if(r.uniform_ShadowMatrix&&r.uniform_ShadowMatrix.uniformIndex){n.uniformMatrix4fv(r.uniform_ShadowMatrix.uniformIndex,false,u.viewProjectionMatrix.rawData)}}n.uniform4fv(r.uniform_ShadowColor.uniformIndex,this.materialData.shadowColor)};return i}(t.MethodBase);t.ShadowMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.vsShaderList[t.ShaderPhaseType.global_vertex]=this.fsShaderList[t.ShaderPhaseType.global_vertex]||[];this.vsShaderList[t.ShaderPhaseType.global_vertex].push("cube_vertex");this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("cube_fragment")}i.prototype.upload=function(t,e,i,r,a,n,o){};i.prototype.activeState=function(t,e,i,r,a,n,o){};return i}(t.MethodBase);t.CubeMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("color_fragment")}i.prototype.upload=function(t,e,i,r,a,n,o){};i.prototype.activeState=function(t,e,i,r,a,n,o){};return i}(t.MethodBase);t.ColorMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._waveVSData=new Float32Array(12);this._waveFSData=new Float32Array(8);this._time=0;this._start=false;this._wave_xyz_intensity_0=new t.Vector3D(120,50,70);this._wave_xyz_intensity_1=new t.Vector3D(80,40,80);this._wave_xyz_speed_0=new t.Vector3D(.001,.001,-.001);this._wave_xyz_speed_1=new t.Vector3D(.001,.001,.001);this.vsShaderList[t.ShaderPhaseType.start_vertex]=this.vsShaderList[t.ShaderPhaseType.start_vertex]||[];this.vsShaderList[t.ShaderPhaseType.start_vertex].push("wave_vs");this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[];this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("wave_fs");this.start();this._waveVSData[0]=this._wave_xyz_intensity_0.x;this._waveVSData[1]=this._wave_xyz_intensity_0.y;this._waveVSData[2]=this._wave_xyz_intensity_0.z;this._waveVSData[3]=this._wave_xyz_intensity_1.x;this._waveVSData[4]=this._wave_xyz_intensity_1.y;this._waveVSData[5]=this._wave_xyz_intensity_1.z;this._waveVSData[6]=this._wave_xyz_speed_0.x;this._waveVSData[7]=this._wave_xyz_speed_0.y;this._waveVSData[8]=this._wave_xyz_speed_0.z;this._waveVSData[9]=this._wave_xyz_speed_1.x;this._waveVSData[10]=this._wave_xyz_speed_1.y;this._waveVSData[11]=this._wave_xyz_speed_1.z;this._waveFSData[0]=0/255;this._waveFSData[1]=63/255;this._waveFSData[2]=77/255;this._waveFSData[3]=1;this._waveFSData[4]=71/255;this._waveFSData[5]=118/255;this._waveFSData[6]=138/255;this._waveFSData[7]=1}Object.defineProperty(i.prototype,"deepWaterColor",{get:function(){var t=this._waveFSData[0]*255;var e=this._waveFSData[1]*255;var i=this._waveFSData[2]*255;var r=this._waveFSData[3]*255;return r<<24|t<<16|e<<8|i},set:function(t){var e=t>>24&255;var i=t>>16&255;var r=t>>8&255;var a=t&255;this._waveFSData[0]=i/255;this._waveFSData[1]=r/255;this._waveFSData[2]=a/255;this._waveFSData[3]=e/255},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"shallowWaterColor",{get:function(){var t=this._waveFSData[4]*255;var e=this._waveFSData[5]*255;var i=this._waveFSData[6]*255;var r=this._waveFSData[7]*255;return r<<24|t<<16|e<<8|i},set:function(t){var e=t>>24&255;var i=t>>16&255;var r=t>>8&255;var a=t&255;this._waveFSData[4]=i/255;this._waveFSData[5]=r/255;this._waveFSData[6]=a/255;this._waveFSData[7]=e/255},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"waveTexture",{set:function(t){this._waveTexture=t;if(t){if(this.materialData["waveTexture"]!=this._waveTexture){this.materialData["waveTexture"]=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});i.prototype.start=function(t){if(t===void 0){t=false}if(t)this._time=0;this._start=true};i.prototype.stop=function(){this._start=false};i.prototype.upload=function(t,e,i,r,a,n,o){i["waveVSData"]=a.getUniformLocation(i.program3D,"waveVSData");i["waveFSData"]=a.getUniformLocation(i.program3D,"waveFSData");i["time"]=a.getUniformLocation(i.program3D,"time")};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._start){this._time+=e}a.uniform3fv(i["waveVSData"],this._waveVSData);a.uniform4fv(i["waveFSData"],this._waveFSData);a.uniform1f(i["time"],this._time)};return i}(t.MethodBase);t.WaterWaveMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._uvData=new Float32Array(8);this._time=0;this._start=false;this._speedU_0=new t.Point(-5e-6,0);this._speedU_1=new t.Point(1e-5,0);this._distion_intensity=new t.Point(.02,.02);this._normal_0_UVScale=2;this._normal_1_UVScale=2;this.fsShaderList[t.ShaderPhaseType.normal_fragment]=this.fsShaderList[t.ShaderPhaseType.normal_fragment]||[];this.fsShaderList[t.ShaderPhaseType.normal_fragment].push("waterNormal_fs");this.start();this._uvData[0]=this._speedU_0.x*2.5;this._uvData[1]=this._speedU_0.y*2.5;this._uvData[2]=this._speedU_1.x*2.5;this._uvData[3]=this._speedU_1.y*2.5;this._uvData[4]=this._distion_intensity.x;this._uvData[5]=this._distion_intensity.y;this._uvData[6]=this._normal_0_UVScale;this._uvData[7]=this._normal_1_UVScale}i.prototype.start=function(t){if(t===void 0){t=false}if(t)this._time=0;this._start=true};i.prototype.stop=function(){this._start=false};i.prototype.setUvSpeed=function(t,e,i){switch(t){case 0:this._speedU_0.x=e;this._speedU_0.y=i;this._uvData[0]=this._speedU_0.x*2.5;this._uvData[1]=this._speedU_0.y*2.5;break;case 1:this._speedU_1.x=e;this._speedU_1.y=i;this._uvData[2]=this._speedU_1.x*2.5;this._uvData[3]=this._speedU_1.y*2.5;break}};i.prototype.setUvScale=function(t,e){this._normal_0_UVScale=t;this._normal_1_UVScale=e;this._uvData[6]=this._normal_0_UVScale;this._uvData[7]=this._normal_1_UVScale};Object.defineProperty(i.prototype,"normalTextureA",{set:function(t){this._normalTexture_0=t;if(this.materialData["normalTextureA"]!=this._normalTexture_0){this.materialData["normalTextureA"]=this._normalTexture_0;this.materialData.textureChange=true}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"normalTextureB",{set:function(t){this._normalTexture_1=t;if(this.materialData["normalTextureB"]!=this._normalTexture_1){this.materialData["normalTextureB"]=this._normalTexture_1;this.materialData.textureChange=true}},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["waterNormalData"]=a.getUniformLocation(i.program3D,"waterNormalData");i["time"]=a.getUniformLocation(i.program3D,"time")};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._start){this._time+=e}a.uniform2fv(i["waterNormalData"],this._uvData);a.uniform1f(i["time"],this._time)};return i}(t.MethodBase);t.WaterNormalMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.reflectValue=.3;this.fsShaderList[t.ShaderPhaseType.lighting_fragment]=this.fsShaderList[t.ShaderPhaseType.lighting_fragment]||[];this.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("environmentMapping_fragment")}Object.defineProperty(i.prototype,"reflect",{get:function(){return this.reflectValue},set:function(t){this.reflectValue=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"environmentTexture",{set:function(t){this.texture=t;if(t){if(this.materialData["environmentMapTex"]!=this.texture){this.materialData["environmentMapTex"]=t;this.materialData.textureChange=true}}},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["reflectValue"]=a.getUniformLocation(i.program3D,"reflectValue")};i.prototype.activeState=function(t,e,i,r,a,n,o){a.uniform1f(i["reflectValue"],this.reflectValue)};return i}(t.MethodBase);t.EnvironmentMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.uniform_rimData=new Float32Array(6);this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[];
this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("rimlight_fs");this.uniform_rimData[0]=.99;this.uniform_rimData[1]=0;this.uniform_rimData[2]=0;this.uniform_rimData[3]=1;this.uniform_rimData[4]=5;this.uniform_rimData[5]=1}Object.defineProperty(i.prototype,"rimColor",{get:function(){return t.Color.RGBAToColor(this.uniform_rimData[0],this.uniform_rimData[1],this.uniform_rimData[2],this.uniform_rimData[3])},set:function(e){var i=t.Color.getColor(e);this.uniform_rimData[0]=i.x;this.uniform_rimData[1]=i.y;this.uniform_rimData[2]=i.z;this.uniform_rimData[3]=i.w},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rimPow",{get:function(){return this.uniform_rimData[4]},set:function(t){this.uniform_rimData[4]=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"strength",{get:function(){return this.uniform_rimData[5]},set:function(t){this.uniform_rimData[5]=t},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["uniform_rimData"]=a.getUniformLocation(i.program3D,"uniform_rimData")};i.prototype.activeState=function(t,e,i,r,a,n,o){a.uniform1fv(i["uniform_rimData"],this.uniform_rimData)};i.prototype.dispose=function(){};return i}(t.MethodBase);t.RimlightMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a){e.call(this,null,r);r.bothside=true;this._method=new t.GrassMethod(a);r.diffusePass.addMethod(this._method);this._data=a;this._birthPoints=i;this._count=i.length;this._plantShape=new t.PlaneGeometry(1,1,1,1,1,1,t.Vector3D.Z_AXIS,true,false);this.initialize();this.initBoudBox(new t.Vector3D(t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE))}Object.defineProperty(i.prototype,"method",{get:function(){return this._method},enumerable:true,configurable:true});i.prototype.initialize=function(){this.geometry=new t.Geometry;this.geometry.buildDefaultSubGeometry();this.geometry.subGeometrys[0].count=this._count*this._plantShape.indexCount;var e=0;var i=[];var r=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_UV0|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_NORMAL;this.geometry.vertexFormat=r;this.initGeometryAttr(this.geometry);this.geometry.vertexCount=this._count*this._plantShape.vertexCount;this.geometry.indexCount=this._count*this._plantShape.indexCount;this._plantShape.getVertexForIndex(0,r,i,this._plantShape.vertexCount);for(var a=0;a<this._count;++a){e=a*this._plantShape.vertexCount;this.geometry.setVerticesForIndex(e,r,i,this._plantShape.vertexCount)}for(var a=0;a<this._count;++a){for(var n=0;n<this._plantShape.indexArray.length;++n){this.geometry.indexArray[a*this._plantShape.indexArray.length+n]=this._plantShape.indexArray[n]+a*this._plantShape.vertexCount}}this.initPostionData(this.geometry,this._count)};i.prototype.initGeometryAttr=function(e){this._attrPosition=new t.GLSL.VarRegister;this._attrPosition.name="attribute_grassOffset";this._attrPosition.size=3;var i=e.vertexAttLength;this._attrPosition.offsetIndex=i;e.vertexAttLength+=this._attrPosition.size;e.vertexSizeInBytes+=this._attrPosition.size*4;e.subGeometrys[0].preAttList.push(this._attrPosition);this._attrAngleY=new t.GLSL.VarRegister;this._attrAngleY.name="attribute_grassAngleY";this._attrAngleY.size=1;var i=e.vertexAttLength;this._attrAngleY.offsetIndex=i;e.vertexAttLength+=this._attrAngleY.size;e.vertexSizeInBytes+=this._attrAngleY.size*4;e.subGeometrys[0].preAttList.push(this._attrAngleY)};i.prototype.initBoudBox=function(e){var i=new t.BoundBox(this);i.fillBox(new t.Vector3D(-e.x/2,-e.y/2,-e.z/2),new t.Vector3D(e.x/2,e.y/2,e.z/2));this.bound=i;this.initAABB()};i.prototype.update=function(t,i,r){e.prototype.update.call(this,t,i,r)};i.prototype.initPostionData=function(e,i){var r=this._birthPoints;var a=e.vertexCount/i;var n=0;var o=this._attrPosition.offsetIndex;for(var s=0;s<i;++s){var h=r[s];for(var u=0;u<a;++u){n=s*a+u;n=n*e.vertexAttLength+o;e.vertexArray[n+0]=h.x;e.vertexArray[n+1]=h.y;e.vertexArray[n+2]=h.z}}var l;var c;var f=0;if(this._data.maxWidth!=1||this._data.minWidth!=1||this._data.maxHeight!=1||this._data.minHeight!=1){for(var s=0;s<i;++s){l=t.MathUtil.mix(this._data.minWidth,this._data.maxWidth,Math.random());c=t.MathUtil.mix(this._data.minHeight,this._data.maxHeight,Math.random());for(var u=0;u<a;++u){n=s*a+u;n=n*e.vertexAttLength+0;e.vertexArray[n+0]*=l;e.vertexArray[n+1]*=c}}}var d=6;var p=new t.Color;var _;var m;var v;var g;var y=Math.abs(this._data.noiseSpread)*10;var x=1/255;var b=new t.Color;var D=new t.Color;b.setColorRGB(Number(this._data.healthyColor));D.setColorRGB(Number(this._data.dryColor));for(var s=0;s<i;++s){_=Math.random()*y;if(_>1){_=1}_*=_;p.lerp(b,D,_);p.scaleBy(x);for(var u=0;u<a;++u){n=s*a+u;n=n*e.vertexAttLength+d;e.vertexArray[n+0]*=p.r;e.vertexArray[n+1]*=p.g;e.vertexArray[n+2]*=p.b;e.vertexArray[n+3]=1}}if(!this._data.billboard){var T=this._attrAngleY.offsetIndex;var P;for(var s=0;s<i;++s){P=Math.random()*2*Math.PI;for(var u=0;u<a;++u){n=s*a+u;n=n*e.vertexAttLength+T;e.vertexArray[n+0]=P}}}this.billboard=this._data.billboard?t.BillboardType.Y_AXIS:t.BillboardType.DISABLE};i.prototype.clone=function(){var t;t=new i(this._birthPoints.slice(),this.material,this._data);t.position=this.position;t.orientation=this.orientation;t.scale=this.scale;return t};i.prototype.dispose=function(){e.prototype.dispose.call(this);if(this._plantShape){this._plantShape.dispose();this._plantShape=null}this._birthPoints=null;this._data=null};return i}(t.Mesh);t.GrassMesh=e;var i=function(){function t(){this.minWidth=100;this.maxWidth=100;this.minHeight=100;this.maxHeight=100;this.noiseSpread=0;this.billboard=true}return t}();t.GrassData=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this);this._time=0;this._windSpeed=200;this._windStrength=.2;this._shakeScale=.1;this._windDirection=new t.Vector3D(1,0,0);this._windSpace=new t.Vector3D(400,0,300);this._windData=new Float32Array(9);this._squeezeData=new Float32Array(6);this._lightMapData=new Float32Array(5);this._lightMapTexture=t.CheckerboardTexture.texture;this._data=i;this.vsShaderList[t.ShaderPhaseType.start_vertex]=this.vsShaderList[t.ShaderPhaseType.start_vertex]||[];this.vsShaderList[t.ShaderPhaseType.start_vertex].push("grass_vs");this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[];this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("grass_fs");this.fillGrassData();this.start()}i.prototype.setLightMapData=function(e,i){this._lightMapRect=i;this._lightMapTexture=e||t.CheckerboardTexture.texture;this.updateLightMapData()};i.prototype.updateLightMapData=function(){if(!this._lightMapTexture||this._lightMapTexture==t.CheckerboardTexture.texture||!this._lightMapRect){this._lightMapData[0]=0}else{this._lightMapData[0]=1;this._lightMapData[1]=this._lightMapRect.x;this._lightMapData[2]=this._lightMapRect.y;this._lightMapData[3]=this._lightMapRect.width;this._lightMapData[4]=this._lightMapRect.height}this.materialData["lightMapTexture"]=this._lightMapTexture;this.materialData.textureChange=true};i.prototype.setWind=function(t,e,i,r,a){if(i===void 0){i=100}if(r===void 0){r=.1}if(a===void 0){a=1}t.y=0;this._windDirection.copyFrom(t);this._windDirection.normalize();this._windSpace.copyFrom(e);this._windStrength=r;this._windSpeed=i;this._shakeScale=a;this.fillGrassData()};i.prototype.updateSqueezeData=function(t,e,i,r){if(i===void 0){i=20}if(r===void 0){r=1}this._squeezeData[0]=e?1:0;this._squeezeData[1]=t.x;this._squeezeData[2]=t.y;this._squeezeData[3]=t.z;this._squeezeData[4]=i;this._squeezeData[5]=r};i.prototype.fillGrassData=function(){this._windData[0]=this._windDirection.x;this._windData[1]=this._windDirection.z;this._windData[2]=this._windSpace.x;this._windData[3]=this._windSpace.z;this._windData[4]=this._windStrength;this._windData[5]=this._windSpeed;this._windData[6]=this._shakeScale};i.prototype.start=function(t){if(t===void 0){t=false}if(t)this._time=0;this._start=true};i.prototype.stop=function(){this._start=false};i.prototype.upload=function(t,e,i,r,a,n,o){i["uniform_grass_data"].uniformIndex=a.getUniformLocation(i.program3D,"uniform_grass_data");i["uniform_squeeze_data"].uniformIndex=a.getUniformLocation(i.program3D,"uniform_squeeze_data");i["uniform_lightMap_data"].uniformIndex=a.getUniformLocation(i.program3D,"uniform_lightMap_data")};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._start){this._time+=e}this._windData[7]=this._time/1e3;this._windData[8]=this._data.billboard?1:0;a.uniform1fv(i["uniform_grass_data"].uniformIndex,this._windData);a.uniform1fv(i["uniform_squeeze_data"].uniformIndex,this._squeezeData);a.uniform1fv(i["uniform_lightMap_data"].uniformIndex,this._lightMapData)};return i}(t.MethodBase);t.GrassMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._uvData=new Float32Array(8);this._horizonColor=new Float32Array(4);this._time=0;this._start=false;this._distion_intensity=new t.Point(.02,.02);this.fsShaderList[t.ShaderPhaseType.normal_fragment]=this.fsShaderList[t.ShaderPhaseType.normal_fragment]||[];this.fsShaderList[t.ShaderPhaseType.normal_fragment].push("waterBump_fs");this.start();this._horizonColor[0]=217/255;this._horizonColor[1]=235/255;this._horizonColor[2]=255/255;this._horizonColor[3]=255/255;this._uvData[0]=-5e-6*2.5;this._uvData[1]=0*2.5;this._uvData[2]=1e-5*2.5;this._uvData[3]=0*2.5;this._uvData[4]=this._distion_intensity.x;this._uvData[5]=this._distion_intensity.y;this._uvData[6]=1;this._uvData[7]=1}i.prototype.start=function(t){if(t===void 0){t=false}if(t)this._time=0;this._start=true};i.prototype.stop=function(){this._start=false};i.prototype.setUvSpeed=function(t,e,i){switch(t){case 0:this._uvData[0]=e;this._uvData[1]=i;break;case 1:this._uvData[2]=e;this._uvData[3]=i;break}};i.prototype.setUvScale=function(t,e){};Object.defineProperty(i.prototype,"bumpTexture",{set:function(t){this._bumpTexture=t;if(this.materialData["bumpTexture"]!=this._bumpTexture){this.materialData["bumpTexture"]=this._bumpTexture;this.materialData.textureChange=true}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"colorTexture",{set:function(t){this._colorControlTexture=t;if(this.materialData["colorControlTexture"]!=this._colorControlTexture){this.materialData["colorControlTexture"]=this._colorControlTexture;this.materialData.textureChange=true}},enumerable:true,configurable:true});i.prototype.upload=function(t,e,i,r,a,n,o){i["waterNormalData"]=a.getUniformLocation(i.program3D,"waterNormalData");i["horizonColor"]=a.getUniformLocation(i.program3D,"horizonColor");i["time"]=a.getUniformLocation(i.program3D,"time")};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._start){this._time+=e}a.uniform4fv(i["horizonColor"],this._horizonColor);a.uniform2fv(i["waterNormalData"],this._uvData);a.uniform1f(i["time"],this._time)};return i}(t.MethodBase);t.WaterBumpMethod=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.sampler2DList=new Array;this.sampler3DList=new Array;this.vertexShader=new t.ShaderBase(t.Shader.vertex);this.fragmentShader=new t.ShaderBase(t.Shader.fragment);this.maxDirectLight=0;this.maxSpotLight=0;this.maxPointLight=0;this.maxBone=0;this.attributeDiry=true}e.prototype.dispose=function(){if(this.program3D){this.program3D.dispose()}this.program3D=null;if(this.vertexShader){if(this.vertexShader.shader){this.vertexShader.shader.dispose()}}this.vertexShader=null;if(this.fragmentShader){if(this.fragmentShader.shader){this.fragmentShader.shader.dispose()}}this.fragmentShader=null};return e}();t.PassUsage=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.apply(this,arguments);this.shaderPhaseTypes={};this.matID=0;this.drawMode=t.DrawMode.TRIANGLES;this.useMipmap=true;this.normalTexture=t.CheckerboardTexture.texture;this.matcapTexture=t.CheckerboardTexture.texture;this.specularTexture=t.CheckerboardTexture.texture;this.lightTexture=t.CheckerboardTexture.texture;this.maskTexture=t.CheckerboardTexture.texture;this.aoTexture=t.CheckerboardTexture.texture;this.environmentTexture=t.CheckerboardTexture.texture;this.blendMaskTexture=t.CheckerboardTexture.texture;this.splat_0Tex=t.CheckerboardTexture.texture;this.splat_1Tex=t.CheckerboardTexture.texture;this.splat_2Tex=t.CheckerboardTexture.texture;this.splat_3Tex=t.CheckerboardTexture.texture;this.layer=0;this.castShadow=false;this.acceptShadow=false;this.shadowColor=new Float32Array([.2,.2,.2,.003]);this.depthTest=true;this.depthMode=0;this.blendMode=t.BlendMode.NORMAL;this.alphaBlending=false;this.ambientColor=0;this.diffuseColor=16777215;this.specularColor=16777215;this.tintColor=2155905152;this.specularLevel=1;this.gamma=1;this.refraction=1.9;this.refractionintensity=2;this.gloss=10;this.cutAlpha=0;this.repeat=false;this.bothside=false;this.alpha=1;this.albedo=.95;this.normalDir=-1;this.uvRectangle=new t.Rectangle(0,0,1,1);this.materialDataNeedChange=true;this.textureChange=false;this.textureStateChage=true;this.cullFrontOrBack=t.ContextConfig.BACK;this.materialSourceData=new Float32Array(20);this.colorGradientsSource=new Float32Array(6)}i.prototype.clone=function(){var t=new i;t.drawMode=this.drawMode;t.diffuseTexture=this.diffuseTexture;t.shadowMapTexture=this.shadowMapTexture;for(var e=0;e<4;++e){t.shadowColor[e]=this.shadowColor[e]}t.layer=this.layer;t.castShadow=this.castShadow;t.acceptShadow=this.acceptShadow;t.depthTest=this.depthTest;t.blendMode=this.blendMode;t.blend_src=this.blend_src;t.blend_dest=this.blend_dest;t.ambientColor=this.ambientColor;t.diffuseColor=this.diffuseColor;t.specularColor=this.specularColor;t.cutAlpha=this.cutAlpha;t.alpha=this.alpha;t.specularLevel=this.specularLevel;t.gloss=this.gloss;t.albedo=this.albedo;t.gamma=this.gamma;t.refraction=this.refraction;t.refractionintensity=this.refractionintensity;t.materialDataNeedChange=this.materialDataNeedChange;t.textureChange=true;t.cullFrontOrBack=this.cullFrontOrBack;t.colorTransform=this.colorTransform;return t};i.prototype.dispose=function(){};return i}(Object);t.MaterialData=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t){if(t===void 0){t=null}this._passChange=true;this._vs_shader_methods={};this._fs_shader_methods={};this.methodList=new Array;this.methodDatas=new Array;this.vsShaderNames=new Array;this.fsShaderNames=new Array;this.enable=true;if(t){this.materialData=t}}Object.defineProperty(e.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(e){if(this._lightGroup){this._lightGroup.removeEventListener(t.LightGroup.EVENT_LIGHT_RESET,this.onLightReset,this)}this._lightGroup=e;if(this._lightGroup){this._lightGroup.addEventListener(t.LightGroup.EVENT_LIGHT_RESET,this.onLightReset,this)}},enumerable:true,configurable:true});e.prototype.onLightReset=function(t){this._passChange=true};Object.defineProperty(e.prototype,"materialData",{set:function(t){this._materialData=t},enumerable:true,configurable:true});e.prototype.addMethod=function(t){var e=this.methodList.indexOf(t);if(e==-1){this.methodList.push(t);t.materialData=this._materialData;this._passChange=true}};e.prototype.removeMethod=function(t){var e=this.methodList.indexOf(t);if(e!=-1){this.methodList.splice(e,1);this._passChange=true}};e.prototype.getMethod=function(t){for(var e=0;e<this.methodList.length;++e){if(this.methodList[e]instanceof t){return this.methodList[e]}}return null};e.prototype.addShadowMethod=function(){if(this._materialData.acceptShadow){this._shadowMethod=new t.ShadowMethod(this._materialData);this.addMethod(this._shadowMethod)}};e.prototype.removShadowMethod=function(){if(this._shadowMethod){this.removeMethod(this._shadowMethod);this._shadowMethod.dispose();this._shadowMethod=null}};e.prototype.materialDataChange=function(){this._materialData.materialDataNeedChange=true};e.prototype.passInvalid=function(){this._passChange=true};e.prototype.resetTexture=function(t){var e;for(var i in this._passUsage.sampler2DList){e=this._passUsage.sampler2DList[i];if(this._materialData[e.varName]){e.texture=this._materialData[e.varName]}}var r;for(var i in this._passUsage.sampler3DList){r=this._passUsage.sampler3DList[i];if(this._materialData[r.varName]){r.texture=this._materialData[r.varName]}}this._materialData.textureChange=false};e.prototype.addMethodShaders=function(t,e){for(var i=0;i<e.length;i++){t.addUseShaderName(e[i])}};e.prototype.addShaderPhase=function(e,i,r){var a;var n;var o;for(n in i){a=i[n];for(var s=0;s<a.length;s++){r[n]=r[n]||[];r[n].push(a[s]);o=t.ShaderPhaseType[n];var h=this._materialData.shaderPhaseTypes[e].indexOf(t.ShaderPhaseType[o]);if(h!=-1){this._materialData.shaderPhaseTypes[e].splice(h,1)}}}};e.prototype.initOthreMethods=function(){var t;var e;for(var i=0;i<this.methodList.length;i++){var r=this.methodList[i];for(t in r.vsShaderList){e=r.vsShaderList[t];for(var a=0;a<e.length;a++){this._vs_shader_methods[t]=this._vs_shader_methods[t]||[];this._vs_shader_methods[t].push(e[a])}}for(t in r.fsShaderList){e=r.fsShaderList[t];for(var a=0;a<e.length;a++){this._fs_shader_methods[t]=this._fs_shader_methods[t]||[];this._fs_shader_methods[t].push(e[a])}}}};e.prototype.initUseMethod=function(e,i){this._passChange=false;var r=0;this._passUsage=new t.PassUsage;this._vs_shader_methods={};this._fs_shader_methods={};if(e){if(e.skeletonAnimationController){this._passUsage.maxBone=e.skeletonAnimationController.jointNum*2;this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")}else if(e.particleAnimationController){this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs");this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods);this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods)}}if(this._materialData.acceptShadow){this._vs_shader_methods[t.ShaderPhaseType.global_vertex]=this._vs_shader_methods[t.ShaderPhaseType.global_vertex]||[];this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]=this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]||[]}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment")}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment")}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.specular_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.specular_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.specular_fragment].push("specularMap_fragment")}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.matCap_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment].push("matCap_TextureMult_fs")}if(this.lightGroup){this._passUsage.maxDirectLight=this.lightGroup.directLightList.length;this._passUsage.maxSpotLight=this.lightGroup.spotLightList.length;this._passUsage.maxPointLight=this.lightGroup.pointLightList.length;this._vs_shader_methods[t.ShaderPhaseType.local_vertex]=this._vs_shader_methods[t.ShaderPhaseType.local_vertex]||[];this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("lightingBase_fs");if(this.lightGroup.directLightList.length){this._passUsage.directLightData=new Float32Array(t.DirectLight.stride*this.lightGroup.directLightList.length);this._vs_shader_methods[t.ShaderPhaseType.local_vertex].push("varyingViewDir_vs");this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("directLight_fragment")}if(this.lightGroup.spotLightList.length){this._passUsage.spotLightData=new Float32Array(t.SpotLight.stride*this.lightGroup.spotLightList.length);this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("spotLight_fragment")}if(this.lightGroup.pointLightList.length){this._passUsage.pointLightData=new Float32Array(t.PointLight.stride*this.lightGroup.pointLightList.length);this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("pointLight_fragment")}}this.initOthreMethods();this.phaseEnd(e)};e.prototype.phaseEnd=function(e){var i;i=this._vs_shader_methods[t.ShaderPhaseType.utils_vertex];if(i&&i.length>0)this.addMethodShaders(this._passUsage.vertexShader,i);i=this._vs_shader_methods[t.ShaderPhaseType.base_vertex];if(i&&i.length>0){this.addMethodShaders(this._passUsage.vertexShader,i)}else{this.addMethodShaders(this._passUsage.vertexShader,["base_vs"]);i=this._vs_shader_methods[t.ShaderPhaseType.start_vertex];if(i&&i.length>0)this.addMethodShaders(this._passUsage.vertexShader,i);else this.addMethodShaders(this._passUsage.vertexShader,["diffuse_vertex"]);i=this._vs_shader_methods[t.ShaderPhaseType.local_vertex];if(i&&i.length>0)this.addMethodShaders(this._passUsage.vertexShader,i);i=this._vs_shader_methods[t.ShaderPhaseType.global_vertex];if(i&&i.length>0)this.addMethodShaders(this._passUsage.vertexShader,i);i=this._vs_shader_methods[t.ShaderPhaseType.end_vertex];if(i&&i.length>0)this.addMethodShaders(this._passUsage.vertexShader,i);else this.addMethodShaders(this._passUsage.vertexShader,["end_vs"]);this.addMethodShaders(this._passUsage.vertexShader,["out_vs"])}i=this._fs_shader_methods[t.ShaderPhaseType.utils_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);i=this._fs_shader_methods[t.ShaderPhaseType.base_fragment];if(i&&i.length>0){this.addMethodShaders(this._passUsage.fragmentShader,i)}else{this.addMethodShaders(this._passUsage.fragmentShader,["base_fs"]);i=this._fs_shader_methods[t.ShaderPhaseType.start_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);i=this._fs_shader_methods[t.ShaderPhaseType.materialsource_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);else this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]);i=this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);else this.addMethodShaders(this._passUsage.fragmentShader,["diffuse_fragment"]);i=this._fs_shader_methods[t.ShaderPhaseType.normal_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);i=this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);i=this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);i=this._fs_shader_methods[t.ShaderPhaseType.specular_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);i=this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);i=this._fs_shader_methods[t.ShaderPhaseType.end_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);else{this.addMethodShaders(this._passUsage.fragmentShader,["end_fs"])}i=this._fs_shader_methods[t.ShaderPhaseType.multi_end_fragment];if(i&&i.length>0)this.addMethodShaders(this._passUsage.fragmentShader,i);this.addMethodShaders(this._passUsage.fragmentShader,["out_fs"])}};e.prototype.upload=function(e,i,r,a,n,o,s,h){this._passChange=false;this.initUseMethod(o,s);this._passUsage.vertexShader.shader=this._passUsage.vertexShader.getShader(this._passUsage);this._passUsage.fragmentShader.shader=this._passUsage.fragmentShader.getShader(this._passUsage);this._passUsage.program3D=t.ShaderPool.getProgram(this._passUsage.vertexShader.shader.id,this._passUsage.fragmentShader.shader.id);for(var u in this._passUsage){if(u.indexOf("uniform")!=-1){if(this._passUsage[u]){this._passUsage[u].uniformIndex=r.getUniformLocation(this._passUsage.program3D,u)}}}var l;for(var c in this._passUsage.sampler2DList){l=this._passUsage.sampler2DList[c];l.uniformIndex=r.getUniformLocation(this._passUsage.program3D,l.varName);l.texture=this._materialData[l.varName]}var f;for(var c in this._passUsage.sampler3DList){f=this._passUsage.sampler3DList[c];f.uniformIndex=r.getUniformLocation(this._passUsage.program3D,f.varName)}if(this.methodList){for(var d=0;d<this.methodList.length;d++){this.methodList[d].upload(e,i,this._passUsage,null,r,a,n,h)}}};e.prototype.draw=function(e,i,r,a,n,o,s,h){if(!this.enable)return;if(this._materialData.materialDataNeedChange){var u=this._materialData.tintColor;var l=u>>24&255;var c=u>>16&255;var f=u>>8&255;var d=u&255;l/=128;c/=128;f/=128;d/=128;this._materialData.materialSourceData[0]=c*(this._materialData.diffuseColor>>16&255)/255;this._materialData.materialSourceData[1]=f*(this._materialData.diffuseColor>>8&255)/255;this._materialData.materialSourceData[2]=d*(this._materialData.diffuseColor&255)/255;this._materialData.materialSourceData[3]=(this._materialData.ambientColor>>16&255)/255;this._materialData.materialSourceData[4]=(this._materialData.ambientColor>>8&255)/255;this._materialData.materialSourceData[5]=(this._materialData.ambientColor&255)/255;this._materialData.materialSourceData[6]=(this._materialData.specularColor>>16&255)/255;this._materialData.materialSourceData[7]=(this._materialData.specularColor>>8&255)/255;this._materialData.materialSourceData[8]=(this._materialData.specularColor&255)/255;this._materialData.materialSourceData[9]=l*this._materialData.alpha;this._materialData.materialSourceData[10]=this._materialData.cutAlpha;this._materialData.materialSourceData[11]=this._materialData.gloss;this._materialData.materialSourceData[12]=this._materialData.specularLevel;this._materialData.materialSourceData[13]=this._materialData.uvRectangle.x;this._materialData.materialSourceData[14]=this._materialData.uvRectangle.y;this._materialData.materialSourceData[15]=this._materialData.uvRectangle.width;this._materialData.materialSourceData[16]=this._materialData.uvRectangle.height;this._materialData.materialSourceData[17]=this._materialData.gamma;this._materialData.materialSourceData[18]=this._materialData.refraction;this._materialData.materialSourceData[19]=this._materialData.refractionintensity}if(this._passChange){this.upload(e,i,r,a,n,s.animation,o.geometry,h)}r.setProgram(this._passUsage.program3D);o.activeState(e,i,this._passUsage,r);if(this._materialData.depthTest){r.enableDepth();r.depthFunc(t.ContextConfig.LEQUAL)}else{r.disableDepth();r.depthFunc(t.ContextConfig.LEQUAL)}if(this._materialData.acceptShadow){if(h.renderDictionary[t.PassType.shadowPass]&&this._shadowMethod)this._shadowMethod.shadowMapTexture=h.renderDictionary[t.PassType.shadowPass].renderTexture}r.setCulling(this._materialData.cullFrontOrBack);if(this._materialData.bothside){r.disableCullFace()}else r.enableCullFace();if(this._passID==t.PassType.shadowPass){r.disableBlend();r.setBlendFactors(t.ContextConfig.ONE,t.ContextConfig.ZERO)}else{if(this._materialData.alphaBlending)t.Context3DProxy.gl.depthMask(false);r.enableBlend();r.setBlendFactors(this._materialData.blend_src,this._materialData.blend_dest)}if(this._passUsage.uniform_materialSource){r.uniform1fv(this._passUsage.uniform_materialSource.uniformIndex,this._materialData.materialSourceData)}if(this._materialData.textureChange){this.resetTexture(r)}var p;var _;for(var m in this._passUsage.sampler2DList){p=this._passUsage.sampler2DList[m];p.texture=this._materialData[p.varName];if(!p.texture){continue}_=p.texture.parentTexture?p.texture.parentTexture:p.texture;_.upload(r);r.setTexture2DAt(p.activeTextureIndex,p.uniformIndex,p.index,_.texture2D);if(_.useMipmap)_.useMipmap=this._materialData.useMipmap;_.repeat=this._materialData.repeat;_.activeState(r);this._materialData.textureStateChage=false}var v;for(var m in this._passUsage.sampler3DList){v=this._passUsage.sampler3DList[m];v.texture=this._materialData[v.varName];if(!v.texture){continue}v.texture.upload(r);r.setCubeTextureAt(v.activeTextureIndex,v.uniformIndex,v.index,v.texture.texture3D)}var g=0;if(this.lightGroup){for(g=0;g<this._passUsage.maxDirectLight;g++){this.lightGroup.directLightList[g].updateLightData(n,g,this._passUsage.directLightData)}for(g=0;g<this._passUsage.maxSpotLight;g++){this.lightGroup.spotLightList[g].updateLightData(n,g,this._passUsage.spotLightData)}for(g=0;g<this._passUsage.maxPointLight;g++){this.lightGroup.pointLightList[g].updateLightData(n,g,this._passUsage.pointLightData)}if(this._passUsage.uniform_directLightSource)r.uniform1fv(this._passUsage.uniform_directLightSource.uniformIndex,this._passUsage.directLightData);if(this._passUsage.uniform_sportLightSource)r.uniform1fv(this._passUsage.uniform_sportLightSource.uniformIndex,this._passUsage.spotLightData);if(this._passUsage.uniform_pointLightSource)r.uniform1fv(this._passUsage.uniform_pointLightSource.uniformIndex,this._passUsage.pointLightData)}if(this._passUsage.uniform_ModelMatrix){r.uniformMatrix4fv(this._passUsage.uniform_ModelMatrix.uniformIndex,false,a.rawData)}if(this._passUsage.uniform_ViewMatrix){r.uniformMatrix4fv(this._passUsage.uniform_ViewMatrix.uniformIndex,false,n.viewMatrix.rawData)}if(this._passUsage.uniform_ProjectionMatrix){r.uniformMatrix4fv(this._passUsage.uniform_ProjectionMatrix.uniformIndex,false,n.projectMatrix.rawData)}if(this._passUsage.uniform_ViewProjectionMatrix){r.uniformMatrix4fv(this._passUsage.uniform_ViewProjectionMatrix.uniformIndex,false,n.viewProjectionMatrix.rawData)}if(this._passUsage.uniform_orthProjectMatrix){r.uniformMatrix4fv(this._passUsage.uniform_orthProjectMatrix.uniformIndex,false,n.orthProjectionMatrix.rawData)}if(s.animation){s.animation.activeState(e,i,this._passUsage,o,r,a,n)}if(this.methodList){for(var g=0;g<this.methodList.length;g++){this.methodList[g].activeState(e,i,this._passUsage,null,r,a,n,h)}}if(this._passUsage.uniform_eyepos){r.uniform3f(this._passUsage.uniform_eyepos.uniformIndex,n.x,n.y,n.z)}if(this._passUsage.uniform_cameraMatrix){r.uniformMatrix4fv(this._passUsage.uniform_cameraMatrix.uniformIndex,false,n.modelMatrix.rawData)}if(this._passUsage["uniform_billboardMatrix"]){var y;switch(s.billboard){case t.BillboardType.STANDARD:y=n.billboardXYZ;break;case t.BillboardType.X_AXIS:y=n.billboardX;break;case t.BillboardType.Y_AXIS:y=n.billboardY;break;case t.BillboardType.Z_AXIS:y=n.billboardZ;break;case t.BillboardType.DISABLE:y=t.Matrix4_4.helpMatrix;y.identity();break}r.uniformMatrix4fv(this._passUsage["uniform_billboardMatrix"].uniformIndex,false,y.rawData)}if(this._passUsage["uniform_ObjectId"]){var x=t.Color.getColor(s.id,t.ContextConfig.ColorFormat_RGBA8888,t.Vector3D.HELP_0);r.uniform3fv(this._passUsage["uniform_ObjectId"].uniformIndex,[x.x,x.y,x.z])}r.drawElement(this._materialData.drawMode,o.start*Uint16Array.BYTES_PER_ELEMENT,o.count);if(this._materialData.alphaBlending)t.Context3DProxy.gl.depthMask(true)};e.prototype.deactiveState=function(t,e){var i;for(var r in t.sampler2DList){i=this._passUsage.sampler2DList[r];if(!i.texture){continue}e.disableTexture2DAt(i.activeTextureIndex,i.uniformIndex,i.index)}};e.prototype.dispose=function(){if(this._passUsage){this._passUsage.dispose()}this._passUsage=null};return e}();t.MaterialPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this._passID=t.PassType.colorPass}i.prototype.initUseMethod=function(e,i){var r=0;this._passChange=false;this._passUsage=new t.PassUsage;this._passUsage.vertexShader.shaderType=t.Shader.vertex;this._passUsage.fragmentShader.shaderType=t.Shader.fragment;if(e){
if(e.skeletonAnimationController){this._passUsage.maxBone=e.skeletonAnimationController.jointNum*2;this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")}else if(e.particleAnimationController){this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs");this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods);this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods)}}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment")}this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[];this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("colorPassEnd_fs");this.phaseEnd(e)};return i}(t.MaterialPass);t.ColorPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this._passID=t.PassType.diffusePass}i.prototype.initUseMethod=function(t,i){e.prototype.initUseMethod.call(this,t,i)};return i}(t.MaterialPass);t.DiffusePass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this._passID=t.PassType.diffusePass}i.prototype.setTexture=function(t,e){this._materialData[t]=e};i.prototype.initUseMethod=function(e,i){this._passChange=false;var r=0;this._passUsage=new t.PassUsage;this._vs_shader_methods={};this._fs_shader_methods={};if(this.lightGroup){this._passUsage.maxDirectLight=this.lightGroup.directLightList.length;this._passUsage.maxSpotLight=this.lightGroup.spotLightList.length;this._passUsage.maxPointLight=this.lightGroup.pointLightList.length;if(this.lightGroup.directLightList.length){this._passUsage.directLightData=new Float32Array(t.DirectLight.stride*this.lightGroup.directLightList.length)}}this.addMethodShaders(this._passUsage.vertexShader,["FakePBR_vs"]);this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]);this.addMethodShaders(this._passUsage.fragmentShader,["FakePBR_fs"])};return i}(t.MaterialPass);t.FakePBRPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this._passID=t.PassType.shadowPass}i.prototype.initUseMethod=function(e,i){this._passChange=false;var r=0;this._passUsage=new t.PassUsage;this._vs_shader_methods={};this._fs_shader_methods={};if(e){if(e.skeletonAnimationController){this._passUsage.maxBone=e.skeletonAnimationController.jointNum*2;this.addMethodShaders(this._passUsage.vertexShader,["shadowPass_skeleton_vs"])}else if(e.particleAnimationController){this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs");this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods);this.addMethodShaders(this._passUsage.vertexShader,["base_vs"]);var a;a=this._vs_shader_methods[t.ShaderPhaseType.start_vertex];if(a&&a.length>0)this.addMethodShaders(this._passUsage.vertexShader,a);a=this._vs_shader_methods[t.ShaderPhaseType.local_vertex];if(a&&a.length>0)this.addMethodShaders(this._passUsage.vertexShader,a);a=this._vs_shader_methods[t.ShaderPhaseType.global_vertex];if(a&&a.length>0)this.addMethodShaders(this._passUsage.vertexShader,a);a=this._vs_shader_methods[t.ShaderPhaseType.end_vertex];if(a&&a.length>0)this.addMethodShaders(this._passUsage.vertexShader,a)}}else{this.addMethodShaders(this._passUsage.vertexShader,["shadowPass_vs"])}this.addMethodShaders(this._passUsage.fragmentShader,["shadowPass_fs"])};return i}(t.MaterialPass);t.ShadowPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this._passID=t.PassType.CubePass}i.prototype.initUseMethod=function(e,i){var r=0;this._passChange=false;this._passUsage=new t.PassUsage;this._passUsage.vertexShader.shaderType=t.Shader.vertex;this._passUsage.fragmentShader.shaderType=t.Shader.fragment;if(e){if(e.skeletonAnimationController){this._passUsage.maxBone=e.skeletonAnimationController.jointNum*2;this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")}else if(e.particleAnimationController){this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs");this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods);this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods)}}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment")}this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[];this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("normalPassEnd_fs");this.phaseEnd(e)};return i}(t.MaterialPass);t.NormalPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this._passID=t.PassType.CubePass}i.prototype.initUseMethod=function(e,i){var r=0;this._passChange=false;this._passUsage=new t.PassUsage;this._passUsage.vertexShader.shaderType=t.Shader.vertex;this._passUsage.fragmentShader.shaderType=t.Shader.fragment;if(e){if(e.skeletonAnimationController){this._passUsage.maxBone=e.skeletonAnimationController.jointNum*2;this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")}else if(e.particleAnimationController){this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs");this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods);this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods)}}this._vs_shader_methods[t.ShaderPhaseType.end_vertex]=this._vs_shader_methods[t.ShaderPhaseType.end_vertex]||[];this._vs_shader_methods[t.ShaderPhaseType.end_vertex].push("positionEndPass_vs");this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[];this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("positionEndPass_fs");this.phaseEnd(e)};return i}(t.MaterialPass);t.PositionPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this._passID=t.PassType.CubePass}i.prototype.initUseMethod=function(e,i){this._passChange=false;var r=0;this._passUsage=new t.PassUsage;this._vs_shader_methods={};this._fs_shader_methods={};if(e){if(e.skeletonAnimationController){this._passUsage.maxBone=e.skeletonAnimationController.jointNum*2;this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")}else if(e.particleAnimationController){this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs");this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods);this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods)}}if(this._materialData.acceptShadow){this._vs_shader_methods[t.ShaderPhaseType.global_vertex]=this._vs_shader_methods[t.ShaderPhaseType.global_vertex]||[];this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]=this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]||[]}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment")}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment")}if(this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.specular_fragment)!=-1){this._fs_shader_methods[t.ShaderPhaseType.specular_fragment]=[];this._fs_shader_methods[t.ShaderPhaseType.specular_fragment].push("specularMap_fragment")}this._vs_shader_methods[t.ShaderPhaseType.end_vertex]=this._vs_shader_methods[t.ShaderPhaseType.end_vertex]||[];this._vs_shader_methods[t.ShaderPhaseType.end_vertex].push("positionEndPass_vs");this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[];this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("Gbuffer");this.initOthreMethods();this.phaseEnd(e)};return i}(t.MaterialPass);t.GbufferPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this,null);this.outline=new Float32Array(5);this._passID=t.PassType.colorPass;this.outline[0]=.2;this.outline[1]=1;this.outline[2]=0;this.outline[3]=0;this.outline[4]=1}Object.defineProperty(i.prototype,"outLineColor",{get:function(){return t.Color.RGBAToColor(this.outline[1],this.outline[2],this.outline[3],this.outline[4])},set:function(e){var i=t.Color.getColor(e);this.outline[1]=i.x;this.outline[2]=i.y;this.outline[3]=i.z;this.outline[4]=i.w},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"outLineSize",{get:function(){return this.outline[0]},set:function(t){this.outline[0]=t},enumerable:true,configurable:true});i.prototype.initUseMethod=function(e,i){var r=0;this._passChange=false;this._passUsage=new t.PassUsage;this._passUsage.vertexShader.shaderType=t.Shader.vertex;this._passUsage.fragmentShader.shaderType=t.Shader.fragment;if(e){if(e.skeletonAnimationController){this._passUsage.maxBone=e.skeletonAnimationController.jointNum*2;this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")}else if(e.particleAnimationController){this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[];this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs");this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods);this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods)}}this._vs_shader_methods[t.ShaderPhaseType.global_vertex]=this._vs_shader_methods[t.ShaderPhaseType.global_vertex]||[];this._vs_shader_methods[t.ShaderPhaseType.global_vertex].push("outLine_vs");this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[];this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("outLine_fs");this.phaseEnd(e)};i.prototype.upload=function(t,i,r,a,n,o,s,h){e.prototype.upload.call(this,t,i,r,a,n,o,s,h)};i.prototype.draw=function(e,i,r,a,n,o,s,h){if(!this.enable)return;if(this._passChange){this.upload(e,i,r,a,n,s.animation,o.geometry,h)}r.setProgram(this._passUsage.program3D);o.activeState(e,i,this._passUsage,r);t.Context3DProxy.gl.depthMask(false);if(this._passUsage.uniform_materialSource){r.uniform1fv(this._passUsage.uniform_materialSource.uniformIndex,this._materialData.materialSourceData)}if(this._passUsage.uniform_ModelMatrix){r.uniformMatrix4fv(this._passUsage.uniform_ModelMatrix.uniformIndex,false,a.rawData)}if(this._passUsage.uniform_ViewMatrix){r.uniformMatrix4fv(this._passUsage.uniform_ViewMatrix.uniformIndex,false,n.viewMatrix.rawData)}if(this._passUsage.uniform_ProjectionMatrix){r.uniformMatrix4fv(this._passUsage.uniform_ProjectionMatrix.uniformIndex,false,n.projectMatrix.rawData)}if(this._passUsage.uniform_ViewProjectionMatrix){r.uniformMatrix4fv(this._passUsage.uniform_ViewProjectionMatrix.uniformIndex,false,n.viewProjectionMatrix.rawData)}if(this._passUsage.uniform_orthProjectMatrix){r.uniformMatrix4fv(this._passUsage.uniform_orthProjectMatrix.uniformIndex,false,n.orthProjectionMatrix.rawData)}if(this._passUsage["uniform_ouline"]){r.uniform1fv(this._passUsage["uniform_ouline"].uniformIndex,this.outline)}if(s.animation){s.animation.activeState(e,i,this._passUsage,o,r,a,n)}if(this.methodList){for(var u=0;u<this.methodList.length;u++){this.methodList[u].activeState(e,i,this._passUsage,null,r,a,n,h)}}if(this._passUsage.uniform_eyepos){r.uniform3f(this._passUsage.uniform_eyepos.uniformIndex,n.x,n.y,n.z)}if(this._passUsage.uniform_cameraMatrix){r.uniformMatrix4fv(this._passUsage.uniform_cameraMatrix.uniformIndex,false,n.modelMatrix.rawData)}r.drawElement(this._materialData.drawMode,o.start,o.count);t.Context3DProxy.gl.depthMask(true)};return i}(t.MaterialPass);t.OutLinePass=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this,i);this._passID=t.PassType.PickPass}i.prototype.initUseMethod=function(e,i){this._passChange=false;var r=0;this._passUsage=new t.PassUsage;this._vs_shader_methods={};this._fs_shader_methods={};if(e){if(e.skeletonAnimationController){this._passUsage.maxBone=e.skeletonAnimationController.jointNum*2;this.addMethodShaders(this._passUsage.vertexShader,["pickPass_skeleton_vs"])}}else{this.addMethodShaders(this._passUsage.vertexShader,["pickPass_vs"])}this.addMethodShaders(this._passUsage.fragmentShader,["pickPass_fs"])};return i}(t.MaterialPass);t.PickPass=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["diffusePass"]=0]="diffusePass";t[t["colorPass"]=1]="colorPass";t[t["normalPass"]=2]="normalPass";t[t["shadowPass"]=3]="shadowPass";t[t["lightPass"]=4]="lightPass";t[t["matCapPass"]=5]="matCapPass";t[t["depthPass_8"]=6]="depthPass_8";t[t["depthPass_32"]=7]="depthPass_32";t[t["CubePass"]=8]="CubePass";t[t["Gbuffer"]=9]="Gbuffer";t[t["PickPass"]=10]="PickPass";t[t["OutLinePass"]=11]="OutLinePass";t[t["position"]=12]="position"})(t.PassType||(t.PassType={}));var e=t.PassType;var i=function(){function i(){}i.CreatPass=function(i,r){switch(i){case e.colorPass:r.shaderPhaseTypes[e.colorPass]=[];return[new t.ColorPass(r)];case e.diffusePass:r.shaderPhaseTypes[e.diffusePass]=[];return[new t.DiffusePass(r)];case e.shadowPass:r.shaderPhaseTypes[e.shadowPass]=[];return[new t.ShadowPass(r)];case e.depthPass_8:r.shaderPhaseTypes[e.depthPass_8]=[];return[new t.PositionPass(r)];case e.normalPass:r.shaderPhaseTypes[e.normalPass]=[];return[new t.NormalPass(r)];case e.Gbuffer:r.shaderPhaseTypes[e.Gbuffer]=[];return[new t.GbufferPass(r)];case e.PickPass:r.shaderPhaseTypes[e.PickPass]=[];return[new t.PickPass(r)];case e.OutLinePass:r.shaderPhaseTypes[e.OutLinePass]=[];return[new t.OutLinePass]}return null};i.PassAuto=[true,true,true,false,false,true,true,true,true,true,false,true,true];return i}();t.PassUtil=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){if(e===void 0){e=null}this.passes={};if(e==null){this.setData(new t.MaterialData)}else this.setData(e)}e.prototype.setData=function(e){this.materialData=e;this.initPass();this.blendMode=t.BlendMode.NORMAL};e.prototype.getData=function(){return this.materialData};e.prototype.initPass=function(){this.creatPass(t.PassType.colorPass)};Object.defineProperty(e.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(e){this._lightGroup=e;if(this.passes[t.PassType.diffusePass]&&this.passes[t.PassType.diffusePass].length>0){for(var i=0;i<this.passes[t.PassType.diffusePass].length;i++){this.passes[t.PassType.diffusePass][i].lightGroup=e}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"depth",{get:function(){return this.materialData.depthTest},set:function(t){this.materialData.depthTest=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"depthMode",{get:function(){return this.materialData.depthMode},set:function(t){this.materialData.depthMode=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"diffuseTexture",{get:function(){return this.materialData.diffuseTexture},set:function(e){if(e){this.materialData.diffuseTexture=e;this.materialData.textureChange=true;if(this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.diffuse_fragment)}if(this.materialData.shaderPhaseTypes[t.PassType.shadowPass]&&this.materialData.shaderPhaseTypes[t.PassType.shadowPass].indexOf(t.ShaderPhaseType.diffuse_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.shadowPass].push(t.ShaderPhaseType.diffuse_fragment)}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"diffuseTexture3D",{get:function(){return this.materialData["diffuseTexture3D"]},set:function(e){if(e){this.materialData["diffuseTexture3D"]=e;this.materialData.textureChange=true;if(this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.diffuse_fragment)}if(this.materialData.shaderPhaseTypes[t.PassType.shadowPass]&&this.materialData.shaderPhaseTypes[t.PassType.shadowPass].indexOf(t.ShaderPhaseType.diffuse_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.shadowPass].push(t.ShaderPhaseType.diffuse_fragment)}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"normalTexture",{get:function(){return this.materialData.normalTexture},set:function(e){if(e){this.materialData.normalTexture=e;this.materialData.textureChange=true;if(this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.normal_fragment);this.passInvalid(t.PassType.diffusePass)}if(this.materialData.shaderPhaseTypes[t.PassType.matCapPass]&&this.materialData.shaderPhaseTypes[t.PassType.matCapPass].indexOf(t.ShaderPhaseType.normal_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.matCapPass].push(t.ShaderPhaseType.normal_fragment)}}},enumerable:true,configurable:true});e.prototype.passInvalid=function(t){if(this.passes[t]&&this.passes[t].length>0){for(var e=0;e<this.passes[t].length;e++){this.passes[t][e].passInvalid()}}};Object.defineProperty(e.prototype,"matcapTexture",{get:function(){return this.materialData.normalTexture},set:function(e){if(e){this.materialData.matcapTexture=e;this.materialData.textureChange=true;if(this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.matCap_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.matCap_fragment);this.passInvalid(t.PassType.diffusePass)}if(this.materialData.shaderPhaseTypes[t.PassType.matCapPass]&&this.materialData.shaderPhaseTypes[t.PassType.matCapPass].indexOf(t.ShaderPhaseType.matCap_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.matCapPass].push(t.ShaderPhaseType.matCap_fragment)}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"specularTexture",{get:function(){return this.materialData.specularTexture},set:function(e){if(e){this.materialData.specularTexture=e;this.materialData.textureChange=true;if(this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.specular_fragment)==-1){this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.specular_fragment)}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"drawMode",{get:function(){return this.materialData.drawMode},set:function(t){this.materialData.drawMode=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"cutAlpha",{get:function(){return this.materialData.cutAlpha},set:function(t){this.materialData.cutAlpha=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"diffuseColor",{get:function(){return this.materialData.diffuseColor},set:function(t){this.materialData.materialDataNeedChange=true;this.materialData.diffuseColor=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"ambientColor",{get:function(){return this.materialData.ambientColor},set:function(t){this.materialData.materialDataNeedChange=true;this.materialData.ambientColor=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"specularColor",{get:function(){return this.materialData.specularColor},set:function(t){this.materialData.materialDataNeedChange=true;this.materialData.specularColor=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"tintColor",{get:function(){return this.materialData.tintColor},set:function(t){this.materialData.materialDataNeedChange=true;this.materialData.tintColor=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){if(this.materialData.alpha!=t){this.materialData.alpha=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"alphaBlending",{get:function(){return this.materialData.alphaBlending},set:function(t){if(this.materialData.alphaBlending!=t){this.materialData.alphaBlending=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"specularLevel",{get:function(){return this.materialData.specularLevel},set:function(t){if(this.materialData.specularLevel!=t){this.materialData.specularLevel=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"gloss",{get:function(){return this.materialData.gloss},set:function(t){if(this.materialData.gloss!=t){this.materialData.gloss=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"normalDir",{get:function(){return this.materialData.normalDir},set:function(t){if(this.materialData.normalDir!=t){this.materialData.normalDir=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"gamma",{get:function(){return this.materialData.gamma},set:function(t){if(this.materialData.gamma!=t){this.materialData.gamma=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"refraction",{get:function(){return this.materialData.refraction},set:function(t){if(this.materialData.refraction!=t){this.materialData.refraction=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"refractionintensity",{get:function(){return this.materialData.refractionintensity},set:function(t){if(this.materialData.refractionintensity!=t){this.materialData.refractionintensity=t;this.materialData.materialDataNeedChange=true}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"uvRectangle",{get:function(){return this.materialData.uvRectangle},set:function(t){this.materialData.uvRectangle.x=t.x;this.materialData.uvRectangle.y=t.y;this.materialData.uvRectangle.width=t.width;this.materialData.uvRectangle.height=t.height;this.materialData.materialDataNeedChange=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"diffusePass",{get:function(){return this.passes[t.PassType.diffusePass][0]},enumerable:true,configurable:true});e.prototype.creatPass=function(e){this.passes[e]=t.PassUtil.CreatPass(e,this.materialData)};e.prototype.addDiffuseChilderPass=function(e){if(this.passes[t.PassType.diffusePass]){e.materialData=this.materialData;this.passes[t.PassType.diffusePass].push(e)}};Object.defineProperty(e.prototype,"castShadow",{get:function(){return this.materialData.castShadow},set:function(e){this.materialData.castShadow=e;if(e){this.creatPass(t.PassType.shadowPass)}else{if(this.passes[t.PassType.shadowPass]){this.disposePass(t.PassType.shadowPass);this.passes[t.PassType.shadowPass]=null}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"castPick",{set:function(e){if(e){t.PickSystem.instance.enablePick=true;this.creatPass(t.PassType.PickPass)}else{if(this.passes[t.PassType.PickPass]){this.disposePass(t.PassType.PickPass);this.passes[t.PassType.PickPass]=null}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"acceptShadow",{get:function(){return this.materialData.acceptShadow},set:function(t){if(this.materialData.acceptShadow==t){return}this.materialData.acceptShadow=t;if(this.diffusePass)this.diffusePass.addShadowMethod()},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"shadowColor",{get:function(){var t=0;t|=this.materialData.shadowColor[0]*255<<16;t|=this.materialData.shadowColor[1]*255<<8;t|=this.materialData.shadowColor[2]*255;return t},set:function(t){this.materialData.shadowColor[0]=t>>16&255/255;this.materialData.shadowColor[1]=t>>8&255/255;this.materialData.shadowColor[2]=t&255/255},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"shadowOffset",{get:function(){return this.materialData.shadowColor[3]},set:function(t){this.materialData.shadowColor[3]=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"repeat",{get:function(){return this.materialData.repeat},set:function(t){this.materialData.repeat=t;this.materialData.textureStateChage=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"bothside",{get:function(){return this.materialData.bothside},set:function(t){this.materialData.textureStateChage=true;this.materialData.bothside=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"cullMode",{get:function(){return this.materialData.cullFrontOrBack},set:function(t){this.materialData.textureStateChage=true;this.materialData.cullFrontOrBack=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"blendMode",{set:function(e){this.materialData.textureStateChage=true;this.materialData.blendMode=e;switch(e){case t.BlendMode.NORMAL:this.materialData.blend_src=t.ContextConfig.ONE;this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_ALPHA;this.materialData.alphaBlending=false;break;case t.BlendMode.LAYER:this.materialData.blend_src=t.ContextConfig.SRC_ALPHA;this.materialData.blend_dest=t.ContextConfig.ZERO;this.materialData.alphaBlending=true;break;case t.BlendMode.MULTIPLY:this.materialData.blend_src=t.ContextConfig.ZERO;this.materialData.blend_dest=t.ContextConfig.SRC_COLOR;this.materialData.alphaBlending=true;break;case t.BlendMode.ADD:this.materialData.blend_src=t.ContextConfig.SRC_ALPHA;this.materialData.blend_dest=t.ContextConfig.ONE;this.materialData.alphaBlending=true;break;case t.BlendMode.SOFT_ADD:this.materialData.blend_src=t.ContextConfig.SRC_COLOR;this.materialData.blend_dest=t.ContextConfig.ONE;this.materialData.alphaBlending=true;break;case t.BlendMode.ALPHA:this.materialData.blend_src=t.ContextConfig.ONE;this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_ALPHA;this.materialData.alphaBlending=true;break;case t.BlendMode.SCREEN:this.materialData.blend_src=t.ContextConfig.ONE;this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_COLOR;break}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"pointSize",{get:function(){return this.materialData.specularLevel},set:function(t){if(t==this.materialData.specularLevel){return}this.materialData.specularLevel=t;this.materialData.textureStateChage=true},enumerable:true,configurable:true});e.prototype.disposePass=function(t){for(var e=0;e<this.passes[t].length;e++){this.passes[t][e].dispose()}};e.prototype.renderXRayPass=function(){};e.prototype.renderOutlinePass=function(){};e.prototype.renderNormalPass=function(){};e.prototype.renderDepthPass=function(){};e.prototype.renderPositionPass=function(){};e.prototype.renderUVPass=function(){};e.prototype.renderScendUVPass=function(){};e.prototype.renderVertexColorPass=function(){};e.prototype.renderLightingPass=function(){};e.prototype.dispose=function(){for(var t in this.passes){for(var e=0;e<this.passes[t].length;++e){this.passes[t][e].dispose()}}};return e}();t.MaterialBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=13421772}e.call(this);this.color=i;this.diffuseTexture=t.CheckerboardTexture.texture;this.initMatPass()}i.prototype.initMatPass=function(){this.creatPass(t.PassType.diffusePass);this.diffusePass.addMethod(new t.ColorMethod)};Object.defineProperty(i.prototype,"color",{get:function(){return this.materialData.diffuseColor},set:function(t){this.materialData.diffuseColor=t},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){this.materialData.alpha=t},enumerable:true,configurable:true});return i}(t.MaterialBase);t.ColorMaterial=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r){if(i===void 0){i=null}if(r===void 0){r=null}e.call(this,r);if(!i){this.diffuseTexture=t.CheckerboardTexture.texture}else{this.diffuseTexture=i}this.initMatPass()}i.prototype.initMatPass=function(){this.creatPass(t.PassType.diffusePass)};i.prototype.clone=function(){var t=new i(this.diffuseTexture,this.materialData.clone());return t};return i}(t.MaterialBase);t.TextureMaterial=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r){if(i===void 0){i=null}if(r===void 0){r=null}e.call(this,r);if(!i){this.diffuseTexture=t.CheckerboardTexture.texture}else{this.diffuseTexture=i}this.initMatPass()}i.prototype.initMatPass=function(){this._fakePBR=new t.FakePBRPass(this.materialData);this.materialData.shaderPhaseTypes[t.PassType.diffusePass]=[];this.passes[t.PassType.diffusePass]=[this._fakePBR]};Object.defineProperty(i.prototype,"albedoTexture",{set:function(t){this._fakePBR.setTexture("albedoTex",t)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"normalTexture",{set:function(t){this._fakePBR.setTexture("normalTex",t)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"glossTexture",{set:function(t){this._fakePBR.setTexture("glossTex",t)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"specularTexture",{set:function(t){this._fakePBR.setTexture("specularTex",t)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"opacityTexture",{set:function(t){this._fakePBR.setTexture("opacityTex ",t)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"reflectionTexture",{set:function(t){this._fakePBR.setTexture("reflectionMap",t)},enumerable:true,configurable:true});i.prototype.clone=function(){var e=new t.TextureMaterial(this.diffuseTexture,this.materialData.clone());return e};return i}(t.MaterialBase);t.FakePBRMaterial=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){
__extends(i,e);function i(i,r){if(i===void 0){i=null}if(r===void 0){r=null}e.call(this,r);this.initMatPass();if(!i){i=t.CubeTexture.createCubeTextureByImageTexture(t.CheckerboardTexture.texture,t.CheckerboardTexture.texture,t.CheckerboardTexture.texture,t.CheckerboardTexture.texture,t.CheckerboardTexture.texture,t.CheckerboardTexture.texture)}this.materialData["diffuseTexture3D"]=i}i.prototype.initMatPass=function(){this.creatPass(t.PassType.diffusePass);this.diffusePass.addMethod(new t.CubeMethod)};i.prototype.clone=function(){var t=new i(this.diffuseTexture,this.materialData.clone());return t};return i}(t.MaterialBase);t.CubeTextureMaterial=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.name="default";this.enabled=true;this.numEntity=0;this._renderIndex=0}Object.defineProperty(e.prototype,"pass",{get:function(){return this._pass},set:function(t){this._pass=t},enumerable:true,configurable:true});e.prototype.setRenderToTexture=function(e,i,r){if(r===void 0){r=t.FrameBufferFormat.UNSIGNED_BYTE_RGB}if(this.renderTexture)this.renderTexture.dispose();this.renderTexture=new t.RenderTexture(e,i,r)};e.prototype.draw=function(t,e,i,r,a,n,o){if(o===void 0){o=null}};return e}();t.RenderBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){if(i===void 0){i=t.PassType.diffusePass}e.call(this);this._i=0;this._j=0;this.currentViewPort=new t.Rectangle;this.pass=i}i.prototype.draw=function(e,i,r,a,n,o,s){if(s===void 0){s=null}this.numEntity=a.renderList.length;this.viewPort=n;if(this.renderTexture){this.renderTexture.upload(r);this.renderTexture.useMipmap=false;r.setRenderToTexture(this.renderTexture.texture2D,true,true,0);this.currentViewPort.x=0;this.currentViewPort.y=0;this.currentViewPort.width=this.renderTexture.texture2D.width;this.currentViewPort.height=this.renderTexture.texture2D.height;this.viewPort=this.currentViewPort}var h;for(this._renderIndex=0;this._renderIndex<this.numEntity;this._renderIndex++){this._renderItem=a.renderList[this._renderIndex];this._renderItem.geometry.activeState(e,i,t.Egret3DCanvas.context3DProxy,this.camera);for(this._i=0;this._i<this._renderItem.geometry.subGeometrys.length;this._i++){var u=this._renderItem.geometry.subGeometrys[this._i];var l=u.matID;h=this._renderItem.multiMaterial[l];if(h==null)continue;if(h.passes[this._pass]){for(this._j=h.passes[this._pass].length-1;this._j>=0;this._j--){h.passes[this._pass][this._j].draw(e,i,r,this._renderItem.modelMatrix,this.camera,u,this._renderItem,o)}}else if(t.PassUtil.PassAuto[this._pass]){if(!h.passes[this._pass]){h.creatPass(this._pass)}for(this._j=h.passes[this._pass].length-1;this._j>=0;this._j--){h.passes[this._pass]=t.PassUtil.CreatPass(this._pass,h.materialData);h.passes[this._pass][this._j].draw(e,i,r,this._renderItem.modelMatrix,this.camera,u,this._renderItem,o)}}h=null}}if(this.drawOver){this.drawOver(a,this.camera,e,i,this.viewPort)}if(this.renderTexture){this.viewPort=n;r.setRenderToBackBuffer();if(this.viewPort){r.viewPort(this.viewPort.x,this.viewPort.y,this.viewPort.width,this.viewPort.height);r.setScissorRectangle(this.viewPort.x,this.viewPort.y,this.viewPort.width,this.viewPort.height)}}this._renderItem=null};return i}(t.RenderBase);t.MultiRender=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.renderDictionary=[];this.renderArray=[];var e=new t.MultiRender(t.PassType.diffusePass);this.setMainRender(e)}e.prototype.setMainRender=function(t){this.mainRender=t};e.prototype.addRender=function(t,e){if(e===void 0){e=-1}var e=this.renderArray.indexOf(t);this.renderDictionary[t.name]=t;if(e==-1){if(e==-1){this.renderArray.push(t)}else{this.renderArray.splice(e,-1,t)}}};e.prototype.removeRender=function(t){var e=this.renderArray.indexOf(t);if(this.renderDictionary[t.name])delete this.renderDictionary[t.name];if(e!=-1){this.renderArray.splice(e,1,t)}};e.prototype.draw=function(e,i,r,a,n,o){if(o===void 0){o=null}var s;for(s=0;s<this.renderArray.length;s++){if(this.renderArray[s].enabled)this.renderArray[s].draw(e,i,r,a,n,this,o)}if(this.mainRender){if(this.mainRender.enabled){if(t.Egret3DCanvas.Performance_Enable){var e=this.curDate;this.mainRender.draw(e,i,r,a,n,this,o);t.Egret3DCanvas.Performance_GPU+=this.curDate-e}else{this.mainRender.draw(e,i,r,a,n,this,o)}}}};Object.defineProperty(e.prototype,"curDate",{get:function(){return(new Date).getTime()},enumerable:true,configurable:true});return e}();t.RenderQuen=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r){e.call(this);this.hud=new t.HUD;this.needClean=false;this.hud.vsShader=i;this.hud.fsShader=r}i.prototype.setTexture=function(t,e){this.hud[t]=e};i.prototype.setRenderToTexture=function(e,i,r){if(r===void 0){r=t.FrameBufferFormat.UNSIGNED_BYTE_RGB}this.renderTexture=new t.RenderTexture(e,i,r)};i.prototype.draw=function(t,e,i,r,a,n){this.numEntity=r.renderList.length;if(this.renderTexture){this.renderTexture.upload(i);i.setRenderToTexture(this.renderTexture.texture2D,this.needClean,true,0)}this.hud.viewPort=this.camera.viewPort;this.hud.x=this.camera.viewPort.x;this.hud.y=this.camera.viewPort.y;this.hud.width=this.camera.viewPort.width;this.hud.height=this.camera.viewPort.height;this.hud.diffuseTexture=n["final"];this.hud["colorTexture"]=n["source"];this.hud.draw(i,this.camera);if(this.renderTexture)i.setRenderToBackBuffer();if(a){i.viewPort(a.x,a.y,a.width,a.height);i.setScissorRectangle(a.x,a.y,a.width,a.height)}};return i}(t.RenderBase);t.PostRender=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["float"]=0]="float";t[t["vec2"]=1]="vec2";t[t["vec3"]=2]="vec3";t[t["vec4"]=3]="vec4"})(t.ValueType||(t.ValueType={}));var e=t.ValueType;var i=function(){function t(){}t.prototype.calculate=function(t,e){if(e===void 0){e=null}new Error("asd");return null};t.prototype.dispose=function(){};return t}();t.ValueShape=i;var r=function(t){__extends(i,t);function i(){t.apply(this,arguments);this.valueType=e.float;this.value=5}i.prototype.calculate=function(t){var e=[];for(var i=0;i<t;i++){e.push(this.value)}return e};return i}(i);t.ConstValueShape=r;var a=function(t){__extends(i,t);function i(){t.apply(this,arguments);this.valueType=e.float;this.min=0;this.max=100}i.prototype.calculate=function(t){var e=[];for(var i=0;i<t;i++){e.push(this.min+Math.random()*(this.max-this.min))}return e};return i}(i);t.ConstRandomValueShape=a;var n=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec2;this.minX=0;this.minY=0}r.prototype.calculate=function(e){var i=[];for(var r=0;r<e;r++){var a=new t.Point;a.x=this.minX;a.y=this.minY;i.push(a)}return i};return r}(i);t.Vec2ConstValueShape=n;var o=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec2;this.minX=0;this.minY=0;this.maxX=100;this.maxY=100}r.prototype.calculate=function(e){var i=[];for(var r=0;r<e;r++){var a=new t.Point;a.x=this.minX+Math.random()*(this.maxX-this.minX);a.y=this.minY+Math.random()*(this.maxY-this.minY);i.push(a)}return i};return r}(i);t.Vec2ConstRandomValueShape=o;var s=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.minX=0;this.minY=0;this.minZ=0}r.prototype.calculate=function(e){var i=[];for(var r=0;r<e;r++){var a=new t.Vector3D;a.x=this.minX;a.y=this.minY;a.z=this.minZ;i.push(a)}return i};return r}(i);t.Vec3ConstValueShape=s;var h=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.minX=-50;this.minY=-50;this.minZ=-50;this.maxX=50;this.maxY=50;this.maxZ=50}r.prototype.calculate=function(e){var i=[];for(var r=0;r<e;r++){var a=new t.Vector3D;a.x=this.minX+Math.random()*(this.maxX-this.minX);a.y=this.minY+Math.random()*(this.maxY-this.minY);a.z=this.minZ+Math.random()*(this.maxZ-this.minZ);i.push(a)}return i};return r}(i);t.Vec3ConstRandomValueShape=h;var u=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.width=100;this.height=100;this.depth=100}r.prototype.calculate=function(e){var i=[];var r;for(var a=0;a<e;a++){r=new t.Vector3D;r.x=Math.random()*this.width-this.width*.5;r.y=Math.random()*this.height-this.height*.5;r.z=Math.random()*this.depth-this.depth*.5;i.push(r)}return i};return r}(i);t.CubeVector3DValueShape=u;var l=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.width=100;this.height=100}r.prototype.calculate=function(e){var i=[];var r;for(var a=0;a<e;a++){r=new t.Vector3D;r.x=Math.random()*this.width-this.width*.5;r.y=0;r.z=Math.random()*this.height-this.height*.5;i.push(r)}return i};return r}(i);t.PlaneValueShape=l;var c=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.radius=20;this.angle=20;this.length=20;this.coneType=t.ParticleConeShapeType.Volume}r.prototype.dispose=function(){if(this.directions){this.directions.length=0}this.origPoint=null;this.directions=null};r.prototype.calculate=function(e){if(this.angle>90){this.angle=90}if(this.radius<=0){this.radius=.01}if(this.angle==90){this.origPoint=new t.Vector3D}else if(this.angle==0){this.origPoint=null}else{this.origPoint=new t.Vector3D;this.origPoint.z=-this.radius/Math.tan(this.angle*Math.PI/180)}var i;this.directions=[];if(this.coneType==t.ParticleConeShapeType.Volume){if(this.angle==90){i=this.calculateBase(e)}else{i=this.calculateVolume(e)}}else if(this.coneType==t.ParticleConeShapeType.VolumeShell){if(this.angle==90){i=this.calculateBaseShell(e)}else{i=this.calculateVolumeShell(e)}}else if(this.coneType==t.ParticleConeShapeType.Base){i=this.calculateBase(e)}else if(this.coneType==t.ParticleConeShapeType.BaseShell){i=this.calculateBaseShell(e)}return i};r.prototype.calculateBase=function(e){var i;var r;var a=[];var n;var o;for(var s=0;s<e;s++){n=Math.random()*Math.PI*2;i=new t.Vector3D;i.z=0;o=Math.random()*this.radius;i.x=Math.sin(n)*o;i.y=Math.cos(n)*o;if(this.origPoint){r=i.subtract(this.origPoint);r.normalize()}else{r=new t.Vector3D(0,0,1)}a.push(i);this.directions.push(r)}return a};r.prototype.calculateBaseShell=function(e){var i;var r;var a=[];var n;var o;for(var s=0;s<e;s++){n=Math.random()*Math.PI*2;i=new t.Vector3D;i.z=0;o=this.radius;i.x=Math.sin(n)*o;i.y=Math.cos(n)*o;if(this.origPoint){r=i.subtract(this.origPoint);r.normalize()}else{r=new t.Vector3D(0,0,1)}a.push(i);this.directions.push(r)}return a};r.prototype.calculateVolume=function(e){var i;var r;var a=[];var n;var o;for(var s=0;s<e;s++){n=Math.random()*Math.PI*2;i=new t.Vector3D;i.z=this.length*Math.random();o=this.radius*Math.random();if(this.origPoint){o*=(i.z-this.origPoint.z)/-this.origPoint.z}i.x=Math.sin(n)*o;i.y=Math.cos(n)*o;if(this.origPoint){r=i.subtract(this.origPoint);r.normalize()}else{r=new t.Vector3D(0,0,1)}a.push(i);this.directions.push(r)}return a};r.prototype.calculateVolumeShell=function(e){var i;var r;var a=[];var n;var o;for(var s=0;s<e;s++){n=Math.random()*Math.PI*2;i=new t.Vector3D;i.z=this.length*Math.random();o=this.radius;if(this.origPoint){o*=(i.z-this.origPoint.z)/-this.origPoint.z}i.x=Math.sin(n)*o;i.y=Math.cos(n)*o;if(this.origPoint){r=i.subtract(this.origPoint);r.normalize()}else{r=new t.Vector3D(0,0,1)}a.push(i);this.directions.push(r)}return a};r.prototype.randomPosAtTop=function(){var t=r.randomPosTop;var e=[];var i;var a;i=Math.random()*Math.PI*2;t.z=this.length;if(this.origPoint){a=this.radius*Math.random();a*=(t.z-this.origPoint.z)/-this.origPoint.z;t.x=Math.sin(i)*a;t.y=Math.cos(i)*a;t.decrementBy(this.origPoint)}else{t.x=t.y=0}};r.prototype.randomDirectionToTop=function(t){this.randomPosAtTop();t.copyFrom(r.randomPosTop);t.normalize()};r.randomPosTop=new t.Vector3D;return r}(i);t.ConeValueShape=c;var f=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.points=[new t.Vector3D,new t.Vector3D(100,0,0),new t.Vector3D(100,200,0)]}r.prototype.calculate=function(e){if(this.points.length==1)return this.points;var i=[];var r;var a=0;var n=0;for(var o=1;o<this.points.length;o++){a+=t.Vector3D.distance(this.points[o-1],this.points[o])}n=a/e;var s=new t.Vector3D;var h=0;var u=0;var l=0;for(var o=1;o<this.points.length;o++){s.x=this.points[o].x-this.points[o-1].x;s.y=this.points[o].y-this.points[o-1].y;s.z=this.points[o].z-this.points[o-1].z;s.normalize();s.scaleBy(n+l);h=t.Vector3D.distance(this.points[o-1],this.points[o]);u=t.Vector3D.distance(s,this.points[o]);if(u>h){l+=u}}return i};return r}(i);var d=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.r=10;this.fromShell=false}r.prototype.calculate=function(t){var e=[];e=this.getPoints1(t,this.r);return e};r.prototype.getPoints1=function(e,i){var r=[];var a;var n;var o;var s;var h=new t.Vector3D(0,0,0);for(var u=0;u<e;u++){a=Math.random()*2*i-i;n=Math.random()*2*i-i;o=Math.random()*2*i-i;s=new t.Vector3D(a,n,o);if(this.fromShell){s.normalize(this.r)}if(t.Vector3D.distance(h,s)>i){u--}else{r.push(s)}}return r};return r}(i);t.BallValueShape=d;var p=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.r=10;this.fromShell=false}r.prototype.calculate=function(t){var e=[];e=this.getPoints(t,this.r);return e};r.prototype.getPoints=function(e,i){var r=[];var a;var n;var o;var s;var h=new t.Vector3D(0,0,0);for(var u=0;u<e;u++){a=Math.random()*2*i-i;n=Math.random()*2*i-i;o=Math.abs(Math.random()*2*i-i);s=new t.Vector3D(a,n,o);if(this.fromShell){s.normalize(this.r)}if(t.Vector3D.distance(h,s)>i){u--}else{r.push(s)}}return r};return r}(i);t.HemiBallValueShape=p;var _=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3}r.prototype.calculate=function(t){var e=[];for(var i=1;i<arguments.length;i++){e[i-1]=arguments[i]}var r;var a=e[0];var n=a[0];r=this.createRandomPoint1(t,n);return r};r.prototype.createRandomPoint1=function(e,i){var r=[];var a=i*2;for(var n=0;n<e;n++){var o=Math.random()*a-i;var s=Math.random()*a-i;if(o*o+s*s>i*i){n--}else{r.push(new t.Vector3D(o,0,s))}}return r};r.prototype.createRandomPoint2=function(e,i){var r=[];var a;var n;var o;for(var s=0;s<e;s++){a=new t.Vector3D;n=Math.sqrt(Math.random())*i;o=Math.random()*360;a.x=n*Math.sin(o);a.z=n*Math.cos(o);a.y=0;r.push(a)}return r};return r}(i);var m=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3;this.normalList=[];this.type=t.ParticleMeshShapeType.Edge;this.scale=1}r.prototype.calculate=function(e){var i=[];if(this.type==t.ParticleMeshShapeType.Edge){this.edgePosition(i,e)}else if(this.type==t.ParticleMeshShapeType.Triangle){this.trianglePosition(i,e)}else if(this.type==t.ParticleMeshShapeType.Vertex){this.vertexPosition(i,e)}if(this.scale!=1&&this.scale!=0){var r;for(var a=0,n=i;a<n.length;a++){r=n[a];r.scaleBy(this.scale)}}return i};r.prototype.edgePosition=function(e,i){var a;var n;var o=this.geometry.faceCount;var s;var h;var u;var l=[];var c=[];for(var f=0;f<i;f++){a=new t.Vector3D;e.push(a);l.length=0;var d=3*Math.floor(o*Math.random());this.geometry.getVertexIndices(d,3,l);c.length=0;this.geometry.getVertexForIndex(l[0],t.VertexFormat.VF_POSITION,c);r.vct1.setTo(c[0],c[1],c[2]);c.length=0;this.geometry.getVertexForIndex(l[1],t.VertexFormat.VF_POSITION,c);r.vct2.setTo(c[0],c[1],c[2]);c.length=0;this.geometry.getVertexForIndex(l[2],t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL,c);r.vct3.setTo(c[0],c[1],c[2]);n=new t.Vector3D;n.setTo(c[3],c[4],c[5]);this.normalList.push(n);u=Math.random();if(u<.333){s=r.vct1;h=r.vct2}else if(u<.666){s=r.vct2;h=r.vct3}else{s=r.vct3;h=r.vct1}s.lerp(s,h,Math.random());a.copyFrom(s)}};r.prototype.trianglePosition=function(e,i){var a;var n;var o=this.geometry.faceCount;var s=new t.Vector3D;var h=new t.Vector3D;var u;var l=[];var c=[];for(var f=0;f<i;f++){a=new t.Vector3D;e.push(a);c.length=0;var d=3*Math.floor(o*Math.random());this.geometry.getVertexIndices(d,3,c);l.length=0;this.geometry.getVertexForIndex(c[0],t.VertexFormat.VF_POSITION,l);r.vct1.setTo(l[0],l[1],l[2]);l.length=0;this.geometry.getVertexForIndex(c[1],t.VertexFormat.VF_POSITION,l);r.vct2.setTo(l[0],l[1],l[2]);l.length=0;this.geometry.getVertexForIndex(c[2],t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL,l);r.vct3.setTo(l[0],l[1],l[2]);n=new t.Vector3D;n.setTo(l[3],l[4],l[5]);this.normalList.push(n);s.lerp(r.vct1,r.vct2,Math.random());h.lerp(r.vct2,r.vct3,Math.random());a.lerp(s,h,Math.random())}};r.prototype.vertexPosition=function(e,i){var a;var n;var o=this.geometry.faceCount;var s;var h=[];var u=[];for(var l=0;l<i;l++){a=new t.Vector3D;e.push(a);var c=3*Math.floor(o*Math.random());h.length=0;this.geometry.getVertexIndices(c,3,h);u.length=0;this.geometry.getVertexForIndex(h[0],t.VertexFormat.VF_POSITION,u);r.vct1.setTo(u[0],u[1],u[2]);u.length=0;this.geometry.getVertexForIndex(h[1],t.VertexFormat.VF_POSITION,u);r.vct2.setTo(u[0],u[1],u[2]);u.length=0;this.geometry.getVertexForIndex(h[2],t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL,u);r.vct3.setTo(u[0],u[1],u[2]);n=new t.Vector3D;n.setTo(u[3],u[4],u[5]);this.normalList.push(n);s=Math.random();if(s<.333){a.copyFrom(r.vct1)}else if(s<.666){a.copyFrom(r.vct2)}else{a.copyFrom(r.vct3)}}};r.prototype.calcNormal=function(t,e,i){r.crsVector1.setTo(e.x-t.x,e.y-t.y,e.z-t.z);r.crsVector2.setTo(i.x-t.x,i.y-t.y,i.z-t.z);r.crsVector1.normalize();r.crsVector2.normalize();this.normal=r.crsVector2.crossProduct(r.crsVector1);this.normal.normalize();return this.normal};r.vct1=new t.Vector3D;r.vct2=new t.Vector3D;r.vct3=new t.Vector3D;r.crsVector1=new t.Vector3D;r.crsVector2=new t.Vector3D;return r}(i);t.Mesh3DValueShape=m;var v=function(i){__extends(r,i);function r(){i.apply(this,arguments);this.valueType=e.vec3}r.prototype.calculate=function(e){var i=[];for(var r=1;r<arguments.length;r++){i[r-1]=arguments[r]}var a=[];var n=[];n.push(new t.Vector3D(0,0,0));n.push(new t.Vector3D(-200,1e3,700));n.push(new t.Vector3D(200,-50,300));n.push(new t.Vector3D(-300,-220,500));var o=n[0];var s=n[1];var h=n[2];var u=n[3];var l;var c;var f;var d;var p;for(var _=0;_<e;_++){l=Math.random();c=1-l;f=o.x*c*c*c+3*s.x*c*c*l+3*h.x*c*l*l+u.x*l*l*l;d=o.y*c*c*c+3*s.y*c*c*l+3*h.y*c*l*l+u.y*l*l*l;p=o.z*c*c*c+3*s.z*c*c*l+3*h.z*c*l*l+u.z*l*l*l;a.push(new t.Vector3D(f,d,p))}return a};return r}(i);var g=function(t){__extends(i,t);function i(){t.apply(this,arguments);this.valueType=e.vec3}i.prototype.calculate=function(t){var e=[];for(var i=1;i<arguments.length;i++){e[i-1]=arguments[i]}var r=this.positionList.slice();return r};return i}(i);t.ValueShapeExternal=g;var y=function(){function t(){this.emitter={}}t.calculate=function(t,e){return e.calculate(t,e)};t.getValues=function(t,e,i){};t._instance=new t;return t}();t.Value=y})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleEndNode";this.importShader(true,t.ShaderPhaseType.end_vertex,"particle_end_vs");this.importShader(false,t.ShaderPhaseType.end_fragment,"particle_end_fs")}i.prototype.build=function(t,e){};return i}(t.AnimationNode);t.ParticleEndNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._tiny=.001}e.prototype.generator=function(e){this._inputCount=2e3;this._data=e;this._node=e.life;this._burstsClone=e.emission.bursts;if(this._burstsClone){this._burstsClone=this._burstsClone.slice()}this.planes=[];this.loopTime=this.circleTime=0;if(this._data.emission.type==t.ParticleValueType.Const){this.generatorConst()}else{this.generatorBezier()}this.planes.sort(function(t,e){return t.x-e.x});var i;var r=0;for(var a=0,n=this.planes;a<n.length;a++){i=n[a];this.circleTime=Math.max(this.circleTime,i.x+i.y);this.loopTime=Math.max(this.loopTime,i.y);r=i.x}if(r>this.loopTime){this.loopTime=r}if(this.loopTime<this._data.life.duration){this.loopTime=this._data.life.duration}this.circleTime+=this._data.life.delay};e.prototype.burstPlanes=function(t,e){var i;var r;var a;var n;for(var o=0,s=this._burstsClone.length;o<s;o++){i=this._burstsClone[o];r=i.x;n=false;if(r>=t&&r<=e){a=Math.min(i.y,this._data.property.particleCount);for(var h=0;h<a;h++){this.tryCreatePlane(r)}n=true}else if(r>=this._data.life.duration){n=true}if(n){this._burstsClone.splice(o,1);o--;s--}}};e.prototype.generatorConst=function(){if(this._data.emission.type==t.ParticleValueType.Const&&this._data.life.type==t.ParticleValueType.Const){this._data.life.duration=Math.ceil(this._data.life.duration/this._data.life.max)*this._data.life.max}var e=this._data.emission.rate;if(e==0){while(this._burstsClone&&this._burstsClone.length>0&&this.planes.length<this._inputCount){this.burstPlanes(0,t.MathUtil.MAX_VALUE)}return}var i=Math.max(1/e,this._tiny);var r=this._data.life.duration;var a=0;var n=i;while(a<=this._data.life.duration&&this.planes.length<this._inputCount){this.tryCreatePlane(a);n=a+i;if(this._burstsClone&&this._burstsClone.length>0){this.burstPlanes(a,n)}a=n}};e.prototype.generatorBezier=function(){var t=1/20;var e=this._data.life.duration;var i=t;var r=i;var a=0;var n=0;var o=0;while(i<e&&this.planes.length<this._inputCount){a+=this._data.emission.bezier.calc(i/e)*t;n=Math.floor(a);a-=n;if(n>0){o=t/n;while(n>0){r+=o;this.tryCreatePlane(i);if(this._burstsClone&&this._burstsClone.length>0){this.burstPlanes(i,r)}i=r;n--}}else{r=i+t;if(this._burstsClone&&this._burstsClone.length>0){this.burstPlanes(i,r)}i=r}}};e.prototype.tryCreatePlane=function(e){var i=0;var r;var a;var n=this._data.property.particleCount;for(var o=0,s=this.planes.length;o<s;o++){a=this.planes[o];r=a.x;if(a.x+a.y>e+.01){i++}}if(i<n){a=new t.Point(e,this.getLifeTime(e));this.planes.push(a)}};e.prototype.getLifeTime=function(e){var i=this._data.life.type;var r=this._data.life;var a;var n;if(r.type==t.ParticleValueType.Const){a=n=r.max}else if(r.type==t.ParticleValueType.RandomConst){a=r.max;n=r.min}else if(r.type==t.ParticleValueType.OneBezier){a=n=r.bezier1.calc(e/r.duration)}else{a=r.bezier1.calc(e/r.duration);n=r.bezier2.calc(e/r.duration)}return Math.random()*(a-n)+n};e.prototype.dispose=function(){this._data=null;this._node=null;this._burstsClone=null;this.planes=null};return e}();t.ParticleLifeGenerator=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleSpeedNode";this.importShader(true,t.ShaderPhaseType.utils_vertex,"particle_bezier");this.importShader(false,t.ShaderPhaseType.utils_fragment,"particle_bezier");this.importShader(false,t.ShaderPhaseType.diffuse_fragment,"particle_diffuse_fragment");this.attribute_time=new t.GLSL.VarRegister;this.attribute_time.name="attribute_time";this.attribute_time.size=3;this.attributes.push(this.attribute_time)}i.prototype.initNode=function(t){};i.prototype.build=function(t,e){this._animationState=this.state;var i=this._animationState.emitter.generator;var r=t.vertexCount/e;var a=0;var n;var o=i.planes;for(var s=0;s<e;++s){n=o[s];for(var h=0;h<r;++h){a=s*r+h;a=a*t.vertexAttLength+this.attribute_time.offsetIndex;t.vertexArray[a+0]=n.x;t.vertexArray[a+1]=n.y;t.vertexArray[a+2]=s}}this._animationState.modTime=i.loopTime;this._animationState.emitter.animation.loopTime=i.circleTime};i.prototype.afterBuild=function(){};Object.defineProperty(i.prototype,"offsetIndex",{get:function(){return this.attribute_time.offsetIndex},enumerable:true,configurable:true});i.prototype.dispose=function(){e.prototype.dispose.call(this);this._animationState=null};return i}(t.AnimationNode);t.ParticleTime=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticlePosition";this.attribute_offsetPosition=new t.GLSL.VarRegister;this.attribute_offsetPosition.name="attribute_offsetPosition";this.attribute_offsetPosition.size=3;this.attributes.push(this.attribute_offsetPosition)}i.prototype.initNode=function(e,i){var r=i.renderMode;if(r==t.ParticleRenderModeType.StretchedBillboard){this.importShader(true,t.ShaderPhaseType.local_vertex,"particle_stretched_mode")}var a=this._node=e;if(a.type==t.ParticleDataShapeType.Point){var n=new t.Vec3ConstValueShape;n.minX=0;n.minY=0;n.minZ=0;this._positions=n}else if(a.type==t.ParticleDataShapeType.Cube){var o=new t.CubeVector3DValueShape;o.width=a.cubeW;o.height=a.cubeH;o.depth=a.cubeD;this._positions=o}else if(a.type==t.ParticleDataShapeType.Sphere){var s=new t.BallValueShape;s.r=a.sphereRadius;s.fromShell=a.emitFromShell;this._positions=s}else if(a.type==t.ParticleDataShapeType.HemiSphere){var h=new t.HemiBallValueShape;h.r=a.hemiSphereRadius;h.fromShell=a.emitFromShell;this._positions=h}else if(a.type==t.ParticleDataShapeType.Cone){var u=new t.ConeValueShape;u.angle=a.coneAngle;u.length=a.coneLength;u.radius=a.coneRadius;u.coneType=a.coneType;this._positions=u}else if(a.type==t.ParticleDataShapeType.Mesh){var l=new t.Mesh3DValueShape;l.geometry=a.geometry;l.type=a.meshType;this._positions=l}else if(a.type==t.ParticleDataShapeType.External){var c=new t.ValueShapeExternal;c.positionList=a.externalPositionList;this._positions=c}};Object.defineProperty(i.prototype,"offsetIndex",{get:function(){return this.attribute_offsetPosition.offsetIndex},enumerable:true,configurable:true});i.prototype.build=function(e,i){this._animationState=this.state;var r=this._positions.calculate(i);var a=this._animationState.directionArray=[];var n;if(this._node.type==t.ParticleDataShapeType.Mesh){n=this._positions.normalList}var o=e.vertexCount/i;var s=0;var h=this._animationState.emitter.data;var u=new t.Vector3D;var l=this._positions;for(var c=0;c<i;++c){var f=r[c];u.copyFrom(f);var d=new t.Vector3D;if(h.shape.randomDirection){if(this._node.type==t.ParticleDataShapeType.Cone&&(this._node.coneType==t.ParticleConeShapeType.Base||this._node.coneType==t.ParticleConeShapeType.BaseShell)){this._positions.randomDirectionToTop(d)}else{d.setTo(Math.random()-.5,Math.random()-.5,Math.random()-.5)}}else{if(this._node.type==t.ParticleDataShapeType.Point){d.setTo(0,0,1,1)}else if(this._node.type==t.ParticleDataShapeType.Cube){d.setTo(0,0,1,1)}else if(this._node.type==t.ParticleDataShapeType.Sphere){d.copyFrom(u)}else if(this._node.type==t.ParticleDataShapeType.HemiSphere){d.copyFrom(u)}else if(this._node.type==t.ParticleDataShapeType.Cone){d=l.directions[c]}else if(this._node.type==t.ParticleDataShapeType.Mesh){d.copyFrom(n[c])}else if(this._node.type==t.ParticleDataShapeType.External){d.setTo(0,0,1,1)}}d.normalize();a.push(d);for(var p=0;p<o;++p){s=c*o+p;s=s*e.vertexAttLength+this.attribute_offsetPosition.offsetIndex;e.vertexArray[s+0]=f.x;e.vertexArray[s+1]=f.y;e.vertexArray[s+2]=f.z}}};i.prototype.afterBuild=function(){this._positions.dispose();this._positions=null;this._animationState.directionArray.length=0;this._animationState.directionArray=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._positions=null;this._animationState=null;this._node=null};return i}(t.AnimationNode);t.ParticlePosition=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleRotation";this.attribute_rotationBirth=new t.GLSL.VarRegister;this.attribute_rotationBirth.name="attribute_rotationBirth";this.attribute_rotationBirth.size=1;this.attributes.push(this.attribute_rotationBirth)}i.prototype.initNode=function(e){var i=this._node=e;this._rotations=new t.ConstRandomValueShape;this._rotations.max=i.max;this._rotations.min=i.min};i.prototype.build=function(e,i){this._animationState=this.state;var r=this._animationState.emitter.data.property.renderMode;if(r==t.ParticleRenderModeType.StretchedBillboard){return}var a=this._rotations.calculate(i);var n=e.vertexCount/i;var o=0;var s=new t.Vector3D;var h;var u=0;var l=this._animationState.emitter.data.life.duration;var c=this._animationState.emitter.timeNode.offsetIndex;var f=0;var d;var p;for(var _=0;_<i;++_){if(this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){d=f*e.vertexAttLength+c;p=e.vertexArray[d+0];u=p/l;u=u-Math.floor(u);h=this._node.bezier1.calc(u);if(this._node.type==t.ParticleValueType.TwoBezier){var m=Math.random();h*=m;h+=this._node.bezier2.calc(u)*(1-m)}}else{h=a[_]}for(var v=0;v<n;++v){o=_*n+v;o=o*e.vertexAttLength+this.attribute_rotationBirth.offsetIndex;e.vertexArray[o+0]=h}}};i.prototype.afterBuild=function(){this._rotations.dispose();this._rotations=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._animationState=null;this._node=null;this._rotations=null};return i}(t.AnimationNode);t.ParticleRotation=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleScale"}i.prototype.initNode=function(e){var i=this._node=e;this._scaleValue=new t.ConstRandomValueShape;this._scaleValue.max=i.max;this._scaleValue.min=i.min};i.prototype.build=function(e,i){this._animationState=this.state;var r=this._scaleValue.calculate(i);var a=e.vertexCount/i;var n=0;var o=0;var s=this._animationState.emitter.data.life.duration;var h=this._animationState.emitter.timeNode.offsetIndex;var u=0;var l;var c;var f=0;for(var d=0;d<i;++d){if(this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){l=u*e.vertexAttLength+h;c=e.vertexArray[l+0];o=c/s;o=o-Math.floor(o);f=this._node.bezier1.calc(o);if(this._node.type==t.ParticleValueType.TwoBezier){var p=Math.random();f*=p;f+=this._node.bezier2.calc(o)*(1-p)}r[d]=f}else{f=r[d]}}this._animationState.scaleBirthArray=r};i.prototype.afterBuild=function(){this._scaleValue.dispose();this._scaleValue=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._animationState=null;this._node=null;this._scaleValue=null};return i}(t.AnimationNode);t.ParticleScale=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.bornTime=0;this.life=0;this.id=0;this.timeIndex=0;this.name="ParticleStartColor"}i.prototype.initNode=function(t){this._node=t};i.prototype.build=function(e,i){this._animationState=this.state;var r=6;var a=e.vertexCount/i;var n=0;var o=this._animationState.emitter.timeNode.offsetIndex;var s=0;var h=new t.Color;var u=new t.Color;var l=0;var c=this._animationState.emitter.data.life.duration;var f=1/255;for(var d=0;d<i;++d){s=d*a;this.timeIndex=s*e.vertexAttLength+o;this.bornTime=e.vertexArray[this.timeIndex+0];l=this.bornTime/c;l=l-Math.floor(l);this.lerpBirthColor(h,u,l);h.scaleBy(f);for(var p=0;p<a;++p){n=d*a+p;n=n*e.vertexAttLength+r;e.vertexArray[n+0]=h.r;e.vertexArray[n+1]=h.g;e.vertexArray[n+2]=h.b;e.vertexArray[n+3]=h.a}}};i.prototype.lerpBirthColor=function(e,i,r){if(this._node.colorType==t.ParticleBirthColorType.Const){e.copyFrom(this._node.colorConst1)}else if(this._node.colorType==t.ParticleBirthColorType.RandomConst){e.randomColor(this._node.colorConst1,this._node.colorConst2,true)}else if(this._node.colorType==t.ParticleBirthColorType.OneGradients){this._node.colorGradients1.lerpColor(r,e)}else if(this._node.colorType==t.ParticleBirthColorType.TwoGradients){this._node.colorGradients1.lerpColor(r,e);this._node.colorGradients2.lerpColor(r,i);e.lerp(e,i,.5)}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._node=null};return i}(t.AnimationNode);t.ParticleStartColor=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._count=0;this._followRotation=false;this._followScale=false;this.bornTime=0;this.life=0;this.id=0;this.timeIndex=0;this._verticesDataDirty=false;this.name="ParticleFollowNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_follow_vs");this.attribute_followPosition=new t.GLSL.VarRegister;this.attribute_followPosition.name="attribute_followPosition";this.attribute_followPosition.size=3;this.attributes.push(this.attribute_followPosition);this.attribute_followRotation=new t.GLSL.VarRegister;this.attribute_followRotation.name="attribute_followRotation";this.attribute_followRotation.size=4;this.attributes.push(this.attribute_followRotation);
this.attribute_followScale=new t.GLSL.VarRegister;this.attribute_followScale.name="attribute_followScale";this.attribute_followScale.size=3;this.attributes.push(this.attribute_followScale)}i.prototype.initNode=function(t){var e=t;this._followScale=e.followScale;this._followRotation=e.followRotation};i.prototype.onAnimTimeChange=function(){e.prototype.onAnimTimeChange.call(this);this.resetCircleData()};i.prototype.build=function(t,e){this._count=e;this._animationState=this.state;this._lifeCircles=[];this.resetCircleData()};i.prototype.resetCircleData=function(){for(var t=0;t<this._count;t++){this._lifeCircles[t]=-1}};i.prototype.update=function(t,e,i){this._verticesDataDirty=this._verticesDataDirty;var r=this._animationState.emitter.data;var a=r.life.loop;var n=this._animationState.modTime+r.life.duration+r.life.delay;if(!a&&t*.001>=n){return}var o=0;var s=i.vertexCount/this._count;var h=0;var u=false;var l=this._animationState.emitter.timeNode.offsetIndex;var c=t*.001-r.life.delay;var f=i.sharedVertexBuffer?i.sharedVertexBuffer.arrayBuffer:i.vertexArray;var d=this._animationState.followTarget||this._animationState.emitter;for(var p=0;p<this._count;++p){h=p*s;this.timeIndex=h*i.vertexAttLength+l;this.bornTime=f[this.timeIndex+0];this.life=f[this.timeIndex+1];var _=-1;if(c>=this.bornTime){if(c>this.bornTime+this.life&&!a)continue;_=Math.floor((c-this.bornTime)/this._animationState.modTime);if((c-this.bornTime)%this._animationState.modTime>this.life){continue}if(_!=this._lifeCircles[p]){this._lifeCircles[p]=_;u=true;for(var m=0;m<s;++m){o=h+m;o=o*i.vertexAttLength+this.attribute_followPosition.offsetIndex;if(true){f[o+0]=d.globalPosition.x;f[o+1]=d.globalPosition.y;f[o+2]=d.globalPosition.z}o=h+m;o=o*i.vertexAttLength+this.attribute_followRotation.offsetIndex;if(this._followRotation){f[o+0]=d.globalOrientation.x;f[o+1]=d.globalOrientation.y;f[o+2]=d.globalOrientation.z;f[o+3]=d.globalOrientation.w}else{f[o+0]=0;f[o+1]=0;f[o+2]=0;f[o+3]=0}o=h+m;o=o*i.vertexAttLength+this.attribute_followScale.offsetIndex;if(this._followScale){f[o+0]=d.globalScaleX;f[o+1]=d.globalScaleY;f[o+2]=d.globalScaleZ}else{f[o+0]=0;f[o+1]=0;f[o+2]=0}}}}}this._verticesDataDirty=u};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._verticesDataDirty){n.geometry.upload(o);this._verticesDataDirty=false}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._animationState=null;this._lifeCircles=null};return i}(t.AnimationNode);t.ParticleFollowNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocity");this.attribute_velocity=new t.GLSL.VarRegister;this.attribute_velocity.name="attribute_velocity";this.attribute_velocity.size=3;this.attributes.push(this.attribute_velocity)}i.prototype.initNode=function(e){var i=this._node=e;if(i.type==t.ParticleValueType.Const||i.type==t.ParticleValueType.RandomConst){this._constValue=new t.ConstRandomValueShape;this._constValue.max=i.max;this._constValue.min=i.min}};i.prototype.build=function(e,i){this._animationState=this.state;var r=e.vertexCount/i;var a=0;var n;if(this._constValue)n=this._constValue.calculate(i);var o=this._animationState.directionArray;var s=new t.Vector3D;var h=0;var u=this._animationState.emitter.data.life.duration;var l=this._animationState.emitter.timeNode.offsetIndex;var c=0;var f;var d;var p;for(var _=0;_<i;++_){c=_*r;if(this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){f=c*e.vertexAttLength+l;d=e.vertexArray[f+0];h=d/u;h=h-Math.floor(h);p=this._node.bezier1.calc(h);if(this._node.type==t.ParticleValueType.TwoBezier){var m=Math.random();p*=m;p+=this._node.bezier2.calc(h)*(1-m)}}else{p=n[_]}s.copyFrom(o[_]);s.scaleBy(p);for(var v=0;v<r;++v){a=_*r+v;a=a*e.vertexAttLength+this.attribute_velocity.offsetIndex;e.vertexArray[a+0]=s.x;e.vertexArray[a+1]=s.y;e.vertexArray[a+2]=s.z}}};i.prototype.afterBuild=function(){this._constValue&&this._constValue.dispose();this._constValue=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._constValue=null;this._animationState=null;this._node=null};return i}(t.AnimationNode);t.ParticleVelocityNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._colorSegment=new Float32Array(i.MaxColor*2);this.name="ParticleColorGlobalNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_color_vs");this.importShader(false,t.ShaderPhaseType.end_fragment,"particle_color_fs")}i.prototype.initNode=function(t){var e=t;var r=i.MaxColor;var a=e.data;a.colors.length=a.times.length=r;var n;for(var o=0;o<r;o++){n=a.colors[o];if(n){this._colorSegment[o]=this.getGpuColor(n.r,n.g,n.b);this._colorSegment[o+r]=this.getTimeAndAlpha(a.times[o],n.a)}else{this._colorSegment[o]=0;this._colorSegment[o+r]=0}}};i.prototype.build=function(t,e){};i.prototype.activeState=function(t,e,i,r,a,n,o){if(a["uniform_colorTransform"]){o.uniform1fv(a["uniform_colorTransform"].uniformIndex,this._colorSegment)}};i.prototype.getGpuColor=function(t,e,i){var r;t=this.normalizeChannel(t);e=this.normalizeChannel(e);i=this.normalizeChannel(i);r=t*256+e+i/256;return r};i.prototype.normalizeChannel=function(t){if(t>255)t=255;else if(t<0)t=0;t=Math.floor(t);return t};i.prototype.normalizeTime=function(t){if(t>=1)t=.9999;else if(t<0)t=0;return t};i.prototype.getTimeAndAlpha=function(t,e){e=this.normalizeChannel(e);t=this.normalizeTime(t);return e+t};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._colorSegment=null};i.MaxColor=20;return i}(t.AnimationNode);t.ParticleColorGlobalNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleSizeGlobalNode"}i.prototype.initNode=function(e){this._node=e;this.attribute_scaleSizeConst=new t.GLSL.VarRegister;this.attribute_scaleSizeConst.name="attribute_scaleSizeConst";this.attribute_scaleSizeConst.size=1;this.attributes.push(this.attribute_scaleSizeConst);this.importShader(true,t.ShaderPhaseType.local_vertex,"particle_scaleSizeConst");if(this._node){this._sizeScale=new t.ConstRandomValueShape;this._sizeScale.max=this._node.max;this._sizeScale.min=this._node.min;if(this._node.type==t.ParticleValueType.OneBezier){this._floatCompressData1=this._node.bezier1.sampler();this.importShader(true,t.ShaderPhaseType.local_vertex,"particle_scaleSizeBezier1")}else if(this._node.type==t.ParticleValueType.TwoBezier){this.importShader(true,t.ShaderPhaseType.local_vertex,"particle_scaleSizeBezier2");this._floatCompressData2=this._node.bezier1.sampler();this._floatCompressData2=this._node.bezier2.sampler();this.attribute_bezierRandomSeed=new t.GLSL.VarRegister;this.attribute_bezierRandomSeed.name="attribute_bezierRandomSeed";this.attribute_bezierRandomSeed.size=1;this.attributes.push(this.attribute_bezierRandomSeed)}}};i.prototype.build=function(e,i){var r=this.state;this._scaleResult=r.scaleBirthArray;var a=0;var n=e.vertexCount/i;if(this._node){if(this._node.type==t.ParticleValueType.TwoBezier){for(var o=0;o<i;++o){var s=Math.random();for(var h=0;h<n;++h){a=o*n+h;a=a*e.vertexAttLength+this.attribute_bezierRandomSeed.offsetIndex;e.vertexArray[a+0]=s}}}if(this._node.type==t.ParticleValueType.Const||this._node.type==t.ParticleValueType.RandomConst){var u=this._sizeScale.calculate(i);for(var o=0;o<i;o++){this._scaleResult[o]*=u[o]}}}for(var o=0;o<i;++o){for(var h=0;h<n;++h){a=o*n+h;a=a*e.vertexAttLength+this.attribute_scaleSizeConst.offsetIndex;e.vertexArray[a+0]=this._scaleResult[o]}}};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._floatCompressData1){o.uniform1fv(a["uniform_scaleSizeBezier1"].uniformIndex,this._floatCompressData1)}if(this._floatCompressData2){o.uniform1fv(a["uniform_scaleSizeBezier2"].uniformIndex,this._floatCompressData2)}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressData1=null;this._floatCompressData2=null;this._node=null};return i}(t.AnimationNode);t.ParticleSizeGlobalNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityOverConstNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverConst");this.attribute_velocityOver=new t.GLSL.VarRegister;this.attribute_velocityOver.name="attribute_velocityOverConst";this.attribute_velocityOver.size=3;this.attributes.push(this.attribute_velocityOver)}i.prototype.initNode=function(e){var i=e;this._overValue=new t.Vec3ConstRandomValueShape;this._overValue.maxX=i.velocityOver.max.x;this._overValue.maxY=i.velocityOver.max.y;this._overValue.maxZ=i.velocityOver.max.z;this._overValue.minX=i.velocityOver.min.x;this._overValue.minY=i.velocityOver.min.y;this._overValue.minZ=i.velocityOver.min.z};i.prototype.build=function(t,e){this._animationState=this.state;var i=t.vertexCount/e;var r=0;var a=this._overValue.calculate(e);for(var n=0;n<e;++n){var o=a[n];for(var s=0;s<i;++s){r=n*i+s;r=r*t.vertexAttLength+this.attribute_velocityOver.offsetIndex;t.vertexArray[r+0]=o.x;t.vertexArray[r+1]=o.y;t.vertexArray[r+2]=o.z}}};i.prototype.afterBuild=function(){this._overValue.dispose();this._overValue=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._overValue=null;this._animationState=null};return i}(t.AnimationNode);t.ParticleVelocityOverConstNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityOverOneBezierNode"}i.prototype.initNode=function(e){this._node=e;this._floatCompressDataX=this._node.velocityOver.xBezier1.trySampler();this._floatCompressDataY=this._node.velocityOver.yBezier1.trySampler();this._floatCompressDataZ=this._node.velocityOver.zBezier1.trySampler();this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverOneBezier");if(this._floatCompressDataX){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverOneBezierX")}if(this._floatCompressDataY){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverOneBezierY")}if(this._floatCompressDataZ){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverOneBezierZ")}};i.prototype.build=function(t,e){};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._floatCompressDataX){o.uniform1fv(a["uniform_velocityOverX"].uniformIndex,this._floatCompressDataX)}if(this._floatCompressDataY){o.uniform1fv(a["uniform_velocityOverY"].uniformIndex,this._floatCompressDataY)}if(this._floatCompressDataZ){o.uniform1fv(a["uniform_velocityOverZ"].uniformIndex,this._floatCompressDataZ)}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressDataX=this._floatCompressDataY=this._floatCompressDataZ=null;this._node=null};return i}(t.AnimationNode);t.ParticleVelocityOverOneBezierNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityOverTwoBezierNode";this.attribute_randomSeed=new t.GLSL.VarRegister;this.attribute_randomSeed.name="attribute_velocityOverRandomSeed";this.attribute_randomSeed.size=1;this.attributes.push(this.attribute_randomSeed)}i.prototype.initNode=function(e){this._node=e;this._floatCompressDataX1=this._node.velocityOver.xBezier1.trySampler();this._floatCompressDataY1=this._node.velocityOver.yBezier1.trySampler();this._floatCompressDataZ1=this._node.velocityOver.zBezier1.trySampler();this._floatCompressDataX2=this._node.velocityOver.xBezier2.trySampler();this._floatCompressDataY2=this._node.velocityOver.yBezier2.trySampler();this._floatCompressDataZ2=this._node.velocityOver.zBezier2.trySampler();this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezier");if(this._floatCompressDataX1){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierX1")}if(this._floatCompressDataX2){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierX2")}if(this._floatCompressDataY1){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierY1")}if(this._floatCompressDataY2){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierY2")}if(this._floatCompressDataZ1){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierZ1")}if(this._floatCompressDataZ2){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierZ2")}};i.prototype.build=function(t,e){this._animationState=this.state;var i=t.vertexCount/e;var r=0;for(var a=0;a<e;++a){var n=Math.random();for(var o=0;o<i;++o){r=a*i+o;r=r*t.vertexAttLength+this.attribute_randomSeed.offsetIndex;t.vertexArray[r+0]=n}}};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._floatCompressDataX1){o.uniform1fv(a["uniform_velocityOverX1"].uniformIndex,this._floatCompressDataX1)}if(this._floatCompressDataX2){o.uniform1fv(a["uniform_velocityOverX2"].uniformIndex,this._floatCompressDataX2)}if(this._floatCompressDataY1){o.uniform1fv(a["uniform_velocityOverY1"].uniformIndex,this._floatCompressDataY1)}if(this._floatCompressDataY2){o.uniform1fv(a["uniform_velocityOverY2"].uniformIndex,this._floatCompressDataY2)}if(this._floatCompressDataZ1){o.uniform1fv(a["uniform_velocityOverZ1"].uniformIndex,this._floatCompressDataZ1)}if(this._floatCompressDataZ2){o.uniform1fv(a["uniform_velocityOverZ2"].uniformIndex,this._floatCompressDataZ2)}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressDataX1=this._floatCompressDataY1=this._floatCompressDataZ1=null;this._floatCompressDataX2=this._floatCompressDataY2=this._floatCompressDataZ2=null;this._node=null;this._animationState=null};return i}(t.AnimationNode);t.ParticleVelocityOverTwoBezierNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityForceConstNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceConst");this.attribute_accelerationSpeed=new t.GLSL.VarRegister;this.attribute_accelerationSpeed.name="attribute_velocityForceConst";this.attribute_accelerationSpeed.size=3;this.attributes.push(this.attribute_accelerationSpeed)}i.prototype.initNode=function(e){this._node=e;var i=this._node.velocityForce;this._forceValue=new t.Vec3ConstRandomValueShape;this._forceValue.maxX=i.max.x;this._forceValue.maxY=i.max.y;this._forceValue.maxZ=i.max.z;this._forceValue.minX=i.min.x;this._forceValue.minY=i.min.y;this._forceValue.minZ=i.min.z};i.prototype.build=function(t,e){var i=t.vertexCount/e;var r=0;var a=this._forceValue.calculate(e);for(var n=0;n<e;++n){var o=a[n];for(var s=0;s<i;++s){r=n*i+s;r=r*t.vertexAttLength+this.attribute_accelerationSpeed.offsetIndex;t.vertexArray[r+0]=o.x;t.vertexArray[r+1]=o.y;t.vertexArray[r+2]=o.z}}};i.prototype.afterBuild=function(){this._forceValue.dispose();this._forceValue=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._forceValue=null;this._node=null};return i}(t.AnimationNode);t.ParticleVelocityForceConstNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityForceOneBezierNode"}i.prototype.initNode=function(e){this._node=e;this._floatCompressDataX=this._node.velocityForce.xBezier1.trySampler();this._floatCompressDataY=this._node.velocityForce.yBezier1.trySampler();this._floatCompressDataZ=this._node.velocityForce.zBezier1.trySampler();this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceOneBezier");if(this._floatCompressDataX){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceOneBezierX")}if(this._floatCompressDataY){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceOneBezierY")}if(this._floatCompressDataZ){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceOneBezierZ")}};i.prototype.build=function(t,e){};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._floatCompressDataX){o.uniform1fv(a["uniform_velocityForceX"].uniformIndex,this._floatCompressDataX)}if(this._floatCompressDataY){o.uniform1fv(a["uniform_velocityForceY"].uniformIndex,this._floatCompressDataY)}if(this._floatCompressDataZ){o.uniform1fv(a["uniform_velocityForceZ"].uniformIndex,this._floatCompressDataZ)}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressDataX=this._floatCompressDataY=this._floatCompressDataZ=null;this._node=null};return i}(t.AnimationNode);t.ParticleVelocityForceOneBezierNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityForceTwoBezierNode";this.attribute_randomSeed=new t.GLSL.VarRegister;this.attribute_randomSeed.name="attribute_velocityForceRandomSeed";this.attribute_randomSeed.size=1;this.attributes.push(this.attribute_randomSeed)}i.prototype.initNode=function(e){this._node=e;this._floatCompressDataX1=this._node.velocityForce.xBezier1.trySampler();this._floatCompressDataY1=this._node.velocityForce.yBezier1.trySampler();this._floatCompressDataZ1=this._node.velocityForce.zBezier1.trySampler();this._floatCompressDataX2=this._node.velocityForce.xBezier2.trySampler();this._floatCompressDataY2=this._node.velocityForce.yBezier2.trySampler();this._floatCompressDataZ2=this._node.velocityForce.zBezier2.trySampler();this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezier");if(this._floatCompressDataX1){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierX1")}if(this._floatCompressDataX2){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierX2")}if(this._floatCompressDataY1){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierY1")}if(this._floatCompressDataY2){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierY2")}if(this._floatCompressDataZ1){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierZ1")}if(this._floatCompressDataZ2){this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierZ2")}};i.prototype.build=function(t,e){this._animationState=this.state;var i=t.vertexCount/e;var r=0;for(var a=0;a<e;++a){var n=Math.random();for(var o=0;o<i;++o){r=a*i+o;r=r*t.vertexAttLength+this.attribute_randomSeed.offsetIndex;t.vertexArray[r+0]=n}}};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._floatCompressDataX1){o.uniform1fv(a["uniform_velocityForceX1"].uniformIndex,this._floatCompressDataX1)}if(this._floatCompressDataX2){o.uniform1fv(a["uniform_velocityForceX2"].uniformIndex,this._floatCompressDataX2)}if(this._floatCompressDataY1){o.uniform1fv(a["uniform_velocityForceY1"].uniformIndex,this._floatCompressDataY1)}if(this._floatCompressDataY2){o.uniform1fv(a["uniform_velocityForceY2"].uniformIndex,this._floatCompressDataY2)}if(this._floatCompressDataZ1){o.uniform1fv(a["uniform_velocityForceZ1"].uniformIndex,this._floatCompressDataZ1)}if(this._floatCompressDataZ2){o.uniform1fv(a["uniform_velocityForceZ2"].uniformIndex,this._floatCompressDataZ2)}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressDataX1=this._floatCompressDataY1=this._floatCompressDataZ1=null;this._floatCompressDataX2=this._floatCompressDataY2=this._floatCompressDataZ2=null;this._node=null;this._animationState=null};return i}(t.AnimationNode);t.ParticleVelocityForceTwoBezierNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityLimitConstNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityLimitConst");this.attribute_velocityLimit=new t.GLSL.VarRegister;this.attribute_velocityLimit.name="attribute_velocityLimit";this.attribute_velocityLimit.size=1;this.attributes.push(this.attribute_velocityLimit)}i.prototype.initNode=function(e){var i=e;this._limitValue=new t.ConstRandomValueShape;this._limitValue.max=i.velocityLimit.max;this._limitValue.min=i.velocityLimit.min};i.prototype.build=function(t,e){this._animationState=this.state;var i=t.vertexCount/e;var r=0;var a=this._limitValue.calculate(e);for(var n=0;n<e;++n){var o=a[n];for(var s=0;s<i;++s){r=n*i+s;r=r*t.vertexAttLength+this.attribute_velocityLimit.offsetIndex;t.vertexArray[r+0]=o}}};i.prototype.afterBuild=function(){this._limitValue.dispose();this._limitValue=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._animationState=null;this._limitValue=null};return i}(t.AnimationNode);t.ParticleVelocityLimitConstNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityLimitOneBezierNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityLimitOneBezier")}i.prototype.initNode=function(t){this._node=t;this._floatCompressData=this._node.velocityLimit.bezier1.sampler()};i.prototype.build=function(t,e){};i.prototype.activeState=function(t,e,i,r,a,n,o){o.uniform1fv(a["uniform_velocityLimit"].uniformIndex,this._floatCompressData)};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressData=null;this._node=null};return i}(t.AnimationNode);t.ParticleVelocityLimitOneBezierNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleVelocityLimitTwoBezierNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_velocityLimitTwoBezier");this.attribute_randomSeed=new t.GLSL.VarRegister;this.attribute_randomSeed.name="attribute_velocityLimitRandomSeed";this.attribute_randomSeed.size=1;this.attributes.push(this.attribute_randomSeed)}i.prototype.initNode=function(t){this._node=t;this._floatCompressData=this._node.velocityLimit.bezier1.sampler();this._floatCompressData2=this._node.velocityLimit.bezier2.sampler()};i.prototype.build=function(t,e){this._animationState=this.state;var i=t.vertexCount/e;var r=0;for(var a=0;a<e;++a){var n=Math.random();for(var o=0;o<i;++o){r=a*i+o;r=r*t.vertexAttLength+this.attribute_randomSeed.offsetIndex;t.vertexArray[r+0]=n}}};i.prototype.activeState=function(t,e,i,r,a,n,o){o.uniform1fv(a["uniform_velocityLimit"].uniformIndex,this._floatCompressData);o.uniform1fv(a["uniform_velocityLimit2"].uniformIndex,this._floatCompressData2)};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressData=null;this._floatCompressData2=null;this._animationState=null;this._node=null};return i}(t.AnimationNode);t.ParticleVelocityLimitTwoBezierNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleRotationConstNode";this.importShader(true,t.ShaderPhaseType.local_vertex,"particle_rotationConst");this.attribute_Rotation=new t.GLSL.VarRegister;this.attribute_Rotation.name="attribute_rotationZ";this.attribute_Rotation.size=1;this.attributes.push(this.attribute_Rotation)}i.prototype.initNode=function(e){var i=e;this._rotation=new t.ConstRandomValueShape;this._rotation.max=i.max.z;this._rotation.min=i.min.z};i.prototype.build=function(t,e){var i=0;var r=t.vertexCount/e;var a=this._rotation.calculate(e);for(var n=0;n<e;++n){var o=a[n];for(var s=0;s<r;++s){i=n*r+s;i=i*t.vertexAttLength+this.attribute_Rotation.offsetIndex;t.vertexArray[i+0]=o}}};i.prototype.afterBuild=function(){this._rotation.dispose();this._rotation=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._rotation=null};return i}(t.AnimationNode);t.ParticleRotationConstNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleRotationXYZConstNode";this.importShader(true,t.ShaderPhaseType.local_vertex,"particle_rotationXYZConst");this.attribute_rotBirthXYZ=new t.GLSL.VarRegister;this.attribute_rotBirthXYZ.name="attribute_rotBirthXYZ";this.attribute_rotBirthXYZ.size=3;this.attributes.push(this.attribute_rotBirthXYZ);this.attribute_rotSpeedXYZ=new t.GLSL.VarRegister;this.attribute_rotSpeedXYZ.name="attribute_rotSpeedXYZ";this.attribute_rotSpeedXYZ.size=3;this.attributes.push(this.attribute_rotSpeedXYZ)}i.prototype.initNode=function(e){var i=e;this._rotationSpeed=new t.Vec3ConstRandomValueShape;this._rotationSpeed.maxX=i.max.x;this._rotationSpeed.maxY=i.max.y;this._rotationSpeed.maxZ=i.max.z;this._rotationSpeed.minX=i.min.x;this._rotationSpeed.minY=i.min.y;this._rotationSpeed.minZ=i.min.z};i.prototype.build=function(t,e){var i=0;var r=t.vertexCount/e;var a=this._rotationSpeed.calculate(e);var n;var o;var s;for(var h=0;h<e;++h){var u=a[h];n=Math.random()*360-180;o=Math.random()*360-180;s=Math.random()*360-180;for(var l=0;l<r;++l){i=h*r+l;i=i*t.vertexAttLength+this.attribute_rotSpeedXYZ.offsetIndex;t.vertexArray[i+0]=u.x;t.vertexArray[i+1]=u.y;t.vertexArray[i+2]=u.z;i=h*r+l;i=i*t.vertexAttLength+this.attribute_rotBirthXYZ.offsetIndex;t.vertexArray[i+0]=n;t.vertexArray[i+1]=o;t.vertexArray[i+2]=s}}};i.prototype.afterBuild=function(){this._rotationSpeed.dispose();this._rotationSpeed=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._rotationSpeed=null};return i}(t.AnimationNode);t.ParticleRotationXYZConstNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleRotationOneBezierNode";this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_rotationOneBezier")}i.prototype.initNode=function(t){this._node=t;this._floatCompressData=this._node.bezier1.sampler()};i.prototype.build=function(t,e){};i.prototype.activeState=function(t,e,i,r,a,n,o){o.uniform1fv(a["uniform_rotationBezier"].uniformIndex,this._floatCompressData)};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressData=null;this._node=null};return i}(t.AnimationNode);t.ParticleRotationOneBezierNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.name="ParticleRotationTwoBezierNode";this.attribute_randomSeed=new t.GLSL.VarRegister;this.attribute_randomSeed.name="attribute_rotationRandomSeed";this.attribute_randomSeed.size=1;this.attributes.push(this.attribute_randomSeed)}i.prototype.initNode=function(e){this._node=e;this._floatCompressData=this._node.bezier1.sampler();this._floatCompressData2=this._node.bezier2.sampler();this.importShader(true,t.ShaderPhaseType.global_vertex,"particle_rotationTwoBezier")};i.prototype.build=function(t,e){this._animationState=this.state;var i=t.vertexCount/e;var r=0;for(var a=0;a<e;++a){var n=Math.random();for(var o=0;o<i;++o){r=a*i+o;r=r*t.vertexAttLength+this.attribute_randomSeed.offsetIndex;t.vertexArray[r+0]=n}}};i.prototype.activeState=function(t,e,i,r,a,n,o){o.uniform1fv(a["uniform_rotationBezier"].uniformIndex,this._floatCompressData);o.uniform1fv(a["uniform_rotationBezier2"].uniformIndex,this._floatCompressData2)};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._floatCompressData=null;this._floatCompressData2=null;this._animationState=null;this._node=null};return i}(t.AnimationNode);t.ParticleRotationTwoBezierNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._sheetFloatData=new Float32Array(5);this.name="ParticleTextureSheetNode";this.attribute_textureSheetData=new t.GLSL.VarRegister;this.attribute_textureSheetData.name="attribute_textureSheetData";this.attribute_textureSheetData.size=3;this.attributes.push(this.attribute_textureSheetData);this.importShader(true,t.ShaderPhaseType.local_vertex,"particle_textureSheet_vs")}i.prototype.initNode=function(e,i){this._sheetData=i;this._sheetFloatData[0]=this._sheetData.tileX;this._sheetFloatData[1]=this._sheetData.tileY;this._sheetFloatData[2]=this._sheetData.circles;if(this._sheetData.whole){this._sheetFloatData[3]=0;this._sheetFloatData[4]=this._sheetData.tileX*this._sheetData.tileY-1}else{this._sheetFloatData[3]=0;this._sheetFloatData[4]=this._sheetData.tileY-1}if(this._sheetData.frameType==t.ParticleValueType.Const||this._sheetData.frameType==t.ParticleValueType.RandomConst){this.importShader(false,t.ShaderPhaseType.start_fragment,"particle_textureSheetConst")}else if(this._sheetData.frameType==t.ParticleValueType.OneBezier){this.importShader(false,t.ShaderPhaseType.start_fragment,"particle_textureSheetOneBezier");this._floatCompressData1=this._sheetData.bezier1.sampler()}else if(this._sheetData.frameType==t.ParticleValueType.TwoBezier){this.importShader(false,t.ShaderPhaseType.start_fragment,"particle_textureSheetTwoBezier");this._floatCompressData1=this._sheetData.bezier1.sampler();this._floatCompressData2=this._sheetData.bezier2.sampler()}};i.prototype.build=function(e,i){var r=0;var a=0;var n=0;var o=0;var s=e.vertexCount/i;for(var h=0;h<i;++h){if(this._sheetData.whole){r=0}else{if(this._sheetData.randomRow){r=Math.floor(this._sheetData.tileY*Math.random())*this._sheetData.tileX}else{r=this._sheetData.row*this._sheetData.tileX}}if(this._sheetData.frameType==t.ParticleValueType.Const||this._sheetData.frameType==t.ParticleValueType.RandomConst){a=(this._sheetData.max-this._sheetData.min)*Math.random()+this._sheetData.min;a=Math.floor(a)}else{a=0}if(this._sheetData.frameType==t.ParticleValueType.TwoBezier){n=Math.random()}else{n=1}for(var u=0;u<s;++u){o=h*s+u;o=o*e.vertexAttLength+this.attribute_textureSheetData.offsetIndex;e.vertexArray[o+0]=r+.001;e.vertexArray[o+1]=a;e.vertexArray[o+2]=n}}};i.prototype.activeState=function(e,i,r,a,n,o,s){s.uniform1fv(n["uniform_textureSheet"].uniformIndex,this._sheetFloatData);if(this._sheetData.frameType==t.ParticleValueType.OneBezier){s.uniform1fv(n["uniform_frameBezier"].uniformIndex,this._floatCompressData1)}else if(this._sheetData.frameType==t.ParticleValueType.TwoBezier){s.uniform1fv(n["uniform_frameBezier1"].uniformIndex,this._floatCompressData1);s.uniform1fv(n["uniform_frameBezier2"].uniformIndex,this._floatCompressData2)}};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._animationState=null;this._floatCompressData1=this._floatCompressData2=null;this._sheetData=null;this._sheetFloatData=null};return i}(t.AnimationNode);t.ParticleTextureSheetNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._uvRollData=new Float32Array(2);this.name="ParticleUVRollNode";this.importShader(false,t.ShaderPhaseType.start_fragment,"particle_uv_roll_fs")}i.prototype.initNode=function(t,e){this._methodData=e;this._uvRollData[0]=this._methodData.uSpeed;this._uvRollData[1]=this._methodData.vSpeed};i.prototype.build=function(t,e){};i.prototype.activeState=function(t,e,i,r,a,n,o){o.uniform1fv(a["uniform_particleUVRoll"].uniformIndex,this._uvRollData)};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._animationState=null;this._methodData=null;this._uvRollData=null};return i}(t.AnimationNode);t.ParticleUVRollNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(r,e);function r(){e.call(this);this._empty=true;this.bornTime=0;this.life=0;this.id=0;this.timeIndex=0;this.count=0;this.position=new t.Vector3D;this._added=false;this._orientation=new t.Quaternion;this._birthPhase=new i(t.ParticleDataSubEmitterPhase.BIRTH);this._collisionPhase=new i(t.ParticleDataSubEmitterPhase.COLLISION);this._deathPhase=new i(t.ParticleDataSubEmitterPhase.DEATH);this.name="ParticleSubEmitterNode"}r.prototype.initNode=function(t,e){if(e===void 0){e=null}this._parent=e};r.prototype.importSubEmitter=function(e,i){var r;if(e==t.ParticleDataSubEmitterPhase.BIRTH){r=this._birthPhase}else if(e==t.ParticleDataSubEmitterPhase.COLLISION){r=this._collisionPhase;
}else if(e==t.ParticleDataSubEmitterPhase.DEATH){r=this._deathPhase}if(r){this._empty=false;r.importSubEmitter(i)}};r.prototype.getSubEmitters=function(e){if(e==t.ParticleDataSubEmitterPhase.BIRTH){return this._birthPhase.playing.getKeys()}else if(e==t.ParticleDataSubEmitterPhase.COLLISION){return this._collisionPhase.playing.getKeys()}else if(e==t.ParticleDataSubEmitterPhase.DEATH){return this._deathPhase.playing.getKeys()}return null};r.prototype.build=function(t,e){this.count=e;this._animationState=this.state;this._lifeCircles=[];this.resetCircleData()};r.prototype.resetCircleData=function(){for(var t=0;t<this.count;t++){this._lifeCircles[t]=-1}};r.prototype.update=function(t,e,i){if(this._empty)return;this.recycleParticle();this.ignoreEmit=e>25;var r=this._animationState.emitter.data;var a=r.life.loop;var n=this._animationState.modTime+r.life.duration+r.life.delay;if(!a&&t*.001>=n){return}var o=0;var s=i.vertexCount/this.count;var h=0;var u=this._animationState.emitter.positionNode.offsetIndex;var l=this._animationState.emitter.timeNode.offsetIndex;var c=t*.001-r.life.delay;var f=i.sharedVertexBuffer?i.sharedVertexBuffer.arrayBuffer:i.vertexArray;var d=this._animationState.followTarget||this._animationState.emitter;for(var p=0;p<this.count;++p){h=p*s;this.timeIndex=h*i.vertexAttLength+l;this.bornTime=f[this.timeIndex+0];this.life=f[this.timeIndex+1];var _=-1;if(c>=this.bornTime){if(c>this.bornTime+this.life&&!a)continue;_=Math.floor((c-this.bornTime)/this._animationState.modTime);if(_!=this._lifeCircles[p]){this._lifeCircles[p]=_;if(this.ignoreEmit){continue}o=h*i.vertexAttLength+u;this.position.x=f[o+0];this.position.y=f[o+1];this.position.z=f[o+2];this.emitParticleAtPhase(this._birthPhase,this.position)}}}};r.prototype.emitParticleAtPhase=function(e,i){var r;var a=e.playing.getKeys();var n;var o;var s;this._orientation.copyFrom(this._parent.orientation);this._orientation.w*=-1;for(var h=0,u=a.length;h<u;h++){r=a[h];o=e.recycle.getValueByKey(r);n=e.playing.getValueByKey(r);s=o.shift();if(s==null){s=new t.ParticleEmitter(r.data,r.material)}n.push(s);s.play(1,true,r.data.property.prewarm);s.position=i;s.orientation=this._orientation;this._parent.addChild(s)}};r.prototype.recycleParticle=function(){this.recycleParticleAtPhase(this._birthPhase);this.recycleParticleAtPhase(this._collisionPhase);this.recycleParticleAtPhase(this._deathPhase)};r.prototype.recycleParticleAtPhase=function(t){var e;var i;var r;var a;var n;var o;var s=t.playing.getKeys();for(var h=0,u=s.length;h<u;h++){e=s[h];i=t.playing.getValueByKey(e);r=t.recycle.getValueByKey(e);for(n=i.length-1;n>=0;n--){a=i[n];if(a.loopProgress>1){i.splice(n,1);a.stop();this._parent.removeChild(a);r.push(a)}}}};r.prototype.activeState=function(t,e,i,r,a,n,o){};r.prototype.dispose=function(){e.prototype.dispose.call(this);this._animationState=null;this._birthPhase&&this._birthPhase.dispose();this._birthPhase=null;this._collisionPhase&&this._collisionPhase.dispose();this._collisionPhase=null;this._deathPhase&&this._deathPhase.dispose();this._deathPhase=null;this._lifeCircles=null;this._orientation=null;this._parent=null};return r}(t.AnimationNode);t.ParticleSubEmitterNode=e;var i=function(){function e(e){this.playing=new t.DoubleArray;this.recycle=new t.DoubleArray;this._phase=e}e.prototype.importSubEmitter=function(t){if(this.playing.getKeys().indexOf(t)>=0)return;this.playing.put(t,[]);this.recycle.put(t,[])};e.prototype.dispose=function(){var t;for(var e=0,i=this.playing.getValues();e<i.length;e++){t=i[e];t.dispose()}for(var r=0,a=this.recycle.getValues();r<a.length;r++){t=a[r];t.dispose()}this.playing.clear();this.recycle.clear();this.playing=this.recycle=null};return e}();t.ParticleSubEmitterNodePhase=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._verticesDataDirty=true;this.name="ParticleTrackPositionNode";this.importShader(true,t.ShaderPhaseType.local_vertex,"particle_trackPosition");this.attribute_trackPosition=new t.GLSL.VarRegister;this.attribute_trackPosition.name="attribute_trackPosition";this.attribute_trackPosition.size=3;this.attributes.push(this.attribute_trackPosition)}Object.defineProperty(i.prototype,"endCoords",{get:function(){return this._toCoords},enumerable:true,configurable:true});i.prototype.trackPosition=function(t,e){if(t.length!=this._count||e.length!=this._count){throw new Error("count don't match!")}var i;var r=this._animationState.emitter.positionNode.offsetIndex;var a=this._animationState.emitter.geometry;var n=a.vertexCount/this._count;for(var o=0;o<this._count;++o){var s=t[o];var h=e[o];for(var u=0;u<n;++u){i=o*n+u;i=i*a.vertexAttLength+r;a.vertexArray[i+0]=s.x;a.vertexArray[i+1]=s.y;a.vertexArray[i+2]=s.z;i=o*n+u;i=i*a.vertexAttLength+this.attribute_trackPosition.offsetIndex;a.vertexArray[i+0]=h.x;a.vertexArray[i+1]=h.y;a.vertexArray[i+2]=h.z}}this._toCoords=e;this._verticesDataDirty=true};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this._verticesDataDirty){n.geometry.upload(o);this._verticesDataDirty=false}};i.prototype.initNode=function(e){this._trackPosition=new t.CubeVector3DValueShape;this._trackPosition.depth=200;this._trackPosition.width=300;this._trackPosition.height=100};i.prototype.build=function(t,e){this._animationState=this.state;this._count=e};i.prototype.afterBuild=function(){this._trackPosition.dispose();this._trackPosition=null};i.prototype.dispose=function(){e.prototype.dispose.call(this);this._trackPosition=null};return i}(t.AnimationNode);t.ParticleTrackPositionNode=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(t,e){this.numberOfVertices=0;this.vertexSizeInBytes=0;this.vertex_shaders={};this.fragment_shaders={};this.modTime=0;this.reverse=1;this.followTarget=null;this._particleProperty=new Float32Array(27);this._emitter=e;this.name=t;this.animNodes=[];this.keyFrames=[]}Object.defineProperty(e.prototype,"emitter",{get:function(){return this._emitter},enumerable:true,configurable:true});e.prototype.addNode=function(t){t.state=this;this.animNodes.push(t)};e.prototype.removeNode=function(t){var e=this.animNodes.indexOf(t);if(e!=-1)this.animNodes.splice(e,1)};e.prototype.onAnimTimeChange=function(){var t;for(var e=0,i=this.animNodes.length;e<i;e++){this.animNodes[e].onAnimTimeChange()}};e.prototype.clean=function(){this.animNodes.length=0};e.prototype.addShaderPhase=function(t,e){var i;var r;for(r in t){i=t[r];for(var a=0;a<i.length;a++){e[r]=e[r]||[];e[r].push(i[a])}}};e.prototype.calculate=function(t){for(var e=0;e<this.animNodes.length;e++){this.addShaderPhase(this.animNodes[e].vertex_ShaderName,this.vertex_shaders);this.addShaderPhase(this.animNodes[e].fragment_ShaderName,this.fragment_shaders);var i=t.vertexAttLength;for(var r=0;r<this.animNodes[e].attributes.length;++r){if(this.animNodes[e].attributes[r].size>0){this.animNodes[e].attributes[r].offsetIndex=i;t.vertexAttLength+=this.animNodes[e].attributes[r].size;t.vertexSizeInBytes+=this.animNodes[e].attributes[r].size*4;t.subGeometrys[0].preAttList.push(this.animNodes[e].attributes[r])}i=t.vertexAttLength}}};e.prototype.fill=function(t,e){for(var i=0;i<this.animNodes.length;i++){this.animNodes[i].build(t,e)}for(var i=0;i<this.animNodes.length;i++){this.animNodes[i].afterBuild()}};e.prototype.update=function(t,e,i){for(var r=0;r<this.animNodes.length;r++){this.animNodes[r].update(t,e,i)}};e.prototype.activeState=function(e,i,r,a,n,o,s,h){var u;var l;var c;var f=this._emitter.data;if(f.followTarget&&this._emitter.followTarget){u=this._emitter.followTarget.globalScale;l=this._emitter.followTarget.globalOrientation;c=this._emitter.followTarget.globalPosition}else{u=this._emitter.globalScale;l=this._emitter.globalOrientation;c=this._emitter.globalPosition}var d=this._emitter.material.materialData.blendMode==t.BlendMode.ALPHA;this._particleProperty[0]=i*.001;this._particleProperty[1]=f.life.loop?1:0;this._particleProperty[2]=f.followTarget?1:0;this._particleProperty[3]=u.x;this._particleProperty[4]=u.y;this._particleProperty[5]=u.z;this._particleProperty[6]=l.x;this._particleProperty[7]=l.y;this._particleProperty[8]=l.z;this._particleProperty[9]=l.w;this._particleProperty[10]=c.x;this._particleProperty[11]=c.y;this._particleProperty[12]=c.z;this._particleProperty[13]=this.modTime;this._particleProperty[14]=f.life.delay;this._particleProperty[15]=f.life.duration;this._particleProperty[16]=f.property.gravity;this._particleProperty[17]=f.moveSpeed.velocityOver&&f.moveSpeed.velocityOver.worldSpace?1:0;this._particleProperty[18]=f.moveSpeed.velocityForce&&f.moveSpeed.velocityForce.worldSpace?1:0;this._particleProperty[19]=f.moveSpeed.velocityLimit?f.moveSpeed.velocityLimit.dampen:0;this._particleProperty[20]=f.property.cameraScale;this._particleProperty[21]=f.property.speedScale;this._particleProperty[22]=f.property.lengthScale;this._particleProperty[23]=f.property.renderMode;this._particleProperty[24]=f.property.stayAtEnd?1:0;this._particleProperty[25]=d?1:0;this._particleProperty[26]=f.shape.type;s.uniform1fv(n["uniform_particleState"].uniformIndex,this._particleProperty);for(var p=0;p<this.animNodes.length;p++){this.animNodes[p].activeState(e,i,r,a,n,o,s)}};e.prototype.dispose=function(){var t;for(var e=0,i=this.animNodes;e<i.length;e++){t=i[e];t.dispose()}this.animNodes.length=0;this.animNodes=null;this.keyFrames.length=0;this.keyFrames=null};return e}();t.ParticleAnimationState=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this);this.animTime=0;this._event3D=new t.AnimationEvent3D;this._lastAnimTime=0;this.delay=0;this.loopTime=0;this.speed=1;this._play=false;this.animStates=[];this.particleAnimationState=new t.ParticleAnimationState("particle",i);this.addAnimState(this.particleAnimationState)}i.prototype.update=function(e,r,a){if(i.Reset){this.animTime=0}if(this._play&&this.speed!=0){this.animTime+=r*this.speed;this.particleAnimationState.update(this.animTime,r,a);if(this.isLoop==false){var n=this.loopTime*1e3;if(this._lastAnimTime<=n&&this.animTime>n){this._event3D.eventType=t.AnimationEvent3D.COMPLETE;this._event3D.target=this;this.dispatchEvent(this._event3D)}}this._lastAnimTime=this.animTime}};i.prototype.activeState=function(t,e,i,r,a,n,o){if(this.particleAnimationState){this.particleAnimationState.activeState(t,this.animTime,e,e,i,r,a,o)}};i.prototype.play=function(t,e,i,r){if(e===void 0){e=1}if(i===void 0){i=true}if(r===void 0){r=true}this._play=true;if(i){this.animTime=0}if(r){this.animTime=this.particleAnimationState.modTime}if(r||i){this.particleAnimationState.onAnimTimeChange()}this.speed=e};i.prototype.stop=function(){this._play=false};i.prototype.isPlay=function(){return this._play};i.prototype.addAnimState=function(t){var e=this.animStates.indexOf(t);if(e==-1)this.animStates.push(t)};i.prototype.removeAnimState=function(t){var e=this.animStates.indexOf(t);if(e!=-1)this.animStates.splice(e,1)};i.prototype.getAnimList=function(){return[]};i.prototype.getAnimNode=function(){return[]};i.prototype.clone=function(){return null};return i}(t.EventDispatcher);t.ParticleAnimation=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["Property"]=0]="Property";t[t["Emission"]=1]="Emission";t[t["Life"]=2]="Life";t[t["Shape"]=3]="Shape";t[t["RotationBirth"]=4]="RotationBirth";t[t["ScaleBirth"]=5]="ScaleBirth";t[t["Geometry"]=6]="Geometry";t[t["MoveSpeed"]=7]="MoveSpeed";t[t["FollowTarget"]=8]="FollowTarget";t[t["ScaleSize"]=9]="ScaleSize";t[t["RotationSpeed"]=10]="RotationSpeed";t[t["ColorOffset"]=11]="ColorOffset";t[t["TextureSheet"]=12]="TextureSheet"})(t.ParticleDataNodeType||(t.ParticleDataNodeType={}));var e=t.ParticleDataNodeType;(function(t){t[t["BIRTH"]=0]="BIRTH";t[t["COLLISION"]=1]="COLLISION";t[t["DEATH"]=2]="DEATH"})(t.ParticleDataSubEmitterPhase||(t.ParticleDataSubEmitterPhase={}));var i=t.ParticleDataSubEmitterPhase;(function(t){t[t["Const"]=0]="Const";t[t["RandomConst"]=1]="RandomConst";t[t["OneBezier"]=2]="OneBezier";t[t["TwoBezier"]=3]="TwoBezier"})(t.ParticleValueType||(t.ParticleValueType={}));var r=t.ParticleValueType;(function(t){t[t["Billboard"]=0]="Billboard";t[t["StretchedBillboard"]=1]="StretchedBillboard";t[t["HorizontalBillboard"]=2]="HorizontalBillboard";t[t["VerticalBillboard"]=3]="VerticalBillboard";t[t["Mesh"]=4]="Mesh"})(t.ParticleRenderModeType||(t.ParticleRenderModeType={}));var a=t.ParticleRenderModeType;(function(t){t[t["Const"]=0]="Const";t[t["RandomConst"]=1]="RandomConst";t[t["OneGradients"]=2]="OneGradients";t[t["TwoGradients"]=3]="TwoGradients"})(t.ParticleBirthColorType||(t.ParticleBirthColorType={}));var n=t.ParticleBirthColorType;(function(t){t[t["Point"]=0]="Point";t[t["Cube"]=1]="Cube";t[t["Sphere"]=2]="Sphere";t[t["HemiSphere"]=3]="HemiSphere";t[t["Cone"]=4]="Cone";t[t["Mesh"]=5]="Mesh";t[t["External"]=6]="External"})(t.ParticleDataShapeType||(t.ParticleDataShapeType={}));var o=t.ParticleDataShapeType;(function(t){t[t["Vertex"]=0]="Vertex";t[t["Triangle"]=1]="Triangle";t[t["Edge"]=2]="Edge"})(t.ParticleMeshShapeType||(t.ParticleMeshShapeType={}));var s=t.ParticleMeshShapeType;(function(t){t[t["Base"]=0]="Base";t[t["BaseShell"]=1]="BaseShell";t[t["Volume"]=2]="Volume";t[t["VolumeShell"]=3]="VolumeShell"})(t.ParticleConeShapeType||(t.ParticleConeShapeType={}));var h=t.ParticleConeShapeType;var u=function(){function t(){this.property=new c;this.emission=new f;this.life=new d;this.shape=new p;this.rotationBirth=new _;this.scaleBirth=new m;this.geometry=new v;this.moveSpeed=new g}t.prototype.validate=function(){this.property.validate();this.emission.validate();this.life.validate();this.shape.validate();this.rotationBirth.validate();this.scaleBirth.validate();this.geometry.validate();this.moveSpeed.validate();if(this.scaleSize){this.scaleSize.validate()}if(this.rotationSpeed){this.rotationSpeed.validate()}if(this.colorOffset){this.colorOffset.validate()}if(this.followTarget){this.followTarget.validate()}if(this.textureSheet){this.textureSheet.validate()}};return t}();t.ParticleData=u;var l=function(){function t(t){this._nodeType=t}Object.defineProperty(t.prototype,"nodeType",{get:function(){return this._nodeType},enumerable:true,configurable:true});return t}();t.ParticleDataNode=l;var c=function(i){__extends(r,i);function r(){i.call(this,e.Property);this.particleCount=10;this.bounds=new t.Vector3D(10,10,10);this.colorType=n.Const;this.colorConst1=new t.Color(255,255,255,255);this.colorConst2=new t.Color(255,255,255,255);this.gravity=0;this.prewarm=false;this.playOnAwake=true;this.rotation=new t.Vector3D(0,0,0,1);this.scale=new t.Vector3D(1,1,1,1);this.position=new t.Vector3D(0,0,0,1);this.sortingFudge=0;this.renderMode=a.Billboard;this.cameraScale=0;this.speedScale=0;this.lengthScale=1}r.prototype.validate=function(){if(this.bounds==null){this.bounds=new t.Vector3D(10,10,10)}if(this.bounds.x<0){this.bounds.x=1}if(this.bounds.y<0){this.bounds.y=1}if(this.bounds.z<0){this.bounds.z=1}if(this.particleCount<0){this.particleCount=10}if(this.colorConst1==null){this.colorConst1=new t.Color(255,255,255,255)}if(this.colorConst2==null){this.colorConst2=new t.Color(255,255,255,255)}if(this.colorType==n.OneGradients||this.colorType==n.TwoGradients){if(this.colorGradients1==null){this.colorGradients1=new t.ColorGradients}}if(this.colorType==n.TwoGradients){if(this.colorGradients2==null){this.colorGradients2=new t.ColorGradients}}if(this.rotation==null){this.rotation=new t.Vector3D(0,0,0,1)}if(this.scale==null){this.scale=new t.Vector3D(1,1,1,1)}if(this.position==null){this.rotation=new t.Vector3D(0,0,0,1)}};return r}(l);t.ParticleDataProperty=c;var f=function(i){__extends(a,i);function a(){i.call(this,e.Emission);this.rate=10;this.type=r.Const;this.bezier=new t.BezierData}a.prototype.validate=function(){if(this.rate<0){this.rate=1e-5}if(this.type==r.OneBezier){if(this.bezier==null){this.bezier=new t.BezierData}this.bezier.validate()}};return a}(l);t.ParticleDataEmission=f;var d=function(i){__extends(a,i);function a(){i.call(this,e.Life);this.type=r.Const;this.max=0;this.min=0;this.duration=5;this.delay=0;this.loop=true}a.prototype.validate=function(){if(this.max<=0){this.max=1e-6}if(this.min<=0){this.min=1e-6}if(this.type==r.Const){this.min=this.max}if(this.type==r.RandomConst){}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.bezier1==null){this.bezier1=new t.BezierData}this.bezier1.validate()}if(this.type==r.TwoBezier){if(this.bezier2==null){this.bezier2=new t.BezierData}this.bezier2.validate()}if(this.delay<0){this.delay=0}if(this.duration<0){this.duration=5}};return a}(l);t.ParticleDataLife=d;var p=function(t){__extends(i,t);function i(){t.call(this,e.Shape);this.type=o.Point;this.randomDirection=false;this.emitFromShell=false;this.cubeW=0;this.cubeH=0;this.cubeD=0;this.sphereRadius=10;this.hemiSphereRadius=10;this.coneType=h.Volume;this.coneLength=10;this.coneRadius=10;this.coneAngle=30;this.meshType=s.Vertex}i.prototype.validate=function(){if(this.type==o.Cube){if(this.cubeW<0){this.cubeW=0}if(this.cubeH<0){this.cubeH=0}if(this.cubeD<0){this.cubeD=0}}else if(this.type==o.Sphere){if(this.sphereRadius<0){this.sphereRadius=10}}};return i}(l);t.ParticleDataShape=p;var _=function(i){__extends(a,i);function a(){i.call(this,e.RotationBirth);this.type=r.Const;this.max=0;this.min=0}a.prototype.validate=function(){if(this.type==r.Const){this.min=this.max}if(this.type==r.RandomConst){}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.bezier1==null){this.bezier1=new t.BezierData}this.bezier1.validate()}if(this.type==r.TwoBezier){if(this.bezier2==null){this.bezier2=new t.BezierData}this.bezier2.validate()}};return a}(l);t.ParticleDataRotationBirth=_;var m=function(i){__extends(a,i);function a(){i.call(this,e.ScaleBirth);this.type=r.Const;this.max=1;this.min=1}a.prototype.validate=function(){if(this.type==r.Const){this.min=this.max}if(this.type==r.RandomConst){}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.bezier1==null){this.bezier1=new t.BezierData}this.bezier1.validate()}if(this.type==r.TwoBezier){if(this.bezier2==null){this.bezier2=new t.BezierData}this.bezier2.validate()}};return a}(l);t.ParticleDataScaleBirth=m;var v=function(t){__extends(i,t);function i(){t.call(this,e.Geometry);this.planeW=10;this.planeH=10}i.prototype.validate=function(){if(this.planeW<0){this.planeW=10}if(this.planeH<0){this.planeH=10}};return i}(l);t.ParticleDataGeometry=v;var g=function(i){__extends(a,i);function a(){i.call(this,e.MoveSpeed);this.type=r.Const;this.max=0;this.min=0}a.prototype.validate=function(){if(this.velocityOver){this.velocityOver.validate()}if(this.velocityLimit){this.velocityLimit.validate()}if(this.velocityForce){this.velocityForce.validate()}if(this.type==r.Const){this.min=this.max}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.bezier1==null){this.bezier1=new t.BezierData}this.bezier1.validate()}if(this.type==r.TwoBezier){if(this.bezier2==null){this.bezier2=new t.BezierData}this.bezier2.validate()}};return a}(l);t.ParticleDataMoveSpeed=g;var y=function(){function e(){this.type=r.Const;this.max=0;this.min=0;this.dampen=0;this.bezier1=new t.BezierData;this.bezier2=new t.BezierData}e.prototype.validate=function(){if(this.max<0){this.max=0}if(this.min<0){this.min=0}this.dampen=this.dampen||0;if(this.type==r.Const){this.min=this.max}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.bezier1==null){this.bezier1=new t.BezierData}this.bezier1.validate()}if(this.type==r.TwoBezier){if(this.bezier2==null){this.bezier2=new t.BezierData}this.bezier2.validate()}};return e}();t.VelocityLimitLifeTimeData=y;var x=function(){function e(){this.type=r.Const;this.max=new t.Vector3D;this.min=new t.Vector3D;this.worldSpace=false;this.xBezier1=new t.BezierData;this.yBezier1=new t.BezierData;this.zBezier1=new t.BezierData;this.xBezier2=new t.BezierData;this.yBezier2=new t.BezierData;this.zBezier2=new t.BezierData}e.prototype.validate=function(){if(this.max==null){this.max=new t.Vector3D}if(this.min==null){this.min=this.max.clone()}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.xBezier1==null){this.xBezier1=new t.BezierData}if(this.yBezier1==null){this.yBezier1=new t.BezierData}if(this.zBezier1==null){this.zBezier1=new t.BezierData}this.xBezier1.validate();this.yBezier1.validate();this.zBezier1.validate()}if(this.type==r.TwoBezier){if(this.xBezier2==null){this.xBezier2=new t.BezierData}if(this.yBezier2==null){this.yBezier2=new t.BezierData}if(this.zBezier2==null){this.zBezier2=new t.BezierData}this.xBezier2.validate();this.yBezier2.validate();this.zBezier2.validate()}};return e}();t.VelocityOverLifeTimeData=x;var b=function(){function e(){this.type=r.Const;this.max=new t.Vector3D;this.min=new t.Vector3D;this.worldSpace=false;this.xBezier1=new t.BezierData;this.yBezier1=new t.BezierData;this.zBezier1=new t.BezierData;this.xBezier2=new t.BezierData;this.yBezier2=new t.BezierData;this.zBezier2=new t.BezierData}e.prototype.validate=function(){if(this.max==null){this.max=new t.Vector3D}if(this.min==null){this.min=this.max.clone()}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.xBezier1==null){this.xBezier1=new t.BezierData}if(this.yBezier1==null){this.yBezier1=new t.BezierData}if(this.zBezier1==null){this.zBezier1=new t.BezierData}this.xBezier1.validate();this.yBezier1.validate();this.zBezier1.validate()}if(this.type==r.TwoBezier){if(this.xBezier2==null){this.xBezier2=new t.BezierData}if(this.yBezier2==null){this.yBezier2=new t.BezierData}if(this.zBezier2==null){this.zBezier2=new t.BezierData}this.xBezier2.validate();this.yBezier2.validate();this.zBezier2.validate()}};return e}();t.VelocityForceLifeTimeData=b;var D=function(i){__extends(a,i);function a(){i.call(this,e.ScaleSize);this.type=r.Const;this.max=1;this.min=1;this.bezier1=new t.BezierData;this.bezier2=new t.BezierData}a.prototype.validate=function(){if(this.max<=0){this.max=1e-6}if(this.min<=0){this.min=1e-6}if(this.type==r.Const){this.min=this.max}if(this.type==r.RandomConst){}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.bezier1==null){this.bezier1=new t.BezierData}this.bezier1.validate()}if(this.type==r.TwoBezier){if(this.bezier2==null){this.bezier2=new t.BezierData}this.bezier2.validate()}};return a}(l);t.ParticleDataScaleSize=D;var T=function(i){__extends(a,i);function a(){i.call(this,e.RotationSpeed);this.max=new t.Vector3D;this.min=new t.Vector3D;this.type=r.Const;this.bezier1=new t.BezierData;this.bezier2=new t.BezierData;this.rot3Axis=false}a.prototype.validate=function(){if(this.max==null){this.max=new t.Vector3D}if(this.min==null){this.min=this.max.clone()}if(this.type==r.OneBezier||this.type==r.TwoBezier){if(this.bezier1==null){this.bezier1=new t.BezierData}this.bezier1.validate()}if(this.type==r.TwoBezier){if(this.bezier2==null){this.bezier2=new t.BezierData}this.bezier2.validate()}};return a}(l);t.ParticleDataRotationSpeed=T;var P=function(i){__extends(r,i);function r(){i.call(this,e.ColorOffset);this.data=new t.ColorGradients}r.prototype.validate=function(){if(this.data.colors==null){this.data.colors=[]}if(this.data.times==null){this.data.times=[]}};return r}(l);t.ParticleDataColorOffset=P;var A=function(t){__extends(i,t);function i(){t.call(this,e.FollowTarget);this.followRotation=true;this.followScale=true}i.prototype.validate=function(){};return i}(l);t.ParticleDataFollowTarget=A;var w=function(i){__extends(a,i);function a(){i.call(this,e.TextureSheet);this.tileX=1;this.tileY=1;this.whole=true;this.frameType=r.Const;this.randomRow=false;this.row=0;this.min=0;this.max=0;this.circles=1;this.bezier1=new t.BezierData;this.bezier2=new t.BezierData}a.prototype.validate=function(){if(this.tileX<0){this.tileX=1}this.tileX=Math.floor(this.tileX);if(this.tileY<0){this.tileY=1}this.tileY=Math.floor(this.tileY);if(this.max<0){this.max=0}if(this.min>this.max){this.min=this.max}if(this.frameType==r.OneBezier||this.frameType==r.TwoBezier){if(this.bezier1==null){this.bezier1=new t.BezierData}this.bezier1.validate()}if(this.frameType==r.TwoBezier){if(this.bezier2==null){this.bezier2=new t.BezierData}this.bezier2.validate()}if(this.circles<1){this.circles=1}};return a}(l);t.ParticleDataTextureSheet=w})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r){if(r===void 0){r=null}e.call(this,null,r);this._isEmitterDirty=true;this._userNodes=[];this.tag.name="effect";this.type=t.IRender.TYPE_PARTICLE_EMIT;this._data=i;this._externalGeometry=i.property.geometry;this.animation=this._particleAnimation=new t.ParticleAnimation(this);this.animation.particleAnimationController=this._particleAnimation;this._particleState=this._particleAnimation.particleAnimationState;this._generator=new t.ParticleLifeGenerator;this._particleAnimation.emit=this;this.buildParticle();this.animation.isLoop=this._data.life.loop}i.prototype.trackPosition=function(t,e){if(this._trackPositionNode){this.animation.animTime=0;this._trackPositionNode.trackPosition(t,e)}};Object.defineProperty(i.prototype,"trackEndCoords",{get:function(){if(this._trackPositionNode){return this._trackPositionNode.endCoords}return null},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"generator",{get:function(){return this._generator},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"drawOrder",{get:function(){return this._data.property.sortingFudge},enumerable:true,configurable:true});i.prototype.addSubEmitter=function(t,e){e.animation.stop();this._subEmitterNode.importSubEmitter(t,e)};i.prototype.buildParticle=function(){if(this._externalGeometry==null){this._geometryShape=this.createPlane()}else{this._geometryShape=this._externalGeometry}var e=this._data.property.renderMode;if(e==t.ParticleRenderModeType.Billboard){this.billboard=t.BillboardType.STANDARD}else if(e==t.ParticleRenderModeType.VerticalBillboard||e==t.ParticleRenderModeType.StretchedBillboard){this.billboard=t.BillboardType.Y_AXIS}else{this.billboard=t.BillboardType.DISABLE}this.initialize();this.initBoudBox(this._data.property.bounds);this._isEmitterDirty=false};i.prototype.createPlane=function(){var e;var i=this._data.geometry;var r=t.Vector3D.Z_AXIS;var a=true;var n=true;if(this._data.property.renderMode==t.ParticleRenderModeType.StretchedBillboard){a=false;n=true}e=new t.PlaneGeometry(i.planeW,i.planeH,1,1,1,1,r,a,n);return e};Object.defineProperty(i.prototype,"data",{get:function(){return this._data},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"timeNode",{get:function(){return this._timeNode},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"positionNode",{get:function(){return this._positionNode},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"followTarget",{get:function(){return this._particleState.followTarget},set:function(t){this._particleState.followTarget=t},enumerable:true,configurable:true});i.prototype.addAnimNode=function(t){var e=this._userNodes.indexOf(t);if(e==-1){this._userNodes.push(t);this._isEmitterDirty=true}};i.prototype.removeAnimNode=function(t){var e=this._userNodes.indexOf(t);if(e!=-1){this._userNodes.slice(e);this._isEmitterDirty=true}};i.prototype.play=function(t,e,i){if(t===void 0){t=1}if(e===void 0){e=false}if(i===void 0){i=false}this.animation.play("",t,e,i)};i.prototype.stop=function(){this.animation.stop()};i.prototype.initialize=function(){this._particleAnimation.particleAnimationState.clean();this._generator.generator(this._data);var e=this._generator.planes.length;this.geometry=new t.Geometry;this.geometry.buildDefaultSubGeometry();this.geometry.subGeometrys[0].count=e*this._geometryShape.indexCount;var i=0;var r=new Array;var a=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_UV0|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_NORMAL;this.geometry.vertexFormat=a;this.initMainAnimNode();this.initUserAnimNode();this.initEndNode();this.geometry.vertexCount=e*this._geometryShape.vertexCount;this.geometry.indexCount=e*this._geometryShape.indexCount;this._geometryShape.getVertexForIndex(0,a,r,this._geometryShape.vertexCount);for(var n=0;n<e;++n){i=n*this._geometryShape.vertexCount;this.geometry.setVerticesForIndex(i,a,r,this._geometryShape.vertexCount)}for(var n=0;n<e;++n){for(var o=0;o<this._geometryShape.indexArray.length;++o){this.geometry.indexArray[n*this._geometryShape.indexArray.length+o]=this._geometryShape.indexArray[o]+n*this._geometryShape.vertexCount}}this._particleAnimation.particleAnimationState.fill(this.geometry,e)};i.prototype.initMainAnimNode=function(){var e=[];this._timeNode=new t.ParticleTime;this._timeNode.initNode(this._data.life);e.push(this._timeNode);this._positionNode=new t.ParticlePosition;this._positionNode.initNode(this._data.shape,this._data.property);e.push(this._positionNode);var i=new t.ParticleVelocityNode;i.initNode(this._data.moveSpeed);e.push(i);this._subEmitterNode=new t.ParticleSubEmitterNode;this._subEmitterNode.initNode(null,this);this._particleAnimation.particleAnimationState.addNode(this._subEmitterNode);var r=this._data.moveSpeed.velocityOver;if(r){if(r.type==t.ParticleValueType.Const||r.type==t.ParticleValueType.RandomConst){var a=new t.ParticleVelocityOverConstNode;a.initNode(this._data.moveSpeed);e.push(a)}else if(r.type==t.ParticleValueType.OneBezier){var n=new t.ParticleVelocityOverOneBezierNode;n.initNode(this._data.moveSpeed);e.push(n)}else if(r.type==t.ParticleValueType.TwoBezier){var o=new t.ParticleVelocityOverTwoBezierNode;o.initNode(this._data.moveSpeed);e.push(o)}}var s=this._data.moveSpeed.velocityLimit;if(s){if(s.type==t.ParticleValueType.Const||s.type==t.ParticleValueType.RandomConst){var h=new t.ParticleVelocityLimitConstNode;h.initNode(this._data.moveSpeed);e.push(h)}else if(s.type==t.ParticleValueType.OneBezier){var u=new t.ParticleVelocityLimitOneBezierNode;u.initNode(this._data.moveSpeed);e.push(u)}else if(s.type==t.ParticleValueType.TwoBezier){var l=new t.ParticleVelocityLimitTwoBezierNode;l.initNode(this._data.moveSpeed);e.push(l)}}var c=this._data.moveSpeed.velocityForce;if(c){if(c.type==t.ParticleValueType.Const||c.type==t.ParticleValueType.RandomConst){var f=new t.ParticleVelocityForceConstNode;f.initNode(this._data.moveSpeed);e.push(f)}else if(c.type==t.ParticleValueType.OneBezier){var d=new t.ParticleVelocityForceOneBezierNode;d.initNode(this._data.moveSpeed);e.push(d)}else if(c.type==t.ParticleValueType.TwoBezier){var p=new t.ParticleVelocityForceTwoBezierNode;p.initNode(this._data.moveSpeed);e.push(p)}}var _=new t.ParticleRotation;_.initNode(this._data.rotationBirth);e.push(_);var m=new t.ParticleScale;m.initNode(this._data.scaleBirth);e.push(m);var v=new t.ParticleSizeGlobalNode;v.initNode(this._data.scaleSize);e.push(v);var g=new t.ParticleStartColor;g.initNode(this._data.property);e.push(g);if(this._data.followTarget){var y=new t.ParticleFollowNode;y.initNode(this._data.followTarget);e.push(y)}if(this._data.rotationSpeed){if(this._data.rotationSpeed.rot3Axis){var x=new t.ParticleRotationXYZConstNode;x.initNode(this._data.rotationSpeed);e.push(x)}else{if(this._data.rotationSpeed.type==t.ParticleValueType.Const||this._data.rotationSpeed.type==t.ParticleValueType.RandomConst){var b=new t.ParticleRotationConstNode;b.initNode(this._data.rotationSpeed);e.push(b)}else if(this._data.rotationSpeed.type==t.ParticleValueType.OneBezier){var D=new t.ParticleRotationOneBezierNode;D.initNode(this._data.rotationSpeed);e.push(D)}else if(this._data.rotationSpeed.type==t.ParticleValueType.TwoBezier){var T=new t.ParticleRotationTwoBezierNode;T.initNode(this._data.rotationSpeed);e.push(T)}}}if(this._data.colorOffset){var P=new t.ParticleColorGlobalNode;P.initNode(this._data.colorOffset);e.push(P)}if(this._data.materialData){var A;for(var w=0,S=this._data.materialData.methods;w<S.length;w++){A=S[w];if(A.type==t.UnitMatMethodData.methodType.lightmapMethod){}else if(A.type==t.UnitMatMethodData.methodType.uvRollMethod){var C=new t.ParticleUVRollNode;C.initNode(null,A);e.push(C)}else if(A.type==t.UnitMatMethodData.methodType.alphaMaskMethod){}else if(A.type==t.UnitMatMethodData.methodType.streamerMethod){}
}}if(this._data.textureSheet){var E=new t.ParticleTextureSheetNode;E.initNode(null,this._data.textureSheet);e.push(E)}if(this._data.property.trackPosition){this._trackPositionNode=new t.ParticleTrackPositionNode;this._trackPositionNode.initNode(null);e.push(this._trackPositionNode)}for(var L=0,M=e.length;L<M;L++){this._particleAnimation.particleAnimationState.addNode(e[L])}};i.prototype.initUserAnimNode=function(){for(var t=0;t<this._userNodes.length;t++){this._particleAnimation.particleAnimationState.addNode(this._userNodes[t])}};i.prototype.initEndNode=function(){var e=new t.ParticleEndNode;this._particleAnimation.particleAnimationState.addNode(e);this._particleAnimation.particleAnimationState.calculate(this.geometry)};i.prototype.initBoudBox=function(e){var i=new t.BoundBox(this);i.fillBox(new t.Vector3D(-e.x/2,-e.y/2,-e.z/2),new t.Vector3D(e.x/2,e.y/2,e.z/2));this.bound=i;this.initAABB()};Object.defineProperty(i.prototype,"loopProgress",{get:function(){var t;t=this.animation.animTime/(this.animation.loopTime*1e3);return t},enumerable:true,configurable:true});i.prototype.update=function(t,i,r){if(this._isEmitterDirty){this.buildParticle()}e.prototype.update.call(this,t,i,r)};i.prototype.copy=function(i){e.prototype.copy.call(this,i);var r=[t.ParticleDataSubEmitterPhase.BIRTH,t.ParticleDataSubEmitterPhase.COLLISION,t.ParticleDataSubEmitterPhase.DEATH];if(i._subEmitterNode){for(var a=0;a<r.length;a++){var n=r[a];var o=i._subEmitterNode.getSubEmitters(n);if(o&&o.length>0){for(var s=0;s<o.length;s++){this.addSubEmitter(n,o[s])}}}}};i.prototype.clone=function(){var t;t=new i(this.data,this.material);t.copy(this);return t};i.prototype.dispose=function(){e.prototype.dispose.call(this);if(this._generator){this._generator.dispose();this._generator=null}this._timeNode=null;this._positionNode=null;if(this._geometryShape){this._geometryShape.dispose();this._geometryShape=null}if(this._externalGeometry){this._externalGeometry.dispose();this._externalGeometry=null}this._particleAnimation=null;if(this._particleState){this._particleState.dispose();this._particleState=null}this._subEmitterNode=null;this._userNodes=null;this._data=null};return i}(t.Mesh);t.ParticleEmitter=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.apply(this,arguments);this._animations=[];this._proAnimations=[];this._animCount=0;this._loopTime=1;this._animTime=0;this._speed=1;this._noLoopAnims=[];this.liveTime=-1;this.isOriginal=true;this._event3D=new t.AnimationEvent3D;this._lastAnimTime=0}i.prototype.init=function(t){if(t===void 0){t=false}this._animations=[];this._loop=t;this.collectAnimations(this,this._animations);this._timeOffset=[];this._animCount=this._timeOffset.length=this._animations.length;for(var e=0;e<this._animCount;e++){this._timeOffset[e]=0}};i.prototype.collectAnimations=function(e,i){var r;var a;if(e instanceof t.Mesh){r=e;a=r.animation;if(a){i.push(a);if(!a.isLoop){this._noLoopAnims.push(a)}}}if(e.proAnimation){this._proAnimations.push(e.proAnimation);if(!e.proAnimation.isLoop){this._noLoopAnims.push(e.proAnimation)}}var n=e.childs.length;for(var o=0;o<n;o++){this.collectAnimations(e.childs[o],i)}if(this._loop){for(var s=0,h=this._noLoopAnims;s<h.length;s++){a=h[s];this._loopTime=Math.max(this._loopTime,a.loopTime*1e3)}}};i.prototype.play=function(t,e,i){t=t||1;e=e||false;i=i||false;for(var r=0;r<this._animCount;r++){var a=this._animations[r];a.play("",t,e,i)}for(var r=0;r<this._proAnimations.length;r++){var a=this._proAnimations[r];a.play("",t,e,i)}this._isPlay=true;this._prewarm=i;this._speed=t;if(e){this._animTime=0}};i.prototype.resetTime=function(t){if(t===void 0){t=0}for(var e;e<this._animCount;e++){var i=this._animations[e];i.animTime=this._timeOffset[e]+t}for(var e;e<this._proAnimations.length;e++){var i=this._proAnimations[e];i.animTime=this._timeOffset[e]+t}};Object.defineProperty(i.prototype,"speed",{get:function(){return this._speed},set:function(t){if(t<1e-7){t=1e-7}this._speed=t},enumerable:true,configurable:true});i.prototype.stop=function(){for(var t;t<this._animCount;t++){this._animations[t].stop()}for(var t=0;t<this._proAnimations.length;t++){var e=this._proAnimations[t];e.stop()}this._isPlay=false};i.prototype.isPlay=function(){return this._isPlay};i.prototype.update=function(i,r,a){e.prototype.update.call(this,i,r,a);if(this._loop&&this._animTime>this._loopTime){this._animTime-=this._loopTime;var n;for(var o=0,s=this._noLoopAnims;o<s.length;o++){n=s[o];n.play("",this._speed,true,this._prewarm)}}this._animTime+=this._speed*r;if(!this._loop){var h=this._loopTime*1e3;if(this._lastAnimTime<=h&&this._animTime>h){this._event3D.eventType=t.AnimationEvent3D.COMPLETE;this._event3D.target=this;this.dispatchEvent(this._event3D)}}this._lastAnimTime=this._animTime};i.prototype.dispose=function(){this.stop();if(this._animations){this._animations.length=0;delete this._animations}if(this._noLoopAnims){this._noLoopAnims.length=0;delete this._noLoopAnims}};i.prototype.copy=function(t){e.prototype.copy.call(this,t)};i.prototype.clone=function(){var t=new i;t.copy(this);return t};i.prototype.deepClone=function(){var t=e.prototype.deepClone.call(this);t.init(this._loop);return t};return i}(t.Object3D);t.EffectGroup=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.enablePick=false}Object.defineProperty(e,"instance",{get:function(){if(!e._instance){e._instance=new e}return e._instance},enumerable:true,configurable:true});e.prototype.update=function(e,i,r,a,n){t.Egret3DCanvas.context3DProxy.clearColor(1,1,1,1);t.Egret3DCanvas.context3DProxy.clear(t.Context3DProxy.gl.COLOR_BUFFER_BIT|t.Context3DProxy.gl.DEPTH_BUFFER_BIT)};e.prototype.drawOver=function(e,i,r,a,n){t.Context3DProxy.gl.readPixels(0,0,this.pickRender.renderTexture.width,this.pickRender.renderTexture.height,t.Context3DProxy.gl.RGBA,t.Context3DProxy.gl.UNSIGNED_BYTE,this.piexs);var o=0};e.prototype.getObjectId=function(t,e,i,r){var a=t-r.x;var n=e-r.y;n=r.height-n;var o=Math.floor(a/r.width*this.pickRender.renderTexture.width);var s=Math.floor(n/r.height*this.pickRender.renderTexture.height);var h=s*this.pickRender.renderTexture.width+o;return this.piexs[h*4+0]<<16|this.piexs[h*4+1]<<8|this.piexs[h*4+2]};return e}();t.PickSystem=e;var i=function(e){__extends(i,e);function i(){e.call(this);this.useDelay=1e3;this._select=false;this._selectSure=false;this._count=0;this._pickProgressEvent=new t.PickEvent3D("pick_Progress");this._pickSureEvent=new t.PickEvent3D("pick_Sure");this._pickCancleEvent=new t.PickEvent3D("pick_cancle");this._sceneRay=new t.Ray}i.prototype.update=function(e,i,r){this._sceneRay.CalculateAndTransformRay(e.width,e.height,e.camera3D.modelMatrix,e.camera3D.projectMatrix,e.width*.5,e.height*.5);var a=e.entityCollect.specialCastItem[t.SpecialCast.Pick];var n;var o=t.MathUtil.MAX_VALUE;if(this._selection)o=t.Vector3D.distance(e.camera3D.position,this._selection.position);var s=0;this._select=false;for(var h=0;h<a.length;h++){n=a[h].bound;if(this._sceneRay.IntersectMesh(n.vexData,n.indexData,n.vexLength,n.indexData.length/3,0,a[h].modelMatrix,a[h].pickResult)){this._select=true;s=t.Vector3D.distance(e.camera3D.position,a[h].position);if(s<o){this._count=0;o=s;if(this._selection){this._pickCancleEvent.pickTarget=this._selection;this.dispatchEvent(this._pickCancleEvent)}this._selection=a[h]}}}if(this._select&&this._selection){this._count++;this._pickProgressEvent.pickTarget=this._selection;this._pickProgressEvent.delay=this._count;this.dispatchEvent(this._pickProgressEvent);if(this._count>this.useDelay&&!this._selectSure){this._selectSure=true;this._pickSureEvent.pickTarget=this._selection;this.dispatchEvent(this._pickSureEvent)}}else if(this._selection){this._pickCancleEvent.pickTarget=this._selection;this.dispatchEvent(this._pickCancleEvent);this._selectSure=false;this._selection=null;this._select=false;this._count=0}};i.PICK_PROGRESS="pick_Progress";i.PICK_SURE="pick_Sure";i.PICK_CANCLE="pick_cancle";return i}(t.EventDispatcher);t.EyePick=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this._tree=new t.TreeBase(this)}Object.defineProperty(i.prototype,"quad",{get:function(){return this._quad},enumerable:true,configurable:true});i.prototype.infrustumList=function(t){return this._tree.infrustumList(t)};i.prototype.createQuadTree=function(){this._quad=new t.QuadRoot(16,2500);var e=new Array;this.collectQuadList(e,this);this._quad.createQuadTree(e)};i.prototype.collectQuadList=function(e,i){e=e||new Array;var r;if(i instanceof t.Mesh){r=i;if(r.aabb){e.push(r)}}var a;if(i.childs&&i.childs.length>0){for(var n=0,o=i.childs;n<o.length;n++){a=o[n];this.collectQuadList(e,a)}}return e};i.prototype.clone=function(){var t=new i;t.copy(this);return t};return i}(t.Object3D);t.Scene3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(t){this._searchList=new Array;this._root=t}t.prototype.infrustumList=function(t){this._searchList.length=0;return this._searchList};return t}();t.TreeBase=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.useMipmap=true;this.smooth=true;this.repeat=false;this.premultiply_alpha=0;this.filp_y=0;this.hasMipmap=false;this.mirroredU=false;this.mirroredV=false;this.ready=false}e.prototype.copyFromTexture=function(e,i,r,a,n){this.parentTexture=e;e.width=a;e.height=n;this.guiIndex=e.guiIndex;this.texture2D=e.texture2D;this.uvRectangle=this.uvRectangle||new t.Rectangle;this.uvRectangle.x=i;this.uvRectangle.y=r;this.uvRectangle.width=a;this.uvRectangle.height=n};e.prototype.upload=function(t){};e.prototype.uploadForcing=function(t){};e.prototype.activeState=function(e){if(this.ready)return;this.ready=true;if(!this.premultiply_alpha){t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0)}if(this.useMipmap&&!this.hasMipmap){t.Context3DProxy.gl.generateMipmap(t.Context3DProxy.gl.TEXTURE_2D);this.hasMipmap=true}if(this.smooth){if(this.hasMipmap){e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR_MIPMAP_LINEAR);e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR)}else{e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR);e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR)}}else{e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.NEAREST);e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.NEAREST)}if(this.repeat){if(this.mirroredU){t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.MIRRORED_REPEAT)}else if(this.mirroredV){t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.MIRRORED_REPEAT)}else{e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.REPEAT);e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.REPEAT)}}else{e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE);e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE)}if(this.filp_y){t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_FLIP_Y_WEBGL,this.filp_y)}};e.prototype.dispose=function(){if(this.texture2D){this.texture2D.dispose()}this.texture2D=null;if(this.texture3D){this.texture3D.dispose()}this.texture3D=null};e.prototype.readPixels=function(e,i,r,a,n,o,s){if(n===void 0){n=t.ContextConfig.ColorFormat_RGBA8888}if(o===void 0){o=t.ContextConfig.UNSIGNED_BYTE}if(s===void 0){s=null}if(!s){switch(o){case t.ContextConfig.UNSIGNED_BYTE:if(n==t.ContextConfig.ColorFormat_RGBA8888){s=new Uint8Array(r*a*4)}else if(n==t.ContextConfig.ColorFormat_RGB888){s=new Uint8Array(r*a*3)}break;case t.ContextConfig.FLOAT:if(n==t.ContextConfig.ColorFormat_RGBA8888){s=new Float32Array(r*a*4)}else if(n==t.ContextConfig.ColorFormat_RGB888){s=new Float32Array(r*a*3)}break}}return s};return e}();t.ITexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i){e.call(this);this.imageData=i;this.texture2D=new t.ContextTexture2D;this.texture2D.imageData=i}Object.defineProperty(i.prototype,"width",{get:function(){return this.imageData.width},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"height",{get:function(){return this.imageData.height},enumerable:true,configurable:true});i.prototype.upload=function(e){if(!this.texture2D.textureBuffer){this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture();this.texture2D.internalFormat=t.InternalFormat.ImageData;this.texture2D.imageData=this.imageData;this.texture2D.dataFormat=t.Context3DProxy.gl.UNSIGNED_BYTE;this.texture2D.colorFormat=t.ContextConfig.ColorFormat_RGBA8888;e.upLoadTextureData(0,this)}};i.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)};i.prototype.dispose=function(){e.prototype.dispose.call(this);if(this.imageData){delete this.imageData;this.imageData=null}};i.prototype.readPixels=function(e,i,r,a,n,o,s){if(n===void 0){n=t.ContextConfig.ColorFormat_RGBA8888}if(o===void 0){o=t.ContextConfig.UNSIGNED_BYTE}if(s===void 0){s=null}return t.Egret3DCanvas.draw2DImage(this.imageData,e,i,r,a)};return i}(t.ITexture);t.ImageTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.smooth=true;this.texture2D=new t.ContextTexture2D}i.prototype.upload=function(e){if(!this.texture2D.textureBuffer){this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture();this.texture2D.internalFormat=this.internalFormat;this.texture2D.colorFormat=this.colorFormat;this.texture2D.mimapData=this.mimapData;this.texture2D.dataFormat=t.Context3DProxy.gl.UNSIGNED_BYTE;if(this.mimapData&&this.mimapData.length>0){for(var i=0;i<this.mimapData.length;i++){e.upLoadTextureData(i,this)}}else{e.upLoadTextureData(0,this)}if(this.parentTexture){if(!this.parentTexture.texture2D){this.parentTexture.upload(e)}this.texture2D=this.parentTexture.texture2D;this.texture2D.internalFormat=this.parentTexture.internalFormat;this.texture2D.colorFormat=this.parentTexture.colorFormat;this.texture2D.mimapData=this.parentTexture.mimapData}}};i.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)};return i}(t.ITexture);t.Texture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a,n,o,s){if(i===void 0){i=null}if(r===void 0){r=null}if(a===void 0){a=null}if(n===void 0){n=null}if(o===void 0){o=null}if(s===void 0){s=null}e.call(this);this.image_front=i;this.image_back=r;this.image_left=a;this.image_right=n;this.image_up=o;this.image_down=s;this.texture3D=new t.ContextTexture3D}i.createCubeTexture=function(e,r,a,n,o,s){var h=new t.ContextTexture2D;h.imageData=e;var u=new t.ContextTexture2D;u.imageData=r;var l=new t.ContextTexture2D;l.imageData=a;var c=new t.ContextTexture2D;c.imageData=n;var f=new t.ContextTexture2D;f.imageData=o;var d=new t.ContextTexture2D;d.imageData=s;var p=new i(h,u,l,c,f,d);return p};i.createCubeTextureByImageTexture=function(t,e,r,a,n,o){return new i(t.texture2D,e.texture2D,r.texture2D,a.texture2D,n.texture2D,o.texture2D)};i.setCubeTexture=function(t,e,i,r,a,n,o){t.image_front=e.texture2D;t.image_back=i.texture2D;t.image_left=r.texture2D;t.image_right=a.texture2D;t.image_up=n.texture2D;t.image_down=o.texture2D};i.prototype.upload=function(t){if(!this.image_front||!this.image_back||!this.image_left||!this.image_right||!this.image_up||!this.image_down){return}if(!this.texture3D.texture){this.texture3D.texture=this.texture3D.texture||t.creatTexture();this.texture3D.border=0;this.texture3D.image_front=this.image_front;this.texture3D.image_back=this.image_back;this.texture3D.image_left=this.image_left;this.texture3D.image_right=this.image_right;this.texture3D.image_up=this.image_up;this.texture3D.image_down=this.image_down;t.uploadCubetexture(this.texture3D)}};i.prototype.uploadForcing=function(t){};return i}(t.ITexture);t.CubeTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(){e.call(this);this.width=32;this.height=32;this.uvRectangle=new t.Rectangle(0,0,1,1);this.buildCheckerboard();this.texture2D=new t.ContextTexture2D}i.prototype.upload=function(e){if(!this.texture2D.textureBuffer){this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture();this.texture2D.border=0;this.texture2D.internalFormat=t.InternalFormat.PixelArray;this.texture2D.colorFormat=t.Context3DProxy.gl.RGBA;this.texture2D.mimapData=new Array;this.texture2D.mimapData.push(new t.MipmapData(this._pixelArray,this.width,this.height));this.texture2D.width=this.width;this.texture2D.height=this.height;this.useMipmap=false;this.texture2D.dataFormat=t.Context3DProxy.gl.UNSIGNED_BYTE;e.upLoadTextureData(0,this)}};i.prototype.buildCheckerboard=function(){if(!this._pixelArray){this._pixelArray=new Uint8Array(this.width*this.height*4);var e=[t.Color.white(),t.Color.black()];var i=0;var r=4;for(var a=0;a<this.height;a++){for(var n=0;n<this.width;n++){if(n%r==0){i=(i+1)%2}if(a%r==0&&n==0){var o=e[0];e[0]=e[1];e[1]=o;i=0}this._pixelArray[a*(this.width*4)+n*4+0]=e[i].r;this._pixelArray[a*(this.width*4)+n*4+1]=e[i].g;this._pixelArray[a*(this.width*4)+n*4+2]=e[i].b;this._pixelArray[a*(this.width*4)+n*4+3]=e[i].a}}}};i.prototype.uploadForcing=function(t){};i.prototype.dispose=function(){e.prototype.dispose.call(this);if(this._pixelArray){delete this._pixelArray}this._pixelArray=null};i.texture=new i;return i}(t.ITexture);t.CheckerboardTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r){var a=this;if(i===void 0){i=256}if(r===void 0){r=256}e.call(this);this.canUpdataTexture=false;this.width=i;this.height=r;this.texture2D=new t.ContextTexture2D;this.tmpCanvas=document.createElement("canvas");this.tmpCanvas.width=i;this.tmpCanvas.height=r;this.context=this.tmpCanvas.getContext("2d");this.video=document.createElement("video");this.video.msZoom=true;this.video.width=i;this.video.height=r;this.video.videoWidth=i;this.video.videoHeight=r;this.video.controls=false;this.video.autoplay=true;this.video.addEventListener("canplaythrough",function(){return a.loadReady()},true);this.tmpCanvas.hidden=true}i.prototype.loadReady=function(){this.canUpdataTexture=true};Object.defineProperty(i.prototype,"source",{get:function(){return this.video.src},set:function(t){this.video.src=t},enumerable:true,configurable:true});i.prototype.play=function(){this.video.play()};i.prototype.pause=function(){this.video.pause()};i.prototype.upload=function(e){if(!this.texture2D.textureBuffer){this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture();this.context.drawImage(this.video,0,0,this.width,this.height);t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_ALIGNMENT,1);t.Context3DProxy.gl.bindTexture(t.Context3DProxy.gl.TEXTURE_2D,this.texture2D.textureBuffer);t.Context3DProxy.gl.texImage2D(t.Context3DProxy.gl.TEXTURE_2D,0,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.UNSIGNED_BYTE,this.tmpCanvas);t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR);t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR);t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE);t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE)}if(this.canUpdataTexture){this.context.drawImage(this.video,0,0,this.width,this.height);t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_ALIGNMENT,1);t.Context3DProxy.gl.bindTexture(t.Context3DProxy.gl.TEXTURE_2D,this.texture2D.textureBuffer);t.Context3DProxy.gl.texImage2D(t.Context3DProxy.gl.TEXTURE_2D,0,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.UNSIGNED_BYTE,this.tmpCanvas);t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR);t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR);t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE);t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE)}};i.prototype.uploadForcing=function(t){};return i}(t.ITexture);t.VideoTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(e){__extends(i,e);function i(i,r,a){if(i===void 0){i=512}if(r===void 0){r=512}if(a===void 0){a=t.FrameBufferFormat.UNSIGNED_BYTE_RGB}e.call(this);this.frameBufferFormat=t.FrameBufferFormat.UNSIGNED_BYTE_RGB;this.useMipmap=false;this.smooth=false;this.width=i;this.height=r;this.frameBufferFormat=a;this.uvRectangle=new t.Rectangle(0,0,1,1);switch(this.frameBufferFormat){case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:this.colorFormat=t.ContextConfig.UNSIGNED_BYTE;break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:this.colorFormat=t.ContextConfig.UNSIGNED_BYTE;break;case t.FrameBufferFormat.FLOAT_RGBA:this.colorFormat=t.ContextConfig.FLOAT;break;case t.FrameBufferFormat.FLOAT_RGB:this.colorFormat=t.ContextConfig.FLOAT;break}}i.prototype.upload=function(t){if(!this.texture2D){this.texture2D=t.createFramebuffer(this.width,this.height,this.frameBufferFormat)}};i.prototype.uploadForcing=function(t){};i.prototype.fillPixels=function(){if(this.texture2D){var e;if(!this.texture2D.mimapData){this.texture2D.mimapData=[];switch(this.frameBufferFormat){case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:e=new Uint8Array(this.width*this.height*4);break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:e=new Uint8Array(this.width*this.height*3);break;case t.FrameBufferFormat.FLOAT_RGBA:e=new Float32Array(this.width*this.height*4);break;case t.FrameBufferFormat.FLOAT_RGB:e=new Float32Array(this.width*this.height*3);break}var i=new t.MipmapData(e,this.width,this.height);this.texture2D.mimapData.push(i)}else{var i=this.texture2D.mimapData[0];e=i.data}t.Context3DProxy.gl.readPixels(0,0,this.width,this.height,this.colorFormat,t.ContextConfig.UNSIGNED_BYTE,e)}};i.prototype.readPixels=function(i,r,a,n,o,s,h){if(o===void 0){o=t.ContextConfig.ColorFormat_RGBA8888}if(s===void 0){s=t.ContextConfig.UNSIGNED_BYTE}if(h===void 0){h=null}h=e.prototype.readPixels.call(this,i,r,a,n,o,s,h);if(this.texture2D&&this.texture2D.mimapData){var u=this.texture2D.mimapData[0];var l=u.data;var c=4;switch(this.frameBufferFormat){case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:case t.FrameBufferFormat.FLOAT_RGBA:c=4;break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:case t.FrameBufferFormat.FLOAT_RGB:c=3;break}for(var f=0;f<n;++f){for(var d=0;d<a;++d){for(var p=0;p<c;++p){h[(f*a+d)*4+p]=l[((r+f)*this.width+(i+d))*4+p]}}}}return h};return i}(t.ITexture);t.RenderTexture=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){this._boundBox=new t.BoundBox;this.enableShadow=false;this.textureSizeWidth=1024;this.textureSizeHeight=1024;this.shadowCamera=new t.Camera3D(t.CameraType.orthogonal);this.shadowRender=new t.MultiRender(t.PassType.shadowPass);this.shadowRender.name=t.PassType.shadowPass.toString();this.shadowRender.camera=this.shadowCamera;this.shadowRender.setRenderToTexture(this.textureSizeWidth,this.textureSizeHeight,t.FrameBufferFormat.UNSIGNED_BYTE_RGBA);this.castShadowLight(e.sunLight);var i=t.MathUtil.CALCULATION_VECTOR3D;i.copyFrom(this.directLight.dir);i.negate();i.scaleBy(1e3);this.shadowCamera.globalPosition=i;e.renderQuen.addRender(this.shadowRender)}e.prototype.setTextureSize=function(e,i){this.textureSizeWidth=e;this.textureSizeHeight=i;this.shadowRender.setRenderToTexture(this.textureSizeWidth,this.textureSizeHeight,t.FrameBufferFormat.UNSIGNED_BYTE_RGBA)};e.prototype.castShadowLight=function(t){this.directLight=t;this.shadowCamera.updateViewport(0,0,2048,2048);this.shadowCamera.near=1;this.shadowCamera.far=3e3;t.addChild(this.shadowCamera)};e.prototype.update=function(t,e,i){this.calculateBoundBox(t)};e.prototype.calculateBoundBox=function(e){this._boundBox.min.copyFrom(new t.Vector3D(t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE));this._boundBox.max.copyFrom(new t.Vector3D(-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE));for(var i=0;i<e.specialCastItem[t.SpecialCast.Shadow].length;i++){var r=e.specialCastItem[t.SpecialCast.Shadow][i];var a=r.bound;if(this._boundBox.max.x<a.max.x+r.globalX){this._boundBox.max.x=a.max.x+r.globalX}if(this._boundBox.max.y<a.max.y+r.globalY){this._boundBox.max.y=a.max.y+r.globalY}if(this._boundBox.max.z<a.max.z+r.globalZ){this._boundBox.max.z=a.max.z+r.globalZ}if(this._boundBox.min.x>a.min.x+r.globalX){this._boundBox.min.x=a.min.x+r.globalX}if(this._boundBox.min.y>a.min.y+r.globalY){this._boundBox.min.y=a.min.y+r.globalY}if(this._boundBox.min.z>a.min.z+r.globalZ){this._boundBox.min.z=a.min.z+r.globalZ}}this._boundBox.fillBox(this._boundBox.min,this._boundBox.max);var n=t.MathUtil.CALCULATION_VECTOR3D;n.copyFrom(this.directLight.dir);n.negate();n.scaleBy(this._boundBox.radius);n.add(this._boundBox.center,n);this.shadowCamera.globalPosition=n;this.shadowCamera.updateViewport(0,0,this._boundBox.radius*2,this._boundBox.radius*2);this.shadowCamera.far=this._boundBox.radius*2};return e}();t.ShadowCast=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this.cameras=new Array}t.prototype.addCamera=function(t){this.cameras.push(t)};t.prototype.removeCamera=function(t){var e=this.cameras.indexOf(t);if(e>=0){this.cameras.splice(e,1)}};t.prototype.update=function(t,e){};t.instance=new t;return t}();t.CameraManager=e})(egret3d||(egret3d={}));var egret3d;(function(t){(function(t){t[t["perspective"]=0]="perspective";t[t["orthogonal"]=1]="orthogonal";t[t["orthogonalToCenter"]=2]="orthogonalToCenter"})(t.CameraType||(t.CameraType={}));var e=t.CameraType;var i=function(i){__extends(r,i);function r(r){if(r===void 0){r=e.perspective}i.call(this);this.projectMatrix=new t.Matrix4_4;this._orthProjectMatrix=new t.Matrix4_4;this._viewPort=new t.Rectangle;this._scissorRect=new t.Rectangle;this._aspectRatio=1;this._fovY=45;this._near=1;this._far=1e4;this.temp=new t.Matrix4_4;this._lookAtPosition=new t.Vector3D;this._up=new t.Vector3D(0,1,0);this._cameraType=0;this._cameraMatrixChange=false;this._viewMatrix=new t.Matrix4_4;this._tempQuat=new t.Quaternion;this._normalMatrix=new t.Matrix4_4;this._unprojection=new t.Matrix4_4;this._animation=[];this.orthProjectChange=true;this._mat=new t.Matrix4_4;this._maxBest=false;this._maxBestPoint=new t.Point;this._angleVector=new t.Vector3D;this.billboardX=new t.Matrix4_4;this.billboardY=new t.Matrix4_4;this.billboardZ=new t.Matrix4_4;this.billboardXYZ=new t.Matrix4_4;this.raw=new Float32Array(16);this.v=new t.Vector3D;this.p=new t.Vector3D;this.frustum=new t.Frustum(this);this._orthProjectMatrix.ortho(this._viewPort.width,this._viewPort.height,this._near,this._far);this.cameraType=r;t.CameraManager.instance.addCamera(this);this._viewMatrix.identity()}Object.defineProperty(r.prototype,"cameraType",{get:function(){return this._cameraType},set:function(t){this._cameraType=t;switch(t){case e.orthogonal:this.projectMatrix.ortho(this._viewPort.width,this._viewPort.height,this._near,this._far);break;case e.orthogonalToCenter:this.projectMatrix.orthoOffCenter(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height,this._near,this._far);break;case e.perspective:this.projectMatrix.perspective(this._fovY,this._aspectRatio,this._near,this._far);break}this._orthProjectMatrix.ortho(this._viewPort.width,this._viewPort.height,this._near,this._far);this.frustum.updateFrustum()},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"maxWidthAndHeight",{get:function(){if(!this._maxBest){this._maxBest=true;this._maxBestPoint.x=t.sizeUtil.getBestPowerOf2(this.viewPort.width);this._maxBestPoint.y=t.sizeUtil.getBestPowerOf2(this.viewPort.height)}return this._maxBestPoint},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"aspectRatio",{get:function(){return this._aspectRatio},set:function(t){if(this._aspectRatio!=t){this._aspectRatio=t;this.cameraType=this._cameraType}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"fieldOfView",{get:function(){return this._fovY},set:function(t){if(this._fovY!=t){this._fovY=t;this.cameraType=this._cameraType}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"near",{get:function(){return this._near},set:function(t){if(this._near!=t){this._near=t;this.cameraType=this._cameraType}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"far",{get:function(){return this._far},set:function(t){if(this._far!=t){this._far=t;this.cameraType=this._cameraType}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"viewProjectionMatrix",{get:function(){this.temp.copyFrom(this.viewMatrix);this.temp.multiply(this.projectMatrix);return this.temp},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"orthProjectionMatrix",{get:function(){if(this.orthProjectChange){this.orthProjectChange=false;this._orthProjectMatrix.ortho(this._viewPort.width,this._viewPort.height,this._near,this._far)}return this._orthProjectMatrix},enumerable:true,configurable:true});r.prototype.updateScissorRect=function(t,e,i,r){this._scissorRect.x=t;this._scissorRect.y=e;this._scissorRect.width=i;this._scissorRect.height=r};r.prototype.updateViewport=function(t,i,r,a){if(t==this._viewPort.x&&i==this._viewPort.y&&r==this._viewPort.width&&a==this._viewPort.height){return}this.orthProjectChange=true;this._viewPort.x=t;this._viewPort.y=i;this._viewPort.width=r;this._viewPort.height=a;switch(this.cameraType){case e.orthogonal:case e.orthogonalToCenter:this.cameraType=this.cameraType;break}};r.prototype.lookAt=function(e,i,r){if(r===void 0){r=t.Vector3D.Y_AXIS}this.globalPosition=e;this._lookAtPosition.copyFrom(i);this._up.copyFrom(r);this._viewMatrix.lookAt(e,i,r);this._mat.copyFrom(this._viewMatrix);this._mat.invert();var a=this._mat.decompose(t.Orientation3D.QUATERNION);this._tempQuat.x=a[1].x;this._tempQuat.y=a[1].y;this._tempQuat.z=a[1].z;this._tempQuat.w=a[1].w;this.globalOrientation=this._tempQuat};r.prototype.lookAtLocal=function(e,i,r){if(r===void 0){r=t.Vector3D.Y_AXIS}this.position=e;this._lookAtPosition.copyFrom(i);this._up.copyFrom(r);this._viewMatrix.lookAt(e,i,r);this._mat.copyFrom(this._viewMatrix);this._mat.invert();var a=this._mat.decompose(t.Orientation3D.QUATERNION);this._tempQuat.x=a[1].x;this._tempQuat.y=a[1].y;this._tempQuat.z=a[1].z;this._tempQuat.w=a[1].w;this.orientation=this._tempQuat};r.prototype.onMakeTransform=function(){t.Vector3D.HELP_1.setTo(1,1,1,1);t.Vector3D.HELP_0.setTo(0,0,0,1);this._modelMatrix3D.makeTransform(this._pos,t.Vector3D.HELP_1,this._orientation);this._modelMatrix3D.makeTransform(this._globalPos,t.Vector3D.HELP_1,this._globalOrientation);t.MathUtil.calcDegree(this._globalOrientation,this._angleVector);this.billboardY.identity();this.billboardY.createByRotation(this._angleVector.y,t.Vector3D.Y_AXIS);this.billboardXYZ.makeTransform(t.Vector3D.HELP_0,t.Vector3D.HELP_1,this._globalOrientation);
};r.prototype.onUpdateTransform=function(){this._viewMatrix.copyFrom(this._modelMatrix3D);this._viewMatrix.invert();this.frustum.update()};Object.defineProperty(r.prototype,"viewMatrix",{get:function(){if(this._transformChange){this.modelMatrix}return this._viewMatrix},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},enumerable:true,configurable:true});r.prototype.updataOrth=function(t){var e=2e3;var i=e*.5;var r=i*this._aspectRatio;var a,n,o,s;if(this._scissorRect.x==0&&this._scissorRect.y==0&&this._scissorRect.width==this._viewPort.width&&this._scissorRect.height==this._viewPort.height){a=-r;n=r;o=-i;s=i;this.raw[0]=2/(e*this._aspectRatio);this.raw[5]=2/e;this.raw[10]=1/(this._far-this._near);this.raw[14]=this._near/(this._near-this._far);this.raw[1]=this.raw[2]=this.raw[3]=this.raw[4]=this.raw[6]=this.raw[7]=this.raw[8]=this.raw[9]=this.raw[11]=this.raw[12]=this.raw[13]=0;this.raw[15]=1}else{var h=r*(this._viewPort.width/this._scissorRect.width);var u=i*(this._viewPort.height/this._scissorRect.height);var l=r*(this._scissorRect.x*2-this._viewPort.width)/this._scissorRect.width+r;var c=-i*(this._scissorRect.y*2-this._viewPort.height)/this._scissorRect.height-i;a=l-h;n=l+h;o=c-u;s=c+u;this.raw[0]=2*1/(n-a);this.raw[5]=-2*1/(o-s);this.raw[10]=1/(this._far-this._near);this.raw[12]=(n+a)/(n-a);this.raw[13]=(s+o)/(s-o);this.raw[14]=this._near/(this.near-this.far);this.raw[1]=this.raw[2]=this.raw[3]=this.raw[4]=this.raw[6]=this.raw[7]=this.raw[8]=this.raw[9]=this.raw[11]=0;this.raw[15]=1}t.copyRawDataFrom(this.raw)};r.prototype.isVisibleToCamera=function(t){t.modelMatrix;this.modelMatrix;var e=true;if(t.bound){e=t.bound.inBound(this.frustum)||!t.enableCulling}t.inFrustum=e;return e};r.prototype.addAnimation=function(t,e){this._animation[t]=e};r.prototype.play=function(t,e){if(e===void 0){e=false}if(this._animation[t]){this._animation[t].bindCamera(this);this._animation[t].play(e)}};r.prototype.update=function(t,e,r){i.prototype.update.call(this,t,e,r);for(var a in this._animation){this._animation[a].update(t,e)}};r.prototype.object3DToScreenRay=function(e,i){if(i===void 0){i=null}if(!i){i=new t.Vector3D}this._halfw=this.viewPort.width*.5;this._halfh=this.viewPort.height*.5;i=this.viewMatrix.transformVector(e,i);this.project(i,i);i.x=this._halfw+i.x*this._halfw;i.y=this.viewPort.height-(this._halfh-i.y*this._halfh);return i};r.prototype.ScreenRayToObject3D=function(e,i){if(i===void 0){i=null}if(!i){i=new t.Vector3D}this._halfw=this.viewPort.width*.5;this._halfh=this.viewPort.height*.5;i.x=(e.x-this._halfw)/this._halfw;i.y=(this._halfh-(this.viewPort.height-e.y))/this._halfh;this.unproject(i.x,i.y,e.z,i);this.modelMatrix.transformVector(i,i);return i};r.prototype.unproject=function(t,e,i,r){r.x=t;r.y=-e;r.z=i;r.w=1;r.x*=i;r.y*=i;this._unprojection.copyFrom(this.projectMatrix);this._unprojection.invert();this._unprojection.transformVector(r,r);r.z=i;return r};r.prototype.project=function(t,e){e=this.projectMatrix.transformVector(t,e);e.x=e.x/e.w;e.y=-e.y/e.w;e.z=t.z;return e};r.prototype.dispose=function(){t.CameraManager.instance.removeCamera(this);i.prototype.dispose.call(this);if(this.frustum){this.frustum.dispose()}this.frustum=null};r.prototype.clone=function(){var t=new r;t.copy(this);return t};return r}(t.Object3D);t.Camera3D=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.minPosX=0;this.minPosY=0;this.maxPosX=0;this.maxPosY=0;this.testID=0;this.points=new Array;this.offsetPosition=new t.Vector3D(0,0,0,0);this.clear()}e.prototype.setAABox=function(t,i,r,a){this.minPosX=t-r/2-e.TINY;this.maxPosX=t+r/2+e.TINY;this.minPosY=i-a/2-e.TINY;this.maxPosY=i+a/2+e.TINY;this.offsetPosition.setTo(0,0,0)};e.prototype.setOffset=function(t){this.maxPosX+=t.x-this.offsetPosition.x;this.minPosX+=t.x-this.offsetPosition.x;this.minPosY+=t.z-this.offsetPosition.z;this.maxPosY+=t.z-this.offsetPosition.z;this.offsetPosition.copyFrom(t)};e.prototype.setContainRect=function(t,e,i,r){if(this.minPosX>t)this.minPosX=t;if(this.minPosY>e)this.minPosY=e;if(this.maxPosX<i)this.maxPosX=i;if(this.maxPosY<r)this.maxPosY=r};e.prototype.clear=function(){var t=1e9;this.minPosX=this.minPosY=t;this.maxPosX=this.maxPosY=-t;this.points.length=0;this.testID=0;this.offsetPosition.setTo(0,0,0)};e.prototype.addPoint=function(t){if(this.points.indexOf(t)==-1){if(t.x<this.minPosX)this.minPosX=t.x-e.TINY;if(t.x>this.maxPosX)this.maxPosX=t.x+e.TINY;if(t.z<this.minPosY)this.minPosY=t.z-e.TINY;if(t.z>this.maxPosY)this.maxPosY=t.z+e.TINY;this.points.push(t)}};e.prototype.clone=function(){var t=new e;t.minPosX=this.minPosX;t.minPosY=this.minPosY;t.maxPosX=this.maxPosX;t.maxPosY=this.maxPosY;return t};Object.defineProperty(e.prototype,"radius",{get:function(){return Math.sqrt((this.maxPosY-this.minPosY)*(this.maxPosY-this.minPosY)+(this.maxPosX-this.minPosX)*(this.maxPosX-this.minPosX))},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"sideX",{get:function(){return this.maxPosX-this.minPosX},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"sideY",{get:function(){return this.maxPosY-this.minPosY},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"centreX",{get:function(){return(this.maxPosX-this.minPosX)*.5+this.minPosX},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"centreY",{get:function(){return(this.maxPosY-this.minPosY)*.5+this.minPosY},enumerable:true,configurable:true});e.prototype.overlapTest=function(t){return this.minPosY>=t.maxPosY||this.maxPosY<=t.minPosY||this.minPosX>=t.maxPosX||this.maxPosX<=t.minPosX?false:true};e.prototype.isPointInside=function(t){return t.x>=this.minPosX&&t.x<=this.maxPosX&&t.z>=this.minPosY&&t.z<=this.maxPosY};e.prototype.isIntersectLineSegment=function(t,e,i,r){var a=false;var n=e-r;var o=i-t;var s=t*r-i*e;var h=(-s-n*this.minPosX)/o;if(h<=this.maxPosY&&h>=this.minPosY)a=true;h=(-s-n*this.maxPosX)/o;if(h<=this.maxPosY&&h>=this.minPosY)a=true;var u=(-s-o*this.minPosY)/n;if(u<=this.maxPosX&&u>=this.minPosX)a=true;u=(-s-o*this.maxPosY)/n;if(u<=this.maxPosX&&u>=this.minPosX)a=true;return a};e.TINY=1e-6;return e}();t.QuadAABB=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.logDeep=0;this._testID=0;this._cells=new Array;this._quadNodes=new Array;this._cellsToTest=new Array;this._aabb=new t.QuadAABB}e.prototype.getQuadNode=function(t){return this._quadNodes[t]};e.prototype.clear=function(){this._cells.length=0;this._quadNodes.length=0};e.prototype.initNodes=function(t){this.clear();var e=0;var i=t.length;while(e<i){t[e].calcGlobalQuadAABB();this._quadNodes.push(t[e]);e++}};e.prototype.buildQuadTree=function(e,i){this._aabb.clear();for(var r=0,a=this._quadNodes;r<a.length;r++){var n=a[r];if(n.isTriangle){for(var o=0,s=n.aabb.points;o<s.length;o++){var h=s[o];this._aabb.addPoint(h)}}else{this._aabb.setContainRect(n.aabb.minPosX,n.aabb.minPosY,n.aabb.maxPosX,n.aabb.maxPosY)}}this._cells.length=0;this._rootCell=new t.QuadTreeCell(this._aabb);this._cells.push(this._rootCell);var u=this._quadNodes.length;for(var l=0;l<u;l++){this._cells[0].nodeIndices[l]=l}var c=new Array;c.push(0);var f;var d;var p;while(c.length!=0){d=c.pop();if(this._cells[d].nodeIndices.length<=e||this._cells[d].aabb.radius<i){continue}for(l=0;l<t.QuadTreeCell.NUM_CHILDREN;l++){this._cells[d].childCellIndices[l]=this._cells.length;c.push(this._cells.length);this._cells.push(new t.QuadTreeCell(this.createAABox(this._cells[d].aabb,l)));p=this._cells[this._cells.length-1];u=this._cells[d].nodeIndices.length;var _=0;for(var m=0;m<u;m++){f=this._cells[d].nodeIndices[m];if(this.doesNodeIntersectCell(this._quadNodes[f],p)){_++;p.nodeIndices.push(f)}}}this._cells[d].nodeIndices.length=0}};e.prototype.createAABox=function(e,i){var r=e.centreX;var a=e.centreY;var n=e.sideX;var o=e.sideY;var s=new t.QuadAABB;switch(i){case 0:s.setAABox(r+n/4,a+o/4,n/2,o/2);break;case 1:s.setAABox(r-n/4,a+o/4,n/2,o/2);break;case 2:s.setAABox(r-n/4,a-o/4,n/2,o/2);break;case 3:s.setAABox(r+n/4,a-o/4,n/2,o/2);break;default:s.setAABox(r+n/4,a-o/4,n/2,o/2);break}return s};e.prototype.doesNodeIntersectCell=function(t,e){var i=t.aabb;if(!i.overlapTest(e.aabb)){return false}if(!t.isTriangle)return true;var r=i.points;var a=r[0];var n=r[1];var o=r[2];if(e.aabb.isPointInside(a)||e.aabb.isPointInside(n)||e.aabb.isPointInside(o)){return true}var s=this.pointInTriangle(e.aabb.minPosX,e.aabb.minPosY,a,n,o)||this.pointInTriangle(e.aabb.minPosX,e.aabb.maxPosY,a,n,o)||this.pointInTriangle(e.aabb.maxPosX,e.aabb.maxPosY,a,n,o)||this.pointInTriangle(e.aabb.maxPosX,e.aabb.minPosY,a,n,o);if(s)return true;s=e.aabb.isIntersectLineSegment(a.x,a.z,n.x,n.z)||e.aabb.isIntersectLineSegment(a.x,a.z,o.x,o.z)||e.aabb.isIntersectLineSegment(n.x,n.z,o.x,o.z);return s};e.prototype.getNodesIntersectingtAABox=function(e,i){if(this._cells.length==0)return 0;this._cellsToTest.length=0;this._cellsToTest.push(0);this.incrementTestCounter();var r,a,n;var o;var s=0;while(this._cellsToTest.length!=0){r=this._cellsToTest.pop();n=this._cells[r];if(!i.overlapTest(n.aabb)){continue}if(n.isLeaf()){a=n.nodeIndices.length;for(s=0;s<a;s++){o=this.getQuadNode(n.nodeIndices[s]).aabb;if(o.testID!=this._testID){o.testID=this._testID;if(i.overlapTest(o)){e.push(n.nodeIndices[s])}}}}else{for(s=0;s<t.QuadTreeCell.NUM_CHILDREN;s++){this._cellsToTest.push(n.childCellIndices[s])}}}return e.length};e.prototype.pointInTriangle=function(t,e,i,r,a){var n=i;var o=r;var s=a;var h=n.z-o.z;var u=o.x-n.x;var l=n.x*o.z-o.x*n.z;var c=o.z-s.z;var f=s.x-o.x;var d=o.x*s.z-s.x*o.z;var p=s.z-n.z;var _=n.x-s.x;var m=s.x*n.z-n.x*s.z;var v=false;var g=h*t+u*e+l;var y=c*t+f*e+d;var x=p*t+_*e+m;var b=.01;if(g>=-b&&y>=-b&&x>=-b||g<=b&&y<=b&&x<=b)v=true;return v};e.prototype.incrementTestCounter=function(){++this._testID;if(this._testID==0){var t=this._quadNodes.length;for(var e=0;e<t;e++){this._quadNodes[e].aabb.testID=0}this._testID=1}};e.prototype.logTree=function(t){if(t<0)return;this.logDeep++;var e=this._cells[t];var i="";for(var r=0;r<this.logDeep-1;r++)i+="-|";console.log(i+"i="+t+" "+e.aabb.minPosX.toFixed(2)+" "+e.aabb.maxPosX.toFixed(2)+" "+e.aabb.minPosY.toFixed(2)+" "+e.aabb.maxPosY.toFixed(2));var a;for(a=0;a<e.nodeIndices.length;a++){if(e.nodeIndices[a]>=0){var n=this._quadNodes[e.nodeIndices[a]];console.log(i+" t="+e.nodeIndices[a]+" "+n.aabb.minPosX.toFixed(2)+" "+n.aabb.maxPosX.toFixed(2)+" "+n.aabb.minPosY.toFixed(2)+" "+n.aabb.maxPosY.toFixed(2))}}for(a=0;a<e.childCellIndices.length;a++){if(e.childCellIndices[a]>=0){this.logTree(e.childCellIndices[a])}}this.logDeep--};return e}();t.QuadTree=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i){if(e===void 0){e=10}if(i===void 0){i=500}this._maxNodesPerCell=e;this._minCellSize=i;this._segBox=new t.QuadAABB;this._collisionNodesIdx=new Array;this._collisionNodes=new Array}e.prototype.createQuadTree=function(e){this._quadTree=new t.QuadTree;this._quadTree.initNodes(e);this._quadTree.buildQuadTree(this._maxNodesPerCell,this._minCellSize)};e.prototype.getNodesByAABB=function(t,e,i,r){this._segBox.clear();this._segBox.maxPosX=i;this._segBox.maxPosY=r;this._segBox.minPosX=t;this._segBox.minPosY=e;this._collisionNodesIdx.length=0;this._collisionNodes.length=0;var a=this._quadTree.getNodesIntersectingtAABox(this._collisionNodesIdx,this._segBox);var n;for(var o=0;o<this._collisionNodesIdx.length;o++){n=this._quadTree.getQuadNode(this._collisionNodesIdx[o]);this._collisionNodes.push(n)}return this._collisionNodes};e.prototype.getTriangleAtPoint=function(e,i){if(i===void 0){i=5}this._segBox.clear();this._segBox.setAABox(e.x,e.z,1,1);this._collisionNodesIdx.length=0;this._collisionNodes.length=0;var r=this._quadTree.getNodesIntersectingtAABox(this._collisionNodesIdx,this._segBox);var a=4294967295;var n=0;var o;var s;var h;var u;for(var l=0;l<this._collisionNodesIdx.length;l++){s=this._quadTree.getQuadNode(this._collisionNodesIdx[l]);u=s.aabb;if(!t.PointUtils.pointInsideTriangle(e,u.points[0],u.points[1],u.points[2])){continue}h=s;n=Math.abs(h.plane.distance(e));if(n>i)continue;if(s==null||n<=a){o=h;a=n}}return o};return e}();t.QuadRoot=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(i){this.childCellIndices=new Array;this.childCellIndices.length=e.NUM_CHILDREN;this.nodeIndices=new Array;this.clear();if(i){this.aabb=i.clone()}else{this.aabb=new t.QuadAABB}}e.prototype.isLeaf=function(){return this.childCellIndices[0]==-1};e.prototype.clear=function(){for(var t=0;t<e.NUM_CHILDREN;t++){this.childCellIndices[t]=-1}this.nodeIndices.splice(0,this.nodeIndices.length)};e.NUM_CHILDREN=4;return e}();t.QuadTreeCell=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){this._keys=new Array;this._values=new Array}t.prototype.getIndexByKey=function(t){return this._keys.indexOf(t)};t.prototype.getValueByKey=function(t){var e=this.getIndexByKey(t);if(e>-1){return this._values[e]}return null};t.prototype.put=function(t,e){if(t==null)return null;var i=this.remove(t);this._keys.push(t);this._values.push(e);return i};t.prototype.remove=function(t){var e=this._keys.indexOf(t);var i;if(e>-1){i=this._values[e];this._keys.splice(e,1);this._values.splice(e,1)}return i};t.prototype.getValues=function(){return this._values};t.prototype.getKeys=function(){return this._keys};t.prototype.clear=function(){this._values.length=0;this._keys.length=0};return t}();t.DoubleArray=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){}e.bacthingMesh=function(t){var i=t.nodeList;var r=t.matDict;var a=e.collectStaticMesh(i);var n=0;var o=[];var s=[];var h;var u;for(var l in a){h=Number(l);o=a[h];s=s.concat(this.batching(h,this.checkMaxBacthing(h,o)))}for(var l in a){o=a[l];for(var c in o){u=o[c].object3d;if(u.parent){u.parent.removeChild(u)}}}o.length=0;return s};e.checkMaxBacthing=function(t,e){var i=1e4;var r=[];var a;var n=0;var o=0;var s;for(var h=0;h<e.length;h++){a=e[h].object3d.geometry;for(var u=0;u<a.subGeometrys.length;u++){if(e[h].materialIDs[u]==t){if(n+a.subGeometrys[u].count<i){r[o]=r[o]||[];r[o].push(e[h]);n=n+a.subGeometrys[u].count}else{o++;n=0;r[o]=r[o]||[];r[o].push(e[h]);n=n+a.subGeometrys[u].count}}}}return r};e.collectStaticMesh=function(t){var e={};var i=0;var r;var a;for(var n=0;n<t.length;n++){if(t[n].type=="Mesh"&&t[n].staticType=="Batching"){r=t[n].object3d;i=r.geometry.subGeometrys.length;for(var o=0;o<i;o++){a=t[n].materialIDs[r.geometry.subGeometrys[o].matID];e[a]=e[a]||[];e[a].push(t[n])}}}return e};e.sortByZ=function(t,e){return t.z-e.z};e.batching=function(e,i){var r=this;var a=t.Matrix4_4.helpMatrix;var n=t.Matrix4_4.helpMatrix2;var o;var s;var h=t.Vector3D.HELP_0;var u=new t.Vector3D;var l,c,f=0,d=0;var p=0;var _=0;var m;var v;var g;var y;var x=[];var b=0;var D=0;var T=0;var P=t.Quaternion.HELP_0;for(var A=0;A<i.length;A++){m=i[A];p=0;_=0;m=m.sort(function(t,e){return r.sortByZ(t,e)});for(l=0;l<m.length;l++){o=m[l].object3d;s=o.geometry.vertexAttLength;for(var w=0;w<o.geometry.subGeometrys.length;w++){g=o.geometry.subGeometrys[w];if(m[l].materialIDs[w]==e){y=w;p+=g.count;_+=g.count}}}var S=new t.Geometry;S.vertexFormat=m[0].object3d.geometry.vertexFormat;S.vertexCount=p;S.indexCount=_;S.buildDefaultSubGeometry();var C=S.vertexArray;var E=S.indexArray;f=0;d=0;for(c=0;c<m.length;c++){o=m[c].object3d;var L=a.decompose()[1];P.x=L.x;P.y=L.y;P.z=L.z;P.w=L.w;a.makeTransform(o.globalPosition,o.globalScale,o.globalOrientation);n.makeTransform(new t.Vector3D,o.globalScale,o.globalOrientation);s=o.geometry.vertexAttLength;var M;var F;for(var w=0;w<o.geometry.subGeometrys.length;w++){g=o.geometry.subGeometrys[w];if(m[c].materialIDs[w]==e){y=w;M=o.geometry.vertexArray;F=o.geometry.indexArray;for(var l=0;l<g.count;++l){b=F[g.start+l];D=f+l;h.x=M[b*s];h.y=M[b*s+1];h.z=M[b*s+2];u.x=M[b*s+3];u.y=M[b*s+4];u.z=M[b*s+5];a.transformVector(h,t.Vector3D.HELP_1);n.transformVector(u,t.Vector3D.HELP_2);C[D*s+0]=t.Vector3D.HELP_1.x;C[D*s+1]=t.Vector3D.HELP_1.y;C[D*s+2]=t.Vector3D.HELP_1.z;C[D*s+3]=t.Vector3D.HELP_2.x;C[D*s+4]=t.Vector3D.HELP_2.y;C[D*s+5]=t.Vector3D.HELP_2.z;for(var R=6;R<s;++R){C[D*s+R]=M[b*s+R]}}for(var l=0;l<g.count;++l){T=f+l;E[T]=T}f+=g.count;d+=g.count}}}v=o.getMaterial(y);x.push(new t.Mesh(S,v))}return x};return e}();t.StaticMergeUtil=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i,r,a){if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=100}if(a===void 0){a=100}this._rectangle=new t.Rectangle;this._transformMatrix=new t.Matrix4_4;this._change=false;this._rotation=new t.Vector3D;this._scale=new t.Vector3D(1,1,1);this._position=new t.Vector3D;this._transformComponents=[];this._changeTexture=false;this._textureStage=false;this._vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_UV0;this._uv_scale=new Float32Array(2);this.name="";this.bothside=false;this.cullMode=t.ContextConfig.BACK;this.visible=true;this.vsShader="hud_vs";this.fsShader="hud_V_fs";this._passUsage=new t.PassUsage;this._attList=new Array;this.uniformData={};this._transformComponents.push(this._position);this._transformComponents.push(this._rotation);this._transformComponents.push(this._scale);this.x=e;this.y=i;this.width=r;this.height=a;this._uv_scale[0]=1;this._uv_scale[1]=1}Object.defineProperty(e.prototype,"diffuseTexture",{get:function(){return this._diffuseTexture},set:function(t){this._changeTexture=true;this._diffuseTexture=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"x",{get:function(){return this._rectangle.x},set:function(t){this._change=true;this._rectangle.x=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"y",{get:function(){return this._rectangle.y},set:function(t){this._change=true;this._rectangle.y=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"width",{get:function(){return this._rectangle.width},set:function(t){this._change=true;this._rectangle.width=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"height",{get:function(){return this._rectangle.height},set:function(t){this._change=true;this._rectangle.height=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"rotationX",{get:function(){return this._rotation.x},set:function(t){this._change=true;if(this._rotation.x==t)return;this._rotation.x=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"rotationY",{get:function(){return this._rotation.y},set:function(t){this._change=true;if(this._rotation.y==t)return;this._rotation.y=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"rotationZ",{get:function(){return this._rotation.z},set:function(t){this._change=true;if(this._rotation.z==t)return;this._rotation.z=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"viewPort",{set:function(t){this._viewPort=t},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"uScale",{get:function(){return this._uv_scale[0]},set:function(t){this._uv_scale[0]=t;if(this._uv_scale[0]>1){this._uv_scale[0]=1}if(this._uv_scale[0]<0){this._uv_scale[0]=0}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"vScale",{get:function(){return this._uv_scale[1]},set:function(t){this._uv_scale[1]=t;if(this._uv_scale[1]>1){this._uv_scale[1]=1}if(this._uv_scale[1]<0){this._uv_scale[1]=0}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"transformMatrix",{get:function(){if(!this._viewPort){return this._transformMatrix}if(this._change){this._scale.x=this._rectangle.width/this._viewPort.width;this._scale.y=this._rectangle.height/this._viewPort.height;this._position.x=t.MathUtil.ScreenToPosition(this._rectangle.x,this._rectangle.width,this._viewPort.width);this._position.y=-t.MathUtil.ScreenToPosition(this._rectangle.y,this._rectangle.height,this._viewPort.height);this._transformMatrix.recompose(this._transformComponents);this._change=false}return this._transformMatrix},enumerable:true,configurable:true});e.prototype.updateTexture=function(t){var e;for(var i in this._passUsage.sampler2DList){e=this._passUsage.sampler2DList[i];e.uniformIndex=t.getUniformLocation(this._passUsage.program3D,e.varName);e.texture=this[e.varName]}this._changeTexture=false};e.prototype.upload=function(i){var r=this;if(!r._vertexBuffer3D){r._vertexBuffer3D=i.creatVertexBuffer(e.singleQuadData)}if(!r._indexBuffer3D){r._indexBuffer3D=i.creatIndexBuffer(e.singleQuadIndex)}r._passUsage.vertexShader.shaderType=t.Shader.vertex;r._passUsage.fragmentShader.shaderType=t.Shader.fragment;r._passUsage.vertexShader.addUseShaderName(r.vsShader);r._passUsage.fragmentShader.addUseShaderName(r.fsShader);r._passUsage.vertexShader.shader=r._passUsage.vertexShader.getShader(r._passUsage);r._passUsage.fragmentShader.shader=r._passUsage.fragmentShader.getShader(r._passUsage);r._passUsage.program3D=t.ShaderPool.getProgram(r._passUsage.vertexShader.shader.id,r._passUsage.fragmentShader.shader.id);for(var a in r._passUsage){if(a.indexOf("uniform")!=-1){if(r._passUsage[a]){r._passUsage[a].uniformIndex=i.getUniformLocation(r._passUsage.program3D,a)}}}for(var n in r.uniformData){var o=r.uniformData[n];o.uniformIndex=i.getUniformLocation(r._passUsage.program3D,n)}r._attList.length=0;var s=0;if(r._passUsage.attribute_position){if(!r._passUsage.attribute_position.uniformIndex){r._passUsage.attribute_position.uniformIndex=i.getShaderAttribLocation(r._passUsage.program3D,r._passUsage.attribute_position.varName)}r._attList.push(r._passUsage.attribute_position);r._passUsage.attribute_position.size=t.Geometry.positionSize;r._passUsage.attribute_position.dataType=t.ContextConfig.FLOAT;r._passUsage.attribute_position.normalized=false;r._passUsage.attribute_position.stride=e.vertexBytes;r._passUsage.attribute_position.offset=s;s+=t.Geometry.positionSize*Float32Array.BYTES_PER_ELEMENT}if(r._passUsage.attribute_uv0){if(!r._passUsage.attribute_uv0.uniformIndex){r._passUsage.attribute_uv0.uniformIndex=i.getShaderAttribLocation(r._passUsage.program3D,r._passUsage.attribute_uv0.varName)}r._attList.push(r._passUsage.attribute_uv0);r._passUsage.attribute_uv0.size=t.Geometry.uvSize;r._passUsage.attribute_uv0.dataType=t.ContextConfig.FLOAT;r._passUsage.attribute_uv0.normalized=false;r._passUsage.attribute_uv0.stride=e.vertexBytes;r._passUsage.attribute_uv0.offset=s;s+=t.Geometry.uvSize*Float32Array.BYTES_PER_ELEMENT}r._passUsage["uv_scale"]=i.getUniformLocation(r._passUsage.program3D,"uv_scale")};e.prototype.draw=function(e,i){if(i===void 0){i=null}var r=this;if(!r.visible){return}if(!r._passUsage.program3D){r.upload(e)}e.setProgram(r._passUsage.program3D);e.bindVertexBuffer(r._vertexBuffer3D);e.bindIndexBuffer(r._indexBuffer3D);for(var a=0;a<r._attList.length;++a){var n=r._attList[a];if(n.uniformIndex>=0){e.vertexAttribPointer(n.uniformIndex,n.size,n.dataType,n.normalized,n.stride,n.offset)}}if(r._changeTexture){r.updateTexture(e)}for(var o in r.uniformData){var s=r.uniformData[o];switch(s.type){case t.UniformType.uniform1f:e.uniform1f(s.uniformIndex,s.data[0]);break;case t.UniformType.uniform1fv:e.uniform1fv(s.uniformIndex,s.data);break;case t.UniformType.uniform2f:e.uniform2f(s.uniformIndex,s.data[0],s.data[1]);break;case t.UniformType.uniform2fv:e.uniform2fv(s.uniformIndex,s.data);break;case t.UniformType.uniform3f:e.uniform3f(s.uniformIndex,s.data[0],s.data[1],s.data[2]);break;case t.UniformType.uniform3fv:e.uniform3fv(s.uniformIndex,s.data);break;case t.UniformType.uniform4f:e.uniform4f(s.uniformIndex,s.data[0],s.data[1],s.data[2],s.data[3]);break;case t.UniformType.uniform4fv:e.uniform4fv(s.uniformIndex,s.data);break}}var h;for(var u in r._passUsage.sampler2DList){h=r._passUsage.sampler2DList[u];if(!h.texture){continue}h.texture.upload(e);e.setTexture2DAt(h.activeTextureIndex,h.uniformIndex,h.index,h.texture.texture2D);h.texture.activeState(e);r._textureStage=false}if(r._passUsage.uniform_ViewProjectionMatrix){e.uniformMatrix4fv(r._passUsage.uniform_ViewProjectionMatrix.uniformIndex,false,r.transformMatrix.rawData)}if(r._passUsage.uniform_ViewMatrix&&i){e.uniformMatrix4fv(r._passUsage.uniform_ViewMatrix.uniformIndex,false,i.viewMatrix.rawData)}if(r._passUsage.uniform_ProjectionMatrix&&i){e.uniformMatrix4fv(r._passUsage.uniform_ProjectionMatrix.uniformIndex,false,i.projectMatrix.rawData)}if(r._passUsage["uv_scale"]&&this._passUsage["uv_scale"]!=-1){e.uniform2f(r._passUsage["uv_scale"],r._uv_scale[0],r._uv_scale[1])}e.setCulling(r.cullMode);if(r.bothside){e.disableCullFace()}else e.enableCullFace();e.enableBlend();e.setBlendFactors(t.ContextConfig.SRC_ALPHA,t.ContextConfig.ONE_MINUS_SRC_ALPHA);e.drawElement(t.DrawMode.TRIANGLES,0,6);e.clear(t.ContextConfig.DEPTH_BUFFER_BIT)};e.singleQuadData=new Float32Array([-1,-1,0,0,1,1,-1,0,1,1,1,1,0,1,0,-1,1,0,0,0]);e.singleQuadIndex=new Uint16Array([0,1,2,0,2,3]);e.vertexBytes=20;return e}();t.HUD=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i,r,a,n){if(n===void 0){n=null}this.scissorRect=new t.Rectangle;this._viewPort=new t.Rectangle;this._scene=new t.Scene3D;this._viewMatrix=new t.Matrix4_4;this._backColor=new t.Vector3D(.3,.3,.6,1);this._cleanParmerts=t.Context3DProxy.gl.COLOR_BUFFER_BIT|t.Context3DProxy.gl.DEPTH_BUFFER_BIT;this._sizeDiry=false;this._huds=new Array;this._postList=[];this.sunLight=new t.DirectLight(new t.Vector3D(0,-1,1));this._entityCollect=new t.EntityCollect;this._entityCollect.root=this._scene;this._camera=n||new t.Camera3D(t.CameraType.perspective);this._camera.name="MainCamera";this._scene.addChild(this._camera);this._renderQuen=new t.RenderQuen;this._renderQuen.mainRender.camera=this.camera3D;this.x=e;this.y=i;this.width=r;this.height=a;this._camera.aspectRatio=this._viewPort.width/this._viewPort.height;this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);this.scissorRect.x=this._viewPort.x;this.scissorRect.y=this._viewPort.y;this.scissorRect.width=this._viewPort.width;this.scissorRect.height=this._viewPort.height;this._shadowCast=new t.ShadowCast(this)}Object.defineProperty(e.prototype,"quadStage",{get:function(){return this._quadStage},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"renderQuen",{get:function(){return this._renderQuen},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"shadowCast",{get:function(){return this._shadowCast},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"post",{set:function(e){this._postList=e;if(e.length>0){this._postProcessing=this._postProcessing||new t.PostProcessing(this._renderQuen);this._postHUD=this._postHUD||new t.HUD(0,0,512,512);this._postHUD.fsShader="hud_H_fs"}},enumerable:true,configurable:true});e.prototype.blender=function(e,i){this._cleanParmerts=(e?t.Context3DProxy.gl.COLOR_BUFFER_BIT:0)|(i?t.Context3DProxy.gl.DEPTH_BUFFER_BIT:0)};Object.defineProperty(e.prototype,"backColor",{get:function(){return this._backColor.w*255<<24|this._backColor.x*255<<16|this._backColor.y*255<<8|this._backColor.z*255},set:function(t){this._backColor.w=(t>>24&255)/255;this._backColor.x=(t>>16&255)/255;this._backColor.y=(t>>8&255)/255;this._backColor.z=(t&255)/255},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"backImage",{get:function(){return this._backImg.diffuseTexture},set:function(e){if(e){this._backImg=this._backImg||new t.HUD;this._backImg.diffuseTexture=e;this._backImg.x=this.x;this._backImg.y=this.y;this._backImg.width=this.width;this._backImg.height=this.height}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"camera3D",{get:function(){return this._camera},set:function(t){this._camera=t;this._camera.aspectRatio=this._viewPort.width/this._viewPort.height;this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);if(this._quadStage)this._quadStage.changeCamera()},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t;this._entityCollect.root=this._scene;if(this.camera3D.parent)this.addChild3D(this.camera3D)},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"x",{get:function(){return this._viewPort.x},set:function(t){this._viewPort.x=t;this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);if(this._backImg){this._backImg.x=t}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"y",{get:function(){return this._viewPort.y},set:function(t){this._viewPort.y=t;this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);if(this._backImg){this._backImg.y=t}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"width",{get:function(){return this._viewPort.width},set:function(t){this._viewPort.width=t;this._camera.aspectRatio=this._viewPort.width/this._viewPort.height;this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);if(this._backImg){this._backImg.width=t}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"height",{get:function(){return this._viewPort.height},set:function(t){this._viewPort.height=t;this._camera.aspectRatio=this._viewPort.width/this._viewPort.height;this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);if(this._backImg){this._backImg.height=t}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"entityCollect",{get:function(){return this._entityCollect},enumerable:true,configurable:true});e.prototype.getGUIStage=function(){if(!this._quadStage){this._quadStage=new t.QuadStage(this)}return this._quadStage};e.prototype.addGUI=function(e){if(!this._quadStage){this._quadStage=new t.QuadStage(this)}this._quadStage.addChild(e)};e.prototype.removeGUI=function(t){this._quadStage.removeChild(t)};e.prototype.addChild3D=function(t){this._scene.addChild(t)};e.prototype.removeChild3D=function(t){this._scene.removeChild(t)};e.prototype.inView3D=function(t,e){return this._viewPort.inner(t,e)};e.prototype.addHUD=function(t){if(this._huds.indexOf(t)==-1){t.viewPort=this._viewPort;this._huds.push(t)}};e.prototype.findHud=function(t){for(var e=0;e<this._huds.length;++e){if(this._huds[e].name==t){return this._huds[e]}}return null};e.prototype.delHUD=function(t){var e=this._huds.indexOf(t);if(e>=0&&e<this._huds.length){this._huds.splice(e,1)}};e.prototype.update=function(e,i){this._camera.viewPort=this._viewPort;if(t.Egret3DEngine.instance.debug)this.a=(new Date).getTime();this.updateObject3D(this._scene,e,i);if(t.Egret3DEngine.instance.debug)t.Egret3DState.showDataInfo("updateObject3D: "+((new Date).getTime()-this.a)+" ms");t.Egret3DCanvas.context3DProxy.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);t.Egret3DCanvas.context3DProxy.setScissorRectangle(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height);if(t.Egret3DEngine.instance.debug)t.Egret3DState.help=(new Date).getTime();this._entityCollect.update(this._camera);this._shadowCast.shadowRender.enabled=false;if(this._entityCollect.numberAcceptShadow>0){this._shadowCast.shadowRender.enabled=true;this._shadowCast.update(this._entityCollect,e,i)}if(t.Egret3DEngine.instance.debug)t.Egret3DState.showDataInfo("entityCollect"+((new Date).getTime()-t.Egret3DState.help)+" ms");if(t.Egret3DEngine.instance.debug){t.Egret3DState.showDataInfo("drawCall : "+this._entityCollect.numberDraw.toString());t.Egret3DState.showDataInfo("vertex : "+this._entityCollect.numberVertex.toString());t.Egret3DState.showDataInfo("tris : "+this._entityCollect.numberFace.toString());t.Egret3DState.showDataInfo("skin : "+this._entityCollect.numberSkin.toString());
t.Egret3DState.showDataInfo("proAnim : "+this._entityCollect.numberAnimation.toString());t.Egret3DState.showDataInfo("particleEmiter : "+this._entityCollect.numberParticle.toString());var r;for(var a=0;a<t.Layer.layerType.length;a++){r=t.Layer.layerType[a]+" layer: "+this._entityCollect.softLayerRenderItems[t.Layer.layerType[a]].length.toString();t.Egret3DState.showDataInfo(r)}}if(this._cleanParmerts&t.Context3DProxy.gl.COLOR_BUFFER_BIT){t.Egret3DCanvas.context3DProxy.clearColor(this._backColor.x,this._backColor.y,this._backColor.z,this._backColor.w)}t.Egret3DCanvas.context3DProxy.clear(this._cleanParmerts);if(this._backImg){this._backImg.draw(t.Egret3DCanvas.context3DProxy)}if(t.Egret3DEngine.instance.debug)this.a=(new Date).getTime();this._renderQuen.mainRender.camera=this.camera3D;this._renderQuen.draw(e,i,t.Egret3DCanvas.context3DProxy,this._entityCollect,this._viewPort);if(t.Egret3DEngine.instance.debug)t.Egret3DState.showDataInfo("draw: "+((new Date).getTime()-this.a)+" ms");if(this._postList.length>0){if(t.Egret3DEngine.instance.debug)this.a=(new Date).getTime();this._postProcessing.postArray=this._postList;this._postProcessing.draw(e,i,t.Egret3DCanvas.context3DProxy,this._entityCollect,this.camera3D,this._viewPort);if(t.Egret3DEngine.instance.debug)t.Egret3DState.showDataInfo("post: "+((new Date).getTime()-this.a)+" ms")}for(var a=0;a<this._huds.length;++a){this._huds[a].draw(t.Egret3DCanvas.context3DProxy)}if(this._quadStage){if(t.Egret3DEngine.instance.debug)this.a=(new Date).getTime();this._quadStage.update(e,i,t.Egret3DCanvas.context3DProxy,this);if(t.Egret3DEngine.instance.debug)t.Egret3DState.showDataInfo("GUI: "+((new Date).getTime()-this.a)+" ms")}};e.prototype.updateObject3D=function(t,e,i){if(t&&t.visible){t.update(e,i,this.camera3D);for(var r=0;r<t.childs.length;++r){this.updateObject3D(t.childs[r],e,i)}}};e.requestFullScreen=function(){var t=document.documentElement;if(t.requestFullscreen){t.requestFullscreen()}else if(t.webkitRequestFullScreen){t.webkitRequestFullScreen()}};e.exitFullscreen=function(){var t=document;if(t.exitFullscreen){t.exitFullscreen()}else if(t.webkitCancelFullScreen){t.webkitCancelFullScreen()}};e.setObjectSrceenPos=function(e,i,r,a){a.object3DToScreenRay(new t.Vector3D,t.Vector3D.HELP_0);t.Vector3D.HELP_0.setTo(e,i,t.Vector3D.HELP_0.z);a.ScreenRayToObject3D(t.Vector3D.HELP_0,t.Vector3D.HELP_1);r.globalPosition=t.Vector3D.HELP_1};return e}();t.View3D=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e,i,r){if(i===void 0){i=55}if(r===void 0){r=70}this.eyeCross=70;this.eyeRay=new t.Vector3D;this.dir=new t.Vector3D;this.mainCamera=e;this.leftCamera=new t.Camera3D;this.rightCamera=new t.Camera3D}e.prototype.update=function(){this.mainCamera.globalOrientation.transformVector(t.Vector3D.X_AXIS,this.dir);this.dir.normalize();this.leftCamera.modelMatrix=this.mainCamera.modelMatrix;this.rightCamera.modelMatrix=this.mainCamera.modelMatrix;var e=this.eyeCross*.5;this.leftCamera.x+=-this.dir.x*e;this.leftCamera.y+=-this.dir.y*e;this.leftCamera.z+=-this.dir.z*e;this.rightCamera.x+=this.dir.x*e;this.rightCamera.y+=this.dir.y*e;this.rightCamera.z+=this.dir.z*e};return e}();t.EyesCamera=e;var i=function(i){__extends(r,i);function r(e,r,a,n){i.call(this,e,r,a,n,new t.Camera3D(t.CameraType.perspective));this.w=0;this.h=0;this.w=a;this.h=n;this.init()}r.prototype.init=function(){this.eyesCamera=new e(this.camera3D)};r.prototype.update=function(t,e){this.eyesCamera.update();this.viewPort.width=this.w*.5;this.viewPort.height=this.h;this.viewPort.x=this.w*.5-this.viewPort.width-10;this.viewPort.y=this.h*.5-this.viewPort.height*.5;this.camera3D=this.eyesCamera.leftCamera;i.prototype.update.call(this,t,e);this.viewPort.width=this.w*.5;this.viewPort.height=this.h;this.viewPort.x=this.w*.5+10;this.viewPort.y=this.h*.5-this.viewPort.height*.5;this.camera3D=this.eyesCamera.rightCamera;i.prototype.update.call(this,t,e)};return r}(t.View3D);t.VRView3D=i})(egret3d||(egret3d={}));var egret3d;(function(t){t.registGUITexture=function(t){t.upload(e.context3DProxy);for(var i=0,r=e._instance.view3Ds;i<r.length;i++){var a=r[i];a.getGUIStage().registerTexture(t)}};var e=function(e){__extends(i,e);function i(r){if(r===void 0){r=false}e.call(this);this.canvas3DRectangle=new t.Rectangle;this._view3DS=new Array;this.sizeDiry=true;this._time=0;this._delay=0;this._renderer=0;this._timeDate=null;this.offsetX=0;this.offsetY=0;this._start=false;if(i._instance)throw new Error("不能重复实例化这个类!");i._instance=this;t.ShaderUtil.instance.load();this._envetManager=new t.EventManager(this);this.canvas=document.createElement("canvas");this.canvas.style.position="absolute";this.canvas.style.zIndex="-1";if(document.getElementsByClassName("egret-player").length>0){document.getElementsByClassName("egret-player")[0].appendChild(this.canvas)}else{document.body.appendChild(this.canvas)}this.canvas.id="egret3D";this.canvas.oncontextmenu=function(){return false};i.context3DProxy=new t.Context3DProxy;t.Context3DProxy.gl=this.canvas.getContext("experimental-webgl");if(!t.Context3DProxy.gl)t.Context3DProxy.gl=this.canvas.getContext("webgl");if(!t.Context3DProxy.gl)alert("you drivers not suport webgl");i.context3DProxy.register();console.log("this.context3D ==>",t.Context3DProxy.gl);t.Input.canvas=this;this.initEvent()}i.prototype.getExtension=function(e){var i=t.Context3DProxy.gl.getExtension(e);if(!i){alert("you drivers not suport "+e)}return i};i.prototype.initEvent=function(){this._enterFrameEvent3D=new t.Event3D(t.Event3D.ENTER_FRAME);this._enterFrameEvent3D.target=this};i.prototype.create2dContext=function(){i._canvas2D=document.createElement("canvas");i._canvas2D.hidden=true;i._ctx2D=i._canvas2D.getContext("2d")};i.draw2DImage=function(t,e,i,r,a){if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=1}if(a===void 0){a=1}document.body.appendChild(this._canvas2D);this._canvas2D.width=t.width;this._canvas2D.height=t.height;this._ctx2D.drawImage(t,e,e,r,a);var n=this._ctx2D.getImageData(0,0,r,a);document.body.removeChild(this._canvas2D);return n};Object.defineProperty(i.prototype,"x",{get:function(){return this.canvas3DRectangle.x},set:function(t){if(this.canvas3DRectangle.x!=t)this.resize(t,this.canvas3DRectangle.y,this.canvas3DRectangle.width,this.canvas3DRectangle.height)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"y",{get:function(){return this.canvas3DRectangle.y},set:function(t){if(this.canvas3DRectangle.y!=t)this.resize(this.canvas3DRectangle.x,t,this.canvas3DRectangle.width,this.canvas3DRectangle.height)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"width",{get:function(){return this.canvas3DRectangle.width},set:function(t){if(this.canvas3DRectangle.width!=t)this.resize(this.canvas3DRectangle.x,this.canvas3DRectangle.y,t,this.canvas3DRectangle.height)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"height",{get:function(){return this.canvas3DRectangle.height},set:function(t){if(this.canvas3DRectangle.height!=t)this.resize(this.canvas3DRectangle.x,this.canvas3DRectangle.y,this.canvas3DRectangle.width,t)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"view3Ds",{get:function(){return this._view3DS},enumerable:true,configurable:true});i.prototype.addView3D=function(t){var e=this._view3DS.indexOf(t);if(e==-1)this._view3DS.push(t)};i.prototype.removeView3D=function(t){var e=this._view3DS.indexOf(t);if(e!=-1)this._view3DS.splice(e,1)};i.prototype.start=function(){this._start=true;this.update(0);i.context3DProxy.enableBlend();i.context3DProxy.enableCullFace();t.Context3DProxy.gl.enable(t.Context3DProxy.gl.SCISSOR_TEST)};i.prototype.stop=function(){this._start=false};i.prototype.update=function(e){var r=this;if(!this._start){return}this._timeDate=new Date;this._delay=this._timeDate.getTime()-this._time;this._time=this._timeDate.getTime();this._enterFrameEvent3D.time=this._time;this._enterFrameEvent3D.delay=this._delay;this.dispatchEvent(this._enterFrameEvent3D);i.context3DProxy.viewPort(this.canvas3DRectangle.x,this.canvas3DRectangle.y,this.canvas3DRectangle.width,this.canvas3DRectangle.height);i.context3DProxy.setScissorRectangle(this.canvas3DRectangle.x,this.canvas3DRectangle.y,this.canvas3DRectangle.width,this.canvas3DRectangle.height);t.CameraManager.instance.update(this._time,this._delay);for(var a=0;a<this._view3DS.length;a++){if(t.Egret3DEngine.instance.debug)t.Egret3DState.help=(new Date).getTime();this._view3DS[a].update(this._time,this._delay);if(t.Egret3DEngine.instance.debug)t.Egret3DState.showDataInfo("view3D-"+a.toString()+":"+((new Date).getTime()-t.Egret3DState.help)+" ms")}if(t.Egret3DEngine.instance.debug){t.Egret3DState.showTime(this._time,this._delay);t.Egret3DState.showDataInfo("renderer: "+((new Date).getTime()-this._time).toString()+" ms");t.Egret3DState.show()}if(this.afterRender){this.afterRender()}t.Context3DProxy.gl.flush();requestAnimationFrame(function(t){return r.update(t)})};i.prototype.resize=function(e,i,r,a){this.canvas3DRectangle.x=e;this.canvas3DRectangle.y=i;this.canvas3DRectangle.width=r;this.canvas3DRectangle.height=a;t.ContextConfig.canvasRectangle=this.canvas3DRectangle;this.canvas.style.left=this.canvas3DRectangle.x.toString()+"px";this.canvas.style.top=this.canvas3DRectangle.y.toString()+"px";this.canvas.width=this.canvas3DRectangle.width;this.canvas.height=this.canvas3DRectangle.height};i.Performance_GPU=0;i.Performance_CPU=0;i.Performance_Enable=false;return i}(t.EventDispatcher);t.Egret3DCanvas=e})(egret3d||(egret3d={}));var egret3d;(function(egret3d){var Egret3DPolicy=function(){function t(){}t.engineVersion="3.2.6";t.useParticle=true;t.useAnimEffect=true;t.useEffect=true;t.useRibbon=true;t.useAnimPoseInterpolation=true;t.useAnimMixInterpolation=true;t.useAnimCache=false;t.useLight=true;t.usePost=true;t.useCompress=false;t.useLowLOD=false;return t}();egret3d.Egret3DPolicy=Egret3DPolicy;var Egret3DEngine=function(){function Egret3DEngine(){this.version="3.2.6";this.jsPath="js/";this.debug=false;this._tsconfigs=[];this.importList=[];this._tsconfigs.push("Egret3D/tsconfig.json")}Egret3DEngine.getXHR=function(){var t=null;if(window["XMLHttpRequest"]){t=new window["XMLHttpRequest"]}else{t=new ActiveXObject("MSXML2.XMLHTTP")}return t};Egret3DEngine.prototype.useDevicePOLICY=function(t){if(t===void 0){t=0}switch(t){case 0:if(this.isWeiXin()){Egret3DPolicy.useAnimPoseInterpolation=false;Egret3DPolicy.useAnimMixInterpolation=false}if(this.isAndroid()){Egret3DPolicy.useAnimPoseInterpolation=false;Egret3DPolicy.useAnimMixInterpolation=false;Egret3DPolicy.useParticle=false}break;default:break}};Egret3DEngine.prototype.isWeiXin=function(){var t=self.navigator.userAgent.toLowerCase();var e=t.indexOf("micromessenger");if(e!=-1){return true}else{return false}};Egret3DEngine.prototype.isAndroid=function(){var t=self.navigator.userAgent.toLowerCase();var e=t.indexOf("android");if(e!=-1){return true}else{return false}};Egret3DEngine.prototype.addTsconfig=function(t){this._tsconfigs.push(t)};Egret3DEngine.prototype.setTsconfig=function(t,e){this._tsconfigs[t]=e};Egret3DEngine.prototype.clearTsconfig=function(){this._tsconfigs.length=0};Egret3DEngine.prototype.preload=function(t,e){if(e===void 0){e=null}this._complete=t;this._thisObject=e;if(this._tsconfigs.length>0){this.doLoader(this._tsconfigs[0])}else{this.onAllLoadComplete()}};Egret3DEngine.prototype.addImportScript=function(t){this.importList.push(t)};Egret3DEngine.prototype.doLoader=function(t){var e=this;this._currentConfig=t;if(this._xhr==null){this._xhr=Egret3DEngine.getXHR()}if(this._xhr==null){alert("Your browser does not support XMLHTTP.");return}if(this._xhr.readyState>0){this._xhr.abort()}this._xhr.open("GET",t+"?"+Math.random()*1e5,true);this._xhr.addEventListener("progress",function(t){return e.onProgress(t)},false);this._xhr.addEventListener("readystatechange",function(t){return e.onReadyStateChange(t)},false);this._xhr.addEventListener("error",function(t){return e.onError(t)},false);this._xhr.responseType="text";this._xhr.send()};Egret3DEngine.prototype.onProgress=function(t){var e=t.loaded.toString()+t.total};Egret3DEngine.prototype.onReadyStateChange=function(t){if(this._xhr.readyState==4){if(this._xhr.status>=400||this._xhr.status==0){console.log(this._currentConfig,"load fail")}else{this.onLoadComplete(this._xhr.responseText)}}};Egret3DEngine.prototype.onLoadComplete=function(source){var s_pos=this._currentConfig.lastIndexOf("/");var dir=this._currentConfig.substr(0,s_pos+1);var obj=eval("("+source+")");var importName;for(var i=0;i<obj.files.length;++i){importName=this.jsPath+dir;importName+=obj.files[i];importName=importName.replace(".ts",".js");this.importList.push(importName)}var index=this._tsconfigs.indexOf(this._currentConfig);if(index==this._tsconfigs.length-1){this.onAllLoadTsconfigComplete()}else{this._xhr=null;this.doLoader(this._tsconfigs[++index])}};Egret3DEngine.prototype.onError=function(t){};Egret3DEngine.prototype.onAllLoadTsconfigComplete=function(){if(this.onTsconfig){this.onTsconfig()}this.startLoadScript(null)};Egret3DEngine.prototype.onAllLoadComplete=function(){if(this._complete){if(this._thisObject){this._complete.call(this._thisObject)}else{this._complete()}}};Egret3DEngine.prototype.startLoadScript=function(t){var e=this;if(this.importList.length>0){var i=document.createElement("script");i.src=this.importList.shift();i.onload=function(t){return e.startLoadScript(t)};i.onerror=function(t){return e.loadScriptError(t)};document.head.appendChild(i)}else{console.log("all complete");this.onAllLoadComplete()}};Egret3DEngine.prototype.loadScriptError=function(t){var e="load Script Error \r\n no file:"+t.srcElement.src;alert(e);this.startLoadScript(null)};Egret3DEngine.instance=new Egret3DEngine;return Egret3DEngine}();egret3d.Egret3DEngine=Egret3DEngine})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._debugHud=new t.HUD;this._h_postRender=new t.PostRender("hud_vs","gaussian_H_fs");this._h_postRender.setRenderToTexture(2048,2048,t.FrameBufferFormat.UNSIGNED_BYTE_RGB);this._v_postRender=new t.PostRender("hud_vs","gaussian_V_fs")}e.prototype.setRenderTexture=function(e,i){this._v_postRender.setRenderToTexture(e,i,t.FrameBufferFormat.UNSIGNED_BYTE_RGB)};e.prototype.draw=function(t,e,i,r,a,n,o){this._h_postRender.camera=a;this._h_postRender.needClean=true;this._h_postRender.draw(t,e,i,r,n,o);o["final"]=this._h_postRender.renderTexture;this._v_postRender.camera=a;this._v_postRender.needClean=true;this._v_postRender.draw(t,e,i,r,n,o);this._v_postRender["color"]=o["source"];o["final"]=this._v_postRender.renderTexture};return e}();t.GaussPost=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(e){if(e===void 0){e=.15}this._debugHud=new t.HUD;this.bloom_amount=e;this.postRender=new t.PostRender("hud_vs","bloom_fs");this.postRender.hud.uniformData["bloom_amount"]={uniformIndex:-1,type:t.UniformType.uniform1f,data:[e]}}e.prototype.setRenderTexture=function(e,i,r){if(!this.postRender.renderTexture||r){this.postRender.setRenderToTexture(e,i,t.FrameBufferFormat.UNSIGNED_BYTE_RGBA)}};e.prototype.draw=function(t,e,i,r,a,n,o){var s=this;s.postRender.camera=a;s.postRender.needClean=true;this.postRender.hud.uniformData["bloom_amount"].data[0]=s.bloom_amount;s.postRender.draw(t,e,i,r,n,o);o["final"]=this.postRender.renderTexture};return e}();t.BloomPost=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this._debugHud=new t.HUD;this.postRender=new t.PostRender("hud_vs","gaussian_H_fs")}e.prototype.setRenderTexture=function(t,e){this.postRender.setRenderToTexture(t,e)};e.prototype.draw=function(t,e,i,r,a,n,o){this.postRender.camera=a;this.postRender.needClean=true;this.postRender.draw(t,e,i,r,n,o);o["final"]=this.postRender.renderTexture};return e}();t.Gbuffer=e})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function t(){}t.prototype.isDimensionValid=function(e){return e>=1&&e<=t.MAX_SIZE&&this.isPowerOfTwo(e)};t.prototype.isPowerOfTwo=function(t){return t?(t&-t)==t:false};t.prototype.getBestPowerOf2=function(e){var i=1;while(i<e)i<<=1;if(i>t.MAX_SIZE)i=t.MAX_SIZE;return i};t.MAX_SIZE=2048;return t}();t.SizeUtil=e;t.sizeUtil=new e;var i=function(){function e(e){this.posTex={};this.hud=new t.HUD;this._sizeChange=false;this._renderQuen=e;this.postArray=[]}e.prototype.draw=function(e,i,r,a,n,o){var s=this;var h;var u;if(!s._renderQuen.mainRender.renderTexture){u=n.maxWidthAndHeight;this._renderQuen.mainRender.setRenderToTexture(u.x,u.y,t.FrameBufferFormat.UNSIGNED_BYTE_RGB)}s.finalTexture=s.posTex["final"]=s.posTex["source"]=s._renderQuen.mainRender.renderTexture;if(s.postArray.length>2){for(var l=0;l<s.postArray.length-1;l++){h=s.postArray[l];h.renderQuen=s._renderQuen;h.setRenderTexture(u.x,u.y);h.draw(e,i,r,a,n,o,s.posTex);s.finalTexture=s.posTex["final"]}}h=s.postArray[s.postArray.length-1];h.renderQuen=s._renderQuen;h.draw(e,i,r,a,n,o,s.posTex)};return e}();t.PostProcessing=i})(egret3d||(egret3d={}));var egret3d;(function(t){var e=function(){function e(){this.postRender=new t.PostRender("hud_vs","colorCorrection_fs")}e.prototype.setRenderTexture=function(t,e){this.postRender.setRenderToTexture(t,e)};Object.defineProperty(e.prototype,"lutTexture",{get:function(){return this._lutTexture},set:function(t){this._lutTexture=t;this.postRender.hud["lutTexture"]=t},enumerable:true,configurable:true});e.prototype.draw=function(t,e,i,r,a,n,o){this.postRender.camera=a;this.postRender.needClean=true;this.postRender.draw(t,e,i,r,n,o);o["final"]=this.postRender.renderTexture};return e}();t.ColorCorrectionPost=e})(egret3d||(egret3d={}));